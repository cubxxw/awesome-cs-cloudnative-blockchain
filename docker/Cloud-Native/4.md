+ [author](http://nsddd.top)

# ç¬¬4èŠ‚ ç¬¬äºŒé˜¶æ®µ ç¬¬äºŒéƒ¨åˆ†

<br>

<div><a href = '3.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '5.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/3293172751/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/3293172751/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]



## Before

+ go test  
+ k3s / helm / K3s rootfs / docs / source codes / 
+ fabric 
+ spring boot  â€“  dockerfile 



## problem

### **[3293172751](https://github.com/3293172751)** commented [2 days ago](https://github.com/labring/sealos/issues/1943#issuecomment-1295060720)

[k3s - github](https://github.com/k3s-io/k3s)ï¼ŒI wonder if I need a tutorial on [k3s.io](https://k3s.io/)ï¼Œwhat should I pay attention to when I use itâ“ Do I need to write the functions next to k8s to keep them **together,** or **separateâ“** [@fanux](https://github.com/fanux)

```
sealos run k0s:latest --masters xxx --nodes xxxx --passwd xxxx
```



### **[cuisongliu](https://github.com/cuisongliu)** commented [yesterday](https://github.com/labring/sealos/issues/1943#issuecomment-1295680848)

[k3s - github](https://github.com/k3s-io/k3s)ï¼ŒI wonder if I need a tutorial on [k3s.io](https://k3s.io/)ï¼Œwhat should I pay attention to when I use itâ“ Do I need to write the functions next to k8s to keep them **together,** or **separateâ“**

1. runtime interface need spilt kubeadm and k3s
2. k3s rootfs



**controllersï¼š**

> `controllers`   vï¼šgo1.18

```bash
cluster # ä¸“é—¨ç®¡ç†awsä¸Šk8sç”Ÿå‘½å‘¨æœŸ
```

 ClusterSpec defines the desired state of InfraMetadata





### rootfs runtime design

::: details k3s rootfs
goolang ç¼–è¯‘æ—¶ä¼šæ‰“åŒ…æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯ä¸ªç‹¬ç«‹çš„ binary éƒ½ä¼šæœ‰ç‹¬ç«‹çš„è¿è¡Œæ—¶æ”¯æŒ

k3sæŠŠæ‰€æœ‰çš„ä¾èµ–éƒ½ç¼–è¯‘åœ¨ä¸€ä¸ª `binary` ä¸­ï¼Œæ‰€æœ‰çš„ç¨‹åº ä¸€ä»½è¿è¡Œæ—¶

å€Ÿé‰´ rootfs (linux) åŸºäº [buildroot](https://github.com/buildroot/buildroot) æ„å»ºçš„ busybox rootfs

å‚è€ƒ [rancher/k3s-root](https://github.com/k3s-io/k3s-root) æ‰€æœ‰çš„k3s æ„å»ºçš„ binary éƒ½æ”¾åœ¨æ­¤å¤„

```
/var/lib/rancher/k3s/data/..../bin
```

:::



make Runtime module more readable

1. k0s runtime
2. k3s runtime 
3. k8s runtime



**aboutï¼š**

1. `util_test.go`  file
2. implement runtime interface
3. k3s runtime 



**implement runtime interfaceï¼š**

+ [https://www.sealos.io/zh-Hans/docs/cli/apply](https://www.sealos.io/zh-Hans/docs/cli/apply)

+ Interface `interface{}`



**runtime module listï¼š**

```markdown
# runtime
+ kubernets
	- kubeconfig.go  # 
	- master.go
	- node.go
	- registry.go
	- reset.go
	- runtime_getter.go
	- runtime.go
	- static_files.go
	- token.go
	- update_cert.go
	- utils.go
+ k3s
	- add.go
	- delete.go
	- reset.go 
	- update.go
	- token.go
+ k0s
```



**k3s rootfs designï¼š**

`init sealos`  â€“> `Clusterfile` file

mergedï¼šrootfs



*root directory: `/`*

::: tip â“ 

+ rootfs make build

+ rootfs interface 

**construction**

> How should rootfs build it?

```test
bin  cri  etc  images  Kubefile  opt  README.md  registry  scripts  statics
```

:::

```bash
+ /bin
+ /etc
+ /images
+ /scripts
+ /tmp
+ /lib
+ /run
+ /var
```



> ä¸ºä»€ä¹ˆæœ‰äº› `merged` æ˜¯ç©ºçš„



<del>`k3d` ï¼šè¦ä½¿ç”¨ Dockerï¼Œ`rancher/k3s`è¿˜å¯ä»¥ä½¿ç”¨é•œåƒæ¥è¿è¡Œ K3s æœåŠ¡å™¨å’Œä»£ç†ã€‚ä½¿ç”¨`docker run`å‘½ä»¤ï¼š</del>

> sealos run ranchar/k3s 

```bash
sudo docker run \
  -d --tmpfs /run \
  --tmpfs /var/run \
  -e K3S_URL=${SERVER_URL} \
  -e K3S_TOKEN=${NODE_TOKEN} \
  --privileged rancher/k3s:vX.Y.Z
```



**the  runtime module of k3sï¼š** 

> ç»“æ„ä½“æ–¹æ³•ï¼š
>
> + initæ–¹æ³•
> + SyncNodeIPVS æ–¹æ³•

+ Init   âš ï¸ 
+ SyncNodeIPVS  âš ï¸ 



**[[sealos]]åœ¨åŸºæœ¬çš„å‘½ä»¤æ“ä½œä¸Šå¯ä»¥ç†è§£ä¸ºä»£æ›¿dockerï¼Ÿ**

**ä½¿ç”¨sealos run docker.io/rancher/k3s?**



**build k3s images ?**

> kubernetes çš„æ„å»ºæ–¹å¼

1. [helm](https://artifacthub.io/packages/search?ts_query_web=k3s&sort=relevance&page=1)
2. sealos run ? ->  merged(rootfs)



**A simple questionï¼š**

1. ç¦»çº¿ç¯å¢ƒä¹Ÿéœ€è¦ sealos ï¼Ÿ
2. é¡¹ç›®æµ‹è¯•ç¯å¢ƒ~ï¼ˆæ–­ç‚¹ã€å•å…ƒæµ‹è¯•ã€æµ‹è¯•ç”¨ä¾‹)

   > windows11
   >
   > centos / ubuntu(å†…å­˜ä¸å¤Ÿ)
   >
   > vscode



[[åƒåœ¾å›æ”¶]]

**I need solutionsï¼š**

repeat imagesï¼ˆauto cleaning)ï¼Ÿ

![image-20221103200214386](http://sm.nsddd.top/smimage-20221103200214386.png)





**æ·»åŠ é•œåƒåˆ—è¡¨ï¼š**

> sealos ä¼šä¸‹è½½é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒå¹¶ç¼“å­˜åˆ° registry ç›®å½•ã€‚
>
> ç›®å½•å¿…é¡»å½¢å¦‚ `images/shim/[your image list filename]`ï¼š
>
> ```shell
>$ cat images/shim/nginxImages
> k8s.gcr.io/ingress-nginx/controller:v1.2.0
> k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1
> ```
> 
> [[sealos]] åœ¨æ„å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨æ·»åŠ é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒä¾èµ–åˆ°é›†ç¾¤é•œåƒä¸­ï¼Œé€šè¿‡ç¥å¥‡çš„æ–¹å¼ä¿å­˜äº†é‡Œé¢ä¾èµ–çš„ Docker é•œåƒã€‚ å¹¶ä¸”åœ¨åˆ°åˆ«çš„ç¯å¢ƒä¸­è¿è¡Œçš„æ—¶å€™æ›´ç¥å¥‡çš„è‡ªåŠ¨æ£€æµ‹é›†ç¾¤ä¸­æƒ³æ˜¯å¦çš„ Docker é•œåƒï¼Œæœ‰çš„è¯è‡ªåŠ¨ä¸‹è½½ï¼Œæ²¡æœ‰çš„è¯æ‰ä¼šå» k8s.gcr.io ä¸‹è½½ã€‚ ç”¨æˆ·æ— éœ€ä¿®æ”¹ helm chart ä¸­çš„ docker é•œåƒåœ°å€ï¼Œè¿™é‡Œç”¨åˆ°äº†é•œåƒç¼“å­˜ä»£ç†çš„é»‘ç§‘æŠ€ã€‚

web ï¼šhttps://k8s.gcr.io/v2/ ï¼Ÿ



**pull images registryâ“ **

```bash
$ sealos login docker.io
$ sealos push docker.io/fanux/ingress-nginx:v1.2.0
```



`sealos life cycle` ï¼špod



**sealos run == apply (pod / Deployment)**

> except  `/var/lib/`ï¼Œanything elseï¼Ÿ



## My questions, suggestionsï¼Ÿ

sealos && docker  ï¼š Invest time in `docker` source code ï¼ˆkubernetesï¼› k3s â€¦.)

linux operating system source code



## else

+ Advice to developers (me)

â€¦



## END é“¾æ¥

<ul><li><div><a href = '3.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '5.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

