+ [author](http://nsddd.top)

# ç¬¬5èŠ‚ é›†ç¾¤æ­å»º

<div><a href = '4.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '6.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]

## è´­ä¹°ä¸‰å°æœºå™¨

> åœ¨é’é¸Ÿäº‘ä¸Šåˆ›å»ºè´¦æˆ·ï¼Œå¹¶ä¸”è”ç³»å®¢æˆ·ç”³è¯·IPæ‰©å®¹ä¸ºä¸‰ä¸ª
>
> ![image-20221018114541669](http://sm.nsddd.top/smimage-20221018114541669.png)



### æ¨èä½¿ç”¨ä¸€ä¸ªè¿œç¨‹sshå·¥å…·

> æ”¯æŒæ‰¹é‡çš„è¾“å…¥ï¼Œå¾ˆé€‚åˆé›†ç¾¤çš„æ­å»º~

+ [x] [electermå¼€æºåœ°å€](https://electerm.github.io/electerm/)

![image-20221018122201424](http://sm.nsddd.top/smimage-20221018122201424.png)



### åˆ›å»ºç§æœ‰ç½‘ç»œ

![image-20221018142107989](http://sm.nsddd.top/smimage-20221018142107989.png)

![image-20221018142057391](http://sm.nsddd.top/smimage-20221018142057391.png)



### ä½¿ç”¨äº¤æ¢æœºåˆ’åˆ†ä¸ºéš”ç¦»ç½‘ç»œçš„å°åŒºåŸŸ

![image-20221018142311011](http://sm.nsddd.top/smimage-20221018142311011.png)



### è¿‡ç¨‹æˆªå›¾

![image-20221018143420128](http://sm.nsddd.top/smimage-20221018143420128.png)



> âš ï¸ ä¸Šé¢ä¸€å®šè¦æ³¨æ„ï¼šå†…ç½‘çš„èŒƒå›´ä¸€å®šè¦é€‰æ‹©`172.31.0.24/24`
>
> å› ä¸ºåé¢å®‰è£…dockerçš„æ—¶å€™ï¼Œdockerå äº†`172.17`å äº†



### æ­å»ºæˆåŠŸ

![image-20221018143510468](http://sm.nsddd.top/smimage-20221018143510468.png)



### æ˜¾ç¤ºå›¾å½¢åŒ–ç•Œé¢

> å¯ä»¥çœ‹åˆ°`vpc`å’Œé˜²ç«å¢™ä»¥åŠä¸‰å°ä¸»æœºä¹‹é—´çš„å…³è”ã€‚

![image-20221018143709858](http://sm.nsddd.top/smimage-20221018143709858.png)



### å¿…é¡»è¦æ‰“å¼€å®‰å…¨ç»„çš„ç»„å†…é€šä¿¡

> **åªæœ‰æ‰“å¼€ç»„å†…é€šä¿¡**ï¼Œé˜²ç«å¢™å³ä½¿ä¸å¼€ç«¯å£ä¹Ÿæ˜¯å¯ä»¥äº’ç›¸è®¿é—®çš„~

![image-20221018143918187](http://sm.nsddd.top/smimage-20221018143918187.png)



### vpcè®¾ç½®ç«¯å£è½¬åŒ–

> vpcé»˜è®¤å…è´¹çš„æ˜¯ä¸ä¼šæä¾›å…¬ç½‘IPçš„ï¼Œå› ä¸ºç°åœ¨å…¬ç½‘çš„IPç´§ç¼ºï¼Œæ‰€ä»¥vpcåœ¨ä¸€å®šç¨‹åº¦ä¸Šéœ€è¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œä½¿ç”¨vpcçš„ç«¯å£è½¬åŒ–ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬è§£å†³é—®é¢˜ã€‚è¿™æ˜¯å› ä¸ºvpcå¤–ç½‘ç«¯å£å¯ä»¥è‡ªå®šä¹‰ã€‚
>
> âš ï¸ æ³¨æ„è¦å¼€æ”¾å¯¹åº”çš„å®‰å…¨ç»„

| ç±»å‹     | ID                                                           | åç§° | è§’è‰² | çŠ¶æ€   | IP åœ°å€     | IPv6 åœ°å€ | DHCP é€‰é¡¹ | æ“ä½œ     |
| :------- | :----------------------------------------------------------- | :--- | :--- | :----- | :---------- | :-------- | :-------- | :------- |
| äº‘æœåŠ¡å™¨ | [i-jj9igf99](https://console.qingcloud.com/sh1/instances/instances/i-jj9igf99/) |      |      | è¿è¡Œä¸­ | 192.168.0.2 |           |           | [ ä¿®æ”¹ ] |
| äº‘æœåŠ¡å™¨ | [i-hdazrzq7](https://console.qingcloud.com/sh1/instances/instances/i-hdazrzq7/) |      |      | è¿è¡Œä¸­ | 192.168.0.3 |           |           | [ ä¿®æ”¹ ] |
| äº‘æœåŠ¡å™¨ | [i-bujgg88x](https://console.qingcloud.com/sh1/instances/instances/i-bujgg88x/) |      |      | è¿è¡Œä¸­ | 192.168.0.4 |           |           | [ ä¿®æ”¹ ] |

![image-20221018151846925](http://sm.nsddd.top/smimage-20221018151846925.png)



### å‡†å¤‡é“¾æ¥

> æˆ‘å¼€å§‹ä¹Ÿè®¾ç½®äº†ä¸€äº›åŸºç¡€çš„è„šæœ¬ï¼Œæ–¹ä¾¿ce'shi

![image-20221018152452648](http://sm.nsddd.top/smimage-20221018152452648.png)



## dockerå®‰è£…

### 1ã€ç§»é™¤ä»¥å‰dockerç›¸å…³åŒ…

```bash
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
```



### 2ã€é…ç½®yumæº

```bash
sudo yum install -y yum-utils
sudo yum-config-manager \
	--add-repo \
	http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```



### 3ã€å®‰è£…docker

```bash
sudo yum install -y docker-ce docker-ce-cli containerd.io


#ä»¥ä¸‹æ˜¯åœ¨å®‰è£…k8sçš„æ—¶å€™ä½¿ç”¨
yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7  containerd.io-1.4.6
```



### 4ã€å¯åŠ¨

```bash
systemctl enable docker --now
```



### 5ã€é…ç½®åŠ é€Ÿ

è¿™é‡Œé¢å¤–æ·»åŠ äº†dockerçš„ç”Ÿäº§ç¯å¢ƒæ ¸å¿ƒé…ç½®cgroup

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://82m9ar63.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```



## kubeadmåˆ›å»ºé›†ç¾¤é¢„å¤‡ç¯å¢ƒ

## å®‰è£…kubeadm

+ ä¸€å°å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®ä¸ºåŸºäº Debian å’Œ Red Hat çš„ Linux å‘è¡Œç‰ˆä»¥åŠä¸€äº›ä¸æä¾›åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›é€šç”¨çš„æŒ‡ä»¤


+ æ¯å°æœºå™¨ 2 GB æˆ–æ›´å¤šçš„ RAM ï¼ˆå¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“ä½ åº”ç”¨çš„è¿è¡Œå†…å­˜)


+ 2 CPU æ ¸æˆ–æ›´å¤šï¼ˆæˆ‘æµ‹è¯•çš„ 2æ ¸2G çš„å¾ˆå¡ï¼‰


+ é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)

+ **è®¾ç½®é˜²ç«å¢™æ”¾è¡Œè§„åˆ™**

+ èŠ‚ç‚¹ä¹‹ä¸­ä¸å¯ä»¥æœ‰é‡å¤çš„ä¸»æœºåã€MAC åœ°å€æˆ– product_uuidã€‚è¯·å‚è§[è¿™é‡Œ](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address)äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚


+ ä¸»æœºåï¼š`[root@i-0xkmp3n1 /]# ` ä¸€èˆ¬ä¸ä¼šé‡å¤     **è®¾ç½®ä¸åŒhostname**

+ å¼€å¯æœºå™¨ä¸Šçš„æŸäº›ç«¯å£ã€‚è¯·å‚è§[è¿™é‡Œ](https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports) äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚--  **å†…ç½‘äº’ä¿¡**

+ ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œä½  **å¿…é¡»** ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ **æ°¸ä¹…å…³é—­**



### è®¾ç½®æ‰€æœ‰æœºå™¨çš„ä¸»æœºåç§°

```bash
hostnamectl set-hostname k8s-master # ç¬¬ä¸€å°æœºå™¨
hostnamectl set-hostname k8s-node2 # ç¬¬äºŒå°æœºå™¨
hostnamectl set-hostname k8s-node3 # ç¬¬ä¸‰å°æœºå™¨
```



### å°† SELinux è®¾ç½®ä¸º permissive æ¨¡å¼

> å°† SELinux è®¾ç½®ä¸º permissive æ¨¡å¼ï¼ˆç›¸å½“äºå°†å…¶ç¦ç”¨ï¼‰

```bash
sudo setenforce 0  #ä¸´æ—¶
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
```



### å…³é—­æ‰€æœ‰æœºå™¨çš„äº¤æ¢åˆ†åŒº

> æŸ¥çœ‹åˆ†åŒºï¼š`free -m`

```bash
#å…³é—­swap
swapoff -a  #ä¸´æ—¶
sed -ri 's/.*swap.*/#&/' /etc/fstab #æ°¸ä¹…
```



### å…è®¸ iptables æ£€æŸ¥æ¡¥æ¥æµé‡
```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sudo sysctl --system  # è®©é…ç½®ç”Ÿæ•ˆ
```



## å®‰è£…é›†ç¾¤çš„ä¸‰å¤§ä»¶

æˆ‘ä»¬ä¸Šä¸€èŠ‚çœ‹åˆ°äº†é©¬è½¦çš„ä¸‰å¤§ä»¶ï¼Œæˆ‘ä»¬é›†ç¾¤ä¹Ÿæ˜¯æœ‰ä¸‰å¤§ä»¶çš„ğŸ˜‚ğŸ˜‚ 

é›†ç¾¤çš„æ­å»ºä¹Ÿæ˜¯å¾ˆæœ‰æ„æ€çš„ï¼Œå’Œredisçš„ä¸‰ä¸»ä¸‰ä»ï¼ŒHadoopçš„æ­å»ºç±»ä¼¼

>  å®‰è£…kubeletã€kubeadmã€kubectl

```bash
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF


sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes   # å®‰è£…ä¸‰å¤§ä»¶

sudo systemctl enable --now kubelet   # æ‰€æœ‰æœºå™¨å¯åŠ¨kublet
```

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼škubelet ç°åœ¨æ¯éš”å‡ ç§’å°±ä¼šé‡å¯ï¼Œå› ä¸ºå®ƒé™·å…¥äº†ä¸€ä¸ªç­‰å¾… kubeadm æŒ‡ä»¤çš„æ­»å¾ªç¯



## ä½¿ç”¨kubeadmå¼•å¯¼é›†ç¾¤

1. ä¸‹è½½å„ä¸ªæœºå™¨éœ€è¦çš„é•œåƒ
2. åˆå§‹åŒ–ä¸»ç»“ç‚¹
3. æ ¹æ®æç¤ºç»§ç»­
4. åŠ å…¥nodeç»“ç‚¹

> å…¶å®åœ¨`k8s`ä¸­ï¼Œé™¤äº†`kubelet`ï¼Œå‰©ä¸‹çš„é•œåƒéƒ½æ˜¯ä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œã€‚`kubelet`ç±»ä¼¼äºå‚é•¿ï¼Œæˆ‘ä»¬ä¸ºäº†é¿å…ä¸‹è½½ä¸­æ–­ï¼Œæ‰€ä»¥å‡†å¤‡çš„æ˜¯è„šæœ¬ã€‚

### ä¸‹è½½å„ä¸ªæœºå™¨éœ€è¦çš„é•œåƒ

```bash
sudo tee ./images.sh <<-'EOF'
#!/bin/bash
images=(
kube-apiserver:v1.20.9
kube-proxy:v1.20.9
kube-controller-manager:v1.20.9
kube-scheduler:v1.20.9
coredns:1.7.0
etcd:3.4.13-0
pause:3.2
)
for imageName in ${images[@]} ; do
docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/$imageName
done
EOF
   
chmod +x ./images.sh && ./images.sh  #æˆäºˆæƒé™å¹¶ä¸”æ‰§è¡Œè„šæœ¬
```

> å¤§æ¦‚ç­‰äº†ä¸€ä¼šä¼šå°±å¯ä»¥æ£€ç´¢äº†
>
> ```
> docker images
> ```
>
> ![image-20221018173701125](http://sm.nsddd.top/smimage-20221018173701125.png)



### åˆå§‹åŒ–ä¸»ç»“ç‚¹

> âš ï¸ ä¸‹é¢ä¸€å®šè¦æŒ‰ç…§è‡ªå·±çš„æƒ…å†µä¿®æ”¹
>
> ä½¿ç”¨`ip addr(ip a)`æŸ¥çœ‹è‡ªå·±çš„å†…ç½‘åœ°å€ã€‚
>
> ```
> 192.168.0.2
> ```
>
> ![image-20221018174044509](http://sm.nsddd.top/smimage-20221018174044509.png)

```bash
#æ‰€æœ‰æœºå™¨æ·»åŠ masteråŸŸåæ˜ å°„ï¼Œä»¥ä¸‹éœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±çš„
echo "192.168.0.2  cluster-endpoint" >> /etc/hosts  # æ¯ä¸€ä¸ªç»“ç‚¹éƒ½éœ€è¦è¾“å…¥
# éœ€è¦æ¯ä¸€ä¸ªç»“ç‚¹èƒ½pingé€š

#ä¸»èŠ‚ç‚¹åˆå§‹åŒ– --apiserver-advertise-addressæ”¹ä¸ºmasterç»“ç‚¹ip
kubeadm init \
--apiserver-advertise-address=192.168.0.2 \  
--control-plane-endpoint=cluster-endpoint \
--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \
--kubernetes-version v1.20.9 \
--service-cidr=10.96.0.0/16 \
--pod-network-cidr=192.168.0.0/16

#æ‰€æœ‰ç½‘ç»œèŒƒå›´ä¸é‡å 
```

ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

> ä¸€å®šè¦æ³¨æ„æ¯ä¸€ä¸ªç»“ç‚¹éƒ½éœ€è¦èƒ½ `ping`é€š`cluster-endpoint`
>
> ä¸»èŠ‚ç‚¹åˆå§‹åŒ–ï¼šæ³¨æ„ç‰ˆæœ¬å’Œç½‘ç»œèŒƒå›´çš„é…ç½®ï¼Œè¿™ä¸ªæŒºéº»çƒ¦çš„åé¢é™¤éç‰¹åˆ«æ·±å…¥è¿™ä¸€å—ï¼Œå¦åˆ™ä¸è¦æ”¹ã€‚
>
> `--apiserver-advertise-address`ä¸€å®šè¦æ”¹æˆè‡ªå·±çš„`master`ç»“ç‚¹çš„`ip`
>
> **å¦‚æœè¦æ”¹ï¼š**
>
> ```
> --service-cidr=10.96.0.0/16 \
> --pod-network-cidr=192.168.0.0/16
> ```
>
> æ‰€æœ‰ç½‘ç»œèŒƒå›´ä¸€å®šä¸èƒ½é‡å ï¼ï¼ï¼
>
> `--apiserver-advertise-address` å¯ä»¥è®¾ç½® control-plane èŠ‚ç‚¹ API server çš„ é€šå‘Šåœ°å€ã€‚
> `--control-plane-endpoint` å¯ä»¥è®¾ç½®æ‰€æœ‰control-plane èŠ‚ç‚¹çš„ shared endpointã€‚
> `--control-plane-endpoint` å…è®¸IPåœ°å€ï¼Œä¹Ÿå…è®¸DNS namesã€‚è¯·è”ç³»ç®¡ç†å‘˜è®¾ç½®DNSå’ŒIPçš„æ˜ å°„ã€‚

```

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of control-plane nodes by copying certificate authorities
and service account keys on each node and then running the following as root:

  kubeadm join cluster-endpoint:6443 --token hums8f.vyx71prsg74ofce7 \
    --discovery-token-ca-cert-hash sha256:a394d059dd51d68bb007a532a037d0a477131480ae95f75840c461e85e2c6ae3 \
    --control-plane 

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join cluster-endpoint:6443 --token hums8f.vyx71prsg74ofce7 \
    --discovery-token-ca-cert-hash sha256:a394d059dd51d68bb007a532a037d0a477131480ae95f75840c461e85e2c6ae3
```

**ç»§ç»­ï¼š**

```bash
#æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹
kubectl get nodes

#æ ¹æ®é…ç½®æ–‡ä»¶ï¼Œç»™é›†ç¾¤åˆ›å»ºèµ„æº
kubectl apply -f xxxx.yaml

#æŸ¥çœ‹é›†ç¾¤éƒ¨ç½²äº†å“ªäº›åº”ç”¨ï¼Ÿ
docker ps   ===   kubectl get pods -A

# è¿è¡Œä¸­çš„åº”ç”¨åœ¨dockeré‡Œé¢å«å®¹å™¨ï¼Œåœ¨k8sé‡Œé¢å«Pod
kubectl get pods -A
```



### æ ¹æ®æç¤ºç»§ç»­

masteræˆåŠŸåæç¤ºå¦‚ä¸‹ï¼š

![image-20221018185049721](http://sm.nsddd.top/smimage-20221018185049721.png)



1ã€è®¾ç½®`.kube/config`



2ã€å®‰è£…ç½‘ç»œç»„ä»¶

+ [x] [calicoå®˜ç½‘](https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-more-than-50-nodes)

```bash
curl https://docs.projectcalico.org/manifests/calico.yaml -O
kubectl apply -f calico.yaml
```



### åŠ å…¥nodeèŠ‚ç‚¹

```bash
kubeadm join cluster-endpoint:6443 --token x5g4uy.wpjjdbgra92s25pp \
	--discovery-token-ca-cert-hash sha256:6255797916eaee52bf9dda9429db616fcd828436708345a308f4b917d3457a22
```

> æ–°ä»¤ç‰Œ
>
> ```
> kubeadm token create --print-join-command
> ```
>
> ***é«˜å¯ç”¨éƒ¨ç½²æ–¹å¼ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸€æ­¥çš„æ—¶å€™ï¼Œä½¿ç”¨æ·»åŠ ä¸»èŠ‚ç‚¹çš„å‘½ä»¤å³å¯***



## END é“¾æ¥

<ul><li><div><a href = '4.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '6.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

