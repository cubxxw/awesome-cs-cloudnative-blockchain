+ [author](http://nsddd.top)

# ç¬¬16èŠ‚ Treafik LB

<div><a href = '15.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '17.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]

## ä»‹ç»

+ [å¼€æºåœ°å€](https://github.com/traefik/traefik)
+ [å®˜æ–¹](https://traefik.io/)

Treafik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£HTTPåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚ å®ƒæ”¯æŒå¤šç§åå° ([Docker](https://www.docker.com/), [Swarm](https://docs.docker.com/swarm), [Kubernetes](https://kubernetes.io/), [Marathon](https://mesosphere.github.io/marathon/), [Mesos](https://github.com/apache/mesos), [Consul](https://www.consul.io/), [Etcd](https://coreos.com/etcd/), [Zookeeper](https://zookeeper.apache.org/), [BoltDB](https://github.com/boltdb/bolt), Rest API, fileâ€¦) æ¥è‡ªåŠ¨åŒ–ã€åŠ¨æ€çš„åº”ç”¨å®ƒçš„é…ç½®æ–‡ä»¶è®¾ç½®ã€‚

![ç»“æ„](http://sm.nsddd.top/smarchitecture.png)



::: details Nginxå’ŒTraefikæ¨ªå‘å¯¹æ¯”
`Nginx` å’Œ `Traefik` æ¨ªå‘å¯¹æ¯”ï¼š

![image-20221031155941634](http://sm.nsddd.top/smimage-20221031155941634.png)

:::



## å®‰è£…

::: details å®‰è£…æ–¹å¼
treafikæ”¯æŒä¸‹é¢å‡ ç§å®‰è£…çš„æ–¹å¼ï¼š

+ æœ€ç®€å•çš„æ–¹æ³•ï¼š ä» [ç‰ˆæœ¬ä¸‹è½½](https://github.com/containous/traefik/releases) é¡µé¢ä¸‹è½½æœ€æ–°çš„å¯æ‰§è¡Œæ–‡ä»¶å¹¶ä»¥è¿™ä¸ª [ç¤ºä¾‹é…ç½®æ–‡ä»¶](https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml) è¿è¡Œï¼š

```shell
./traefik --configFile=traefik.toml
```



+ é€šè¿‡Dockeré•œåƒï¼š

```shell
docker run -d -p 8080:8080 -p 80:80 -v $PWD/traefik.toml:/etc/traefik/traefik.toml traefik
```



+ é€šè¿‡æºç ç¼–è¯‘ï¼š

```shell
git clone https://github.com/containous/traefik
```

:::



## CoreDNS

CoreDNS æ˜¯åœ¨ agent èŠ‚ç‚¹å¯åŠ¨æ—¶éƒ¨ç½²çš„ã€‚è¦ç¦ç”¨ï¼Œè¯·åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè¿è¡Œ `--disable coredns` é€‰é¡¹ã€‚

å¦‚æœä½ ä¸å®‰è£… CoreDNSï¼Œä½ å°†éœ€è¦è‡ªå·±å®‰è£…ä¸€ä¸ªé›†ç¾¤ DNS æä¾›å•†ã€‚

### å¦‚ä½•ä¿®æ”¹ coredns å‚æ•°

é€šè¿‡ä¿®æ”¹`/var/lib/rancher/k3s/server/manifests/coredns.yaml`é…ç½®æ–‡ä»¶ä¼šç«‹å³ç”Ÿæ•ˆï¼Œä½†é‡å¯ K3s æœåŠ¡ä¼šå¯¼è‡´ coredns é…ç½®é‡æ–°åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦ä¿®æ”¹ corends çš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹ï¼š

1. å°†`coredns.yaml`ä¿å­˜åˆ°å…¶ä»–ç›®å½•
2. é€šè¿‡ `--disable coredns` ç¦ç”¨ coredns
3. å°†å¤‡ä»½çš„`coredns.yaml` å¤åˆ¶åˆ° `/var/lib/rancher/k3s/server/manifests/c.yaml`ï¼Œå¹¶ä¿®æ”¹å¯¹åº”å‚æ•°



## Traefik Ingress Controller

å¯åŠ¨ server æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šéƒ¨ç½² Traefikã€‚é»˜è®¤çš„é…ç½®æ–‡ä»¶åœ¨`/var/lib/rancher/k3s/server/manifests/traefik.yaml`ä¸­ï¼Œå¯¹è¯¥æ–‡ä»¶çš„ä»»ä½•ä¿®æ”¹éƒ½ä¼šä»¥ç±»ä¼¼`kubectl apply`çš„æ–¹å¼è‡ªåŠ¨éƒ¨ç½²åˆ° Kubernetes ä¸­ã€‚

Traefik ingress controller å°†ä½¿ç”¨ä¸»æœºä¸Šçš„ 80 å’Œ 443 ç«¯å£ï¼ˆå³è¿™äº›ç«¯å£ä¸èƒ½ç”¨äº HostPort æˆ– NodePortï¼‰ã€‚

Traefik å¯ä»¥é€šè¿‡ç¼–è¾‘ `traefik.yaml` æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚ä¸ºäº†é˜²æ­¢ k3s ä½¿ç”¨æˆ–è¦†ç›–ä¿®æ”¹åçš„ç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨`--disable traefik`éƒ¨ç½² k3sï¼Œå¹¶å°†ä¿®æ”¹åçš„å‰¯æœ¬å­˜å‚¨åœ¨`k3s/server/manifests`ç›®å½•ä¸­ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒå®˜æ–¹çš„[Traefik é…ç½®å‚æ•°](https://github.com/helm/charts/tree/master/stable/traefik#configuration)ã€‚

è¦ç¦ç”¨å®ƒï¼Œè¯·ä½¿ç”¨`--disable traefik`é€‰é¡¹å¯åŠ¨æ¯ä¸ª serverã€‚



### å¦‚ä½•å¯ç”¨ treafik2 dashboardï¼š

```bash
# Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.
# To create an encoded user:password pair, the following command can be used:
# htpasswd -nb admin admin | openssl base64

apiVersion: v1
kind: Secret
metadata:
  name: authsecret
  namespace: default
data:
  users: |2
    YWRtaW46JGFwcjEkLkUweHd1Z0EkUjBmLi85WndJNXZWRFMyR2F2LmtELwoK
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard
spec:
  routes:
  - match: Host(`traefik.example.com`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
    middlewares:
      - name: auth
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: auth
spec:
  basicAuth:
    secret: authsecret # Kubernetes secret named "secretName"
```

ç„¶åé€šè¿‡ http://traefik.example.com/dashboard/ è®¿é—® traefik dashboard

å‚è€ƒï¼š

https://doc.traefik.io/traefik/operations/dashboard/

https://doc.traefik.io/traefik/middlewares/basicauth/#general

## Service Load Balancer

K3s æä¾›äº†ä¸€ä¸ªåä¸º[Klipper Load Balancer](https://github.com/rancher/klipper-lb)çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å¯ç”¨çš„ä¸»æœºç«¯å£ã€‚ å…è®¸åˆ›å»º LoadBalancer ç±»å‹çš„ Serviceï¼Œä½†ä¸åŒ…æ‹¬ LB çš„å®ç°ã€‚æŸäº› LB æœåŠ¡éœ€è¦äº‘æä¾›å•†ï¼Œä¾‹å¦‚ Amazon EC2 æˆ– Microsoft Azureã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒK3s service LB ä½¿å¾—å¯ä»¥åœ¨æ²¡æœ‰äº‘æä¾›å•†çš„æƒ…å†µä¸‹ä½¿ç”¨ LB æœåŠ¡ã€‚

### Service LB å¦‚ä½•å·¥ä½œ

K3s åˆ›å»ºäº†ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨ä¸º service load balancer åˆ›å»ºäº†ä¸€ä¸ª Podï¼Œè¿™ä¸ª Pod æ˜¯[Service](https://kubernetes.io/docs/concepts/services-networking/service/)ç±»å‹çš„ Kubernetes å¯¹è±¡ã€‚

å¯¹äºæ¯ä¸ª service load balancerï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª[DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)ã€‚ DaemonSet åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªå‰ç¼€ä¸º`svc`çš„ Podã€‚

Service LB æ§åˆ¶å™¨ä¼šç›‘å¬å…¶ä»– Kubernetes Servicesã€‚å½“å®ƒæ‰¾åˆ°ä¸€ä¸ª Service åï¼Œå®ƒä¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šä½¿ç”¨ DaemonSet ä¸ºè¯¥æœåŠ¡åˆ›å»ºä¸€ä¸ªä»£ç† Podã€‚è¿™ä¸ª Pod æˆä¸ºå…¶ä»– Service çš„ä»£ç†ï¼Œä¾‹å¦‚ï¼Œæ¥è‡ªèŠ‚ç‚¹ä¸Š 8000 ç«¯å£çš„è¯·æ±‚å¯ä»¥è¢«è·¯ç”±åˆ°ç«¯å£ 8888 ä¸Šçš„å·¥ä½œè´Ÿè½½ã€‚

å¦‚æœåˆ›å»ºå¤šä¸ª Servicesï¼Œåˆ™ä¸ºæ¯ä¸ª Service åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ DaemonSetã€‚

åªè¦ä½¿ç”¨ä¸åŒçš„ç«¯å£ï¼Œå°±å¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œå¤šä¸ª Servicesã€‚

å¦‚æœæ‚¨å°è¯•åˆ›å»ºä¸€ä¸ªåœ¨ 80 ç«¯å£ä¸Šç›‘å¬çš„ Service LBï¼ŒService LB å°†å°è¯•åœ¨é›†ç¾¤ä¸­æ‰¾åˆ° 80 ç«¯å£çš„ç©ºé—²ä¸»æœºã€‚å¦‚æœè¯¥ç«¯å£æ²¡æœ‰å¯ç”¨çš„ä¸»æœºï¼ŒLB å°†ä¿æŒ Pending çŠ¶æ€ã€‚

### ç”¨æ³•

åœ¨ K3s ä¸­åˆ›å»ºä¸€ä¸ª[LoadBalancer ç±»å‹çš„ Service](https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer)ã€‚

### ä»èŠ‚ç‚¹ä¸­æ’é™¤ Service LB

è¦æ’é™¤èŠ‚ç‚¹ä½¿ç”¨ Service LBï¼Œè¯·å°†ä»¥ä¸‹æ ‡ç­¾æ·»åŠ åˆ°ä¸åº”æ’é™¤çš„èŠ‚ç‚¹ä¸Šï¼š

```
svccontroller.k3s.cattle.io/enablelb
```

å¦‚æœä½¿ç”¨æ ‡ç­¾ï¼Œåˆ™ service load balancer ä»…åœ¨æ ‡è®°çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

### ç¦ç”¨ Service LB

è¦ç¦ç”¨åµŒå…¥å¼ LBï¼Œè¯·ä½¿ç”¨`--disable servicelb`é€‰é¡¹è¿è¡Œ k3s serverã€‚

å¦‚æœæ‚¨å¸Œæœ›è¿è¡Œå…¶ä»– LBï¼Œä¾‹å¦‚ MetalLBï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚

## æ²¡æœ‰ä¸»æœºåçš„èŠ‚ç‚¹

ä¸€äº›äº‘æä¾›å•†ï¼ˆå¦‚ Linodeï¼‰ä¼šä»¥ "localhost "ä½œä¸ºä¸»æœºååˆ›å»ºæœºå™¨ï¼Œè€Œå…¶ä»–æä¾›å•†å¯èƒ½æ ¹æœ¬æ²¡æœ‰è®¾ç½®ä¸»æœºåã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´åŸŸåè§£æçš„é—®é¢˜ã€‚ä½ å¯ä»¥ç”¨`--node-name`æ ‡å¿—æˆ–`K3S_NODE_NAME`ç¯å¢ƒå˜é‡æ¥è¿è¡Œ K3sï¼Œè¿™æ ·å°±ä¼šä¼ é€’èŠ‚ç‚¹åç§°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚





## END é“¾æ¥

<ul><li><div><a href = '15.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '17.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

