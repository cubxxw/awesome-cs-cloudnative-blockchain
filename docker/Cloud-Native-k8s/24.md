+ [author](http://nsddd.top)

# ç¬¬24èŠ‚ ETCD

<div><a href = '23.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '25.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

[[toc]]

## ETCD ä»‹ç»

::: tip etcd address

+ [github](https://github.com/etcd-io/etcd)
+ [official websize](https://etcd.io/)

:::

etcd (aid) æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å…³é”®æ•°æ®çš„åˆ†å¸ƒå¼å¯é é”®å€¼å­˜å‚¨ï¼Œé‡ç‚¹æ˜¯ï¼š

+ *ç®€å•*ï¼šå®šä¹‰æ˜ç¡®ã€é¢å‘ç”¨æˆ·çš„ API (gRPC)
+ *å®‰å…¨*ï¼šå…·æœ‰å¯é€‰å®¢æˆ·ç«¯è¯ä¹¦èº«ä»½éªŒè¯çš„è‡ªåŠ¨ TLS
+ *å¿«é€Ÿ*ï¼šåŸºå‡†æµ‹è¯• 10,000 æ¬¡å†™å…¥/ç§’
+ *å¯é *ï¼šä½¿ç”¨ Raft æ­£ç¡®åˆ†å¸ƒ

> **etcd**æ˜¯ä¸€ç§é«˜åº¦ä¸€è‡´çš„åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œå®ƒæä¾›äº†ä¸€ç§å¯é çš„æ–¹å¼æ¥å­˜å‚¨éœ€è¦ç”±åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–æœºå™¨é›†ç¾¤è®¿é—®çš„æ•°æ®ã€‚å®ƒåœ¨ç½‘ç»œåˆ†åŒºæœŸé—´ä¼˜é›…åœ°å¤„ç†é¢†å¯¼é€‰ä¸¾ï¼Œå¹¶ä¸”å¯ä»¥å®¹å¿æœºå™¨æ•…éšœï¼Œå³ä½¿åœ¨ `leader node` ä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

ä¸ç®¡æ˜¯ kubernetes çš„æ·±å…¥å­¦ä¹ ä¸­ï¼Œé‡åˆ°äº†å¾ˆå¤šå…³äº etcd çš„çŸ¥è¯†ï¼Œåˆæˆ–è€…æ˜¯æœ¬èº«å…³äº k3s runtime æ”¯æŒï¼Œå…³äº etcd ä½œä¸ºå†…åµŒ DB ä¹Ÿé‡åˆ°äº†å¾ˆå¤šç–‘æƒ‘ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡ã€‚

etcd æ˜¯ç”¨ Go ç¼–å†™çš„ï¼Œä½¿ç”¨[Raft](https://raft.github.io/)å…±è¯†ç®—æ³•æ¥ç®¡ç†ä¸€ä¸ªé«˜å¯ç”¨çš„å¤åˆ¶æ—¥å¿—ã€‚

::: warning æé†’
etcd æ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼å­˜å‚¨çš„ä¸­é—´ä»¶ï¼Œä½¿ç”¨ Goè¯­è¨€ ç¼–å†™å¹¶é€šè¿‡ Raft ä¸€è‡´æ€§ç®—æ³•å¤„ç†å’Œç¡®ä¿åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚**è§£å†³æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œç”¨äºå¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒã€‚**

ä¸€äº›å…³äº Raft çš„é—®é¢˜ï¼Œæˆ‘æƒ³åœ¨[ä¸‹ä¸€ç¯‡](./25.md)ä½ èƒ½æ‰¾åˆ°ç­”æ¡ˆ

å¦‚æœä½ éœ€è¦çœ‹åˆ°å…³äº [etcd - raft ç®—æ³•çš„ Goè¯­è¨€](https://github.com/etcd-io/etcd/tree/release-0.4/third_party/github.com/goraft/raft) å®ç°ã€‚

:::

> æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£æˆ‘ä»¬ä¹‹å‰æ— è®ºæ˜¯éƒ¨ç½² hedoop è¿˜æ˜¯ kubernetes ï¼Œéƒ½æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå°½é‡é€‰æ‹©å¥‡æ•°çš„èŠ‚ç‚¹ï¼ŒçœŸæ˜¯å› ä¸º raftã€‚



### åˆ†å¸ƒå¼ CAP ç†è®º

::: tip 
consistency(ä¸€è‡´æ€§)ã€Availability(å¯ç”¨æ€§)ã€Partition tolerance(åˆ†åŒºå®¹é”™æ€§)

è¿™ä¸‰ä¸ªç‰¹æ€§åªèƒ½åŒæ—¶å®ç°ä¸¤ç‚¹ï¼Œä¸èƒ½ä¸‰ç‚¹åŒæ—¶å…¼é¡¾~

åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºæœ¬ç‰¹æ€§ï¼š**Partition tolerance(åˆ†åŒºå®¹é”™æ€§) å¿…é¡»è¦æ»¡è¶³**

consistency(ä¸€è‡´æ€§)ã€Availability(å¯ç”¨æ€§) äºŒé€‰ä¸€ï¼š

+ é“¶è¡Œé€‰æ‹©æ•°æ®ä¸€è‡´æ€§
+ å¤§ä¼—ç½‘é¡µé€‰æ‹©æœåŠ¡å¯ç”¨æ€§

**etcd å½’æ ¹ç»“åº•æ˜¯ä¸€ä¸ªå­˜å‚¨ç»„ä»¶ï¼Œå¯ä»¥å®ç°é…ç½®å…±äº«å’ŒæœåŠ¡å‘ç°~**

:::



### etcd å¸¸ç”¨æœ¯è¯­

| æœ¯è¯­      | æè¿°                                  | å¤‡æ³¨                                                         |
| --------- | ------------------------------------- | ------------------------------------------------------------ |
| Raft      | Raftç®—æ³•,etcdå®ç°ä¸€è‡´æ€§çš„æ ¸å¿ƒ         | etcdæœ‰[etcd-raft](https://github.com/etcd-io/etcd/tree/release-0.4/third_party/github.com/goraft/raft)æ¨¡å— |
| Follower  | Raftä¸­çš„ä»å±èŠ‚ç‚¹                      | ç«äº‰Leaderå¤±è´¥                                               |
| Leader    | Raftä¸­çš„é¢†å¯¼åè°ƒèŠ‚ç‚¹,ç”¨äºå¤„ç†æ•°æ®æäº¤ | LeaderèŠ‚ç‚¹åè°ƒæ•´ä¸ªé›†ç¾¤                                       |
| Candidate | å€™é€‰èŠ‚ç‚¹                              | å½“Followeræ¥æ”¶LeaderèŠ‚ç‚¹çš„æ¶ˆæ¯è¶…æ—¶ä¼šè½¬å˜ä¸ºcandidate          |
| Node      | RaftçŠ¶æ€æœºçš„å®ä¾‹                      | Raftä¸­è®¾è®¡å¤šä¸ªèŠ‚ç‚¹                                           |
| Member    | etcdå®ä¾‹,ç®¡ç†å¯¹åº”çš„NodeèŠ‚ç‚¹           | å¯å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚                                             |
| Peer      | åŒä¸€ä¸ªé›†ç¾¤ä¸­çš„å¦ä¸€ä¸ªMember            | å…¶ä»–æˆå‘˜                                                     |
| Cluster   | etcdé›†ç¾¤                              | æ‹¥æœ‰å¤šä¸ªetcd memeber                                         |
| Lease     | ç§ŸæœŸ                                  | å…³é”®è®¾ç½®çš„ç§ŸæœŸ,è¿‡æœŸåˆ é™¤                                      |
| Watch     | æ£€æµ‹æœºåˆ¶                              | ç›‘æ§ç®€ç›´å¯¹çš„å˜åŒ–                                             |
| Term      | ä»»æœŸ                                  | æŸä¸ªèŠ‚ç‚¹æˆä¸ºLeader,åˆ°ä¸‹ä¸€æ¬¡ç«é€‰çš„äº‹ä»¶                        |
| WAL       | é¢„å†™å¼æ—¥å¿—                            | ç”¨äºæŒä¹…åŒ–å­˜å‚¨çš„æ—¥å¿—æ ¼å¼                                     |
| client    | å®¢æˆ·ç«¯                                | å‘etcdå‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯                                       |



::: warning 
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå’Œ kubernetes é›†ç¾¤ä¸­ï¼Œetcd å¯ä»¥ä½œä¸ºæœåŠ¡æ³¨å†Œä¸å‘ç°å’Œé”®å€¼å¯¹å­˜å‚¨ç»„ä»¶ã€‚

+ é”®å€¼å¯¹å­˜å‚¨ï¼šetcd æ˜¯ä¸€ä¸ªç”¨äºé”®å€¼å¯¹çš„å­˜å‚¨ï¼Œkubernetes å…ƒæ•°æ®å­˜å‚¨
+ æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼šraft ç®—æ³•ä¿è¯åˆ†å¸ƒå¼åœºæ™¯ä¸€è‡´æ€§ã€‚
+ æ¶ˆæ¯è®¢é˜…ä¸å‘ç°
+ åˆ†å¸ƒå¼é”ï¼šåŸºäº raft ç®—æ³•ï¼Œå¾ˆå®¹æ˜“å®ç°

:::



### æ¶æ„

![img](http://sm.nsddd.top/smwebp123)





## æ­å»º etcd

å¯ä»¥ä½¿ç”¨ï¼š

```
yum install etcd 
```

> yaml å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
>
> | åç§°         | ä½ç½®                             |
> | :----------- | :------------------------------- |
> | etcd         | /usr/bin/etcd                    |
> | etcdctl      | /usr/bin/etcdctl                 |
> | etcd.service | /lib/systemd/system/etcd.service |
> | etcd.conf    | /etc/etcd/etcd.conf              |

**æ¨èä½¿ç”¨ äºŒè¿›åˆ¶ ã€ æºç ç¼–è¯‘ã€dockerå®‰è£…ï¼š**



### é«˜å¯ç”¨å®‰è£… â€“ é¿å…å•ç‚¹æ•…éšœ

::: tip å¯åŠ¨æ–¹å¼

+ é™æ€å¯åŠ¨
+ etcd åŠ¨æ€å‘ç°
+ DNS å‘ç°

:::



goreman æ˜¯ä¸€ä¸ª Goè¯­è¨€ ç¼–å†™çš„å¤šè¿›ç¨‹ç®¡ç†å·¥å…·ï¼Œæ˜¯å¯¹ ruby ä¸‹å¹¿æ³›ä½¿ç”¨çš„ Foreman çš„é‡å†™~

```bash
go get github.com/mattn/goreman
```

**å®‰è£…ï¼š**

```bash
go install github.com/mattn/goreman@latest
```



**ä½¿ç”¨goreman å¯åŠ¨ etcd é›†ç¾¤**

```bash
goreman -f /opt/procfile start
```



## dockeréƒ¨ç½²

::: tip 
ä¸ªäººæ¯”è¾ƒå€¾å‘äºè¿™ç§æ–¹å¼ï¼Œä¸ªäººç”µè„‘é…ç½®ä¸è¡Œ~

:::



### æ„å»ºæ€è·¯

| èŠ‚ç‚¹å | IPåœ°å€    |
| ------ | --------- |
| node1  | 10.2.36.1 |
| node2  | 10.2.36.2 |
| node3  | 10.2.36.3 |

æˆ‘ä»¬éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¿™ä¸‰ä¸ªèŠ‚ç‚¹å¯ä»¥åˆ†å¸ƒåœ¨ä¸åŒæœåŠ¡å™¨ï¼Œæœ¬æ¡ˆä¾‹ä¸­ï¼Œä»¥ä¸€å°æœåŠ¡å™¨åŸºäºDockerè¿è¡Œå¤šä¸ªå®¹å™¨æ¥åšæ¼”ç¤ºã€‚



### ä¸‹è½½Etcdé•œåƒ

```bash
root@ubuntu:~# docker pull quay.io/coreos/etcd
root@ubuntu:~# docker images | grep "etcd"
quay.io/coreos/etcd                                latest                           61ad63875109   4 years ago     39.5MB
```



### åˆ›å»ºè‡ªå®šä¹‰Dockerç½‘ç»œ

> [docker åŸºç¡€ç¯‡](https://docker.nsddd.top) æˆ‘ä»¬çŸ¥é“å•¦dockerç½‘ç»œæ¨¡å¼ï¼Œæˆ‘ä»¬é€‰æ‹©[è‡ªå®šä¹‰ç½‘ç»œ](https://docker.nsddd.top/markdown/31.html#%E6%80%BB%E4%BD%93%E4%BB%8B%E7%BB%8D)ã€‚

é¦–å…ˆæ„å»ºä¸ªè‡ªå®šä¹‰ç½‘ç»œï¼Œå› ä¸ºæˆ‘ä»¬è¦ç»™å„ä¸ªèŠ‚ç‚¹åˆ†é…IPåœ°å€ï¼ŒDockerå®¹å™¨é»˜è®¤ç½‘ç»œåªèƒ½è‡ªåŠ¨é…IPæ— æ³•æ‰‹åŠ¨åˆ†é…ã€‚

> âš ï¸ æ³¨æ„ï¼šå³ä½¿æ˜¯è‡ªå®šä¹‰ç½‘ç»œï¼Œæˆ‘é€‰æ‹©çš„ä¹Ÿæ˜¯é»˜è®¤çš„ç½‘æ¡¥æ¨¡å¼ï¼ˆ*åˆ›å»ºä¸€ä¸ªæ–°çš„bridgeç½‘ç»œ*ï¼‰
>
> 1. `--driver`ï¼šé©±åŠ¨ç¨‹åºç±»å‹
> 2. `--subnet`ï¼šä»£è¡¨ç½‘æ®µçš„ `CIDR` æ ¼å¼çš„å­ç½‘
> 3. `--gateway`ï¼šä¸»å­ç½‘çš„ `IPV4` å’Œ `IPV6` çš„ç½‘å…³
> 4. `mynet2`ï¼šæ˜¯è‡ªå®šä¹‰ç½‘ç»œåç§°

```bash
root@ubuntu:~# docker network create --driver bridge --subnet=10.2.36.0/16 --gateway=10.2.1.1 mynet2
be11fe7f1fc8ea9fe30e018297295b8c61a823bb31f647aa4da777fa3eee63a7

root@ubuntu:~# docker network ls |grep "mynet2"
be11fe7f1fc8   mynet2                     bridge    local
```



### åˆ›å»ºå¹¶å¯åŠ¨Etcdé•œåƒèŠ‚ç‚¹

::: tip å‚æ•°ğŸ“œ å¯¹ä¸‹é¢çš„è§£é‡Š
å¦‚å›¾è¡¨ï¼š

![image-20221118192826609](http://sm.nsddd.top/smimage-20221118192826609.png)

:::



::: details èŠ‚ç‚¹ 1 ğŸ”½

```bash
docker run -d \
-p 2479:2379 \
-p 2381:2380 \
--name node1 \
--network=mynet2 \
--ip 10.2.36.1 \
quay.io/coreos/etcd:latest \
etcd \
-name node1 \
-advertise-client-urls http://10.2.36.1:2379 \
-initial-advertise-peer-urls http://10.2.36.1:2380 \
-listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 \
-initial-cluster-token etcd-cluster \
-initial-cluster "node1=http://10.2.36.1:2380,node2=http://10.2.36.2:2380,node3=http://10.2.36.3:2380" \
-initial-cluster-state new
```

:::



::: details èŠ‚ç‚¹ 2 ğŸ”½

```bash
docker run -d \
-p 2579:2379 \
-p 2382:2380 \
--name node2 \
--network=mynet2 \
--ip 10.2.36.2 \
quay.io/coreos/etcd:latest \
etcd \
-name node2 \
-advertise-client-urls http://10.2.36.2:2379 \
-initial-advertise-peer-urls http://10.2.36.2:2380 \
-listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 \
-initial-cluster-token etcd-cluster \
-initial-cluster "node1=http://10.2.36.1:2380,node2=http://10.2.36.2:2380,node3=http://10.2.36.3:2380" \
-initial-cluster-state new
```

:::



::: details èŠ‚ç‚¹ 3 ğŸ”½

```bash
docker run -d \
-p 2679:2379 \
-p 2383:2380 \
--name node3 \
--network=mynet2 \
--ip 10.2.36.3 \
quay.io/coreos/etcd:latest \
etcd \
-name node3 \
-advertise-client-urls http://10.2.36.3:2379 \
-initial-advertise-peer-urls http://10.2.36.3:2380 \
-listen-client-urls http://0.0.0.0:2379 -listen-peer-urls http://0.0.0.0:2380 \
-initial-cluster-token etcd-cluster \
-initial-cluster "node1=http://10.2.36.1:2380,node2=http://10.2.36.2:2380,node3=http://10.2.36.3:2380" \
-initial-cluster-state new
```

:::



### verification

```bash
root@ubuntu:~# docker ps | grep "node"
2986d95eedd4   quay.io/coreos/etcd:latest   "etcd -name node3 -aâ€¦"   50 seconds ago       Up 49 seconds   0.0.0.0:2679->2379/tcp, :::2679->2379/tcp, 0.0
93e41bb72642   quay.io/coreos/etcd:latest   "etcd -name node2 -aâ€¦"   54 seconds ago       Up 53 seconds   0.0.0.0:2579->2379/tcp, :::2579->2379/tcp, 0.0
bae0df00930c   quay.io/coreos/etcd:latest   "etcd -name node1 -aâ€¦"   About a minute ago   Up 59 seconds   0.0.0.0:2479->2379/tcp, :::2479->2379/tcp, 0.0
```

![image-20221118193208499](http://sm.nsddd.top/smimage-20221118193208499.png)



::: tip succeed
é€šè¿‡etcdctl member listå‘½ä»¤å¯ä»¥æŸ¥è¯¢å‡ºæ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹çš„åˆ—è¡¨å³ä¸ºæˆåŠŸ

```
docker exec -it node1 etcdctl member list
docker exec -it node2 etcdctl member list
docker exec -it node3 etcdctl member list
```

![image-20221118193514366](http://sm.nsddd.top/smimage-20221118193514366.png)

:::

**è‡ªå®šä¹‰ç½‘ç»œæœ¬èº«å°±ç»´æŠ¤å¥½äº†ä¸»æœºåå’Œipçš„å¯¹åº”å…³ç³»ï¼ˆipå’ŒåŸŸåéƒ½èƒ½é€šï¼‰**



## åŠ¨æ€å‘ç°å¯åŠ¨ etcd



## etcd æ“ä½œ

åŸºäº etcd è‡ªå¸¦çš„å®¢æˆ·ç«¯å·¥å…· â€“ etcdctl æ¥è¿›è¡Œä¸€äº›åˆ—æ“ä½œï¼ŒåŒæ ·çš„ v2 å’Œ v3 çš„ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸ä¸€æ ·ä¼šçš„

::: tip 
etcdctl æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œï¼Œä¾¿äºæˆ‘ä»¬è¿›è¡ŒæœåŠ¡æµ‹è¯•æˆ–è€…æ‰‹åŠ¨ä¿®æ”¹æ•°æ®

```bash
export ETCDCTL_API=2
export ETCDCTL_API=3
```

**æŸ¥è¯¢ï¼š**

```
root@ubuntu:/c# docker exec -it node2 etcdctl -v
etcdctl version: 3.3.8
API version: 2
```

:::



### å¸¸ç”¨å‘½ä»¤

::: tip 
å¸¸ç”¨å‘½ä»¤åˆ†ä¸º **æ•°æ®åº“æ“ä½œ** å’Œ **éæ•°æ®åº“æ“ä½œ** ä¸¤ç§ç±»å‹ã€‚
:::



**å¸®åŠ©ä¿¡æ¯ï¼š**

```bash
etcdctl -h 
```



etcd åœ¨é”®çš„ç»„ç»‡ä¸Šé‡‡ç”¨äº†å±‚æ¬¡åŒ–çš„ç©ºé—´ç»“æ„ï¼ˆç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿä¸­ç›®å½•çš„æ¦‚å¿µï¼‰ï¼Œæ•°æ®åº“æ“ä½œå›´ç»•å¯¹é”®å€¼å’Œç›®å½•çš„ CRUD [å¢åˆ æ”¹æŸ¥]ï¼ˆç¬¦åˆ REST é£æ ¼çš„ä¸€å¥—æ“ä½œï¼šCreate, Read, Update, Deleteï¼‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€‚

**æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š**

```
ETCDCTL_API=3 etcdctl endpoint status --cluster -w table
```



**å¸¸ç”¨å‘½ä»¤ï¼š**

```bash
# åˆ—è¡¨
etcdctl ls /kube-centos/network/config
 
# æŸ¥çœ‹
etcdctl get /kube-centos/network/config
 
# v2ç§»é™¤
etcdctl rm /kube-centos/network/config
 
# v3ç§»é™¤
ETCDCTL_API=3 etcdctl del /kube-centos/network/config
 
# é€’å½’ç§»é™¤
etcdctl rm --recursive registry
 
# ä¿®æ”¹
etcdctl mk /kube-centos/network/config "{ \"Network\": \"172.30.0.0/16\", \"Backend\": { \"Type\": \"vxlan\" } }"
 
# å‘½ä»¤å°†æ•°æ®å­˜åˆ°æŒ‡å®šä½ç½®ã€‚è¿™éƒ¨åˆ†æ•°æ®å¯ä»¥ç”¨æ¥ç¾éš¾æ¢å¤
etcdctl backup
 
# å¥åº·æ£€æŸ¥
etcdctl endpoint health
```



**å‘½ä»¤åˆé›†ï¼š**

```bash
#å­˜å‚¨:
    curl http://127.0.0.1:4001/v2/keys/testkey -XPUT -d value='testvalue'
    curl -s http://127.0.0.1:4001/v2/keys/message2 -XPUT -d value='hello etcd' -d ttl=5
 
#è·å–:
    curl http://127.0.0.1:4001/v2/keys/testkey
 
#æŸ¥çœ‹ç‰ˆæœ¬:
    curl  http://127.0.0.1:4001/version
 
#åˆ é™¤:
    curl -s http://127.0.0.1:4001/v2/keys/testkey -XDELETE
 
#ç›‘è§†:
    çª—å£1ï¼šcurl -s http://127.0.0.1:4001/v2/keys/message2 -XPUT -d value='hello etcd 1'
          curl -s http://127.0.0.1:4001/v2/keys/message2?wait=true
    çª—å£2ï¼š
          curl -s http://127.0.0.1:4001/v2/keys/message2 -XPUT -d value='hello etcd 2'
 
è‡ªåŠ¨åˆ›å»ºkey:
    curl -s http://127.0.0.1:4001/v2/keys/message3 -XPOST -d value='hello etcd 1'
    curl -s 'http://127.0.0.1:4001/v2/keys/message3?recursive=true&sorted=true'
 
#åˆ›å»ºç›®å½•ï¼š
    curl -s http://127.0.0.1:4001/v2/keys/message8 -XPUT -d dir=true
 
#åˆ é™¤ç›®å½•ï¼š
    curl -s 'http://127.0.0.1:4001/v2/keys/message7?dir=true' -XDELETE
    curl -s 'http://127.0.0.1:4001/v2/keys/message7?recursive=true' -XDELETE
 
#æŸ¥çœ‹æ‰€æœ‰key:
    curl -s http://127.0.0.1:4001/v2/keys/?recursive=true
 
#å­˜å‚¨æ•°æ®ï¼š
    curl -s http://127.0.0.1:4001/v2/keys/file -XPUT --data-urlencode value@upfile
 
 
#ä½¿ç”¨etcdctlå®¢æˆ·ç«¯ï¼š
 
#å­˜å‚¨:
    etcdctl set /liuyiling/testkey "610" --ttl '100'
                                         --swap-with-value value
 
#è·å–ï¼š
    etcdctl get /liuyiling/testkey
 
#æ›´æ–°ï¼š
    etcdctl update /liuyiling/testkey "world" --ttl '100'
 
#åˆ é™¤ï¼š
    etcdctl rm /liuyiling/testkey
 
#ä½¿ç”¨caè·å–ï¼š
etcdctl --cert-file=/etc/etcd/ssl/etcd.pem   --key-file=/etc/etcd/ssl/etcd-key.pem  --ca-file=/etc/etcd/ssl/ca.pem get /message
 
#ç›®å½•ç®¡ç†ï¼š
 
    etcdctl mk /liuyiling/testkey "hello"    ç±»ä¼¼set,ä½†æ˜¯å¦‚æœkeyå·²ç»å­˜åœ¨ï¼ŒæŠ¥é”™
 
    etcdctl mkdir /liuyiling 
 
    etcdctl setdir /liuyiling  
 
    etcdctl updatedir /liuyiling      
 
    etcdctl rmdir /liuyiling    
 
#æŸ¥çœ‹ï¼š
    etcdctl ls --recursive
 
#ç›‘è§†ï¼š
    etcdctl watch mykey  --forever         +    etcdctl update mykey "hehe"
 
    #ç›‘è§†ç›®å½•ä¸‹æ‰€æœ‰èŠ‚ç‚¹çš„æ”¹å˜
 
    etcdctl exec-watch --recursive /foo -- sh -c "echo hi"
 
    etcdctl exec-watch mykey -- sh -c 'ls -al'    +    etcdctl update mykey "hehe"
 
    etcdctl member list
```



#### å¯¹è±¡ä¸ºé”®å€¼

1.  set[å¢:æ— è®ºæ˜¯å¦å­˜åœ¨]:`etcdctl set key value`

2.  mk[å¢:å¿…é¡»ä¸å­˜åœ¨]:`etcdctl mk key value`

3.  rm[åˆ ]:`etcdctl rm key`

4.  update[æ”¹]:`etcdctl update key value`

5.  get[æŸ¥]:`etcdctl get key`



#### å¯¹è±¡ä¸ºç›®å½•

1.  setdir[å¢:æ— è®ºæ˜¯å¦å­˜åœ¨]:`etcdctl setdir dir`

2.  mkdir[å¢:å¿…é¡»ä¸å­˜åœ¨]: `etcdctl mkdir dir`

3.  rmdir[åˆ ]:`etcdctl rmdir dir`

4.  updatedir[æ”¹]:`etcdctl updatedir dir`

5.  ls[æŸ¥]:`etcdclt ls`



###  éæ•°æ®åº“æ“ä½œå‘½ä»¤

1. backup[å¤‡ä»½ etcd çš„æ•°æ®]

   ```
   etcdctl backup
   ```

2. watch[ç›‘æµ‹ä¸€ä¸ªé”®å€¼çš„å˜åŒ–ï¼Œä¸€æ—¦é”®å€¼å‘ç”Ÿæ›´æ–°ï¼Œå°±ä¼šè¾“å‡ºæœ€æ–°çš„å€¼å¹¶é€€å‡º]

   ```
   etcdctl watch key
   ```

3. exec-watch[ç›‘æµ‹ä¸€ä¸ªé”®å€¼çš„å˜åŒ–ï¼Œä¸€æ—¦é”®å€¼å‘ç”Ÿæ›´æ–°ï¼Œå°±æ‰§è¡Œç»™å®šå‘½ä»¤]

   ```bash
   etcdctl exec-watch key --sh -c "ls"
   ```

4. member[é€šè¿‡ listã€addã€removeã€update å‘½ä»¤åˆ—å‡ºã€æ·»åŠ ã€åˆ é™¤ ã€æ›´æ–°etcd å®ä¾‹åˆ° etcd é›†ç¾¤ä¸­]

   ```
   etcdctl member listï¼›etcdctl member add å®ä¾‹ï¼›etcdctl member remove å®ä¾‹ï¼›etcdctl member update å®ä¾‹ã€‚
   ```

5.  etcdctl cluster-health[æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€]



### å¸¸ç”¨é…ç½®å‚æ•°

è®¾ç½®é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º`/etc/etcd/etcd.conf`ã€‚

| é…ç½®å‚æ•°                     | å‚æ•°è¯´æ˜                                                     |
| :--------------------------- | :----------------------------------------------------------- |
| é…ç½®å‚æ•°                     | å‚æ•°è¯´æ˜                                                     |
| -name                        | èŠ‚ç‚¹åç§°                                                     |
| -data-dir                    | ä¿å­˜æ—¥å¿—å’Œå¿«ç…§çš„ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•ï¼ŒæŒ‡å®šèŠ‚ç‚¹çš„æ•°æ®å­˜å‚¨ç›®å½• |
| -addr                        | å…¬å¸ƒçš„ipåœ°å€å’Œç«¯å£ã€‚ é»˜è®¤ä¸º127.0.0.1:2379                    |
| -bind-addr                   | ç”¨äºå®¢æˆ·ç«¯è¿æ¥çš„ç›‘å¬åœ°å€ï¼Œé»˜è®¤ä¸º-addré…ç½®                    |
| -peers                       | é›†ç¾¤æˆå‘˜é€—å·åˆ†éš”çš„åˆ—è¡¨ï¼Œä¾‹å¦‚ 127.0.0.1:2380,127.0.0.1:2381   |
| -peer-addr                   | é›†ç¾¤æœåŠ¡é€šè®¯çš„å…¬å¸ƒçš„IPåœ°å€ï¼Œé»˜è®¤ä¸º 127.0.0.1:2380.           |
| -peer-bind-addr              | é›†ç¾¤æœåŠ¡é€šè®¯çš„ç›‘å¬åœ°å€ï¼Œé»˜è®¤ä¸º-peer-addré…ç½®                 |
| -wal-dir                     | æŒ‡å®šèŠ‚ç‚¹çš„wasæ–‡ä»¶çš„å­˜å‚¨ç›®å½•ï¼Œè‹¥æŒ‡å®šäº†è¯¥å‚æ•°ï¼Œwalæ–‡ä»¶ä¼šå’Œå…¶ä»–æ•°æ®æ–‡ä»¶åˆ†å¼€å­˜å‚¨ |
| -listen-client-urls          |                                                              |
| -listen-peer-urls            | ç›‘å¬URLï¼Œç”¨äºä¸å…¶ä»–èŠ‚ç‚¹é€šè®¯                                  |
| -initial-advertise-peer-urls | å‘ŠçŸ¥é›†ç¾¤å…¶ä»–èŠ‚ç‚¹url.                                         |
| -advertise-client-urls       | å‘ŠçŸ¥å®¢æˆ·ç«¯url, ä¹Ÿå°±æ˜¯æœåŠ¡çš„url                               |
| -initial-cluster-token       | é›†ç¾¤çš„ID                                                     |
| -initial-cluster             | é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹                                               |
| -initial-cluster-state       | -initial-cluster-state=new è¡¨ç¤ºä»æ— åˆ°æœ‰æ­å»ºetcdé›†ç¾¤          |
| -discovery-srv               | ç”¨äºDNSåŠ¨æ€æœåŠ¡å‘ç°ï¼ŒæŒ‡å®šDNS SRVåŸŸå                         |
| -discovery                   | ç”¨äºetcdåŠ¨æ€å‘ç°ï¼ŒæŒ‡å®šetcdå‘ç°æœåŠ¡çš„URL [https://discovery.etcd.io/],ç”¨ç¯å¢ƒå˜é‡è¡¨ç¤º |



## Go å’Œ etcd äº¤äº’

```go
package main

import (
	"context"
	"log"
	"time"

	"go.etcd.io/etcd/client/v3"
)

func main() {
	cli, err := clientv3.New(clientv3.Config{
		Endpoints:   []string{"http://10.2.36.1:2479", "http://10.2.36.2:2579", "http://10.2.36.3:2679"},
		DialTimeout: 5 * time.Second,
	})
	if err != nil {
		panic(err)
	}
	defer cli.Close()

	testKey := "/test/key"	//è®¾ç½® key
	testValue := "I love docker"  //è®¾ç½® value

	_, err = cli.Put(context.Background(), testKey, testValue)
	if err != nil {
		log.Fatal("Put failed:", err)
	}

	res, err := cli.Get(context.Background(), testKey)
	if err != nil {
		log.Fatal("Get failed:", err)
	}

	kvs := res.Kvs
	val := string(kvs[0].Value)
	log.Println("result:", val == testValue)
}

```



## gPRC ä»£ç†æ¨¡å¼

::: tip gPRC ä»£ç†æ¨¡å¼ â€“ å®ç°å¯ä¼¸ç¼©çš„ etcd API
gRPC proxy æ˜¯åœ¨ gRPC å±‚ è¿è¡Œçš„æ— çŠ¶æ€ etcd åå‘ä»£ç†

æ—¨åœ¨å‡å°‘ etcd é›†ç¾¤ä¸Šçš„æ€»å¤„ç†è´Ÿè½½

:::







## END é“¾æ¥

<ul><li><div><a href = '23.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '25.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

