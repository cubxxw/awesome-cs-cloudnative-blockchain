# docker è”åˆæ–‡ä»¶ç³»ç»Ÿ æ·±å…¥è§£è¯»

[[toc]]

[toc]

## ä½œç”¨

è·å–[å®¹å™¨](https://cloud.tencent.com/product/tke?from=10680)/é•œåƒçš„å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰



## å‘½ä»¤æ ¼å¼

```bash
docker inspect [OPTIONS] NAME|ID [NAME|ID...]
```

::: tip options è¯´æ˜

| option | è¯´æ˜                             |
| :----- | :------------------------------- |
| -f     | æŒ‡å®šè¿”å›å€¼çš„æ¨¡æ¿æ–‡ä»¶             |
| -s     | å¦‚æœç±»å‹ä¸ºå®¹å™¨ï¼Œåˆ™æ˜¾ç¤ºæ–‡ä»¶æ€»å¤§å° |
| --type | è¿”å›æŒ‡å®šç±»å‹çš„JSON               |

:::



## ç­›é€‰

**è·å– IP åœ°å€ï¼š**

```bash
docker inspect tomcat7 | grep IPAddress
```



**è·å– Dir ï¼š**

> æˆ‘ä¸»è¦æ˜¯å¸Œæœ›å¾ˆç†Ÿæ‚‰ Data å­—æ®µï¼Œæ‰€ä»¥åé¢é‡ç‚¹è¯´æ˜~

```yaml
[root@VM-4-6-centos 123]# docker  inspect -s 40da9cff87a0 |grep "Dir"
                "LowerDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57-init/diff:/var/lib/docker/overlay2/2e6f81e45b3db01494296c925185d77831443eca0dd3cbf119f8d32190f90d5c/diff:/var/lib/docker/overlay2/ebf60447144fb679348fc4534bc30b68ce19618aac23b39ee93e5f941d6b13bc/diff:/var/lib/docker/overlay2/eb6694dc2ad08ab91f8f4e3f00bf7481d2c59df52c3a1553f0b7f3c3512179ed/diff:/var/lib/docker/overlay2/c4acacb9aa7f0e60af79eeb6cb7506d736df1789710da7f7e53747feffaead95/diff:/var/lib/docker/overlay2/29165236db2b92b69ae83bc679d17cf7237880dde09e5d3c1f5890ca6e907861/diff:/var/lib/docker/overlay2/3b17651312652668a9c2ef61df2a957ca7ceeb6307166a23a5726ca8dbaf1c23/diff:/var/lib/docker/overlay2/23a2a19d74c1945307e606a0df77496e2bdca76b85ea9058bd76a1cb9e1be205/diff:/var/lib/docker/overlay2/2916a80e9370af849f411871cad64cbb13d04617c91e66f45a16cbe979ffe88f/diff:/var/lib/docker/overlay2/d78b6c08a6749d7b88e7eb4fac33de1355cb1d926fcb01a8b1c72361d1867cbc/diff:/var/lib/docker/overlay2/be49972d15fe94755593cfd846c231d2a18e625a256fa86fe62e131e711f200a/diff",
                "MergedDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/merged",
                "UpperDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/diff",
                "WorkDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/work"
            "WorkingDir": "/application",
```



## docker GraphDriver

è¿™é‡Œæˆ‘ä»¬äº†è§£ä¸€ä¸‹ docker çš„é•œåƒå­˜å‚¨ï¼Œåœ¨Dockerä¸­ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„æ¦‚å¿µå°±æ˜¯ `GraphDriver`ï¼Œå®ƒä¸»è¦ç”¨äºç®¡ç†å’Œç»´æŠ¤é•œåƒï¼ŒåŒ…æ‹¬æŠŠé•œåƒä»ä»“åº“ä¸‹è½½ä¸‹æ¥ï¼Œåˆ°è¿è¡Œæ—¶æŠŠé•œåƒæŒ‚è½½èµ·æ¥å¯ä»¥è¢«å®¹å™¨è®¿é—®ç­‰ï¼Œéƒ½æ˜¯`GraphDriver`å»å®Œæˆçš„ã€‚



**æˆ‘ä»¬ä»¥ Golang é•œåƒä¸ºå‡†ï¼š**

```bash
 docker  inspect -s golang 
```

**å­—æ®µ GraphDriverï¼š**

```yaml
 "GraphDriver": {
            "Name": "overlay2",
            "Data": {
                "LowerDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57-init/diff:/var/lib/docker/overlay2/2e6f81e45b3db01494296c925185d77831443eca0dd3cbf119f8d32190f90d5c/diff:/var/lib/docker/overlay2/ebf60447144fb679348fc4534bc30b68ce19618aac23b39ee93e5f941d6b13bc/diff:/var/lib/docker/overlay2/eb6694dc2ad08ab91f8f4e3f00bf7481d2c59df52c3a1553f0b7f3c3512179ed/diff:/var/lib/docker/overlay2/c4acacb9aa7f0e60af79eeb6cb7506d736df1789710da7f7e53747feffaead95/diff:/var/lib/docker/overlay2/29165236db2b92b69ae83bc679d17cf7237880dde09e5d3c1f5890ca6e907861/diff:/var/lib/docker/overlay2/3b17651312652668a9c2ef61df2a957ca7ceeb6307166a23a5726ca8dbaf1c23/diff:/var/lib/docker/overlay2/23a2a19d74c1945307e606a0df77496e2bdca76b85ea9058bd76a1cb9e1be205/diff:/var/lib/docker/overlay2/2916a80e9370af849f411871cad64cbb13d04617c91e66f45a16cbe979ffe88f/diff:/var/lib/docker/overlay2/d78b6c08a6749d7b88e7eb4fac33de1355cb1d926fcb01a8b1c72361d1867cbc/diff:/var/lib/docker/overlay2/be49972d15fe94755593cfd846c231d2a18e625a256fa86fe62e131e711f200a/diff",
                "MergedDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/merged",
                "UpperDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/diff",
                "WorkDir": "/var/lib/docker/overlay2/0a0abda0165a1342ddac4ba3263352d79564e9a56dfdb497ac66e25030bb5b57/work"
            }
        },
```

::: warning ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Š 
![image-20221125163549549](http://sm.nsddd.top/smimage-20221125163549549.png)

+ LowerDirï¼šåŒ…å«å®¹å™¨å†…æ‰€æœ‰å±‚çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åä¸€å±‚é™¤å¤–
+ UpperDirï¼šå®¹å™¨æœ€ä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿã€‚è¿™ä¹Ÿæ˜¯åæ˜ ä»»ä½•è¿è¡Œæ—¶ä¿®æ”¹çš„åœ°æ–¹ã€‚
+ MergedDirï¼šæ–‡ä»¶ç³»ç»Ÿæ‰€æœ‰å±‚çš„ç»„åˆè§†å›¾ã€‚
+ WorkDirï¼šç”¨äºç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å†…éƒ¨å·¥ä½œç›®å½•ã€‚

:::



### å®¹å™¨å†…

```bash
 docker exec -it golang:latest /bin/bash 
```

**æ ¹ç›®å½•ï¼š**

```bash
root@cbd9c47e79e3:/# cd /; mkdir 111;cd 111; echo "this a test file" >> test.txt; ls
test.txt
go version go1.19.3 linux/amd64
root@cbd9c47e79e3:/111# whereis go
go: /usr/local/go /usr/local/go/bin/go
```

**Goè¯­è¨€å·¥ä½œç›®å½•ï¼š**

```bash
root@cbd9c47e79e3:/usr/local/go/bin# ls -al go
-rwxr-xr-x 1 root root 15301490 Oct 31 20:20 go
root@cbd9c47e79e3:/usr/local/go/bin# pwd 
/usr/local/go/bin
root@cbd9c47e79e3:/usr/local/go/bin# ./go version
go version go1.19.3 linux/amd64
```



### lower

`æœ€åä¸€å±‚é™¤å¤–`ï¼šè¿™ä¸ªæ„æ€å°±æ˜¯æˆ‘ä»¬çš„å¯å†™å±‚ï¼Œæˆ‘ä»¬å¯¹å®¹å™¨çš„ä¿®æ”¹ï¼Œéƒ½æ˜¯åœ¨è¿™å±‚ä¸Šé¢è¿›è¡Œçš„ï¼Œå³æˆ‘ä»¬å®¹å™¨é‡Œé¢çš„ `cd /; mkdir 111;cd 111; echo "this a test file" >> test.txt;` è¿™ä¸ªæ–‡ä»¶åœ¨LowerDiré‡Œçœ‹ä¸åˆ°ã€‚



**MergedDir**

åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªå®¹å™¨é‡Œé¢çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬ä¿®æ”¹çš„(**æ³¨æ„æ˜¯å®¹å™¨**)

```bash
[root@VM-4-6-centos merged]# cd /var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/merged
[root@VM-4-6-centos merged]# ls
111  bin  boot  dev  etc  go  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
```

::: warning æµ‹è¯•é‡Œé¢çš„ç¯å¢ƒå˜é‡
æ˜¯ä¸æ˜¯å¯ä»¥å°†é‡Œé¢çš„ Goè¯­è¨€ ç¯å¢ƒå˜é‡ä½ç½®é…ç½®åˆ°ä¸»æœºä¸­ï¼Ÿï¼Ÿï¼Ÿæˆ‘è§‰å¾—è¿™æ ·å¥½ç©

:::

**å½“å‰ä½ç½®ï¼š**

```bash
[root@VM-4-6-centos bin]# ls
go  gofmt
[root@VM-4-6-centos bin]# pwd
/var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/merged/usr/local/go/bin
[root@VM-4-6-centos bin]# cp go golangtext
```

**åŠ å…¥ç¯å¢ƒå˜é‡ï¼š**

```bash
[root@VM-4-6-centos bin]# cp go golangtext

# åŠ å…¥ç¯å¢ƒå˜é‡
[root@VM-4-6-centos root]# cat /etc/profile.d/mypath 
export GO_TEST=$"/var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/merged/usr/local/go"
export PATH=$PATH:$GO_TEST/bin
```

**æµ‹è¯•ï¼š**

```bash
[root@VM-4-6-centos root]# golangtext version
go: cannot find GOROOT directory: /root/.g/go
```



### UpperDir

`WorkDir`ï¼šç”¨äºç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å†…éƒ¨å·¥ä½œç›®å½•

æˆ‘ä»¬åœ¨ Dockerfile ä¸­å¯æŒ‡å®š workspacesï¼Œå³ä½¿åœ¨ GitHub çš„ codespaces ä¸­ï¼Œworkspaces ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚

```
[root@VM-4-6-centos root]# cd /var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/work
[root@VM-4-6-centos work]# ls
work
[root@VM-4-6-centos work]# cd work/
[root@VM-4-6-centos work]# ls
```



::: tip æ¨èæ–‡ç« 

+ [å…³äºæ–‡ä»¶ç³»ç»Ÿå¦‚ä½•å·¥ä½œçš„-](https://martinheinz.dev/blog/44)

:::



##  `/proc/<pid>/root`

æˆ‘ä»¬åˆ°ç°åœ¨çŸ¥é“äº† `Pid` åœ¨ docker ä¸­èµ·åˆ°äº†å¤šä¹ˆé‡è¦çš„ä½œç”¨ï¼Œè¿™ä¸ªå…³ä¹ç€æˆ‘ä»¬æœªæ¥æ„å»º docker çš„è®¡åˆ’~

æœ‰ä¸€ç§æ›´ç®€å•çš„æ–¹æ³•å¯ä»¥ä»ä¸»æœºæ‰¾åˆ°å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚ä½¿ç”¨å®¹å™¨å†…è¿›ç¨‹çš„ä¸»æœº PIDï¼Œæ‚¨å¯ä»¥ç®€å•åœ°è¿è¡Œï¼š

```bash
sudo ls /proc/<pid>/root
```

 Linux å·²ç»è´Ÿè´£ä¸ºæ‚¨æä¾›è¿›ç¨‹çš„æŒ‚è½½å‘½åç©ºé—´è§†å›¾ã€‚



### è·å–å‘½åç©ºé—´

::: tip 
å®¹å™¨è¿›ç¨‹å°±åƒ Linux ä¸»æœºä¸Šçš„å…¶ä»–è¿›ç¨‹ä¸€æ ·ï¼Œåªåœ¨å‘½åç©ºé—´å†…è¿è¡Œï¼Œä»¥ä½¿å®ƒä»¬ä¸ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»ã€‚
:::

å› æ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [`nsenter`](https://man7.org/linux/man-pages/man1/nsenter.1.html) å‘½ä»¤è¾“å…¥ç›®æ ‡å®¹å™¨çš„å‘½åç©ºé—´

```bash
# Get the host PID of the process in the container
PID=$(docker container inspect mycontainer | jq '.[0].State.Pid')

# Use nsenter to go into the containerâ€™s mount namespace.
sudo nsenter -m -t $PID /bin/bash
```



### è·å– PID

å‰æï¼šæˆ‘ä»¬çŸ¥é“äº† å®¹å™¨ ID

```
docker inspect -f '{{.State.Pid}}'
```



**ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š**

```bash
[root@VM-4-6-centos work]# docker ps
CONTAINER ID        IMAGE                          COMMAND                  CREATED             STATUS                      PORTS                    NAMES
cbd9c47e79e3        golang                         "bash"                   About an hour ago   Up About an hour                                     jolly_chandrasekhar
40da9cff87a0        docker.io/halohub/halo:1.6.0   "/bin/sh -c 'java ..."   11 days ago         Restarting (1) 2 days ago                            halo-next
0b35d2dcb578        3293172751/halo_myblog:2.0     "/bin/sh -c 'java ..."   3 weeks ago         Up 11 days                  0.0.0.0:8090->8090/tcp   halo2
[root@VM-4-6-centos work]# docker inspect -f '{{.State.Pid}}' cbd9c47e79e3
1050
```



::: danger æˆ–è€…ä½ è¿˜å¯ä»¥é€šè¿‡container è·å–

```
docker container top
```

:::



### æŸ¥çœ‹`/proc/<pid>/root`

```bash
[root@VM-4-6-centos work]# ll /proc/1050/root/
total 76
drwxr-xr-x   2 root root 4096 Nov 25 16:10 111
drwxr-xr-x   1 root root 4096 Nov 15 18:23 bin
drwxr-xr-x   2 root root 4096 Sep  3 20:10 boot
drwxr-xr-x   5 root root  360 Nov 25 15:28 dev
drwxr-xr-x   1 root root 4096 Nov 25 15:28 etc
drwxrwxrwx   4 root root 4096 Nov 16 12:16 go
drwxr-xr-x   2 root root 4096 Sep  3 20:10 home
drwxr-xr-x   1 root root 4096 Nov 16 12:16 lib
drwxr-xr-x   2 root root 4096 Nov 14 08:00 lib64
drwxr-xr-x   2 root root 4096 Nov 14 08:00 media
drwxr-xr-x   2 root root 4096 Nov 14 08:00 mnt
drwxr-xr-x   2 root root 4096 Nov 14 08:00 opt
dr-xr-xr-x 159 root root    0 Nov 25 15:28 proc
drwx------   2 root root 4096 Nov 14 08:00 root
drwxr-xr-x   1 root root 4096 Nov 25 15:28 run
drwxr-xr-x   1 root root 4096 Nov 15 18:23 sbin
drwxr-xr-x   2 root root 4096 Nov 14 08:00 srv
dr-xr-xr-x  13 root root    0 Nov 25 15:28 sys
drwxrwxrwt   1 root root 4096 Nov 16 12:16 tmp
drwxr-xr-x   1 root root 4096 Nov 14 08:00 usr
drwxr-xr-x   1 root root 4096 Nov 14 08:00 var
```



### å®¹å™¨è¿›ç¨‹ç›®å½•ä¸‹æœ‰ä»€ä¹ˆï¼Ÿ

```bash
[root@VM-4-6-centos work]# cd /proc/1050/
[root@VM-4-6-centos 1050]# ls
attr        comm             fd        map_files   net            pagemap      schedstat  statm    wchan
autogroup   coredump_filter  fdinfo    maps        ns             patch_state  sessionid  status
auxv        cpuset           gid_map   mem         numa_maps      personality  setgroups  syscall
cgroup      cwd              io        mountinfo   oom_adj        projid_map   smaps      task
clear_refs  environ          limits    mounts      oom_score      root         stack      timers
cmdline     exe              loginuid  mountstats  oom_score_adj  sched        stat       uid_map
```



**æŸ¥çœ‹ `/mountinfo`**

```bash
[root@VM-4-6-centos 1050]# cat mountinfo | head -n 10
659 493 0:157 / / rw,relatime - overlay overlay rw,lowerdir=/var/lib/docker/overlay2/l/PIDEMVBEIEE3VONRURI4Z4EUJX:/var/lib/docker/overlay2/l/BWR7ZEPY4UYAKRS3ZCHZZ6EGTP:/var/lib/docker/overlay2/l/34HR5PAPLZ5473EG5FNPRQLLYQ:/var/lib/docker/overlay2/l/AGIW6BJEBXJNUEBZI67DHV73UC:/var/lib/docker/overlay2/l/6XDUP6AULW7Z4AT5NPHVTGD4SH:/var/lib/docker/overlay2/l/WRKLDD6PZE5FYTSPKPED7F3N7L:/var/lib/docker/overlay2/l/PLPE7MKV5TXKVZFBCSK7ZPA7FD:/var/lib/docker/overlay2/l/BT7MBYLOPX66TO6QWWYBELSZN2,upperdir=/var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/diff,workdir=/var/lib/docker/overlay2/4ff3e2faabfa51f38c884c1321e20609352f5e009239d146161ec75bc806c3c5/work
660 659 0:160 / /proc rw,nosuid,nodev,noexec,relatime - proc proc rw
661 659 0:161 / /dev rw,nosuid - tmpfs tmpfs rw,mode=755
662 661 0:162 / /dev/pts rw,nosuid,noexec,relatime - devpts devpts rw,gid=5,mode=620,ptmxmode=666
663 659 0:163 / /sys ro,nosuid,nodev,noexec,relatime - sysfs sysfs ro
664 663 0:164 / /sys/fs/cgroup ro,nosuid,nodev,noexec,relatime - tmpfs tmpfs rw,mode=755
665 664 0:22 /system.slice/docker-cbd9c47e79e39457d638b8d0552aeb2c646dbd7ade72f41f8ffc48ea91188322.scope /sys/fs/cgroup/systemd ro,nosuid,nodev,noexec,relatime - cgroup cgroup rw,xattr,release_agent=/usr/lib/systemd/systemd-cgroups-agent,name=systemd
666 664 0:24 /system.slice/docker-cbd9c47e79e39457d638b8d0552aeb2c646dbd7ade72f41f8ffc48ea91188322.scope /sys/fs/cgroup/blkio ro,nosuid,nodev,noexec,relatime - cgroup cgroup rw,blkio
667 664 0:25 /system.slice/docker-cbd9c47e79e39457d638b8d0552aeb2c646dbd7ade72f41f8ffc48ea91188322.scope /sys/fs/cgroup/hugetlb ro,nosuid,nodev,noexec,relatime - cgroup cgroup rw,hugetlb
668 664 0:26 /system.slice/docker-cbd9c47e79e39457d638b8d0552aeb2c646dbd7ade72f41f8ffc48ea91188322.scope /sys/fs/cgroup/net_prio,net_cls ro,nosuid,nodev,noexec,relatime - cgroup cgroup rw,net_prio,net_cls
```

å¯ä»¥çœ‹åˆ°å®¹å™¨å·²æŒ‚è½½äº†ä¸€ä¸ªè¦†ç›–æ–‡ä»¶ç³»ç»Ÿä½œä¸ºå…¶æ ¹ã€‚å®ƒè¿˜æŠ¥å‘Šä¸ `docker inspect`æŠ¥å‘Šç›¸åŒç±»å‹çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„ `LowerDir` å’Œ `UpperDir`ã€‚å®ƒä¸ç›´æ¥æ˜¾ç¤º `MergedDir`ï¼Œä½†æ‚¨åªéœ€ä½¿ç”¨ `UpperDir` å¹¶å°† `diff` æ›´æ”¹ä¸º`merged`ï¼Œæ‚¨å°±å¯ä»¥æŸ¥çœ‹å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚



## æœ€å

å¸Œæœ›æˆ‘ä»¬éƒ½å¯ä»¥æ·±å…¥ç†è§£å®¹å™¨ï¼Œèƒ½å°è¯•å…¶ä¸­çš„ä¸€äº›æŠ€æœ¯ã€‚ä¸€æ—¦ä½ ä½“éªŒåˆ°ä¸å†å—å®¹å™¨ä»£ç é™åˆ¶çš„è‡ªç”±ï¼Œä½ å¯èƒ½å†ä¹Ÿå›ä¸å»äº†ã€‚å®ƒæ‰€éœ€è¦çš„åªæ˜¯ç®€å•åœ°è®¿é—® /`/proc/<pid>/root`~