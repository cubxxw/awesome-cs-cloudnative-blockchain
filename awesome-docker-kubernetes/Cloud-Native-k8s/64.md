+ [author](http://nsddd.top)

# ç¬¬64èŠ‚ kubeadmæ¦‚è¿°ã€åŸç†ã€ä»¥åŠéƒ¨åˆ†æºç é˜…è¯»

<div><a href = '63.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '65.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## kubeadm

+ [github kubeadm design docs](https://github.com/kubernetes/kubeadm/blob/main/docs/design/)

æˆ‘ä»¬åœ¨å‰é¢å‡ åä¸ªå°èŠ‚å­¦ä¹ ä¸­ä¹ŸçŸ¥é“äº† REST APIæ˜¯Kubernetesçš„åŸºæœ¬ç»“æ„ã€‚ç»„ä»¶å’Œå¤–éƒ¨ç”¨æˆ·å‘½ä»¤ä¹‹é—´çš„æ‰€æœ‰æ“ä½œå’Œé€šä¿¡éƒ½æ˜¯APIæœåŠ¡å™¨å¤„ç†çš„REST APIè°ƒç”¨ã€‚å› æ­¤ï¼ŒKuberneteså¹³å°ä¸­çš„æ‰€æœ‰å†…å®¹éƒ½è¢«è§†ä¸ºAPIå¯¹è±¡ï¼Œå¹¶ä¸”åœ¨APIä¸­æœ‰ç›¸åº”çš„æ¡ç›®ã€‚

å¤§å¤šæ•°æ“ä½œéƒ½å¯ä»¥é€šè¿‡[`kubectl`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/kubectl_cli/overview_of_kubectl.html)å‘½ä»¤è¡Œç•Œé¢æˆ–å…¶ä»–å‘½ä»¤è¡Œå·¥å…·(å¦‚[`kubeadm`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/overview_of_kubeadm.html))æ‰§è¡Œï¼Œè€Œè¿™äº›å·¥å…·åˆä½¿ç”¨APIã€‚ä¸è¿‡ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨RESTè°ƒç”¨ç›´æ¥è®¿é—®APIã€‚

Kubeadmæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæä¾›`kubeadm init`å’Œ`kubeadm join`ä½œä¸ºåˆ›å»ºKubernetesé›†ç¾¤çš„æœ€ä½³å®è·µâ€œå¿«æ·è·¯å¾„â€ã€‚

> kubeadmæ˜¯ä¸€ä¸ªç”¨äºéƒ¨ç½²Kubernetesé›†ç¾¤çš„å·¥å…·ã€‚å®ƒè¢«è®¾è®¡ç”¨äºè‡ªåŠ¨åŒ–å¤§å¤šæ•°Kubernetesé›†ç¾¤çš„éƒ¨ç½²ä»»åŠ¡ï¼Œä»è€Œä½¿Kubernetesé›†ç¾¤çš„éƒ¨ç½²å˜å¾—æ›´åŠ ç®€å•å’Œé«˜æ•ˆã€‚kubeadmè´Ÿè´£åˆå§‹åŒ–MasterèŠ‚ç‚¹ï¼Œå¹¶åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…Kubernetesç»„ä»¶ã€‚å®ƒè¿˜å¯ä»¥æ·»åŠ WorkerèŠ‚ç‚¹ï¼Œä»¥ä¾¿å°†å®ƒä»¬æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚

kubeadmæ‰§è¡Œå¿…è¦çš„æ“ä½œæ¥å¯åŠ¨å’Œè¿è¡Œæœ€å°å¯è¡Œé›†ç¾¤ã€‚æŒ‰ç…§è®¾è®¡ï¼Œå®ƒåªå…³å¿ƒå¼•å¯¼ï¼Œè€Œä¸å…³å¿ƒé…ç½®æœºå™¨ã€‚åŒæ ·ï¼Œå®‰è£…å„ç§æ¼‚äº®çš„æ’ä»¶(æ¯”å¦‚Kubernetes Dashboardã€ç›‘æ§è§£å†³æ–¹æ¡ˆå’Œç‰¹å®šäºäº‘çš„æ’ä»¶)ä¹Ÿä¸åœ¨è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚

ç›¸åï¼Œæˆ‘ä»¬æœŸæœ›åœ¨kubeadmçš„åŸºç¡€ä¸Šæ„å»ºæ›´é«˜çº§ã€æ›´å®šåˆ¶åŒ–çš„å·¥å…·ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œä½¿ç”¨kubeadmä½œä¸ºæ‰€æœ‰éƒ¨ç½²çš„åŸºç¡€å°†ä½¿åˆ›å»ºç¬¦åˆè§„èŒƒçš„é›†ç¾¤å˜å¾—æ›´å®¹æ˜“ã€‚



## kubeadm init

æ­¤å‘½ä»¤ç”¨äºåˆå§‹åŒ–Kubernetesæ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚

`init`å‘½ä»¤æ‰§è¡Œä»¥ä¸‹é˜¶æ®µ:

1. **preflight** è¿è¡Œé¢„æ£€æŸ¥
2. **certs**ï¼šè¯ä¹¦ç”Ÿæˆ
   + **/ca** ç”Ÿæˆç”¨äºä¸ºå…¶ä»–Kubernetesç»„ä»¶æä¾›èº«ä»½çš„è‡ªç­¾åKubernetes CA
   + **/apiserver** ç”Ÿæˆç”¨äºæä¾›Kubernetes APIçš„è¯ä¹¦
   + **/apiserver-kubelet-client** ç”ŸæˆAPIæœåŠ¡å™¨ç”¨äºè¿æ¥kubeletçš„è¯ä¹¦
   + **/front-proxy-ca** ç”Ÿæˆç”¨äºæä¾›å‰ç½®ä»£ç†èº«ä»½çš„è‡ªç­¾åCA
   + **/front-proxy-client** ç”Ÿæˆå‰ç½®ä»£ç†å®¢æˆ·ç«¯è¯ä¹¦
   + **/etcd-ca** ç”Ÿæˆç”¨äºä¸ºetcdæä¾›èº«ä»½çš„è‡ªç­¾åCA
   + **/etcd-server** ç”Ÿæˆç”¨äºæä¾›etcdæœåŠ¡çš„è¯ä¹¦
   + **/etcd-peer** ç”Ÿæˆä¾›etcdèŠ‚ç‚¹ç›¸äº’é€šä¿¡çš„è¯ä¹¦
   + **/etcd-healthcheck-client** ç”Ÿæˆç”¨äºå¥åº·æ£€æŸ¥etcdçš„æ´»æ€§æ¢é’ˆè¯ä¹¦
   + **/apiserver-etcd-client** ç”Ÿæˆapiserverç”¨äºè®¿é—®etcdçš„è¯ä¹¦
   + **/sa** ç”Ÿæˆç”¨äºç­¾ç½²æœåŠ¡å¸æˆ·ä»¤ç‰Œçš„ç§é’¥åŠå…¶å…¬é’¥
3. **kubeconfig**ï¼šç”Ÿæˆæ‰€æœ‰kubeconfigæ–‡ä»¶ï¼Œä»¥å»ºç«‹æ§åˆ¶å¹³é¢å’Œç®¡ç†å‘˜kubeconfigæ–‡ä»¶
   + **/admin** ä¸ºç®¡ç†å‘˜å’Œkubeadmæœ¬èº«ç”Ÿæˆkubeconfigæ–‡ä»¶
   + **/kubelet** ä¸ºkubeletç”Ÿæˆkubeconfigæ–‡ä»¶ï¼Œä»…ç”¨äºé›†ç¾¤å¼•å¯¼ç›®çš„
   + **/controller-manager** ä¸ºæ§åˆ¶å™¨ç®¡ç†å™¨ç”Ÿæˆkubeconfigæ–‡ä»¶
   + **/scheduler** ä¸ºè°ƒåº¦å™¨ç”Ÿæˆkubeconfigæ–‡ä»¶
4. **kubelet-start** å†™å…¥kubeletè®¾ç½®å¹¶ï¼ˆé‡æ–°ï¼‰å¯åŠ¨kubelet
5. **control-plane**ï¼šç”Ÿæˆæ‰€æœ‰é™æ€Podæ¸…å•æ–‡ä»¶ï¼Œä»¥å»ºç«‹æ§åˆ¶å¹³é¢
   + **/apiserver** ç”Ÿæˆkube-apiserveré™æ€Podæ¸…å•
   + **/controller-manager** ç”Ÿæˆkube-controller-manageré™æ€Podæ¸…å•
   + **/scheduler** ç”Ÿæˆkube-scheduleré™æ€Podæ¸…å•
6. **etcd**ï¼šä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€Podæ¸…å•æ–‡ä»¶
   + **/local** ä¸ºæœ¬åœ°å•èŠ‚ç‚¹etcdå®ä¾‹ç”Ÿæˆé™æ€Podæ¸…å•æ–‡ä»¶
7. **upload-config**ï¼šå°†kubeadmå’Œkubeleté…ç½®ä¸Šä¼ åˆ°ConfigMap
   + **/kubeadm** å°†kubeadm ClusterConfigurationä¸Šä¼ åˆ°ConfigMap
   + **/kubelet** å°†kubeletç»„ä»¶é…ç½®ä¸Šä¼ åˆ°ConfigMap
8. **upload-certs** å°†è¯ä¹¦ä¸Šä¼ åˆ°kubeadm-certs
9. **mark-control-plane** å°†èŠ‚ç‚¹æ ‡è®°ä¸ºæ§åˆ¶å¹³é¢
10. **bootstrap-token** ç”Ÿæˆç”¨äºå°†èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å¼•å¯¼ä»¤ç‰Œ
11. **kubelet-finalize**ï¼šåœ¨TLSå¼•å¯¼åæ›´æ–°ä¸kubeletç›¸å…³çš„è®¾ç½®
    + **/experimental-cert-rotation** å¯ç”¨kubeletå®¢æˆ·ç«¯è¯ä¹¦è½®æ¢
12. **addon**ï¼šå®‰è£…é€šè¿‡ä¸€è‡´æ€§æµ‹è¯•æ‰€éœ€çš„å¿…è¦æ’ä»¶
    + **/coredns** å°†CoreDNSæ’ä»¶å®‰è£…åˆ°Kubernetesé›†ç¾¤
    + **/kube-proxy** å°†kube-proxyæ’ä»¶å®‰è£…åˆ°Kubernetesé›†ç¾¤
13. **show-join-command** æ˜¾ç¤ºæ§åˆ¶å¹³é¢å’Œå·¥ä½œèŠ‚ç‚¹çš„åŠ å…¥å‘½ä»¤



### é€‰é¡¹

| é€‰é¡¹                          | ç±»å‹        | è¯´æ˜                                                         |
| ----------------------------- | ----------- | ------------------------------------------------------------ |
| --apiserver-advertise-address | string      | API Server å¹¿å‘Šå…¶ç›‘å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚ |
| --apiserver-bind-port         | int32       | é»˜è®¤å€¼ï¼š6443ã€‚API Serverç»‘å®šçš„ç«¯å£ã€‚                         |
| --apiserver-cert-extra-sans   | stringSlice | API Server æœåŠ¡è¯ä¹¦çš„å¯é€‰é¢å¤–ä¸»ä½“æ›¿ä»£åç§°ï¼ˆSANï¼‰ï¼Œå¯ä»¥æ˜¯ IP åœ°å€å’Œ DNS åç§°ã€‚ |
| --cert-dir                    | string      | é»˜è®¤å€¼ï¼š"/etc/kubernetes/pki"ã€‚                              |
| --certificate-key             | string      | ç”¨äºåŠ å¯† kubeadm-certs Secret ä¸­çš„æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚       |
| --config                      | string      | kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚                                     |
| --cri-socket                  | string      | è¦è¿æ¥çš„CRIå¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œkubeadmå°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ï¼›ä»…åœ¨å®‰è£…äº†å¤šä¸ªCRIæˆ–å­˜åœ¨éæ ‡å‡†CRIå¥—æ¥å­—æ—¶ä½¿ç”¨æ­¤é€‰é¡¹ã€‚ |
| --dry-run                     |             | ä¸åº”ç”¨ä»»ä½•æ›´æ”¹ï¼›åªè¾“å‡ºå°†è¦æ‰§è¡Œçš„æ“ä½œã€‚                       |
| --experimental-upload-certs   |             | ä¸Šä¼ æ§åˆ¶å¹³é¢è¯ä¹¦åˆ° kubeadm-certs Secretã€‚                    |
| --feature-gates               | string      | ä¸€ç»„é”®å€¼å¯¹ï¼Œæè¿°å„ç§åŠŸèƒ½çš„ç‰¹æ€§é—¨ã€‚å¯é€‰é¡¹ä¸ºï¼š                 |
| -h, --help                    |             | init çš„å¸®åŠ©ä¿¡æ¯ã€‚                                            |
| --ignore-preflight-errors     | stringSlice | è¦å°†å…¶é”™è¯¯æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨ã€‚ç¤ºä¾‹ï¼šâ€œIsPrivilegedUserï¼ŒSwapâ€ã€‚å€¼â€œallâ€ä¼šå¿½ç•¥æ‰€æœ‰æ£€æŸ¥çš„é”™è¯¯ã€‚ |
| --image-repository            | string      | é»˜è®¤å€¼ï¼šâ€œhttp://k8s.gcr.io/â€ã€‚é€‰æ‹©ä¸€ä¸ªå®¹å™¨æ³¨å†Œè¡¨ä»¥æ‹‰å–æ§åˆ¶å¹³é¢æ˜ åƒã€‚ |
| --kubernetes-version          | string      | é»˜è®¤å€¼ï¼šâ€œstable-1â€ã€‚ä¸ºæ§åˆ¶å¹³é¢é€‰æ‹©ç‰¹å®šçš„ Kubernetes ç‰ˆæœ¬ã€‚   |
| --node-name                   | string      | æŒ‡å®šèŠ‚ç‚¹åç§°ã€‚                                               |
| --pod-network-cidr            | string      | æŒ‡å®š Pod ç½‘ç»œçš„ IP åœ°å€èŒƒå›´ã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™æ§åˆ¶å¹³é¢å°†è‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é… CIDRã€‚ |
| --service-cidr                | string      | é»˜è®¤å€¼ï¼šâ€œ10.96.0.0/12â€ã€‚ä½¿ç”¨æ›¿ä»£ IP åœ°å€èŒƒå›´æ¥è®¾ç½®æœåŠ¡ VIPã€‚ |
| --service-dns-domain          | string      | é»˜è®¤å€¼ï¼šâ€œcluster.localâ€ã€‚ä½¿ç”¨æ›¿ä»£åŸŸåä¸ºæœåŠ¡å‘½åï¼Œä¾‹å¦‚â€œmyorg.internalâ€ã€‚ |
| --skip-certificate-key-print  |             | ä¸æ‰“å°ç”¨äºåŠ å¯†æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚                           |
| --skip-phases                 | stringSlice | è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨ã€‚                                           |
| --skip-token-print            |             | è·³è¿‡æ‰“å°ç”±â€œkubeadm initâ€ç”Ÿæˆçš„é»˜è®¤å¼•å¯¼ä»¤ç‰Œã€‚                 |
| --token                       | string      | ç”¨äºåœ¨èŠ‚ç‚¹å’Œæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å»ºç«‹åŒå‘ä¿¡ä»»çš„ä»¤ç‰Œã€‚æ ¼å¼ä¸º[a-z0-9] {6}ã€‚[a-z0-9] {16} - ä¾‹å¦‚abcdef.0123456789abcdef |
| --token-ttl duration          |             | é»˜è®¤å€¼ï¼š24h0m0sã€‚ä»¤ç‰Œè‡ªåŠ¨åˆ é™¤ä¹‹å‰çš„æŒç»­æ—¶é—´ï¼ˆä¾‹å¦‚1sï¼Œ2mï¼Œ3hï¼‰ã€‚å¦‚æœè®¾ç½®ä¸ºâ€œ0â€ï¼Œåˆ™ä»¤ç‰Œæ°¸ä¸è¿‡æœŸã€‚ |



### ä»çˆ¶å‘½ä»¤ç»§æ‰¿çš„é€‰é¡¹

| é€‰é¡¹     | ç±»å‹   | æè¿°                                                        |
| :------- | :----- | :---------------------------------------------------------- |
| --rootfs | string | [EXPERIMENTAL] The path to the 'real' host root filesystem. |



### åˆå§‹åŒ–æµç¨‹

#### pre-flifht æ£€æŸ¥

åœ¨æ‰§è¡Œ kubeadm init å‘½ä»¤ä¹‹å‰ï¼Œkubeadm ä¼šè¿è¡Œä¸€ä¸ª preflight é˜¶æ®µï¼Œç”¨äºæ£€æŸ¥é›†ç¾¤èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ Kubernetes çš„æœ€ä½è¦æ±‚ã€‚åœ¨ preflight é˜¶æ®µä¸­ï¼Œkubeadm ä¼šæ ¹æ®ç”¨æˆ·æä¾›çš„é€‰é¡¹æ¥æ‰§è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œä»¥ç¡®ä¿ Kubernetes æ§åˆ¶å¹³é¢çš„æ­£å¸¸è¿è¡Œã€‚

å¸¸ç”¨çš„ preflight é˜¶æ®µé€‰é¡¹åŒ…æ‹¬ï¼š

+ -configï¼šæŒ‡å®š kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼›
+ -cri-socketï¼šæŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ï¼ˆCRIï¼‰çš„ socket æ–‡ä»¶è·¯å¾„ï¼›
+ -skip-phasesï¼šè·³è¿‡ preflight é˜¶æ®µä¸­çš„æŸäº›æ£€æŸ¥é˜¶æ®µï¼›
+ -ignore-preflight-errorsï¼šå¿½ç•¥ preflight é˜¶æ®µä¸­çš„æŸäº›é”™è¯¯ã€‚



#### certificate ç”Ÿæˆé˜¶æ®µ

åœ¨åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢æ—¶ï¼Œkubeadm è¿˜ä¼šè‡ªåŠ¨ä¸º Kubernetes ç»„ä»¶ç”Ÿæˆ TLS è¯ä¹¦å’Œç§˜é’¥ã€‚è¿™äº›è¯ä¹¦å’Œç§˜é’¥ç”¨äºç¡®ä¿ Kubernetes ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡ã€‚

ç”Ÿæˆè‡ªç­¾åCAï¼ˆå¦‚æœæä¾›äº†ï¼Œåˆ™ä½¿ç”¨ç°æœ‰CAï¼‰ï¼Œä¸ºé›†ç¾¤ä¸­çš„æ¯ä¸ªç»„ä»¶è®¾ç½®æ ‡è¯†ã€‚å¦‚æœç”¨æˆ·æä¾›äº†è‡ªå·±çš„CAè¯ä¹¦å’Œ/æˆ–å¯†é’¥ï¼Œå¹¶å°†å…¶æ”¾å…¥é€šè¿‡ `--cert-dir` é€‰é¡¹ï¼ˆé»˜è®¤å€¼ä¸º`/etc/kubernetes/pki` ï¼‰é…ç½®çš„è¯ä¹¦ç›®å½•ä¸­ã€‚å¯ä»¥æŒ‰ç…§[ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#zidingyizhengshu)æ–‡æ¡£ä¸­çš„æè¿°è·³è¿‡æ­¤æ­¥éª¤ã€‚APIæœåŠ¡å™¨è¯ä¹¦æ‹¥æœ‰ç”¨äº `--apiserver-cert-extra-sans`å‚æ•°ï¼ˆå¿…è¦æ—¶å°å†™ï¼‰çš„é¢å¤–SANæ¡ç›®ã€‚



#### ç”Ÿæˆ kubeconfig æ–‡ä»¶

å°†kubeconfigæ–‡ä»¶å†™åˆ°`/etc/kubernetes/`ä¸­ï¼Œä¾›kubeletã€æ§åˆ¶å™¨-ç®¡ç†å™¨å’Œè°ƒåº¦å™¨è¿æ¥APIæœåŠ¡å™¨ï¼Œæ¯ä¸ªkubeconfigæ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„æ ‡è¯†ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªåä¸º`admin.conf`çš„kubeconfigæ–‡ä»¶ç”¨äºç®¡ç†ã€‚



#### pod

ä¸ºAPIæœåŠ¡å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨ç”Ÿæˆé™æ€Podæ¸…å•ã€‚å¦‚æœæ²¡æœ‰æä¾›å¤–éƒ¨etcdï¼Œåˆ™ä¸ºetcdç”Ÿæˆé¢å¤–çš„é™æ€Podæ¸…å•ã€‚

é™æ€Podæ¸…å•è¢«å†™å…¥`/etc/kubernetes/manifests`ï¼›kubeletç›‘è§†è¿™ä¸ªç›®å½•ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ—¶åˆ›å»ºpodã€‚

ä¸€æ—¦æ§åˆ¶å¹³é¢podå¯åŠ¨å¹¶è¿è¡Œï¼Œ`kubeadm init`æµç¨‹å°±å¯ä»¥ç»§ç»­ã€‚

1. å°†æ ‡ç­¾å’Œæ±¡æŸ“åº”ç”¨åˆ°æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œè¿™æ ·å°±ä¸ä¼šåœ¨é‚£é‡Œè¿è¡Œé¢å¤–çš„å·¥ä½œè´Ÿè½½ã€‚

2. ç”Ÿæˆä»¤ç‰Œï¼Œé¢å¤–çš„èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨è¯¥ä»¤ç‰Œåœ¨å°†æ¥å‘æ§åˆ¶å¹³é¢æ³¨å†Œè‡ªå·±ã€‚ç”¨æˆ·å¯ä»¥é€‰æ‹©é€šè¿‡`--token`é€‰é¡¹æä¾›ä»¤ç‰Œï¼Œå¦‚[kubeadm token](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_token.html)æ–‡æ¡£ä¸­æ‰€è¿°ã€‚

3. é…ç½®æ‰€æœ‰å¿…è¦çš„é…ç½®ï¼Œå…è®¸èŠ‚ç‚¹ä½¿ç”¨[å¼•å¯¼ä»¤ç‰Œ](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html)å’Œ[TLSå¼•å¯¼](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html)æœºåˆ¶åŠ å…¥é›†ç¾¤ï¼š

   + ç¼–å†™ä¸€ä¸ªConfigMapæ¥æä¾›åŠ å…¥é›†ç¾¤æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶è®¾ç½®ç›¸å…³çš„RBACè®¿é—®è§„åˆ™ã€‚
   + ä½¿å¼•å¯¼ä»¤ç‰Œè®¿é—®CSRç­¾åAPIã€‚
   + ä¸ºæ–°çš„CSRè¯·æ±‚é…ç½®è‡ªåŠ¨æ‰¹å‡†ã€‚

   æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[kubeadm join](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join.html)ã€‚

4. é€šè¿‡APIæœåŠ¡å™¨å®‰è£…DNSæœåŠ¡å™¨(CoreDNS)å’Œkube-proxyæ’ä»¶ç»„ä»¶ã€‚åœ¨Kubernetes v1.11å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSæ˜¯é»˜è®¤çš„DNSæœåŠ¡å™¨ã€‚å¦‚æœä½ è¦å®‰è£…kube-dnsè€Œä¸æ˜¯CoreDNSï¼Œå¿…é¡»åœ¨kubeadm `ClusterConfiguration`é…ç½®DNSæ’ä»¶ã€‚



### ä½¿ç”¨kubeadmçš„åˆå§‹åŒ–é˜¶æ®µ

Kubeadmå…è®¸ä½ åˆ†é˜¶æ®µåˆ›å»ºä¸€ä¸ªæ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚åœ¨v1.13ä¸­ï¼Œ`kubeadm init phase`å‘½ä»¤å·²ç»ä»alphaçº§åˆ«çš„`kubeadm alpha phase`å‡çº§åˆ°äº†GAçº§åˆ«ã€‚

è¦æŸ¥çœ‹æœ‰åºçš„é˜¶æ®µå’Œå­é˜¶æ®µåˆ—è¡¨ï¼Œå¯ä»¥è°ƒç”¨`kubeadm init --help`ã€‚åˆ—è¡¨å°†ä½äºå¸®åŠ©ä¿¡æ¯çš„é¡¶éƒ¨ï¼Œæ¯ä¸ªé˜¶æ®µæ—è¾¹éƒ½æœ‰ä¸€ä¸ªæè¿°ã€‚æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨`kubeadm init`ï¼Œæ‰€æœ‰é˜¶æ®µå’Œå­é˜¶æ®µéƒ½å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚

æœ‰äº›é˜¶æ®µæœ‰ç‹¬ç‰¹çš„é€‰é¡¹ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹å¯ç”¨çš„é€‰é¡¹åˆ—è¡¨ï¼Œè¯·æ·»åŠ `--help`ï¼Œä¾‹å¦‚:

```shell
sudo kubeadm init phase control-plane controller-manager --help
```

ä½ è¿˜å¯ä»¥ä½¿ç”¨`--help`æŸ¥çœ‹ç‰¹å®šçˆ¶é˜¶æ®µçš„å­é˜¶æ®µåˆ—è¡¨:

```shell
sudo kubeadm init phase control-plane --help
```

`kubeadm init`è¿˜æš´éœ²äº†ä¸€ä¸ªåä¸º`--skip-phase`çš„é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å¯ç”¨äºè·³è¿‡æŸäº›é˜¶æ®µã€‚è¯¥é€‰é¡¹æ¥å—ä¸€ä¸ªé˜¶æ®µåç§°åˆ—è¡¨ï¼Œè¿™äº›åç§°å¯ä»¥ä»ä¸Šé¢çš„æœ‰åºåˆ—è¡¨ä¸­è·å–ã€‚

```bash
sudo kubeadm init phase control-plane all --config=configfile.yaml
sudo kubeadm init phase etcd local --config=configfile.yaml
# you can now modify the control plane and etcd manifest files
sudo kubeadm init --skip-phases=control-plane,etcd --config=configfile.yaml
sudo kubeadm init phase control-plane all --config=configfile.yaml
sudo kubeadm init phase etcd local --config=configfile.yaml
# you can now modify the control plane and etcd manifest files
sudo kubeadm init --skip-phases=control-plane,etcd --config=configfile.yaml
```

è¯¥ç¤ºä¾‹å°†ç¼–å†™åŸºäº`configfile.yaml`ä¸­çš„é…ç½®ï¼Œä½äº`/etc/kubernetes/manifests`ä¸­çš„æ¸…å•æ–‡ä»¶ã€‚è¿™å…è®¸ä½ ä¿®æ”¹æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨`--skip-phases`é€‰é¡¹è·³è¿‡è¿™äº›é˜¶æ®µã€‚é€šè¿‡è°ƒç”¨æœ€åä¸€ä¸ªå‘½ä»¤ï¼Œä½ å°†åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è‡ªå®šä¹‰æ¸…å•æ–‡ä»¶çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚



### ä¸ºkubeadm initæŒ‡å®šé…ç½®æ–‡ä»¶

å¯ä»¥ç”¨é…ç½®æ–‡ä»¶è€Œä¸æ˜¯å‘½ä»¤è¡Œé€‰é¡¹æ¥é…ç½®`kubeadm init`ï¼Œä¸€äº›æ›´é«˜çº§çš„ç‰¹æ€§å¯èƒ½åªä½œä¸ºé…ç½®æ–‡ä»¶é€‰é¡¹ä½¿ç”¨ã€‚è¯¥æ–‡ä»¶é€šè¿‡ `--config` é€‰é¡¹ä¼ é€’ã€‚



#### å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ

é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadmä» `k8s.gcr.io`ä¸­æ‹‰å–é•œåƒï¼Œé™¤éè¯·æ±‚çš„Kubernetesç‰ˆæœ¬æ˜¯CIç‰ˆæœ¬ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°†ä½¿ç”¨ `gcr.io/kubernetes-ci-images` ã€‚

è¿™ç§æƒ…å†µä¸‹åœ¨å›½å†…å¯èƒ½ä¼šå‡ºç°æ‹‰å– over time

ä½ å¯ä»¥å‘kubeadmæŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶è¦†ç›–æ­¤è¡Œä¸ºã€‚å…è®¸è‡ªå®šä¹‰æœ‰ï¼š

+ æä¾›ä¸€ä¸ªæ›¿ä»£ `k8s.gcr.io`çš„`imageRepository`ã€‚
+ å°†`useHyperKubeImage`è®¾ç½®ä¸º`true`ä»¥ä½¿ç”¨HyperKubeå›¾åƒã€‚
+ ä¸ºetcdæˆ–DNSæ’ä»¶æä¾›ç‰¹å®šçš„`imageRepository`å’Œ`imageTag`ã€‚

è¯·æ³¨æ„ï¼Œé…ç½®å­—æ®µ`kubernetesVersion`å’Œå‘½ä»¤è¡Œé€‰é¡¹ `--kubernetes-version` éƒ½ä¼šå½±å“é•œåƒçš„ç‰ˆæœ¬ã€‚



### ä½¿ç”¨è‡ªå®šä¹‰è¯ä¹¦

é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeadmç”Ÿæˆé›†ç¾¤è¿è¡Œæ‰€éœ€çš„æ‰€æœ‰è¯ä¹¦ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡æä¾›è‡ªå·±çš„è¯ä¹¦æ¥è¦†ç›–æ­¤è¡Œä¸ºã€‚

ä¸ºæ­¤ï¼Œä½ å¿…é¡»å°†å®ƒä»¬æ”¾åœ¨ç”± `--cert-dir`é€‰é¡¹æˆ– `CertificatesDir`é…ç½®æ–‡ä»¶é”®æŒ‡å®šçš„ç›®å½•ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥ç›®å½•ä¸º`/etc/kubernetes/pki`ã€‚

å¦‚æœå­˜åœ¨ç»™å®šçš„è¯ä¹¦å’Œç§é’¥å¯¹ï¼Œkubeadmå°†è·³è¿‡ç”Ÿæˆæ­¥éª¤ï¼Œä½¿ç”¨ç°æœ‰æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥å°†ç°æœ‰çš„CAå¤åˆ¶åˆ° `/etc/kubernetes/pki/ca.crt`å’Œ `/etc/kubernetes/pki/ca.key`ï¼Œkubeadmå°†ä½¿ç”¨æ­¤CAç­¾ç½²å…¶ä½™çš„è¯ä¹¦ã€‚



#### å¤–éƒ¨CAæ¨¡å¼

ä¹Ÿå¯ä»¥åªæä¾›`ca.crt` æ–‡ä»¶ï¼Œè€Œä¸æä¾›`ca.key`æ–‡ä»¶ï¼ˆè¿™åªé€‚ç”¨äºæ ¹CAæ–‡ä»¶ï¼Œä¸é€‚ç”¨äºå…¶ä»–è¯ä¹¦å¯¹ï¼‰ã€‚å¦‚æœæ‰€æœ‰å…¶ä»–è¯ä¹¦å’Œkubeconfigæ–‡ä»¶éƒ½åˆ°ä½ï¼Œkubeadmå°†è¯†åˆ«æ­¤æ¡ä»¶å¹¶æ¿€æ´»â€œå¤–éƒ¨CAâ€æ¨¡å¼ã€‚kubeadmå°†åœ¨ç£ç›˜ä¸Šæ²¡æœ‰CAå¯†é’¥çš„æƒ…å†µä¸‹ç»§ç»­æ‰§è¡Œã€‚

ç›¸åï¼Œä½¿ç”¨ `--controllers=csrsigner`ç‹¬ç«‹è¿è¡Œæ§åˆ¶å™¨ç®¡ç†å™¨ï¼Œå¹¶æŒ‡å‘CAè¯ä¹¦å’Œå¯†é’¥ã€‚



### æŒ‡å®š CRI

ä»v1.6.0å¼€å§‹ï¼ŒKuberneteså°±é»˜è®¤å¯ç”¨äº†CRIå®¹å™¨è¿è¡Œæ—¶æ¥å£ã€‚é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯Dockerï¼Œå®ƒæ˜¯é€šè¿‡`kubelet`å†…ç½®çš„`dockershim `CRIå¯ç”¨çš„ã€‚

ä» Kubernetes 1.20 å¼€å§‹ï¼Œé»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä¸º `containerd`ï¼Œè€Œä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤å®¹å™¨è¿è¡Œæ—¶ä¸º `Docker`ã€‚

æˆåŠŸå®‰è£…`kubeadm`å’Œ`kubelet`ä¹‹åï¼Œæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªé¢å¤–æ­¥éª¤:

1. æŒ‰ç…§ä¸Šé¢è¿è¡Œæ—¶shimé¡¹ç›®æ¸…å•ä¸­çš„å®‰è£…æ–‡æ¡£ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå®‰è£…è¿è¡Œæ—¶shimã€‚

2. é…ç½®kubeletä½¿ç”¨è¿œç¨‹CRIè¿è¡Œæ—¶ã€‚è¯·è®°ä½å°†`RUNTIME_ENDPOINT`æ›´æ”¹ä¸ºä½ è‡ªå·±çš„å€¼ï¼Œæ¯”å¦‚ `/var/run/{your_runtime}.sock`ï¼š

   ```shell
   cat > /etc/systemd/system/kubelet.service.d/20-cri.conf <<EOF[Service]Environment="KUBELET_EXTRA_ARGS=--container-runtime=remote --container-runtime-endpoint=$RUNTIME_ENDPOINT"EOFsystemctl daemon-reload
   ```

ç°åœ¨`kubelet`å·²ç»å‡†å¤‡å¥½ä½¿ç”¨æŒ‡å®šçš„CRIè¿è¡Œæ—¶ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨`kubeadm init`å’Œ`kubeadm join`æ¥éƒ¨ç½²Kubernetesé›†ç¾¤ã€‚

åœ¨ä½¿ç”¨å¤–éƒ¨CRIå®ç°æ—¶ï¼Œè¯·å°†åœ¨æ‰§è¡Œ `kubeadm init` å’Œ`kubeadm reset`æ—¶æ·»åŠ  `--cri-socket` é€‰é¡¹ã€‚



### ç¦»çº¿è¿è¡Œ kubeadm

è¦åœ¨æ²¡æœ‰äº’è”ç½‘è¿æ¥çš„æƒ…å†µä¸‹è¿è¡Œkubeadmï¼Œä½ å¿…é¡»é¢„å…ˆæ‹‰å–æ‰€éœ€çš„æ§åˆ¶å¹³é¢é•œåƒã€‚

åœ¨Kubernetes v1.11å’Œæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `kubeadm config images`çš„å­å‘½ä»¤è·å–å’Œæ‹‰å–é•œåƒ:

```bash
â¯ ./kubeadm config images list

W0319 15:08:46.559718   50461 version.go:112] could not obtain neither client nor remote version; fall back to: 1.0.0-placeholder-version
W0319 15:08:46.561620   50461 images.go:80] could not find officially supported version of etcd for Kubernetes v1.0.0-placeholder-version, falling back
to the nearest etcd version (3.2.24)
registry.k8s.io/kube-apiserver:v1.0.0-placeholder-version
registry.k8s.io/kube-controller-manager:v1.0.0-placeholder-version
registry.k8s.io/kube-scheduler:v1.0.0-placeholder-version
registry.k8s.io/kube-proxy:v1.0.0-placeholder-version
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.2.24
registry.k8s.io/coredns/coredns:v1.10.1
```

æ‹‰å–ï¼š

```
kubeadm config images pull
```



## kubeadm join

è¯¥å‘½ä»¤åˆå§‹åŒ–Kuberneteså·¥ä½œèŠ‚ç‚¹å¹¶å°†å…¶åŠ å…¥åˆ°é›†ç¾¤ã€‚åœ¨å¸Œæœ›åŠ å…¥ç°æœ‰é›†ç¾¤çš„æ‰€æœ‰æœºå™¨ä¸Šè¿è¡Œæ­¤æ“ä½œã€‚

 `kubeadm init` å’Œ `kubeadm join` ä¸€èµ·æä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥ä»å¤´å¼€å§‹åˆ›å»ºæœ€ä½³å®è·µçš„è£¸Kubernetesé›†ç¾¤ã€‚ç„¶è€Œï¼Œkubeadmæ˜¯å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Œå¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚

åœ¨åŠ å…¥ç”±kubeadmåˆå§‹åŒ–çš„é›†ç¾¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹åŒå‘ä¿¡ä»»ã€‚è¿™åˆ†ä¸º***å‘ç°***ï¼ˆè®©èŠ‚ç‚¹ä¿¡ä»»Kubernetesæ§åˆ¶å¹³é¢ï¼‰å’Œ*TLS**å¼•å¯¼***(è®©Kubernetesæ§åˆ¶å¹³é¢ä¿¡ä»»èŠ‚ç‚¹)ã€‚

æœ‰ä¸¤ç§ä¸»è¦çš„å‘ç°æ–¹æ¡ˆã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å…±äº«ä»¤ç‰Œå’ŒAPIæœåŠ¡å™¨çš„IPåœ°å€ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶â€”â€”æ ‡å‡†kubeconfigæ–‡ä»¶çš„å­é›†ã€‚è¯¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡HTTPS URLä¸‹è½½ã€‚å½¢å¼ä¸º`kubeadm join --discovery-token abcdef.1234567890abcdef 1.2.3.4:6443`ã€ `kubeadm join --discovery-file path/to/file.conf`æˆ–`kubeadm join --discovery-file https://url/file.conf`ã€‚åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ç§å½¢å¼ã€‚å¦‚æœå‘ç°ä¿¡æ¯æ˜¯ä»URLåŠ è½½çš„ï¼Œåˆ™å¿…é¡»ä½¿ç”¨HTTPSã€‚æ­¤å¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨å·²å®‰è£…çš„ä¸»æœºCAåŒ…éªŒè¯è¿æ¥ã€‚



### å‘½ä»¤é˜¶æ®µ

`join [api-server-endpoint]`å‘½ä»¤æ‰§è¡Œä»¥ä¸‹é˜¶æ®µ:

~~~sql
The "join [api-server-endpoint]" command executes the following phases:
```
preflight              Run join pre-flight checks
control-plane-prepare  Prepare the machine for serving a control plane
  /download-certs        [EXPERIMENTAL] Download certificates shared among control-plane nodes from the kubeadm-certs Secret
  /certs                 Generate the certificates for the new control plane components
  /kubeconfig            Generate the kubeconfig for the new control plane components
  /control-plane         Generate the manifests for the new control plane components
kubelet-start          Write kubelet settings, certificates and (re)start the kubelet
control-plane-join     Join a machine as a control plane instance
  /etcd                  Add a new local etcd member
  /update-status         Register the new control-plane node into the ClusterStatus maintained in the kubeadm-config ConfigMap (DEPRECATED)
  /mark-control-plane    Mark a node as a control-plane
~~~

+ `preflight`ï¼šè¿è¡ŒåŠ å…¥å‰æ£€æŸ¥
+ `control-plane-prepare`ï¼šå‡†å¤‡æœºå™¨ä»¥æœåŠ¡äºæ§åˆ¶å¹³é¢
+ + `/download-certs`ï¼š[å®éªŒæ€§] ä» kubeadm-certs Secret ä¸‹è½½æ§åˆ¶å¹³é¢èŠ‚ç‚¹é—´å…±äº«çš„è¯ä¹¦
  + `/certs`ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆè¯ä¹¦
  + `/kubeconfig`ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆ kubeconfig
  + `/control-plane`ï¼šä¸ºæ–°çš„æ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆæ¸…å•
+ `kubelet-start`ï¼šç¼–å†™ kubelet è®¾ç½®ï¼Œè¯ä¹¦å¹¶å¯åŠ¨ kubelet
+ `control-plane-join`ï¼šå°†æœºå™¨ä½œä¸ºæ§åˆ¶å¹³é¢å®ä¾‹åŠ å…¥
+ + `/etcd`ï¼šæ·»åŠ ä¸€ä¸ªæ–°çš„æœ¬åœ° etcd æˆå‘˜
  + `/update-status`ï¼šå°†æ–°çš„æ§åˆ¶å¹³é¢èŠ‚ç‚¹æ³¨å†Œåˆ°ç»´æŠ¤åœ¨ kubeadm-config ConfigMap ä¸­çš„ ClusterStatus ä¸­ (å·²å¼ƒç”¨)
  + `/mark-control-plane`ï¼šå°†èŠ‚ç‚¹æ ‡è®°ä¸ºæ§åˆ¶å¹³é¢èŠ‚ç‚¹



### é€‰é¡¹

| é€‰é¡¹                                            | ç±»å‹        | æè¿°                                                         |
| ----------------------------------------------- | ----------- | ------------------------------------------------------------ |
| `--apiserver-advertise-address`                 | string      | å¦‚æœèŠ‚ç‚¹åº”è¯¥æ‰˜ç®¡æ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™æ˜¯ API æœåŠ¡å™¨å°†å¹¿å‘Šå®ƒæ­£åœ¨ä¾¦å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚ |
| `--apiserver-bind-port`                         | int32       | é»˜è®¤å€¼ï¼š6443ã€‚å¦‚æœèŠ‚ç‚¹åº”è¯¥æ‰˜ç®¡æ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™æ˜¯ API æœåŠ¡å™¨ç»‘å®šçš„ç«¯å£ã€‚ |
| `--certificate-key`                             | string      | ä½¿ç”¨æ­¤å¯†é’¥è§£å¯†ç”± init ä¸Šä¼ çš„è¯ä¹¦å¯†é’¥ã€‚                       |
| `--config`                                      | string      | kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚                                     |
| `--cri-socket`                                  | string      | è¿æ¥çš„ CRI å¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œkubeadm å°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ã€‚ä»…åœ¨å®‰è£…äº†å¤šä¸ª CRI æˆ–å…·æœ‰éæ ‡å‡† CRI å¥—æ¥å­—æ—¶ä½¿ç”¨æ­¤é€‰é¡¹ã€‚ |
| `--discovery-file`                              | string      | å¯¹äºåŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œè¦ä»ä¸­åŠ è½½ç¾¤é›†ä¿¡æ¯çš„æ–‡ä»¶æˆ– URLã€‚         |
| `--discovery-token`                             | string      | å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œç”¨äºéªŒè¯ä» API æœåŠ¡å™¨è·å–çš„ç¾¤é›†ä¿¡æ¯çš„ä»¤ç‰Œã€‚ |
| `--discovery-token-ca-cert-hash`                | stringSlice | å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼ŒéªŒè¯æ ¹ CA å…¬é’¥æ˜¯å¦ä¸æ­¤å“ˆå¸Œå€¼åŒ¹é…ï¼ˆæ ¼å¼ï¼šâ€œ : â€ï¼‰ã€‚ |
| `--discovery-token-unsafe-skip-ca-verification` |             | å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œå…è®¸åŠ å…¥è€Œä¸ä½¿ç”¨ --discovery-token-ca-cert-hash å›ºå®šã€‚ |
| `--experimental-control-plane`                  |             | åœ¨æ­¤èŠ‚ç‚¹ä¸Šåˆ›å»ºæ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ã€‚                             |
| `-h`, `--help`                                  |             | join çš„å¸®åŠ©ä¿¡æ¯                                              |
| `--ignore-preflight-errors`                     | stringSlice | æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨çš„é”™è¯¯ã€‚ç¤ºä¾‹ï¼šâ€œIsPrivilegedUser,Swapâ€ã€‚å€¼â€œallâ€ä¼šå¿½ç•¥æ‰€æœ‰æ£€æŸ¥çš„é”™è¯¯ã€‚ |
| `--node-name`                                   | string      | æŒ‡å®šèŠ‚ç‚¹åç§°ã€‚                                               |
| `--skip-phases`                                 | stringSlice | è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨ã€‚                                           |
| `--tls-bootstrap-token`                         | string      | åœ¨åŠ å…¥èŠ‚ç‚¹æ—¶ï¼ŒæŒ‡å®šç”¨äºä¸´æ—¶èº«ä»½éªŒè¯ Kubernetes æ§åˆ¶å¹³é¢çš„ä»¤ç‰Œã€‚ |
| `--token`                                       | string      | åœ¨æœªæä¾› discovery-token å’Œ tls-bootstrap-token æ—¶ä½¿ç”¨æ­¤ä»¤ç‰Œã€‚ |



### åŠ å…¥æµç¨‹

`kubeadm join`å¼•å¯¼Kuberneteså·¥ä½œèŠ‚ç‚¹æˆ–æ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚å¯¹äºå·¥ä½œèŠ‚ç‚¹ï¼Œè¯¥æ“ä½œåŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤:

1. kubeadmä»APIæœåŠ¡å™¨ä¸‹è½½å¿…è¦çš„é›†ç¾¤ä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå’ŒCAå¯†é’¥çš„å“ˆå¸Œå€¼æ¥éªŒè¯æ•°æ®çš„çœŸå®æ€§ã€‚æ ¹CAä¹Ÿå¯ä»¥é€šè¿‡æ–‡ä»¶æˆ–URLç›´æ¥è·å–ã€‚

2. ä¸€æ—¦è·å–äº†é›†ç¾¤ä¿¡æ¯ï¼Œkubeletå°±å¯ä»¥å¯åŠ¨TLSå¼•å¯¼æµç¨‹ã€‚

   TLSå¼•å¯¼ä½¿ç”¨å…±äº«ä»¤ç‰Œä¸Kubernetes APIæœåŠ¡å™¨è¿›è¡Œä¸´æ—¶è®¤è¯ï¼Œæäº¤è¯ä¹¦ç­¾åè¯·æ±‚(CSR)ï¼›é»˜è®¤æƒ…å†µä¸‹ï¼Œæ§åˆ¶å¹³é¢è‡ªåŠ¨ç­¾ç½²æ­¤CSRè¯·æ±‚ã€‚

3. æœ€åï¼Œkubeadmå°†æœ¬åœ°kubeleté…ç½®ä¸ºä½¿ç”¨åˆ†é…ç»™èŠ‚ç‚¹çš„æœ€ç»ˆæ ‡è¯†è¿æ¥åˆ°APIæœåŠ¡å™¨ã€‚

å¯¹äºæ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œè¿˜è¦æ‰§è¡Œé¢å¤–çš„æ­¥éª¤:

1. ä»é›†ç¾¤ä¸­ä¸‹è½½æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å…±äº«çš„è¯ä¹¦(å¦‚æœç”¨æˆ·æ˜¾å¼åœ°è¯·æ±‚)ã€‚
2. ç”Ÿæˆæ§åˆ¶å¹³é¢ç»„ä»¶æ¸…å•ã€è¯ä¹¦å’Œkubeconfigã€‚
3. æ·»åŠ æ–°çš„æœ¬åœ°etcdæˆå‘˜ã€‚
4. å°†æ­¤èŠ‚ç‚¹æ·»åŠ åˆ°kubeadmé›†ç¾¤çš„ClusterStatusä¸­ã€‚



### ä½¿ç”¨kubeadmçš„åŠ å…¥é˜¶æ®µ

Kubeadmå…è®¸ä½ åˆ†é˜¶æ®µå°†èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤ã€‚`kubeadm join phase`å‘½ä»¤æ˜¯åœ¨v1.14.0ä¸­æ·»åŠ çš„ã€‚

è¦æŸ¥çœ‹é˜¶æ®µçš„æœ‰åºåˆ—è¡¨å’Œå­é˜¶æ®µåˆ—è¡¨ï¼Œå¯ä»¥è°ƒç”¨`kubeadm join --help`ã€‚åˆ—è¡¨å°†ä½äºå¸®åŠ©çš„é¡¶éƒ¨ï¼Œæ¯ä¸ªé˜¶æ®µæ—è¾¹éƒ½æœ‰ä¸€ä¸ªæè¿°ã€‚æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨`kubeadm join`ï¼Œæ‰€æœ‰é˜¶æ®µå’Œå­é˜¶æ®µéƒ½å°†æŒ‰ç…§è¿™ä¸ªé¡ºåºæ‰§è¡Œã€‚

æœ‰äº›é˜¶æ®µæœ‰ç‹¬ç‰¹çš„é€‰é¡¹ï¼Œæ‰€ä»¥å¦‚æœä½ æƒ³æŸ¥çœ‹å¯ç”¨çš„é€‰é¡¹åˆ—è¡¨ï¼Œè¯·æ·»åŠ `--help`ï¼Œä¾‹å¦‚:

```shell
kubeadm join phase kubelet-start --help
```

ä¸[`kubeadm init phase`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html)å‘½ä»¤ç±»ä¼¼ï¼Œ[`kubadm join phase`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join_phase.html)å…è®¸ä½ ä½¿ç”¨`--skip-phase`é€‰é¡¹è·³è¿‡æŸäº›é˜¶æ®µã€‚

ä¾‹å¦‚ï¼š

```shell
sudo kubeadm join --skip-phases=preflight --config=config.yaml
```



## kubeadm upgrade

`kubeadm upgrade`æ˜¯ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„å‘½ä»¤ï¼Œå®ƒå°†å¤æ‚çš„å‡çº§é€»è¾‘å°è£…åœ¨ä¸€ä¸ªå‘½ä»¤åé¢ï¼Œæ”¯æŒè®¡åˆ’å‡çº§å’Œå®é™…æ‰§è¡Œå‡çº§ã€‚

å¦‚æœéœ€è¦ï¼Œ`kubeadm upgrade`è¿˜å¯ä»¥ç”¨äºé™çº§é›†ç¾¤ã€‚

 æ£€æŸ¥å¯ä»¥å‡çº§åˆ°å“ªäº›ç‰ˆæœ¬ï¼Œå¹¶éªŒè¯å½“å‰é›†ç¾¤æ˜¯å¦å¯ä»¥å‡çº§ã€‚è¦è·³è¿‡internetæ£€æŸ¥ï¼Œè¯·ä¼ å…¥å¯é€‰`[version]`å‚æ•°ã€‚

```css
â¯ ./kubeadm upgrade
Upgrade your cluster smoothly to a newer version with this command

Usage:
  kubeadm upgrade [flags]
  kubeadm upgrade [command]

Available Commands:
  apply       Upgrade your Kubernetes cluster to the specified version
  diff        Show what differences would be applied to existing static pod manifests. See also: kubeadm upgrade apply --dry-run
  node        Upgrade commands for a node in the cluster
  plan        Check which versions are available to upgrade to and validate whether your current cluster is upgradeable. To skip the internet check, pass in the optional [version] parameter
```





## kubeadm config

ä»v1.8.0å¼€å§‹ï¼Œkubeadmå°†é›†ç¾¤çš„é…ç½®ä¸Šä¼ åˆ°`kube-system`åç§°ç©ºé—´ä¸­åä¸º`kubeadm-config`çš„ConfigMapï¼Œç„¶ååœ¨å‡çº§æ—¶è¯»å–ConfigMapã€‚è¿™æ”¯æŒæ­£ç¡®é…ç½®ç³»ç»Ÿç»„ä»¶ï¼Œå¹¶æä¾›äº†æ— ç¼çš„ç”¨æˆ·ä½“éªŒã€‚

ä½ å¯ä»¥æ‰§è¡Œ`kubeadm config view`æ¥æŸ¥çœ‹ConfigMapã€‚å¦‚æœä½¿ç”¨kubeadm v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨ä½¿ç”¨`kubeadm upgrade`ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨`kubeadm config upload`åˆ›å»ºConfigMapã€‚

åœ¨Kubernetes v1.11.0ä¸­ï¼Œæ·»åŠ äº†ä¸€äº›æ–°å‘½ä»¤ã€‚ä½ å¯ä»¥ä½¿ç”¨`kubeadm config print-default` æ¥æ‰“å°é»˜è®¤é…ç½®ï¼Œè€Œ`kubeadm config migrate` å¯ä»¥å°†æ—§çš„é…ç½®æ–‡ä»¶è½¬æ¢ä¸ºæ–°ç‰ˆæœ¬ã€‚`kubeadm config images list` å’Œ`kubeadm config images pull` å¯ç”¨äºåˆ—å‡ºå’Œæ‹‰å–kubeadmæ‰€éœ€çš„é•œåƒã€‚

åœ¨ `Kubernetes v1.13.0` ä»¥åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœè¦åˆ—å‡º/æ‹‰å‡ºçš„æ˜¯kube-dnsé•œåƒï¼Œè€Œä¸æ˜¯CoreDNSé•œåƒï¼Œåˆ™å¿…é¡»ä½¿ç”¨è¿™é‡Œæè¿°çš„`--config` æ–¹å¼ã€‚

```bash
â¯ kubeadm config upload --help

There is a ConfigMap in the kube-system namespace called "kubeadm-config" that kubeadm uses to store internal configuration about the
cluster. kubeadm CLI v1.8.0+ automatically creates this ConfigMap with the config used with 'kubeadm init', but if you
initialized your cluster using kubeadm v1.7.x or lower, you must use the 'config upload' command to create this
ConfigMap. This is required so that 'kubeadm upgrade' can configure your upgraded cluster correctly.

Usage:
  kubeadm config [flags]
  kubeadm config [command]

Available Commands:
  images      Interact with container images used by kubeadm
  migrate     Read an older version of the kubeadm configuration API types from a file, and output the similar config object for the newer version
  print       Print configuration

Flags:
  -h, --help                help for config
      --kubeconfig string   The kubeconfig file to use when talking to the cluster. If the flag is not set, a set of standard locations can be searched for an existing kubeconfig file. (default "/etc/kubernetes/admin.conf")

Global Flags:
      --add-dir-header           If true, adds the file directory to the header of the log messages
      --log-file string          If non-empty, use this log file
      --log-file-max-size uint   Defines the maximum size a log file can grow to. Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)
      --one-output               If true, only write logs to their native severity level (vs also writing to each lower severity level)
      --rootfs string            [EXPERIMENTAL] The path to the 'real' host root filesystem.
      --skip-headers             If true, avoid header prefixes in the log messages
      --skip-log-headers         If true, avoid headers when opening log files
  -v, --v Level                  number for the log level verbosity
```



### kubeadm config upload from-file

ä¸Šä¼ ä¸€ä¸ªé…ç½®æ–‡ä»¶åˆ°é›†ç¾¤å†…çš„ConfigMapï¼Œç”¨äºkubeadmé…ç½®ã€‚

ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä½ å¯ä»¥ä½¿ç”¨æä¾›ç»™`kubeadm init`çš„ç›¸åŒé…ç½®æ–‡ä»¶å°†é…ç½®ä¸Šä¼ åˆ°é›†ç¾¤ä¸­çš„ConfigMapã€‚å¦‚æœä½¿ç”¨v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨ä½¿ç”¨`kubeadm upgrade`å‡çº§åˆ°v1.8ä¹‹å‰ï¼Œä½ éœ€è¦ä½¿ç”¨ç›¸åŒçš„é…ç½®æ–‡ä»¶è¿è¡Œè¿™ä¸ªå‘½ä»¤ã€‚

é…ç½®ä½äº`kube-system`å‘½åç©ºé—´ä¸­çš„`kubeadm-config` ConfigMapä¸­ã€‚

```bash
kubeadm config upload from-file [flags]
```

> `kubeadm config upload from-file --help ` æŸ¥çœ‹æ”¯æŒçš„ flages



### kubeadm config view

ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä½ å¯ä»¥åœ¨kubeadmé…ç½®æ‰€åœ¨çš„é›†ç¾¤ä¸­æŸ¥çœ‹ConfigMapã€‚

é…ç½®ä½äº`kube-system`å‘½åç©ºé—´ä¸­çš„`kubeadm-config` ConfigMapä¸­ã€‚

```bash
kubeadm config view [flags]
```



## kubeadm reset

æ­¤å‘½ä»¤å°†è¿˜åŸ`kubeadm init`å’Œ`kubeadm join`æ‰€åšçš„ä»»ä½•æ›´æ”¹ã€‚

è¿è¡Œæ­¤å‘½ä»¤ï¼Œä»¥æ¢å¤` kubeadm init`å’Œ `kubeadm join`å¯¹è¯¥ä¸»æœºæ‰€åšçš„ä»»ä½•æ›´æ”¹ã€‚

```bash
kubeadm reset
```



### æ¸…ç†å¤–éƒ¨etcd

å¦‚æœä½¿ç”¨å¤–éƒ¨etcdï¼Œ `kubeadm reset`ä¸ä¼šåˆ é™¤ä»»ä½•etcdæ•°æ®ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœå†æ¬¡ä½¿ç”¨ç›¸åŒçš„etcdç«¯ç‚¹è¿è¡Œ`kubeadm init`ï¼Œæ‚¨å°†çœ‹åˆ°ä»¥å‰é›†ç¾¤çš„çŠ¶æ€ã€‚

è¦æ“¦é™¤etcdæ•°æ®ï¼Œå»ºè®®ä½¿ç”¨etcdctlè¿™æ ·çš„å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚:

```bash
etcdctl del "" --prefix
```



## kubeadm token

å¼•å¯¼ä»¤ç‰Œç”¨äºåœ¨è¿æ¥é›†ç¾¤çš„èŠ‚ç‚¹å’Œæ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´å»ºç«‹åŒå‘ä¿¡ä»»ï¼Œå¦‚[ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html)ä¸­æ‰€è¿°ã€‚

`kubeadm init`ä½¿ç”¨24å°æ—¶TTLåˆ›å»ºåˆå§‹ä»¤ç‰Œã€‚ä¸‹é¢çš„å‘½ä»¤å¯ä»¥ç®¡ç†è¯¥ä»¤ç‰Œï¼Œå¹¶åˆ›å»ºå’Œç®¡ç†æ–°çš„ä»¤ç‰Œã€‚

 ### kubeadm token create

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¼•å¯¼ä»¤ç‰Œã€‚

```bash
kubeadm token create [token]
```

è¿™ä¸ªå‘½ä»¤å°†ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ª **å¼•å¯¼ä»¤ç‰Œ**ã€‚ä½ å¯ä»¥æŒ‡å®šæ­¤ä»¤ç‰Œçš„ç”¨æ³•ã€â€œç”Ÿå­˜æ—¶é—´â€å’Œå¯é€‰çš„äººæ€§åŒ–æè¿°ã€‚

`[token]`æ˜¯è¦å†™çš„å®é™…ä»¤ç‰Œã€‚è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå®‰å…¨ç”Ÿæˆçš„éšæœºä»¤ç‰Œå½¢å¼`[a-z0-9]{6}.[a-z0-9]{16}`ã€‚å¦‚æœæ²¡æœ‰ç»™å‡º`[token]`ï¼Œåˆ™kubeadmå°†ç”Ÿæˆä¸€ä¸ªéšæœºä»¤ç‰Œã€‚

> æ‰€ä»¥æ‰€ å¼•å¯¼ä»¤ç‰Œæ˜¯å’Œ kueadme å¯¹åº”çš„ï¼š
>
> ```
> â¯ kubeadm token create
> qg8u0m.g31qk96l34ns9gz4
> 
> â¯ kubectl get secrets -A | grep -i qg8u0m
> kube-system       bootstrap-token-qg8u0m                           bootstrap.kubernetes.io/token         6      2m10s
> ```



### kubeadm token delete

åˆ é™¤æœåŠ¡å™¨ä¸Šçš„å¼•å¯¼ä»¤ç‰Œã€‚

```bash
kubeadm token delete [token-value]
```

ä¾‹å¦‚ï¼š

```bash
â¯ kubeadm token delete qg8u0m
bootstrap token "qg8u0m" deleted
â¯ kubeadm token list
```



### kubeadm token generate

ç”Ÿæˆå¹¶æ‰“å°å¼•å¯¼ä»¤ç‰Œï¼Œä½†ä¸è¦åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå®ƒã€‚

è¿™ä¸ªå‘½ä»¤å°†è¾“å‡ºä¸€ä¸ªéšæœºç”Ÿæˆçš„å¼•å¯¼ä»¤ç‰Œï¼Œå¯ä»¥ä¸`init`å’Œ`join`å‘½ä»¤ä¸€èµ·ä½¿ç”¨ã€‚

ä½ ä¸å¿…ä½¿ç”¨æ­¤å‘½ä»¤æ¥ç”Ÿæˆä»¤ç‰Œã€‚åªè¦æ ¼å¼æ˜¯`[a-z0-9]{6}.[a-z0-9]{16}`ï¼Œä½ å‡ºå¯ä»¥è‡ªå·±ç”Ÿæˆã€‚æä¾›æ­¤å‘½ä»¤æ˜¯ä¸ºäº†æ–¹ä¾¿ä»¥ç»™å®šæ ¼å¼ç”Ÿæˆä»¤ç‰Œã€‚

ä½ è¿˜å¯ä»¥ä½¿ç”¨`kubeadm init`è€Œæ— éœ€æŒ‡å®šä»¤ç‰Œï¼Œå®ƒå°†ä¸ºä½ ç”Ÿæˆå¹¶æ‰“å°ä¸€ä¸ªä»¤ç‰Œã€‚

```bash
kubeadm token generate [flags]
```



### kubeadm token list

åˆ—å‡ºæœåŠ¡å™¨ä¸Šçš„å¼•å¯¼ä»¤ç‰Œã€‚



## kubeadm version

è¿™ä¸ªå‘½ä»¤æ‰“å°kubeadmçš„ç‰ˆæœ¬ã€‚



## kubeadm alpha

Kubeadm alphaå‘½ä»¤æ˜¯Kubeadmå·¥å…·ä¸­çš„ä¸€ä¸ªå®éªŒæ€§åŠŸèƒ½ï¼Œç”¨äºå¯ç”¨Kubernetesé›†ç¾¤çš„æŸäº›é«˜çº§åŠŸèƒ½ã€‚åœ¨Kubeadm alphaå‘½ä»¤ä¸­ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å„ç§å‚æ•°å’Œæ ‡å¿—æ¥é…ç½®æ‰€éœ€çš„åŠŸèƒ½å¹¶å¯åŠ¨Kubernetesé›†ç¾¤ã€‚



### kubeadm alpha certs renew

ä½ å¯ä»¥ä½¿ç”¨`all`å­å‘½ä»¤æ›´æ–°æ‰€æœ‰Kubernetesè¯ä¹¦ï¼Œæˆ–è€…æœ‰é€‰æ‹©åœ°æ›´æ–°å®ƒä»¬ã€‚



### renew

æ›´æ–°Kubernetesé›†ç¾¤çš„è¯ä¹¦ã€‚



### all

æ›´æ–°æ‰€æœ‰å¯ç”¨è¯ä¹¦ã€‚

æ›´æ–°è¿è¡Œæ§åˆ¶å¹³é¢æ‰€éœ€çš„æ‰€æœ‰å·²çŸ¥è¯ä¹¦ã€‚æ— è®ºè¿‡æœŸæ—¥æœŸå¦‚ä½•ï¼Œéƒ½ä¼šæ— æ¡ä»¶åœ°è¿è¡Œç»­è®¢ã€‚ä¸ºäº†è·å¾—æ›´å¤šçš„æ§åˆ¶ï¼Œè¿˜å¯ä»¥å•ç‹¬è¿è¡Œç»­è®¢ã€‚

```bash
kubeadm alpha certs renew all [flags]
```



### kubeadm alpha kubeconfig user

`user`å­å‘½ä»¤å¯ç”¨äºä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºkubeconfigæ–‡ä»¶ã€‚



## kubeadm init phase

åœ¨v1.8.0ä¸­ï¼Œkubeadmå¼•å…¥äº†`kubeadm alpha phase`å‘½ä»¤ï¼Œç›®çš„æ˜¯ä½¿kubeadmæ›´åŠ æ¨¡å—åŒ–ã€‚åœ¨v1.13.0ä¸­ï¼Œè¿™ä¸ªå‘½ä»¤é€æ¸è¿‡æ¸¡åˆ°`kubeadm init phase`ã€‚è¿™ç§æ¨¡å—åŒ–ä½¿ä½ èƒ½å¤Ÿè°ƒç”¨å¼•å¯¼è¿‡ç¨‹çš„åŸå­å­æ­¥éª¤ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è®©kubeadmå®ŒæˆæŸäº›éƒ¨åˆ†ï¼Œå¹¶åœ¨éœ€è¦è‡ªå®šä¹‰çš„åœ°æ–¹è¿›è¡Œå¡«å……ã€‚

`kubeadm init phase`ä¸[`kubeadm init`å·¥ä½œæµç¨‹](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#chushihualiucheng)æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„ä»£ç ã€‚



## kubeadm join phase

åœ¨v1.14.0ä¸­ï¼Œkubeadmå¼•å…¥äº†`kubeadm join phase`å‘½ä»¤ï¼Œç›®çš„æ˜¯ä½¿kubeadmæ›´åŠ æ¨¡å—åŒ–ã€‚è¿™ç§æ¨¡å—åŒ–ä½¿ä½ èƒ½å¤Ÿè°ƒç”¨åŠ å…¥ï¼ˆjoinï¼‰è¿‡ç¨‹çš„åŸå­å­æ­¥éª¤ã€‚å› æ­¤ï¼Œä½ å¯ä»¥è®©kubeadmå®ŒæˆæŸäº›éƒ¨åˆ†ï¼Œå¹¶åœ¨éœ€è¦è‡ªå®šä¹‰çš„åœ°æ–¹è¿›è¡Œå¡«å……ã€‚

`kubeadm join phase`ä¸`kubeadm join`å·¥ä½œæµç¨‹æ˜¯ä¸€è‡´çš„ï¼Œå¹¶ä¸”åœ¨åå°ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„ä»£ç ã€‚



## ç»†èŠ‚

kubeadm å›´ç»•ç€ init å’Œ join ä¸ºä¸»ä½“å¼€å±•çš„ã€‚

`kubeadm init`å’Œ`kubeadm join`æ‰€å»ºç«‹çš„é›†ç¾¤åº”è¯¥æ˜¯:

+ å®‰å…¨çš„ï¼š

  å®ƒåº”è¯¥é‡‡ç”¨æœ€æ–°çš„æœ€ä½³å®è·µï¼Œå¦‚:

  + å¼ºåˆ¶æ‰§è¡ŒRBAC
  + ä½¿ç”¨èŠ‚ç‚¹æˆæƒå™¨
  + ä½¿ç”¨æ§åˆ¶å¹³é¢ç»„ä»¶ä¹‹é—´çš„å®‰å…¨é€šä¿¡
  + ä½¿ç”¨APIæœåŠ¡å™¨å’Œkubeletä¹‹é—´çš„å®‰å…¨é€šä¿¡
  + é”å®škubelet API
  + é”å®šå¯¹kube-proxyå’ŒCoreDNSç­‰ç³»ç»Ÿç»„ä»¶çš„APIè®¿é—®
  + é”å®šå¼•å¯¼ä»¤ç‰Œå¯ä»¥è®¿é—®çš„å†…å®¹
  + ç­‰å¾…

+ æ˜“ç”¨çš„ï¼š

  ç”¨æˆ·è¿è¡Œçš„ä¸¤ä¸ªå‘½ä»¤ä¸åº”è¯¥è¶…ä¸¤ä¸ª:

  + `kubeadm init`
  + `export KUBECONFIG=/etc/kubernetes/admin.conf`
  + `kubectl apply -f <network-of-choice.yaml>`
  + `kubeadm join --token <token> <master-ip>:<master-port>`

+ å¯æ‰©å±•çš„ï¼š

  + ä¾‹å¦‚ï¼Œå®ƒåº”è¯¥ä¸æ”¯æŒæ‰€æœ‰ç½‘ç»œæä¾›è€…ï¼Œç›¸åï¼Œé…ç½®ç½‘ç»œå·²è¶…å‡ºäº†èŒƒå›´
  + åº”è¯¥æä¾›ä½¿ç”¨é…ç½®æ–‡ä»¶å®šåˆ¶å„ç§å‚æ•°çš„å¯èƒ½æ€§



### å¸¸é‡å’Œè‘—åçš„å€¼ä¸è·¯å¾„

ä¸ºäº†é™ä½å¤æ‚æ€§å¹¶ç®€åŒ–åŸºäºkubeadmå®ç°çš„éƒ¨ç½²è§£å†³æ–¹æ¡ˆçš„å¼€å‘ï¼Œkubeadmä¸ºä¼—æ‰€å‘¨çŸ¥çš„è·¯å¾„å’Œæ–‡ä»¶åä½¿ç”¨ä¸€ç»„æœ‰é™çš„å¸¸é‡å€¼ã€‚

Kubernetesç›®å½•`/etc/kubernetes`åœ¨åº”ç”¨ç¨‹åºä¸­æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå› ä¸ºå®ƒåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ç»™å®šçš„è·¯å¾„ï¼Œå¹¶ä¸”æ˜¯æœ€ç›´è§‚çš„ä½ç½®ï¼›å…¶ä»–å¸¸é‡è·¯å¾„å’Œæ–‡ä»¶åä¸º:

+ **`/etc/kubernetes/manifests` ä½œä¸ºkubeletåº”è¯¥å¯»æ‰¾é™æ€Podæ¸…å•çš„è·¯å¾„ã€‚é™æ€podçš„æ¸…å•æœ‰:**
  + `etcd.yaml`
  + `kube-apiserver.yaml`
  + `kube-controller-manager.yaml`
  + `kube-scheduler.yaml`
+ **`/etc/kubernetes/` ä½œä¸ºå­˜å‚¨å…·æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶æ ‡è¯†ç¬¦çš„kubeconfigæ–‡ä»¶çš„è·¯å¾„ã€‚kubeconfigæ–‡ä»¶çš„åç§°æœ‰:**
  + `kubelet.conf` (`bootstrap-kubelet.conf` åœ¨TLSå¼•å¯¼æœŸé—´)
  + `controller-manager.conf`
  + `scheduler.conf`
  + `admin.conf` ç”¨äºé›†ç¾¤ç®¡ç†å‘˜å’Œkubeadmè‡ªå·±
+ **è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶åç§°:**
  + `ca.crt`ã€ `ca.key` ç”¨äºKubernetesè¯ä¹¦æˆæƒ
  + `apiserver.crt`ã€ `apiserver.key` ç”¨äºAPIæœåŠ¡å™¨è¯ä¹¦
  + `apiserver-kubelet-client.crt`ã€ `apiserver-kubelet-client.key` ä½œä¸ºAPIæœåŠ¡å™¨çš„å®¢æˆ·ç«¯è¯ä¹¦ç”¨äºè¿æ¥å®‰å…¨åœ°è¿æ¥kubelet
  + `sa.pub`ã€ `sa.key` åœ¨ç­¾å`ServiceAccount`æ—¶ï¼Œä½œä¸ºæ§åˆ¶å™¨ç®¡ç†å™¨çš„å¯†é’¥
  + `front-proxy-ca.crt`ã€ `front-proxy-ca.key` ç”¨äºå‰ç«¯ä»£ç†è¯ä¹¦æˆæƒ
  + `front-proxy-client.crt`ã€ `front-proxy-client.key` ç”¨äºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯



### kubeadmåˆå§‹åŒ–æµç¨‹çš„å†…éƒ¨è®¾è®¡

`kubeadm init`å†…éƒ¨æµç¨‹ï¼ˆç¬¬äºŒä¸ªæ®µè½æ ‡é¢˜ï¼‰ç”±ä¸€ç³»åˆ—è¦æ‰§è¡Œçš„åŸå­å·¥ä½œä»»åŠ¡ç»„æˆï¼Œå¦‚`kubeadm init`ä¸­æ‰€è¿°ã€‚

`kubeadm init phase`å‘½ä»¤å…è®¸ç”¨æˆ·åˆ†åˆ«è°ƒç”¨æ¯ä¸ªä»»åŠ¡ï¼Œå¹¶æœ€ç»ˆæä¾›ä¸€ä¸ªå¯é‡ç”¨å’Œå¯ç»„åˆçš„API/å·¥å…·ç®±ï¼Œå…¶ä»–Kuberneteså¼•å¯¼å·¥å…·ã€ä»»ä½•ITè‡ªåŠ¨åŒ–å·¥å…·æˆ–é«˜çº§ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨è¯¥API/å·¥å…·ç®±åˆ›å»ºè‡ªå®šä¹‰é›†ç¾¤ã€‚



### é¢„æ£€æŸ¥ï¼ˆpreflight)

Kubeadmåœ¨å¯åŠ¨ init ä¹‹å‰æ‰§è¡Œä¸€ç»„é¢„å…ˆæ£€æŸ¥ï¼Œç›®çš„æ˜¯éªŒè¯å…ˆå†³æ¡ä»¶å¹¶é¿å…å¸¸è§çš„é›†ç¾¤å¯åŠ¨é—®é¢˜ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨`--ignore-preflight-errors` é€‰é¡¹è·³è¿‡ç‰¹å®šçš„é¢„å…ˆæ£€æŸ¥ï¼ˆæˆ–è€…æœ€ç»ˆè·³è¿‡æ‰€æœ‰çš„é¢„å…ˆæ£€æŸ¥ï¼‰ã€‚

+ [è­¦å‘Š]å¦‚æœè¦ä½¿ç”¨çš„Kubernetesç‰ˆæœ¬ï¼ˆä½¿ç”¨ `--kubernetes-version`é€‰é¡¹æŒ‡å®šï¼‰è‡³å°‘æ¯”kubeadm CLIç‰ˆæœ¬é«˜ä¸€ä¸ªæ¬¡è¦ç‰ˆæœ¬ã€‚
+ Kubernetesç³»ç»Ÿè¦æ±‚:
  + å¦‚æœè¿è¡Œåœ¨linuxä¸Š:
    + [é”™è¯¯]å¦‚æœä¸æ˜¯æ‹¥æœ‰ç‰¹å®šKernelSpecçš„å†…æ ¸3.10+æˆ–4
    + [é”™è¯¯]å¦‚æœéœ€è¦çš„cgroupså­ç³»ç»Ÿæ²¡æœ‰å»ºç«‹
  + å¦‚æœä½¿ç”¨dockerï¼š
    + [è­¦å‘Š/é”™è¯¯]å¦‚æœDockeræœåŠ¡ä¸å­˜åœ¨ï¼Œå¦‚æœå®ƒè¢«ç¦ç”¨ï¼Œå¦‚æœå®ƒä¸æ˜¯æ´»åŠ¨çš„ã€‚
    + [é”™è¯¯]å¦‚æœDockerç«¯ç‚¹ä¸å­˜åœ¨æˆ–ä¸å·¥ä½œ
    + [è­¦å‘Š]å¦‚æœdockerç‰ˆæœ¬>17.03
  + å¦‚æœä½¿ç”¨å…¶å®ƒCRIå¼•æ“ï¼š
    + [é”™è¯¯]å¦‚æœcrictlå¥—æ¥å­—æ²¡æœ‰åº”ç­”
+ [é”™è¯¯]å¦‚æœç”¨æˆ·ä¸æ˜¯root
+ [é”™è¯¯]å¦‚æœæœºå™¨ä¸»æœºåä¸æ˜¯æœ‰æ•ˆçš„DNSå­åŸŸå
+ [è­¦å‘Š]å¦‚æœæ— æ³•é€šè¿‡ç½‘ç»œæŸ¥æ‰¾è®¿é—®ä¸»æœºå
+ [é”™è¯¯]å¦‚æœkubeletç‰ˆæœ¬ä½äºkubeadmæ”¯æŒçš„æœ€å°kubeletç‰ˆæœ¬ï¼ˆå½“å‰æ¬¡è¦ç‰ˆæœ¬ - 1ï¼‰
+ [é”™è¯¯]å¦‚æœkubeletç‰ˆæœ¬æ¯”æ‰€éœ€çš„æ§åˆ¶å¹³é¢ç‰ˆæœ¬ï¼ˆä¸æ”¯æŒçš„ç‰ˆæœ¬å€¾æ–œï¼‰é«˜è‡³å°‘ä¸€ä¸ªæ¬¡è¦ç‰ˆæœ¬
+ [è­¦å‘Š]å¦‚æœkubeletæœåŠ¡ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨
+ [è­¦å‘Š]å¦‚æœfirewalldæ˜¯æ´»åŠ¨çš„
+ [é”™è¯¯]å¦‚æœAPIæœåŠ¡å™¨bindPortæˆ–ç«¯å£ä½¿ç”¨çš„æ˜¯`10250/10251/10252`
+ [é”™è¯¯]å¦‚æœ`/etc/kubernetes/manifest`æ–‡ä»¶å¤¹å·²ç»å­˜åœ¨ä¸”ä¸æ˜¯ç©ºçš„
+ [é”™è¯¯]å¦‚æœ`/proc/sys/net/bridge/bridge-nf-call-iptables`æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸åŒ…å«1
+ [é”™è¯¯]å¦‚æœadvertiseåœ°å€æ˜¯ipv6ï¼Œ `/proc/sys/net/bridge/bridge-nf-call-ip6tables`ä¸å­˜åœ¨æˆ–ä¸åŒ…å«1ã€‚
+ [é”™è¯¯]å¦‚æœswapæ˜¯æ‰“å¼€çš„
+ [é”™è¯¯]å¦‚æœå‘½ä»¤è·¯å¾„ä¸­ä¸å­˜åœ¨`ip`ã€`iptables`ã€`mount`ã€`nsenter`å‘½ä»¤
+ [è­¦å‘Š]å¦‚æœå‘½ä»¤è·¯å¾„ä¸­æ²¡æœ‰`ebtables`ã€`ethtool`ã€`socat`ã€`tc`ã€`touch`ã€`crictl`å‘½ä»¤
+ [è­¦å‘Š]å¦‚æœAPIæœåŠ¡å™¨ã€æ§åˆ¶å™¨ç®¡ç†å™¨ã€è°ƒåº¦å™¨çš„é¢å¤–å‚æ•°åŒ…å«ä¸€äº›æ— æ•ˆé€‰é¡¹
+ [è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°[https://API.AdvertiseAddress:API.BindPort](https://api.advertiseaddress:API.BindPort/)
+ [è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°æœåŠ¡å­ç½‘ï¼ˆä»…é€‰ä¸­ç¬¬ä¸€ä¸ªåœ°å€ï¼‰
+ [è­¦å‘Š]å¦‚æœé€šè¿‡ä»£ç†è¿æ¥åˆ°Podå­ç½‘ï¼ˆä»…é€‰ä¸­ç¬¬ä¸€ä¸ªåœ°å€ï¼‰
+ å¦‚æœæä¾›å¤–éƒ¨etcd:
  + [é”™è¯¯]å¦‚æœetcdç‰ˆæœ¬å°äº3.0.14
  + [é”™è¯¯]å¦‚æœæŒ‡å®šetcdè¯ä¹¦æˆ–å¯†é’¥ï¼Œä½†æ²¡æœ‰æä¾›
+ å¦‚æœæ²¡æœ‰æä¾›å¤–éƒ¨etcdï¼ˆå› æ­¤å°†å®‰è£…æœ¬åœ°etcdï¼‰:
  + [é”™è¯¯]å¦‚æœ2379ç«¯å£è¢«å ç”¨
  + [é”™è¯¯]å¦‚æœ Etcd.DataDiræ–‡ä»¶å¤¹å·²ç»å­˜åœ¨å¹¶ä¸”ä¸ä¸ºç©º
+ å¦‚æœæˆæƒæ¨¡å¼ä¸ºABAC:
  + [é”™è¯¯]å¦‚æœ`abac_policy.json`æ–‡ä»¶ä¸å­˜åœ¨
+ å¦‚æœæˆæƒæ¨¡å¼æ˜¯WebHookï¼š
  + [é”™è¯¯]å¦‚æœ`webhook_authz .conf`æ–‡ä»¶ä¸å­˜åœ¨

è¯·æ³¨æ„ï¼š

1. å¯ä»¥ä½¿ç”¨ `kubeadm init phase preflight`å‘½ä»¤å•ç‹¬æ‰§è¡Œé¢„å…ˆæ£€æŸ¥



### ç”Ÿæˆå¿…è¦çš„è¯ä¹¦

Kubeadmç”Ÿæˆç”¨äºä¸åŒç›®çš„çš„è¯ä¹¦å’Œç§é’¥å¯¹:

+ ä¸€ä¸ªç”¨äºKubernetesé›†ç¾¤çš„è‡ªç­¾åè¯ä¹¦é¢å‘æœºæ„ï¼Œä¿å­˜åœ¨`ca.crt`æ–‡ä»¶å’Œ`ca.key`ç§é’¥æ–‡ä»¶ä¸­

+ APIæœåŠ¡å™¨çš„æœåŠ¡è¯ä¹¦ï¼Œä½¿ç”¨

  ```
  ca.crt
  ```

  ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜åˆ°

  ```
  apiserver.crt
  ```

  æ–‡ä»¶åŠå…¶ç§é’¥

  ```
  apiserver.key
  ```

  ã€‚æ­¤è¯ä¹¦åº”åŒ…å«ä»¥ä¸‹å¯é€‰åç§°:

  + KubernetesæœåŠ¡çš„å†…éƒ¨é›†ç¾¤IPï¼ˆæœåŠ¡CIDRä¸­çš„ç¬¬ä¸€ä¸ªåœ°å€ï¼Œä¾‹å¦‚ï¼šå¦‚æœæœåŠ¡å­ç½‘æ˜¯`10.96.0.0/12`ï¼Œåˆ™é›†ç¾¤IPä¸º`10.96.0.1`ï¼‰
  + Kubernetes DNSåç§°ï¼›ä¾‹å¦‚ï¼šå¦‚æœæŒ‡å®š`--service-dns-domain` ä¸º `cluster.local`ï¼Œåˆ™DNSåç§°ä¸º`kubernetes.default.svc.cluster.local` ï¼ŒåŠ ä¸Šé»˜è®¤DNSåç§°ï¼š `kubernetes.default.svc`ã€`kubernetes.default`ã€ `kubernetes`
  + èŠ‚ç‚¹åç§°
  + `--apiserver-advertise-address`
  + ç”±ç”¨æˆ·æŒ‡å®šçš„å…¶ä»–æ›¿ä»£åç§°

+ ç”¨äºAPIæœåŠ¡å™¨å®‰å…¨åœ°è¿æ¥åˆ°kubeletçš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½¿ç”¨`ca.crt`ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜åˆ°`apiserver-kubelet-client.crt`æ–‡ä»¶ä¸­åŠå…¶ç§é’¥`apiserver-kubelet-client.key`ã€‚è¿™ä¸ªè¯ä¹¦åº”è¯¥åœ¨ `system:masters`ç»„ç»‡ä¸­

+ ç”¨äºç­¾åæœåŠ¡è´¦æˆ·ä»¤ç‰Œçš„ç§é’¥ï¼Œå¹¶ä¿å­˜è‡³ `sa.key` æ–‡ä»¶åŠå…¶å…¬é’¥æ–‡ä»¶ `sa.pub`

+ ç”¨äºå‰ç«¯ä»£ç†æˆæƒçš„è¯ä¹¦ï¼Œå¹¶ä¿å­˜è‡³ `front-proxy-ca.crt`æ–‡ä»¶åŠå…¶å¯†é’¥æ–‡ä»¶y`front-proxy-ca.key`

+ ç”¨äºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯çš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä½¿ç”¨ `front-proxy-ca.crt`ä½œä¸ºCAç”Ÿæˆï¼Œå¹¶ä¿å­˜è‡³ `front-proxy-client.crt` æ–‡ä»¶åŠå…¶ç§é’¥`front-proxy-client.key`

è¯ä¹¦é»˜è®¤å­˜å‚¨åœ¨`/etc/kubernetes/pki`ä¸­ï¼Œä½†æ˜¯è¿™ä¸ªç›®å½•å¯ä»¥ä½¿ç”¨`--cert-dir`é€‰é¡¹è¿›è¡Œé…ç½®ã€‚

**è¯·æ³¨æ„ï¼š**

1. å¦‚æœä¸€ä¸ªç»™å®šçš„è¯ä¹¦å’Œç§é’¥å¯¹éƒ½å­˜åœ¨ï¼Œå¹¶ä¸”å®ƒçš„å†…å®¹ç¬¦åˆä¸Šé¢çš„è§„èŒƒï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ç°æœ‰çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·³è¿‡ç»™å®šè¯ä¹¦çš„ç”Ÿæˆé˜¶æ®µã€‚ä¾‹å¦‚ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥å°†ç°æœ‰CAå¤åˆ¶åˆ°`/etc/kubernetes/pki/ca.{crt,key}`ï¼Œç„¶åkubeadmå°†ä½¿ç”¨è¿™äº›æ–‡ä»¶æ¥ç­¾ç½²å…¶ä½™çš„è¯ä¹¦ã€‚
2. ä»…å¯¹äºCAï¼Œå¯ä»¥åªæä¾›`ca.crt`æ–‡ä»¶è€Œä¸æä¾›`ca.key`æ–‡ä»¶ï¼Œå¦‚æœæ‰€æœ‰å…¶ä»–è¯ä¹¦å’Œkubeconfigæ–‡ä»¶å·²ç»åˆ°ä½ï¼Œkubeadmè¯†åˆ«è¿™ç§æƒ…å†µå¹¶æ¿€æ´»å¤–éƒ¨CAæ¨¡å¼ï¼Œè¿™ä¹Ÿæ„å‘³ç€åœ¨æ§åˆ¶å™¨ç®¡ç†å™¨çš„`csrsigner`æ§åˆ¶å™¨ä¸ä¼šå¯åŠ¨ã€‚
3. å¦‚æœkubeadmåœ¨[å¤–éƒ¨CAæ¨¡å¼](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#waibucamoshi)ä¸‹è¿è¡Œï¼›æ‰€æœ‰è¯ä¹¦éƒ½å¿…é¡»ç”±ç”¨æˆ·æä¾›ï¼Œå› ä¸ºkubeadmä¸èƒ½è‡ªå·±ç”Ÿæˆè¯ä¹¦ã€‚
4. åœ¨kubeadmä»¥`--dry-run`æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œè¯ä¹¦æ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ã€‚
5. å¯ä»¥ä½¿ç”¨[`kubeadm init phase certs all`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-certs) å‘½ä»¤å•ç‹¬è°ƒç”¨è¯ä¹¦ç”Ÿæˆã€‚



### ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”Ÿæˆkubeconfigæ–‡ä»¶

å¸¦æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶æ ‡è¯†çš„Kubeadm kubeconfigæ–‡ä»¶:

+ ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›kubeletä½¿ç”¨ï¼Œ

  ```
  /etc/kubernetes/kubelet.conf
  ```

  ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰kubeletæ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚æ­¤å®¢æˆ·è¯ä¹¦åº”è¯¥ï¼š

  + åœ¨ `system:nodes`ç»„ç»‡ä¸­ï¼Œæ ¹æ®[èŠ‚ç‚¹æˆæƒ](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_node_authorization.html)æ¨¡å—çš„è¦æ±‚
  + CNä¸º `system:node:<hostname-lowercased>`

+ ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›æ§åˆ¶å™¨ç®¡ç†å™¨ä½¿ç”¨ï¼Œ`/etc/kubernetes/controller-manager.conf`ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰æ§åˆ¶å™¨ç®¡ç†å™¨æ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¿™ä¸ªå®¢æˆ·ç«¯è¯ä¹¦çš„CNåº”è¯¥ä¸º `system:kube-controller-manager`ï¼Œè¿™æ˜¯ç”±é»˜è®¤çš„[RBACæ ¸å¿ƒç»„ä»¶è§’è‰²](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#hexinzujianjiaose)å®šä¹‰çš„

+ ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œä¾›è°ƒåº¦å™¨ä½¿ç”¨ï¼Œ`/etc/kubernetes/scheduler.conf`ï¼›åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­åµŒå…¥äº†ä¸€ä¸ªå¸¦æœ‰è°ƒåº¦å™¨æ ‡è¯†çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚è¿™ä¸ªå®¢æˆ·ç«¯è¯ä¹¦CNåº”è¯¥ä¸º`system:kube-scheduler`ï¼Œè¿™æ˜¯ç”±é»˜è®¤çš„[RBACæ ¸å¿ƒç»„ä»¶è§’è‰²](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#hexinzujianjiaose-1)å®šä¹‰çš„

æ­¤å¤–ï¼Œè¿˜ç”Ÿæˆä¸€ä¸ªkubeadmè‡ªèº«å’Œç®¡ç†å‘˜ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°`/etc/kubernetes/admin.conf`æ–‡ä»¶ä¸­ã€‚è¿™é‡Œçš„`admin`å®šä¹‰äº†ç®¡ç†é›†ç¾¤å¹¶å¸Œæœ›å®Œå…¨æ§åˆ¶ï¼ˆrootï¼‰é›†ç¾¤çš„å®é™…äººå‘˜ã€‚ç”¨äº`admin`çš„åµŒå…¥å¼å®¢æˆ·ç«¯è¯ä¹¦åº”è¯¥ï¼š

+ åœ¨`system:masters`ç»„ç»‡ä¸­ï¼Œå¦‚é»˜è®¤çš„[RBACç”¨æˆ·é¢å‘è§’è‰²ç»‘å®š](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_rbac_authorization.html#mianxiangyonghudejiaose)æ‰€å®šä¹‰çš„é‚£æ ·
+ åŒ…å«ä¸€ä¸ªCNï¼Œä½†å®ƒå¯ä»¥æ˜¯ä»»ä½•å€¼ã€‚Kubeadmä½¿ç”¨CN `kubernetes-admin`

è¯·æ³¨æ„ï¼š

1. `ca.crt`è¯ä¹¦è¢«åµŒå…¥åˆ°æ‰€æœ‰kubeconfigæ–‡ä»¶ä¸­ã€‚
2. å¦‚æœå­˜åœ¨ä¸€ä¸ªç»™å®šçš„kubeconfigæ–‡ä»¶ï¼Œå¹¶ä¸”å®ƒçš„å†…å®¹ç¬¦åˆä¸Šé¢çš„è§„èŒƒï¼Œé‚£ä¹ˆå°†ä½¿ç”¨ç°æœ‰çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è·³è¿‡ç»™å®škubeconfigçš„ç”Ÿæˆé˜¶æ®µã€‚
3. å¦‚æœkubeadmåœ¨å¤–éƒ¨CAæ¨¡å¼ä¸‹è¿è¡Œï¼Œé‚£ä¹ˆç”¨æˆ·è¿˜å¿…é¡»æä¾›æ‰€æœ‰å¿…éœ€çš„kubeconfigï¼Œå› ä¸ºkubeadmæœ¬èº«ä¸èƒ½ç”Ÿæˆä»»ä½•kubeonfig
4. åœ¨kubeadmä»¥`--dry-run`æ¨¡å¼æ—¶ï¼Œkubeconfigæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹ã€‚
5. å¯ä»¥ä½¿ç”¨[`kubeadm init phase kubeconfig all`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-kubeconfig) å‘½ä»¤å•ç‹¬è°ƒç”¨Kubeconfigæ–‡ä»¶ç”Ÿæˆã€‚

### ä¸ºæ§åˆ¶å¹³é¢ç»„ä»¶ç”ŸæˆpodåŠèˆ±æ¸…å•

Kubeadmå°†æ§åˆ¶å¹³é¢ç»„ä»¶çš„é™æ€Podæ¸…å•æ–‡ä»¶å†™å…¥`/etc/kubernetes/manifests`ï¼›kubeletç›‘æ§è¿™ä¸ªç›®å½•ï¼Œä»¥ä¾¿åœ¨å¯åŠ¨æ—¶åˆ›å»ºpodã€‚

é™æ€Podæ¸…å•å…±äº«ä¸€ç»„å…¬å…±å±æ€§:

+ æ‰€æœ‰é™æ€podéƒ½éƒ¨ç½²åœ¨`kube-system`å‘½åç©ºé—´ä¸­

+ æ‰€æœ‰é™æ€podéƒ½æœ‰ `tier:control-plane` å’Œ`component:{component-name}` æ ‡ç­¾

+ æ‰€æœ‰é™æ€podéƒ½æœ‰ `scheduler.alpha.kubernetes.io/critical-pod`æ³¨è§£ï¼ˆè¿™å°†è½¬ç§»åˆ°é€‚å½“çš„è§£å†³æ–¹æ¡ˆï¼Œå³åœ¨å°±ç»ªæ—¶ä½¿ç”¨Podä¼˜å…ˆçº§å’ŒæŠ¢å ï¼‰

+ ```
  hostNetwork: true
  ```

   

  è®¾ç½®åœ¨æ‰€æœ‰é™æ€podä¸Šï¼Œå…è®¸åœ¨é…ç½®ç½‘ç»œä¹‹å‰å¯åŠ¨æ§åˆ¶å¹³é¢ï¼›ç»“æœ:

  + æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨ç”¨æ¥å¼•ç”¨APIæœåŠ¡å™¨çš„`address`æ˜¯`127.0.0.1`
  + å¦‚æœä½¿ç”¨æœ¬åœ°etcdæœåŠ¡å™¨ï¼Œ`etcd-servers`åœ°å€å°†è¢«è®¾ç½®ä¸º`127.0.0.1:2379`

+ æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨éƒ½å¯ç”¨äº†é€‰ä¸»åŠŸèƒ½

+ æ§åˆ¶å™¨ç®¡ç†å™¨å’Œè°ƒåº¦å™¨å°†ä½¿ç”¨å„è‡ªçš„æƒŸä¸€æ ‡è¯†å¼•ç”¨kubeconfigæ–‡ä»¶

+ æ‰€æœ‰é™æ€podè·å–ç”¨æˆ·æŒ‡å®šçš„æ‰€æœ‰é¢å¤–é€‰é¡¹ï¼Œå¦‚[å‘æ§åˆ¶å¹³é¢ä¼ é€’è‡ªå®šä¹‰é€‰é¡¹](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#xiangkongzhipingmianchuandizidingyixuanxiang)ä¸­æ‰€è¿°

+ æ‰€æœ‰é™æ€podè·å–ç”¨æˆ·ï¼ˆ`hostPath`ï¼‰æŒ‡å®šçš„æ‰€æœ‰é¢å¤–å·

è¯·æ³¨æ„ï¼š

1. æ‰€æœ‰çš„é•œåƒï¼Œå¯¹äº `--kubernetes-version`æˆ–å½“å‰æ¶æ„ï¼Œå°†ä»`k8s.gcr.io`æ‹‰å–ã€‚å¦‚æœæŒ‡å®šäº†æ›¿ä»£é•œåƒä»“åº“æˆ–CIé•œåƒä»“åº“ï¼Œåˆ™ä½¿ç”¨æ­¤ä»“åº“ï¼›å¦‚æœæ‰€æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶éƒ½åº”è¯¥ä½¿ç”¨ç‰¹å®šçš„å®¹å™¨é•œåƒï¼Œåˆ™å°†ä½¿ç”¨æ­¤é•œåƒã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#shiyongzidingyijingxiang)
2. åœ¨kubeadmä»¥`--dry-run`æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œé™æ€Podæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹
3. å¯ä»¥ä½¿ç”¨ [`kubeadm init phase control-plane all`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-control-plane)å‘½ä»¤å•ç‹¬è°ƒç”¨ä¸»ç»„ä»¶çš„é™æ€Podæ¸…å•ç”Ÿæˆ

#### APIæœåŠ¡å™¨

APIæœåŠ¡å™¨çš„é™æ€Podæ¸…å•å—ç”¨æˆ·æä¾›çš„å‚æ•°å½±å“:

+ è¦ç»‘å®šçš„`apiserver-advertise-address` å’Œ`apiserver-bind-port` ï¼›å¦‚æœæ²¡æœ‰æä¾›ï¼Œè¿™äº›å€¼é»˜è®¤ä¸ºæœºå™¨ä¸Šé»˜è®¤ç½‘ç»œæ¥å£çš„IPåœ°å€å’Œ6443ç«¯å£
+ ç”¨äºæœåŠ¡çš„`service-cluster-ip-range`
+ å¦‚æœæŒ‡å®šäº†å¤–éƒ¨etcdæœåŠ¡å™¨ï¼Œåˆ™æŒ‡å®š `etcd-servers` åœ°å€å’Œç›¸å…³TLSè®¾ç½®ï¼ˆ`etcd-cafile`ã€`etcd-certfile`ã€`etcd-keyfile`ï¼‰ï¼›å¦‚æœä¸æä¾›å¤–éƒ¨etcdæœåŠ¡å™¨ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°etcdï¼ˆé€šè¿‡ä¸»æœºç½‘ç»œï¼‰
+ å¦‚æœæŒ‡å®šäº†äº‘æä¾›å•†ï¼Œåˆ™é…ç½®ç›¸åº”çš„ `--cloud-provider`ï¼Œå¦‚æœå­˜åœ¨ `--cloud-config`è·¯å¾„ï¼ˆè¿™æ˜¯å®éªŒæ€§çš„ã€alphaçº§åˆ«ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰

å…¶ä»–æ— æ¡ä»¶è®¾ç½®çš„APIæœåŠ¡å™¨é€‰é¡¹æœ‰ï¼š

+ `--insecure-port=0` é¿å…ä¸APIæœåŠ¡å™¨çš„ä¸å®‰å…¨è¿æ¥

+ `--enable-bootstrap-token-auth=true` å¯ç”¨ `BootstrapTokenAuthenticator` è®¤è¯æ¨¡å—ã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[TLSå¼•å¯¼](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html)

+ `--allow-privileged` ä¸º`true` ï¼ˆå¿…é¡»ï¼Œä¾‹å¦‚ï¼škube-proxyï¼‰

+ `--requestheader-client-ca-file` ä¸º`front-proxy-ca.crt`

+ ```
  --enable-admission-plugins
  ```

   

  ä¸ºï¼š

  + [`NamespaceLifecycle`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#namespacelifecycle) é¿å…åˆ é™¤ç³»ç»Ÿä¿ç•™çš„å‘½åç©ºé—´
  + [`LimitRanger`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#limitranger) å’Œ[`ResourceQuota`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#resourcequota) æ‰§è¡Œå‘½åç©ºé—´é™åˆ¶
  + [`ServiceAccount`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#serviceaccount) æ‰§è¡ŒæœåŠ¡è´¦æˆ·è‡ªåŠ¨åŒ–
  + [`PersistentVolumeLabel`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#persistentvolumelabel) å°†åœ°åŒºï¼ˆregionï¼‰æˆ–åŒºåŸŸï¼ˆzoneï¼‰æ ‡ç­¾é™„åŠ åˆ°äº‘æä¾›å•†å®šä¹‰çš„æŒä¹…å·ä¸Šï¼ˆä¸æ¨èä½¿ç”¨æ­¤å‡†å…¥æ§åˆ¶å™¨ï¼Œå¹¶å°†åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸æ˜ç¡®é€‰æ‹©ä½¿ç”¨`gce`æˆ–`aws`ä½œä¸ºäº‘æä¾›å•†æ—¶ï¼Œåœ¨v1.9ä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œkubeadmä¸ä¼šéƒ¨ç½²æ­¤å‡†å…¥æ§åˆ¶å™¨ï¼‰
  + [`DefaultStorageClass`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#defaultstorageclass) åœ¨ `PersistentVolumeClaim`å¯¹è±¡ä¸Šå¼ºåˆ¶æ‰§è¡Œé»˜è®¤å­˜å‚¨ç±»ã€
  + [`DefaultTolerationSeconds`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#defaulttolerationseconds)
  + [`NodeRestriction`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/using_admission_controllers.html#noderestriction) é™åˆ¶kubeletå¯ä»¥ä¿®æ”¹çš„å†…å®¹ï¼ˆä¾‹å¦‚ï¼Œåªæœ‰è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„podï¼‰

+ `--kubelet-preferred-address-types` ä¸º`InternalIP,ExternalIP,Hostname;` è¿™ä½¿å¾—`kubectl logs`å’Œå…¶ä»–APIæœåŠ¡å™¨ä¸kubeletçš„é€šä¿¡å¯ä»¥åœ¨èŠ‚ç‚¹çš„ä¸»æœºåæ— æ³•è§£æçš„ç¯å¢ƒä¸­å·¥ä½œ

+ ä½¿ç”¨å‰é¢æ­¥éª¤ç”Ÿæˆçš„è¯ä¹¦çš„é€‰é¡¹:

  + `--client-ca-file` ä¸º`ca.crt`
  + `--tls-cert-file` ä¸º`apiserver.crt`
  + `--tls-private-key-file` ä¸º`apiserver.key`
  + `--kubelet-client-certificate` ä¸º`apiserver-kubelet-client.crt`
  + `--kubelet-client-key` ä¸º`apiserver-kubelet-client.key`
  + `--service-account-key-file` ä¸º`sa.pub`
  + `--requestheader-client-ca-file` ä¸º-proxy-ca.crt`
  + `--proxy-client-cert-file` ä¸º`front-proxy-client.crt`
  + `--proxy-client-key-file` ä¸º`front-proxy-client.key`

+ ç”¨äºä¿æŠ¤å‰ç«¯ä»£ç†ï¼ˆ

  APIèšåˆ

  ï¼‰é€šä¿¡çš„å…¶ä»–é€‰é¡¹ï¼š

  + `--requestheader-username-headers=X-Remote-User`
  + `--requestheader-group-headers=X-Remote-Group`
  + ``--requestheader-extra-headers-prefix=X-Remote-Extra-`
  + `--requestheader-allowed-names=front-proxy-client`

#### æ§åˆ¶å™¨ç®¡ç†å™¨

APIæœåŠ¡å™¨çš„é™æ€Podæ¸…å•å—ç”¨æˆ·æä¾›çš„å‚æ•°å½±å“:

+ å¦‚æœè°ƒç”¨kubeadmæ—¶æŒ‡å®šäº†

   

  ```
  --pod-network-cidr
  ```

  ï¼Œåˆ™é€šè¿‡è®¾ç½®ä»¥ä¸‹é€‰é¡¹å¯ä»¥å¯ç”¨æŸäº›CNIç½‘ç»œæ’ä»¶æ‰€éœ€çš„å­ç½‘ç®¡ç†å™¨ç‰¹æ€§:

  + `--allocate-node-cidrs=true`
  + `--cluster-cidr` å’Œ`--node-cidr-mask-size` é€‰é¡¹ï¼ˆæ ¹æ®æŒ‡å®šçš„CIDRï¼‰
  + å¦‚æœæŒ‡å®šäº†äº‘æä¾›å•†ï¼Œåˆ™é…ç½®ç›¸åº”çš„ `--cloud-provider`ï¼Œå¦‚æœå­˜åœ¨ `--cloud-config`è·¯å¾„ï¼ˆè¿™æ˜¯å®éªŒæ€§çš„ã€alphaçº§åˆ«ï¼Œå°†åœ¨æœªæ¥ç‰ˆæœ¬ä¸­åˆ é™¤ï¼‰

å…¶ä»–æ— æ¡ä»¶è®¾ç½®çš„é€‰é¡¹æœ‰:

+ `--controllers` ä¸ºTLSå¼•å¯¼å¯ç”¨æ‰€æœ‰é»˜è®¤æ§åˆ¶å™¨ä»¥åŠ`BootstrapSigner`å’Œ`TokenCleaner`æ§åˆ¶å™¨ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[TLSå¼•å¯¼](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/command_line_tools_reference/tls_bootstrapping.html)
+ `--use-service-account-credentials` ä¸º`true`
+ ä½¿ç”¨å‰é¢æ­¥éª¤ç”Ÿæˆçš„è¯ä¹¦çš„é€‰é¡¹:
  + `--root-ca-file` ä¸º`ca.crt`
  + `--cluster-signing-cert-file` ä¸º`ca.crt`ï¼Œå¦‚æœç¦ç”¨äº†å¤–éƒ¨CAæ¨¡å¼ï¼Œåˆ™è®¾ç½®ä¸º`""`
  + `--cluster-signing-key-file` ä¸º`ca.key`ï¼Œå¦‚æœç¦ç”¨äº†å¤–éƒ¨CAæ¨¡å¼ï¼Œåˆ™è®¾ç½®ä¸º`""`
  + `--service-account-private-key-file` ä¸º`sa.key`

#### è°ƒåº¦å™¨

è°ƒåº¦å™¨çš„é™æ€Podæ¸…å•ä¸å—ç”¨æˆ·æä¾›çš„å‚æ•°çš„å½±å“ã€‚

### ä¸ºæœ¬åœ°etcdç”Ÿæˆé™æ€Podæ¸…å•

å¦‚æœç”¨æˆ·æŒ‡å®šäº†ä¸€ä¸ªå¤–éƒ¨etcdï¼Œåˆ™è·³è¿‡æ­¤æ­¥éª¤ï¼Œå¦åˆ™kubeadmå°†ç”Ÿæˆä¸€ä¸ªé™æ€Podæ¸…å•æ–‡ä»¶ï¼Œç”¨äºåˆ›å»ºåœ¨Podä¸­è¿è¡Œçš„æœ¬åœ°etcdå®ä¾‹ï¼Œè¯¥å®ä¾‹å…·æœ‰ä»¥ä¸‹å±æ€§:

+ åœ¨ `localhost:2379` ä¸Šè¿›è¡Œç›‘å¬å¹¶ä½¿ç”¨ `HostNetwork=true`
+ å°† `hostPath`ä»`dataDir`æŒ‚è½½åˆ°ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿ
+ ç”¨æˆ·æŒ‡å®šçš„ä»»ä½•é¢å¤–é€‰é¡¹

è¯·æ³¨æ„ï¼š

1. etcdé•œåƒå°†ä»`k8.gcr.io`ä¸­æ‹‰å–ã€‚å¦‚æœæŒ‡å®šäº†å¦ä¸€ä¸ªé•œåƒä»“åº“ï¼Œåˆ™ä½¿ç”¨æ­¤é•œåƒä»“åº“ï¼›å¦‚æœæŒ‡å®šäº†å…¶ä»–é•œåƒåç§°ï¼Œåˆ™å°†ä½¿ç”¨æ­¤é•œåƒåç§°ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[ä½¿ç”¨è‡ªå®šä¹‰é•œåƒ](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#shiyongzidingyijingxiang-1)
2. åœ¨kubeadmä»¥`--dry-run`æ¨¡å¼æ‰§è¡Œæ—¶ï¼Œé™æ€Podæ–‡ä»¶è¢«å†™å…¥ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¤¹
3. æœ¬åœ°etcdçš„é™æ€Podæ¸…å•ç”Ÿæˆå¯ä»¥ä½¿ç”¨[`kubeadm init phase etcd local`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-etcd) å‘½ä»¤å•ç‹¬è°ƒç”¨

### å¯é€‰çš„åŠ¨æ€Kubleté…ç½®

è¦ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·è°ƒç”¨ `kubeadm alpha kubelet config enable-dynamic`ã€‚å®ƒå°†kubeletåˆå§‹åŒ–é…ç½®å†™å…¥ `/var/lib/kubelet/config/init/kubelet`æ–‡ä»¶ã€‚

åˆå§‹åŒ–é…ç½®ç”¨äºåœ¨æ­¤ç‰¹å®šèŠ‚ç‚¹ä¸Šå¯åŠ¨kubeletï¼Œä¸ºkubeletçš„drop-inæ–‡ä»¶æä¾›äº†å¦ä¸€ç§é€‰æ‹©ï¼›è¿™äº›é…ç½®å°†è¢«kubeletåŸºæœ¬é…ç½®æ‰€æ›¿ä»£ï¼Œå¦‚ä¸‹é¢çš„æ­¥éª¤æ‰€è¿°ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®Kubeletå‚æ•°](https://www.coderdocument.com/docs/kubernetes/v1.14/tasks/administer_cluster/set_kubelet_parameters_via_a_config_file.html)ã€‚

è¯·æ³¨æ„ï¼š

+ è¦ä½¿åŠ¨æ€kubeleté…ç½®å·¥ä½œï¼Œ`--dynamic-config-dir=/var/lib/kubelet/config/dynamic` åº”è¯¥åœ¨ `/etc/systemd/system/kubelet.service.d/10-kubeadm.conf`ä¸­æŒ‡å®š
+ ä½¿ç”¨é…ç½®æ–‡ä»¶`--config some-file.yaml`å‘`kubeadm init` æˆ–`kubeadm join` ä¼ é€’ä¸€ä¸ª `KubeletConfiguration`å¯¹è±¡ï¼Œå¯ä»¥æ›´æ”¹kubeleté…ç½®ã€‚å¯ä»¥ä½¿ç”¨`---`åˆ†éš”ç¬¦å°†`KubeletConfiguration`å¯¹è±¡ä¸å…¶ä»–å¯¹è±¡ï¼ˆå¦‚`InitConfiguration`ï¼‰åˆ†éš”å¼€ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·æŸ¥çœ‹ `kubeadm config print-default`å‘½ä»¤ã€‚

### ç­‰å¾…æ§åˆ¶å¹³é¢å¯åŠ¨

è¿™æ˜¯kubeadmé›†ç¾¤çš„å…³é”®æ—¶åˆ»ã€‚kubeadmå°†ç­‰å¾…`localhost:6443/healthz`è¿”å›`ok`ï¼Œä½†æ˜¯ä¸ºäº†æ£€æµ‹æ­»é”æ¡ä»¶ï¼Œå¦‚æœ`localhost:10255/healthz` ï¼ˆkubeletå­˜æ´»ï¼‰æˆ–`localhost:10255/healthz/syncloop` ï¼ˆkubeletå°±ç»ªï¼‰åœ¨40ç§’å’Œ60ç§’åéƒ½æ²¡æœ‰è¿”å›`ok`ï¼Œåˆ™kubeadmå°†å¿«é€Ÿå¤±è´¥ã€‚

kubeadmä¾èµ–äºkubeletæ¥æ‹‰å–æ§åˆ¶å¹³é¢é•œåƒï¼Œå¹¶å°†å…¶ä½œä¸ºé™æ€podæ­£å¸¸è¿è¡Œã€‚æ§åˆ¶å¹³é¢å¯åŠ¨åï¼Œkubeadmå°†å®Œæˆä»¥å¦‚ä¸‹æ®µè½ä¸­æè¿°çš„ä»»åŠ¡ã€‚

### ï¼ˆåœ¨v1.9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«ï¼‰å†™å…¥kubeletåŸºæœ¬é…ç½®

å¦‚æœä½¿ç”¨ `--feature-gates=DynamicKubeletConfig`è°ƒç”¨kubeadmï¼š

+ å°†kubeletåŸºæœ¬é…ç½®å†™å…¥`kube-system`å‘½åç©ºé—´ä¸­çš„`kubelet-base-config-v1.9` ConfigMap
+ åˆ›å»ºRBACè§„åˆ™ï¼Œæˆäºˆå¯¹æ‰€æœ‰å¼•å¯¼ä»¤ç‰Œå’Œæ‰€æœ‰kubeletå®ä¾‹(å³ `system:bootstrappers:kubeadm:default-node-token` å’Œ`system:nodes`ç»„)çš„ConfigMapçš„è¯»è®¿é—®æƒ
+ é€šè¿‡ `Node.spec.configSource`æŒ‡å‘æ–°åˆ›å»ºçš„ConfigMapï¼Œä¸ºåˆå§‹æ§åˆ¶å¹³é¢èŠ‚ç‚¹å¯ç”¨åŠ¨æ€kubeleté…ç½®ç‰¹æ€§ã€‚

### å°†kubeadmé›†ç¾¤é…ç½®ä¿å­˜åœ¨ConfigMapä¸­ï¼Œä¾›ä»¥åä½¿ç”¨

kubeadmå°†é€šè¿‡é€‰é¡¹æˆ–é…ç½®æ–‡ä»¶ä¼ é€’ç»™`kubeadm init`çš„é…ç½®ä¿å­˜åœ¨`kube-system`å‘½åç©ºé—´ä¸­åä¸º`kubeadm-config`çš„ConfigMapä¸­ã€‚

è¿™å°†ç¡®ä¿å°†æ¥æ‰§è¡Œkubeadmæ“ä½œï¼ˆå¦‚ï¼š`kubeadm upgrade`ï¼‰å°†èƒ½å¤Ÿç¡®å®šå®é™…/å½“å‰é›†ç¾¤çŠ¶æ€ï¼Œå¹¶åŸºäºè¯¥æ•°æ®åšå‡ºæ–°çš„å†³ç­–ã€‚

è¯·æ³¨æ„ï¼š

1. åœ¨ä¸Šä¼ ä¹‹å‰ï¼Œæ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚ä»¤ç‰Œï¼Œå°†ä»é…ç½®ä¸­åˆ é™¤
2. å¯ä»¥ä½¿ç”¨[`kubeadm init phase upload-config`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-upload-config) å‘½ä»¤å•ç‹¬è°ƒç”¨ä¸»èŠ‚ç‚¹é…ç½®çš„ä¸Šä¼ 
3. å¦‚æœä½¿ç”¨kubeadm v1.7åˆå§‹åŒ–é›†ç¾¤ã€‚åœ¨å‡çº§åˆ°v1.8ä¹‹å‰ï¼Œä½ å¿…é¡»æ‰‹åŠ¨åˆ›å»ºä¸»èŠ‚ç‚¹é…ç½®ConfigMapã€‚ä¸ºäº†ç®€åŒ–è¿™ä¸€ä»»åŠ¡ï¼Œå®ç°äº† [`kubeadm config upload (from-flags|from-file)`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_config.html)

### æ ‡è®°ä¸»èŠ‚ç‚¹

ä¸€æ—¦æ§åˆ¶å¹³é¢å¯ç”¨ï¼Œkubeadmå°±ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

+ ä¸ºä¸»èŠ‚ç‚¹æ·»åŠ  `node-role.kubernetes.io/master=""`æ ‡ç­¾
+ ä¸ºä¸»èŠ‚ç‚¹æ·»åŠ  `node-role.kubernetes.io/master:NoSchedule`æ±¡æŸ“

è¯·æ³¨æ„ï¼š

+ å¯ä»¥ä½¿ç”¨[`kubeadm init phase mark-control-plane`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-mark-control-plane) å‘½ä»¤å•ç‹¬è°ƒç”¨æ ‡è®°æ§åˆ¶å¹³é¢é˜¶æ®µ

### é…ç½®TLSå¼•å¯¼ç”¨äºèŠ‚ç‚¹åŠ å…¥é›†ç¾¤

Kubeadm[ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html)ï¼Œå°†æ–°èŠ‚ç‚¹è¿æ¥åˆ°ç°æœ‰é›†ç¾¤ï¼›æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§[è®¾è®¡ææ¡ˆ](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md)ã€‚

`kubeadm init`ç¡®ä¿ä¸ºè¯¥è¿›ç¨‹æ­£ç¡®é…ç½®äº†æ‰€æœ‰å†…å®¹ï¼Œè¿™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ä»¥åŠè®¾ç½®APIæœåŠ¡å™¨å’Œæ§åˆ¶å™¨é€‰é¡¹ï¼ˆå¦‚å‰é¢å„æ®µè½ä¸­æ‰€è¿°ï¼‰ã€‚è¯·æ³¨æ„ï¼š

+ å¯ä»¥ä½¿ç”¨[`kubeadm init phase bootstrap-token`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-bootstrap-token) å‘½ä»¤é…ç½®èŠ‚ç‚¹çš„TLSå¼•å¯¼ï¼Œæ‰§è¡Œå¦‚ä¸‹å„æ®µè½æè¿°çš„æ‰€æœ‰é…ç½®æ­¥éª¤ï¼›æˆ–è€…ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥å•ç‹¬è°ƒç”¨

#### åˆ›å»ºå¼•å¯¼ä»¤ç‰Œ

`kubeadm init`åˆ›å»ºç¬¬ä¸€ä¸ªå¼•å¯¼ä»¤ç‰Œï¼Œè¯¥ä»¤ç‰Œå¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥ç”±ç”¨æˆ·ä½¿ç”¨ `--token`ç®•æä¾›ï¼›æ­£å¦‚å¼•å¯¼ä»¤ç‰Œè§„èŒƒä¸­æ‰€è®°å½•çš„é‚£æ ·ï¼Œä»¤ç‰Œåº”è¯¥ä»¥åç§° `bootstrap-token-<token-id>` ä½œä¸ºSecretä¿å­˜åœ¨`kube-system`å‘½åç©ºé—´ä¸­ã€‚è¯·æ³¨æ„:

1. ç”±`kubeadm init`åˆ›å»ºçš„ç¼ºçœä»¤ç‰Œå°†ç”¨äºéªŒè¯TLSå¼•å¯¼è¿‡ç¨‹ä¸­çš„ä¸´æ—¶ç”¨æˆ·ï¼›è¿™äº›ç”¨æˆ·å°†æ˜¯`system:bootstrappers:kubeadm:default-node-token` ç»„çš„æˆå‘˜
2. ä»¤ç‰Œçš„æœ‰æ•ˆæ€§æœ‰é™ï¼Œé»˜è®¤ä¸º24å°æ—¶ï¼ˆé—´éš”å¯ä»¥ä½¿ç”¨`â€”token-ttl` é€‰é¡¹æ›´æ”¹ï¼‰
3. å¯ä»¥ä½¿ç”¨[`kubeadm token`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_token.html)å‘½ä»¤åˆ›å»ºå…¶ä»–ä»¤ç‰Œï¼Œè¯¥å‘½ä»¤ä¸ºä»¤ç‰Œç®¡ç†æä¾›äº†å…¶ä»–æœ‰ç”¨çš„åŠŸèƒ½

#### å…è®¸è¦åŠ å…¥çš„èŠ‚ç‚¹è°ƒç”¨CSR API

Kubeadmç¡®ä¿ `system:bootstrappers:kubeadm:default-node-token`ç»„ä¸­çš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®è¯ä¹¦ç­¾åAPIã€‚

è¿™æ˜¯é€šè¿‡åœ¨ä¸Šé¢çš„ç»„å’Œé»˜è®¤RBACè§’è‰² `system:node-bootstrapper`ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º `kubeadm:kubelet-bootstrap`çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚

#### ä¸ºæ–°çš„å¼•å¯¼ä»¤ç‰Œè®¾ç½®è‡ªåŠ¨æ‰¹å‡†

Kubeadmç¡®ä¿å¼•å¯¼ä»¤ç‰Œå°†ç”±`csrapprover`æ§åˆ¶å™¨è‡ªåŠ¨æ‰¹å‡†å…¶CSRè¯·æ±‚ã€‚

è¿™æ˜¯é€šè¿‡åœ¨`system:bootstrappers:kubeadm:default-node-token` ç»„å’Œé»˜è®¤è§’è‰² `system:certificates.k8s.io:certificatesigningrequests:nodeclient`ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º `kubeadm:node-autoapprove-bootstrap` çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚

åº”è¯¥ä¹Ÿåˆ›å»ºäº† `system:certificates.k8s.io:certificatesigningrequests:nodeclient`è§’è‰²ï¼Œè¯¥è§’è‰²è¢«æˆäºˆäº†å¯¹`/apis/certificates.k8s.io/certificatesigningrequests/nodeclient`çš„POSTæƒé™ã€‚

#### ä¸ºèŠ‚ç‚¹è¯ä¹¦æ—‹è½¬è®¾ç½®è‡ªåŠ¨æ‰¹å‡†

Kubeadmç¡®ä¿ä¸ºèŠ‚ç‚¹å¯ç”¨è¯ä¹¦æ—‹è½¬ï¼ŒèŠ‚ç‚¹çš„æ–°è¯ä¹¦è¯·æ±‚å°†ç”±`csrapprover`æ§åˆ¶å™¨è‡ªåŠ¨æ‰¹å‡†å…¶CSRè¯·æ±‚ã€‚

è¿™æ˜¯é€šè¿‡åœ¨`system:nodes` ç»„å’Œé»˜è®¤è§’è‰² `system:certificates.k8s.io:certificatesigningrequests:selfnodeclient`ä¹‹é—´åˆ›å»ºä¸€ä¸ªåä¸º `kubeadm:node-autoapprove-certificate-rotation` çš„é›†ç¾¤è§’è‰²ç»‘å®šæ¥å®ç°çš„ã€‚

#### åˆ›å»ºå…¬å…±cluster-info ConfigMap

è¿™ä¸ªé˜¶æ®µåœ¨`kube-public`å‘½åç©ºé—´ä¸­åˆ›å»º`cluster-info` ConfigMapã€‚

æ­¤å¤–ï¼Œå®ƒè¿˜åˆ›å»ºäº†ä¸€ä¸ªè§’è‰²å’Œä¸€ä¸ªè§’è‰²ç»‘å®šï¼Œæˆäºˆæœªç»è®¤è¯çš„ç”¨æˆ·ï¼ˆå³ `system:unauthenticated`ç»„ä¸­çš„ç”¨æˆ·ï¼‰è®¿é—®è¯¥ConfigMapçš„æƒé™ã€‚

è¯·æ³¨æ„ï¼š

1. å¯¹`cluster-info` ConfigMapçš„è®¿é—®ä¸å—é€Ÿç‡é™åˆ¶ã€‚å¦‚æœä½ æŠŠä½ çš„ä¸»èŠ‚ç‚¹æš´éœ²åœ¨äº’è”ç½‘ä¸Šï¼Œè¿™å¯èƒ½æ˜¯ä¸ªé—®é¢˜ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ï¼›æœ€åçš„æƒ…å†µæ˜¯DoSæ”»å‡»ï¼Œæ”»å‡»è€…ä½¿ç”¨APIæœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†çš„æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¯·æ±‚æ¥è®¿é—®`cluster-info` ConfigMapã€‚

### å®‰è£…æ’ä»¶

Kubeadmé€šè¿‡APIæœåŠ¡å™¨å®‰è£…å†…éƒ¨DNSæœåŠ¡å™¨å’Œkube-proxyæ’ä»¶ç»„ä»¶ã€‚è¯·æ³¨æ„:

1. æ­¤é˜¶æ®µå¯ä»¥ä½¿ç”¨ [`kubeadm init phase addon all`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init_phase.html#kubeadm-init-phase-addon)å‘½ä»¤å•ç‹¬è°ƒç”¨ã€‚

#### proxy

åœ¨ `kube-system` å‘½åç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªç”¨äº`kube-proxy`çš„ServiceAccountï¼›ç„¶å`kube-proxy`ä½œä¸ºDaemonSetéƒ¨ç½²:

+ åˆ°ä¸»èŠ‚ç‚¹çš„å‡­æ®ï¼ˆ`ca.crt`å’Œ`token`ï¼‰æ¥è‡ªServiceAccount
+ ä¸»èŠ‚ç‚¹çš„ä½ç½®æ¥è‡ªConfigMap
+ `kube-proxy` ServiceAccountç»‘å®šåˆ° `system:node-proxier` ClusterRoleä¸­çš„ç‰¹æƒ

#### DNS

è¯·æ³¨æ„ï¼š

+ CoreDNSæœåŠ¡è¢«å‘½åä¸º`kube-dns`ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢å½“ç”¨æˆ·å°†é›†ç¾¤DNSä»kube-dnsåˆ‡æ¢åˆ°CoreDNSï¼ˆåä¹‹äº¦ç„¶ï¼‰æ—¶æœåŠ¡ä¸­çš„ä»»ä½•ä¸­æ–­
+ åœ¨Kubernetes v1.10æˆ–æ›´æ—©çš„ç‰ˆæœ¬ä¸­ï¼Œå¿…é¡»ä½¿ç”¨ `--feature-gates=CoreDNS=true`å¯ç”¨CoreDNS
+ åœ¨Kubernetes v1.11å’Œv1.12ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSæ˜¯é»˜è®¤çš„DNSæœåŠ¡å™¨ï¼Œå¿…é¡»ä½¿ç”¨ `--feature-gates=CoreDNS=false`è°ƒç”¨kubeadmæ¥å®‰è£…kube-dns
+ åœ¨Kubernetes v1.13åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼ŒCoreDNSç‰¹æ€§å¼€å…³ä¸å†å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨è¿™é‡Œæè¿°çš„`--config`æ–¹æ³•å®‰è£…kube-dns

åœ¨`kube-system`å‘½åç©ºé—´ä¸­åˆ›å»ºäº†ä¸€ä¸ªç”¨äºCoreDNSæˆ–kube-dnsçš„ServiceAccountã€‚

éƒ¨ç½²`kube-dns`éƒ¨ç½²å’ŒæœåŠ¡:

+ è¿™æ˜¯ç›¸å¯¹æœªç»ä¿®æ”¹çš„ä¸Šæ¸¸æ ¸å¿ƒéƒ¨ç½²
+ `kube-dns`æœåŠ¡å¸æˆ·ç»‘å®šåˆ° `system:kube-dns` ClusterRoleçš„ç‰¹æƒ

### å¯é€‰çš„è‡ªæ‰˜ç®¡

è¦åœ¨ç°æœ‰çš„é™æ€Podæ§åˆ¶å¹³é¢ä¸Šå¯ç”¨è‡ªæ‰˜ç®¡ï¼Œè¯·ä½¿ç”¨`kubeadm alpha selfhosting pivot`ã€‚

è‡ªæ‰˜ç®¡åŸºæœ¬ä¸Šç”¨DaemonSetæ›¿æ¢äº†ç”¨äºæ§åˆ¶å¹³é¢ç»„ä»¶çš„podåŠèˆ±ï¼›è¿™æ˜¯é€šè¿‡å¯¹APIæœåŠ¡å™¨ã€è°ƒåº¦å™¨å’Œæ§åˆ¶å™¨ç®¡ç†å™¨é™æ€åŠèˆ±æ‰§è¡Œä»¥ä¸‹æ­¥éª¤å®ç°çš„:

+ ä»ç£ç›˜åŠ è½½é™æ€Podè§„çº¦
+ ä»é™æ€Podæ¸…å•æ–‡ä»¶ä¸­æå–PodSpec
+ ä¿®æ”¹PodSpecä½¿ä¹‹ä¸è‡ªæ‰˜ç®¡å…¼å®¹ï¼Œæ›´å¤šç»†èŠ‚:
  + æ·»åŠ èŠ‚ç‚¹é€‰æ‹©å™¨å±æ€§ï¼Œå®šå‘è‡³æ‹¥æœ‰`node-role.kubernetes.io/master=""` æ ‡ç­¾çš„èŠ‚ç‚¹
  + æ·»åŠ  `node-role.kubernetes.io/master:NoSchedule` æ±¡æŸ“çš„å®¹å¿
  + å°† `spec.DNSPolicy` è®¾ç½®ä¸º`ClusterFirstWithHostNet`
+ ä½¿ç”¨ä¸Šé¢æåˆ°çš„PodSpecï¼Œä¸ºè‡ªæ‰˜ç®¡ç»„ä»¶æ„å»ºä¸€ä¸ªæ–°çš„DaemonSetå¯¹è±¡ã€‚
+ åœ¨`kube-system`å‘½åç©ºé—´ä¸­åˆ›å»ºDaemonSetèµ„æºï¼Œå¹¶ç­‰å¾…podå¼€å§‹è¿è¡Œã€‚
+ åˆ é™¤é™æ€Podæ¸…å•æ–‡ä»¶ã€‚kubeletå°†åœæ­¢åŸæ¥è¿è¡Œçš„é™æ€podæ‰˜ç®¡ç»„ä»¶

è¯·æ³¨æ„ï¼Œè‡ªæ‰˜ç®¡å°šæœªæ¢å¤åˆ°èŠ‚ç‚¹é‡å¯ï¼›è¿™å¯ä»¥é€šè¿‡å¤–éƒ¨æ£€æŸ¥ç‚¹æˆ–æ§åˆ¶å¹³é¢podçš„kubeletæ£€æŸ¥ç‚¹æ¥ä¿®å¤ã€‚æœ‰å…³æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§[è‡ªæ‰˜ç®¡](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_init.html#zituoguan)ã€‚

### kubeadm join phaseçš„å†…éƒ¨è®¾è®¡

ä¸`kubeadm init`ç±»ä¼¼ï¼Œ`kubeadm join`å†…éƒ¨å·¥ä½œæµç¨‹ä¹Ÿç”±ä¸€ç³»åˆ—è¦æ‰§è¡Œçš„åŸå­å·¥ä½œä»»åŠ¡ç»„æˆã€‚

è¿™åˆ†ä¸ºå‘ç°ï¼ˆè®©èŠ‚ç‚¹ä¿¡ä»»Kubernetesä¸»èŠ‚ç‚¹ï¼‰å’ŒTLSå¼•å¯¼ï¼ˆè®©Kubernetesä¸»èŠ‚ç‚¹ä¿¡ä»»è¯¥èŠ‚ç‚¹ï¼‰ã€‚

å‚è§[ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œè¿›è¡Œè®¤è¯](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/accessing_api/authenticating_with_bootstrap_tokens.html)æˆ–ç›¸åº”çš„[è®¾è®¡ææ¡ˆ](https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md)ã€‚

### é¢„å…ˆï¼ˆpreflightï¼‰æ£€æŸ¥

`kubeadm`åœ¨å¯åŠ¨åŠ å…¥é›†ç¾¤ä¹‹å‰æ‰§è¡Œä¸€ç»„é¢„å…ˆæ£€æŸ¥ï¼Œç›®çš„æ˜¯éªŒè¯å…ˆå†³æ¡ä»¶å¹¶é¿å…å¸¸è§çš„é›†ç¾¤å¯åŠ¨é—®é¢˜ã€‚

è¯·æ³¨æ„ï¼š

1. `kubeadm join`é¢„å…ˆæ£€æŸ¥åŸºæœ¬ä¸Šæ˜¯`kubeadm init`é¢„å…ˆæ£€æŸ¥çš„å­é›†
2. ä»v1.9å¼€å§‹ï¼Œkubeadmä¸ºCRI-genericåŠŸèƒ½æä¾›äº†æ›´å¥½çš„æ”¯æŒï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºcrictlè·³è¿‡æˆ–æ›¿æ¢dockerç‰¹å®šçš„æ§ä»¶ã€‚
3. ä»v1.9å¼€å§‹ï¼Œkubeadmæ”¯æŒè¿è¡Œåœ¨Windowsä¸Šçš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†è·³è¿‡linuxç‰¹å®šçš„æ§ä»¶ã€‚
4. åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨`--ignore-preflight-errors` é€‰é¡¹è·³è¿‡ç‰¹å®šçš„é¢„å…ˆæ£€æŸ¥ï¼ˆæˆ–è€…æœ€ç»ˆè·³è¿‡æ‰€æœ‰çš„é¢„å…ˆæ£€æŸ¥ï¼‰ã€‚

### å‘ç°cluster-info

æœ‰ä¸¤ç§ä¸»è¦çš„å‘ç°æ–¹æ¡ˆã€‚ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨å…±äº«ä»¤ç‰Œå’ŒAPIæœåŠ¡å™¨çš„IPåœ°å€ã€‚ç¬¬äºŒç§æ–¹æ³•æ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶ï¼ˆå®ƒæ˜¯æ ‡å‡†kubeconfigæ–‡ä»¶çš„å­é›†ï¼‰ã€‚

#### å…±äº«ä»¤ç‰Œå‘ç°

å¦‚æœä½¿ç”¨`--discovery-token`è°ƒç”¨`kubeadm join`ï¼Œåˆ™ä½¿ç”¨ä»¤ç‰Œå‘ç°ï¼›åœ¨æœ¬ä¾‹ä¸­ï¼ŒèŠ‚ç‚¹åŸºæœ¬ä¸Šä»`kube-public`å‘½åç©ºé—´ä¸­çš„`cluster-info` ConfigMapä¸­æ£€ç´¢é›†ç¾¤CAè¯ä¹¦ã€‚

ä¸ºäº†é˜²æ­¢â€œä¸­é—´äººâ€çš„æ”»å‡»ï¼Œæˆ‘ä»¬é‡‡å–äº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

+ é¦–å…ˆï¼Œé€šè¿‡ä¸å®‰å…¨çš„è¿æ¥æ£€ç´¢CAè¯ä¹¦ï¼ˆè¿™æ˜¯å¯èƒ½çš„ï¼Œå› ä¸º`kubeadm init`ä¸º`system:unauthenticated`æˆäºˆäº†å¯¹ `cluster-info` ç”¨æˆ·çš„è®¿é—®æƒé™ï¼‰
+ ç„¶åCAè¯ä¹¦ç»è¿‡ä»¥ä¸‹éªŒè¯æ­¥éª¤:
  + åŸºæœ¬éªŒè¯ï¼šå¯¹JWTç­¾åä½¿ç”¨ä»¤ç‰ŒID
  + å…¬é’¥éªŒè¯ï¼šä½¿ç”¨æä¾›çš„ `--discovery-token-ca-cert-hash`ã€‚è¿™ä¸ªå€¼åœ¨`kubeadm init`çš„è¾“å‡ºä¸­å¯ç”¨ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨æ ‡å‡†å·¥å…·è®¡ç®—ï¼ˆå“ˆå¸Œæ˜¯é€šè¿‡Subject Public Key Info (SPKI)å¯¹è±¡çš„å­—èŠ‚è®¡ç®—çš„ï¼Œå¦‚RFC7469ä¸­æ‰€ç¤ºï¼‰ã€‚`--discovery-token-ca-cert-hash flag` é€‰é¡¹å¯ä»¥é‡å¤å¤šæ¬¡ï¼Œä»¥å…è®¸å¤šä¸ªå…¬é’¥ã€‚
  + ä½œä¸ºé™„åŠ éªŒè¯ï¼ŒCAè¯ä¹¦é€šè¿‡å®‰å…¨è¿æ¥æ£€ç´¢ï¼Œç„¶åä¸æœ€åˆæ£€ç´¢çš„CAè¿›è¡Œæ¯”è¾ƒ

è¯·æ³¨è§£ï¼š

1. é€šè¿‡ä¼ é€’`--discovery-token-unsafe-skip-ca-verification` é€‰é¡¹ï¼Œå¯ä»¥è·¯è¿‡å…¬é’¥éªŒè¯ï¼›è¿™å‰Šå¼±äº†kubeadmå®‰å…¨æ¨¡å‹ï¼Œå› ä¸ºå…¶ä»–äººå¯èƒ½å†’å……Kubernetesä¸»èŠ‚ç‚¹ã€‚

#### æ–‡ä»¶æˆ–HTTPSå‘ç°

å¦‚æœä½¿ç”¨`--discovery-file`è°ƒç”¨`kubeadm join`ï¼Œåˆ™ä½¿ç”¨æ–‡ä»¶å‘ç°ï¼›è¯¥æ–‡ä»¶å¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡HTTPS URLä¸‹è½½ï¼›å¯¹äºHTTPSï¼Œä½¿ç”¨å·²å®‰è£…çš„ä¸»èŠ‚ç‚¹CA åŒ…éªŒè¯èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚

é€šè¿‡æ–‡ä»¶å‘ç°ï¼Œé›†ç¾¤CAè¯ä¹¦è¢«æ·»åŠ åœ¨æ–‡ä»¶æœ¬èº«ä¸­ï¼›äº‹å®ä¸Šï¼Œå‘ç°æ–‡ä»¶æ˜¯ä¸€ä¸ªkubeconfigæ–‡ä»¶ï¼Œåªè®¾ç½®äº† `server`å’Œ `certificate-authority-data`å±æ€§ï¼Œå¦‚ [`kubeadm join`](https://www.coderdocument.com/docs/kubernetes/v1.14/reference/setup_tools_reference/kubeadm/kubeadm_join.html)å‚è€ƒæ–‡æ¡£ä¸­æ‰€è¿°ï¼›å½“ä¸é›†ç¾¤å»ºç«‹è¿æ¥æ—¶ï¼Œkubeadmå°è¯•è®¿é—®`cluster-info` ConfigMapï¼Œå¦‚æœå¯ç”¨ï¼Œåˆ™ä½¿ç”¨å®ƒã€‚

### TLSå¼•å¯¼

ä¸€æ—¦çŸ¥é“é›†ç¾¤ä¿¡æ¯ï¼Œå°±ä¼šå†™å…¥`bootstrap-kubelet.conf`æ–‡ä»¶ï¼Œä»è€Œå…è®¸kubeletæ‰§è¡ŒTLSå¼•å¯¼ï¼ˆç›¸åï¼Œç›´åˆ°v.1.7 TLSå¼•å¯¼æ‰ç”±kubeadmç®¡ç†ï¼‰ã€‚

TLSå¼•å¯¼æœºåˆ¶ä½¿ç”¨å…±äº«ä»¤ç‰Œä¸Kubernetesä¸»èŠ‚ç‚¹è¿›è¡Œä¸´æ—¶è®¤è¯ï¼Œä¸ºæœ¬åœ°åˆ›å»ºçš„å¯†é’¥å¯¹æäº¤è¯ä¹¦ç­¾åè¯·æ±‚(CSR)ã€‚

ç„¶åè‡ªåŠ¨æ‰¹å‡†è¯·æ±‚ï¼Œä¿å­˜`ca.crt`æ–‡ä»¶å’Œ`kubelet.conf`æ–‡ä»¶ï¼Œkubeletå°†ä½¿ç”¨è¯¥æ–‡ä»¶åŠ å…¥é›†ç¾¤ï¼ŒåŒæ—¶åˆ é™¤`bootstrap-kubelet.conf`ã€‚

è¯·æ³¨æ„ï¼š

+ ä¸´æ—¶è®¤è¯æ˜¯æ ¹æ®`kubeadm init`æµç¨‹ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡ŒéªŒè¯çš„ï¼ˆæˆ–è€…ä½¿ç”¨`kubeadm token`åˆ›å»ºçš„å…¶ä»–ä»¤ç‰Œï¼‰
+ ä¸´æ—¶è®¤è¯è§£æä¸º`system:bootstrappers:kubeadm:default-node-token` ç»„çš„ç”¨æˆ·æˆå‘˜ï¼Œè¯¥ç”¨æˆ·ç»„åœ¨`kubeadm init`æµç¨‹ä¸­è¢«æˆäºˆè®¿é—®CSR APIçš„æƒé™
+ è‡ªåŠ¨CSRæ‰¹å‡†ç”±`csrapprover`æ§åˆ¶å™¨æ ¹æ®`kubeadm init`æµç¨‹çš„é…ç½®è¿›è¡Œç®¡ç†

#### ï¼ˆåœ¨v1.9ä¸­ä¸ºå¯é€‰çš„alphaçº§åˆ«ï¼‰å†™å…¥kubeletåˆå§‹åŒ–é…ç½®

å¦‚æœä½¿ç”¨ `--feature-gates=DynamicKubeletConfig`è°ƒç”¨`kubeadm`ï¼š

+ ä½¿ç”¨å¼•å¯¼ä»¤ç‰Œå‡­è¯å°†kubeletåŸºæœ¬é…ç½®å†™å…¥`kube-system`å‘½åç©ºé—´ä¸­çš„`kubelet-base-config-v1.9` ConfigMapï¼Œå¹¶å°†å…¶ä½œä¸º kubeletåˆå§‹åŒ–æ–‡ä»¶ `/var/lib/kubelet/config/init/kubelet` å†™å…¥ç£ç›˜ã€‚
+ ä¸€æ—¦kubeletå¼€å§‹ä½¿ç”¨èŠ‚ç‚¹è‡ªå·±çš„å‡­æ®ï¼ˆ`/etc/kubernetes/kubelet.conf`ï¼‰ï¼Œæ›´æ–°å½“å‰èŠ‚ç‚¹é…ç½®ï¼ŒæŒ‡å®šçš„èŠ‚ç‚¹æˆ–kubeletå’Œé…ç½®æ¥æºäºä¸Šè¿°ConfigMapã€‚

è¯·æ³¨æ„ï¼š

1. è¦ä½¿åŠ¨æ€kubeleté…ç½®å·¥ä½œï¼Œéœ€è¦åœ¨`/etc/systemd/system/kubelet.service.d/10-kubeadm.conf`ä¸­è®¾ç½®`--dynamic-config-dir=/var/lib/kubelet/config/dynamic`é€‰é¡¹ã€‚





## END é“¾æ¥

<ul><li><div><a href = '63.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '65.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

