+ [author](http://nsddd.top)

# ç¬¬67èŠ‚ K8s æ·±å…¥ç†è§£ Operator-client è¯¦è§£

<div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## å‰è¨€

åœ¨ä¸Šä¸€ä¸ªå¯¹äº client-go å­¦ä¹ ä¸­ï¼Œé€šè¿‡ sample-controller çš„é¡¹ç›®äº†è§£åˆ° Kubernetes çš„ éƒ¨åˆ† client-go çš„å­¦ä¹ ã€‚ç»§ç»­æ·±å…¥å­¦ä¹  client-go



### Client-go

kubectl å¹¶ä¸é€‚åˆ Kubernetes çš„äºŒæ¬¡å¼€å‘è€…æ¥å’Œ k8s æ‰“äº¤é“ï¼ŒGoè¯­è¨€æä¾›äº†ä¸€ä¸ªä¸“é—¨å’Œ Kubernetes API äº¤äº’çš„ åº“ Client-goã€‚

Kubernetes ä¹Ÿæä¾›äº†ä¸€ä¸ªç¼–å†™æ§åˆ¶å™¨[çš„å°æ¡ˆä¾‹](https://github.com/kubernetes/sample-controller/)ï¼Œå¯ä»¥ä½œä¸º client-go çš„å…¥é—¨

Client-goæ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes API äº¤äº’çš„Goåº“ã€‚å®ƒæä¾›äº†å¹¿æ³›çš„åŠŸèƒ½ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼ŒåŒ…æ‹¬å¼ºç±»å‹ APIã€èµ„æºå®¢æˆ·ç«¯ã€Watch API å’ŒåŠ¨æ€å®¢æˆ·ç«¯ã€‚ä½¿ç”¨ client-goï¼Œå¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°åœ¨ Kubernetes ä¸­åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤èµ„æºå¯¹è±¡ã€‚

> ä»è¿™ä¸ª`package`çš„åç§°æ¥çœ‹ï¼Œè¿™åº”è¯¥æ˜¯è·Ÿ`k8s`æ‰“äº¤é“çš„å®¢æˆ·ç«¯`client`çš„`go`å®ç°ï¼Œè¿™ä¸€ç‚¹æ²¡é”™ï¼Œå®ƒå®šä¹‰äº†è¯¸å¤šèµ„æºçš„å®¢æˆ·ç«¯`client`ã€‚

+ [Client-go GitHub Address](https://github.com/kubernetes/client-go)
+ https://github.com/cubxxw/client-go

ä¸Šé¢æ˜¯ client-go çš„ GitHub ä»“åº“ï¼Œä¸è¿‡è¿™ä¸ªåº“æ˜¯ actions ä»¥æ¯å¤©ä¸€æ¬¡çš„é¢‘ç‡ä» Kubernetes/Kubernetes ä¸»ä»“åº“ä¸­è‡ªåŠ¨åŒæ­¥è¿‡æ¥çš„ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³è´¡çŒ®çš„è¯æ‰¾å¥½ä½ç½®å» Kubernetes è´¡çŒ®ï¼ˆkubernetes/stagin/src/k8s.ioï¼‰ã€‚



### Client-goç›®å½•ç»“æ„

```bash
â”œâ”€â”€ discovery   # DsicoveryClientå®¢æˆ·ç«¯,ç”¨äºå‘ç°k8sæ‰€æ”¯æŒGVRã€‚
â”œâ”€â”€ dynamic     # DynamicClientå®¢æˆ·ç«¯, ç”¨äºè®¿é—®k8s Resourcesï¼Œä¹Ÿå¯ä»¥è®¿é—®CRDã€‚
â”œâ”€â”€ informers   # k8sä¸­å„ç§Resourcesçš„Informeræœºåˆ¶çš„å®ç°ã€‚
â”œâ”€â”€ kubernetes  # å¯¹RestClientè¿›è¡Œäº†å°è£…ï¼Œå®šä¹‰å¤šç§Clientçš„å®¢æˆ·ç«¯é›†åˆï¼Œä¿—ç§°clientsetã€‚
â”œâ”€â”€ listers     # æä¾›å¯¹Resourcesçš„è·å–åŠŸèƒ½ã€‚å¯¹äºGet()å’ŒList()è€Œè¨€ï¼Œlistersæä¾›ç»™äºŒè€…çš„æ•°æ®éƒ½æ˜¯ä»ç¼“å­˜ä¸­è¯»å–çš„ã€‚
â”œâ”€â”€ pkg
â”œâ”€â”€ plugin      # æä¾›ç¬¬ä¸‰æ–¹æ’ä»¶ã€‚
â”œâ”€â”€ scale       # å®šä¹‰ç”¨äºDeploy, RS, RCç­‰èµ„æºè¿›è¡Œçš„æ‰©ã€ç¼©å®¹çš„å®¢æˆ·ç«¯ScaleClientã€‚
â”œâ”€â”€ tools       # å®ç°clientæŸ¥è¯¢å’Œç¼“å­˜æœºåˆ¶ï¼Œä»¥åŠå®šä¹‰è¯¸å¦‚SharedInformerã€Reflectorã€DealtFIFOå’ŒIndexerç­‰å¸¸ç”¨å·¥å…·ã€‚
â”œâ”€â”€ transport
â””â”€â”€ util        # æä¾›è¯¸å¦‚WorkQueueã€Certificateç­‰å¸¸ç”¨æ–¹æ³•ã€‚
```

ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

+ `/discovery`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå‘ç°å’Œè·å–Kubernetes APIèµ„æºçš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Podã€Serviceã€ReplicationControllerç­‰ã€‚`discovery`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å‘ç°å’Œä½¿ç”¨è¿™äº›èµ„æºã€‚
+ `/dynamic`ï¼šè¯¥ç›®å½•åŒ…å«åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œç”¨äºä¸Kubernetes APIäº¤äº’ï¼Œè€Œæ— éœ€ç”Ÿæˆä»£ç ã€‚è¿™å¯¹äºæ„å»ºéœ€è¦ä¸ä»»æ„Kubernetesèµ„æºäº¤äº’çš„é€šç”¨å·¥å…·å’Œå®ç”¨ç¨‹åºéå¸¸æœ‰ç”¨ã€‚
+ `/kubernetes`ï¼šè¿™ä¸ªåŒ…ä¸­æ–¹çš„æ˜¯ç”¨ client-gen è‡ªåŠ¨ç”Ÿæˆçš„ç”¨æ¥è®¿é—® Kubernetes API çš„ ClientSetï¼Œåé¢ä¼šç»å¸¸çœ‹åˆ° ClientSet è¿™ä¸ªå·¥å…·ã€‚
+ `/informers`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºç›‘è§†Kubernetesèµ„æºå˜åŒ–çš„ä»£ç ã€‚è¿™äº›å˜åŒ–å¯ä»¥åŒ…æ‹¬èµ„æºçš„åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ã€‚`informers`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ„å»ºæ§åˆ¶å™¨å’Œå…¶ä»–éœ€è¦å¯¹Kubernetesç¯å¢ƒä¸­çš„å˜åŒ–åšå‡ºååº”çš„åº”ç”¨ç¨‹åºã€‚
+ `/listers`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä»KubernetesæœåŠ¡å™¨è·å–èµ„æºåˆ—è¡¨çš„ä»£ç ã€‚è¿™äº›èµ„æºåˆ—è¡¨åŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚`listers`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°è·å–æœ‰å…³Kubernetesèµ„æºçš„ä¿¡æ¯ã€‚
+ `/rest`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetes APIäº¤äº’çš„ä»£ç ã€‚è¿™äº›APIåŒ…æ‹¬Podã€Serviceã€Namespaceç­‰ã€‚`rest`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ‰§è¡Œå„ç§æ“ä½œï¼ŒåŒ…æ‹¬ç®¡ç†Podã€Deploymentã€Serviceã€Namespaceç­‰ã€‚
+ `/scale`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºä¸Kubernetesèµ„æºçš„è‡ªåŠ¨ç¼©æ”¾ç›¸å…³çš„ä»£ç ã€‚è¿™äº›èµ„æºåŒ…æ‹¬Deploymentã€ReplicaSetã€StatefulSetç­‰ã€‚`scale`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è‡ªåŠ¨ç¼©æ”¾ä¸Kubernetesèµ„æºç›¸å…³çš„ç»„ä»¶ã€‚
+ `transport`ï¼šè¿™ä¸ªåŒ…ç”¨äºè®¾ç½®è®¤è¯å’Œå»ºç«‹è¿æ¥
+ `/tools`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºæµ‹è¯•å’Œå…¶ä»–å®ç”¨ç¨‹åºçš„ä»£ç ã€‚è¿™äº›å®ç”¨ç¨‹åºåŒ…æ‹¬ä»£ç ç”Ÿæˆå™¨ã€æµ‹è¯•å·¥å…·ç­‰ã€‚`tools`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°æµ‹è¯•å’Œä½¿ç”¨client-goåº“ã€‚
+ `/util`ï¼šè¯¥ç›®å½•åŒ…å«ç”¨äºå®¢æˆ·ç«¯åº“çš„è¾…åŠ©åŠŸèƒ½çš„ä»£ç ã€‚è¿™äº›åŠŸèƒ½åŒ…æ‹¬å¯¹Kubernetes APIå¯¹è±¡çš„ç±»å‹è½¬æ¢ã€å¯¹è±¡æ¯”è¾ƒç­‰ã€‚`util`ç›®å½•ä¸­çš„ä»£ç å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´è½»æ¾åœ°ä½¿ç”¨client-goåº“ã€‚



### è·å– Client-go

å¯ä»¥é€šè¿‡ go get å‘½ä»¤è·å– client-goï¼Œä¸è¿‡æˆ‘ç›´æ¥å…‹éš†æœ€æ–°æºä»£ç ï¼Œç„¶åæ„å»ºä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š

```bash
git clone https://github.com/kubernetes/client-go.git
```

ä»–ä»¬ç»™äº†ä¸€äº›æ ·ä¾‹çš„æ–‡ä»¶ï¼Œæˆ‘æ‰¾å‡ºæ¥ï¼š

```bash
â¯ find -name main.go
./examples/workqueue/main.go
./examples/in-cluster-client-configuration/main.go
./examples/out-of-cluster-client-configuration/main.go
./examples/dynamic-create-update-delete-deployment/main.go
./examples/create-update-delete-deployment/main.go
./examples/leader-election/main.go
```

è¿™äº›æ–‡ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿä¸Šæ‰‹ client-goï¼š

+ `./examples/workqueue/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆWorkqueueï¼‰å®ç°èµ„æºæ§åˆ¶å™¨ï¼ˆControllerï¼‰ã€‚
+ `./examples/in-cluster-client-configuration/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å†…éƒ¨ä½¿ç”¨ `client-go` è®¿é—® Kubernetes API Serverã€‚
+ `./examples/out-of-cluster-client-configuration/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes é›†ç¾¤å¤–éƒ¨ä½¿ç”¨ `client-go` è®¿é—® Kubernetes API Serverã€‚
+ `./examples/dynamic-create-update-delete-deployment/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚
+ `./examples/create-update-delete-deployment/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ `client-go` å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚
+ `./examples/leader-election/main.go`ï¼šæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„ Leader Election æœºåˆ¶ï¼Œå®ç°èµ„æºæ§åˆ¶å™¨çš„é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»ã€‚



åœ¨ `/root/workspaces/client-go/examples/workqueue` ç›®å½•ä¸­ï¼š

æˆ‘ä»¬æ˜¯ä¸èƒ½ç›´æ¥ç¼–è¯‘çš„ï¼Œçœ‹ä¸€ä¸‹ï¼š

```bash
â¯ ./main --help
Usage of ./main:
  -kubeconfig string
        absolute path to the kubeconfig file
  -master string
        master url
```

æŒ‡å®š kubeconfig ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡  `export KUBECONFIG` ï¼‰

```bash
â¯ ./main -kubeconfig ~/.kube/config
```

> ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º myresource çš„è‡ªå®šä¹‰èµ„æºï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ `go run ./examples/workqueue/main.go` å‘½ä»¤å¯åŠ¨æ§åˆ¶å™¨ã€‚æ­¤æ—¶ï¼Œæ§åˆ¶å™¨ä¼šå¼€å§‹ç›‘å¬ myresource èµ„æºï¼Œå¹¶åœ¨è¯¥èµ„æºè¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼Œå¼‚æ­¥åœ°å¤„ç†ä¸€äº›ä»»åŠ¡ã€‚



**ç»§ç»­æ¼”ç¤º å¯¹ Deployment CURD æ“ä½œï¼š**

```bash
â¯ cd dynamic-create-update-delete-deployment/
â¯ ls
README.md  main.go
â¯ go build main.go
â¯ ./main 
Creating deployment...
Created deployment "demo-deployment".
-> Press Return key to continue.

Updating deployment...
Updated deployment...
-> Press Return key to continue.

Listing deployments in namespace "default":
 * demo-deployment (1 replicas)
 * my-nginx-app (3 replicas)
 * nginx-deployment (3 replicas)
-> Press Return key to continue.

Deleting deployment...
Deleted deployment.
```

`./examples/dynamic-create-update-delete-deployment/main.go`ï¼šè¿™ä¸ªç¤ºä¾‹æ–‡ä»¶æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Kubernetes çš„åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼ˆDynamic Clientï¼‰å®ç°å¯¹ Deployment èµ„æºå¯¹è±¡çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œã€‚ä½¿ç”¨åŠ¨æ€å®¢æˆ·ç«¯åº“ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ›´åŠ çµæ´»åœ°æ“ä½œ Kubernetes èµ„æºå¯¹è±¡ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨ç¼–å†™å¤æ‚çš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ Deployment èµ„æºå¯¹è±¡ã€‚

> ä¸¾ä¾‹ï¼šä½¿ç”¨ kubectl å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªåä¸º my-deployment çš„ Deployment å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° YAML æ–‡ä»¶ä¸­ã€‚ç„¶åï¼Œè¿è¡Œ `go run ./examples/dynamic-create-update-delete-deployment/main.go` å‘½ä»¤ï¼Œä½¿ç”¨ DynamicClient å¯¹è±¡ï¼ŒåŠ¨æ€åœ°åˆ›å»ºã€æ›´æ–°å’Œåˆ é™¤ my-deployment Deployment å¯¹è±¡ã€‚

æµ‹è¯•ï¼š

```bash
â¯ k get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
demo-deployment    0/1     0            0           4s
my-nginx-app       0/3     3            0           26h
nginx-deployment   3/3     3            3           165m
```





### WorkQueue æºç åˆ†æ

WorkQueue ä¸€èˆ¬ä½¿ç”¨çš„è¯´å°±æ˜¯å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°ï¼Œåœ¨ Resopurce Event Handlers ä¸­ä¼šå®Œæˆå°†å¯¹è±¡çš„ key æ”¾å…¥ WorkQueue çš„è¿‡ç¨‹ï¼Œç„¶åå†è‡ªå·±çš„é€»è¾‘ä»£ç ä¸­ä» WorkQueue ä¸­æ¶ˆè´¹è¿™äº› Keyã€‚

Client-go çš„ `utile/Workqueue` åŒ…ä¸­æœ‰ä¸‰ä¸ªé˜Ÿåˆ—ï¼š

åˆ†åˆ«å¯¹åº”çš„æ˜¯ æ™®é€šé˜Ÿåˆ—ã€å»¶æ—¶é˜Ÿåˆ—å’Œé™é€Ÿé˜Ÿåˆ—ã€‚å¯¹åº”çš„æºæ–‡ä»¶åˆ†åˆ«æ˜¯ï¼š

+ queue.go
+ delaying_queue.go
+ rate_limiting_queue.go



**æˆ‘ä»¬å…ˆçœ‹çœ‹ æ™®é€šé˜Ÿåˆ—ï¼Œè¿™ä¸ªå¯¹åº”çš„æ–‡ä»¶å°±æ˜¯ queue.goï¼š**

```go
type Interface interface {
	Add(item interface{})
	Len() int
	Get() (item interface{}, shutdown bool)
	Done(item interface{})
	ShutDown()
	ShutDownWithDrain()
	ShuttingDown() bool
}
```

çœ‹æ¥å£å°±çŸ¥é“äº†å®ç°äº†å“ªäº›æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯æ·»åŠ å…ƒç´ ï¼Œå…ƒç´ ä¸ªæ•°ã€è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ã€ç¬¬äºŒä¸ªè¿”å›å€¼å’Œ channel ç±»ä¼¼ï¼Œæ ‡è®°äº†é˜Ÿåˆ—æ˜¯å¦å…³é—­ã€‚

Done æ ‡è®°ä¸€ä¸ªå…ƒç´ æ˜¯å¦å·²ç»å¤„ç†å®Œï¼ŒShutDown å…³é—­é˜Ÿåˆ—ï¼ŒShowDownWithDrain å…³é—­é˜Ÿåˆ—ï¼Œä½†æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¤„ç†å®Œã€‚ShuttingDown æ ‡è®°å½“å‰çš„ channel æ˜¯å¦æ­£åœ¨å…³é—­ã€‚



**æˆ‘ä»¬å†çœ‹å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¯¹åº”çš„æ–‡ä»¶åœ¨delaying_queue.go**

```go
// DelayingInterface is an Interface that can Add an item at a later time. This makes it easier to
// requeue items after failures without ending up in a hot-loop.
type DelayingInterface interface {
	Interface
	// AddAfter adds an item to the workqueue after the indicated duration has passed
	AddAfter(item interface{}, duration time.Duration)
}
```

æ¥å£å°±å¾ˆç®€å•ï¼Œå®šä¹‰ DelayingInterface æ¥å£åœ¨ delaying_queue.go æºæ–‡ä»¶ï¼Œåå­—å’Œ Queue æ‰€ä½¿ç”¨çš„interfaceå¯¹ç§°ï¼Œå«åš DelayingInterfaceã€‚

è¿™é‡Œæœ‰ä¸€ä¸ª Interfaceï¼Œå¯¹æ­¤æˆ‘æ„Ÿè§‰åˆ°æœ‰ä¸€äº›ç–‘æƒ‘ï¼ŒInterface æ˜¯æ™®é€šé˜Ÿåˆ—å‘½åçš„æ¥å£ï¼Œè¿™ä¸ªè®¾è®¡æ¨¡å¼çš„æ¥å£è®¾è®¡çš„æ€è·¯è›®æœ‰æ„æ€çš„ï¼Œå…ˆåˆ«æ¿€åŠ¨ï¼Œåé¢æœ‰ä½ æ¿€åŠ¨çš„ï¼Œçœ‹åˆ° Controller çš„æ¥å£è®¾è®¡ï¼Œé‚£ç®€ç›´å°±æ˜¯ 6 ~



**æœ€åæˆ‘ä»¬çœ‹ä¸€ä¸‹é™é€Ÿé˜Ÿåˆ—ï¼Œè¿™ä¸ªæœ‰æ„æ€å¾ˆå¤šäº†ï¼ŒåŒæ ·ä»Šå¤©çš„é¡¹ç›® `sample-controller` ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ controller éƒ¨åˆ†ï¼š**

```go
type Controller struct {
    //...
	workqueue workqueue.RateLimitingInterface
} 
```

æˆ‘ä»¬çœ‹åˆ°äº† é™é€Ÿé˜Ÿåˆ—åŒ…å«äº†å»¶è¿Ÿé˜Ÿåˆ—çš„æ‰€æœ‰æ¥å£å®ç°ï¼Œä¹ŸåŒ…å«äº† åŸºæœ¬é˜Ÿåˆ—çš„æ‰€æœ‰æ¥å£å®ç°ã€‚

**åˆ†æè¿™ä¸ªé˜Ÿåˆ—çš„æ¥å£ï¼š**

+ AddRateLimitedï¼šåœ¨é€Ÿç‡é™åˆ¶å™¨è®¤å¯çš„æƒ…å†µä¸‹å°†é¡¹ç›®æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ã€‚
+ Forgetï¼šè¡¨ç¤ºé¡¹ç›®å·²ç»å®Œæˆé‡è¯•ã€‚æ— è®ºæ˜¯æ°¸ä¹…æ€§å¤±è´¥è¿˜æ˜¯æˆåŠŸï¼Œæˆ‘ä»¬éƒ½ä¼šåœæ­¢é€Ÿç‡é™åˆ¶å™¨å¯¹å…¶è¿›è¡Œè·Ÿè¸ªã€‚è¿™ä»…æ¸…é™¤äº†`rateLimiter`ï¼Œæ‚¨ä»ç„¶éœ€è¦åœ¨é˜Ÿåˆ—ä¸Šè°ƒç”¨`Done`æ–¹æ³•ã€‚
+ NumRequeuesï¼šè¿”å›é¡¹ç›®è¢«é‡æ–°æ’é˜Ÿçš„æ¬¡æ•°ã€‚

```go
// RateLimitingInterface is an interface that rate limits items being added to the queue.
type RateLimitingInterface interface {
	DelayingInterface

	// AddRateLimited adds an item to the workqueue after the rate limiter says it's ok
	AddRateLimited(item interface{})

	// Forget indicates that an item is finished being retried.  Doesn't matter whether it's for perm failing
	// or for success, we'll stop the rate limiter from tracking it.  This only clears the `rateLimiter`, you
	// still have to call `Done` on the queue.
	Forget(item interface{})

	// NumRequeues returns back how many times the item was requeued
	NumRequeues(item interface{}) int
}
```

åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å†æ·±å…¥æ¢ç´¢è¿™äº› WorkQueue çš„å®ç°ã€‚



### DeltaFIFO æºç åˆ†æ

DeltaFIFO ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„ç»„ä»¶ï¼Œåœ¨ `k8s.io/client-go/tools/cache` åŒ…ä¸­ï¼Œç”¨äºå­˜å‚¨å¯¹è±¡çš„å¢é‡æ›´æ–°ã€‚

+ å­˜å‚¨å¯¹è±¡çš„å¢é‡æ›´æ–°ï¼ŒåŒ…æ‹¬æ·»åŠ ã€åˆ é™¤å’Œæ›´æ–°æ“ä½œã€‚
+ èƒ½å¤ŸæŒ‰é¡ºåºå¤„ç†æ›´æ–°ï¼Œä»¥ç¡®ä¿å®ƒä»¬è¢«æ­£ç¡®åœ°åº”ç”¨ã€‚
+ æ”¯æŒé˜»å¡å¼åŒæ­¥ï¼Œä»¥ä¾¿åœ¨åº”ç”¨æ‰€æœ‰æ›´æ–°ä¹‹å‰ç­‰å¾…ã€‚

åœ¨ fifo.go ä¸­å®šä¹‰äº†ä¸€ä¸ª Queue çš„æ¥å£ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ¥å£ä»£ç ï¼š

```go
type Queue interface {
	Store
	Pop(PopProcessFunc) (interface{}, error)
	AddIfNotPresent(interface{}) error
	HasSynced() bool
	// Close the queue
	Close()
}
```

åµŒå…¥äº†ä¸€ä¸ª Store æ¥å£ï¼š

```go
Store interface {
	Add(obj interface{}) error
	Update(obj interface{}) error
	Delete(obj interface{}) error
	List() []interface{}
	ListKeys() []string
	Get(obj interface{}) (item interface{}, exists bool, err error)
	GetByKey(key string) (item interface{}, exists bool, err error)
	Replace([]interface{}, string) error
	Resync() error
}
```

éƒ½æ˜¯è¡¨é¢çš„æ„æ€äº†ï¼ŒCURD æ“ä½œï¼Œå„ç§ Getã€List æ“ä½œã€‚

**é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„ï¼Œé˜…è¯»æºç å³å¯ï¼Œåé¢æ…¢æ…¢æ·±å…¥è®²è§£ã€‚**



### Informer æœºåˆ¶

Informar è¿™ä¸ªå•è¯å‡ºé•œç‡å¾ˆé«˜ï¼Œæˆ‘ä»¬åœ¨å¾ˆå¤šæ–‡ç« ä¸­éƒ½å¯ä»¥çœ‹åˆ°è¿™ä¸ª Informerï¼ŒåŒ…æ‹¬ Kubernetes æºç è®²è§£çš„ ETCD å’Œ API Server ä¸­ã€‚

Informer ä» DeltaFIFO ä¸­ Pop ç›¸å¯¹åº”çš„å¯¹è±¡ï¼Œä¼šé€šè¿‡ Indexer å°†å¯¹è±¡å’Œç´¢å¼•éƒ½ä¸¢åœ¨æœ¬åœ°çš„ cache ä¸­ï¼Œå†è§¦å‘ç›¸åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼ˆResource Event Handlers) çš„è¿è¡Œã€‚

æºç ä½ç½®ï¼š `k8s.io/client-go/tools/cache`

Informar æ˜¯é€šè¿‡ä¸€ä¸ª Controller å¯¹è±¡æ¥è¿›è¡Œå®šä¹‰çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¯¹è±¡æ¥å£ï¼š

åœ¨ `controller.go` æ–‡ä»¶ä¸­èƒ½çœ‹åˆ° Controller çš„å®šä¹‰ï¼š

```go
type Controller interface {
	Run(stopCh <-chan struct{})
	HasSynced() bool
	LastSyncResourceVersion() string
}
```

çœ‹å‡ºï¼Œæœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯ `Run(stopCh <-chan struct{})` Run è¿™ä¸ªå‡½æ•°æˆ‘ä»¬ç‚¹å‡»è¿›å»ä¼šå‘ç°ï¼Œä¸»è¦åšäº†ä¸¤ä¸ªäº‹æƒ…ï¼š

+ æ„é€  Reflector åˆ©ç”¨ ListerWatcher çš„èƒ½åŠ›å°†å¯¹è±¡äº‹ä»¶æ›´æ–°åˆ° DeltaFIFO
+ ä» DeltaFIFO ä¸­ Pop å¯¹è±¡åè°ƒç”¨ ProcessFunc æ¥å¤„ç†ã€‚

åˆå§‹åŒ–æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

```go
// New makes a new Controller from the given Config.
func New(c *Config) Controller {
	ctlr := &controller{
		config: *c,
		clock:  &clock.RealClock{},
	}
	return ctlr
}
```

ä¼ å…¥äº†ä¸€ä¸ª Config è¿‡æ¥ï¼Œç„¶ååˆå§‹åŒ–ï¼Œæ ¸å¿ƒé€»è¾‘é‚£å°±åœ¨ Config ä¸­äº†ï¼š

```go
// Config contains all the settings for one of these low-level controllers.
type Config struct {
	Queue
	// Something that can list and watch your objects.
	ListerWatcher
	// Something that can process a popped Deltas.
	Process ProcessFunc
	// ObjectType is an example object of the type this controller is
	// expected to handle.
	ObjectType runtime.Object
	// ObjectDescription is the description to use when logging type-specific information about this controller.
	ObjectDescription string
	// FullResyncPeriod is the period at which ShouldResync is considered.
	FullResyncPeriod time.Duration
	ShouldResync ShouldResyncFunc
	RetryOnError bool
	// Called whenever the ListAndWatch drops the connection with an error.
	WatchErrorHandler WatchErrorHandler
	// WatchListPageSize is the requested chunk size of initial and relist watch lists.
	WatchListPageSize int64
}
```



### SharedInformer å¯¹è±¡æºç 

SharedInformer å’Œ Informer ä¹‹é—´çš„åå­—å°±å·®ä¸€ä¸ª Sharedï¼Œåœ¨ Operator å¼€å‘ä¸­ï¼Œå¦‚æœä¸é€‚ç”¨ controller-runtime åº“ï¼ˆkubebuilder controller-runtime å­é¡¹ç›®çš„Repoï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸ç”¨ Kubebuilder ç­‰å·¥å…·ç”Ÿæˆè„šæ‰‹æ¶ï¼Œé‚£ä¹ˆåº”è¯¥ç”¨åˆ°çš„æ˜¯ SharedInformerFactoryï¼Œæ¯”å¦‚ä»Šå¤©ä¸»è¦åšçš„ sample-controller çš„ `main()`  å‡½æ•°ï¼Œåœ¨ä¸‹é¢çš„ sample-controller æºç ä»‹ç»ä¸­ä¼šè®²è§£~

æˆ‘ä»¬èƒ½çœ‹åˆ°è¿™ä¸¤è¡Œä»£ç ï¼š

```go
kubeInformerFactory := kubeinformers.NewSharedInformerFactory(kubeClient, time.Second*30)
	
exampleInformerFactory := informers.NewSharedInformerFactory(exampleClient, time.Second*30)

controller := NewController(ctx, kubeClient, exampleClient,
	kubeInformerFactory.Apps().V1().Deployments(), exampleInformerFactory.Samplecontroller().V1alpha1().Foos())
```

æ§åˆ¶å™¨çš„åˆå§‹åŒ–åé¢ä¼šè®² `controller.go` çš„æ—¶å€™é‡ç‚¹è®²è§£ï¼Œå…ˆçœ‹çœ‹åˆå§‹åŒ–è¿‡ç¨‹å’Œ SharedInformer çš„å…³ç³»ã€‚

controller ä¾èµ–äº `kubeInformerFactory.Apps().V1().Deployments()` å’Œ `exampleInformerFactory.Samplecontroller().V1alpha1().Foos()`

åè€…æ˜¯ ` sample-controller ` è‡ªå·± pkg åŒ…æä¾›çš„ï¼Œå‰è€…æ˜¯ client-go æä¾›çš„ï¼Œé‚£ä¹ˆçœ‹çœ‹å‰è€…ï¼š 

è¿™é‡Œçš„ Deployment ä¾èµ–çš„æ˜¯ï¼š`Deployments() DeploymentInformer`

è€Œ `DeploymentInformer` æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œçœ‹ä¸€çœ‹ï¼š

```go
// DeploymentInformer provides access to a shared informer and lister for
// Deployments.
type DeploymentInformer interface {
	Informer() cache.SharedIndexInformer
	Lister() v1.DeploymentLister
}
```

å®ç°äº† `Informer`  å’Œ `Lister`ï¼Œ`Informer` æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª `ShareIndexInformer`

---

**æ¥ä¸‹æ¥çš„ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç» sample-controllerã€kubebuilderã€operator-sdk ä»¥åŠå®ƒä»¬ä¹‹é—´é‚£å¾®å¦™çš„å…³ç³»ã€‚**



## END é“¾æ¥
<ul><li><div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

