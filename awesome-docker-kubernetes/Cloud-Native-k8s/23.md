+ [author](http://nsddd.top)

# ç¬¬23èŠ‚ Kubeconfig && token

<div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

[[toc]]

## å‰è¨€

::: tip 
åœ¨å‰é¢å®‰è£…k3s & k8s ä¸­ï¼Œæˆ‘ä»¬è®¤è¯†äº† kubeconfigï¼Œä½†æ˜¯æˆ‘ä»¬ä¾æ—§å¯¹è¿™ä¸ªä¸œè¥¿å¾ˆé™Œç”Ÿ

æˆ–è®¸ï¼Œæˆ‘ä»¬å¿…é¡»ç†Ÿæ‚‰ä»–æ‰å¯ä»¥åšæ›´å¤šæœ‰æ„ä¹‰çš„work

åœ¨å¼€å¯äº† TLS çš„é›†ç¾¤ä¸­ï¼Œæ¯å½“ä¸é›†ç¾¤äº¤äº’çš„æ—¶å€™å°‘ä¸äº†çš„æ˜¯[èº«ä»½è®¤è¯](https://cloud.tencent.com/solution/tb-digitalid?from=10680)ï¼Œä½¿ç”¨ kubeconfigï¼ˆå³è¯ä¹¦ï¼‰ å’Œ token ä¸¤ç§è®¤è¯æ–¹å¼æ˜¯æœ€ç®€å•ä¹Ÿæœ€é€šç”¨çš„è®¤è¯æ–¹å¼ã€‚

:::



::: details é’ˆå¯¹ä¸€æ¬¡ Kubeconfig é—®é¢˜çš„è®°å½•

+ [å…³äºè¿™æ¬¡é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ](https://headworq.org/en/how-to-connect-to-kubernetes/#)

```bash
èµµä¸½é¢–
 ä»Šå¤© ä¸­åˆ 12:18
Ladies and gentlemen, after the agent node deployment, my k3s prompts such an error. What is the cause




23 æ¡å›å¤
æ–°å¢åŠŸèƒ½


icsy7867
  26 åˆ†é’Ÿå‰
It shouldn't be talking to port 8080.  But 6443.  This usually means kubectl doesn't have access to the yaml conf.
åŒæ—¶å‘é€è‡³é¢‘é“


èµµä¸½é¢–
  25 åˆ†é’Ÿå‰
Sorry, I don't quite understand the k3s configuration, which files should I modify?


icsy7867
  25 åˆ†é’Ÿå‰
Did you move the config to the location you specified?


icsy7867
  25 åˆ†é’Ÿå‰
And check the permissions
ä»…å¯¹ä½ å¯è§


Slackbot
  24 åˆ†é’Ÿå‰
/etc/rancher/k3s/config.yamléæœ‰æ•ˆå‘½ä»¤ã€‚åœ¨ Slack ä¸­ï¼Œæ‰€æœ‰ä»¥ "/" å­—ç¬¦å¼€å§‹çš„æ¶ˆæ¯éƒ½è¢«è§£æä¸ºå‘½ä»¤ã€‚
å¦‚æœä½ å°è¯•å‘é€æ¶ˆæ¯è€Œä¸æ˜¯è¿è¡Œå‘½ä»¤ï¼Œè¯·å°è¯•åœ¨ "/" å‰åŠ ç©ºæ ¼ã€‚


èµµä¸½é¢–
  24 åˆ†é’Ÿå‰
/etc/rancher/k3s/config.yaml 


èµµä¸½é¢–
  24 åˆ†é’Ÿå‰
This is the position?


icsy7867
  20 åˆ†é’Ÿå‰
Or k3s.yaml.  not next to a computer


icsy7867
  19 åˆ†é’Ÿå‰
Or is it in that directory you specified?  If so try to export that path so kubectl knows where to look


èµµä¸½é¢–
  19 åˆ†é’Ÿå‰
image.png
 
image.png




èµµä¸½é¢–
  18 åˆ†é’Ÿå‰
I didn't use 'K3S_CONFIG_FILE' to specify it


èµµä¸½é¢–
  18 åˆ†é’Ÿå‰
Where should it go?


èµµä¸½é¢–
  16 åˆ†é’Ÿå‰
Even though I specify its location, it seems to be blank
image.png
 
image.png


icsy7867
  16 åˆ†é’Ÿå‰
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml


icsy7867
  16 åˆ†é’Ÿå‰
Try running this


icsy7867
  14 åˆ†é’Ÿå‰
And then kubectl get nodes


èµµä¸½é¢–
  13 åˆ†é’Ÿå‰
Thank you very much for your answer. Are you the maintainer of the k3s community


icsy7867
  11 åˆ†é’Ÿå‰
Nope.  Just someone who has stumbled around playing with k3s and happened to see your message :å¾®ç¬‘:


èµµä¸½é¢–
  9 åˆ†é’Ÿå‰
Nice to meet you. What you met is a junior undergraduate student from China. There is an assignment about k3s


icsy7867
  5 åˆ†é’Ÿå‰
Neat!


icsy7867
  5 åˆ†é’Ÿå‰
Nice to meet you


icsy7867
  5 åˆ†é’Ÿå‰
And here's a good link
https://headworq.org/en/how-to-connect-to-kubernetes/
headworqheadworq
3 ways to connect to your K3s Kubernetes Cluster
In this article I'll show you three Kubernetes Clients â€“ Kubectl, Lens and Kubenav.
2021 å¹´ 1 æœˆ 18 æ—¥ (557 kB)
https://headworq.org/en/how-to-connect-to-kubernetes/



icsy7867
  4 åˆ†é’Ÿå‰
The problem was kubectl was looking for a config file, couldn't find one and tried a basic setup.


èµµä¸½é¢–
  < 1 åˆ†é’Ÿå‰
yep, great article, thanks so much for your help
```

:::



##  å‘½ä»¤å‚æ•°

```bash
kubectl config SUBCOMMAND

é€‰é¡¹
      --kubeconfig="": ä½¿ç”¨ç‰¹å®šçš„é…ç½®æ–‡ä»¶ã€‚

ç»§æ‰¿è‡ªçˆ¶å‘½ä»¤çš„é€‰é¡¹
      --alsologtostderr[=false]: åŒæ—¶è¾“å‡ºæ—¥å¿—åˆ°æ ‡å‡†é”™è¯¯æ§åˆ¶å°å’Œæ–‡ä»¶ã€‚
      --api-version="": å’ŒæœåŠ¡ç«¯äº¤äº’ä½¿ç”¨çš„APIç‰ˆæœ¬ã€‚
      --certificate-authority="": ç”¨ä»¥è¿›è¡Œè®¤è¯æˆæƒçš„.certæ–‡ä»¶è·¯å¾„ã€‚
      --client-certificate="": TLSä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„ã€‚
      --client-key="": TLSä½¿ç”¨çš„å®¢æˆ·ç«¯å¯†é’¥è·¯å¾„ã€‚
      --cluster="": æŒ‡å®šä½¿ç”¨çš„kubeconfigé…ç½®æ–‡ä»¶ä¸­çš„é›†ç¾¤åã€‚
      --context="": æŒ‡å®šä½¿ç”¨çš„kubeconfigé…ç½®æ–‡ä»¶ä¸­çš„ç¯å¢ƒåã€‚
      --insecure-skip-tls-verify[=false]: å¦‚æœä¸ºtrueï¼Œå°†ä¸ä¼šæ£€æŸ¥æœåŠ¡å™¨å‡­è¯çš„æœ‰æ•ˆæ€§ï¼Œè¿™ä¼šå¯¼è‡´ä½ çš„HTTPSé“¾æ¥å˜å¾—ä¸å®‰å…¨ã€‚
      --kubeconfig="": å‘½ä»¤è¡Œè¯·æ±‚ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚
      --log-backtrace-at=:0: å½“æ—¥å¿—é•¿åº¦è¶…è¿‡å®šä¹‰çš„è¡Œæ•°æ—¶ï¼Œå¿½ç•¥å †æ ˆä¿¡æ¯ã€‚
      --log-dir="": å¦‚æœä¸ä¸ºç©ºï¼Œå°†æ—¥å¿—æ–‡ä»¶å†™å…¥æ­¤ç›®å½•ã€‚
      --log-flush-frequency=5s: åˆ·æ–°æ—¥å¿—çš„æœ€å¤§æ—¶é—´é—´éš”ã€‚
      --logtostderr[=true]: è¾“å‡ºæ—¥å¿—åˆ°æ ‡å‡†é”™è¯¯æ§åˆ¶å°ï¼Œä¸è¾“å‡ºåˆ°æ–‡ä»¶ã€‚
      --match-server-version[=false]: è¦æ±‚æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬åŒ¹é…ã€‚
      --namespace="": å¦‚æœä¸ä¸ºç©ºï¼Œå‘½ä»¤å°†ä½¿ç”¨æ­¤namespaceã€‚
      --password="": API Serverè¿›è¡Œç®€å•è®¤è¯ä½¿ç”¨çš„å¯†ç ã€‚
  -s, --server="": Kubernetes API Serverçš„åœ°å€å’Œç«¯å£å·ã€‚
      --stderrthreshold=2: é«˜äºæ­¤çº§åˆ«çš„æ—¥å¿—å°†è¢«è¾“å‡ºåˆ°é”™è¯¯æ§åˆ¶å°ã€‚
      --token="": è®¤è¯åˆ°API Serverä½¿ç”¨çš„ä»¤ç‰Œã€‚
      --user="": æŒ‡å®šä½¿ç”¨çš„kubeconfigé…ç½®æ–‡ä»¶ä¸­çš„ç”¨æˆ·åã€‚
      --username="": API Serverè¿›è¡Œç®€å•è®¤è¯ä½¿ç”¨çš„ç”¨æˆ·åã€‚
      --v=0: æŒ‡å®šè¾“å‡ºæ—¥å¿—çš„çº§åˆ«ã€‚
      --vmodule=: æŒ‡å®šè¾“å‡ºæ—¥å¿—çš„æ¨¡å—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼špattern=Nï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚
```



## ä½¿ç”¨ kubeconfig æ–‡ä»¶ç»„ç»‡é›†ç¾¤è®¿é—®

ä½¿ç”¨ kubeconfig æ–‡ä»¶æ¥ç»„ç»‡æœ‰å…³é›†ç¾¤ã€ç”¨æˆ·ã€å‘½åç©ºé—´å’Œèº«ä»½éªŒè¯æœºåˆ¶çš„ä¿¡æ¯ã€‚`kubectl`å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨ kubeconfig æ–‡ä»¶æ¥æŸ¥æ‰¾é€‰æ‹©é›†ç¾¤å’Œä¸é›†ç¾¤çš„ API æœåŠ¡å™¨é€šä¿¡æ‰€éœ€çš„ä¿¡æ¯ã€‚

::: danger 
**æ³¨æ„ï¼š**ç”¨äºé…ç½®å¯¹é›†ç¾¤çš„è®¿é—®çš„æ–‡ä»¶ç§°ä¸º*kubeconfig æ–‡ä»¶*ã€‚è¿™æ˜¯å¼•ç”¨é…ç½®æ–‡ä»¶çš„é€šç”¨æ–¹å¼ã€‚è¿™å¹¶ä¸æ„å‘³ç€æœ‰ä¸€ä¸ªåä¸º`kubeconfig`.

**è­¦å‘Šï¼š**ä»…ä½¿ç”¨æ¥è‡ªå¯ä¿¡æ¥æºçš„ kubeconfig æ–‡ä»¶ã€‚ä½¿ç”¨ç‰¹åˆ¶çš„ kubeconfig æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´æ¶æ„ä»£ç æ‰§è¡Œæˆ–æ–‡ä»¶æš´éœ²ã€‚å¦‚æœæ‚¨å¿…é¡»ä½¿ç”¨ä¸å—ä¿¡ä»»çš„ kubeconfig æ–‡ä»¶ï¼Œè¯·å…ˆä»”ç»†æ£€æŸ¥å®ƒï¼Œå°±åƒæ£€æŸ¥ shell è„šæœ¬ä¸€æ ·ã€‚
:::

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`kubectl`æŸ¥æ‰¾ç›®å½•ä¸­å‘½å`config`çš„`$HOME/.kube`æ–‡ä»¶ã€‚`KUBECONFIG`æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æˆ–è®¾ç½® [`--kubeconfig`](https://kubernetes.io/docs/reference/generated/kubectl/kubectl/)æ ‡å¿—æ¥æŒ‡å®šå…¶ä»– kubeconfig æ–‡ä»¶ã€‚



## æ”¯æŒå¤šé›†ç¾¤ã€å¤šç”¨æˆ·ã€å¤šè®¤è¯æœºåˆ¶[ ](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/#supporting-multiple-clusters-users-and-authentication-mechanisms)

å‡è®¾æ‚¨æœ‰å¤šä¸ªé›†ç¾¤ï¼Œå¹¶ä¸”æ‚¨çš„ç”¨æˆ·å’Œç»„ä»¶ä»¥å¤šç§æ–¹å¼è¿›è¡Œèº«ä»½éªŒè¯ã€‚ä¾‹å¦‚ï¼š

+ æ­£åœ¨è¿è¡Œçš„ kubelet å¯èƒ½ä¼šä½¿ç”¨è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ã€‚
+ ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä»¤ç‰Œè¿›è¡Œèº«ä»½éªŒè¯ã€‚
+ ç®¡ç†å‘˜å¯èƒ½æ‹¥æœ‰ä»–ä»¬æä¾›ç»™å„ä¸ªç”¨æˆ·çš„è¯ä¹¦é›†ã€‚

ä½¿ç”¨ kubeconfig æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥ç»„ç»‡é›†ç¾¤ã€ç”¨æˆ·å’Œå‘½åç©ºé—´ã€‚æ‚¨è¿˜å¯ä»¥å®šä¹‰ä¸Šä¸‹æ–‡ä»¥åœ¨é›†ç¾¤å’Œåç§°ç©ºé—´ä¹‹é—´å¿«é€Ÿè½»æ¾åœ°åˆ‡æ¢ã€‚

> `kubectl config use-context` å‘½ä»¤å¿«é€Ÿåœ°åœ¨é›†ç¾¤ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚



## ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰

é€šè¿‡ kubeconfig æ–‡ä»¶ä¸­çš„ *context* å…ƒç´ ï¼Œä½¿ç”¨ç®€ä¾¿çš„åç§°æ¥å¯¹è®¿é—®å‚æ•°è¿›è¡Œåˆ†ç»„ã€‚ æ¯ä¸ª context éƒ½æœ‰ä¸‰ä¸ªå‚æ•°ï¼šclusterã€namespace å’Œ userã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œ`kubectl` å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨ **å½“å‰ä¸Šä¸‹æ–‡** ä¸­çš„å‚æ•°ä¸é›†ç¾¤è¿›è¡Œé€šä¿¡ã€‚

```bash
kubectl config use-context
```



## KUBECONFIG ç¯å¢ƒå˜é‡ 

`KUBECONFIG` ç¯å¢ƒå˜é‡åŒ…å«ä¸€ä¸ª kubeconfig æ–‡ä»¶åˆ—è¡¨ã€‚ å¯¹äº Linux å’Œ Macï¼Œåˆ—è¡¨ä»¥å†’å·åˆ†éš”ã€‚å¯¹äº Windowsï¼Œåˆ—è¡¨ä»¥åˆ†å·åˆ†éš”ã€‚ `KUBECONFIG` ç¯å¢ƒå˜é‡ä¸æ˜¯å¿…è¦çš„ã€‚ å¦‚æœ `KUBECONFIG` ç¯å¢ƒå˜é‡ä¸å­˜åœ¨ï¼Œ`kubectl` ä½¿ç”¨é»˜è®¤çš„ kubeconfig æ–‡ä»¶ï¼Œ`$HOME/.kube/config`ã€‚

å¦‚æœ `KUBECONFIG` ç¯å¢ƒå˜é‡å­˜åœ¨ï¼Œ`kubectl` ä½¿ç”¨ `KUBECONFIG` ç¯å¢ƒå˜é‡ä¸­åˆ—ä¸¾çš„æ–‡ä»¶åˆå¹¶åçš„æœ‰æ•ˆé…ç½®ã€‚



## åˆå¹¶ kubeconfig æ–‡ä»¶

è¦æŸ¥çœ‹é…ç½®ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š

```yaml
[root@iZbp1evo5cnwagauz3w188Z ~]# kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://apiserver.cluster.local:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
```

å¦‚å‰æ‰€è¿°ï¼Œè¾“å‡ºå¯èƒ½æ¥è‡ª kubeconfig æ–‡ä»¶ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆå¹¶å¤šä¸ª kubeconfig æ–‡ä»¶çš„ç»“æœã€‚

**ä»¥ä¸‹æ˜¯ `kubectl` åœ¨åˆå¹¶ kubeconfig æ–‡ä»¶æ—¶ä½¿ç”¨çš„è§„åˆ™ã€‚**



å¦‚æœè®¾ç½®äº† `--kubeconfig` å‚æ•°ï¼Œåˆ™ä»…ä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶ã€‚ä¸è¿›è¡Œåˆå¹¶ã€‚æ­¤å‚æ•°åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚

å¦åˆ™ï¼Œå¦‚æœè®¾ç½®äº† `KUBECONFIG` ç¯å¢ƒå˜é‡ï¼Œå°†å®ƒç”¨ä½œåº”åˆå¹¶çš„æ–‡ä»¶åˆ—è¡¨ã€‚æ ¹æ®ä»¥ä¸‹è§„åˆ™åˆå¹¶ `KUBECONFIG` ç¯å¢ƒå˜é‡ä¸­åˆ—å‡ºçš„æ–‡ä»¶ï¼š

+ å¿½ç•¥ç©ºæ–‡ä»¶åã€‚
+ å¯¹äºå†…å®¹æ— æ³•ååºåˆ—åŒ–çš„æ–‡ä»¶ï¼Œäº§ç”Ÿé”™è¯¯ä¿¡æ¯ã€‚
+ ç¬¬ä¸€ä¸ªè®¾ç½®ç‰¹å®šå€¼æˆ–è€…æ˜ å°„é”®çš„æ–‡ä»¶å°†ç”Ÿæ•ˆã€‚
+ æ°¸è¿œä¸ä¼šæ›´æ”¹å€¼æˆ–è€…æ˜ å°„é”®ã€‚ç¤ºä¾‹ï¼šä¿ç•™ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ä¸Šä¸‹æ–‡ä»¥è®¾ç½® `current-context`ã€‚ç¤ºä¾‹ï¼šå¦‚æœä¸¤ä¸ªæ–‡ä»¶éƒ½æŒ‡å®šäº† `red-user`ï¼Œåˆ™ä»…ä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ `red-user` ä¸­çš„å€¼ã€‚å³ä½¿ç¬¬äºŒä¸ªæ–‡ä»¶åœ¨ `red-user` ä¸‹æœ‰éå†²çªæ¡ç›®ï¼Œä¹Ÿè¦ä¸¢å¼ƒå®ƒä»¬ã€‚

æœ‰å…³è®¾ç½® `KUBECONFIG` ç¯å¢ƒå˜é‡çš„ç¤ºä¾‹ï¼Œè¯·å‚é˜… [è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡](https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/configure-access-multiple-clusters/#set-the-kubeconfig-environment-variable)ã€‚

å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ kubeconfig æ–‡ä»¶ï¼Œ `$HOME/.kube/config`ï¼Œä¸è¿›è¡Œåˆå¹¶ã€‚



**æ ¹æ®æ­¤é“¾ä¸­çš„ç¬¬ä¸€ä¸ªåŒ¹é…ç¡®å®šè¦ä½¿ç”¨çš„ä¸Šä¸‹æ–‡:**

1. å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨ `--context` å‘½ä»¤è¡Œå‚æ•°ã€‚
2. ä½¿ç”¨åˆå¹¶çš„ kubeconfig æ–‡ä»¶ä¸­çš„ `current-context`ã€‚



**è¿™ç§åœºæ™¯ä¸‹å…è®¸ç©ºä¸Šä¸‹æ–‡:**

ç¡®å®šé›†ç¾¤å’Œç”¨æˆ·ã€‚æ­¤æ—¶ï¼Œå¯èƒ½æœ‰ä¹Ÿå¯èƒ½æ²¡æœ‰ä¸Šä¸‹æ–‡ã€‚æ ¹æ®æ­¤é“¾ä¸­çš„ç¬¬ä¸€ä¸ªåŒ¹é…ç¡®å®šé›†ç¾¤å’Œç”¨æˆ·ï¼Œè¿™å°†è¿è¡Œä¸¤æ¬¡ï¼šä¸€æ¬¡ç”¨äºç”¨æˆ·ï¼Œä¸€æ¬¡ç”¨äºé›†ç¾¤ã€‚

1. å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ï¼š`--user` æˆ–è€… `--cluster`ã€‚
2. å¦‚æœä¸Šä¸‹æ–‡éç©ºï¼Œä»ä¸Šä¸‹æ–‡ä¸­è·å–ç”¨æˆ·æˆ–é›†ç¾¤ã€‚



**è¿™ç§åœºæ™¯ä¸‹ç”¨æˆ·å’Œé›†ç¾¤å¯ä»¥ä¸ºç©º:**

ç¡®å®šè¦ä½¿ç”¨çš„å®é™…é›†ç¾¤ä¿¡æ¯ã€‚æ­¤æ—¶ï¼Œå¯èƒ½æœ‰ä¹Ÿå¯èƒ½æ²¡æœ‰é›†ç¾¤ä¿¡æ¯ã€‚åŸºäºæ­¤é“¾æ„å»ºæ¯ä¸ªé›†ç¾¤ä¿¡æ¯ï¼›ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ä¼šè¢«é‡‡ç”¨ï¼š

1. å¦‚æœå­˜åœ¨ï¼š`--server`ã€`--certificate-authority` å’Œ `--insecure-skip-tls-verify`ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ã€‚
2. å¦‚æœåˆå¹¶çš„ kubeconfig æ–‡ä»¶ä¸­å­˜åœ¨é›†ç¾¤ä¿¡æ¯å±æ€§ï¼Œåˆ™ä½¿ç”¨å®ƒä»¬ã€‚
3. å¦‚æœæ²¡æœ‰ server é…ç½®ï¼Œåˆ™é…ç½®æ— æ•ˆã€‚

ç¡®å®šè¦ä½¿ç”¨çš„å®é™…ç”¨æˆ·ä¿¡æ¯ã€‚ä½¿ç”¨ä¸é›†ç¾¤ä¿¡æ¯ç›¸åŒçš„è§„åˆ™æ„å»ºç”¨æˆ·ä¿¡æ¯ï¼Œä½†æ¯ä¸ªç”¨æˆ·åªå…è®¸ä¸€ç§èº«ä»½è®¤è¯æŠ€æœ¯ï¼š

1. å¦‚æœå­˜åœ¨ï¼š`--client-certificate`ã€`--client-key`ã€`--username`ã€`--password` å’Œ `--token`ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ã€‚
2. ä½¿ç”¨åˆå¹¶çš„ kubeconfig æ–‡ä»¶ä¸­çš„ `user` å­—æ®µã€‚
3. å¦‚æœå­˜åœ¨ä¸¤ç§å†²çªæŠ€æœ¯ï¼Œåˆ™é…ç½®æ— æ•ˆã€‚
4. å¯¹äºä»ç„¶ç¼ºå¤±çš„ä»»ä½•ä¿¡æ¯ï¼Œä½¿ç”¨å…¶å¯¹åº”çš„é»˜è®¤å€¼ï¼Œå¹¶å¯èƒ½æç¤ºè¾“å…¥èº«ä»½è®¤è¯ä¿¡æ¯ã€‚





## æ–‡ä»¶å¼•ç”¨

kubeconfig æ–‡ä»¶ä¸­çš„æ–‡ä»¶å’Œè·¯å¾„å¼•ç”¨æ˜¯ç›¸å¯¹äº kubeconfig æ–‡ä»¶çš„ä½ç½®ã€‚ å‘½ä»¤è¡Œä¸Šçš„æ–‡ä»¶å¼•ç”¨æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„ã€‚ åœ¨ `$HOME/.kube/config` ä¸­ï¼Œç›¸å¯¹è·¯å¾„æŒ‰ç›¸å¯¹è·¯å¾„å­˜å‚¨ï¼Œç»å¯¹è·¯å¾„æŒ‰ç»å¯¹è·¯å¾„å­˜å‚¨ã€‚



## kubeconfig ä¸¤ç§å®ç°æ–¹å¼

1. åˆ›å»º Kubeconfig æ–‡ä»¶
   1. ç”³è¯·è¯ä¹¦
   2. åˆ›å»º kuberconfig æ–‡ä»¶
   3. éªŒè¯ kuberconfig æ–‡ä»¶
2. æ‰‹åŠ¨å¤åˆ¶è¯ä¹¦
   1. é›†ç¾¤ç¯å¢ƒ
   2. é…ç½®æ–¹æ³•



## ä»£ç†

ä½ å¯ä»¥åœ¨ `kubeconfig` æ–‡ä»¶ä¸­ï¼Œä¸ºæ¯ä¸ªé›†ç¾¤é…ç½® `proxy-url` æ¥è®© `kubectl` ä½¿ç”¨ä»£ç†ï¼Œä¾‹å¦‚ï¼š

```bash
apiVersion: v1
kind: Config

clusters:
- cluster:
    proxy-url: http://proxy.example.org:3128
    server: https://k8s.example.org/k8s/clusters/c-xxyyzz
  name: development

users:
- name: developer

contexts:
- context:
  name: development
```



## å®šä¹‰é›†ç¾¤ï¼Œç”¨æˆ·å’Œ context

å‡è®¾ç”¨æˆ·æœ‰ä¸¤ä¸ªé›†ç¾¤ï¼Œä¸€ä¸ªç”¨äºæ­£å¼å¼€å‘å·¥ä½œï¼Œä¸€ä¸ªç”¨äºå…¶å®ƒä¸´æ—¶ç”¨é€”ï¼ˆscratchï¼‰ã€‚ åœ¨ `development` é›†ç¾¤ä¸­ï¼Œå‰ç«¯å¼€å‘è€…åœ¨åä¸º `frontend` çš„åå­—ç©ºé—´ä¸‹å·¥ä½œï¼Œ å­˜å‚¨å¼€å‘è€…åœ¨åä¸º `storage` çš„åå­—ç©ºé—´ä¸‹å·¥ä½œã€‚åœ¨ `scratch` é›†ç¾¤ä¸­ï¼Œ å¼€å‘äººå‘˜å¯èƒ½åœ¨é»˜è®¤åå­—ç©ºé—´ä¸‹å·¥ä½œï¼Œä¹Ÿå¯èƒ½è§†æƒ…å†µåˆ›å»ºé™„åŠ çš„åå­—ç©ºé—´ã€‚ è®¿é—®å¼€å‘é›†ç¾¤éœ€è¦é€šè¿‡è¯ä¹¦è¿›è¡Œè®¤è¯ã€‚ è®¿é—®å…¶å®ƒä¸´æ—¶ç”¨é€”çš„é›†ç¾¤éœ€è¦é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ã€‚

åˆ›å»ºåä¸º `config-exercise` çš„ç›®å½•ã€‚åœ¨ `config-exercise` ç›®å½•ä¸­ï¼Œåˆ›å»ºåä¸º `config-demo` çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹ä¸ºï¼š

```yml
apiVersion: v1
kind: Config
preferences: {}

clusters:
- cluster:
  name: development
- cluster:
  name: scratch

users:
- name: developer
- name: experimenter

contexts:
- context:
  name: dev-frontend
- context:
  name: dev-storage
- context:
  name: exp-scratch
```

é…ç½®æ–‡ä»¶æè¿°äº†é›†ç¾¤ã€ç”¨æˆ·åå’Œä¸Šä¸‹æ–‡ã€‚`config-demo` æ–‡ä»¶ä¸­å«æœ‰æè¿°ä¸¤ä¸ªé›†ç¾¤ã€ ä¸¤ä¸ªç”¨æˆ·å’Œä¸‰ä¸ªä¸Šä¸‹æ–‡çš„æ¡†æ¶ã€‚

è¿›å…¥ `config-exercise` ç›®å½•ã€‚è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå°†é›†ç¾¤è¯¦ç»†ä¿¡æ¯æ·»åŠ åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š

```bash
kubectl config --kubeconfig=config-demo set-cluster development --server=https://1.2.3.4 --certificate-authority=fake-ca-file
kubectl config --kubeconfig=config-demo set-cluster scratch --server=https://5.6.7.8 --insecure-skip-tls-verify
```

::: warning **æ³¨æ„ï¼š**
å°†å¯†ç ä¿å­˜åˆ° Kubernetes å®¢æˆ·ç«¯é…ç½®ä¸­æœ‰é£é™©ã€‚ ä¸€ä¸ªè¾ƒå¥½çš„æ›¿ä»£æ–¹å¼æ˜¯ä½¿ç”¨å‡­æ®æ’ä»¶å¹¶å•ç‹¬ä¿å­˜è¿™äº›å‡­æ®ã€‚ å‚é˜… [client-go å‡­æ®æ’ä»¶](https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#client-go-credential-plugins)
:::

```bash
kubectl config --kubeconfig=config-demo set-credentials developer --client-certificate=fake-cert-file --client-key=fake-key-seefile
kubectl config --kubeconfig=config-demo set-credentials experimenter --username=exp --password=some-password
```



::: tip**è¯´æ˜ï¼š**

+ è¦åˆ é™¤ç”¨æˆ·ï¼Œå¯ä»¥è¿è¡Œ `kubectl --kubeconfig=config-demo config unset users.<name>`
+ è¦åˆ é™¤é›†ç¾¤ï¼Œå¯ä»¥è¿è¡Œ `kubectl --kubeconfig=config-demo config unset clusters.<name>`
+ è¦åˆ é™¤ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥è¿è¡Œ `kubectl --kubeconfig=config-demo config unset contexts.<name>`
  :::































## ç”Ÿæˆkubeconfigçš„é…ç½®æ­¥éª¤

**å®šä¹‰å˜é‡ï¼š**

```
export KUBE_APISERVER="https://172.20.0.2:6443" 
```

**è®¾ç½®é›†ç¾¤å‚æ•°ï¼š** 

```bash
kubectl config set-cluster kubernetes   --certificate-authority=/etc/kubernetes/ssl/ca.pem   --embed-certs=true   --server=${KUBE_APISERVER}   #å¯ä»¥æŒ‡å®šè·¯å¾„kubeconfig=/root/config.conf
```

> è¯´æ˜ï¼šé›†ç¾¤å‚æ•°ä¸»è¦è®¾ç½®äº†æ‰€éœ€è¦è®¿é—®çš„é›†ç¾¤çš„ä¿¡æ¯ã€‚ä½¿ç”¨ `set-cluster` è®¾ç½®äº†éœ€è¦è®¿é—®çš„é›†ç¾¤ï¼Œå¦‚ä¸Šä¸º `kubernetes`ï¼›`--certificate-authority`è®¾ç½®äº†è¯¥é›†ç¾¤çš„å…¬é’¥ï¼›`--embed-certs`ä¸º `true` è¡¨ç¤ºå°† `--certificate-authority` è¯ä¹¦å†™å…¥åˆ° `kubeconfig` ä¸­ï¼›`--server`åˆ™è¡¨ç¤ºè¯¥é›†ç¾¤çš„ kube-apiserver åœ°å€ã€‚ 

**è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°ï¼š** 

```bash
kubectl config set-credentials admin   --client-certificate=/etc/kubernetes/ssl/admin.pem   --embed-certs=true   --client-key=/etc/kubernetes/ssl/admin-key.pem #å¯ä»¥æŒ‡å®šè·¯å¾„kubeconfig=/root/config.conf
```

> è¯´æ˜ï¼šç”¨æˆ·å‚æ•°ä¸»è¦è®¾ç½®ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ç”¨æˆ·è¯ä¹¦ã€‚å¦‚ä¸Šçš„ç”¨æˆ·åä¸ºadminï¼Œè¯ä¹¦ä¸ºï¼š/etc/kubernetes/ssl/admin.pemï¼Œç§é’¥ä¸ºï¼š/etc/kubernetes/ssl/admin-key.pemã€‚æ³¨æ„å®¢æˆ·ç«¯çš„è¯ä¹¦é¦–å…ˆè¦ç»è¿‡é›†ç¾¤CAçš„ç­¾ç½²ï¼Œå¦åˆ™ä¸ä¼šè¢«é›†ç¾¤è®¤å¯ã€‚æ­¤å¤„ä½¿ç”¨çš„æ˜¯caè®¤è¯æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨tokenè®¤è¯ï¼Œå¦‚kubeletçš„ TLS Boostrapæœºåˆ¶ä¸‹çš„bootstrappingä½¿ç”¨çš„å°±æ˜¯tokenè®¤è¯æ–¹å¼ã€‚

**è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°ï¼š** 

```bash
kubectl config set-context kubernetes   --cluster=kubernetes   --user=admin #å¯ä»¥æŒ‡å®šè·¯å¾„kubeconfig=/root/config.conf
```

> è¯´æ˜ï¼šä¸Šä¸‹æ–‡å‚æ•°å°†**é›†ç¾¤å‚æ•°**å’Œ**ç”¨æˆ·å‚æ•°**å…³è”èµ·æ¥ã€‚å¦‚ä¸Šé¢çš„ä¸Šä¸‹æ–‡åç§°ä¸ºkubenetesï¼Œé›†ç¾¤ä¸ºkubenetesï¼Œç”¨æˆ·ä¸ºadminï¼Œè¡¨ç¤ºä½¿ç”¨adminçš„ç”¨æˆ·å‡­è¯æ¥è®¿é—®kubenetesé›†ç¾¤çš„defaultå‘½åç©ºé—´ï¼Œä¹Ÿå¯ä»¥å¢åŠ --namspaceæ¥æŒ‡å®šè®¿é—®çš„å‘½åç©ºé—´ã€‚ 

**è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡** 

```bash
kubectl config use-context kubernetes  #å¯ä»¥æŒ‡å®šè·¯å¾„kubeconfig=/root/config.conf
```

> è¯´æ˜ï¼šæœ€åä½¿ç”¨kubectl config use-context kubernetesæ¥ä½¿ç”¨åä¸ºkubenetesçš„ç¯å¢ƒé¡¹æ¥ä½œä¸ºé…ç½®ã€‚å¦‚æœé…ç½®äº†å¤šä¸ªç¯å¢ƒé¡¹ï¼Œå¯é€šè¿‡åˆ‡æ¢ä¸åŒçš„ç¯å¢ƒé¡¹åå­—æ¥è®¿é—®åˆ°ä¸åŒçš„é›†ç¾¤ç¯å¢ƒã€‚

é»˜è®¤ç”Ÿæˆçš„ `kubeconfig` è¢«ä¿å­˜åˆ° `~/.kube/config` æ–‡ä»¶



## END é“¾æ¥
<ul><li><div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

