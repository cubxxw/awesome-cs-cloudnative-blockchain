+ [author](http://nsddd.top)

# ç¬¬10èŠ‚ Deployment

<div><a href = '9.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '11.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br><br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]

## Deployment

**âš ï¸ Deploymentï¼šæ§åˆ¶podï¼Œä½¿podå…·æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œè‡ªæ„ˆï¼Œæ‰©ç¼©å®¹ç­‰èƒ½åŠ›~**



::: tip deployment and pod?
Podæ˜¯å•ä¸€äº¦æˆ–ä¸€ç»„å®¹å™¨çš„åˆé›†

Podæ˜¯k8sçš„æœ€å°è°ƒåº¦å•ä½ï¼Œä¸€ä¸ªPodä¸­å¯ä»¥æœ‰å¤šä¸ªcontainersï¼Œå½¼æ­¤å…±äº«ç½‘ç»œç­‰ï¼Œè¿™æ˜¯k8sçš„æ ¸å¿ƒæ¦‚å¿µã€‚

**deploymentæ˜¯podç‰ˆæœ¬ç®¡ç†çš„å·¥å…· ç”¨æ¥åŒºåˆ†ä¸åŒç‰ˆæœ¬çš„pod**

ä»å¼€å‘è€…è§’åº¦çœ‹ï¼Œdeploymenté¡¾æ˜æ€æ„ï¼Œæ—¢éƒ¨ç½²ï¼Œå¯¹äºå®Œæ•´çš„åº”ç”¨éƒ¨ç½²æµç¨‹ï¼Œé™¤äº†è¿è¡Œä»£ç (æ—¢pod)ä¹‹å¤–ï¼Œéœ€è¦è€ƒè™‘æ›´æ–°ç­–ç•¥ï¼Œå‰¯æœ¬æ•°é‡ï¼Œå›æ»šï¼Œé‡å¯ç­‰æ­¥éª¤ï¼Œ

deploymentï¼ŒStatefulSetæ˜¯Controllerï¼Œä¿è¯Podä¸€ç›´è¿è¡Œåœ¨ä½ éœ€è¦çš„çŠ¶æ€ã€‚

æœ‰ä¸€æ¬¡æ€§çš„ä¹Ÿå°±æ˜¯jobï¼Œæœ‰å®šæ—¶æ‰§è¡Œçš„ä¹Ÿå°±æ˜¯crontabjobï¼Œæœ‰æ’å·çš„ä¹Ÿå°±æ˜¯sts

:::



## ç”¨deploymentåˆ›å»ºæœ‰ä½•ä¸åŒ

```bash
# æ¸…é™¤æ‰€æœ‰podï¼Œæ¯”è¾ƒä¸‹é¢ä¸¤æ¡å‘½ä»¤æœ‰å•¥ä¸åŒ
kubectl delete pod my-nginx-7fb96c846b-cnhbz my-nginx-7fb96c846b-g55km my-nginx-7fb96c846b-m9rjp myapp  mynginx  -n default

kubectl  run mynginx --image=nginx #ç¬¬ä¸€æ¡

kubectl create deployment mytomcat --image=tomcat:8.5.68  #ç¬¬äºŒæ¡
```

ğŸš€ ç»“æœå¦‚ä¸‹ï¼š

![image-20221022160112746](http://sm.nsddd.top/smimage-20221022160112746.png)

::: tip ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š
å¯èƒ½æˆ‘ä»¬ç°åœ¨æ²¡åŠæ³•çœ‹å‡ºæ¥å¾ˆå¤§çš„åŒºåˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨`delete`åˆ é™¤è¿™ä¸ª`deployment`éƒ¨ç½²`tomcat`ä¼šæ€ä¹ˆæ ·ï¼Ÿ

```bash
kubectl delete pod mytomcat-dc7db794-mkfxn mynginx 
```

![image-20221022160515168](http://sm.nsddd.top/smimage-20221022160515168.png)

> å¯ä»¥çœ‹å‡ºæ˜¯æ²¡æœ‰åŠæ³•åˆ é™¤æ‰çš„ï¼Œå› ä¸ºåˆ é™¤åk8såˆæ‹‰å–äº†ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯å¾ˆå¼ºå¤§çš„~yyds
>
> **è¿™æ ·çš„è¯å³ä½¿æœºå™¨å®•æœºäº†ä¹Ÿæ˜¯ä¸ä¼šå½±å“çš„~**

:::



### å¦‚æœæƒ³è¦çœŸæ­£çš„åˆ é™¤æ€ä¹ˆåŠï¼Ÿ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`deploy`æŸ¥çœ‹éƒ¨ç½²ï¼ˆdeploymentç®€å†™ï¼‰ï¼š

```bash
[root@k8s-master01 ~]# kubectl get deploy
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx   3/3     3            3           42h
mytomcat   1/1     1            1           10m
```



æ¥ä¸‹æ¥å¯ä»¥åˆ é™¤äº†

```bash
[root@k8s-master01 ~]# kubectl get deploy
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx   3/3     3            3           42h
mytomcat   1/1     1            1           10m

[root@k8s-master01 ~]# kubectl delete deploy mytomcat 
deployment.apps "mytomcat" deleted

[root@k8s-master01 ~]# kubectl get deploy
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
my-nginx   3/3     3            3           42h
```



## å¤šå‰¯æœ¬

**æˆ‘ä»¬å¯ä»¥æŒ‡å®šå‰¯æœ¬ä¸ªæ•°ï¼Œæ¯”å¦‚è¯´ä¸‹é¢æŒ‡å®šä¸‰ä»½ï¼š**

```bash
kubectl create deployment my-dep --image=nginx --replicas=3
```



::: tip ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š
![image-20221022161337428](http://sm.nsddd.top/smimage-20221022161337428.png)

+ UP-TO-DATEï¼šè¡¨ç¤ºæˆåŠŸå¯åŠ¨çš„ä¸ªæ•°
+ AVAILABLEï¼šè¡¨ç¤ºä¸€å…±å‰¯æœ¬çš„æ€»æ•°

> å½“ç„¶åŒæ ·çš„æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`dashboard`å¯è§†åŒ–ç•Œé¢è¿›è¡Œéƒ¨ç½²~

âš¡ æˆ‘ä»¬è¿˜å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤æ‰“å°`pod`è¯¦ç»†ä¿¡æ¯ï¼š

```
 kubectl get pod -owide
```

![image-20221022161843319](http://sm.nsddd.top/smimage-20221022161843319.png)

æ¯å°æœºå™¨éƒ½åˆ›å»ºäº†ä¸€å°ï¼ŒåŒæ ·çš„ï¼Œæ¯å°æœºå™¨çš„`ip`æ˜¯ä¸ä¸€æ ·çš„~

:::



## å·¥ä½œè´Ÿè½½-deploymentæ‰©å®¹ç¼©å®¹èƒ½åŠ›

âš¡ **å°†ç°æœ‰çš„æœºå™¨ï¼ˆå› ä¸ºæ»¡è¶³ä¸äº†éœ€æ±‚ï¼‰å¤šéƒ¨ç½²å‡ å°podï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšæ‰©å®¹ã€‚åŒæ ·çš„ç¼©å®¹å°±æ˜¯å°†ä¸€äº›podä¸‹çº¿ï¼ˆæµé‡é«˜å³°æœŸè¿‡äº†ï¼‰**



### æ‰©ç¼©å®¹

::: tip æŠ€å·§
æˆ‘ä»¬å¯ä»¥åŠ¨æ€æŸ¥çœ‹podæƒ…å†µ

```
watch -n 1 kubectl get pod 
```

:::



> ç¼©å®¹ä¸ºä¸¤ä»½

```bash
kubectl scale deploy/my-nginx  --replicas=2
```

![image-20221022163051069](http://sm.nsddd.top/smimage-20221022163051069.png)



> æ‰©å®¹ä¸ºä¸‰ä»½

```
kubectl scale deploy/my-nginx  --replicas=3
```

![image-20221022163210228](http://sm.nsddd.top/smimage-20221022163210228.png)



::: warning æ³¨æ„ï¼šä½ æ˜¯å¯ä»¥æ‰©å®¹å¤šä»½ï¼ˆå³ä½¿ä½ çš„æœåŠ¡å™¨æ²¡æœ‰è¿™ä¹ˆå¤šï¼‰
![image-20221022163510801](http://sm.nsddd.top/smimage-20221022163510801.png)

:::



### ä½ å¯ä»¥ç›´æ¥ä¿®æ”¹deploté…ç½®æ–‡ä»¶è¾¾åˆ°æ‰©ç¼©å®¹

```
kubectl edit deploy my-nginx
```

![image-20221022163752641](http://sm.nsddd.top/smimage-20221022163752641.png)



::: tip
å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨å¯è§†åŒ–ç•Œé¢å®ç°ï¼ˆç‚¹å‡»ç¼©æ”¾ï¼šå¯ä»¥å®ç°æ‰©å®¹å’Œç¼©å®¹ï¼‰

:::



## yaml å£°æ˜å¼åˆ›å»º





## è‡ªæ„ˆå’Œæ•…éšœè½¬ç§»

::: tip è‡ªæ„ˆå’Œæ•…éšœè½¬ç§»
å½“æˆ‘ä»¬æœ‰ä¸€å°`pod`å‡ºç°é—®é¢˜ï¼Œ`depoyment`ä¼šæ„ŸçŸ¥åˆ°é”™è¯¯ï¼Œç„¶åå°†å…¶ä¿®å¤ï¼ˆæ€æ­»é‡å¯ï¼‰ã€‚

ä¹Ÿæœ‰ä¸€ç§æƒ…å†µï¼šæŸä¸€ä¸ªæœºå™¨çªç„¶å®•æœºæˆ–è€…ä¸‹çº¿äº†ï¼Œæ•´ä¸ªæœºå™¨æ²¡åŠæ³•è¿è¡Œï¼Œæ­¤æ—¶`depoyment`ä¼šå°†è¿™ä¸ªæœºå™¨çš„æ‰€æœ‰`pod`è½¬ç§»åˆ°å…¶ä»–æœºå™¨æ­£å¸¸è¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšæ•…éšœè½¬ç§»ã€‚

:::



## depoymentæ»šåŠ¨å’Œæ›´æ–°èƒ½åŠ›

ğŸš¸ å¦‚æœpodæœ‰æ–°çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ€ä¹ˆæ ·å»å‡çº§podï¼Ÿ

```
v1 --> v2
```

![æŸ¥çœ‹æºå›¾åƒ](http://sm.nsddd.top/smformat,png)

::: warning æ³¨æ„âš ï¸
æˆ‘ä»¬æ˜¯ä¸ä¼šåŒæ—¶æ›´æ–°æ‰€æœ‰çš„podï¼Œå› ä¸ºè¿™æ ·çš„è¯éœ€è¦åœæœºç»´æŠ¤ï¼Œæˆæœ¬å¾ˆå¤§ã€‚

æˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼æ˜¯æ»šåŠ¨æ›´æ–°ï¼Œä¸€ä¸ªpodæ›´æ–°å®Œäº†å†æ›´æ–°ä¸‹ä¸€ä¸ªã€‚

è¿™æ ·å°±ä¸éœ€è¦åœæœºç»´æŠ¤äº†~  ä¹Ÿä¸ä¼šå½±å“æ­£å¸¸è¿è¡Œ

:::



### æ»šåŠ¨æ›´æ–°

**å‘½ä»¤ï¼š**

+ ` --record `ï¼šæ˜¾ç¤ºæ›´æ–°çš„æ•ˆæœ

```bash
kubectl set image deploy/my-nginx nginx=1.16.1  --record 
```



**å‡çº§å‰æ•ˆæœï¼š**

```bash
kubectl get pod -w #å¯ä»¥è§‚å¯Ÿåˆ°å®æ—¶çš„æ›´æ–°çŠ¶æ€
```

![image-20221022170358831](http://sm.nsddd.top/smimage-20221022170358831.png)



**å‡çº§åæ•ˆæœï¼š**

![image-20221022170823962](http://sm.nsddd.top/smimage-20221022170823962.png)



## ç‰ˆæœ¬å›é€€

**æŸ¥çœ‹å½“å‰çš„podç‰ˆæœ¬ï¼š**

> `image`è¡¨ç¤ºå¯¹åº”çš„å½“å‰é•œåƒç‰ˆæœ¬å·

```bash
[root@k8s-master01 ~]# kubectl get deploy/my-nginx -o yaml |grep image
      {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"labels":{"app":"nginx"},"name":"my-nginx","namespace":"default"},"spec":{"replicas":3,"selector":{"matchLabels":{"app":"nginx"}},"template":{"metadata":{"labels":{"app":"nginx"}},"spec":{"containers":[{"image":"nginx:1.14.2","name":"nginx","ports":[{"containerPort":80}]}]}}}}
    kubernetes.io/change-cause: kubectl set image deploy/my-nginx nginx=1.16.1 --record=true
      - image: 1.16.1
        imagePullPolicy: IfNotPresent
```



**æŸ¥çœ‹å†å²è®°å½•ï¼š**

```bash
[root@k8s-master01 ~]# kubectl rollout history deployment/my-nginx
deployment.apps/my-nginx 
REVISION  CHANGE-CAUSE
1         <none>
2         kubectl set image deploy/my-nginx nginx=1.16.1 --record=true
```

> ä¸¤æ¬¡ç‰ˆæœ¬ï¼š
>
> 1. éƒ¨ç½²`my-nginx`äº§ç”Ÿçš„`<none>`
> 2. ç‰ˆæœ¬å‡çº§é•œåƒäº§ç”Ÿçš„å†…å®¹

::: warning å›æ»šåˆ°ä¸Šä¸€æ¬¡
æˆ‘ä»¬ä½¿ç”¨`rollout`å‘½ä»¤

```bash
kubectl rollout undo deploy/my-dep --to-revision=1
```

![image-20221022171946361](http://sm.nsddd.top/smimage-20221022171946361.png)

:::



## å…¶ä»–å·¥ä½œè´Ÿè½½

::: tip å·¥ä½œè´Ÿè½½æ˜¯åœ¨kubernetesä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åº
æ— è®ºä½ çš„è´Ÿè½½æ˜¯å•ä¸€ç»„ä»¶è¿˜æ˜¯ç”±å¤šä¸ªä¸€åŒå·¥ä½œçš„ç»„ä»¶æ„æˆï¼Œåœ¨Kubernetesä¸­ä½ å¯ä»¥åœ¨ä¸€ç»„Podsä¸­è¿è¡Œå®ƒã€‚åœ¨Kuberneresä¸­ï¼Œpodä»£è¡¨çš„æ˜¯é›†ç¾¤ä¸Šå¤„äºè¿è¡ŒçŠ¶æ€çš„ä¸€ç»„å®¹å™¨ã€‚

Kubernetes Podsæœ‰ç¡®å®šçš„ç”Ÿå‘½å‘¨æœŸã€‚ä¾‹å¦‚ï¼Œå½“æŸPodåœ¨ä½ çš„é›†ç¾¤ä¸­è¿è¡Œæ—¶ï¼ŒPodè¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹å‡ºç°è‡´å‘½é”™è¯¯æ—¶ï¼Œæ‰€æœ‰è¯¥èŠ‚ç‚¹ä¸Šçš„Podséƒ½ä¼šå¤±è´¥ã€‚Kuberneteså°†è¿™ç±»å¤±è´¥è§†ä¸ºæœ€ç»ˆçŠ¶æ€ï¼šå³ä½¿è¯¥èŠ‚ç‚¹åæ¥æ¢å¤æ­£å¸¸è¿è¡Œï¼Œä½ ä¹Ÿéœ€è¦åˆ›å»ºæ–°çš„Podæ¥æ¢å¤åº”ç”¨ã€‚

ä¸è¿‡ï¼Œä¸ºäº†è®©ç”¨æˆ·çš„æ—¥å­ç•¥å¾®å¥½è¿‡ä¸€ç‚¹ï¼Œä½ å¹¶ä¸éœ€è¦ç›´æ¥ç®¡ç†æ¯ä¸ªPodã€‚ç›¸åï¼Œä½ å¯ä»¥ä½¿ç”¨è´Ÿè½½èµ„æºæ¥æ›¿ä½ ç®¡ç†ä¸€ç»„Podsã€‚è¿™äº›èµ„æºé…ç½®æ§åˆ¶å™¨æ¥ç¡®ä¿åˆé€‚ç±»å‹çš„ã€å¤„äºè¿è¡ŒçŠ¶æ€çš„Podä¸ªæ•°æ˜¯æ­£ç¡®çš„ï¼Œä¸ä½ æ‰€æŒ‡å®šçš„çŠ¶æ€ç›¸ä¸€è‡´ã€‚

å¸¸ç”¨çš„å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨ï¼š

+ `Deployment`ï¼šæ— çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼ˆå¾®æœåŠ¡ï¼‰
+ `StatefulSet`ï¼šæœ‰çŠ¶æ€åº”ç”¨éƒ¨ç½²ï¼ˆredisã€mysqlï¼Œæä¾›å­˜å‚¨ã€ç½‘ç»œç­‰ï¼‰
+ `DaemonSet`ï¼šç¡®ä¿æ‰€æœ‰Nodeè¿è¡ŒåŒä¸€ä¸ªPodï¼ˆå®ˆæŠ¤å‹åº”ç”¨éƒ¨ç½²ï¼Œæ¯”å¦‚æ—¥å¿—æ”¶é›†ç»„ä»¶ï¼‰
+ `Job`ï¼šä¸€æ¬¡æ€§ä»»åŠ¡
+ `CronJob`ï¼šå®šæ—¶ä»»åŠ¡

:::



**åœ¨å¹³å¸¸æˆ‘ä»¬æ˜¯ä¸ä¼šç›´æ¥çš„åˆ›å»º`pod`ï¼Œè€Œæ˜¯ä½¿ç”¨å·¥ä½œè´Ÿè½½æ¥åˆ›å»º`pod`**

![image-20221022172816219](http://sm.nsddd.top/smimage-20221022172816219.png)



::: warning  âš ï¸æ³¨æ„
æˆ‘ä»¬æ‰€æœ‰çš„éƒ¨ç½²ï¼ˆmysqlã€redisã€tomcatï¼‰éƒ½æ˜¯æ²¡åŠæ³•é€šè¿‡æµè§ˆå™¨è®¿é—®çš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•çœ‹åˆ°æ•ˆæœï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥é€šè¿‡å†…ç½‘çš„åœ°å€è®¿é—®ï¼ˆcurlï¼‰

```bash
[root@k8s-master01 ~]# curl 100.66.195.43
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

:::



## END é“¾æ¥

<ul><li><div><a href = '9.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '11.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

