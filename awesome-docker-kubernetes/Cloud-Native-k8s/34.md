+ [author](http://nsddd.top)

# ç¬¬34èŠ‚ API Server

<div><a href = '33.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '35.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## ğŸ’¡API Server å®ƒå¾ˆé‡è¦

å®ƒå°±åƒæ˜¯æ•°æ®åº“ä¸€æ ·é‡è¦ï¼Œç¼ºäº†å®ƒï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½æ²¡åŠæ³•å®ç°ï¼Œä½†æ˜¯ç›¸æ¯”è¾ƒæ§åˆ¶å™¨ï¼Œå®ƒåˆä¸æ˜¯æˆ‘ä»¬æ ¸å¿ƒã€‚

ä½†æ˜¯æˆ‘ä»¬ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘å¸Œæœ›å¯ä»¥ä»å®ƒå¼€å§‹å­¦ä¹ ~

::: tip 
æˆ‘ä»¬çŸ¥é“ kubernetes æ§åˆ¶å±‚é¢çš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ API-Serverã€ Controller Managerã€Schedulerï¼Œå…¶ä¸­ API-Server å¯¹å†…ä¸åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ etcd äº¤äº’å®ç° kubernetes èµ„æºï¼ˆä¾‹å¦‚ podã€namespaceã€configMapã€service ç­‰ï¼‰çš„æŒä¹…åŒ–ï¼Œå¯¹å¤–æä¾›é€šè¿‡ RESTFul çš„å½¢å¼æä¾› kubernetes API çš„è®¿é—®æ¥å£ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜è´Ÿè´£ API è¯·æ±‚çš„è®¤è¯(authN)ã€æˆæƒ(authZ)ä»¥åŠéªŒè¯ã€‚åˆšæåˆ°çš„â€œå¯¹å¤–â€æ˜¯ç›¸å¯¹çš„æ¦‚å¿µï¼Œå› ä¸ºé™¤äº†åƒ kubectl ä¹‹ç±»çš„å‘½ä»¤è¡Œå·¥å…·ä¹‹å¤–ï¼Œkubernetes çš„å…¶ä»–ç»„ä»¶ä¹Ÿä¼šé€šè¿‡å„ç§å®¢æˆ·ç«¯åº“æ¥è®¿é—® kubernetes APIï¼Œå…³äºå®˜æ–¹æä¾›çš„å„ç§å®¢æˆ·ç«¯åº“è¯·æŸ¥çœ‹ client-libraries åˆ—è¡¨ï¼Œå…¶ä¸­æœ€å…¸å‹çš„æ˜¯ Go è¯­è¨€çš„å®¢æˆ·ç«¯åº“ client-goã€‚
:::

![image-20221203150413748](http://sm.nsddd.top/smimage-20221203150413748.png)

âš ï¸ å‰é¢çŸ¥é“ï¼š**apis æ˜¯åŒ…å«å†…å»º API Groups å’Œ API Objects çš„ï¼Œè€Œ scheme ç›¸å…³çš„ä»£ç å¤§éƒ¨åˆ†åœ¨è¿™é‡Œã€‚**



## ä¸‰ä¸ªé‡è¦çš„ API åè¯

### API Object

æ˜¯ Kubernetes å†…éƒ¨ç®¡ç†çš„åŸºæœ¬å…ƒç´ ï¼Œæ˜¯ Kubernetes åœ¨ ETCD ä¸­ä¿¡æ¯å­˜å‚¨å•å…ƒã€‚

ä¾‹å¦‚ Deploymentï¼ŒPodï¼ŒServiceï¼Œéƒ½æ˜¯ API Objectã€‚å†…éƒ¨ä»£ç å¸¸ç”¨ `API` ç§°å‘¼ã€‚



### API  Group

ä¸€ç»„ API Object ç»„æˆçš„ä¸€ä¸ªå…·æœ‰å…±æœ‰æ€§è´¨çš„å¯¹è±¡é›†åˆã€‚

ä¾‹å¦‚ï¼šapps è¿™ä¸ª group ï¼Œå®ƒç”± Deploymentï¼ŒReplicaSetï¼ŒStatefulSetã€‚



### Legacy API Object

ç»å¤§å¤šæ•°çš„ API Object éƒ½è¢«å½’åœ¨ API Group ä¸‹é¢ï¼Œç‰¹åˆ«æ˜¯æ–°ç‰ˆä¸­å¼•å…¥çš„ä¸€å®šééµä»è¿™ä¸€åŸåˆ™ã€‚

ä½†æ˜¯åœ¨ Kubernetes é¡¹ç›®é¡¹ç›®åˆå§‹åŒ–é˜¶æ®µæ‰€å¼•å…¥çš„ API Object æ²¡æœ‰æ˜¾ç¤ºå®šä¹‰åœ¨ API Group ä¸‹é¢ï¼Œä¾‹å¦‚ Podï¼ŒEventï¼ŒNodeç­‰ç­‰ï¼Œåœ¨ä»£ç ä¸­æœ‰æ—¶ä¹Ÿç§°å‘¼ä»–ä»¬ä¸º `core` ã€API Object



## GVKä¸GVR

Kubernetes API é€šè¿‡ HTTP åè®®ä»¥ RESTful çš„å½¢å¼æä¾›ï¼ŒAPI èµ„æºçš„åºåˆ—åŒ–æ–¹å¼ä¸»è¦æ˜¯ä»¥ JSON æ ¼å¼è¿›è¡Œï¼Œä½†ä¸ºäº†å†…éƒ¨é€šä¿¡ä¹Ÿæ”¯æŒ Protocol Buffer æ ¼å¼ã€‚ä¸ºäº†æ–¹ä¾¿æ‰©å±•ä¸æ¼”è¿›ï¼Œkubernetes API æ”¯æŒåˆ†ç»„ä¸å¤šç‰ˆæœ¬ï¼Œè¿™ä½“ç°åœ¨ä¸åŒçš„ API è®¿é—®è·¯å¾„ä¸Šã€‚æœ‰äº†åˆ†ç»„ä¸å¤šç‰ˆæœ¬æ”¯æŒï¼Œå³ä½¿è¦åœ¨æ–°ç‰ˆæœ¬ä¸­å»æ‰ API èµ„æºçš„ç‰¹å®šå­—æ®µæˆ–è€…é‡æ„ API èµ„æºçš„å±•ç°å½¢å¼ï¼Œä¹Ÿå¯ä»¥ä¿è¯ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§ã€‚

+ GVK å°±æ˜¯ groupã€verisonã€kind
+ GVR å°±æ˜¯ groupã€versionã€resource



::: details ä¸ºä»€ä¹ˆä¼šæœ‰ Kind resource ä¸¤ä¸ªç›¸ä¼¼çš„æ¦‚å¿µ

+ é¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®å‡ ä¸ªæ¦‚å¿µï¼š

  + åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œèµ„æºæ•°æ®çš„å­˜å‚¨éƒ½æ˜¯

    ä»¥ç»“æ„ä½“å­˜å‚¨

    (ç§°ä¸º Go type)

    + ç”±äºå¤šç‰ˆæœ¬versionçš„å­˜åœ¨ï¼ˆalpha1ï¼Œbeta1ï¼Œv1ç­‰ï¼‰ï¼Œ**ä¸åŒç‰ˆæœ¬ä¸­å­˜å‚¨ç»“æ„ä½“çš„å­˜åœ¨ç€å·®å¼‚**ï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½ä¼šç»™å…¶ç›¸åŒçš„ Kind åå­—ï¼ˆæ¯”å¦‚ Deploymentï¼‰
    + å› æ­¤ï¼Œæˆ‘ä»¬ç¼–ç ä¸­**åªç”¨ Kind åï¼ˆå¦‚ Deploymentï¼‰ï¼Œå¹¶ä¸èƒ½å‡†ç¡®è·å–åˆ°å…¶ä½¿ç”¨å“ªä¸ªç‰ˆæœ¬ç»“æ„ä½“**
    + æ‰€ä»¥ï¼Œé‡‡ç”¨ GVK è·å–åˆ°ä¸€ä¸ªå…·ä½“çš„ å­˜å‚¨ç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯ GVK çš„ä¸‰ä¸ªä¿¡æ¯ï¼ˆgroup/verion/kind) ç¡®å®šä¸€ä¸ª Go typeï¼ˆç»“æ„ä½“ï¼‰
      + å¦‚ä½•è·å–å‘¢ï¼Ÿ â€”â€” é€šè¿‡ Scheme, **Scheme å­˜å‚¨äº† GVK å’Œ Go type çš„æ˜ å°„å…³ç³»**

  + åœ¨åˆ›å»ºèµ„æºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™ yamlï¼Œæäº¤è¯·æ±‚ï¼š

    + ç¼–å†™ yaml è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå†™ apiversion å’Œ kindï¼Œå…¶å®å°±æ˜¯ GVK
    + è€Œå®¢æˆ·ç«¯ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬ï¼‰ä¸ apiserver é€šä¿¡æ˜¯ http å½¢å¼ï¼Œå°±æ˜¯å°†è¯·æ±‚å‘é€åˆ°æŸä¸€ http path
    + å‘é€åˆ°å“ªä¸ª http path å‘¢ï¼Ÿ
      + è¿™ä¸ª http path å…¶å®å°±æ˜¯ GVR
        + `/apis/batch/v1/namespaces/default/job` è¿™ä¸ªå°±æ˜¯è¡¨ç¤º default å‘½åç©ºé—´çš„ job èµ„æº
        + æˆ‘ä»¬ kubectl get po æ—¶ ä¹Ÿæ˜¯è¯·æ±‚çš„è·¯å¾„ ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸º GVR
      + å…¶å® GVR æ˜¯ç”± GVK è½¬åŒ–è€Œæ¥ â€”â€” **é€šè¿‡RESTæ˜ å°„çš„RESTMapperså®ç°**

:::

**æ€»ç»“ï¼š**

+ åŒ Kind ç”±äºå¤šç‰ˆæœ¬ä¼šå­˜åœ¨ å¤šä¸ªæ•°æ®ç»“æ„ï¼ˆGo typeï¼‰
+ GVK å¯ä»¥ç¡®å®šä¸€ä¸ªå…·ä½“çš„ Go Typeï¼ˆæ˜ å°„å…³ç³»ç”± Scheme ç»´æŠ¤ï¼‰
+ GVK å¯ä»¥è½¬æ¢ http path è¯·æ±‚è·¯å¾„ï¼ˆä¹Ÿå°±æ˜¯ GVRï¼‰ï¼ˆæ˜ å°„ç”±RESTMapperså®ç°ï¼‰
+ GVKå’ŒGVRæ˜¯ç›¸å…³çš„ã€‚GVKåœ¨GVRæ ‡è¯†çš„HTTPè·¯å¾„ä¸‹æä¾›æœåŠ¡ã€‚å°†GVKæ˜ å°„åˆ°GVRçš„è¿‡ç¨‹ç§°ä¸ºRESTæ˜ å°„ã€‚æˆ‘ä»¬å°†åœ¨â€œ REST Mappingâ€ä¸­çœ‹åˆ°åœ¨Golangä¸­å®ç°RESTæ˜ å°„çš„RESTMappersã€‚





### API-group

å°†æ•´ä¸ª kubernetes API èµ„æºåˆ†æˆå„ä¸ªç»„ï¼Œå¯ä»¥å¸¦æ¥å¾ˆå¤šå¥½å¤„ï¼š

+ å„ç»„å¯ä»¥å•ç‹¬æ‰“å¼€æˆ–è€…å…³é—­
+ å„ç»„å¯ä»¥æœ‰ç‹¬ç«‹çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸å½±å“å…¶ä»–ç»„çš„æƒ…å†µä¸‹å•ç‹¬å‘å‰è¡åŒ–
+ åŒä¸€ä¸ªèµ„æºå¯ä»¥åŒæ—¶å­˜åœ¨äºå¤šä¸ªä¸åŒç»„ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åŒæ—¶æ”¯æŒæŸä¸ªç‰¹å®šèµ„æºç¨³å®šç‰ˆæœ¬ä¸å®éªŒç‰ˆæœ¬



å…³äº kubernetes API èµ„æºçš„åˆ†ç»„ä¿¡æ¯å¯ä»¥åœ¨åºåˆ—åŒ–çš„èµ„æºå®šä¹‰ä¸­æœ‰æ‰€ä½“ç°ï¼Œä¾‹å¦‚ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example-deploy
spec:
...
```

å…¶ä¸­ apiVersion å­—æ®µä¸­ `apps` å³ä¸º `Deployment` èµ„æºçš„åˆ†ç»„ï¼Œå®é™…ä¸Šï¼Œ`Deployment` ä¸æ­¢å‡ºç°åœ¨ `apps` åˆ†ç»„é‡Œï¼Œä¹Ÿå‡ºç°åœ¨ `extensions` åˆ†ç»„ä¸­ï¼Œä¸åŒçš„åˆ†ç»„å¯ä»¥å®éªŒä¸åŒçš„ç‰¹æ€§ï¼›å¦å¤–ï¼Œ`kubernetes` ä¸­çš„æ ¸å¿ƒèµ„æºå¦‚ `pod`ã€`namespace`ã€`configmap`ã€`node`ã€`service` ç­‰å­˜åœ¨äº `core` åˆ†ç»„ä¸­ï¼Œä½†æ˜¯ç”±äºå†å²çš„åŸå› ï¼Œ`core` ä¸å‡ºç°åœ¨ `apiVersion` å­—æ®µä¸­ï¼Œä¾‹å¦‚ä»¥ä¸‹å®šä¹‰ä¸€ä¸ª `pod` èµ„æºçš„åºåˆ—åŒ–å¯¹è±¡ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
  labels:
    app: exp
...
```

API åˆ†ç»„ä¹Ÿä½“ç°åœ¨è®¿é—®èµ„æºçš„ `RESTful API` è·¯å¾„ä¸Šï¼Œ**core ç»„** ä¸­çš„èµ„æºè®¿é—®è·¯å¾„ä¸€èˆ¬ä¸º `/api/$VERSION`ï¼Œå…¶ä»–å‘½åç»„çš„èµ„æºè®¿é—®è·¯å¾„åˆ™æ˜¯ `/apis/$GROUP_NAME/$VERSION`ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº›ç³»ç»Ÿçº§åˆ«çš„èµ„æºï¼Œå¦‚é›†ç¾¤æŒ‡æ ‡ä¿¡æ¯ `/metrics`ï¼Œä»¥ä¸Šè¿™äº›å°±åŸºæœ¬æ„æˆäº† kubernetes API çš„æ ‘ç»“æ„ï¼š

![image-20221203150759615](http://sm.nsddd.top/smimage-20221203150759615.png)



### API-version

ä¸ºäº†æ”¯æŒç‹¬ç«‹çš„æ¼”è¿›ï¼Œkubernetes API ä¹Ÿæ”¯æŒä¸åŒçš„ç‰ˆæœ¬ï¼Œä¸åŒçš„ç‰ˆæœ¬ä»£è¡¨ä¸åŒçš„æˆç†Ÿåº¦ã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯ **API è€Œéèµ„æº**æ”¯æŒå¤šç‰ˆæœ¬ã€‚å› ä¸ºå¤šç‰ˆæœ¬æ”¯æŒæ˜¯é’ˆå¯¹ API çº§åˆ«ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„èµ„æºæˆ–è€…èµ„æºçš„å­—æ®µã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ ¹æ® API åˆ†ç»„ã€èµ„æºç±»å‹ã€namespace ä»¥åŠ name æ¥åŒºåˆ†ä¸åŒçš„èµ„æºå¯¹è±¡ï¼Œå¯¹äºåŒä¸€ä¸ªèµ„æºå¯¹è±¡çš„ä¸åŒç‰ˆæœ¬ï¼ŒAPI-Server è´Ÿè´£ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„æ— æŸåˆ‡æ¢ï¼Œè¿™ç‚¹å¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ã€‚äº‹å®ä¸Šï¼Œä¸åŒç‰ˆæœ¬çš„åŒç±»å‹çš„èµ„æºåœ¨æŒä¹…åŒ–å±‚çš„æ•°æ®å¯èƒ½æ˜¯ç›¸åŒçš„ã€‚*ä¾‹å¦‚ï¼Œå¯¹äºåŒä¸€ç§èµ„æºç±»å‹æ”¯æŒ `v1` å’Œ `v1beta1` ä¸¤ä¸ª API ç‰ˆæœ¬ï¼Œä»¥ `v1beta1` ç‰ˆæœ¬åˆ›å»ºè¯¥èµ„æºçš„å¯¹è±¡ï¼Œåç»­å¯ä»¥ä»¥`v1` æˆ–è€… `v1beta1` æ¥æ›´æ–°æˆ–è€…åˆ é™¤è¯¥èµ„æºå¯¹è±¡ã€‚*

API å¤šç‰ˆæœ¬æ”¯æŒä¸€èˆ¬é€šè¿‡å°†èµ„æºåˆ†ç»„ç½®äºä¸åŒçš„ç‰ˆæœ¬ä¸­æ¥å®ç°ï¼Œä¾‹å¦‚ï¼Œ`batch` åŒæ—¶å­˜åœ¨ `v2alph1` ä¸ `v1` ç‰ˆæœ¬ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ–°çš„èµ„æºåˆ†ç»„å…ˆå‡ºç° `v1alpha1` ç‰ˆæœ¬ï¼Œéšç€ç¨³å®šæ€§çš„æé«˜è¢«æ¨è¿›åˆ° `v1beta1` ï¼Œæœ€åä» `v1` ç‰ˆæœ¬æ¯•ä¸šã€‚

éšç€æ–°çš„ç”¨æˆ·åœºæ™¯å‡ºç°ï¼Œkubernetes API éœ€è¦ä¸æ–­å˜åŒ–ï¼Œå¯èƒ½æ˜¯æ–°å¢ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ é™¤æ—§çš„å­—æ®µï¼Œç”šè‡³æ˜¯æ”¹å˜èµ„æºçš„å±•ç°å½¢å¼ã€‚ä¸ºäº†ä¿è¯å…¼å®¹æ€§ï¼Œkubernetes åˆ¶å®šäº†ä¸€ç³»åˆ—çš„ç­–ç•¥ã€‚æ€»çš„æ¥è¯´ï¼Œå¯¹äºå·²ç» GA çš„ APIï¼ŒAPIï¼Œkubernetes ä¸¥æ ¼ç»´æŠ¤å…¶å…¼å®¹æ€§ï¼Œç»ˆç«¯ç”¨æˆ·å¯ä»¥æ”¾å¿ƒé£Ÿç”¨ï¼Œbeta ç‰ˆæœ¬çš„ API åˆ™å°½é‡ç»´æŠ¤ï¼Œä¿è¯ä¸æ‰“ç ´ç‰ˆæœ¬è·¨ç‰ˆæœ¬ä¹‹é—´çš„äº¤äº’ï¼Œè€Œå¯¹äº alpha ç‰ˆæœ¬çš„ API åˆ™å¾ˆéš¾ä¿è¯å…¼å®¹æ€§ï¼Œä¸å¤ªæ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚



### GVK ä¸ GVR æ˜ å°„

åœ¨ kubernetes API å®‡å®™ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å±äº GVK æˆ–è€… GVR æ¥åŒºåˆ†ç‰¹å®šçš„ kubernetes èµ„æºã€‚å…¶ä¸­ GVK æ˜¯ Group Version Kind çš„ç®€ç§°ï¼Œè€Œ GVR åˆ™æ˜¯ Group Version Resource çš„ç®€ç§°ã€‚

é€šè¿‡ä¸Šé¢å¯¹äº kubernetes API åˆ†ç»„å’Œå¤šç‰ˆæœ¬çš„ä»‹ç»ä¸­æˆ‘ä»¬å·²ç»äº†è§£äº† Group ä¸ Versionï¼Œé‚£ä¹ˆ Kind ä¸ Resource åˆåˆ†åˆ«æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿ

**Kind** æ˜¯ API â€œé¡¶çº§â€èµ„æºå¯¹è±¡çš„ç±»å‹ï¼Œæ¯ä¸ªèµ„æºå¯¹è±¡éƒ½éœ€è¦ Kind æ¥åŒºåˆ†å®ƒè‡ªèº«ä»£è¡¨çš„èµ„æºç±»å‹ï¼Œä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª pod çš„ä¾‹å­ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
  labels:
    app: exp
...
```

å…¶ä¸­ kind å­—æ®µå³ä»£è¡¨è¯¥èµ„æºå¯¹è±¡çš„ç±»å‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ kubernetes API ä¸­æœ‰ä¸‰ç§ä¸åŒçš„ Kindï¼š

1. å•ä¸ªèµ„æºå¯¹è±¡çš„ç±»å‹ï¼Œæœ€å…¸å‹çš„å°±æ˜¯åˆšæ‰ä¾‹å­ä¸­æåˆ°çš„ Pod
2. èµ„æºå¯¹è±¡çš„åˆ—è¡¨ç±»å‹ï¼Œä¾‹å¦‚ PodList ä»¥åŠ NodeList ç­‰
3. ç‰¹æ®Šç±»å‹ä»¥åŠéæŒä¹…åŒ–æ“ä½œçš„ç±»å‹ï¼Œå¾ˆå¤šè¿™ç§ç±»å‹çš„èµ„æºæ˜¯ subresourceï¼Œ ä¾‹å¦‚ç”¨äºç»‘å®šèµ„æºçš„ `/binding`ã€æ›´æ–°èµ„æºçŠ¶æ€çš„ `/status` ä»¥åŠè¯»å†™èµ„æºå®ä¾‹æ•°é‡çš„ `/scale`

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŒ Kind ä¸æ­¢å¯ä»¥å‡ºç°åœ¨åŒä¸€åˆ†ç»„çš„ä¸åŒç‰ˆæœ¬ä¸­ï¼Œå¦‚ `apps/v1beta1` ä¸ `apps/v1`ï¼Œå®ƒè¿˜å¯èƒ½å‡ºç°åœ¨ä¸åŒçš„åˆ†ç»„ä¸­ï¼Œä¾‹å¦‚ Deployment å¼€å§‹ä»¥ alpha çš„ç‰¹æ€§å‡ºç°åœ¨ `extensions` åˆ†ç»„ï¼ŒGA ä¹‹åè¢«æ¨è¿›åˆ° `apps` ç»„ï¼Œæ‰€ä»¥ä¸ºäº†ä¸¥æ ¼åŒºåˆ†ä¸åŒçš„ Kindï¼Œéœ€è¦ç»„åˆ API Groupã€API Version ä¸ Kind æˆä¸º **GVK**ã€‚

**Resource** åˆ™æ˜¯é€šè¿‡ HTTP åè®®ä»¥ JSON æ ¼å¼å‘é€æˆ–è€…è¯»å–çš„èµ„æºå±•ç°å½¢å¼ï¼Œå¯ä»¥ä»¥å•ä¸ªèµ„æºå¯¹è±¡å±•ç°ï¼Œä¾‹å¦‚ `.../namespaces/default`ï¼Œä¹Ÿå¯ä»¥ä»¥åˆ—è¡¨çš„å½¢å¼å±•ç°ï¼Œä¾‹å¦‚ `.../jobs`ã€‚è¦æ­£ç¡®çš„è¯·æ±‚èµ„æºå¯¹è±¡ï¼ŒAPI-Server å¿…é¡»çŸ¥é“ `apiVersion` ä¸è¯·æ±‚çš„èµ„æºï¼Œè¿™æ · API-Server æ‰èƒ½æ­£ç¡®åœ°è§£ç è¯·æ±‚ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ­£æ˜¯å¤„äºè¯·æ±‚çš„èµ„æºè·¯å¾„ä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒæŠŠ API Groupã€API Version ä»¥åŠ Resource ç»„åˆæˆä¸º GVR å¯ä»¥åŒºåˆ†ç‰¹å®šçš„èµ„æºè¯·æ±‚è·¯å¾„ï¼Œä¾‹å¦‚ `/apis/batch/v1/jobs` å°±æ˜¯è¯·æ±‚æ‰€æœ‰çš„ jobs ä¿¡æ¯ã€‚

GVR å¸¸ç”¨äºç»„åˆæˆ RESTful API è¯·æ±‚è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹åº”ç”¨ç¨‹åº v1 éƒ¨ç½²çš„ RESTful API è¯·æ±‚å¦‚ä¸‹æ‰€ç¤ºï¼š

```go
GET /apis/apps/v1/namespaces/{namespace}/deployments/{name}
```

é€šè¿‡è·å–èµ„æºçš„ JSON æˆ– YAML æ ¼å¼çš„åºåˆ—åŒ–å¯¹è±¡ï¼Œè¿›è€Œä»èµ„æºçš„ç±»å‹ä¿¡æ¯ä¸­å¯ä»¥è·å¾—è¯¥èµ„æºçš„ GVKï¼›ç›¸åï¼Œé€šè¿‡ GVK ä¿¡æ¯åˆ™å¯ä»¥è·å–è¦è¯»å–çš„èµ„æºå¯¹è±¡çš„ GVRï¼Œè¿›è€Œæ„å»º RESTful API è¯·æ±‚è·å–å¯¹åº”çš„èµ„æºã€‚è¿™ç§ GVK ä¸ GVR çš„æ˜ å°„å«åš RESTMapperã€‚Kubernetes å®šä¹‰äº† RESTMapper æ¥å£[9]å¹¶å¸¦é»˜è®¤å¸¦æœ‰å®ç° DefaultRESTMapperã€‚





## API Server åœ¨ cobra çš„å®ç°

`API Server`ï¼š

```go
func main() {
	command := app.NewAPIServerCommand()	
	code := cli.Run(command)	//è·‘ command
	os.Exit(code)	//ä¸€ç›´è·‘ï¼Œé™¤éè°ƒç”¨ code 
}
```

> å¾ˆç®€æ´çš„ä¸»ç¨‹åº~



## server chain

**æ„å»ºè¿‡ç¨‹ ä»å³å‘å·¦ï¼› è¯·æ±‚æµå‘ ä»å·¦å‘å³ï¼š**





## Master ä¸­è½¬è½½ API

API Server çš„å†…å®¹ æ˜¯ API Object 

é€šè¿‡ Restful æœåŠ¡å¯¹å¤–æä¾›æ“ä½œ API Object çš„èƒ½åŠ›ã€‚





## è¯¦è§£ Scheme æœºåˆ¶

::: warning å®šä¹‰
Scheme æ˜¯ä¸€ä¸ªæ¥å£ä½“ï¼Œå†…å«å¤„ç†å¤–éƒ¨ Version ä¹‹é—´çš„è½¬æ¢ï¼Œ **GVK å’Œ Go Typeä¹‹é—´çš„è½¬æ¢ä¹‹ç”¨çš„æ•°æ®å’Œæ–¹æ³•ã€‚**

> Scheme å†…éƒ¨æœ‰ä¸¤å¼  mapï¼Œåˆ†åˆ«å¯¹åº”åˆ° gvk åˆ° type ï¼ˆ `gvkToTypeype` ï¼‰å’Œ type åˆ° gvkï¼ˆ `typeToGVK` ï¼‰ï¼›
>
> ä½¿å¾—ä¸¤è€…å¯ä»¥ç›¸äº’æ‰¾åˆ°ã€‚

+ å†…éƒ¨å’Œå¤–éƒ¨ç‰ˆæœ¬è½¬æ¢ã€‚

æˆ–è®¸ä½ å¯ä»¥ç«‹å³ä¸º Windows ä¸Šçš„æ³¨å†Œè¡¨ï¼Œå­˜å‚¨å½“å‰ API Server æ‰€çŸ¥é“çš„æ‰€æœ‰ api æœåŠ¡ã€‚

:::



å¦‚æœè¯´`RESTMapper`ç®¡ç†çš„æ˜¯`GVR`å’Œ`GVK`çš„å…³ç³»ï¼Œé‚£ä¹ˆSchemeç®¡ç†çš„å°±æ˜¯`GVK`å’Œ`Type`çš„å…³ç³»ã€‚ç³»ç»Ÿä¸­æ‰€æœ‰çš„`Type`éƒ½è¦æ³¨å†Œåˆ°`Scheme`ä¸­ï¼Œå½“ç„¶ç›®å‰ç³»ç»Ÿåªæœ‰ä¸€ä¸ª`Scheme`ï¼Œå³ `api.Scheme`ï¼Œ

å®šä¹‰åœ¨`/pkg/api/register.go`ä¸­ï¼š



 Scheme å®šä¹‰äº†èµ„æºåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ–¹æ³•ä»¥åŠèµ„æºç±»å‹å’Œç‰ˆæœ¬çš„å¯¹åº”å…³ç³»ï¼›è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆä¸€å¼ çºªå½•è¡¨ã€‚å®šä¹‰åœ¨ [k8s.io/apimachinery/pkg/runtime/scheme.go](https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apimachinery/pkg/runtime/scheme.go) ä¸­ã€‚éœ€è¦å…³æ³¨çš„ `gvkToTypeype` å’Œ `typeToGVK` å­—æ®µ

```go
// Schemes are not expected to change at runtime and are only threadsafe after
// registration is complete.
type Scheme struct {
	// gvkToType allows one to figure out the go type of an object with
	// the given version and name.
	gvkToType map[schema.GroupVersionKind]reflect.Type

	// typeToGVK allows one to find metadata for a given go object.
	// The reflect.Type we index by should *not* be a pointer.
	typeToGVK map[reflect.Type][]schema.GroupVersionKind

	// unversionedTypes are transformed without conversion in ConvertToVersion.
	unversionedTypes map[reflect.Type]schema.GroupVersionKind

	// unversionedKinds are the names of kinds that can be created in the context of any group
	// or version
	// TODO: resolve the status of unversioned types.
	unversionedKinds map[string]reflect.Type

	// Map from version and resource to the corresponding func to convert
	// resource field labels in that version to internal version.
	fieldLabelConversionFuncs map[schema.GroupVersionKind]FieldLabelConversionFunc

	// defaulterFuncs is a map to funcs to be called with an object to provide defaulting
	// the provided object must be a pointer.
	defaulterFuncs map[reflect.Type]func(interface{})

	// converter stores all registered conversion functions. It also has
	// default converting behavior.
	converter *conversion.Converter

	// versionPriority is a map of groups to ordered lists of versions for those groups indicating the
	// default priorities of these versions as registered in the scheme
	versionPriority map[string][]string

	// observedVersions keeps track of the order we've seen versions during type registration
	observedVersions []schema.GroupVersion

	// schemeName is the name of this scheme.  If you don't specify a name, the stack of the NewScheme caller will be used.
	// This is useful for error reporting to indicate the origin of the scheme.
	schemeName string
}
```

å’Œ API Server é€šä¿¡çš„æ—¶å€™èƒ½å¤Ÿå¤„ç†æ–°çš„ `types` ç±»å‹å°±éœ€è¦çŸ¥é“æœ‰æ–°çš„ `types` ç±»å‹ï¼Œ`AddToScheme` ä¼šåˆ©ç”¨åˆ°åå°„ï¼Œæ–°å®šä¹‰çš„ `types` ç±»å‹çš„ç»“æ„ä½“çš„å‘½åå¿…é¡»å’Œè‡ªå®šä¹‰çš„ `Kind` çš„å‘½åä¸€è‡´ï¼Œå¦åˆ™æ‰¾ä¸åˆ°å¯¹åº”çš„`kind`ã€‚



## converter å’Œ defaulter ä»£ç ç”Ÿæˆ

ç›®å½•ï¼špkg/apis/

+ æ³¨å†Œï¼šregister.go



### ä¸ºä»€ä¹ˆéœ€è¦ä»£ç ç”Ÿæˆï¼Ÿ

1. Goè¯­è¨€æ²¡æœ‰ç»§æ‰¿æœºåˆ¶ï¼Œæ‰€ä»¥ä»£ç çš„å†—ä½™å¿…ç„¶å‘ç”Ÿã€‚
2.  External Version å’Œ Internal Version çš„è½¬æ¢

::: tip 
version ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ¯ä¸€ä¸ª version å‡ºç°éƒ½éœ€è¦è¿›è¡Œè½¬æ¢ï¼Œå¦‚æœéƒ½éœ€è¦æ‰‹å†™å¤ªç´¯äº†ã€‚

æˆ‘ä»¬ä¹Ÿæ²¡åŠæ³•é€šè¿‡ç»§æ‰¿ï¼Œé€šè¿‡çˆ¶ç±»å†™æ–¹æ³•ï¼Œç„¶åå­ç±»ç»§æ‰¿å®ƒã€‚

:::



## Version

æ¯ä¸€ä¸ª API Group éƒ½ä¼šæœ‰å¾ˆå¤š versionï¼Œæ¯ä¸€ä¸ª version åŒ…å«å¾ˆå¤šä¸ª kind ï¼ˆä¸€ä¸ª KIndä¼šå‡ºç°åœ¨å¤šä¸ª version ä¸‹ï¼‰

è¿™äº› Version åˆç§°ä¸º External Version ï¼Œå®ƒä»¬é¢å‘ API Server å¤–éƒ¨ï¼ŒInternal Version æ˜¯ API Server åœ¨å†…éƒ¨ç¨‹åºä¸­å¤„ç†æ•°æ®æ—¶ API Object çš„å®é™…ç±»å‹ã€‚



## GVK

Groupï¼ŒVersionï¼ŒKind ã€‚è¿™ä¸‰å…ƒç»„ç¡®å®šäº†ä¸€ä¸ª Kindï¼Œå½“ç„¶å¹¶ä¸æ˜¯ç¼ºä¸€ä¸å¯ã€‚GVK ç†è§£ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ˜¯ä¸‰è€…æ‹¼æ¥çš„ç»“æœã€‚





## Type

ä»£ç ä¸­å¸¸è§ "TYPE" ã€‚



## å‚è€ƒæ–‡ç« 

+ [åˆè¯† Kubernetes ç»„ç»‡ç»“æ„](https://blog.csdn.net/alex_yangchuansheng/article/details/114254004)



## END é“¾æ¥

<ul><li><div><a href = '33.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '35.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 



