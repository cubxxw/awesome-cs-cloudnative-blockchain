+ [author](http://nsddd.top)

# ç¬¬58èŠ‚ Kubernetes ç½‘ç»œ

<div><a href = '57.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '59.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## Kubernetes ç½‘ç»œåŸºç¡€

ç½‘ç»œå¾ˆéš¾ï¼ŒKubernetes çš„ç½‘ç»œæ›´éš¾ï¼Œåé¢æ›´æ˜¯æœ‰å¤æ‚çš„ç½‘ç»œåˆ†æ²»ï¼Œè¦ç†è§£å®ç°ï¼Œå¿…é¡»å¯¹Kubernetesçš„ç½‘ç»œæœ‰ç€æ·±å…¥çš„äº†è§£ã€‚

:::danger
Kubernetes å¾€æ·±å¤„æŒ–å¿…é¡»è¦æ‰“å¥½ç½‘ç»œçš„åŸºç¡€ï¼Œè¿™ä¸ªå¾ˆé‡è¦ ~

ä»ä½¿ç”¨äº¤æ¢æœºã€è·¯ç”±å™¨å’Œä»¥å¤ªç½‘ç”µç¼†çš„ç‰©ç†ç½‘ç»œè¿ç§»åˆ°ä½¿ç”¨è½¯ä»¶å®šä¹‰ç½‘ç»œï¼ˆSDNï¼‰å’Œè™šæ‹Ÿæ¥å£çš„è™šæ‹Ÿç½‘ç»œéœ€è¦ä¸€æ®µæ—¶é—´ã€‚å½“ç„¶ï¼ŒåŸåˆ™æ˜¯ç›¸åŒçš„ï¼Œä½†æœ‰ä¸åŒçš„è§„èŒƒå’Œæœ€ä½³å®è·µã€‚Kubernetesæœ‰è‡ªå·±çš„ä¸€å¥—è§„åˆ™ï¼Œå¦‚æœæ‚¨è¦å¤„ç†å®¹å™¨å’Œäº‘ï¼Œäº†è§£Kubernetesç½‘ç»œçš„å·¥ä½œåŸç†ä¼šæœ‰æ‰€å¸®åŠ©ã€‚

"ç½‘ç»œæ ˆ" åŒ…æ‹¬äº†ç½‘å¡ï¼ˆnetwork interface)ã€å›ç¯è®¾å¤‡ï¼ˆloopback deviceï¼‰ã€è·¯ç”±è¡¨ï¼ˆrouting tableï¼‰ å’Œ iptables çš„è§„åˆ™ï¼Œè¿™äº›æ˜¯æ„æˆäº†ç½‘ç»œçš„å‘èµ·å’Œå“åº”çš„åŸºæœ¬è¦ç´ ã€‚

> ç½‘å¡å·¥ä½œåœ¨ OSI æ¨¡å‹çš„ç¬¬äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰å’Œç¬¬ä¸€å±‚ï¼ˆç‰©ç†å±‚ï¼‰ï¼Œè´Ÿè´£å¤„ç†ç‰©ç†ç½‘ç»œçš„æ•°æ®æµã€‚ç½‘å¡é€šå¸¸ç”±ç½‘å¡é©±åŠ¨ç¨‹åºæ§åˆ¶ï¼Œç½‘å¡é©±åŠ¨ç¨‹åºæ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çš„ç¨‹åºã€‚ç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡å¥—æ¥å­—ï¼ˆsocketï¼‰æ¥å£ä¸å†…æ ¸ç©ºé—´çš„ç½‘ç»œåè®®æ ˆè¿›è¡Œé€šä¿¡ï¼Œä»è€Œé€šè¿‡ç½‘å¡å‘é€å’Œæ¥æ”¶ç½‘ç»œæ•°æ®åŒ…ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åºé€šè¿‡å¥—æ¥å­—æ¥å£å‘å†…æ ¸ç©ºé—´å‘é€ç½‘ç»œæ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡è¯¥æ¥å£æ¥æ”¶æ¥è‡ªå†…æ ¸ç©ºé—´çš„ç½‘ç»œæ•°æ®åŒ…ã€‚

:::



**è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°†æ”¶é›† ä»¥ä¸‹ èµ„æ–™è¿›è¡Œæ•´ç†ã€è¯´æ˜ ğŸ’¡ï¼š**

+ ã€Šæ·±å…¥å‰–æKubernetesã€‹ï¼šKubernetes ç½‘ç»œåŸç†
+ åˆ˜è¶…è€å¸ˆçš„ ã€Šè¶£è°ˆ*ç½‘ç»œ*åè®®ã€‹
+ https://opensource.com/article/22/6/kubernetes-networking-fundamentals
+ https://kubernetes.io/docs/concepts/cluster-administration/networking/
+ https://dramasamy.medium.com/life-of-a-packet-in-kubernetes-part-1-f9bc0909e051



**è¿™ç¯‡æ–‡ç« ï¼Œæœ€ç»ˆä¼šå½’çº³åˆ° docs: [https://docker.nsddd.top](https://docker.nsddd.top)** Kubernetes / CloudNative



Kubernetesç½‘ç»œæ¨¡å‹æœ‰å‡ æ¡ä¸€èˆ¬è§„åˆ™éœ€è¦ç‰¢è®°ï¼š

1. **æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„IPåœ°å€**ï¼šä¸éœ€è¦åœ¨Podä¹‹é—´åˆ›å»ºé“¾æ¥ï¼Œä¹Ÿä¸éœ€è¦å°†å®¹å™¨ç«¯å£æ˜ å°„åˆ°ä¸»æœºç«¯å£ã€‚
2. **ä¸éœ€è¦NAT**ï¼šèŠ‚ç‚¹ä¸Šçš„Podåº”èƒ½å¤Ÿä¸æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podé€šä¿¡ï¼Œè€Œæ— éœ€NATã€‚
3. **Agents è·å¾—æ‰€æœ‰è®¿é—®æƒé™**ï¼šnode ä¸Šçš„ agentï¼ˆsystem daemonsã€Kubeletï¼‰å¯ä»¥ä¸è¯¥èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰Podé€šä¿¡ã€‚
4. **å…±äº«å‘½åç©ºé—´**ï¼šPodä¸­çš„å®¹å™¨å…±äº«ç½‘ç»œåç§°ç©ºé—´ï¼ˆIPå’ŒMACåœ°å€ï¼‰ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥ä½¿ç”¨ç¯å›åœ°å€ç›¸äº’é€šä¿¡ã€‚



### Kubernetes ä¸­ç½‘ç»œçš„è§£å†³æ–¹æ¡ˆ

Kubernetesç½‘ç»œè®¾è®¡ç”¨äºç¡®ä¿Kubernetesä¸­çš„ä¸åŒå®ä½“ç±»å‹å¯ä»¥é€šä¿¡ã€‚KubernetesåŸºç¡€è®¾æ–½çš„å¸ƒå±€åœ¨è®¾è®¡ä¸Šæœ‰å¾ˆå¤§çš„åˆ†ç¦»åº¦ã€‚åç§°ç©ºé—´ã€å®¹å™¨å’ŒPodæ—¨åœ¨ä¿æŒç»„ä»¶ä¹‹é—´çš„åŒºåˆ«ï¼Œå› æ­¤é«˜åº¦ç»“æ„åŒ–çš„é€šä¿¡è®¡åˆ’éå¸¸é‡è¦ã€‚

![image-20230310135053049](https://sm.nsddd.top/sm202303101350246.png "Kubernetesç½‘ç»œæ–¹æ¡ˆå›¾")



**ç½‘ç»œæ˜¯Kubernetesçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä½†è¦å‡†ç¡®äº†è§£å®ƒçš„å·¥ä½œæ–¹å¼å¯èƒ½ä¼šå¾ˆæœ‰æŒ‘æˆ˜æ€§ã€‚æœ‰4ä¸ªä¸åŒçš„ç½‘ç»œé—®é¢˜éœ€è¦è§£å†³ï¼š**

+ é«˜åº¦è€¦åˆçš„å®¹å™¨é—´é€šä¿¡ï¼šè¿™ä¸ªå·²ç»è¢« [Pod](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/) å’Œ `localhost` é€šä¿¡è§£å†³äº†ã€‚
+ Pod é—´é€šä¿¡ï¼šè¿™æ˜¯æœ¬æ–‡æ¡£è®²è¿°çš„é‡ç‚¹ã€‚
+ Pod ä¸ Service é—´é€šä¿¡ï¼šæ¶µç›–åœ¨ [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/) ä¸­ã€‚
+ å¤–éƒ¨ä¸ Service é—´é€šä¿¡ï¼šä¹Ÿæ¶µç›–åœ¨ Service ä¸­ã€‚

Kuberneteså®Œå…¨æ˜¯ä¸ºäº†åœ¨åº”ç”¨ç¨‹åºä¹‹é—´å…±äº«æœºå™¨ã€‚é€šå¸¸ï¼Œå…±äº«è®¡ç®—æœºéœ€è¦ç¡®ä¿ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¸ä¼šå°è¯•ä½¿ç”¨ç›¸åŒçš„ç«¯å£ã€‚è·¨å¤šä¸ªå¼€å‘äººå‘˜åè°ƒç«¯å£éå¸¸éš¾ä»¥å¤§è§„æ¨¡è¿›è¡Œï¼Œå¹¶ä¸”ä¼šä½¿ç”¨æˆ·é¢ä¸´è¶…å‡ºå…¶æ§åˆ¶èŒƒå›´çš„ç¾¤é›†çº§é—®é¢˜ã€‚



### Container-to-container networking

å®¹å™¨åˆ°å®¹å™¨çš„ç½‘ç»œè¿æ¥é€šè¿‡Pod namespace è¿›è¡Œã€‚**namespaceç©ºé—´å…è®¸æ‚¨æ‹¥æœ‰ç‹¬ç«‹çš„ç½‘ç»œæ¥å£å’Œè·¯ç”±è¡¨ï¼Œå®ƒä»¬ä¸ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»å¹¶ç‹¬ç«‹è¿è¡Œã€‚** æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„ç½‘ç»œåç§°ç©ºé—´ï¼ŒPodå†…çš„å®¹å™¨å…±äº«ç›¸åŒçš„IPåœ°å€å’Œç«¯å£ã€‚**è¿™äº›å®¹å™¨ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½é€šè¿‡localhostè¿›è¡Œï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯åŒä¸€åç§°ç©ºé—´çš„ä¸€éƒ¨åˆ†ã€‚**ï¼ˆä¸Šå›¾ä¸­ä»¥ç»¿è‰²çº¿è¡¨ç¤ºã€‚ï¼‰

æˆ‘ä»¬åœ¨å‰é¢æŸä¸€èŠ‚æœ‰å­¦è¿‡ docker çš„ç½‘ç»œçŸ¥è¯†ï¼Œè¿™å¾ˆé‡è¦ä¸æ˜¯å˜›ğŸ‘€ ã€‚æˆ‘ä»¬å°è¯•å¯åŠ¨ container:

```bash
$ docker run -d -net=host --name nginx-host nginx
```

> æˆ‘ä»¬å°è¯•å¯åŠ¨ nginxï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬çŸ¥é“å¯åŠ¨çš„é»˜è®¤ç«¯å£æ˜¯å®¿ä¸»æœºçš„ 80 ç«¯å£ã€‚

**è¿™ç§æ–¹å¼ï¼Œè™½ç„¶å’Œä¸»æœºä½¿ç”¨åŒä¸€ä¸ª ç½‘ç»œæ ˆï¼Œå¯ä»¥ä¸ºå®¹å™¨æä¾›è‰¯å¥½çš„ç½‘ç»œæ€§èƒ½ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¸¦æ¥å…±äº«ç½‘ç»œèµ„æºå¸¦æ¥çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œå¦‚ç½‘ç»œéš”ç¦»æ€§ã€ç½‘ç»œçš„ç«¯å£å†²çªï¼Œè®°å¾—æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ ï¼š Network Namespece.**

docker ä¸­åœ¨å®¿ä¸»æœºåˆ›å»ºä¸€ä¸ª å« `docker0` çš„ç½‘æ¡¥ï¼Œå‡¡æ˜¯å’Œ `docker0` é“¾æ¥çš„å®¹å™¨ï¼Œéƒ½å¯ä»¥ç”¨å®ƒæ¥é€šä¿¡ï¼Œè€Œå®¹å™¨é“¾æ¥åˆ° `docker0` çš„æ–¹å¼ï¼Œå°±æ›´åŠ å¾®å¦™äº†ï¼Œä½¿ç”¨çš„æ–¹å¼æ˜¯ `Veth Pair` çš„è™šæ‹Ÿè®¾å¤‡ã€‚

> åœ¨ Docker ä¸­ï¼ŒVeth Pairï¼ˆæˆ–ç§° Veth å¯¹ï¼‰æ˜¯ä¸€ç§è™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼Œå®ƒç”±ä¸€å¯¹è™šæ‹Ÿç½‘å¡ç»„æˆï¼Œä¸€ç«¯è¿æ¥åˆ° Docker å®¹å™¨ä¸­çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ°å®¿ä¸»æœºçš„ç½‘ç»œå‘½åç©ºé—´ã€‚Veth Pair æä¾›äº†ä¸€ç§ç®€å•è€Œé«˜æ•ˆçš„æ–¹å¼ï¼Œè®©å®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´å¯ä»¥è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚
>
> Veth Pair çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹æ˜¯ï¼Œå®ƒä»¬æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œä¸€ç«¯è¿æ¥åˆ° Docker å®¹å™¨ä¸­ï¼Œå¦ä¸€ç«¯è¿æ¥åˆ°å®¿ä¸»æœºä¸­ã€‚ç”±äº Veth Pair æ˜¯è™šæ‹Ÿè®¾å¤‡ï¼Œæ‰€ä»¥å®ƒä»¬ä¸ä¼šå ç”¨å®¿ä¸»æœºä¸­çš„ç‰©ç†ç½‘ç»œæ¥å£ï¼Œä»è€Œå¯ä»¥é¿å…ç½‘ç»œèµ„æºçš„æµªè´¹ã€‚



### Pod-to-Pod networking

ä½¿ç”¨Kubernetesæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æŒ‡å®šçš„Pod IP CIDRèŒƒå›´ã€‚è¿™å¯ç¡®ä¿æ¯ä¸ªPodéƒ½æ”¶åˆ°ç¾¤é›†ä¸­å…¶ä»–Podå¯ä»¥çœ‹åˆ°çš„å”¯ä¸€IPåœ°å€ã€‚åˆ›å»ºæ–°Podæ—¶ï¼ŒIPåœ°å€å†³ä¸ä¼šé‡å ã€‚ä¸å®¹å™¨åˆ°å®¹å™¨ç½‘ç»œä¸åŒï¼ŒPodåˆ°Podé€šä¿¡ä½¿ç”¨çœŸå®çš„IPï¼Œæ— è®ºæ‚¨å°†Podéƒ¨ç½²åœ¨ç¾¤é›†ä¸­çš„åŒä¸€èŠ‚ç‚¹è¿˜æ˜¯ä¸åŒèŠ‚ç‚¹ä¸Šã€‚

ä¸Šå›¾ä¸­æ˜¾ç¤ºï¼Œ**Podè¦ç›¸äº’é€šä¿¡ï¼Œæµé‡å¿…é¡»åœ¨ Pod ç½‘ç»œå‘½åç©ºé—´å’Œæ ¹ç½‘ç»œå‘½åç©ºé—´ï¼ˆroot network namespaceï¼‰ä¹‹é—´æµåŠ¨**ã€‚è¿™æ˜¯é€šè¿‡è™šæ‹Ÿä»¥å¤ªç½‘è®¾å¤‡æˆ–vethå¯¹ï¼ˆå›¾ä¸­veth0åˆ°Podå‘½åç©ºé—´1ï¼Œveth1åˆ°Podå‘½åç©ºé—´2ï¼‰è¿æ¥Podå‘½åç©ºé—´å’Œæ ¹å‘½åç©ºé—´æ¥å®ç°çš„ã€‚è™šæ‹Ÿç½‘æ¡¥è¿æ¥è¿™äº›è™šæ‹Ÿæ¥å£ï¼Œå…è®¸æµé‡ä½¿ç”¨åœ°å€è§£æåè®®ï¼ˆARPï¼‰ åœ¨å®ƒä»¬ä¹‹é—´æµåŠ¨ã€‚

**å½“æ•°æ®ä»Pod 1å‘é€åˆ°Pod 2æ—¶ï¼Œäº‹ä»¶æµä¸ºï¼š**

1. Pod 1æµé‡é€šè¿‡eth0æµå‘æ ¹ç½‘ç»œå‘½åç©ºé—´çš„è™šæ‹Ÿæ¥å£veth0ã€‚
2. ç„¶åï¼Œæµé‡é€šè¿‡veth0åˆ°è¾¾è¿æ¥åˆ°veth1çš„è™šæ‹Ÿç½‘æ¡¥ã€‚
3. æµé‡é€šè¿‡è™šæ‹Ÿç½‘æ¡¥åˆ°è¾¾veth1ã€‚
4. æœ€åï¼Œæµé‡é€šè¿‡veth1åˆ°è¾¾Pod 2çš„eth0æ¥å£ã€‚

 

### Pod-to-Service networking

è™½ç„¶ pod çš„ address æ˜¯å”¯ä¸€çš„ï¼Œä½†æ˜¯pod æ˜¯éå¸¸åŠ¨æ€çš„ã€‚å®ƒä»¬å¯èƒ½éœ€è¦æ ¹æ®éœ€æ±‚è¿›è¡Œæ‰©å±•æˆ–ç¼©å‡ã€‚åœ¨åº”ç”¨ç¨‹åºå´©æºƒæˆ–èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é‡æ–°åˆ›å»ºå®ƒä»¬ã€‚è¿™äº›äº‹ä»¶ä¼šå¯¼è‡´Podçš„IPåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œè¿™å°†ä½¿è”ç½‘æˆä¸ºä¸€ä¸ªæŒ‘æˆ˜ã€‚

![image-20230310143159337](http://sm.nsddd.top/sm202303101432580.png)



**æˆ‘ä»¬è¦è§£å†³ pod çš„åŠ¨æ€é—®é¢˜ï¼Œé‚£ä¹ˆå°±éœ€è¦ï¼š**

1. åœ¨å‰ç«¯åˆ†é…é™æ€è™šæ‹ŸIPåœ°å€ï¼ˆvirtual IPï¼šVIPï¼‰ï¼Œä»¥è¿æ¥ä¸æœåŠ¡å…³è”çš„ä»»ä½•åç«¯Podã€‚
2. å°†å¯»å€åˆ°æ­¤è™šæ‹ŸIPçš„ä»»ä½•æµé‡è´Ÿè½½å¹³è¡¡åˆ°åç«¯Podé›†ã€‚
3. è·Ÿè¸ªPodçš„IPåœ°å€ï¼Œè¿™æ ·å³ä½¿Pod IPåœ°å€å‘ç”Ÿå˜åŒ–ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¸ä¼šåœ¨è¿æ¥Podæ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬åªç›´æ¥è¿æ¥åˆ°æœåŠ¡æœ¬èº«çš„é™æ€è™šæ‹ŸIPåœ°å€ã€‚



**ç¾¤é›†å†…è´Ÿè½½å¹³è¡¡ä»¥ä¸¤ç§æ–¹å¼è¿›è¡Œï¼š**

1. `Iptables`ï¼šåœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œkube-proxyç›‘è§†APIæœåŠ¡å™¨ä¸­çš„æ›´æ”¹ã€‚å¯¹äºæ¯ä¸ªæ–°æœåŠ¡ï¼Œå®ƒéƒ½å®‰è£…iptablesè§„åˆ™ï¼Œè¿™äº›è§„åˆ™æ•è·åˆ°æœåŠ¡çš„clusterIPå’Œç«¯å£çš„æµé‡ï¼Œç„¶åå°†æµé‡é‡å®šå‘åˆ°æœåŠ¡çš„åç«¯Podã€‚Podæ˜¯éšæœºé€‰æ‹©çš„ã€‚è¿™ç§æ¨¡å¼å¾ˆå¯é ï¼Œè€Œä¸”ç³»ç»Ÿå¼€é”€è¾ƒä½ï¼Œå› ä¸ºLinux Netfilteræ— éœ€åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´åˆ‡æ¢å³å¯å¤„ç†æµé‡ã€‚
2. `IPVS`ï¼š**IPVSæ„å»ºåœ¨Netfilterä¹‹ä¸Šï¼Œå®ç°ä¼ è¾“å±‚è´Ÿè½½å¹³è¡¡**ã€‚IPVSä½¿ç”¨`Netfilter Hook`  å‡½æ•°ï¼Œä½¿ç”¨ `hash tables` ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œå¹¶åœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚è¿™æ„å‘³ç€IPVSæ¨¡å¼ä¸‹çš„ `kube-proxy` é‡å®šå‘æµé‡æ¯”iptablesæ¨¡å¼ä¸‹çš„kube-proxyå…·æœ‰æ›´ä½çš„å»¶è¿Ÿã€æ›´é«˜çš„ååé‡å’Œæ›´å¥½çš„æ€§èƒ½ã€‚

> ä¸Šå›¾æ˜¾ç¤ºäº†ä»Pod 1åˆ°Pod 3ï¼Œé€šè¿‡æœåŠ¡åˆ°ä¸åŒèŠ‚ç‚¹ï¼ˆç”¨çº¢è‰²æ ‡è®°ï¼‰çš„åŒ…æµã€‚ç”±äºç½‘æ¡¥ä¸Šè¿è¡Œçš„ RPC æ— æ³•ç†è§£æœåŠ¡ï¼Œå› æ­¤ä¼ è¾“åˆ°è™šæ‹Ÿç½‘æ¡¥çš„åŒ…å¿…é¡»ä½¿ç”¨é»˜è®¤è·¯ç”±ï¼ˆeth0)ã€‚ç¨åï¼Œå¿…é¡»é€šè¿‡iptablesè¿‡æ»¤è¿™äº›åŒ…ï¼Œiptablesä½¿ç”¨kube-proxyåœ¨èŠ‚ç‚¹ä¸­å®šä¹‰çš„è§„åˆ™ã€‚å› æ­¤ï¼Œå›¾ä¸­æ˜¾ç¤ºçš„æ˜¯è·¯å¾„ã€‚



### Internet-to-Service networking

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘å·²ç»è®¨è®ºäº†å¦‚ä½•åœ¨é›†ç¾¤ä¸­è·¯ç”±æµé‡ã€‚ä¸è¿‡ï¼ŒKubernetesç½‘ç»œè¿˜æœ‰å¦ä¸€é¢ï¼Œé‚£å°±æ˜¯å°†åº”ç”¨ç¨‹åºæš´éœ²ç»™å¤–éƒ¨ç½‘ç»œã€‚

![image-20230310144018105](http://sm.nsddd.top/sm202303101441314.png)



**å¯ä»¥é€šè¿‡ä¸¤ç§ä¸åŒçš„æ–¹å¼å°†åº”ç”¨ç¨‹åºå…¬å¼€ç»™å¤–éƒ¨ç½‘ç»œ:**

1. Egressï¼šå½“æ‚¨å¸Œæœ›å°†æµé‡ä»KubernetesæœåŠ¡è·¯ç”±åˆ°Internetæ—¶ï¼Œè¯·ä½¿ç”¨æ­¤é€‰é¡¹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œiptablesæ‰§è¡ŒæºNATï¼Œå› æ­¤æµé‡ä¼¼ä¹æ¥è‡ªèŠ‚ç‚¹è€Œä¸æ˜¯Podã€‚
2. Ingressï¼šè¿™æ˜¯ä»å¤–éƒ¨ä¸–ç•Œåˆ°æœåŠ¡çš„ä¼ å…¥æµé‡ã€‚å…¥å£è¿˜ä½¿ç”¨è¿æ¥è§„åˆ™å…è®¸å’Œé˜»æ­¢ä¸æœåŠ¡çš„ç‰¹å®šé€šä¿¡ã€‚é€šå¸¸ï¼Œå­˜åœ¨ä¸¤ç§åœ¨ä¸åŒç½‘ç»œå †æ ˆåŒºåŸŸä¸Šèµ·ä½œç”¨çš„å…¥å£è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡è´Ÿè½½å‡è¡¡å™¨å’Œå…¥å£æ§åˆ¶å™¨ã€‚



## æœåŠ¡å‘ç°ï¼ˆDiscovering Services ï¼‰

Kubernetesæä¾›äº†ä¸€ç§æœºåˆ¶æ¥è‡ªåŠ¨ç®¡ç†å®¹å™¨å’ŒæœåŠ¡ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œè¿™è¢«ç§°ä¸ºæœåŠ¡å‘ç°ã€‚æœåŠ¡å‘ç°å…è®¸å®¹å™¨å’ŒæœåŠ¡äº’ç›¸å‘ç°å½¼æ­¤çš„å­˜åœ¨å’Œä½ç½®ï¼Œä»è€Œä½¿å®ƒä»¬å¯ä»¥è¿›è¡Œé€šä¿¡ã€‚

**Kubernetes æœåŠ¡å‘ç°çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š**

+ **ç¯å¢ƒå˜é‡**ï¼šPodæ‰€åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ çš„`kubelet`æœåŠ¡è´Ÿè´£ä¸ºæ¯ä¸ªæ´»åŠ¨æœåŠ¡è®¾ç½®`{SVCNAME}_SERVICE_HOST`å’Œ`{SVCNAME}_SERVICE_PORT`æ ¼å¼çš„ç¯å¢ƒå˜é‡ã€‚å¿…é¡»åœ¨å®¢æˆ·ç«¯Podå‡ºç°ä¹‹å‰åˆ›å»ºæœåŠ¡ã€‚å¦åˆ™ï¼Œè¿™äº›å®¢æˆ·æœºPodå°†ä¸ä¼šå¡«å……å…¶ç¯å¢ƒå˜é‡ã€‚
+ **DNS**ï¼šDNSæœåŠ¡ä½œä¸ºæ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªDNSæœåŠ¡å™¨Podçš„KubernetesæœåŠ¡å®ç°ï¼Œè¿™äº›Podçš„è°ƒåº¦ä¸ä»»ä½•å…¶ä»–Podä¸€æ ·ã€‚ç¾¤é›†ä¸­çš„Podé…ç½®ä¸ºä½¿ç”¨DNSæœåŠ¡ï¼ŒDNSæœç´¢åˆ—è¡¨åŒ…æ‹¬Podè‡ªå·±çš„å‘½åç©ºé—´å’Œç¾¤é›†çš„é»˜è®¤åŸŸã€‚æ”¯æŒç¾¤é›†çš„DNSæœåŠ¡å™¨ï¼ˆå¦‚CoreDNSï¼‰ä¼šç›‘è§†Kubernetes APIä¸­çš„æ–°æœåŠ¡ï¼Œå¹¶ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºä¸€ç»„DNSè®°å½•ã€‚å¦‚æœåœ¨æ•´ä¸ªç¾¤é›†ä¸­å¯ç”¨äº†DNSï¼Œåˆ™æ‰€æœ‰Podéƒ½å¯ä»¥é€šè¿‡å…¶DNSåç§°è‡ªåŠ¨è§£ææœåŠ¡ã€‚Kubernetes DNSæœåŠ¡å™¨æ˜¯è®¿é—®ExternalNameæœåŠ¡çš„å”¯ä¸€é€”å¾„ã€‚

æ­¤å¤–ï¼ŒKubernetesè¿˜æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨KubernetesæœåŠ¡å¯¹è±¡æ¥å®šä¹‰ä¸€ç»„ç›¸å…³çš„Podï¼Œå¹¶ä¸ºå®ƒä»¬åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„åç§°å’ŒIPåœ°å€ã€‚è¿™ä½¿å¾—å…¶ä»–æœåŠ¡å¯ä»¥ä½¿ç”¨è¯¥åç§°æ¥è®¿é—®è¿™ç»„Podï¼Œè€Œä¸å¿…æ‹…å¿ƒå®ƒä»¬çš„IPåœ°å€ä¼šå‘ç”Ÿå˜åŒ–ã€‚

Kubernetesè¿˜æ”¯æŒåœ¨æœåŠ¡å‘ç°è¿‡ç¨‹ä¸­ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç®¡ç†æµé‡ã€‚è´Ÿè½½å‡è¡¡å™¨å¯ä»¥æ ¹æ®ç‰¹å®šçš„è§„åˆ™å°†æµé‡åˆ†å‘åˆ°å¤šä¸ªå®¹å™¨æˆ–æœåŠ¡ä¸­ï¼Œä»è€Œç¡®ä¿å®ƒä»¬ä¹‹é—´çš„è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨æ€§ã€‚

å¦å¤–ï¼ŒKubernetesè¿˜æ”¯æŒè‡ªå®šä¹‰æœåŠ¡å‘ç°æ’ä»¶ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ»¡è¶³ç‰¹å®šåº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶æ¥å®ç°è·¨å¤šä¸ªKubernetesé›†ç¾¤çš„æœåŠ¡å‘ç°ã€‚



### Kubernetes æœåŠ¡å‘å¸ƒ

KubernetesæœåŠ¡ä¸ºä½ æä¾›äº†ä¸€ç§è®¿é—®Podç»„çš„æ–¹æ³•ï¼Œé€šå¸¸ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨è¿›è¡Œå®šä¹‰ã€‚è¿™å¯èƒ½æ˜¯è¯•å›¾è®¿é—®é›†ç¾¤ä¸­å…¶ä»–åº”ç”¨ç¨‹åºçš„åº”ç”¨ç¨‹åºï¼Œä¹Ÿå¯èƒ½å…è®¸æ‚¨å°†é›†ç¾¤ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå…¬å¼€ç»™å¤–éƒ¨ä¸–ç•Œã€‚Kubernetes æœåŠ¡ç±»å‹å…è®¸æ‚¨æŒ‡å®šæ‰€éœ€çš„æœåŠ¡ç±»å‹ã€‚

![image-20230310145316045](http://sm.nsddd.top/sm202303101453168.png)



**ä¸åŒçš„æœåŠ¡ç±»å‹åŒ…æ‹¬ï¼š**

1. **ClusterIP**ï¼šè¿™æ˜¯é»˜è®¤çš„æœåŠ¡ç±»å‹ã€‚å®ƒä½¿æœåŠ¡åªèƒ½ä»é›†ç¾¤å†…è®¿é—®ï¼Œå¹¶å…è®¸é›†ç¾¤å†…çš„åº”ç”¨ç¨‹åºç›¸äº’é€šä¿¡ã€‚æ²¡æœ‰å¤–éƒ¨è®¿é—®ã€‚
2. **LoadBalancerï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰**ï¼šæ­¤ServiceTypeä½¿ç”¨äº‘æä¾›å•†çš„è´Ÿè½½å¹³è¡¡å™¨å‘å¤–éƒ¨å…¬å¼€æœåŠ¡ã€‚æ¥è‡ªå¤–éƒ¨è´Ÿè½½å¹³è¡¡å™¨çš„æµé‡è¢«å®šå‘åˆ°åç«¯Podã€‚äº‘æä¾›å•†å†³å®šå¦‚ä½•è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚
3. **NodePort**ï¼šè¿™å…è®¸å¤–éƒ¨æµé‡é€šè¿‡æ‰“å¼€æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç‰¹å®šç«¯å£æ¥è®¿é—®æœåŠ¡ã€‚å‘é€åˆ°è¯¥ç«¯å£çš„ä»»ä½•æµé‡éšåå°†è½¬å‘åˆ°æœåŠ¡ã€‚
4. **ExternalNameï¼ˆå¤–éƒ¨åç§°ï¼‰**ï¼šæ­¤ç±»å‹çš„æœåŠ¡é€šè¿‡ä½¿ç”¨externalNameå­—æ®µçš„å†…å®¹å°†æœåŠ¡æ˜ å°„åˆ°DNSåç§°ï¼Œæ–¹æ³•æ˜¯è¿”å›CNAMEè®°å½•åŠå…¶å€¼ã€‚ä¸è®¾ç½®ä»»ä½•ç±»å‹çš„ä»£ç†ã€‚



## CNI

+ [åœ¨å‰é¢æˆ‘ä»¬è®²è¿‡ namespces](./53.md#CNI)
+ [CNI  github](https://github.com/containernetworking/cni)

åœ¨ä»»ä½•Linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ `ip` å‘½ä»¤åˆ›å»ºç½‘ç»œåç§°ç©ºé—´éƒ½éå¸¸å®¹æ˜“ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªä¸åŒçš„ç½‘ç»œåç§°ç©ºé—´ï¼Œå¹¶å°†å®ƒä»¬å‘½åä¸ºclientå’Œserverã€‚

```bash
â¯ ip netns add client
â¯ ip netns add server
â¯ ip netns list
server
client
```

> åˆ é™¤ namespace å‘½ä»¤ï¼š`ip netns delete <namespace_name>`

![image-20230310151650219](http://sm.nsddd.top/sm202303101516295.png)

åˆ›å»º `veth` å¯¹ä»¥è¿æ¥è¿™äº›ç½‘ç»œå‘½åç©ºé—´ã€‚å°† `veth` çº¿å¯¹è§†ä¸ºä¸¤ç«¯éƒ½æœ‰è¿æ¥å™¨çš„ç½‘çº¿ï¼ˆæˆ‘ä»¬åœ¨å‰é¢è®²è¿‡ veth)ã€‚

```bash
â¯ ip link add veth-client type veth peer name veth-server
â¯ ip link list | grep veth
12: veth-server@veth-client: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
13: veth-client@veth-server: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
```

![image-20230310151749562](https://sm.nsddd.top/sm202303101517622.png)

`veth` å¯¹ï¼ˆç”µç¼†ï¼‰å­˜åœ¨äºä¸»æœºç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œç°åœ¨ï¼Œè®©æˆ‘ä»¬å°† `veth` å¯¹çš„ä¸¤ç«¯ç§»åˆ°å‰é¢åˆ›å»ºçš„å®ƒä»¬å„è‡ªçš„åç§°ç©ºé—´ä¸­ã€‚

```bash
â¯ ip link set veth-client netns client
â¯ ip link set veth-server netns server
â¯ ip link list | grep veth # doesnâ€™t exist on the host network namespace now
```

![image-20230310151854318](http://sm.nsddd.top/sm202303101518387.png)

è®©æˆ‘ä»¬éªŒè¯ `veth` ç»“æŸå®é™…ä¸Šå­˜åœ¨äºåç§°ç©ºé—´ä¸­ã€‚æˆ‘ä»¬å°†ä» `client` åç§°ç©ºé—´å¼€å§‹

```bash
â¯ ip netns exec client ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
13: veth-client@if12: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 16:8c:9a:f4:34:5d brd ff:ff:ff:ff:ff:ff link-netns server
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ£€æŸ¥ `server` åç§°ç©ºé—´

```bash
â¯ ip netns exec server ip link
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
12: veth-server@if13: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 4a:36:cf:93:eb:d3 brd ff:ff:ff:ff:ff:ff link-netns client
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸ºè¿™äº›æ¥å£åˆ†é…IPåœ°å€å¹¶å°†å…¶è®¾ç½®ä¸ºå¯ç”¨çŠ¶æ€

```bash
â¯ ip netns exec client ip address add 10.0.0.11/24 dev veth-client
â¯ ip netns exec client ip link set veth-client up
â¯ ip netns exec server ip link set veth-server up
â¯ ip netns exec server ip address add 10.0.0.12/24 dev veth-server
â¯ ip netns exec client ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
13: veth-client@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 16:8c:9a:f4:34:5d brd ff:ff:ff:ff:ff:ff link-netns server
    inet 10.0.0.11/24 scope global veth-client
       valid_lft forever preferred_lft forever
    inet6 fe80::148c:9aff:fef4:345d/64 scope link 
       valid_lft forever preferred_lft forever
```



ç»§ç»­çœ‹æœåŠ¡ç«¯ IPï¼š

```bash
â¯ ip netns exec server ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
12: veth-server@if13: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 4a:36:cf:93:eb:d3 brd ff:ff:ff:ff:ff:ff link-netns client
    inet 10.0.0.12/24 scope global veth-server
       valid_lft forever preferred_lft forever
    inet6 fe80::4836:cfff:fe93:ebd3/64 scope link 
       valid_lft forever preferred_lft forever
```

![image-20230310152215060](http://sm.nsddd.top/sm202303101522150.png)

ä½¿ç”¨pingå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯ä¸¤ä¸ªç½‘ç»œåç§°ç©ºé—´å·²ç»è¿æ¥å¹¶ä¸”å¯ä»¥è®¿é—®ï¼Œ

```bash
â¯ ip netns exec client ping 10.0.0.12
PING 10.0.0.12 (10.0.0.12) 56(84) bytes of data.
64 bytes from 10.0.0.12: icmp_seq=1 ttl=64 time=0.102 ms
64 bytes from 10.0.0.12: icmp_seq=2 ttl=64 time=0.036 ms
64 bytes from 10.0.0.12: icmp_seq=3 ttl=64 time=0.038 ms
64 bytes from 10.0.0.12: icmp_seq=4 ttl=64 time=0.037 ms
```

å¦‚æœæˆ‘ä»¬æƒ³åˆ›å»ºæ›´å¤šçš„ç½‘ç»œåç§°ç©ºé—´å¹¶å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ï¼Œä¸ºåç§°ç©ºé—´çš„æ¯ä¸ªç»„åˆåˆ›å»º `veth` å¯¹å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¯ä¼¸ç¼©çš„è§£å†³æ–¹æ¡ˆã€‚ç›¸åï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªLinuxæ¡¥ï¼Œå¹¶å°†è¿™äº›ç½‘ç»œåç§°ç©ºé—´è¿æ¥åˆ°æ¡¥ä»¥è·å¾—è¿æ¥ã€‚è¿™æ­£æ˜¯Dockeråœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œçš„å®¹å™¨ä¹‹é—´å»ºç«‹ç½‘ç»œçš„æ–¹å¼ï¼

è®©æˆ‘ä»¬åˆ›å»ºåç§°ç©ºé—´å¹¶å°†å…¶é™„åŠ åˆ° bridgeã€‚

![image-20230310152321642](http://sm.nsddd.top/sm202303101523717.png)



### å¦‚ä½•ä»å¤–éƒ¨æœåŠ¡å™¨è®¿é—®ä¸“ç”¨ç½‘ç»œï¼Ÿ

è®©æˆ‘ä»¬ä½¿ç”¨Dockeræ¥æ¨¡æ‹Ÿè¯¥åœºæ™¯ã€‚

```bash
$ docker run -d --name web --rm nginx
$ WEB_IP=`docker inspect -f "{{ .NetworkSettings.IPAddress }}" web`
$ docker inspect web --format '{{ .NetworkSettings.SandboxKey }}'
/var/run/docker/netns/c009f2a4be71
```

ç”±äºDockerä¸ä¼šåœ¨é»˜è®¤ä½ç½®åˆ›å»º `**netns**` ï¼Œå› æ­¤ `**ip netns list**` ä¸ä¼šæ˜¾ç¤ºæ­¤ç½‘ç»œåç§°ç©ºé—´ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæŒ‡å‘é¢„æœŸä½ç½®çš„ç¬¦å·é“¾æ¥æ¥å…‹æœè¿™ä¸ªé™åˆ¶ã€‚

```bash
client$ container_id=web
client$ container_netns=$(docker inspect ${container_id} --format '{{ .NetworkSettings.SandboxKey }}')
client$ mkdir -p /var/run/netns
client$ rm -f /var/run/netns/${container_id}
client$ ln -sv ${container_netns} /var/run/netns/${container_id}
'/var/run/netns/web' -> '/var/run/docker/netns/c009f2a4be71'
client$ ip netns list
web (id: 3)
server1 (id: 1)
client1 (id: 0)
```



æ£€æŸ¥Webåç§°ç©ºé—´ä¸­çš„IPåœ°å€

```bash
$ ip netns exec web ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
11: eth0@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:12:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.18.0.3/24 brd 172.18.0.255 scope global eth0
       valid_lft forever preferred_lft forever
```



æˆ‘ä»¬æ¥æ£€æŸ¥ä¸€ä¸‹Dockerå®¹å™¨ä¸­çš„IPåœ°å€

```bash
$ WEB_IP=`docker inspect -f "{{ .NetworkSettings.IPAddress }}" web`
client$ echo $WEB_IP
172.18.0.3
```

å¾ˆæ˜æ˜¾ï¼ŒDockerä½¿ç”¨æ‰€æœ‰Linuxåç§°ç©ºé—´ï¼Œå¹¶å°†å†…å®¹ä¸ä¸»æœºéš”ç¦»ã€‚è®©æˆ‘ä»¬å°è¯•ä»HOSTæœåŠ¡å™¨è®¿é—®åœ¨webç½‘ç»œåç§°ç©ºé—´ä¸­è¿è¡Œçš„WebAppã€‚

```bash
client$ curl $WEB_IP
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>
<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>
<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

æ˜¯å¦å¯ä»¥ä»å¤–éƒ¨ç½‘ç»œè®¿é—®æ­¤WebæœåŠ¡å™¨ï¼Ÿæ˜¯çš„ï¼Œé€šè¿‡æ·»åŠ ç«¯å£è½¬å‘ã€‚

```bash
$ iptables -t nat -A PREROUTING -p tcp --dport 80 -j 
$ echo $HOST_IP
172.17.0.23
```

è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸»æœºIPåœ°å€è®¿é—®WebæœåŠ¡å™¨ã€‚

```bash
$ curl 172.17.0.23
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>
<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>
<p><em>Thank you for using nginx.</em></p>
</body>
</html>
node01 $
```

![image-20230310162317474](http://sm.nsddd.top/sm202303101623625.png)



### CNI

â€œCNIæ’ä»¶è´Ÿè´£å°†ç½‘ç»œæ¥å£æ’å…¥å®¹å™¨ç½‘ç»œåç§°ç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œvethå¯¹çš„ä¸€ç«¯ï¼‰ï¼Œå¹¶åœ¨ä¸»æœºä¸Šè¿›è¡Œä»»ä½•å¿…è¦çš„æ›´æ”¹ï¼ˆä¾‹å¦‚ï¼Œå°†vethçš„å¦ä¸€ç«¯è¿æ¥åˆ°ç½‘æ¡¥ï¼‰ã€‚ç„¶åï¼Œå®ƒåº”å°†IPåˆ†é…ç»™æ¥å£ï¼Œå¹¶é€šè¿‡è°ƒç”¨ç›¸åº”çš„IPAMæ’ä»¶è®¾ç½®ä¸IPåœ°å€ç®¡ç†éƒ¨åˆ†ä¸€è‡´çš„è·¯ç”±ã€‚â€

CNIï¼ˆå®¹å™¨ç½‘ç»œæ¥å£ï¼‰æ˜¯äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šçš„ä¸€ä¸ªé¡¹ç›®ï¼Œç”±ä¸€ä¸ªè§„èŒƒå’Œåº“ç»„æˆï¼Œç”¨äºç¼–å†™æ’ä»¶æ¥é…ç½®Linuxå®¹å™¨ä¸­çš„ç½‘ç»œæ¥å£ï¼Œæ²¿ç€è®¸å¤šå—æ”¯æŒçš„æ’ä»¶ã€‚CNIåªå…³å¿ƒå®¹å™¨çš„ç½‘ç»œè¿é€šæ€§ï¼Œå¹¶åœ¨åˆ é™¤å®¹å™¨æ—¶ç§»é™¤åˆ†é…çš„èµ„æºã€‚ç”±äºè¿™ä¸€é‡ç‚¹ï¼ŒCNIå¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒï¼Œå¹¶ä¸”è§„èŒƒæ˜“äºå®ç°ã€‚

![image-20230310162410292](http://sm.nsddd.top/sm202303101624384.png)

æ³¨æ„ï¼šè¿è¡Œæ—¶å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿-ä¾‹å¦‚ Kubernetes, PodMan, cloud foundry, etc



### åˆ›å»º CNI

**æ­¥éª¤1ï¼šä¸‹è½½CNIæ’ä»¶**

```bash
client$ mkdir cni
client$ cd cni
client$ curl -O -L https://github.com/containernetworking/cni/releases/download/v0.4.0/cni-amd64-v0.4.0.tgz
client$ tar -xvf cni-amd64-v0.4.0.tgz
```



**æ­¥éª¤2ï¼šåˆ›å»ºJSONæ ¼å¼çš„CNIé…ç½®**

```yaml
cat > /tmp/00-demo.conf <<"EOF"
{
    "cniVersion": "0.2.0",
    "name": "demo_br",
    "type": "bridge",
    "bridge": "cni_net0",
    "isGateway": true,
    "ipMasq": true,
    "ipam": {
        "type": "host-local",
        "subnet": "10.0.10.0/24",
        "routes": [
            { "dst": "0.0.0.0/0" },
            { "dst": "1.1.1.1/32", "gw":"10.0.10.1"}
        ]
    }
}
EOF
```



**CNIé…ç½®å‚æ•°**

```
-:CNI generic parameters:-
cniVersion: The version of the CNI spec in which the definition works with
name: The network name
type: The name of the plugin you wish to use.  In this case, the actual name of the plugin executable
args: Optional additional parameters
ipMasq: Configure outbound masquerade (source NAT) for this network
ipam:
    type: The name of the IPAM plugin executable
    subnet: The subnet to allocate out of (this is actually part of the IPAM plugin)
    routes:
        dst: The subnet you wish to reach
        gw: The IP address of the next hop to reach the dst.  If not specified the default gateway for the subnet is assumed
dns:
    nameservers: A list of nameservers you wish to use with this network
    domain: The search domain to use for DNS requests
    search: A list of search domains
    options: A list of options to be passed to the receiver
```



æ­¥éª¤3ï¼šåˆ›å»ºä¸€ä¸ªç½‘ç»œä¸ºâ€œ**none**â€çš„å®¹å™¨ï¼Œè¿™æ ·å®¹å™¨å°±ä¸ä¼šæœ‰ä»»ä½•IPåœ°å€å¯ä¾›ä½¿ç”¨ã€‚æ‚¨å¯ä»¥ä¸ºè¿™ä¸ªå®¹å™¨ä½¿ç”¨ä»»ä½•å›¾åƒï¼Œä½†æ˜¯ï¼Œæˆ‘ä½¿ç”¨'**pause**'å®¹å™¨æ¥æ¨¡æ‹ŸKubernetesã€‚

```bash
controlplane $ docker run --name pause_demo -d --rm --network none kubernetes/pause
controlplane $ container_id=pause_demo
controlplane $ container_netns=$(docker inspect ${container_id} --format '{{ .NetworkSettings.SandboxKey }}')
controlplane $ mkdir -p /var/run/netns
controlplane $ rm -f /var/run/netns/${container_id}
controlplane $ ln -sv ${container_netns} /var/run/netns/${container_id}
'/var/run/netns/pause_demo' -> '/var/run/docker/netns/0297681f79b5'
controlplane $ ip netns list
pause_demo
controlplane $ ip netns exec $container_id ifconfig
lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 erbashrors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
```



**æ­¥éª¤4ï¼šä½¿ç”¨CNIé…ç½®æ–‡ä»¶è°ƒç”¨CNIæ’ä»¶**

```bash
$ CNI_CONTAINERID=$container_id CNI_IFNAME=eth10 CNI_COMMAND=ADD CNI_NETNS=/var/run/netns/$container_id CNI_PATH=`pwd` ./bridge </tmp/00-demo.conf
2020/10/17 17:32:37 Error retriving last reserved ip: Failed to retrieve last reserved ip: open /var/lib/cni/networks/demo_br/last_reserved_ip: no such file or directory
{
    "ip4": {
        "ip": "10.0.10.2/24",
        "gateway": "10.0.10.1",
        "routes": [
            {
                "dst": "0.0.0.0/0"
            },
            {
                "dst": "1.1.1.1/32",
                "gw": "10.0.10.1"
            }
        ]
    },
    "dns": {}
```



## END é“¾æ¥

<ul><li><div><a href = '57.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '59.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 



