+ [author](http://nsddd.top)

# ç¬¬15èŠ‚ k3s è¡¥å……

<div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

[TOC]



::: danger 
é¡µé¢å†…å®¹å¤ªå¤šå¡é¡¿ï¼Œæ–°å¼€ååŠéƒ¨åˆ†è¡¥å……~

+ [k3s vs k0s](https://docker.nsddd.top/Cloud-Native/7.html)

:::



## èµ„æºåˆ†æ

èµ„æºå ç”¨ç‡ä½æ˜¯ k3s çªå‡ºçš„ç‰¹ç‚¹ï¼Œé’ˆå¯¹ k3s ç‰¹æ€§ï¼Œåˆ†æèµ„æºçš„å ç”¨ï¼š



**å½±å“èµ„æºåˆ©ç”¨ç‡çš„å› ç´ ï¼š**

- `K3s server`ï¼šK3s server çš„åˆ©ç”¨ç‡æ•°æ®ä¸»è¦æ˜¯ç”±æ”¯æŒ Kubernetes æ•°æ®å­˜å‚¨ï¼ˆkine æˆ– etcdï¼‰ã€API Serverã€Controller-Manager å’Œ Scheduler æ§åˆ¶ã€‚ **åˆ›å»º/ä¿®æ”¹/åˆ é™¤** èµ„æºå°†å¯¼è‡´æš‚æ—¶çš„åˆ©ç”¨ç‡ä¸Šå‡ã€‚å¤§é‡ä½¿ç”¨ Kubernetes æ•°æ®å­˜å‚¨çš„ operators æˆ–åº”ç”¨ç¨‹åºä¹Ÿå°†å¢åŠ  server çš„èµ„æºéœ€æ±‚ã€‚

- `K3s agent`ï¼šç®¡ç†é•œåƒã€æä¾› **å­˜å‚¨æˆ–åˆ›å»º/é”€æ¯å®¹å™¨** çš„æ“ä½œå°†å¯¼è‡´åˆ©ç”¨ç‡çš„æš‚æ—¶ä¸Šå‡ï¼Œæ‹‰å–é•œåƒé€šå¸¸ä¼šå½±å“ CPU å’Œ IOï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠå°†é•œåƒå†…å®¹è§£å‹åˆ°ç£ç›˜ã€‚å¦‚æœå¯èƒ½çš„è¯ï¼Œå·¥ä½œè´Ÿè½½å­˜å‚¨(pod ä¸´æ—¶å­˜å‚¨å’Œå·)åº”è¯¥ä¸ agent ç»„ä»¶( `/var/lib/rancher/k3s/agent` )éš”ç¦»ï¼Œä»¥ç¡®ä¿ä¸ä¼šå‡ºç°èµ„æºå†²çªã€‚



**é˜²æ­¢ agent å’Œå·¥ä½œè´Ÿè½½å¹²æ‰°é›†ç¾¤æ•°æ®å­˜å‚¨ï¼š**

+ åœ¨ `server` èŠ‚ç‚¹è¿è¡Œå·¥ä½œè´Ÿè½½ pod æ—¶ï¼Œåº”ç¡®ä¿ `agent` å’Œå·¥ä½œè´Ÿè½½ `IOPS` ä¸å¹²æ‰°æ•°æ®å­˜å‚¨ã€‚

+ å°† `server` ç»„ä»¶ï¼ˆ`/var/lib/rancher/k3s/server`ï¼‰ä¸ `agent` ç»„ä»¶ï¼ˆ`/var/lib/rancher/k3s/agent`ï¼‰æ”¾åœ¨ä¸åŒçš„å­˜å‚¨ä»‹è´¨ä¸Šï¼Œåè€…åŒ…æ‹¬ `containerd` é•œåƒå­˜å‚¨ã€‚

+ å·¥ä½œè´Ÿè½½å­˜å‚¨ï¼ˆ`pod` ä¸´æ—¶å­˜å‚¨å’Œå·ï¼‰ä¹Ÿåº”è¯¥ä¸æ•°æ®å­˜å‚¨éš”ç¦»ã€‚



### /usr/local/bin é‡è¦äºŒè¿›åˆ¶

::: tip 
åé¢çš„æµ‹è¯•éƒ½æ˜¯å’Œ `/usr/local/bin` æ¯æ¯ç›¸å…³ï¼Œå°±æ¯”å¦‚è¯´æ¯ä¸€æ¬¡æµ‹è¯•åˆ é™¤ï¼š

```bash
/usr/local/bin/k3s-uninstall.sh 
```

**åŒæ ·çš„è¿˜æœ‰åœæ­¢ k3sï¼š**

ä¸ºäº†åœ¨å‡çº§æœŸé—´å®ç°é«˜å¯ç”¨æ€§ï¼ŒK3s å®¹å™¨åœ¨ K3s æœåŠ¡åœæ­¢æ—¶ä¼šç»§ç»­è¿è¡Œã€‚

```bash
/usr/local/bin/k3s-killall.sh
```

killall è„šæœ¬èƒ½æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶è¿˜èƒ½åˆ é™¤ iptables é“¾ä»¥åŠæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚

 ğŸ„â€â™‚ï¸ åŒæ ·å¯ä»¥ä½¿ç”¨ `systemctl start k3s` ï¼Œç›®å‰å‘ç°æ•ˆæœä¸€æ ·ï¼Œå¦‚æœä½ è§‰å¾—ä¸ä¸€æ ·ï¼Œè”ç³»ä¸‹æˆ‘~

**å½“ç„¶ k3s éƒ½æ˜¯å›´ç»•ç€ k3s è„šæœ¬ä¸ºä¸­å¿ƒçš„ï¼š**

:::



## è„šæœ¬å®‰è£…é€‰é¡¹

::: tip 
æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†å…³äºè„šæœ¬çš„é€‰é¡¹ä¸¤ç§æ–¹å¼ï¼Œ**ç¯å¢ƒå˜é‡** æˆ–è€… **æ ‡å¿—** ã€‚

âš ï¸ æ³¨æ„ï¼Œå¦‚æœä½ é€‰æ‹© **ä¸‹è½½install.sh** ä½¿ç”¨ https://ghproxy.com ï¼Œåé¢çš„æ‰€æœ‰è„šæœ¬æˆ‘éƒ½æ˜¯ä½¿ç”¨ï¼š

```bash
INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYMLINK=skip  sh install.sh
```

ä»¥ "K3S_"å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚

åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½®`K3S_URL`ï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º "agent"ã€‚

è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½®`K3S_TOKEN`ã€‚

:::



`INSTALL_K3S_SKIP_DOWNLOAD` -- (ç”¨äºç¦»çº¿å®‰è£…) å¦‚æœè®¾ç½®ä¸º "true "å°†ä¸ä¼šä¸‹è½½ K3s çš„å“ˆå¸Œå€¼æˆ–äºŒè¿›åˆ¶ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
    INSTALL_K3S_SKIP_DOWNLOAD=true \
    sh -
```



`INSTALL_K3S_SYMLINK` -- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè·¯å¾„ä¸­ä¸å­˜åœ¨å‘½ä»¤ï¼Œå°†ä¸º `kubectl`ã€`crictl` å’Œ `ctr` äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»ºç¬¦å·é“¾æ¥ã€‚å¦‚æœè®¾ç½®ä¸º `'skip'` å°†ä¸ä¼šåˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè€Œ `'force'` å°†è¦†ç›–ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYMLINK=skip \
  sh -
```

> **æµ‹è¯•(é»˜è®¤æƒ…å†µï¼‰ï¼š**
>
> ```bash
> root@etcnode01:/usr/local/bin# ls -al
> total 66164
> drwxr-xr-x  2 root root     4096 Nov 26 09:40 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 crictl -> k3s
> -rwxr-xr-x  1 root root 67735552 Nov 26 06:19 k3s
> -rwxr-xr-x  1 root root     1433 Nov 26 06:19 k3s-agent-uninstall.sh
> -rwxr-xr-x  1 root root     2026 Nov 26 06:19 k3s-killall.sh
> lrwxrwxrwx  1 root root        3 Nov 26 06:19 kubectl -> k3s
> ```
>
> 
>
> **æµ‹è¯•ï¼ˆæŒ‡å®šç¯å¢ƒå˜é‡ï¼‰ï¼š**
>
> ```bash
> root@cubmaster01:/usr/local/bin# ls -al
> total 66168
> drwxr-xr-x  2 root root     4096 Nov 26 11:16 .
> drwxr-xr-x 10 root root     4096 Aug 31 06:52 ..
> -rwxr-xr-x  1 root root 67735552 Nov 26 11:16 k3s
> -rwxr-xr-x  1 root root     2026 Nov 26 11:16 k3s-killall.sh
> -rwxr-xr-x  1 root root     1397 Nov 26 11:16 k3s-uninstall.sh
> ```

::: warning æ³¨æ„
âš ï¸ æˆ‘åœ¨ä¸Šä¸€èŠ‚ä»‹ç»äº†ä½¿ç”¨ **åˆ«å** ï¼Œå®ƒå¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚
:::

 

`INSTALL_K3S_SKIP_ENABLE` -- å¦‚æœè®¾ç½®ä¸º "true"ï¼Œå°†ä¸å¯ç”¨æˆ–å¯åŠ¨ K3s æœåŠ¡ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_ENABLE=true \
  sh -
```

> **å¼€å¯ï¼š**
>
> ```bash
> systemctl start k3s
> kubectl get nodes
> ```



`INSTALL_K3S_SKIP_START` -- å¦‚æœè®¾ç½®ä¸º "true "å°†ä¸ä¼šå¯åŠ¨ K3s æœåŠ¡ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_START=true \
  sh -
```



`INSTALL_K3S_VERSION` -- ä» Github ä¸‹è½½ K3s çš„ç‰ˆæœ¬ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°†å°è¯•ä»"stable"é¢‘é“ä¸‹è½½ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_VERSION="v1.19.9+k3s1" \
  sh -
```

> æ³¨æ„åé¢æ˜¯ `+`



`INSTALL_K3S_BIN_DIR` -- å®‰è£… K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€é“¾æ¥å’Œå¸è½½è„šæœ¬çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨ `/usr/local/bin` ä½œä¸ºé»˜è®¤ç›®å½•ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR=/opt/bin \
  sh -
```

::: danger
è¿™é‡Œæœ‰ä¸ªå‘ï¼Œå®ƒçµ¦è®¾ç½® äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œä½†æ˜¯ä¸ç»™æ”¹å˜ç¯å¢ƒå˜é‡è·¯å¾„~

ä¸€ä¸ª idea ï¼šå¦‚æœæˆ‘ä»¬åˆ›å»ºçš„ hash ç›®å½•ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥å°† roofs è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œå°±æ¯”å¦‚è¯´ `cd ~k3s`   OR   `cd $K3S`

æˆ‘ä»¬åªéœ€è¦æ‹¿åˆ° hash è·¯å¾„  `export K3S="/var/lib/rancher/k3s/data/${HASH}/bin"`

:::



`INSTALL_K3S_BIN_DIR_READ_ONLY` -- å¦‚æœè®¾ç½®ä¸º true å°†ä¸ä¼šæŠŠæ–‡ä»¶å†™å…¥INSTALL_K3S_BIN_DIRï¼Œå¼ºåˆ¶è®¾ç½®INSTALL_K3S_SKIP_DOWNLOAD=trueã€‚

`INSTALL_K3S_SKIP_DOWNLOAD` ä¼šåˆ›å»º `kubectl/crictl/ctr` ç­‰ï¼Œè€Œ `INSTALL_K3S_BIN_DIR_READ_ONLY` ä¸åˆ›å»ºã€‚

```sh
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_BIN_DIR_READ_ONLY=true \
  sh -
```



`INSTALL_K3S_SYSTEMD_DIR` -- å®‰è£… systemd æœåŠ¡å’Œç¯å¢ƒæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–è€…ä½¿ç”¨/etc/systemd/system ä½œä¸ºé»˜è®¤ç›®å½•ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SYSTEMD_DIR=/opt/systemd \
  sh -
```

::: tip æµ‹è¯•

```bash
root@cubmaster01:/workspces/runtime# INSTALL_K3S_MIRROR=cn   INSTALL_K3S_SYSTEMD_DIR=/opt/systemd sh install.sh 
root@cubmaster01:/opt/systemd# ls -al
total 12
drwxr-xr-x 2 root root 4096 Nov 26 11:53 .
drwxr-xr-x 6 root root 4096 Nov 26 11:51 ..
-rw-r--r-- 1 root root  829 Nov 26 11:53 k3s.service
-rw------- 1 root root    0 Nov 26 11:53 k3s.service.env
```

:::





`INSTALL_K3S_EXEC` -- å¸¦æœ‰æ ‡å¿—çš„å‘½ä»¤ï¼Œç”¨äºåœ¨æœåŠ¡ä¸­å¯åŠ¨ K3sã€‚**å¦‚æœæœªæŒ‡å®šå‘½ä»¤ï¼Œå¹¶ä¸”è®¾ç½®äº† K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œagentâ€ã€‚å¦‚æœæœªè®¾ç½® K3S_URLï¼Œå®ƒå°†é»˜è®¤ä¸ºâ€œserverâ€ã€‚**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

**æœ€åçš„ systemd å‘½ä»¤è§£æä¸ºè¿™ä¸ªç¯å¢ƒå˜é‡å’Œè„šæœ¬å‚æ•°çš„ç»„åˆã€‚**ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹å‘½ä»¤çš„ç»“æœä¸æ³¨å†Œä¸€ä¸ªæ²¡æœ‰ flannel çš„ server çš„è¡Œä¸ºç›¸åŒï¼š

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --flannel-backend none" sh -s -
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server" sh -s - --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - server --flannel-backend none
curl -sfL https://get.k3s.io | sh -s - --flannel-backend none
```



`INSTALL_K3S_NAME` -- è¦åˆ›å»ºçš„ `systemd` æœåŠ¡åç§°ï¼Œå¦‚æœä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œ k3sï¼Œåˆ™é»˜è®¤ä¸º `'k3s'`ï¼›å¦‚æœä»¥ `agent` æ–¹å¼è¿è¡Œ `k3s`ï¼Œåˆ™é»˜è®¤ä¸º `'k3s-agent'` ã€‚å¦‚æœæŒ‡å®šäº†æœåŠ¡åï¼Œåˆ™æœåŠ¡åå°†ä»¥ `'k3s-'` ä¸ºå‰ç¼€ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_NAME="seal" \
  sh -
```



`INSTALL_K3S_TYPE` -- è¦åˆ›å»ºçš„ systemd æœåŠ¡ç±»å‹ï¼Œé»˜è®¤ä¸º notify

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_TYPE="exec" \
  sh -
```



`INSTALL_K3S_SKIP_SELINUX_RPM` -- å¦‚æœè®¾ç½®ä¸º `"true "` å°†è·³è¿‡ `k3s RPM` çš„è‡ªåŠ¨å®‰è£…ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_SKIP_SELINUX_RPM=true \
  sh -
```



::: tip K3s RPM
[å®‰å…¨å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰](https://en.wikipedia.org/wiki/Security-Enhanced_Linux)æ˜¯å¯¹ Linux çš„å®‰å…¨å¢å¼ºã€‚

å®ƒç”± Red Hat å¼€å‘ï¼Œæ˜¯ Linux ä¸Šå¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰çš„ä¸€ä¸ªå®ç°ã€‚å¼ºåˆ¶æ€§è®¿é—®æ§åˆ¶å…è®¸ç³»ç»Ÿç®¡ç†å‘˜å®šä¹‰åº”ç”¨ç¨‹åºå’Œç”¨æˆ·å¦‚ä½•è®¿é—®ä¸åŒçš„èµ„æºï¼Œå¦‚æ–‡ä»¶ã€è®¾å¤‡ã€ç½‘ç»œå’Œè¿›ç¨‹é—´é€šä¿¡ã€‚SELinux è¿˜é€šè¿‡ä½¿æ“ä½œç³»ç»Ÿåœ¨é»˜è®¤æƒ…å†µä¸‹å…·æœ‰é™åˆ¶æ€§è€Œå¢å¼ºäº†å®‰å…¨æ€§ã€‚

åœ¨å†å²ä¸Šè¢«æ”¿åºœæœºæ„ä½¿ç”¨åï¼ŒSELinux ç°åœ¨æ˜¯è¡Œä¸šæ ‡å‡†ï¼Œåœ¨ CentOS 7 å’Œ 8 ä¸Šé»˜è®¤å¯ç”¨ã€‚è¦æ£€æŸ¥ SELinux æ˜¯å¦åœ¨ä½ çš„ç³»ç»Ÿä¸Šå¯ç”¨å’Œæ‰§è¡Œï¼Œè¯·ä½¿ç”¨`getenforce`ã€‚

```bash
getenforce
Enforcing
```

:::



`INSTALL_K3S_CHANNEL_URL` -- ç”¨äºè·å– K3s ä¸‹è½½ç½‘å€çš„é¢‘é“ URLã€‚é»˜è®¤ä¸º https://update.k3s.io/v1-release/channels ã€‚

`INSTALL_K3S_CHANNEL` -- ç”¨äºè·å– K3s ä¸‹è½½ URL çš„é€šé“ã€‚é»˜è®¤å€¼ä¸º "stable"ã€‚é€‰é¡¹åŒ…æ‹¬ï¼š`stable`, `latest`, `testing`ã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_CHANNEL="latest" \
  sh -
```



`K3S_CONFIG_FILE` -- æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚é»˜è®¤ç›®å½•ä¸º`/etc/rancher/k3s/config.yaml`ã€‚

::: tip æˆ‘ä»¬å…ˆæŒ‡å®šä¸‹æ–‡ä»¶ï¼š

```bash
cat >> /opt/config.yaml <<-EOF
node-label:
- "foo=bar"
- "something=amazing"
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_CONFIG_FILE=/opt/config.yaml \
  sh -
```

![image-20221126211751303](http://sm.nsddd.top/smimage-20221126211751303.png)





`K3S_TOKEN` -- ç”¨äºå°† server æˆ– agent åŠ å…¥é›†ç¾¤çš„å…±äº« secretã€‚

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN=rancher-k3s \
  sh -
```

::: tip å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®

```bash
cat /var/lib/rancher/k3s/server/token
K1042465c14be8de6a57c482b4162f673addcb652acb13c8119a9900b5d27c234f7::server:rancher-k3s
```

:::



`K3S_TOKEN_FILE` -- æŒ‡å®š `cluster-secret`,`token` çš„æ–‡ä»¶ç›®å½•ã€‚

::: tip æˆ‘ä»¬éœ€è¦å…ˆæŒ‡å®šæ–‡ä»¶

```bash
cat >> /opt/token.txt <<-EOF
rancher-k3s
EOF
```

:::

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_TOKEN_FILE=/opt/token.txt \
  sh -
```

::: tip å¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°å®ƒçš„ä½ç½®

```bash
root@cubmaster01:/workspces/runtime# cat /var/lib/rancher/k3s/server/token
K10fbe884032e42976a1dd419e5d171b9bc38d50e13dc852afbc97ffb99c765f06e::server:rancher-k3s
```

:::



### æ€»ç»“

::: tip

1. ä»¥ "K3S\_"å¼€å¤´çš„ç¯å¢ƒå˜é‡å°†è¢«ä¿ç•™ï¼Œä¾› systemd å’Œ openrc æœåŠ¡ä½¿ç”¨ã€‚
2. åœ¨æ²¡æœ‰æ˜ç¡®è®¾ç½® exec å‘½ä»¤çš„æƒ…å†µä¸‹è®¾ç½® K3S_URLï¼Œä¼šå°†å‘½ä»¤é»˜è®¤ä¸º "agent"ã€‚
3. è¿è¡Œ agent æ—¶è¿˜å¿…é¡»è®¾ç½® K3S_TOKENã€‚

:::



##  å¯¹äºŒè¿›åˆ¶çš„å®‰è£…é«˜çº§è¡¥å……

å®‰è£…è„šæœ¬ä¸»è¦æ˜¯é…ç½® K3s ä½œä¸ºæœåŠ¡è¿è¡Œã€‚å¦‚æœä½ é€‰æ‹©ä¸ä½¿ç”¨è„šæœ¬ï¼Œä½ å¯ä»¥é€šè¿‡ [å‘å¸ƒé¡µé¢](https://github.com/rancher/k3s/releases/latest)ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨ä½ çš„ç¯å¢ƒå˜é‡è·¯å¾„ä¸Šï¼Œç„¶åæ‰§è¡Œå®ƒæ¥è¿è¡Œ K3sã€‚K3s äºŒè¿›åˆ¶æ”¯æŒä»¥ä¸‹å‘½ä»¤ï¼š

`k3s server` -- è¿è¡Œ K3s serverï¼Œå®ƒè¿˜å°†å¯åŠ¨ Kubernetes control-plane ç»„ä»¶ï¼Œå¦‚ API server, controller-manager, å’Œ schedulerã€‚

> å’Œ kubernetes çš„æ§åˆ¶å±‚é¢å¾ˆç±»ä¼¼~

```bash
root@cubmaster01:/workspces/runtime# k3s server
INFO[0000] Acquiring lock file /var/lib/rancher/k3s/data/.lock 
INFO[0000] Preparing data dir /var/lib/rancher/k3s/data/2ef87ff954adbb390309ce4dc07500f29c319f84feec1719bfb5059c8808ec6a 
INFO[0000] Starting k3s v1.25.3+k3s1 (f2585c16)         
INFO[0000] Configuring sqlite3 database connection pooling: maxIdleConns=2, maxOpenConns=0, connMaxLifetime=0s 
INFO[0000] Configuring database table schema and indexes, this may take a moment... 
INFO[0000] Database tables and indexes are up to date   
INFO[0000] Kine available at unix://kine.sock 
......
```



`k3s agent` -- è¿è¡Œ `K3s agent` èŠ‚ç‚¹ã€‚è¿™å°†ä½¿ `K3s` ä½œä¸ºå·¥ä½œèŠ‚ç‚¹è¿è¡Œï¼Œå¯åŠ¨ `Kubernetes` èŠ‚ç‚¹æœåŠ¡ `kubelet` å’Œ `kube-proxy`ã€‚

```
root@etcnode01:~# k3s agent --server https://192.168.71.130:6443 --token K10fcaced71fc70ca6b77921a7e374dc03c34fdd1fb11973d69a2a8e937b61beb22::server:82c397ed440c496f5448ec3c4b11c112
INFO[0000] Starting k3s agent v1.25.4+k3s1 (0dc63334)   
INFO[0000] Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [192.168.71.130:6443] 
ERRO[0004] failed to get CA certs: Get "https://127.0.0.1:6444/cacerts": read tcp 127.0.0.1:60386->127.0.0.1:6444: read: connection reset by peer 
......
```

> ```bash
> root@cubmaster01:/opt# k3s kubectl get nodes
> NAME          STATUS   ROLES                  AGE   VERSION
> cubmaster01   Ready    control-plane,master   96m   v1.25.3+k3s1
> cubnode02     Ready    <none>                 52m   v1.25.4+k3s1
> etcnode01     Ready    <none>                 67m   v1.25.4+k3s1
> ```



`k3s kubectl` -- è¿è¡ŒåµŒå…¥å¼ kubectl CLIã€‚å¦‚æœæ²¡æœ‰è®¾ç½® KUBECONFIG ç¯å¢ƒå˜é‡ï¼Œå½“å¯åŠ¨ K3s æœåŠ¡å™¨èŠ‚ç‚¹æ—¶ï¼Œå°†è‡ªåŠ¨å°è¯•ä½¿ç”¨åœ¨`/etc/rancher/k3s/k3s.yaml` åˆ›å»ºçš„é…ç½®æ–‡ä»¶ã€‚

```bash
root@k3s1:~# k3s kubectl get nodes
NAME   STATUS   ROLES                  AGE     VERSION
k3s1   Ready    control-plane,master   8m14s   v1.20.5+k3s1
k3s2   Ready    <none                11s     v1.20.5+k3s1
```



`k3s crictl` -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼ crictlã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºä¸ Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼ˆCRIï¼‰äº¤äº’çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚

```bash
root@k3s1:~# k3s crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                     ATTEMPT             POD ID
9ceb610df16c7       aa764f7db3051       8 minutes ago       Running             traefik                  0                   373c79416fa65
cadceb62ae08d       897ce3c5fc8ff       8 minutes ago       Running             lb-port-443              0                   f8a0ecfe56562
a26a49be485ac       897ce3c5fc8ff       8 minutes ago       Running             lb-port-80               0                   f8a0ecfe56562
01894072f2298       148c192562719       8 minutes ago       Running             local-path-provisioner   1                   b9d55e63f632f
5ccd6ed05120f       296a6d5035e2d       9 minutes ago       Running             coredns                  0                   2bae007d8e486
be0765e77a703       9dd718864ce61       9 minutes ago       Running             metrics-server           0                   53ab949c026ce
```



`k3s ctr` -- è¿è¡Œä¸€ä¸ªåµŒå…¥å¼çš„ ctrã€‚è¿™æ˜¯ä¸º containerdï¼ˆK3s ä½¿ç”¨çš„å®¹å™¨å®ˆæŠ¤è¿›ç¨‹ï¼‰æä¾›çš„ CLIã€‚å¯¹è°ƒè¯•å¾ˆæœ‰ç”¨ã€‚

```bash
root@k3s1:~# k3s ctr container ls
CONTAINER                                                           IMAGE                                                                                                               RUNTIME
01894072f2298208f3c109f9fb1d5e12e677d11cd5d0b0a3a66f550ae38644e4    docker.io/rancher/local-path-provisioner:v0.0.19                                                                    io.containerd.runc.v2
2bae007d8e486afffbbf1ffb88e97b92d367aff4b06842217de4fb5d22ecf1b9    docker.io/rancher/pause:3.1
```

`k3s server` å’Œ `k3s agent` å‘½ä»¤æœ‰é¢å¤–çš„é…ç½®é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡ `k3s server --help` æˆ– `k3s agent --help` æŸ¥çœ‹ã€‚



## é€šè¿‡é…ç½®æ–‡ä»¶å¯åŠ¨ K3s

é™¤äº†ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œ CLI å‚æ•°æ¥é…ç½® K3sï¼ŒK3s è¿˜å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶ã€‚é»˜è®¤ç›®å½•ä½äº `/etc/rancher/k3s/config.yaml`ï¼ˆæˆ–è€…æ˜¯ `k3s.yaml` æ–‡ä»¶ï¼‰

::: warning æç¤º
å¦‚æœåŒæ—¶ä½¿ç”¨é…ç½®æ–‡ä»¶å’Œ CLI å‚æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå€¼å°†ä»ä¸¤ä¸ªæ¥æºåŠ è½½ï¼Œä½† CLI å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ã€‚ å¯¹äºå¯é‡å¤çš„å‚æ•°ï¼Œå¦‚--node-labelï¼ŒCLI å‚æ•°å°†è¦†ç›–åˆ—è¡¨ä¸­çš„æ‰€æœ‰å€¼ã€‚
:::



## K3s Server/Agent é…ç½®

**`write-kubeconfig` -- å°†ç®¡ç†å®¢æˆ·ç«¯çš„ kubeconfig å†™å…¥è¿™ä¸ªæ–‡ä»¶**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  K3S_KUBECONFIG_OUTPUT=/root/.kube/config \
  sh -
```



**ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--docker" \
  sh -
```

::: tip æµ‹è¯•

```bash
root@cubmaster01:/workspces/runtime# docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED              STATUS              PORTS     NAMES
9e9e8cd5eb22   rancher/mirrored-library-traefik   "/entrypoint.sh --glâ€¦"   14 seconds ago       Up 12 seconds                 k8s_traefik_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
8fb6d8f2c3dc   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-443_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6033d7ecc824   dbd43b6716a0                       "entry"                  32 seconds ago       Up 31 seconds                 k8s_lb-tcp-80_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
6b95dbafc4ee   rancher/mirrored-pause:3.6         "/pause"                 32 seconds ago       Up 31 seconds                 k8s_POD_traefik-bb69b68cd-ps2j6_kube-system_4905ff4a-b161-498e-b1d4-fed57a5d65a8_0
b13f33df38d9   rancher/mirrored-pause:3.6         "/pause"                 33 seconds ago       Up 31 seconds                 k8s_POD_svclb-traefik-59fdd98e-vjxlk_kube-system_4a45d7e2-5af8-4a48-99c4-1057c5ba96b0_0
5e8ce9d7d95e   rancher/mirrored-coredns-coredns   "/coredns -conf /etcâ€¦"   51 seconds ago       Up 50 seconds                 k8s_coredns_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_1
03db38691203   rancher/local-path-provisioner     "local-path-provisioâ€¦"   56 seconds ago       Up 55 seconds                 k8s_local-path-provisioner_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_1
9b087eb2f2d0   e57a417f15d3                       "/metrics-server --câ€¦"   About a minute ago   Up About a minute             k8s_metrics-server_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_1
a1ead6d83564   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_coredns-597584b69b-sn7n2_kube-system_d778542c-14b4-4c25-bc1f-b8b525a662a2_0
7a1020d7a01f   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_local-path-provisioner-79f67d76f8-prcsc_kube-system_45729047-9cc5-4d39-9f9b-9c99d9dfefb7_0
cd0e940354a9   rancher/mirrored-pause:3.6         "/pause"                 About a minute ago   Up About a minute             k8s_POD_metrics-server-5c8978b444-bw47f_kube-system_b820f87d-9063-49a8-9ed9-5c501e11f88a_0

```

:::



**é’ˆå¯¹å¤šç½‘å¡ä¸»æœºå®‰è£… K3s é›†ç¾¤**

**k3s server:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
INSTALL_K3S_EXEC="--node-ip=192.168.99.211" \
sh -
```



**K3s agent:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
K3S_URL=https://192.168.99.211:6443 \
K3S_TOKEN=xiongxinwei \
INSTALL_K3S_EXEC="--node-ip=192.168.99.212" \
sh -
```



**--tls-san -- åœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC="--tls-san 3.97.6.45"  \
  sh -
```



ä¿®æ”¹`kube-apiserver`ã€`kube-scheduler` ã€`kube-controller-manager`ã€ `kube-cloud-controller-manager`ã€ `kubelet`ã€ `kube-proxy` å‚æ•°

**kubelet-argï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kubelet-arg=max-pods=200' \
  sh -
```



**kube-apiserverï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-apiserver-arg=service-node-port-range=40000-50000' \
  sh -
```



**kube-proxy-argï¼š**

```bash
 curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--kube-proxy-arg=proxy-mode=ipvs' \
  sh -
```



**`--data-dir -- K3s` æ•°æ®å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸º `/var/lib/rancher/k3s` æˆ– `${HOME}/.rancher/k3s`(å¦‚æœä¸æ˜¯ root ç”¨æˆ·)**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--data-dir=/opt/k3s-data' \
  sh -
```

::: tip 
è¿™å°±æœ‰ç‚¹æ„æ€äº†ï¼Œæˆ‘ä»¬é»˜è®¤çš„å®‰è£…è¿ç§»äº†ï¼š

```bash
root@cubmaster01:/opt/k3s-data/server# cd /opt/k3s-data/;ls
agent  server
```

**å½“ç„¶ï¼Œæˆ‘ä»¬è‡ªå·±è®¾è®¡ç›®å½•ç»“æ„çš„æ—¶å€™æˆ–è®¸å¯ä»¥ç”¨åˆ°~**

:::



**ç¦ç”¨ç»„ä»¶ --disableï¼š**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--disable traefik' \
  sh -
```



::: tip
**ç¦ç”¨å‰ï¼š**

```bash
[root@VM-4-6-centos k3s]# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml  traefik.yaml
```



**ç¦ç”¨åï¼š**

```bash
root@cubmaster01:/workspces/runtime# ls /var/lib/rancher/k3s/server/manifests
ccm.yaml  coredns.yaml  local-storage.yaml  metrics-server  rolebindings.yaml
root@cubmaster01:/workspces/runtime# kubectl get pods -A | grep traefik
```

:::



**æ·»åŠ  label å’Œ taint:**

```bash
curl -sfL https://get.k3s.io | INSTALL_K3S_MIRROR=cn \
  INSTALL_K3S_EXEC='--node-label foo=bar,hello=world --node-taint key1=value1:NoExecute' \
  sh -
```



## ç½‘ç»œé€‰é¡¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œ`K3s` å°†ä»¥ `flannel` ä½œä¸º `CNI` è¿è¡Œï¼Œä½¿ç”¨ `VXLAN` ä½œä¸ºé»˜è®¤åç«¯ã€‚`CNI`å’Œé»˜è®¤åç«¯éƒ½å¯ä»¥é€šè¿‡å‚æ•°ä¿®æ”¹ã€‚

### Flannel é€‰é¡¹

Flannel çš„é»˜è®¤åç«¯æ˜¯ VXLANã€‚è¦å¯ç”¨åŠ å¯†ï¼Œè¯·ä½¿ç”¨ä¸‹é¢çš„ IPSecï¼ˆInternet Protocol Securityï¼‰æˆ– WireGuard é€‰é¡¹ã€‚

| CLI Flag å’Œ Value             | æè¿°                                                         |
| :---------------------------- | :----------------------------------------------------------- |
| `--flannel-backend=vxlan`     | (é»˜è®¤) ä½¿ç”¨ VXLAN åç«¯ã€‚                                     |
| `--flannel-backend=ipsec`     | ä½¿ç”¨ IPSEC åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚                        |
| `--flannel-backend=host-gw`   | ä½¿ç”¨ host-gw åç«¯ã€‚                                          |
| `--flannel-backend=wireguard` | ä½¿ç”¨ WireGuard åç«¯ï¼Œå¯¹ç½‘ç»œæµé‡è¿›è¡ŒåŠ å¯†ã€‚å¯èƒ½éœ€è¦é¢å¤–çš„å†…æ ¸æ¨¡å—å’Œé…ç½®ã€‚ |



### flannel-backend ä½¿ç”¨ `host-gw`

```bash
# K3s master
root@k3s1:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_EXEC="--flannel-backend=host-gw" \
        INSTALL_K3S_MIRROR=cn sh -

# K3s agent 
root@k3s2:~# curl -sfL https://get.k3s.io | \
        INSTALL_K3S_MIRROR=cn K3S_URL=https://172.16.64.6:6443 \
        K3S_TOKEN=85892cbfef2177603f25be30344dbcd0 sh -
```

::: tip 

```bash
root@k3s1:~# cat /var/lib/rancher/k3s/agent/etc/flannel/net-conf.json
{
	"Network": "10.42.0.0/16",
	"Backend": {
		"Type": "host-gw"
	}
}

root@k3s1:~# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         172.16.64.1     0.0.0.0         UG    100    0        0 enp0s2
10.42.0.0       0.0.0.0         255.255.255.0   U     0      0        0 cni0
10.42.1.0       172.16.64.9     255.255.255.0   UG    0      0        0 enp0s2
172.16.64.0     0.0.0.0         255.255.255.0   U     0      0        0 enp0s2
172.16.64.1     0.0.0.0         255.255.255.255 UH    100    0        0 enp0s2
```

:::



### å¯ç”¨ Directrouting

å½“ä¸»æœºåœ¨åŒä¸€å­ç½‘æ—¶ï¼Œå¯ç”¨ direct routes(å¦‚host-gw)ã€‚`vxlan` åªç”¨äºå°†æ•°æ®åŒ…å°è£…åˆ°ä¸åŒå­ç½‘çš„ä¸»æœºä¸Šï¼ŒåŒå­ç½‘çš„ä¸»æœºä¹‹é—´ä½¿ç”¨ `host-gw`ã€‚é»˜è®¤å€¼ä¸º `false`ã€‚

```bash
# K3s master å’Œ agent
cat >> /etc/net-conf.json <<EOF 
{
        "Network": "10.42.0.0/16",
        "Backend": {
            "Type": "vxlan",
            "Directrouting": true
	}
}
EOF

# K3s master
curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_EXEC="--flannel-conf=/etc/net-conf.json" \
        INSTALL_K3S_MIRROR=cn sh -
```



## è‡ªå®šä¹‰ CNI

ä½¿ç”¨ `--flannel-backend=none` è¿è¡Œ K3sï¼Œç„¶ååœ¨å®‰è£…ä½ é€‰æ‹©çš„ CNIã€‚



#### Calico

æŒ‰ç…§[Calico CNI æ’ä»¶æŒ‡å—](https://docs.projectcalico.org/master/reference/cni-plugin/configuration)ã€‚ä¿®æ”¹ Calico YAMLï¼Œåœ¨ container_settings éƒ¨åˆ†ä¸­å…è®¸ IP è½¬å‘ï¼Œä¾‹å¦‚ï¼š

```
"container_settings": {
              "allow_ip_forwarding": true
          }
```

> å¦‚ä¸é…ç½® `"allow_ip_forwarding": true`ï¼Œ `svclb-traefik` å°†ä¼šæŠ¥é”™ï¼š`/usr/bin/entry: line 6: can't create /proc/sys/net/ipv4/ip_forward: Read-only file system`

```bash
root@k3s1:~# curl -sfL http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | \
        INSTALL_K3S_MIRROR=cn \
        INSTALL_K3S_EXEC="--flannel-backend=none \
        --cluster-cidr=192.168.200.0/24" \
        sh -
root@k3s1:~# kubectl apply -f https://raw.githubusercontent.com/kingsd041/k3s-tutorial/main/05-å®‰è£…-ç½‘ç»œé€‰é¡¹/calico.yaml
```

**å‚è€ƒï¼š**https://docs.projectcalico.org/getting-started/kubernetes/k3s/quickstart



## ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“å®ç°é«˜å¯ç”¨å®‰è£…

::: tip 
å•èŠ‚ç‚¹ k3s server é›†ç¾¤å¯ä»¥æ»¡è¶³å„ç§ç”¨ä¾‹ï¼Œä½†æ˜¯å¯¹äºéœ€è¦ Kubernetes control-plane ç¨³å®šè¿è¡Œçš„é‡è¦ç¯å¢ƒï¼Œæ‚¨å¯ä»¥åœ¨ HA é…ç½®ä¸­è¿è¡Œ K3sã€‚ä¸€ä¸ª K3s HA é›†ç¾¤ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- **ä¸¤ä¸ªæˆ–å¤šä¸ª** `server èŠ‚ç‚¹`ï¼Œå°†ä¸º Kubernetes API æä¾›æœåŠ¡å¹¶è¿è¡Œå…¶ä»– control-plane æœåŠ¡ã€‚
- **é›¶ä¸ªæˆ–å¤šä¸ª** `agent èŠ‚ç‚¹`ï¼Œç”¨äºè¿è¡Œæ‚¨çš„åº”ç”¨å’ŒæœåŠ¡ã€‚
- `å¤–éƒ¨æ•°æ®å­˜å‚¨` (ä¸å•ä¸ª k3s server è®¾ç½®ä¸­ä½¿ç”¨çš„åµŒå…¥å¼ SQLite æ•°æ®å­˜å‚¨ç›¸å)
- `å›ºå®šçš„æ³¨å†Œåœ°å€`ï¼Œä½äº server èŠ‚ç‚¹çš„å‰é¢ï¼Œä»¥å…è®¸ agent èŠ‚ç‚¹å‘é›†ç¾¤æ³¨å†Œ

> Agent é€šè¿‡å›ºå®šçš„æ³¨å†Œåœ°å€è¿›è¡Œæ³¨å†Œï¼Œä½†æ³¨å†Œåç›´æ¥ä¸å…¶ä¸­ä¸€ä¸ª `server` èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚è¿™æ˜¯ä¸€ä¸ªç”± `k3s agent` è¿›ç¨‹å‘èµ·çš„ `websocket` è¿æ¥ï¼Œå¹¶ç”±ä½œä¸º `agent` è¿›ç¨‹ä¸€éƒ¨åˆ†è¿è¡Œçš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ç»´æŠ¤ã€‚
>
> **åµŒå…¥å¼ ETCD ä½¿ç”¨çš„å…±è¯†ç®—æ³• Raft å»ºè®®ä½ ä½¿ç”¨æœ€å°‘ 3 ä¸ªä¸”æ•°é‡ä¸ºå¥‡æ•°çš„èŠ‚ç‚¹**

:::



### ç¯å¢ƒå‡†å¤‡

::: warning æé†’
ä¸ªäººæ¯”è¾ƒå€¾å‘äº etcdï¼ŒDqlite å·²ç»è¢«æŠ›å¼ƒäº†ï¼ŒåµŒå…¥å¼ etcd æ‰æ˜¯ yyds

ä½¿ç”¨ä¹‹å‰çš„ 3 å°ä¸»æœºå®éªŒã€‚**åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®å­˜å‚¨**

:::



| ä¸»æœºå       | è§’è‰²       | IP             |
| ------------ | ---------- | -------------- |
| k3s-server-1 | k3s master | 192.168.71.130 |
| k3s-server-2 | k3s master | 192.168.71.131 |
| k3s-db       | DB         | 121.43.165.25  |
| k3s-lb       | LB         | 172.31.13.97   |
| k3s-agent    | k3s agent  | 172.31.15.130  |



### å¤–éƒ¨æ•°æ®åº“é«˜å¯ç”¨

```bash
# k3s-db
docker run --name some-mysql --restart=unless-stopped -p 3306:3306 -e MYSQL_ROOT_PASSWORD=password -d mysql:5.7
```



**å¯åŠ¨ k3s server èŠ‚ç‚¹:**

```bash
# k3s-server-1 å’Œ k3s-server-2 èŠ‚ç‚¹
curl -sfL https://get.k3s.io | sh -s - server \
  --datastore-endpoint="mysql://root:password@tcp(192.168.71.130:3306)/database-name" --tls-san 172.31.13.97
```



::: warning æ³¨æ„
`--tls-san`ï¼šåœ¨ TLS è¯ä¹¦ä¸­æ·»åŠ å…¶ä»–ä¸»æœºåæˆ– IP ä½œä¸ºä¸»é¢˜å¤‡ç”¨åç§°ï¼Œæœ¬ä¾‹ä¸º LB çš„ IP
å¦åˆ™é€šè¿‡ LB IP è¿æ¥ k3s api æ—¶å°†ä¼šæŠ¥é”™ï¼š`Unable to connect to the server: x509: certificate is valid for 10.43.0.1, 127.0.0.1, 172.31.2.134, 172.31.2.42, not 172.31.13.97`

`--tls-san` å¯çœç•¥

:::

::: tip éªŒè¯

```bash

```

é»˜è®¤æƒ…å†µä¸‹ï¼Œserver èŠ‚ç‚¹å°†æ˜¯å¯è°ƒåº¦çš„ï¼Œå› æ­¤ä½ çš„å·¥ä½œè´Ÿè½½å¯ä»¥åœ¨å®ƒä»¬ä¸Šå¯åŠ¨ã€‚å¦‚æœä½ å¸Œæœ›æœ‰ä¸€ä¸ªä¸“ç”¨çš„ control-planeï¼Œåœ¨è¿™ä¸ªå¹³é¢ä¸Šä¸ä¼šè¿è¡Œç”¨æˆ·å·¥ä½œè´Ÿè½½ï¼Œä½ å¯ä»¥ä½¿ç”¨ taintsã€‚`node-taint` å‚æ•°å°†å…è®¸ä½ ç”¨æ±¡ç‚¹é…ç½®èŠ‚ç‚¹ï¼Œä¾‹å¦‚`--node-taint CriticalAddonsOnly=true:NoExecute`ã€‚

:::



### agent åŠ å…¥

Agent èŠ‚ç‚¹éœ€è¦ä¸€ä¸ª URL æ¥æ³¨å†Œï¼Œä½ åº”è¯¥åœ¨ server èŠ‚ç‚¹å‰é¢æœ‰ä¸€ä¸ªç¨³å®šçš„ endpointï¼Œä¸ä¼šéšæ—¶é—´æ¨ç§»è€Œæ”¹å˜ã€‚å¯ä»¥ä½¿ç”¨è®¸å¤šæ–¹æ³•æ¥è®¾ç½®æ­¤ endpointï¼Œä¾‹å¦‚ï¼š

- ä¸€ä¸ª 4 å±‚ï¼ˆTCPï¼‰è´Ÿè½½å‡è¡¡å™¨
- è½®è¯¢ DNS
- è™šæ‹Ÿæˆ–å¼¹æ€§ IP åœ°å€

ä½¿ç”¨ nginx ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ï¼Œå°† 6443 ç«¯å£æµé‡è½¬å‘åˆ° k3s server:

```bash
# k3s-lb èŠ‚ç‚¹
cat >> /etc/nginx.conf <<EOF
worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

stream {
    upstream k3s_api {
        least_conn;
        server 172.31.2.134:6443 max_fails=3 fail_timeout=5s;
        server 172.31.2.42:6443 max_fails=3 fail_timeout=5s;
    }
    server {
        listen     6443;
        proxy_pass k3s_api;
    }
}
EOF
```

*è¿è¡Œï¼š*

```dockerfile
docker run -d --restart=unless-stopped \
  -p 6443:6443 \
  -v /etc/nginx.conf:/etc/nginx/nginx.conf \
  nginx:1.14
```





### æ²¡æœ‰ CLI æ ‡å¿—å¯åŠ¨ agent åŠ å…¥

å¦‚æœç¬¬ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯åœ¨æ²¡æœ‰ `--token` CLI æ ‡å¿—æˆ– `K3S_TOKEN` å˜é‡çš„æƒ…å†µä¸‹å¯åŠ¨çš„ï¼Œåˆ™å¯ä»¥ä»å·²åŠ å…¥ç¾¤é›†çš„ä»»ä½•æœåŠ¡å™¨æ£€ç´¢ä»¤ç‰Œå€¼ï¼š

```bash
cat /var/lib/rancher/k3s/server/token
```

ç„¶å[å¯ä»¥ä½¿ç”¨ä»¤ç‰Œæ·»åŠ ](https://docs.k3s.io/reference/server-config#cluster-options)å…¶ä»–æœåŠ¡å™¨èŠ‚ç‚¹:

```bash
curl -sfL https://get.k3s.io | sh -s - server \
  \
  --datastore-endpoint="mysql://username:password@tcp(hostname:3306)/database-name"
```

::: tip
 åœ¨ HA é›†ç¾¤ä¸­åŠ å…¥ agent èŠ‚ç‚¹ä¸åœ¨å•ä¸ª server é›†ç¾¤ä¸­åŠ å…¥ agent èŠ‚ç‚¹æ˜¯ä¸€æ ·çš„ã€‚ä½ åªéœ€è¦æŒ‡å®š agent åº”è¯¥æ³¨å†Œåˆ°çš„ URL å’Œå®ƒåº”è¯¥ä½¿ç”¨çš„ token å³å¯ã€‚

```bash
# k3s-agent èŠ‚ç‚¹
curl -sfL https://get.k3s.io | K3S_URL=https://172.31.13.97:6443 K3S_TOKEN=mynodetoken sh -
```

:::

æœ‰ä¸€äº›é…ç½®æ ‡å¿—åœ¨æ‰€æœ‰æœåŠ¡å™¨èŠ‚ç‚¹ä¸­å¿…é¡»ç›¸åŒï¼š

+ ç½‘ç»œç›¸å…³æ ‡å¿—ï¼š --cluster-dnsï¼Œ -`--cluster-domain`ï¼Œ --cluster-cidrï¼Œ -`--service-cidr` `--cluster-dns``--cluster-cidr`
+ æ§åˆ¶æŸäº›ç»„ä»¶éƒ¨ç½²çš„æ ‡å¿—ï¼š--disable-helm-controllerã€--`--disable-kube-proxy`ã€-`--disable-network-policy` ä»¥åŠä¼ é€’ç»™ -`--disable` çš„ä»»ä½•ç»„ä»¶ `--disable-helm-controller`
+ åŠŸèƒ½ç›¸å…³æ ‡å¿—ï¼š-`--secrets-encryption`

::: warning æ³¨æ„

ç¡®ä¿ä¿ç•™æ­¤ä»¤ç‰Œçš„å‰¯æœ¬ï¼Œå› ä¸ºä»å¤‡ä»½è¿˜åŸå’Œæ·»åŠ èŠ‚ç‚¹æ—¶éœ€è¦è¯¥å‰¯æœ¬ã€‚ä»¥å‰ï¼ŒK3s åœ¨ä½¿ç”¨å¤–éƒ¨ SQL æ•°æ®å­˜å‚¨æ—¶ä¸ä¼šå¼ºåˆ¶ä½¿ç”¨ä»¤ç‰Œã€‚

:::



## åµŒå…¥å¼DB HA

è¦åœ¨è¿™ç§æ¨¡å¼ä¸‹è¿è¡Œ K3sï¼Œä½ å¿…é¡»æœ‰å¥‡æ•°çš„æœåŠ¡å™¨èŠ‚ç‚¹ã€‚æˆ‘ä»¬å»ºè®®ä»ä¸‰ä¸ªèŠ‚ç‚¹å¼€å§‹ã€‚

è¦å¼€å§‹è¿è¡Œï¼Œé¦–å…ˆå¯åŠ¨ä¸€ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ï¼Œä½¿ç”¨ cluster-init æ ‡å¿—æ¥å¯ç”¨é›†ç¾¤ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªæ ‡è®°ä½œä¸ºå…±äº«çš„å¯†é’¥æ¥åŠ å…¥å…¶ä»–æœåŠ¡å™¨åˆ°é›†ç¾¤ä¸­ã€‚

```bash
K3S_TOKEN=SECRET k3s server --cluster-init
# æˆ–ï¼š
curl -sfL https://get.k3s.io | K3S_TOKEN=SECRET sh -s - --cluster-init
```



å¯åŠ¨ç¬¬ä¸€å°æœåŠ¡å™¨åï¼Œä½¿ç”¨å…±äº«å¯†é’¥å°†ç¬¬äºŒå°å’Œç¬¬ä¸‰å°æœåŠ¡å™¨åŠ å…¥é›†ç¾¤ã€‚

```bash
K3S_TOKEN=SECRET k3s server --server https://<ip or hostname of server1>:6443
# æˆ–:
curl -sfL https://get.k3s.io | K3S_TOKEN=SECRET sh -s - --server https://<ip or hostname of server1>:6443
```



æŸ¥è¯¢ ETCD é›†ç¾¤çŠ¶æ€ï¼š

```bash
ETCDCTL_ENDPOINTS='https://172.31.12.136:2379,https://172.31.4.43:2379,https://172.31.4.190:2379' 
ETCDCTL_CACERT='/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt' 
ETCDCTL_CERT='/var/lib/rancher/k3s/server/tls/etcd/server-client.crt' 
ETCDCTL_KEY='/var/lib/rancher/k3s/server/tls/etcd/server-client.key' 
ETCDCTL_API=3 etcdctl endpoint status --write-out=table
```



::: danger 
etcd è¯ä¹¦é»˜è®¤ç›®å½•ï¼š`/var/lib/rancher/k3s/server/tls/etcd`
etcd æ•°æ®é»˜è®¤ç›®å½•ï¼š`/var/lib/rancher/k3s/server/db/etcd`
:::



## é›†ç¾¤æ•°æ®å­˜å‚¨é€‰é¡¹

::: tip å®˜æ–¹ä»‹ç»ï¼š
ä½¿ç”¨ etcd ä»¥å¤–çš„æ•°æ®å­˜å‚¨è¿è¡Œ Kubernetes çš„èƒ½åŠ›ä½¿ K3s åŒºåˆ«äºå…¶ä»– Kubernetes å‘è¡Œç‰ˆã€‚è¯¥åŠŸèƒ½ä¸º Kubernetes æ“ä½œè€…æä¾›äº†çµæ´»æ€§ã€‚å¯ç”¨çš„æ•°æ®å­˜å‚¨é€‰é¡¹å…è®¸æ‚¨é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆæ‚¨ç”¨ä¾‹çš„æ•°æ®å­˜å‚¨ã€‚ä¾‹å¦‚ï¼š

- å¦‚æœä½ çš„å›¢é˜Ÿæ²¡æœ‰æ“ä½œ etcd çš„ä¸“ä¸šçŸ¥è¯†ï¼Œå¯ä»¥é€‰æ‹© MySQL æˆ– PostgreSQL ç­‰ä¼ä¸šçº§ SQL æ•°æ®åº“ã€‚
- å¦‚æœæ‚¨éœ€è¦åœ¨ CI/CD ç¯å¢ƒä¸­è¿è¡Œä¸€ä¸ªç®€å•çš„ã€çŸ­æš‚çš„é›†ç¾¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åµŒå…¥å¼ SQLite æ•°æ®åº“ã€‚
- å¦‚æœä½ å¸Œæœ›åœ¨è¾¹ç¼˜éƒ¨ç½² Kubernetesï¼Œå¹¶éœ€è¦ä¸€ä¸ªé«˜å¯ç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œä½†åˆæ— æ³•æ‰¿æ‹…åœ¨è¾¹ç¼˜ç®¡ç†æ•°æ®åº“çš„æ“ä½œå¼€é”€ï¼Œä½ å¯ä»¥ä½¿ç”¨ K3s å»ºç«‹åœ¨åµŒå…¥å¼ etcd ä¹‹ä¸Šçš„åµŒå…¥å¼ HA æ•°æ®å­˜å‚¨ã€‚

:::



### é…ç½®å‚æ•°

ä½¿ç”¨å¤–éƒ¨æ•°æ®å­˜å‚¨ï¼Œå¦‚ PostgreSQLã€MySQL æˆ– etcdï¼Œä½ å¿…é¡»è®¾ç½®`datastore-endpoint`å‚æ•°ï¼Œä»¥ä¾¿ K3s çŸ¥é“å¦‚ä½•è¿æ¥åˆ°å®ƒã€‚ä½ ä¹Ÿå¯ä»¥æŒ‡å®šå‚æ•°æ¥é…ç½®è¿æ¥çš„è®¤è¯å’ŒåŠ å¯†ã€‚ä¸‹è¡¨å‚æ•°ï¼Œå®ƒä»¬å¯ä»¥ä½œä¸º CLI æ ‡å¿—æˆ–ç¯å¢ƒå˜é‡ä¼ é€’ã€‚

| CLI Flag               | ç¯å¢ƒå˜é‡                 | æè¿°                                                         |
| :--------------------- | :----------------------- | :----------------------------------------------------------- |
| `--datastore-endpoint` | `K3S_DATASTORE_ENDPOINT` | æŒ‡å®šä¸€ä¸ª PostgresSQLã€MySQL æˆ– etcd è¿æ¥å­—ç¬¦ä¸²ã€‚ç”¨äºæè¿°ä¸æ•°æ®å­˜å‚¨çš„è¿æ¥ã€‚è¿™ä¸ªå­—ç¬¦ä¸²çš„ç»“æ„æ˜¯ç‰¹å®šäºæ¯ä¸ªåç«¯çš„ï¼Œè¯¦æƒ…å¦‚ä¸‹ã€‚ |
| `--datastore-cafile`   | `K3S_DATASTORE_CAFILE`   | TLS è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰æ–‡ä»¶ï¼Œç”¨äºå¸®åŠ©ç¡®ä¿ä¸æ•°æ®å­˜å‚¨çš„é€šä¿¡å®‰å…¨ã€‚å¦‚æœä½ çš„æ•°æ®å­˜å‚¨é€šè¿‡ TLS æœåŠ¡è¯·æ±‚ï¼Œä½¿ç”¨ç”±è‡ªå®šä¹‰è¯ä¹¦é¢å‘æœºæ„ç­¾ç½²çš„è¯ä¹¦ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‚æ•°æŒ‡å®šè¯¥ CAï¼Œè¿™æ · K3s å®¢æˆ·ç«¯å°±å¯ä»¥æ­£ç¡®éªŒè¯è¯ä¹¦ã€‚ |
| `--datastore-certfile` | `K3S_DATASTORE_CERTFILE` | TLS è¯ä¹¦æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„éªŒè¯ã€‚è¦ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼Œä½ çš„æ•°æ®å­˜å‚¨å¿…é¡»è¢«é…ç½®ä¸ºæ”¯æŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚å¦‚æœä½ æŒ‡å®šäº†è¿™ä¸ªå‚æ•°ï¼Œä½ è¿˜å¿…é¡»æŒ‡å®š`datastore-keyfile`å‚æ•°ã€‚ |
| `--datastore-keyfile`  | `K3S_DATASTORE_KEYFILE`  | TLS å¯†é’¥æ–‡ä»¶ï¼Œç”¨äºå¯¹æ•°æ®å­˜å‚¨è¿›è¡ŒåŸºäºå®¢æˆ·ç«¯è¯ä¹¦çš„è®¤è¯ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§å‰é¢çš„`datastore-certfile`å‚æ•°ã€‚ |

ä½œä¸ºæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å»ºè®®å°†è¿™äº›å‚æ•°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·ä½ çš„æ•°æ®åº“è¯ä¹¦æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯å°±ä¸ä¼šä½œä¸ºè¿›ç¨‹ä¿¡æ¯çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚

::: warning å®˜æ–¹å»ºè®®
ä½œä¸ºæœ€ä½³å®è·µï¼Œæˆ‘ä»¬å»ºè®®å°†è¿™äº›å‚æ•°è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ ·ä½ çš„æ•°æ®åº“è¯ä¹¦æˆ–å…¶ä»–æ•æ„Ÿä¿¡æ¯å°±ä¸ä¼šä½œä¸º **è¿›ç¨‹ä¿¡æ¯** çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚
:::



## ç§æœ‰ä»“åº“

å¯ä»¥å°† Containerd é…ç½®ä¸ºè¿æ¥åˆ°ç§æœ‰æ³¨å†Œè¡¨ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬åœ¨èŠ‚ç‚¹ä¸Šæ‹‰å–ç§æœ‰æ˜ åƒã€‚

K3s é»˜è®¤ä½¿ç”¨ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥åœ¨ docker ä¸Šé…ç½®é•œåƒä»“åº“æ˜¯ä¸ç”Ÿæ•ˆçš„

K3s registry é…ç½®ç›®å½•ä¸ºï¼š `/etc/rancher/k3s/registries.yaml`ã€‚K3s å¯åŠ¨æ—¶ï¼ŒK3s ä¼šæ£€æŸ¥ `/etc/rancher/k3s/` ä¸­æ˜¯å¦å­˜åœ¨ `registries.yaml` æ–‡ä»¶ï¼Œå¹¶æŒ‡ç¤º `containerd` ä½¿ç”¨æ–‡ä»¶ä¸­å®šä¹‰çš„é•œåƒä»“åº“ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ï¼Œé‚£ä¹ˆä½ éœ€è¦åœ¨æ¯ä¸ªä½¿ç”¨é•œåƒä»“åº“çš„èŠ‚ç‚¹ä¸Šä»¥ root èº«ä»½åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ã€‚

è¯·æ³¨æ„ï¼Œserver èŠ‚ç‚¹é»˜è®¤æ˜¯å¯ä»¥è°ƒåº¦çš„ã€‚å¦‚æœä½ æ²¡æœ‰åœ¨ server èŠ‚ç‚¹ä¸Šè®¾ç½®æ±¡ç‚¹ï¼Œé‚£ä¹ˆå°†åœ¨å®ƒä»¬ä¸Šè¿è¡Œå·¥ä½œè´Ÿè½½ï¼Œè¯·ç¡®ä¿åœ¨æ¯ä¸ª server èŠ‚ç‚¹ä¸Šåˆ›å»º `registries.yaml` æ–‡ä»¶ã€‚



### registries.yaml æ–‡ä»¶

**ç»„æˆéƒ¨åˆ†ï¼š**

1. `mirrors`ï¼šå®šä¹‰ä¸“ç”¨æ³¨å†Œè¡¨çš„åç§°å’Œç«¯ç‚¹çš„æŒ‡ä»¤
2. `configs`ï¼š`configs`éƒ¨åˆ†å®šä¹‰æ¯ä¸ªé•œåƒçš„ TLS å’Œå‡­æ®é…ç½®ã€‚å¯¹äºæ¯ä¸ªé•œåƒï¼Œæ‚¨å¯ä»¥å®šä¹‰`auth`å’Œ/æˆ– `tls`.



::: tip
containerd ä½¿ç”¨äº†ç±»ä¼¼ K8S ä¸­ svc ä¸ endpoint çš„æ¦‚å¿µï¼Œsvc å¯ä»¥ç†è§£ä¸º **è®¿é—®åç§°**ï¼Œè¿™ä¸ªåç§°ä¼šè§£æåˆ°å¯¹åº”çš„ endpoint ä¸Šã€‚ ä¹Ÿå¯ä»¥ç†è§£ mirror é…ç½®å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†ï¼Œå®ƒæŠŠå®¢æˆ·ç«¯çš„è¯·æ±‚ä»£ç†åˆ° endpoint é…ç½®çš„åç«¯é•œåƒä»“åº“ã€‚mirror åç§°å¯ä»¥éšæ„å¡«å†™ï¼Œä½†æ˜¯å¿…é¡»ç¬¦åˆIPæˆ–åŸŸåçš„å®šä¹‰è§„åˆ™ã€‚å¹¶ä¸”å¯ä»¥é…ç½®å¤šä¸ª endpointï¼Œé»˜è®¤è§£æåˆ°ç¬¬ä¸€ä¸ª endpointï¼Œå¦‚æœç¬¬ä¸€ä¸ª endpoint æ²¡æœ‰è¿”å›æ•°æ®ï¼Œåˆ™è‡ªåŠ¨åˆ‡æ¢åˆ°ç¬¬äºŒä¸ª endpointï¼Œä»¥æ­¤ç±»æ¨ã€‚`INSTALL_K3S_MIRROR=cn`

**ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š**

```yaml
mirrors:
  "172.31.6.200:5000":
    endpoint:
      - "http://172.31.6.200:5000"
      - "http://x.x.x.x:5000"
      - "http://y.y.y.y:5000"
  "rancher.ksd.top:5000":
    endpoint:
      - "http://172.31.6.200:5000"
  "docker.io":
    endpoint:
      - "https://fogjl973.mirror.aliyuncs.com"
      - "https://registry-1.docker.io"

configs:
  "172.31.6.200:5000":
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.kingsd.top.cert
      key_file:  /home/ubuntu/harbor2.kingsd.top.key
      ca_file:   /home/ubuntu/ca.crt
```

å¯ä»¥é€šè¿‡ `crictl pull 172.31.6.200:5000/library/alpine` å’Œ `crictl pull rancher.ksd.top:5000/library/alpine` è·å–åˆ°é•œåƒï¼Œä½†é•œåƒéƒ½æ˜¯ä»åŒä¸€ä¸ªä»“åº“è·å–åˆ°çš„ã€‚

:::



#### mirrors

```yaml
mirrors:
  mycustomreg.com:
    endpoint:
      - "https://mycustomreg.com:5000"
```



**Rewrites:**

æ¯ä¸ªé•œåƒéƒ½å¯ä»¥æœ‰ä¸€ç»„ `Rewrites`ã€‚`Rewrites` å¯ä»¥æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼æ›´æ”¹å›¾åƒçš„æ ‡ç­¾ã€‚å¦‚æœé•œåƒæ³¨å†Œè¡¨ä¸­çš„ç»„ç»‡/é¡¹ç›®ç»“æ„ä¸ä¸Šæ¸¸ç»“æ„ä¸åŒï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®å°†ä»¥é€æ˜æ–¹å¼ä» `registry.example.com:5000/mirrorproject/rancher-images/coredns-coredns:1.6.3` æ‹‰å–æ˜ åƒ `docker.io/rancher/coredns-coredns:1.6.3`:

```yaml
mirrors:
  docker.io:
    endpoint:
      - "https://registry.example.com:5000"
    rewrite:
      "^rancher/(.*)": "mirrorproject/rancher-images/$1"
```

> æ˜ åƒä»å°†å­˜å‚¨åœ¨åŸå§‹åç§°ä¸‹ï¼Œä»¥ä¾¿ `crictl image ls` å°†æ˜¾ç¤ºèŠ‚ç‚¹ä¸Šå¯ç”¨çš„ `docker.io/rancher/coredns-coredns:1.6.3`ï¼Œå³ä½¿æ˜ åƒæ˜¯ä»å…·æœ‰ä¸åŒåç§°çš„é•œåƒæ³¨å†Œè¡¨ä¸­æå–çš„ã€‚



#### configs

`configs`éƒ¨åˆ†å®šä¹‰æ¯ä¸ªé•œåƒçš„ TLS å’Œå‡­æ®é…ç½®ã€‚å¯¹äºæ¯ä¸ªé•œåƒï¼Œæ‚¨å¯ä»¥å®šä¹‰`auth`å’Œ/æˆ– `tls`.

`tls` éƒ¨åˆ†åŒ…æ‹¬ï¼š

| å‘½ä»¤                   | æè¿°                                             |
| ---------------------- | ------------------------------------------------ |
| `cert_file`            | å°†ç”¨äºå‘æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„       |
| `key_file`             | å°†ç”¨äºå‘æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯çš„å®¢æˆ·ç«¯å¯†é’¥è·¯å¾„       |
| `ca_file`              | å®šä¹‰ç”¨äºéªŒè¯æ³¨å†Œè¡¨çš„æœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶çš„ CA è¯ä¹¦è·¯å¾„ |
| `insecure_skip_verify` | å®šä¹‰æ˜¯å¦åº”è·³è¿‡æ³¨å†Œè¡¨çš„ TLS éªŒè¯çš„å¸ƒå°”å€¼          |

èº«ä»½éªŒè¯éƒ¨åˆ†ç”±ç”¨æˆ·å/å¯†ç æˆ–`auth`ä»¤ç‰Œç»„æˆï¼š

| å‘½ä»¤       | æè¿°                                 |
| ---------- | ------------------------------------ |
| `username` | ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„ç”¨æˆ·å       |
| `password` | ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„ç”¨æˆ·å¯†ç      |
| `auth`     | ä¸“ç”¨æ³¨å†Œè¡¨åŸºæœ¬èº«ä»½éªŒè¯çš„èº«ä»½éªŒè¯ä»¤ç‰Œ |

 

#### ä½¿ç”¨ TLS

ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†ä½¿ç”¨ TLS æ—¶å¦‚ä½•åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé…ç½® /`/etc/rancher/k3s/registries.yaml`ã€‚

```bash
cat >> /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  "harbor.kingsd.top":
    endpoint:
      - "https://harbor.kingsd.top"
configs:
  "harbor.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345
EOF
systemctl restart k3s
```



**è‡ªç­¾åè¯ä¹¦:**

```bash
cat >> /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  "harbor2.kingsd.top":
    endpoint:
      - "https://harbor2.kingsd.top"
configs:
  "harbor2.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.kingsd.top.cert
      key_file:  /home/ubuntu/harbor2.kingsd.top.key
      ca_file:   /home/ubuntu/ca.crt
EOF
systemctl restart k3s
```



**ä¸ä½¿ç”¨ TLS (Http registry):**

> åœ¨æ²¡æœ‰ TLS é€šä¿¡çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ä¸º endpoints æŒ‡å®šhttp://ï¼Œå¦åˆ™å°†é»˜è®¤ä¸º https

```bash
cat >> /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  "172.31.19.227:5000":
    endpoint:
      - "http://172.31.19.227:5000"
EOF
systemctl restart k3s
```



**å¸¦èº«ä»½éªŒè¯çš„å’Œä¸å¸¦èº«ä»½éªŒè¯çš„ï¼ˆauth)**

:::: code-group
::: code-group-item å¸¦èº«ä»½éªŒè¯

```yaml
mirrors:
  docker.io:
    endpoint:
      - "https://mycustomreg.com:5000"
configs:
  "mycustomreg:5000":
    auth:
      username: xxxxxx # this is the registry username
      password: xxxxxx # this is the registry password
    tls:
      cert_file: # path to the cert file used in the registry
      key_file:  # path to the key file used in the registry
      ca_file:   # path to the ca file used in the registry
```
:::
::: code-group-item ä¸å¸¦èº«ä»½éªŒè¯

```yaml
mirrors:
  docker.io:
    endpoint:
      - "https://mycustomreg.com:5000"
configs:
  "mycustomreg:5000":
    tls:
      cert_file: # path to the cert file used in the registry
      key_file:  # path to the key file used in the registry
      ca_file:   # path to the ca file used in the registry
```
:::

> åœ¨æ²¡æœ‰ TLS é€šä¿¡çš„æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä¸ºç«¯ç‚¹æŒ‡å®š `http://`ï¼Œå¦åˆ™å®ƒå°†é»˜è®¤ä¸º httpsã€‚

ä¸ºäº†ä½¿æ³¨å†Œè¡¨æ›´æ”¹ç”Ÿæ•ˆï¼Œæ‚¨éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé‡æ–°å¯åŠ¨ K3ã€‚

::::



**é…ç½® Mirror:**

```bash
cat >> /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  "docker.io":
    endpoint:
      - "https://fogjl973.mirror.aliyuncs.com"
      - "https://registry-1.docker.io"
EOF
systemctl restart k3s
```



::: details å®Œæ•´ç¤ºä¾‹

```yaml
mirrors:
  "harbor.kingsd.top":
    endpoint:
      - "https://harbor.kingsd.top"
  "harbor2.kingsd.top":
    endpoint:
      - "https://harbor2.kingsd.top"
  "172.31.19.227:5000":
    endpoint:
      - "http://172.31.19.227:5000"
  "docker.io":
    endpoint:
      - "https://fogjl973.mirror.aliyuncs.com"
      - "https://registry-1.docker.io"

configs:
  "harbor.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345

  "harbor2.kingsd.top":
    auth:
      username: admin
      password: Harbor@12345
    tls:
      cert_file: /home/ubuntu/harbor2.kingsd.top.cert
      key_file:  /home/ubuntu/harbor2.kingsd.top.key
      ca_file:   /home/ubuntu/ca.crt

```

:::



### é…ç½® Containerd

K3s å°†ä¼šåœ¨`/var/lib/rancher/k3s/agent/etc/containerd/config.toml`ä¸­ä¸º containerd ç”Ÿæˆ `config.toml`ã€‚

å¦‚æœè¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé«˜çº§è®¾ç½®ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ç›®å½•ä¸­åˆ›å»ºå¦ä¸€ä¸ªåä¸º `config.toml.tmpl` çš„æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å°†ä¼šä»£æ›¿é»˜è®¤è®¾ç½®ã€‚

`config.toml.tmpl`å°†è¢«è§†ä¸º Go æ¨¡æ¿æ–‡ä»¶ï¼Œå¹¶ä¸”`config.Node`ç»“æ„è¢«ä¼ é€’ç»™æ¨¡æ¿ã€‚æˆªå–ä¸‹é¢æ¨¡æ¿ç¤ºä¾‹ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ç»“æ„æ¥è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ã€‚

```go
package templates

import (
	"github.com/rancher/wharfie/pkg/registries"

	"github.com/k3s-io/k3s/pkg/daemons/config"
)

type ContainerdRuntimeConfig struct {
	RuntimeType string
	BinaryName  string
}

type ContainerdConfig struct {
	NodeConfig            *config.Node
	DisableCgroup         bool
	SystemdCgroup         bool
	IsRunningInUserNS     bool
	EnableUnprivileged    bool
	PrivateRegistryConfig *registries.Registry
	ExtraRuntimes         map[string]ContainerdRuntimeConfig
}
```



### å°†æ˜ åƒæ·»åŠ åˆ°ä¸“ç”¨æ³¨å†Œè¡¨

é¦–å…ˆï¼Œä» GitHub è·å–æ‚¨æ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬.txt k3s-images æ–‡ä»¶ã€‚ä» docker.io ä¸­æå– k3s æ˜ åƒ.txt æ–‡ä»¶ä¸­åˆ—å‡ºçš„ K3s æ˜ åƒ

ç¤ºä¾‹ï¼š`docker pull docker.io/rancher/coredns-coredns:1.6.3`

ç„¶åï¼Œå°†æ˜ åƒé‡æ–°æ ‡è®°åˆ°ä¸“ç”¨æ³¨å†Œè¡¨ã€‚

ç¤ºä¾‹ï¼šdocker tag coredns-corednsï¼š`docker tag coredns-coredns:1.6.3 mycustomreg:5000/coredns-coredns`

æœ€åï¼Œå°†æ˜ åƒæ¨é€åˆ°ä¸“ç”¨æ³¨å†Œè¡¨ã€‚

ç¤ºä¾‹ï¼š`docker push mycustomreg.com:5000/coredns-coredns`



## ç¦»çº¿å®‰è£…

ç¦»çº¿å®‰è£…çš„è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š

**æ­¥éª¤ 1**ï¼šéƒ¨ç½²é•œåƒï¼Œæœ¬æ–‡æä¾›äº†ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯**éƒ¨ç½²ç§æœ‰é•œåƒä»“åº“**å’Œ**æ‰‹åŠ¨éƒ¨ç½²é•œåƒ**ã€‚è¯·åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­é€‰æ‹©ä¸€ç§æ‰§è¡Œã€‚

**æ­¥éª¤ 2**ï¼šå®‰è£… K3sï¼Œæœ¬æ–‡æä¾›äº†ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯**å•èŠ‚ç‚¹å®‰è£…**å’Œ**é«˜å¯ç”¨å®‰è£…**ã€‚å®Œæˆé•œåƒéƒ¨ç½²åï¼Œè¯·åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­é€‰æ‹©ä¸€ç§æ‰§è¡Œã€‚

**ç¦»çº¿å‡çº§ K3s ç‰ˆæœ¬**ï¼šå®Œæˆç¦»çº¿å®‰è£… K3s åï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡è„šæœ¬å‡çº§ K3s ç‰ˆæœ¬ï¼Œæˆ–å¯ç”¨è‡ªåŠ¨å‡çº§åŠŸèƒ½ï¼Œä»¥ä¿æŒç¦»çº¿ç¯å¢ƒä¸­çš„ K3s ç‰ˆæœ¬ä¸æœ€æ–°çš„ K3s ç‰ˆæœ¬åŒæ­¥ã€‚



### é€šè¿‡ç§æœ‰é•œåƒä»“åº“å®‰è£… K3s

**å°†æ‰€éœ€é•œåƒä¸Šä¼ åˆ°ç§æœ‰é•œåƒä»“åº“ï¼š**

K3s é•œåƒåˆ—è¡¨å¯ä»¥ä» https://github.com/k3s-io/k3s/releases è·å–ã€‚



**åˆ›å»ºé•œåƒä»“åº“ YAMLï¼š**

æŒ‰ç…§[ç§æœ‰é•œåƒä»“åº“é…ç½®æŒ‡å—](http://docs.rancher.cn/docs/k3s/installation/private-registry/_index/) åˆ›å»ºå¹¶é…ç½®`registry.yaml`æ–‡ä»¶ã€‚

```yaml
mkdir -p /etc/rancher/k3s/
cat >> /etc/rancher/k3s/registries.yaml <<EOF
mirrors:
  "docker.io":
    endpoint:
      - "https://harbor.kingsd.top"
configs:
  "docker.io":
    auth:
      username: admin
      password: Harbor@12345
EOF
```



**å®‰è£…å•èŠ‚ç‚¹ K3sï¼š**

1. ä»[K3s GitHub Release](https://github.com/rancher/k3s/releases)é¡µé¢è·å– K3s äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒK3s äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦ä¸ç¦»çº¿é•œåƒçš„ç‰ˆæœ¬åŒ¹é…ã€‚

2. è·å– K3s å®‰è£…è„šæœ¬ï¼šhttps://get.k3s.ioã€‚

3. å°†äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„`/usr/local/bin`ä¸­ï¼Œå¹¶ç¡®ä¿æ‹¥æœ‰å¯æ‰§è¡Œæƒé™ã€‚å°†å®‰è£…è„šæœ¬æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„ä»»æ„ä½ç½®ï¼Œå¹¶å°†å…¶å‘½åä¸º`install.sh`ã€‚

4. å®‰è£… K3s serverï¼š

```
INSTALL_K3S_SKIP_DOWNLOAD=true ./install.sh
```

5. å°† agent åŠ å…¥åˆ° K3s é›†ç¾¤

```
INSTALL_K3S_SKIP_DOWNLOAD=true K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken ./install.sh
```



**é€šè¿‡æ‰‹åŠ¨éƒ¨ç½²é•œåƒå®‰è£… K3sï¼š**

è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å‡†å¤‡é•œåƒå’Œ K3s äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

1. ä»[K3s GitHub Release](https://github.com/rancher/k3s/releases)é¡µé¢è·å–ä½ æ‰€è¿è¡Œçš„ K3s ç‰ˆæœ¬çš„é•œåƒ tar æ–‡ä»¶ã€‚

2. å°† tar æ–‡ä»¶æ”¾åœ¨`images`ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ï¼š

```shell
sudo mkdir -p /var/lib/rancher/k3s/agent/images/
sudo cp ./k3s-airgap-images-$ARCH.tar /var/lib/rancher/k3s/agent/images/
```

3. å°† k3s äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨ `/usr/local/bin/k3s`è·¯å¾„ä¸Šï¼Œå¹¶ç¡®ä¿æ‹¥æœ‰å¯æ‰§è¡Œæƒé™ã€‚

4. å®‰è£… K3s serverï¼š

```
INSTALL_K3S_SKIP_DOWNLOAD=true ./install.sh
```

5. å°† agent åŠ å…¥åˆ° K3s é›†ç¾¤

```
INSTALL_K3S_SKIP_DOWNLOAD=true K3S_URL=https://myserver:6443 K3S_TOKEN=mynodetoken ./install.sh
```



æŒ‡å®š`INSTALL_K3S_SKIP_DOWNLOAD=true`å‚æ•°æŒ‡å®šä½¿ç”¨æœ¬åœ° K3s äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚

```bash
INSTALL_K3S_SKIP_DOWNLOAD=true INSTALL_K3S_EXEC='server --datastore-endpoint=mysql://username:password@tcp(hostname:3306)/database-name' ./install.sh
```



## å‡çº§ K3s

### é€šè¿‡è„šæœ¬å‡çº§

ç¦»çº¿ç¯å¢ƒçš„å‡çº§å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®Œæˆï¼š

1. ä»[K3s GitHub Release](https://github.com/rancher/k3s/releases)é¡µé¢ä¸‹è½½è¦å‡çº§åˆ°çš„ K3s ç‰ˆæœ¬ã€‚å°† tar æ–‡ä»¶æ”¾åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„`/var/lib/rancher/k3s/agent/images/`ç›®å½•ä¸‹ã€‚åˆ é™¤æ—§çš„ tar æ–‡ä»¶ã€‚
2. å¤åˆ¶å¹¶æ›¿æ¢æ¯ä¸ªèŠ‚ç‚¹ä¸Š`/usr/local/bin`ä¸­çš„æ—§ K3s äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¤åˆ¶https://get.k3s.io çš„å®‰è£…è„šæœ¬ï¼ˆå› ä¸ºå®ƒå¯èƒ½åœ¨ä¸Šæ¬¡å‘å¸ƒåå‘ç”Ÿäº†å˜åŒ–ï¼‰ã€‚å†æ¬¡è¿è¡Œè„šæœ¬ã€‚
3. é‡å¯ K3s æœåŠ¡ã€‚



### åœ¨çº¿è„šæœ¬å‡çº§

::: warning åœ¨çº¿è„šæœ¬å‡çº§
å½“å‡çº§ K3s æ—¶ï¼ŒK3s æœåŠ¡ä¼šé‡å¯æˆ–åœæ­¢ï¼Œä½† K3s å®¹å™¨ä¼šç»§ç»­è¿è¡Œã€‚ è¦åœæ­¢æ‰€æœ‰çš„ K3s å®¹å™¨å¹¶é‡ç½®å®¹å™¨çš„çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨ `k3s-killall.sh` è„šæœ¬ã€‚ killall è„šæœ¬æ¸…ç†å®¹å™¨ã€K3s ç›®å½•å’Œç½‘ç»œç»„ä»¶ï¼ŒåŒæ—¶ä¹Ÿåˆ é™¤äº† iptables é“¾å’Œæ‰€æœ‰ç›¸å…³è§„åˆ™ã€‚é›†ç¾¤æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚

ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3sï¼Œæˆ–è€…æ‰‹åŠ¨å®‰è£…æ‰€éœ€ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

> æ³¨æ„ï¼š å‡çº§æ—¶ï¼Œå…ˆé€ä¸ªå‡çº§ server èŠ‚ç‚¹ï¼Œç„¶åå†å‡çº§å…¶ä»– agent èŠ‚ç‚¹ã€‚

:::



### Channels è¯´æ˜

é€šè¿‡å®‰è£…è„šæœ¬æˆ–ä½¿ç”¨æˆ‘ä»¬çš„[è‡ªåŠ¨å‡çº§](http://docs.rancher.cn/docs/k3s/upgrades/basic/_index)åŠŸèƒ½è¿›è¡Œçš„å‡çº§å¯ä»¥ç»‘å®šåˆ°ä¸åŒçš„å‘å¸ƒ channelsã€‚ä»¥ä¸‹æ˜¯å¯ç”¨çš„ channelsã€‚

| CHANNEL      | æ è¿°                                                        |
| :----------- | :----------------------------------------------------------- |
| stable       | (é»˜è®¤)ç¨³å®šç‰ˆå»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚è¿™äº›ç‰ˆæœ¬å·²ç»è¿‡ä¸€æ®µæ—¶é—´çš„ç¤¾åŒºå¼ºåŒ–ã€‚ |
| latest       | æ¨èä½¿ç”¨æœ€æ–°ç‰ˆæœ¬å°è¯•æœ€æ–°çš„åŠŸèƒ½ã€‚ è¿™äº›ç‰ˆæœ¬è¿˜æ²¡æœ‰ç»è¿‡ç¤¾åŒºå¼ºåŒ–ã€‚ |
| v1.19 (ä¾‹å­) | æ¯ä¸€ä¸ªæ”¯æŒçš„ Kubernetes æ¬¡è¦ç‰ˆæœ¬éƒ½æœ‰ä¸€ä¸ªå‘å¸ƒ channelï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯`v1.19`ã€`v1.20`å’Œ`v1.21`ã€‚ã€‚è¿™äº› channel ä¼šé€‰æ‹©æœ€æ–°çš„å¯ç”¨è¡¥ä¸ç‰ˆæœ¬ï¼Œä¸ä¸€å®šæ˜¯ç¨³å®šç‰ˆæœ¬ã€‚ |

å¯¹äºè¯¦ç»†çš„æœ€æ–° channels åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥è®¿é—®[k3s channel æœåŠ¡ API](https://update.k3s.io/v1-release/channels)ã€‚å…³äº channels å·¥ä½œçš„æ›´å¤šæŠ€æœ¯ç»†èŠ‚ï¼Œè¯·å‚è§[channelserver é¡¹ç›®](https://github.com/rancher/channelserver)ã€‚



### ä½¿ç”¨å®‰è£…è„šæœ¬å‡çº§ K3s

è¦ä»æ—§ç‰ˆæœ¬å‡çº§ K3sï¼Œä½ å¯ä»¥ä½¿ç”¨ **ç›¸åŒçš„æ ‡å¿—** é‡æ–°è¿è¡Œå®‰è£…è„šæœ¬:

- å‡çº§åˆ°æœ€æ–° `stable` ç‰ˆæœ¬

```
curl -sfL https://get.k3s.io | sh -
```

- å‡çº§åˆ° `latest` ç‰ˆæœ¬

```
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=latest sh -
```

- å‡çº§åˆ° `v1.20` çš„æœ€æ–°ç‰ˆæœ¬

```
curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL="v1.20" sh -
```

- å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬

```
curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION=vX.Y.Z-rc1 sh -
```

#### ä½¿ç”¨äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å‡çº§ K3s

1. ä»[å‘å¸ƒ](https://github.com/rancher/k3s/releases)ä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶
2. å°†ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°`/usr/local/bin/k3s`ï¼ˆæˆ–æ‚¨æ‰€éœ€çš„ä½ç½®ï¼‰
3. åœæ­¢æ—§çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶
4. å¯åŠ¨æ–°çš„ K3s äºŒè¿›åˆ¶æ–‡ä»¶





### è‡ªåŠ¨å‡çº§

> æ³¨æ„ï¼š æ­¤åŠŸèƒ½ä» v1.17.4+k3s1 å¼€å§‹æä¾›æ”¯æŒã€‚

ä½ å¯ä»¥ä½¿ç”¨ Rancher çš„ system-upgrad-controller æ¥ç®¡ç† K3s é›†ç¾¤å‡çº§ã€‚è¿™æ˜¯ä¸€ç§ Kubernetes åŸç”Ÿçš„é›†ç¾¤å‡çº§æ–¹æ³•ã€‚å®ƒåˆ©ç”¨[è‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/#custom-resources)ã€`è®¡åˆ’`å’Œ[æ§åˆ¶å™¨](https://kubernetes.io/docs/concepts/architecture/controller/)ï¼Œæ ¹æ®é…ç½®çš„è®¡åˆ’å®‰æ’å‡çº§ã€‚

æ§åˆ¶å™¨é€šè¿‡ç›‘æ§è®¡åˆ’å’Œé€‰æ‹©è¦åœ¨å…¶ä¸Šè¿è¡Œå‡çº§[ job](https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/) çš„èŠ‚ç‚¹æ¥è°ƒåº¦å‡çº§ã€‚è®¡åˆ’é€šè¿‡[æ ‡ç­¾é€‰æ‹©å™¨](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/)å®šä¹‰å“ªäº›èŠ‚ç‚¹åº”è¯¥å‡çº§ã€‚å½“ä¸€ä¸ª job æˆåŠŸè¿è¡Œå®Œæˆåï¼Œæ§åˆ¶å™¨ä¼šç»™å®ƒè¿è¡Œçš„èŠ‚ç‚¹æ‰“ä¸Šç›¸åº”çš„æ ‡ç­¾ã€‚

å…³äº system-upgrade-controller çš„è®¾è®¡å’Œæ¶æ„æˆ–å…¶ä¸ K3s é›†æˆçš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è§ä»¥ä¸‹ Git ä»“åº“ï¼š

- [system-upgrade-controller](https://github.com/rancher/system-upgrade-controller)
- [k3s-upgrade](https://github.com/rancher/k3s-upgrade)

è¦ä»¥è¿™ç§æ–¹å¼è¿›è¡Œè‡ªåŠ¨å‡çº§ï¼Œä½ å¿…é¡»ï¼š

1. å°† system-upgrade-controller å®‰è£…åˆ°æ‚¨çš„é›†ç¾¤ä¸­
1. é…ç½®è®¡åˆ’

#### å®‰è£… system-upgrade-controller

System-upgrade-controller å¯ä»¥ä½œä¸º deployment å®‰è£…åˆ°æ‚¨çš„é›†ç¾¤ä¸­ã€‚Deployment éœ€è¦ä¸€ä¸ª service-accountã€clusterRoleBinding å’Œä¸€ä¸ª configmapã€‚è¦å®‰è£…è¿™äº›ç»„ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤:

```
kubectl apply -f https://github.com/rancher/system-upgrade-controller/releases/download/v0.6.2/system-upgrade-controller.yaml
```

#### é…ç½®è®¡åˆ’

å»ºè®®æ‚¨æœ€å°‘åˆ›å»ºä¸¤ä¸ªè®¡åˆ’ï¼šå‡çº§ serverï¼ˆmasterï¼‰èŠ‚ç‚¹çš„è®¡åˆ’å’Œå‡çº§ agentï¼ˆworkerï¼‰èŠ‚ç‚¹çš„è®¡åˆ’ã€‚æ ¹æ®éœ€è¦ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå…¶ä»–è®¡åˆ’æ¥æ§åˆ¶è·¨èŠ‚ç‚¹çš„æ»šåŠ¨å‡çº§ã€‚ä»¥ä¸‹ä¸¤ä¸ªç¤ºä¾‹è®¡åˆ’å°†æŠŠæ‚¨çš„é›†ç¾¤å‡çº§åˆ° K3s v1.20.4+k3s1ã€‚åˆ›å»ºè®¡åˆ’åï¼Œæ§åˆ¶å™¨å°†æ¥æ”¶è¿™äº›è®¡åˆ’å¹¶å¼€å§‹å‡çº§æ‚¨çš„é›†ç¾¤ã€‚

```
# Server plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: server-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master
      operator: In
      values:
      - "true"
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1

---
# Agent plan
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: agent-plan
  namespace: system-upgrade
spec:
  concurrency: 1
  cordon: true
  nodeSelector:
    matchExpressions:
    - key: node-role.kubernetes.io/master
      operator: DoesNotExist
  prepare:
    args:
    - prepare
    - server-plan
    image: rancher/k3s-upgrade
  serviceAccountName: system-upgrade
  upgrade:
    image: rancher/k3s-upgrade
  version: v1.20.4+k3s1
```

å…³äºè¿™äº›è®¡åˆ’ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„äº‹æƒ…éœ€è¦æé†’ï¼š

é¦–å…ˆï¼Œå¿…é¡»åœ¨éƒ¨ç½²æ§åˆ¶å™¨çš„åŒä¸€å‘½åç©ºé—´ä¸­åˆ›å»ºè®¡åˆ’ã€‚

å…¶æ¬¡ï¼Œ`concurrency`å­—æ®µè¡¨ç¤ºå¯ä»¥åŒæ—¶å‡çº§å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚

ç¬¬ä¸‰ï¼Œ`server-plan`é€šè¿‡æŒ‡å®šä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©å¸¦æœ‰`node-role.kubernetes.io/master`æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œä»è€Œé”å®š server èŠ‚ç‚¹ã€‚`agent-plan`é€šè¿‡æŒ‡å®šä¸€ä¸ªæ ‡ç­¾é€‰æ‹©å™¨æ¥é€‰æ‹©æ²¡æœ‰è¯¥æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œä»¥ agent èŠ‚ç‚¹ä¸ºç›®æ ‡ã€‚

ç¬¬å››ï¼Œ`agent-plan`ä¸­çš„ `prepare` æ­¥éª¤ä¼šä½¿è¯¥è®¡åˆ’ç­‰å¾…`server-plan`å®Œæˆåå†æ‰§è¡Œå‡çº§ jobsã€‚

ç¬¬äº”ï¼Œä¸¤ä¸ªè®¡åˆ’çš„`version`å­—æ®µéƒ½è®¾ç½®ä¸º v1.17.4+k3s1ã€‚æˆ–è€…ï¼Œä½ å¯ä»¥çœç•¥ `version` å­—æ®µï¼Œå°† `channel` å­—æ®µè®¾ç½®ä¸ºè§£æåˆ° K3s ç‰ˆæœ¬çš„ URLã€‚è¿™å°†å¯¼è‡´æ§åˆ¶å™¨ç›‘æ§è¯¥ URLï¼Œå¹¶åœ¨å®ƒè§£æåˆ°æ–°ç‰ˆæœ¬æ—¶éšæ—¶å‡çº§é›†ç¾¤ã€‚è¿™ä¸ [release channels](/docs/k3s/upgrades/basic/_index#å‘å¸ƒ-channels) é…åˆå¾—å¾ˆå¥½ã€‚å› æ­¤ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„ channel é…ç½®ä½ çš„è®¡åˆ’ï¼Œä»¥ç¡®ä¿ä½ çš„é›†ç¾¤æ€»æ˜¯è‡ªåŠ¨å‡çº§åˆ° K3s çš„æœ€æ–°ç¨³å®šç‰ˆæœ¬ã€‚

```
apiVersion: upgrade.cattle.io/v1
kind: Plan
...
spec:
  ...
  channel: https://update.k3s.io/v1-release/channels/stable

```

å¦‚ä¸Šæ‰€è¿°ï¼Œä¸€æ—¦æ§åˆ¶å™¨æ£€æµ‹åˆ°è®¡åˆ’å·²åˆ›å»ºï¼Œå‡çº§å°±ä¼šç«‹å³å¼€å§‹ã€‚æ›´æ–°è®¡åˆ’å°†ä½¿æ§åˆ¶å™¨é‡æ–°è¯„ä¼°è®¡åˆ’å¹¶ç¡®å®šæ˜¯å¦éœ€è¦å†æ¬¡å‡çº§ã€‚

æ‚¨å¯ä»¥é€šè¿‡ kubectl æŸ¥çœ‹ plans å’Œ jobs æ¥ç›‘æ§å‡çº§çš„è¿›åº¦ï¼š

```
kubectl -n system-upgrade get plans -o yaml
kubectl -n system-upgrade get jobs -o yaml
```



## è¿æ¥åˆ° k3s kubernets é›†ç¾¤çš„ä¸‰ç§æ–¹å¼

::: tip 
åŒæ—¶ä¹Ÿæ˜¯å¯¹ [23 èŠ‚](https://docker.nsddd.top/Cloud-Native-k8s/23.html)ï¼Œ[Kubeconfig && token](https://docker.nsddd.top/Cloud-Native-k8s/23.html) çš„è¡¥å……

+ [å‚è€ƒhttps://headworq.org/en/how-to-connect-to-kubernetes/#](https://headworq.org/en/how-to-connect-to-kubernetes/#)

:::

### kubeconfig

åœ¨ K3s å®‰è£…è¿‡ç¨‹ä¸­ï¼Œ**kubeconfig** æ–‡ä»¶è¢«å†™å…¥ `/etc/rancher/k3s/k3s.yaml`ã€‚æ‚¨å°†éœ€è¦æ­¤æ–‡ä»¶æ‰èƒ½ä½¿ç”¨é¦–é€‰çš„ Kubernetes å®¢æˆ·ç«¯è¿æ¥åˆ°æ‚¨çš„é›†ç¾¤ã€‚ä½ çš„ kubeconfig ä¼šå–œæ¬¢è¿™æ ·ï¼š

```yaml
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0...
    server: https://127.0.0.1:6443
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    client-certificate-data: LS...
    client-key-data: LS...
```

::: danger æ³¨æ„
å¦‚æœè¦ä»å…¶ä»–ä¸»æœºè¿›è¡Œè¿æ¥ï¼Œåˆ™å¿…é¡»æ›´æ”¹æœåŠ¡å™¨ç«¯ç‚¹å¹¶è¾“å…¥å¯è®¿é—®ç¾¤é›†çš„ä¸»æœºå/IP åœ°å€ã€‚å¦‚æœç¾¤é›†èŠ‚ç‚¹ä¸Šçš„é˜²ç«å¢™å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œåˆ™å¯èƒ½å¿…é¡»å…ˆæ‰“å¼€ç«¯å£ 6443/tcpï¼ˆ[è¯·å‚é˜…æ­¤å¤„](https://headworq.org/en-how-to-install-k3s-kubernets-on-ubuntu/)ï¼‰).
:::

**å‡ºäºå¥½å¥‡ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥k3s-agentå•å…ƒæ–‡ä»¶å¦‚ä½•ä½¿ç”¨ç¯å¢ƒæ–‡ä»¶ ( `/etc/systemd/system/k3s-agent.service.env` ) æ¥å­˜å‚¨å˜é‡å˜é‡K3S_URLå’ŒK3S_TOKENï¼š**

```bash
root@cubnode02:/workspces/runtime# cat /etc/systemd/system/k3s-agent.service
[Unit]
Description=Lightweight Kubernetes
Documentation=https://k3s.io
Wants=network-online.target
After=network-online.target

[Install]
WantedBy=multi-user.target

[Service]
Type=notify
EnvironmentFile=-/etc/default/%N
EnvironmentFile=-/etc/sysconfig/%N
EnvironmentFile=-/etc/systemd/system/k3s-agent.service.env
KillMode=process
Delegate=yes
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=1048576
LimitNPROC=infinity
LimitCORE=infinity
TasksMax=infinity
TimeoutStartSec=0
Restart=always
RestartSec=5s
ExecStartPre=/bin/sh -xc '! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service'
ExecStartPre=-/sbin/modprobe br_netfilter
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/k3s \
    agent \
	'--server' \

```

::: tip
å¦‚æœä¸ä¾èµ–systemctlæœåŠ¡è¿›è¡Œç®¡ç†ï¼Œåªèƒ½nohupè‡ªå·±æï¼Œè¦ä¹ˆå†™ç¨‹åºçš„æ—¶å€™åšä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹deamonå®ˆæŠ¤ï¼Œä¸€ç›´è®©å®ƒæŒç»­è·‘ã€‚
ExecStartå‡ ä¸ªæ®µï¼Œå’Œä½ å¹³æ—¶æ‰§è¡Œçš„ä¸€å¥è¯å‘½ä»¤æ˜¯ä¸€æ ·çš„
åªä¸è¿‡å†™æˆäº†é…ç½®æ–‡ä»¶ï¼Œäº¤ç»™systemctlç®¡ç†æ•´ä¸€ä¸ªæœåŠ¡
environmentFileç›¸å½“äºä½ æ¯æ¬¡æ‰§è¡Œçš„æ‰‹å·¥ç¯å¢ƒå˜é‡å…¨æ•´å¥½äº†

`nohup  å‘½ä»¤   &`

:::



**k3s-agent.service.env** çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```bash
root@cubnode02:/workspces/runtime# cat /etc/systemd/system/k3s-agent.service.env
K3S_TOKEN='SECRET'
K3S_URL='https://192.168.71.130:6443'
```



è¦æ‰‹åŠ¨å¯åŠ¨`k3s` ä»£ç†ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡çš„é€‰é¡¹`--server`å’Œ`--token inetad`ï¼š

```bash
k3s agent --server https://192.168.71.130:6443 --token "K10b625ace11027708856a6369064ef7cbd8e695a65457c9815e5f7ec2c3eca0635::server:SECRET"
```



### kubectl

è¿æ¥åˆ° Kubernetes é›†ç¾¤çš„æœ€å¸¸è§æ–¹æ³•æ˜¯ `'kubectl'` å‘½ä»¤ã€‚è¯¥å‘½ä»¤åœ¨ K3s å®‰è£…æœŸé—´è‡ªåŠ¨å®‰è£…åœ¨ç¾¤é›†èŠ‚ç‚¹ä¸Šã€‚

è¦è¿æ¥åˆ°é›†ç¾¤ï¼Œä½ å¿…é¡»è®© `kubectl` çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ° `kubeconfig`ã€‚æ‚¨å¯ä»¥é€šè¿‡ **å°† kubeconfig æ–‡ä»¶æŒ‡å®šä¸ºé€‰é¡¹ã€è®¾ç½®ç¯å¢ƒå˜é‡æˆ–å°†å…¶å¤åˆ¶åˆ° `~/.kube/config`** æ¥åšåˆ°è¿™ä¸€ç‚¹â€”â€”ä»»ä½•æ›´é€‚åˆæ‚¨çš„æ–¹æ³•ï¼š

```bash
# æŒ‡å®škubeconfigæ–‡ä»¶ä½œä¸ºé€‰é¡¹ï¼Œ
kubectl --kubeconfig=/etc/rancher/k3s/k3s.yaml  get nodes
# <output>

# è®¾ç½®ç¯å¢ƒå˜é‡
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
kubectl get nodes
# <output>

# copying it to '~/.kube/config' 
cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
kubectl get nodes
# <output>
```



æœ‰äº† kubeconfigï¼Œä½ å¯ä»¥å°è¯•ä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤ã€‚

```bash
# kubectl get nodes
NAME          STATUS   ROLES                       AGE   VERSION
cubmaster01   Ready    control-plane,etcd,master   15m   v1.25.4+k3s1
# kubectl get pods --all-namespaces
NAMESPACE     NAME                                      READY   STATUS      RESTARTS   AGE
kube-system   coredns-597584b69b-rb9bh                  1/1     Running     0          15m
kube-system   helm-install-traefik-crd-9h7rn            0/1     Completed   0          15m
kube-system   helm-install-traefik-fn7n7                0/1     Completed   1          15m
kube-system   local-path-provisioner-79f67d76f8-v5nxz   1/1     Running     0          15m
kube-system   metrics-server-5c8978b444-xbdbk           1/1     Running     0          15m
kube-system   svclb-traefik-f1a0eea9-ch5hp              2/2     Running     0          14m
kube-system   traefik-bb69b68cd-wzt8q                   1/1     Running     0          14m
```



### Lens Kubernetes IDE

å¦‚æœæ‚¨æ›´å–œæ¬¢å›¾å½¢ç•Œé¢æ¥ç®¡ç†æ‚¨çš„é›†ç¾¤ï¼Œæ‚¨ç»å¯¹åº”è¯¥æŸ¥çœ‹ [Lens](https://k8slens.dev/)ã€‚å®ƒç¡®å®å¯ä»¥æ›´è½»æ¾åœ°ç®¡ç†å·¥ä½œè´Ÿè½½ï¼Œé…ç½®æ˜ å°„ï¼Œæœºå¯†ï¼ŒæœåŠ¡ï¼Œå…¥å£ï¼Œå¹¶ä¸ºæ‚¨æä¾›æ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…çš„æ¦‚è¿°ã€‚æœ€å¥½çš„äº‹æƒ…æ˜¯ï¼Œå®ƒæ˜¯å®Œå…¨å…è´¹å’Œå¼€æºçš„ã€‚

> â€œLens ä¸º Kubernetes ä¸­è¿è¡Œçš„æ‰€æœ‰å†…å®¹æä¾›äº†å®Œæ•´çš„æ€åŠ¿æ„ŸçŸ¥ã€‚å®ƒé™ä½äº†åˆšèµ·æ­¥çš„äººçš„è¿›å…¥é—¨æ§›ï¼Œå¹¶ä»æ ¹æœ¬ä¸Šæé«˜äº†æ‹¥æœ‰æ›´å¤šç»éªŒçš„äººçš„ç”Ÿäº§åŠ›ã€‚
>
> https://github.com/lensapp/lens/



[Kubenav](https://kubenav.io/) ä¹Ÿæ˜¯ä¸€ä¸ªå›¾å½¢åŒ–çš„ Kubernetes å·¥å…·ã€‚Kubenav æœ€å¥½çš„ä¸€ç‚¹æ˜¯å®ƒå¯ç”¨äºç§»åŠ¨ Android å’Œ iOS è®¾å¤‡ï¼Œå› æ­¤æ‚¨å¯ä»¥åœ¨æ—…é€”ä¸­ç®¡ç†æ‚¨çš„ Kubernetes é›†ç¾¤;)ã€‚Kubenav ä¹Ÿæ˜¯å¼€æºçš„ï¼Œå¯åœ¨ iOS App Store å’Œ Play Store ä¸Šä½¿ç”¨ã€‚æ‚¨ä¹Ÿå¯ä»¥ä» [Github å­˜å‚¨åº“](https://github.com/kubenav/kubenav/)ä¸‹è½½æ¡Œé¢ç‰ˆæœ¬.

å®‰è£…åå¯¼èˆªåˆ°â€œç¾¤é›†â€ï¼Œç„¶åæŒ‰åŠ å·æ·»åŠ ç¾¤é›†ã€‚å‘ä¸‹æ»šåŠ¨åˆ°â€œå¯¼å…¥ Kubeconfigâ€ï¼Œå°†å†…å®¹ç²˜è´´åˆ°æ–‡æœ¬å­—æ®µä¸­ï¼Œç„¶åæŒ‰â€œæ·»åŠ â€ã€‚

![image-20221127124516263](https://sm.nsddd.top/smimage-20221127124516263.png)

æ³¨æ„ï¼šKubernetes API ç«¯å£ ï¼ˆTCP/6443ï¼‰ å¿…é¡»å¯ç”¨äºæ‚¨çš„æ‰‹æœºã€‚å¦‚æœæ‚¨ä¸æƒ³æ‰“å¼€è¯¥ç«¯å£åˆ°äº’è”ç½‘ï¼Œæ‚¨å¯ä»¥é€šè¿‡VPNè¿æ¥åˆ°é›†ç¾¤ã€‚è¯·å‚é˜…æˆ‘åœ¨ [Ubuntu ä¸Šè®¾ç½® Wireguard çš„æŒ‡å—](https://headworq.org/en-how-to-install-wiregurad-on-ubuntu/).



## END é“¾æ¥

<ul><li><div><a href = '14.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '16.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

