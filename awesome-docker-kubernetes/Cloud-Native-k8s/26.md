+ [author](http://nsddd.top)

# ç¬¬26èŠ‚ helm æ•™ç¨‹

<div><a href = '25.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '27.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[toc]]

## helmä»‹ç»

::: tip 
ä½¿ç”¨ `Helm` æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿çš„å°±æ­å»ºå‡ºæ¥ `MongoDB` / `MySQL` å‰¯æœ¬é›†ç¾¤ï¼Œ`YAML` æ–‡ä»¶åˆ«äººéƒ½ç»™æˆ‘ä»¬å†™å¥½äº†ï¼Œç›´æ¥ä½¿ç”¨ã€‚

`helm`çš„ä½œç”¨å°±æ˜¯æŠŠè®¸å¤šçš„èµ„æºå®šä¹‰ æ¯”å¦‚`svc`ï¼Œ`deployment`ï¼Œä¸€æ¬¡æ€§é€šè¿‡å…¨éƒ¨å®šä¹‰å¥½ï¼Œæ”¾åœ¨æºé‡Œç»Ÿä¸€ç®¡ç†ï¼Œè¿™æ ·å¾ˆå®¹æ˜“åœ¨å…¶ä»–æœºå™¨ä¸Šéƒ¨ç½²ï¼Œä¸ªäººç†è§£è¿™ä¸ªç±»ä¼¼äºè‡ªåŠ¨åŒ–è¿ç»´ä¸­`ansible`ä¸­çš„è§’è‰²æ¦‚å¿µï¼Œå‰ç«¯é¡¹ç›®ä¸­çš„`npm`åŒ…ç®¡ç†å·¥å…·,åç«¯é¡¹ç›®ä¸­çš„`maven`ç­‰æ„å»ºå·¥å…·ä¸€æ ·ï¼Œç±»æ¯”`Ansible`ä½¿ç”¨è§’è‰²æ¥æ•´åˆ`playbook.yaml`è¾¾åˆ°å¤ç”¨æ€§ã€‚åŒæ ·çš„ï¼Œä½¿ç”¨`helm`ç”¨äºæ•´åˆk8sä¸­çš„èµ„æºå¯¹è±¡`yaml`æ–‡ä»¶ï¼Œå®ç°å¤ç”¨æ€§,åŒæ—¶è®²èµ„æºæ–‡ä»¶çš„å‚æ•°ï¼Œå’Œå‚æ•°å€¼é€šè¿‡`temple`å’Œ`value`è¿›è¡Œäº†åˆ†ç¦»ã€‚

+ [å®˜ç½‘](https://helm.sh/zh/)
+ [åº”ç”¨ä¸­å¿ƒ](https://artifacthub.io/)

:::



## k3s helm

K3s ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„é…ç½®å°±å¯ä»¥ä½¿ç”¨ Helm å‘½ä»¤è¡Œå·¥å…·ã€‚åªè¦ç¡®ä¿ä½ å·²ç»æŒ‰ç…§[é›†ç¾¤è®¿é—®](http://docs.rancher.cn/docs/k3s/cluster-access/_index/)ä¸€èŠ‚æ­£ç¡®è®¾ç½®äº†ä½ çš„ kubeconfigã€‚ K3s é€šè¿‡ rancher/helm-release CRD ä½¿ä¼ ç»Ÿçš„ Kubernetes èµ„æºæ¸…å•å’Œ Helm Charts éƒ¨ç½²æ›´åŠ å®¹æ˜“ã€‚



### è‡ªåŠ¨éƒ¨ç½² Helm charts

åœ¨`/var/lib/rancher/k3s/server/manifests`ä¸­æ‰¾åˆ°çš„ä»»ä½• Kubernetes æ¸…å•å°†ä»¥ç±»ä¼¼`kubectl apply`çš„æ–¹å¼è‡ªåŠ¨éƒ¨ç½²åˆ° K3sã€‚ä»¥è¿™ç§æ–¹å¼éƒ¨ç½²çš„ manifests æ˜¯ä½œä¸º AddOn è‡ªå®šä¹‰èµ„æºæ¥ç®¡ç†çš„ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œ`kubectl get addon -A`æ¥æŸ¥çœ‹ã€‚ä½ ä¼šå‘ç°æ‰“åŒ…ç»„ä»¶çš„ AddOnsï¼Œå¦‚ CoreDNSã€Local-Storageã€Traefik ç­‰ã€‚AddOns æ˜¯ç”±éƒ¨ç½²æ§åˆ¶å™¨è‡ªåŠ¨åˆ›å»ºçš„ï¼Œå¹¶æ ¹æ®å®ƒä»¬åœ¨ manifests ç›®å½•ä¸‹çš„æ–‡ä»¶åå‘½åã€‚

ä¹Ÿå¯ä»¥å°† Helm Chart ä½œä¸º AddOns éƒ¨ç½²ã€‚K3s åŒ…æ‹¬ä¸€ä¸ª[Helm Controller](https://github.com/rancher/helm-controller/)ï¼Œå®ƒä½¿ç”¨ HelmChart Custom Resource Definition(CRD)ç®¡ç† Helm Chartã€‚



### ä½¿ç”¨ Helm CRD

[HelmChart CRD](https://github.com/rancher/helm-controller#helm-controller)æ•è·äº†å¤§å¤šæ•°ä½ é€šå¸¸ä¼šä¼ é€’ç»™`helm`å‘½ä»¤è¡Œå·¥å…·çš„é€‰é¡¹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œè¯´æ˜å¦‚ä½•ä»é»˜è®¤çš„ Chart èµ„æºåº“ä¸­éƒ¨ç½² Grafanaï¼Œè¦†ç›–ä¸€äº›é»˜è®¤çš„ Chart å€¼ã€‚è¯·æ³¨æ„ï¼ŒHelmChart èµ„æºæœ¬èº«åœ¨ `kube-system` å‘½åç©ºé—´ï¼Œä½† Chart èµ„æºå°†è¢«éƒ¨ç½²åˆ° `monitoring` å‘½åç©ºé—´ã€‚

```yaml
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: grafana
  namespace: kube-system
spec:
  chart: stable/grafana
  targetNamespace: monitoring
  set:
    adminPassword: "NotVerySafePassword"
  valuesContent: |-
    image:
      tag: master
    env:
      GF_EXPLORE_ENABLED: true
    adminUser: admin
    sidecar:
      datasources:
        enabled: true
```



### HelmChart å­—æ®µå®šä¹‰

| å­—æ®µ                 | é»˜è®¤å€¼  | æè¿°                                                         | Helm Argument / Flag Equivalent |
| :------------------- | :------ | :----------------------------------------------------------- | :------------------------------ |
| name                 | N/A     | Helm Chart åç§°                                              | NAME                            |
| spec.chart           | N/A     | ä»“åº“ä¸­çš„ Helm Chart åç§°ï¼Œæˆ–å®Œæ•´çš„ HTTPS URLï¼ˆ.tgzï¼‰ã€‚       | CHART                           |
| spec.targetNamespace | default | Helm Chart ç›®æ ‡å‘½åç©ºé—´                                      | `--namespace`                   |
| spec.version         | N/A     | Helm Chart ç‰ˆæœ¬(ä»ç‰ˆæœ¬åº“å®‰è£…æ—¶ä½¿ç”¨çš„ç‰ˆæœ¬å·)                  | `--version`                     |
| spec.repo            | N/A     | Helm Chart ç‰ˆæœ¬åº“ URL åœ°å€                                   | `--repo`                        |
| spec.helmVersion     | v3      | Helm çš„ç‰ˆæœ¬å·ï¼Œå¯é€‰å€¼ä¸º `v2` å’Œ`v3`ï¼Œé»˜è®¤å€¼ä¸º `v3`           | N/A                             |
| spec.set             | N/A     | è¦†ç›–ç®€å•çš„é»˜è®¤ Chart å€¼ã€‚è¿™äº›å€¼ä¼˜å…ˆäºé€šè¿‡ valuesContent è®¾ç½®çš„é€‰é¡¹ã€‚ | `--set` / `--set-string`        |
| spec.jobImage        |         | æŒ‡å®šå®‰è£… helm chart æ—¶è¦ä½¿ç”¨çš„é•œåƒã€‚å¦‚ï¼šrancher/klipper-helm:v0.3.0ã€‚ |                                 |
| spec.valuesContent   | N/A     | é€šè¿‡ YAML æ–‡ä»¶å†…å®¹è¦†ç›–å¤æ‚çš„é»˜è®¤ Chart å€¼ã€‚                  | `--values`                      |
| spec.chartContent    | N/A     | Base64 ç¼–ç çš„ Chart å­˜æ¡£.tgz - è¦†ç›– spec.chartã€‚             | CHART                           |

æ”¾åœ¨`/var/lib/rancher/k3s/server/static/`ä¸­çš„å†…å®¹å¯ä»¥é€šè¿‡ Kubernetes APIServer ä»é›†ç¾¤å†…åŒ¿åè®¿é—®ã€‚è¿™ä¸ª URL å¯ä»¥ä½¿ç”¨`spec.chart`å­—æ®µä¸­çš„ç‰¹æ®Šå˜é‡`%{KUBERNETES_API}%`è¿›è¡Œæ¨¡æ¿åŒ–ã€‚ä¾‹å¦‚ï¼Œæ‰“åŒ…åçš„ Traefik ç»„ä»¶ä»`https://%{KUBERNETES_API}%/static/charts/traefik-1.81.0.tgz`åŠ è½½å…¶ Chartã€‚



### ä½¿ç”¨ HelmChartConfig è‡ªå®šä¹‰æ‰“åŒ…çš„ç»„ä»¶

ä¸ºäº†å…è®¸è¦†ç›–ä½œä¸º HelmChartsï¼ˆå¦‚ Traefikæˆ–å…¶ä»–é€šè¿‡helm crd éƒ¨ç½²çš„åº”ç”¨ï¼‰éƒ¨ç½²çš„æ‰“åŒ…ç»„ä»¶çš„å€¼ï¼Œä» v1.19.0+k3s1 å¼€å§‹çš„ K3s ç‰ˆæœ¬æ”¯æŒé€šè¿‡ HelmChartConfig CRD éƒ¨ç½²ã€‚HelmChartConfig èµ„æºå¿…é¡»ä¸å…¶å¯¹åº”çš„ HelmChart çš„åç§°å’Œå‘½åç©ºé—´ç›¸åŒ¹é…ï¼Œå¹¶æ”¯æŒæä¾›é¢å¤–çš„ "valuesContent"ï¼Œå®ƒä½œä¸ºä¸€ä¸ªé¢å¤–çš„å€¼æ–‡ä»¶ä¼ é€’ç»™`helm`å‘½ä»¤ã€‚

> **æ³¨æ„ï¼š** HelmChart çš„`spec.set`å€¼è¦†ç›–äº† HelmChart å’Œ HelmChartConfig çš„`spec.valuesContent`è®¾ç½®ã€‚

```yaml
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: grafana
  namespace: kube-system
spec:
  valuesContent: |-
    service:
      type: NodePort
```

å¦‚æœè¦è‡ªå®šä¹‰æ‰“åŒ…åçš„ Traefik å…¥å£é…ç½®ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º`/var/lib/rancher/k3s/server/manifests/traefik-config.yaml`çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶å¡«å……ä¸ºä»¥ä¸‹å†…å®¹ã€‚





::: details å‘½ä»¤é€ŸæŸ¥
helmå¸¸ç”¨å‘½ä»¤ï¼š

1ã€æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```service httpd status```

2ã€å¯åŠ¨æœåŠ¡

```service httpd start```

3ã€åœæ­¢æœåŠ¡

```service httpd stop```

4ã€é‡å¯æœåŠ¡

```service httpd restart```

5ã€é‡è½½é…ç½®æ–‡ä»¶

```service httpd reload```

6ã€æŸ¥çœ‹ç«¯å£å ç”¨æƒ…å†µ

```netstat -tunlp```

7ã€æŸ¥çœ‹httpdè¿›ç¨‹

```ps -ef | grep httpd```

8ã€æŸ¥çœ‹httpdç‰ˆæœ¬

```httpd -v```

9ã€æŸ¥çœ‹httpdé…ç½®æ–‡ä»¶

```httpd -V```

10ã€æŸ¥çœ‹httpdæ¨¡å—

```httpd -l```

11ã€æŸ¥çœ‹httpdæ¨¡å—è¯¦ç»†ä¿¡æ¯

```httpd -M```

12ã€æŸ¥çœ‹httpdå®‰è£…è·¯å¾„

```httpd -V | grep SERVER_CONFIG_FILE```

13ã€æŸ¥çœ‹httpdé”™è¯¯æ—¥å¿—

```cat /var/log/httpd/error_log```

14ã€æŸ¥çœ‹httpdè®¿é—®æ—¥å¿—

```cat /var/log/httpd/access_log```

15ã€æŸ¥çœ‹httpdé…ç½®æ–‡ä»¶

```cat /etc/httpd/conf/httpd.conf```

16ã€æŸ¥çœ‹httpdé…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å—

```cat /etc/httpd/conf/httpd.conf | grep LoadModule```

17ã€æŸ¥çœ‹httpdé…ç½®æ–‡ä»¶ä¸­çš„è™šæ‹Ÿä¸»æœº

```cat /etc/httpd/conf/httpd.conf | grep VirtualHost```

18ã€æŸ¥çœ‹httpdé…ç½®æ–‡ä»¶ä¸­çš„ç›‘å¬ç«¯å£

```cat /etc/httpd/conf/httpd.conf | grep Listen```

:::



::: danger hemlè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
æˆ‘ä»¬éƒ¨ç½²åº”ç”¨ï¼Ÿ

`k8s` ä¸Šçš„åº”ç”¨å¯¹è±¡ï¼Œéƒ½æ˜¯ç”±ç‰¹å®šçš„èµ„æºæè¿°ç»„æˆï¼Œ åŒ…æ‹¬ `deployment`ã€`service` ç­‰ï¼Œéƒ½ä¿å­˜åœ¨å„è‡ªæ–‡ä»¶ä¸­æˆ–è€…é›†æˆåˆ°ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ `kubectl apply -f` éƒ¨ç½²

> **æˆ‘ä»¬éƒ¨ç½²å°çš„åº”ç”¨ç¨‹åºè‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯éƒ¨ç½²ä¸€ä¸ªå¤æ‚çš„åº”ç”¨ç®¡ç† `yaml` æ–‡ä»¶ï¼Œå¯èƒ½å°±æœ‰äº›éº»çƒ¦ã€‚**

**æˆ‘ä»¬éœ€è¦ï¼š**

1. å¦‚ä½•å°†è¿™äº›æœåŠ¡ä½œä¸ºä¸€ä¸ªæ•´ä½“ç®¡ç†
2. è¿™äº›èµ„æºæ–‡ä»¶å¦‚ä½•é«˜æ•ˆå¤ç”¨
3. ä¸æ”¯æŒåº”ç”¨çº§åˆ«çš„ç‰ˆæœ¬ç®¡ç†

:::



helmå°±èƒ½è§£å†³è¿™äº›é—®é¢˜ï¼Œå®ƒå°±ç±»ä¼¼äºLinuxä¸­çš„`yum`åŒ…æˆ–è€…`apt`åŒ…ã€‚



::: tip 

+ [å¼€æºé¡¹ç›®åœ°å€](https://github.com/helm/helm)

Helm æ˜¯ Kubernetes çš„é¦–é€‰åŒ…ç®¡ç†å·¥å…·ã€‚Helm Chart ä¸º Kubernetes YAML æ¸…å•æ–‡ä»¶æä¾›äº†æ¨¡æ¿åŒ–è¯­æ³•ã€‚é€šè¿‡ Helmï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¯é…ç½®çš„éƒ¨ç½²ï¼Œè€Œä¸ä»…ä»…æ˜¯ä½¿ç”¨é™æ€æ–‡ä»¶ã€‚æœ‰å…³åˆ›å»ºè‡ªå·±çš„éƒ¨ç½²ç›®å½•çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[Helm å¿«é€Ÿå…¥é—¨](https://helm.sh/docs/intro/quickstart/)ã€‚

K3s ä¸éœ€è¦ä»»ä½•ç‰¹æ®Šçš„é…ç½®å°±å¯ä»¥ä½¿ç”¨ Helm å‘½ä»¤è¡Œå·¥å…·ã€‚åªè¦ç¡®ä¿ä½ å·²ç»æŒ‰ç…§[é›†ç¾¤è®¿é—®](https://docs.rancher.cn/docs/k3s/cluster-access/_index)ä¸€èŠ‚æ­£ç¡®è®¾ç½®äº†ä½ çš„ kubeconfigã€‚ K3s åŒ…å«äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œé€šè¿‡[rancher/helm-release CRD](https://docs.rancher.cn/docs/k3s/helm/_index#ä½¿ç”¨-helm-crd)ï¼Œä½¿ä¼ ç»Ÿçš„ Kubernetes èµ„æºæ¸…å•å’Œ Helm Charts éƒ¨ç½²æ›´åŠ å®¹æ˜“ã€‚

:::



## v2 vs v3

**ç®€å•æ¥è¯´ï¼ŒHelmå°±æ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹éƒ¨ç½²k8såº”ç”¨çš„å·¥å…·**

::: tip helm v3 vs v2ç‰¹æ€§
å¦å¤–ï¼Œå¸¸ç”¨çš„Helmç‰ˆæœ¬æœ‰v2è·Ÿv3ï¼ŒHelm v3åŒºåˆ«äºv2ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

+ ç§»é™¤äº†Tiller(from SA to kubeconfig)
+ ä¸‰æ–¹ä¼šè°ˆ (Three-way Strategic merge patch)
+ ä½¿ç”¨Secretä½œä¸ºé»˜è®¤å­˜å‚¨

:::



### åŒºåˆ«å¯¹æ¯”

**1ã€ç§»é™¤äº†Tiller(from SA to kubeconfig)**

åŸæ¥Helm v2éœ€è¦åœ¨ Kubernetes é›†ç¾¤ä¸­éƒ¨ç½²`Tiller`ï¼ˆ`Tiller` ç”¨äºæ¥æ”¶ Helm çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ® `Chart` ç”Ÿæˆ Kubernetes çš„éƒ¨ç½²æ–‡ä»¶ï¼‰ï¼Œ`Tiller pod` æ ¹æ®è‡ªèº«SAæƒé™éƒ¨ç½²åº”ç”¨ã€‚å¹¶ä¸”åœ¨å¤šç§Ÿæˆ·ç¯å¢ƒä¸‹ï¼Œä¸ºäº†è¿›è¡Œæƒé™ç®¡ç†éœ€è¦éƒ¨ç½²å¤šä¸ª`Tiller`ã€‚

![img](http://sm.nsddd.top/smwebp)åœ¨ Helm v3 ä¸­ï¼ŒTiller è¢«ç§»é™¤äº†ã€‚**æ–°çš„ Helm å®¢æˆ·ç«¯ä¼šåƒ kubectl å‘½ä»¤ä¸€æ ·ï¼Œè¯»å–æœ¬åœ°çš„ kubeconfig æ–‡ä»¶ï¼Œä½¿ç”¨æˆ‘ä»¬åœ¨ kubeconfig ä¸­é¢„å…ˆå®šä¹‰å¥½çš„SAæƒé™æ¥è¿›è¡Œä¸€ç³»åˆ—æ“ä½œã€‚è¿™æ ·åšæ³•å³ç®€å•ï¼Œåˆå®‰å…¨ã€‚**



**2ã€ä¸‰æ–¹ä¼šè°ˆ (Three-way Strategic merge patch)**

ä¼šå…¼å®¹é€šè¿‡ç¬¬ä¸‰æ–¹ä¿®æ”¹çš„å±æ€§ï¼ˆå¦‚é€šè¿‡kubectl editä¿®æ”¹çš„å±æ€§ï¼Œåœ¨helm upgradeæ—¶ä¼šè€ƒè™‘è¿›å»ï¼‰

![img](http://sm.nsddd.top/smwebp2)



**3ã€ä½¿ç”¨Secretä½œä¸ºé»˜è®¤å­˜å‚¨**



**4ã€crd-install hookè¿ç§»åˆ°äº†crds/è·¯å¾„ç­‰**

::: details ä»€ä¹ˆæ˜¯CRDï¼Ÿ
CRD(Custom Resource Define) è‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼Œæ˜¯åœ¨k8sé«˜ç‰ˆæœ¬ï¼ˆv1.7+ï¼‰ä¸Šæ–°å¢åŠ çš„æ–°ç‰¹æ€§ï¼Œä¸ºäº†æé«˜æ‹“å±•æ€§ï¼Œè®©å¼€å‘è€…å¯ä»¥è‡ªå·±å»å®šä¹‰k8sèµ„æºå¯¹è±¡ã€‚

å®é™…è¿è¡Œæ—¶æ˜¯ä»¥CRï¼ˆCustom Resourseè‡ªå®šä¹‰èµ„æºï¼‰å…·ä½“å®ä¾‹è¿›è¡Œå‘ˆç°ã€‚

**å½“å‰å·²ç»å­˜åœ¨çš„å®˜æ–¹èµ„æºï¼š**

+ `Pod`ï¼šæ˜¯ä¸€ç§é›†åˆäº†å¤šä¸ªåº”ç”¨å®¹å™¨ã€å­˜å‚¨èµ„æºã€ä¸“ç”¨IPåŠæ”¯æ’‘å®¹å™¨è¿è¡Œå…¶ä»–é…ç½®é€‰é¡¹çš„é€»è¾‘ç»„ä»¶ï¼Œæ˜¯k8séƒ¨ç½²å•å…ƒå’ŒåŸå­è¿è¡Œå•å…ƒï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªè¿è¡Œå¤šä¸ªåº”ç”¨ç¨‹åºçš„å•ä¸€è¿è¡Œå®ä¾‹ï¼Œé€šè¿‡å…±äº«èµ„æºç›¸äº’è”ç³»çš„åº”ç”¨å®¹å™¨ã€‚é€šä¿—çš„è®²ï¼Œpodæ˜¯ä¸€ä¸ªç‰©ç†ä¸»æœºæˆ–VMä¸»æœºï¼Œpodä¸­çš„åº”ç”¨å®¹å™¨å°±æ˜¯ä¸»æœºä¸Šçš„è¿›ç¨‹ï¼Œå½¼æ­¤éš”ç¦»ã€‚
+ `ReplicaSet`ï¼šå®šä¹‰ä¸€ç»„ä»»ä½•æ—¶å€™éƒ½å¤„äºè¿è¡ŒçŠ¶æ€çš„podå‰¯æœ¬çš„ç¨³å®šé›†åˆèµ„æºï¼Œä¿è¯è¿è¡ŒæŒ‡å®šæ•°é‡çš„ã€å®Œå…¨ç›¸åŒçš„podçš„å¯ç”¨æ€§ã€‚
+ `ReplicationController`ï¼šè·ŸReplicaSetæ˜¯ä¸€æ ·çš„ï¼Œç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰ç‰¹å®šæ•°é‡çš„ Pod å‰¯æœ¬å¤„äºè¿è¡ŒçŠ¶æ€ã€‚ æ¢å¥è¯è¯´ï¼ŒReplicationController ç¡®ä¿ä¸€ä¸ª Pod æˆ–ä¸€ç»„åŒç±»çš„ Pod æ€»æ˜¯å¯ç”¨çš„ã€‚ä½†æ˜¯æ›´æ¨èä½¿ç”¨ReplicaSetçš„Deploymentå»å»ºç«‹å‰¯æœ¬ã€‚
+ `Deployment`ï¼šè¯¥å¯¹è±¡æ˜¯ç”¨æ¥æè¿°podå’ŒReplicaSetå‰¯æœ¬çš„ç›®æ ‡çŠ¶æ€ï¼Œå¹¶æ›´æ–°ä»–ä»¬ä¸ç¬¦åˆæœŸæœ›æ—¶çš„çŠ¶æ€ã€‚
+ `StatefulSet`ï¼šè¯¥èµ„æºå¯¹è±¡ç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨podçš„å·¥ä½œè´Ÿè½½ï¼Œæ”¯æŒpodé›†åˆçš„éƒ¨ç½²å’Œæ‰©å®¹ã€ç¼©å®¹ã€‚
+ `DaemonSet`ï¼šè¯¥å¯¹è±¡ç”¨æ¥ç¡®ä¿å…¨éƒ¨æˆ–è€…éƒ¨åˆ†èŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªpodå‰¯æœ¬ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„å®ˆæŠ¤è¿›ç¨‹ã€‚
+ `Job`ï¼šè¯¥å¯¹è±¡ç”¨æ¥æ‰§è¡Œç›®æ ‡çŠ¶æ€çš„podå‰¯æœ¬çš„ä¸€ä¸ªä»»åŠ¡ï¼Œç›¸å½“äºä¸€ä¸ªç›‘å¬ä»»åŠ¡ï¼Œå®æ—¶æ§åˆ¶podå‰¯æœ¬è¾¾åˆ°æœŸæœ›çŠ¶æ€ã€‚
+ `CronJob`ï¼šè¿™æ˜¯ä¸€ä¸ªæœ‰æ—¶é—´å‘¨æœŸçš„Jobã€‚
+ `HorizontalPodAutoscaling`ï¼šè¯¥å¯¹è±¡ä¸ºpodæ°´å¹³è‡ªåŠ¨æ‰©ç¼©ï¼Œè‡ªåŠ¨æ›´æ–°å·¥ä½œè´Ÿè½½èµ„æºï¼ˆDeploymentå’ŒStatefulSetï¼‰ï¼Œç›®çš„æ˜¯è‡ªåŠ¨æ‰©ç¼©å·¥ä½œè´Ÿè½½ä»¥æ»¡è¶³éœ€æ±‚ã€‚
+ `Node`ï¼šèŠ‚ç‚¹æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è€…ç‰©ç†æœºï¼ŒèŠ‚ç‚¹ä¸Šè¿è¡Œpodæ‰€éœ€çš„å®¹å™¨ã€‚
+ `Namespace`ï¼šå‘½åç©ºé—´ï¼Œæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå°†åŒä¸€é›†ç¾¤çš„èµ„æºåˆ’åˆ†ä¸€ä¸ªç›¸äº’éš”ç¦»çš„ç»„ã€‚
+ `Service`ï¼šå°±æ˜¯è¿è¡Œåœ¨podä¸Šçš„æä¾›æœåŠ¡çš„ç»„ä»¶ï¼Œå¦‚å¾®æœåŠ¡ç»„ä»¶ã€‚
+ `Ingress`ï¼šæ˜¯å„ä¸ªæœåŠ¡serviceç›¸äº’è®¿é—®çš„ä¸€ä¸ªä¸­é—´è·¯ç”±ç®¡ç†å™¨ï¼Œå¯ä»¥å®ç°æµé‡æ§åˆ¶ç­‰ã€‚
+ `Label`ï¼šä¸ºæ¯ä¸ªå¯¹è±¡å®šä¹‰æ ‡ç­¾ï¼Œç”¨äºæ ‡ç­¾é€‰æ‹©å™¨å¯ä»¥é«˜æ•ˆåœ°æŸ¥è¯¢å’Œç›‘å¬k8så¯¹è±¡ã€‚
+ `CustomResourceDefinition`ï¼šç”¨äºå¼€å‘è€…è‡ªå®šä¹‰çš„èµ„æºå¯¹è±¡ã€‚

:::

**å¦‚ä½•ä½¿ç”¨CRDï¼š**

CRD èµ„æºå¯ä»¥åŠ¨æ€æ³¨å†Œåˆ°é›†ç¾¤ä¸­ï¼Œæ³¨å†Œå®Œæ¯•åï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ kubectl æ¥åˆ›å»ºè®¿é—®è¿™ä¸ªè‡ªå®šä¹‰çš„èµ„æºå¯¹è±¡ï¼Œç±»ä¼¼äºæ“ä½œ Pod ä¸€æ ·ã€‚



## Helm Controller

Helm Controllerå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªCRD Controllerï¼Œç®¡ç†çš„æ˜¯HelmChartç±»å‹çš„CRD API

![img](http://sm.nsddd.top/sm23094781.png)



**è®¾è®¡åŸç†ï¼š**

1ã€`Helm-controller` è¿è¡Œåœ¨`master`èŠ‚ç‚¹å¹¶`list/watch HelmChart CRD`å¯¹è±¡

2ã€`CRD onChange`æ—¶æ‰§è¡Œ`Job`æ›´æ–°

3ã€`Job Container`ä½¿ç”¨`rancher/kilipper-helm`ä¸º`entrypoint`

4ã€`Killper-helm`å†…ç½®`helm cli`ï¼Œå¯ä»¥å®‰è£…/å‡çº§/åˆ é™¤å¯¹åº”çš„`chart`



## helmå®‰è£…

### ç”¨äºŒè¿›åˆ¶ç‰ˆæœ¬å®‰è£…

æ¯ä¸ªHelm [ç‰ˆæœ¬](https://github.com/helm/helm/releases)éƒ½æä¾›äº†å„ç§æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œè¿™äº›ç‰ˆæœ¬å¯ä»¥æ‰‹åŠ¨ä¸‹è½½å’Œå®‰è£…ã€‚

1. ä¸‹è½½ [éœ€è¦çš„ç‰ˆæœ¬](https://github.com/helm/helm/releases)
2. è§£å‹(`tar -zxvf helm-v3.0.0-linux-amd64.tar.gz`)
3. åœ¨è§£å‹ç›®ä¸­æ‰¾åˆ°`helm`ç¨‹åºï¼Œç§»åŠ¨åˆ°éœ€è¦çš„ç›®å½•ä¸­(`mv linux-amd64/helm /usr/local/bin/helm`)

ç„¶åå°±å¯ä»¥æ‰§è¡Œå®¢æˆ·ç«¯ç¨‹åºå¹¶ [æ·»åŠ ç¨³å®šä»“åº“](https://helm.sh/zh/docs/intro/quickstart/#åˆå§‹åŒ–): `helm help`.

**æ³¨æ„** é’ˆå¯¹Linux AMD64ï¼ŒHelmçš„è‡ªåŠ¨æµ‹è¯•åªæœ‰åœ¨CircleCiæ„å»ºå’Œå‘å¸ƒæ—¶æ‰ä¼šæ‰§è¡Œã€‚æµ‹è¯•å…¶ä»–æ“ä½œç³»ç»Ÿæ˜¯ç¤¾åŒºé’ˆå¯¹ç³»ç»Ÿé—®é¢˜è¯·æ±‚Helmçš„è´£ä»»ã€‚



### ä½¿ç”¨è„šæœ¬å®‰è£…

Helmç°åœ¨æœ‰ä¸ªå®‰è£…è„šæœ¬å¯ä»¥è‡ªåŠ¨æ‹‰å–æœ€æ–°çš„Helmç‰ˆæœ¬å¹¶åœ¨ [æœ¬åœ°å®‰è£…](https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3)ã€‚

æ‚¨å¯ä»¥è·å–è¿™ä¸ªè„šæœ¬å¹¶åœ¨æœ¬åœ°æ‰§è¡Œã€‚å®ƒè‰¯å¥½çš„æ–‡æ¡£ä¼šè®©æ‚¨åœ¨æ‰§è¡Œä¹‹å‰çŸ¥é“è„šæœ¬éƒ½åšäº†ä»€ä¹ˆã€‚

```bash
$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh
```

::: details 

```bash
root@cubmaster01:/workspces/runtime/ingress-nginx# ./helm.sh 
Downloading https://get.helm.sh/helm-v3.10.2-linux-amd64.tar.gz
Verifying checksum... Done.
Preparing to install helm into /usr/local/bin
helm installed into /usr/local/bin/helm
```

:::

å¦‚æœæƒ³ç›´æ¥æ‰§è¡Œå®‰è£…ï¼Œè¿è¡Œ

```bash
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```



## é…ç½®helmæº

**ä½¿ç”¨helméœ€è¦é…ç½®yamlæº,å¸¸è§çš„æœ‰é˜¿é‡Œã€‚å¾®è½¯ï¼Œå’ŒGithubä¸Šçš„æº**

+ é˜¿é‡Œäº‘çš„æº https://apphub.aliyuncs.com
+ å¾®è½¯`azure`çš„æº http://mirror.azure.cn/kubernetes/charts/



**æŸ¥çœ‹æ‰€æœ‰çš„æºï¼š**

```bash
helm repo list  #æŸ¥çœ‹æ‰€ä»¥çš„æº
```



**æ·»åŠ æŒ‡å®šçš„æºï¼š**

```bash
helm repo add azure http://mirror.azure.cn/kubernetes/charts/

helm repo add aliyun https://apphub.aliyuncs.com
```



**æŸ¥çœ‹é…ç½®çš„å­˜å‚¨åº“ï¼š**

```
helm search repo stable
```



**åˆ é™¤;**

```
helm repo remove aliyun
```



::: tip æœç´¢
å®ƒä¼šæœç´¢å½“å‰ä»“åº“æ‰€åŒ¹é…çš„æ‰€æœ‰é•œåƒæºï¼š

```
helm search 
```

:::

## å¿«é€Ÿä¸Šæ‰‹

::: warning helmå¸¸è§ç”¨æ³•ï¼š
Helmçš„å¸¸è§ç”¨æ³•ï¼ŒåŒ…æ‹¬æœç´¢Chartã€å®‰è£…Chartã€è‡ªå®šä¹‰Charté…ç½®ã€æ›´æ–°æˆ–å›æ»šReleaseã€åˆ é™¤Releaseã€åˆ›å»ºè‡ªå®šä¹‰Chartã€æ­å»ºç§æœ‰ä»“åº“ç­‰

:::



**æ£€æµ‹ç‰ˆæœ¬çš„å®‰è£…ï¼š**

```bash
root@VM-4-3-ubuntu:~# helm version
version.BuildInfo{Version:"v3.9.2", GitCommit:"1addefbfe665c350f4daf868a9adc5600cc064fd", GitTreeState:"clean", GoVersion:"go1.17.12"}
```



### å’Œdockerä¸€æ ·ï¼Œæœç´¢å¯ç”¨çš„åŒ…ï¼š

```
helm search  repo mysql
```



### helmåŒ…æ‹‰å–

å®‰è£…chartå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤å®‰è£…ï¼Œä¹Ÿå¯ä»¥æ‹‰å–åˆ°æœ¬åœ°ä¹‹åå®‰è£…ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡å‘½åè¡Œå®‰è£…

+ æœ¬åœ°çš„Chartå‹ç¼©åŒ…(helm install mysql-1.6.4.tgz)
+ ä¸€ä¸ªChartç›®å½•(helm install mysql/)
+ ä¸€ä¸ªå®Œæ•´çš„URL(helm install https://example.com/charts/mysql-1.6.4.tgz)



**chartåŒ…æ‹‰å–ï¼š**

```
helm pull azure/mysql --version=1.6.4
```

![image-20221104202213778](http://sm.nsddd.top/smimage-20221104202213778.png)



**helm installï¼šå®‰è£…Chartï¼š**

> è¿™ä¸ªå‘½ä»¤æ˜¯ç›´æ¥æ‹‰å–å®‰è£…ï¼Œè€Œä¸Šé¢çš„æ˜¯å¯ä»¥å®ç°ç¦»çº¿å®‰è£…çš„~

```bash
helm install db azure/mysql --version=1.6.4
```



**æ‹‰å–çš„chartåŒ…è¯¦ç»†ä¿¡æ¯ï¼Œé€šè¿‡è§£å‹ä¹‹åæŸ¥çœ‹ï¼š**

```
tar -zxvf mysql-1.6.4.tgz
```

![image-20221104203359659](http://sm.nsddd.top/smimage-20221104203359659.png)



**å…³é”®æ–‡ä»¶ï¼š**

![image-20221104203553063](http://sm.nsddd.top/smimage-20221104203553063.png)



**å¯¹äºä¸‹è½½å¥½çš„`yaml`æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹åä½¿ç”¨`helm package`é‡æ–°æ‰“åŒ…**

```bash
rm -rf mysql-1.6.4.tgz && helm package  mysql/
```

> æ­¤æ—¶ `mysql` ä¼šè¢«é‡æ–°æ‰“åŒ…æˆ `tar` 
>
> ```bash
> root@VM-4-3-ubuntu:~/helm# ls
> mysql  mysql-1.6.4.tgz
> ```



**ä¸‹é¢æˆ‘ä»¬ä¿®æ”¹chartä¸­çš„å¯¹åº”é•œåƒä¸ºå·²ç»ä¸‹è½½å¥½çš„mysqlå’Œbusyboxé•œåƒï¼š**

```bash
ansible 192.168.26.82 -m shell -a "docker images | grep mysql"
```



**é€šè¿‡ä¿®å¥½çš„yamlæ–‡ä»¶åˆ›å»ºchart**ï¼Œ **ä½¿ç”¨`helm ls`æŸ¥çœ‹å½“å‰è¿è¡Œçš„chart**

```
helm ls
```



**ä½¿ç”¨`helm install`è¿è¡ŒChart**

> **è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¹‹å‰çš„é‚£ä¸ªmysq chartæ¥å®‰è£…ä¸€ä¸ªmysql**

```bash
cd mysql/ && helm install mydb .
```



**æŸ¥çœ‹æ˜¯å¦æ˜¯å¦è¿è¡ŒæˆåŠŸmydbçš„podå’ŒSVC**

```bash
kubectl  get pods
kubectl  get svc
```



**å®‰è£…ä¸€ä¸ªmysqlå®¢æˆ·ç«¯æµ‹è¯•OKï¼š**

```bash
yum install  mariadb -y
mysql -h10.107.17.103 -uroot -ptesting
```





### å®‰è£…é›†ç¾¤é•œåƒ

**Add repositoryï¼š**

```bash
helm repo add redis https://spy86.github.io/redis
```



**Install chartï¼š**

```bash
helm install my-redis redis/redis --version 0.1.1
```



**ä½¿ç”¨ï¼š**

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
helm install my-mongo bitnami/mongodb

# æŒ‡å®šå¯†ç å’Œæ¶æ„
helm install my-mongo bitnami/mongodb --set architecture="replicaset",auth.rootPassword="mongopass"

# åˆ é™¤
helm ls
helm delete my-mongo

# æŸ¥çœ‹å¯†ç 
kubectl get secret my-mongo-mongodb -o json
kubectl get secret my-mongo-mongodb -o yaml > secret.yaml

# ä¸´æ—¶è¿è¡Œä¸€ä¸ªåŒ…å« mongo client çš„ debian ç³»ç»Ÿ
kubectl run mongodb-client --rm --tty -i --restart='Never' --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --command -- bash

# è¿›å» mongodb
mongo --host "my-mongo-mongodb" -u root -p mongopass

# ä¹Ÿå¯ä»¥è½¬å‘é›†ç¾¤é‡Œçš„ç«¯å£åˆ°å®¿ä¸»æœºè®¿é—® mongodb
kubectl port-forward svc/my-mongo-mongodb 27017:27018
```



## helm é…ç½®å®‰è£…é›†ç¾¤

**helm å®‰è£…è¿‡ç¨‹ä¸­æœ‰ä¸¤ç§æ–¹å¼ä¼ é€’æ•°æ®ï¼š**

+ `-f(æˆ–--values)`ï¼šä½¿ç”¨ YAML æ–‡ä»¶è¦†ç›–é»˜è®¤é…ç½®ã€‚å¯ä»¥æŒ‡å®šå¤šæ¬¡ï¼Œä¼˜å…ˆä½¿ç”¨æœ€å³è¾¹çš„æ–‡ä»¶ã€‚
+ `--set` ï¼šé€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼å¯¹æŒ‡å®šé¡¹è¿›è¡Œè¦†ç›–

::: danger æ³¨æ„
å¦‚æœåŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼ï¼Œåˆ™ `--set` ä¸­çš„å€¼ä¼šè¢«åˆå¹¶åˆ° `-f` ä¸­ï¼Œä½†æ˜¯ `â€“set` ä¸­çš„å€¼ä¼˜å…ˆçº§æ›´é«˜

:::



## END é“¾æ¥
<ul><li><div><a href = '25.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '27.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

