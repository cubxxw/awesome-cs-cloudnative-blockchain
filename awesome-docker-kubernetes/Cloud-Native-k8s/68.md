+ [author](http://nsddd.top)

# ç¬¬68èŠ‚ Reflector åŸç†

<div><a href = '67.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '69.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•æ–°æ—¶ä»£æ‹¥æŠ±äº‘åŸç”Ÿï¼Œäº‘åŸç”Ÿå…·æœ‰ç¯å¢ƒç»Ÿä¸€ã€æŒ‰éœ€ä»˜è´¹ã€å³å¼€å³ç”¨ã€ç¨³å®šæ€§å¼ºç‰¹ç‚¹ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## ä»‹ç»

`reflector`åœ¨ `client-go` é‡Œé¢çš„ä¸»è¦ä½œç”¨æ˜¯ä¸`apiserver`è¿›è¡Œäº¤äº’ï¼Œè·å–è‡ªå®šä¹‰èµ„æºæ•°æ®æ›´æ–°åˆ° `Delta FIFO` é˜Ÿåˆ—é‡Œé¢ï¼Œæ‰€ä»¥å®ƒä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†åŠŸèƒ½ï¼Œä¸€éƒ¨åˆ†æ˜¯listå’Œwatchçš„åŠŸèƒ½ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æ›´æ–°ç¼“å­˜çš„åŠŸèƒ½ã€‚

```go
func NewReflector(lw ListerWatcher, expectedType interface{}, store Store, resyncPeriod time.Duration) *Reflector {
  ...
}
```

**å‚æ•°è¯´æ˜ï¼š**

+ `lw`: `ListerWatcher` æ¥å£çš„å®ç°ï¼Œç”¨äºè·å– Kubernetes API Server ä¸­èµ„æºçš„çŠ¶æ€ã€‚
+ `expectedType`: æŒ‡å®šäº†éœ€è¦è¢«å¤„ç†çš„ Kubernetes API å¯¹è±¡çš„ç±»å‹ã€‚
+ `store`: å­˜å‚¨ Kubernetes èµ„æºå¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Œç”¨äºä¸ Kubernetes API äº¤äº’ã€‚
+ `resyncPeriod`: å‘¨æœŸæ€§åœ°é‡æ–°åŒæ­¥èµ„æºå¯¹è±¡çš„æ—¶é—´é—´éš”ã€‚



**æ³¨æ„ï¼š**

`Kubernetes` ä¸­å¯¹ API Server æ˜¯ä¸€ä¸ªé•¿è¿æ¥è€Œä¸æ˜¯è½®è¯¢ã€‚

List å’Œ Watch å¯ä»¥ä¿è¯ å¯é æ€§ã€å®æ—¶æ€§å’Œé¡ºåºæ€§ã€‚

+ `List` æ–¹æ³•æŒ‡å®šç±»å‹èµ„æºå¯¹è±¡å…¨é‡æ›´æ–°ï¼Œå¹¶ä¸”æ›´æ–°åˆ°ç¼“å­˜ä¸Šã€‚å¯ä»¥åˆ—å‡º Kubernetes API Server ä¸­æŒ‡å®šç±»å‹çš„æ‰€æœ‰èµ„æºå¯¹è±¡ã€‚

  ```
  curl -iv https://127.0.0.1:8001/api/v1/namespaces/default/pods
  ```

+ `Watch` æ–¹æ³•å¯ä»¥ç›‘å¬ Kubernetes API Server ä¸­æŒ‡å®šç±»å‹çš„èµ„æºå¯¹è±¡çš„å˜åŒ–ï¼Œå½“èµ„æºå¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè¿”å›ä¸€ä¸ª `watch.Event` å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†å‘ç”Ÿå˜åŒ–çš„èµ„æºå¯¹è±¡çš„ä¿¡æ¯ã€‚å‡å¦‚è¦ç›‘å¬podçš„å˜åŒ–æ—¶ï¼Œå¯ä»¥åœ¨Listè¿™ä¸ªAPIä¸ŠåŠ ä¸€ä¸ªå‚æ•°`watch=true` å°±å¯ä»¥ç›‘å¬èµ„æºå¯¹è±¡çš„äº‹ä»¶å˜åŒ–ï¼‰ã€‚

  ```
  curl -iv https://127.0.0.1:8001/api/v1/namespaces/default/pod\?watch\=ture
  ```



## ResourceVersionä¸Bookmarks

### ResourceVersion

åœ¨K8Sä¸­æ¯ä¸€ä¸ªèµ„æºå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªResourceVersionï¼Œå½“èµ„æºå¯¹è±¡å‘ç”Ÿå˜æ›´æ—¶ResourceVersionå°±ä¼šå‘ç”Ÿé€’å¢çš„å˜æ›´ï¼Œä½¿å¯¹åº”åˆ° ETCD çš„ `reversion` çš„å˜æ›´

+ ä¿è¯å®¢æˆ·ç«¯æ•°æ®ä¸€è‡´æ€§å’Œé¡ºåºæ€§
+ å¹¶å‘æ§åˆ¶(å¯ä»¥ä¿è¯å¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘å»æ›´æ”¹èµ„æºå¯¹è±¡æ—¶ï¼Œå‡ºç°çš„å¹¶å‘é—®é¢˜)



**Bookmarksï¼š**

+ å‡å°‘apiserverè´Ÿè½½ï¼ˆé«˜ç‰ˆæœ¬çš„apiserveræ‰æ”¯æŒBookmarksï¼‰
+ æ›´æ–°å®¢æˆ·ç«¯ä¿å­˜çš„æœ€è¿‘ä¸€æ¬¡ResourceVersion

> æ‰€ä»¥è¯´æˆ‘ä»¬çš„å®¢æˆ·ç«¯å½“æ¥å—åˆ°bookmarkçš„äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªäº‹ä»¶é‡Œé¢çš„ResourceVersionæå–å‡ºæ¥ï¼Œç„¶åæ›´æ–°æˆ‘ä»¬æœ¬åœ°çš„ResourceVersionï¼Œç„¶åæ¥ç€ä»¥è¿™ä¸ªResourceVersionå»watchæˆ‘ä»¬çš„èµ„æºå¯¹è±¡çš„å˜æ›´ã€‚

Bookmarksæ˜¯Kubernetes API Serverçš„ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯åœ¨é•¿è½®è¯¢è¯·æ±‚ä¸­ä¼ é€’ä¸€ä¸ªæ‰€è°“çš„â€œä¹¦ç­¾â€ï¼Œè¿™ä¸ªä¹¦ç­¾æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒæè¿°äº†å®¢æˆ·ç«¯æœ€åä¸€æ¬¡çœ‹åˆ°çš„èµ„æºç‰ˆæœ¬ã€‚è¿™æ ·ï¼ŒAPI Serverå°±å¯ä»¥åªè¿”å›æ–°çš„æˆ–æ›´æ–°çš„èµ„æºï¼Œè€Œä¸æ˜¯æ•´ä¸ªèµ„æºåˆ—è¡¨ã€‚è¿™æ ·å¯ä»¥å‡å°‘ç½‘ç»œæµé‡å’ŒAPI Serverçš„è´Ÿè½½ã€‚

æ‰€ä»¥è¯´æˆ‘ä»¬çš„å®¢æˆ·ç«¯å½“æ¥å—åˆ°`bookmark`çš„äº‹ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¿™ä¸ªäº‹ä»¶é‡Œé¢çš„ResourceVersionæå–å‡ºæ¥ï¼Œç„¶åæ›´æ–°æˆ‘ä»¬æœ¬åœ°çš„ResourceVersionï¼Œç„¶åæ¥ç€ä»¥è¿™ä¸ªResourceVersionå»watchæˆ‘ä»¬çš„èµ„æºå¯¹è±¡çš„å˜æ›´ã€‚



## Reflectorä¸RESTClient

æˆ‘ä»¬çŸ¥é“ Kubernetes ä¸­ æ‰€æœ‰çš„ç»„ä»¶éœ€è¦å»æ“ä½œé›†ç¾¤èµ„æºçš„æ—¶å€™éƒ½éœ€è¦é€šè¿‡è°ƒç”¨ kube-apiserver æä¾›çš„ RESTful æ¥å£ï¼Œkube-apiserver è¿›ä¸€æ­¥å’Œ ETCD äº¤äº’ï¼Œå®Œæˆèµ„æºçš„ä¿¡æ¯æ›´æ–°ã€‚

é‚£ä¹ˆ Reflectorå¦‚æœè¦è·Ÿapiserverè¿›è¡Œäº¤äº’çš„è¯ï¼Œå°±ä¼šé€šè¿‡RESTClientæˆ–è€…æ˜¯å…¶ä»–çš„clientã€‚ä»¥ä¸‹ä¾‹å­æ˜¯`informer`é‡Œé¢çš„ï¼Œå®ƒå®ç°äº†ç›¸åº”çš„æ¥å£ï¼Œå¹¶æä¾›äº†listå’Œwatchæ–¹æ³•ï¼Œé‡Œé¢çš„é€»è¾‘å°±æ˜¯è°ƒç”¨çš„clientsetã€‚

```go
        ...
        &cache.ListWatch{
            ListFunc: func(options metav1.ListOptions) (runtime.Object, error) {
                if tweakListOptions != nil {
                    tweakListOptions(&options)
                }
                return client.CoreV1().Pods(namespace).List(context.TODO(), options)
            },
            WatchFunc: func(options metav1.ListOptions) (watch.Interface, error) {
                if tweakListOptions != nil {
                    tweakListOptions(&options)
                }
                return client.CoreV1().Pods(namespace).Watch(context.TODO(), options)
            },
        },
        ...
```









## END é“¾æ¥

<ul><li><div><a href = '67.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '69.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

