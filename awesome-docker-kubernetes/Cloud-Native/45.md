+ [author](http://nsddd.top)

# ç¬¬45èŠ‚ OpenMI å‘æ¶ˆæ¯çš„æ—¶å€™åšäº†ä»€ä¹ˆ

<div><a href = '44.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '46.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## æµç¨‹

```go
func (c *Conversation) CreateTextMessage(ctx context.Context, text string) (*sdk_struct.MsgStruct, error) {
	s := sdk_struct.MsgStruct{}
	err := c.initBasicInfo(ctx, &s, constant.UserMsgType, constant.Text)
	if err != nil {
		return nil, err
	}
	s.Content = text
	return &s, nil
}
func (c *Conversation) CreateAdvancedTextMessage(ctx context.Context, text string, messageEntities []*sdk_struct.MessageEntity) (*sdk_struct.MsgStruct, error) {
	s := sdk_struct.MsgStruct{}
	err := c.initBasicInfo(ctx, &s, constant.UserMsgType, constant.AdvancedText)
	if err != nil {
		return nil, err
	}
	s.MessageEntityElem.Text = text
	s.MessageEntityElem.MessageEntityList = messageEntities
	s.Content = utils.StructToJsonString(s.MessageEntityElem)
	return &s, nil
}
```

1. `CreateTextMessage(ctx context.Context, text string) (*sdk_struct.MsgStruct, error)`ï¼šè¿™ä¸ªæ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªæ™®é€šæ–‡æœ¬æ¶ˆæ¯ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡`ctx`å’Œä¸€ä¸ªå­—ç¬¦ä¸²`text`ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘`sdk_struct.MsgStruct`ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆå’Œä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚è¯¥æ–¹æ³•é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„`sdk_struct.MsgStruct`å¯¹è±¡`s`ï¼Œç„¶åè°ƒç”¨`initBasicInfo`æ–¹æ³•æ¥åˆå§‹åŒ–æ¶ˆæ¯çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ç±»å‹å’Œå†…å®¹ç±»å‹ã€‚æœ€åï¼Œå°†æ–‡æœ¬æ¶ˆæ¯å†…å®¹`text`èµ‹å€¼ç»™`s.Content`å­—æ®µï¼Œå¹¶è¿”å›`s`æŒ‡é’ˆå’Œnilã€‚
2. `CreateAdvancedTextMessage(ctx context.Context, text string, messageEntities []*sdk_struct.MessageEntity) (*sdk_struct.MsgStruct, error)`ï¼šè¿™ä¸ªæ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªé«˜çº§æ–‡æœ¬æ¶ˆæ¯ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯å®ä½“ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡`ctx`ã€ä¸€ä¸ªå­—ç¬¦ä¸²`text`å’Œä¸€ä¸ª`sdk_struct.MessageEntity`ç±»å‹çš„åˆ‡ç‰‡`messageEntities`ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘`sdk_struct.MsgStruct`ç±»å‹å¯¹è±¡çš„æŒ‡é’ˆå’Œä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚è¯¥æ–¹æ³•é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„`sdk_struct.MsgStruct`å¯¹è±¡`s`ï¼Œç„¶åè°ƒç”¨`initBasicInfo`æ–¹æ³•æ¥åˆå§‹åŒ–æ¶ˆæ¯çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¶ˆæ¯ç±»å‹å’Œå†…å®¹ç±»å‹ã€‚æ¥ä¸‹æ¥ï¼Œå°†æ–‡æœ¬æ¶ˆæ¯å†…å®¹`text`èµ‹å€¼ç»™`s.MessageEntityElem.Text`å­—æ®µï¼Œå¹¶å°†`sdk_struct.MessageEntity`ç±»å‹çš„åˆ‡ç‰‡`messageEntities`èµ‹å€¼ç»™`s.MessageEntityElem.MessageEntityList`å­—æ®µã€‚æœ€åï¼Œå°†`s.MessageEntityElem`ç»“æ„ä½“åºåˆ—åŒ–æˆ`JSON`æ ¼å¼çš„å­—ç¬¦ä¸²å¹¶èµ‹å€¼ç»™`s.Content`å­—æ®µï¼Œå¹¶è¿”å›`s`æŒ‡é’ˆå’Œ`nil`ã€‚



### ç»“æ„ä½“å­—æ®µ

è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡å¹¶ä¸”å¾ˆå¤§çš„ä¸€ä¸ªæ¶ˆæ¯ç»“æ„ä½“ï¼Œ`MsgStruct` ç»“æ„ä½“æ˜¯æˆ‘ä»¬ç»™å®¢æˆ·ç«¯ç”¨åˆ°çš„ç»“æ„ä½“ã€‚

```go
type MsgStruct struct {
	ClientMsgID          string                `json:"clientMsgID,omitempty"`
	ServerMsgID          string                `json:"serverMsgID,omitempty"`
	CreateTime           int64                 `json:"createTime"`
	SendTime             int64                 `json:"sendTime"`
	SessionType          int32                 `json:"sessionType"`
	SendID               string                `json:"sendID,omitempty"`
	RecvID               string                `json:"recvID,omitempty"`
	MsgFrom              int32                 `json:"msgFrom"`
	ContentType          int32                 `json:"contentType"`
	SenderPlatformID     int32                 `json:"platformID"`
	SenderNickname       string                `json:"senderNickname,omitempty"`
	SenderFaceURL        string                `json:"senderFaceUrl,omitempty"`
	GroupID              string                `json:"groupID,omitempty"`
	Content              string                `json:"content,omitempty"`
	Seq                  int64                 `json:"seq"`
	IsRead               bool                  `json:"isRead"`
	Status               int32                 `json:"status"`
	IsReact              bool                  `json:"isReact,omitempty"`
	IsExternalExtensions bool                  `json:"isExternalExtensions,omitempty"`
	OfflinePush          sdkws.OfflinePushInfo `json:"offlinePush,omitempty"`
	AttachedInfo         string                `json:"attachedInfo,omitempty"`
	Ex                   string                `json:"ex,omitempty"`
	PictureElem          struct {
		SourcePath      string          `json:"sourcePath,omitempty"`
		SourcePicture   PictureBaseInfo `json:"sourcePicture,omitempty"`
		BigPicture      PictureBaseInfo `json:"bigPicture,omitempty"`
		SnapshotPicture PictureBaseInfo `json:"snapshotPicture,omitempty"`
	} `json:"pictureElem,omitempty"`
	SoundElem struct {
		UUID      string `json:"uuid,omitempty"`
		SoundPath string `json:"soundPath,omitempty"`
		SourceURL string `json:"sourceUrl,omitempty"`
		DataSize  int64  `json:"dataSize"`
		Duration  int64  `json:"duration"`
		SoundType string `json:"soundType,omitempty"`
	} `json:"soundElem,omitempty"`
	VideoElem struct {
		VideoPath      string `json:"videoPath,omitempty"`
		VideoUUID      string `json:"videoUUID,omitempty"`
		VideoURL       string `json:"videoUrl,omitempty"`
		VideoType      string `json:"videoType,omitempty"`
		VideoSize      int64  `json:"videoSize"`
		Duration       int64  `json:"duration"`
		SnapshotPath   string `json:"snapshotPath,omitempty"`
		SnapshotUUID   string `json:"snapshotUUID,omitempty"`
		SnapshotSize   int64  `json:"snapshotSize"`
		SnapshotURL    string `json:"snapshotUrl,omitempty"`
		SnapshotWidth  int32  `json:"snapshotWidth"`
		SnapshotHeight int32  `json:"snapshotHeight"`
		SnapshotType   string `json:"snapshotType,omitempty"`
	} `json:"videoElem,omitempty"`
	FileElem struct {
		FilePath  string `json:"filePath,omitempty"`
		UUID      string `json:"uuid,omitempty"`
		SourceURL string `json:"sourceUrl,omitempty"`
		FileName  string `json:"fileName,omitempty"`
		FileSize  int64  `json:"fileSize"`
		FileType  string `json:"fileType,omitempty"`
	} `json:"fileElem,omitempty"`
	MergeElem struct {
		Title             string           `json:"title,omitempty"`
		AbstractList      []string         `json:"abstractList,omitempty"`
		MultiMessage      []*MsgStruct     `json:"multiMessage,omitempty"`
		MessageEntityList []*MessageEntity `json:"messageEntityList,omitempty"`
	} `json:"mergeElem,omitempty"`
	AtElem struct {
		Text         string     `json:"text,omitempty"`
		AtUserList   []string   `json:"atUserList,omitempty"`
		AtUsersInfo  []*AtInfo  `json:"atUsersInfo,omitempty"`
		QuoteMessage *MsgStruct `json:"quoteMessage,omitempty"`
		IsAtSelf     bool       `json:"isAtSelf"`
	} `json:"atElem,omitempty"`
	FaceElem struct {
		Index int    `json:"index"`
		Data  string `json:"data,omitempty"`
	} `json:"faceElem,omitempty"`
	LocationElem struct {
		Description string  `json:"description,omitempty"`
		Longitude   float64 `json:"longitude"`
		Latitude    float64 `json:"latitude"`
	} `json:"locationElem,omitempty"`
	CustomElem struct {
		Data        string `json:"data,omitempty"`
		Description string `json:"description,omitempty"`
		Extension   string `json:"extension,omitempty"`
	} `json:"customElem,omitempty"`
	QuoteElem struct {
		Text              string           `json:"text,omitempty"`
		QuoteMessage      *MsgStruct       `json:"quoteMessage,omitempty"`
		MessageEntityList []*MessageEntity `json:"messageEntityList,omitempty"`
	} `json:"quoteElem,omitempty"`
	NotificationElem struct {
		Detail      string `json:"detail,omitempty"`
		DefaultTips string `json:"defaultTips,omitempty"`
	} `json:"notificationElem,omitempty"`
	MessageEntityElem struct {
		Text              string           `json:"text,omitempty"`
		MessageEntityList []*MessageEntity `json:"messageEntityList,omitempty"`
	} `json:"messageEntityElem,omitempty"`
	AttachedInfoElem AttachedInfoElem `json:"attachedInfoElem,omitempty"`
}
```

è¿™æ˜¯ä¸€ä¸ªåä¸º `MsgStruct` çš„ç»“æ„ä½“ï¼ŒåŒ…å«äº†ä¸€ä¸ªå³æ—¶é€šè®¯æ¶ˆæ¯çš„å„ç§å…ƒç´ ã€‚ä¸‹é¢æ˜¯æ¯ä¸ªå­—æ®µçš„è§£é‡Šï¼š

+ `ClientMsgID`ï¼šå®¢æˆ·ç«¯ç”Ÿæˆçš„æ¶ˆæ¯ IDã€‚
+ `ServerMsgID`ï¼šæœåŠ¡å™¨ç”Ÿæˆçš„æ¶ˆæ¯ IDã€‚
+ `CreateTime`ï¼šæ¶ˆæ¯åˆ›å»ºæ—¶é—´ï¼ŒUnix æ—¶é—´æˆ³ã€‚
+ `SendTime`ï¼šæ¶ˆæ¯å‘é€æ—¶é—´ï¼ŒUnix æ—¶é—´æˆ³ã€‚
+ `SessionType`ï¼šä¼šè¯ç±»å‹ï¼Œå¦‚å•èŠã€ç¾¤èŠç­‰ã€‚
+ `SendID`ï¼šæ¶ˆæ¯å‘é€è€…çš„ IDã€‚
+ `RecvID`ï¼šæ¶ˆæ¯æ¥æ”¶è€…çš„ IDã€‚
+ `MsgFrom`ï¼šæ¶ˆæ¯æ¥æºï¼Œå¦‚å‘é€æ–¹æˆ–æ¥æ”¶æ–¹ã€‚
+ `ContentType`ï¼šæ¶ˆæ¯å†…å®¹ç±»å‹ï¼Œå¦‚æ–‡æœ¬ã€å›¾ç‰‡ã€éŸ³é¢‘ç­‰ã€‚
+ `SenderPlatformID`ï¼šå‘é€è€…ä½¿ç”¨çš„å¹³å° IDã€‚
+ `SenderNickname`ï¼šå‘é€è€…çš„æ˜µç§°ã€‚
+ `SenderFaceURL`ï¼šå‘é€è€…çš„å¤´åƒ URLã€‚
+ `GroupID`ï¼šå¦‚æœæ˜¯ç¾¤èŠæ¶ˆæ¯ï¼Œç¾¤èŠ IDã€‚
+ `Content`ï¼šæ¶ˆæ¯å†…å®¹ã€‚
+ `Seq`ï¼šæ¶ˆæ¯åºåˆ—å·ã€‚
+ `IsRead`ï¼šæ¶ˆæ¯æ˜¯å¦å·²è¯»ã€‚
+ `Status`ï¼šæ¶ˆæ¯çŠ¶æ€ï¼Œå¦‚å‘é€ä¸­ã€å‘é€æˆåŠŸã€å‘é€å¤±è´¥ç­‰ã€‚
+ `IsReact`ï¼šæ˜¯å¦éœ€è¦åé¦ˆã€‚
+ `IsExternalExtensions`ï¼šæ˜¯å¦åŒ…å«æ‰©å±•ä¿¡æ¯ã€‚
+ `OfflinePush`ï¼šç¦»çº¿æ¨é€ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€å†…å®¹ã€å£°éŸ³ç­‰ã€‚
+ `AttachedInfo`ï¼šé™„åŠ ä¿¡æ¯ã€‚
+ `Ex`ï¼šé¢„ç•™å­—æ®µã€‚
+ `PictureElem`ï¼šå›¾ç‰‡æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬åŸå›¾ã€å¤§å›¾ã€å¿«ç…§ç­‰ã€‚
+ `SoundElem`ï¼šéŸ³é¢‘æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬ UUIDã€è·¯å¾„ã€å¤§å°ã€æ—¶é•¿ç­‰ã€‚
+ `VideoElem`ï¼šè§†é¢‘æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬è·¯å¾„ã€UUIDã€å¤§å°ã€æ—¶é•¿ã€å¿«ç…§ç­‰ã€‚
+ `FileElem`ï¼šæ–‡ä»¶æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬è·¯å¾„ã€UUIDã€å¤§å°ã€åç§°ã€ç±»å‹ç­‰ã€‚
+ `MergeElem`ï¼šåˆå¹¶æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€æ‘˜è¦ã€å¤šæ¡æ¶ˆæ¯ã€æ¶ˆæ¯å®ä½“ç­‰ã€‚
+ `AtElem`ï¼š@ æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€@ ç”¨æˆ·åˆ—è¡¨ã€@ ç”¨æˆ·ä¿¡æ¯ã€å¼•ç”¨æ¶ˆæ¯ã€æ˜¯å¦ @ è‡ªå·±ç­‰ã€‚
+ `FaceElem`ï¼šè¡¨æƒ…æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬è¡¨æƒ…ç´¢å¼•ã€æ•°æ®ç­‰ã€‚
+ `LocationElem`ï¼šä½ç½®æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬æè¿°ã€ç»åº¦ã€çº¬åº¦ç­‰ã€‚
+ `CustomElem`ï¼šè‡ªå®šä¹‰æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬æ•°æ®ã€æè¿°ã€æ‰©å±•ç­‰ã€‚
+ `QuoteElem`ï¼šå¼•ç”¨æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å¼•ç”¨çš„æ¶ˆæ¯ã€æ¶ˆæ¯å®ä½“ç­‰ã€‚
+ `NotificationElem`ï¼šé€šçŸ¥æ¶ˆæ¯å…ƒç´ ï¼ŒåŒ…æ‹¬è¯¦æƒ…ã€é»˜è®¤æç¤ºç­‰ã€‚
+ `MessageEntityElem`ï¼šæ¶ˆæ¯å®ä½“å…ƒç´ ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€æ¶ˆæ¯å®ä½“åˆ—è¡¨ç­‰ã€‚
+ `AttachedInfoElem`ï¼šé™„åŠ ä¿¡æ¯å…ƒç´ ï¼ŒåŒ…æ‹¬ç±»å‹ã€æ•°æ®ç­‰ã€‚





### å‘é€æ¶ˆæ¯éœ€è¦çš„ç»“æ„ä½“å­—æ®µ

```go
type TextElem struct {
	Text string `json:"text,omitempty"`
}


type MsgStruct struct {
	ClientMsgID          string                `json:"clientMsgID,omitempty"`
	CreateTime           int64                 `json:"createTime"`
	SendTime             int64                 `json:"sendTime"`
	MsgFrom              int32                 `json:"msgFrom"`
	ContentType          int32                 `json:"contentType"`
	SenderPlatformID     int32                 `json:"platformID"`
	SenderNickname       string                `json:"senderNickname,omitempty"`
	SenderFaceURL        string                `json:"senderFaceUrl,omitempty"`
	Status               int32                 `json:"status"`
	IsReact              bool                  `json:"isReact,omitempty"`
	IsExternalExtensions bool                  `json:"isExternalExtensions,omitempty"`
	OfflinePush          sdkws.OfflinePushInfo `json:"offlinePush,omitempty"`
	AttachedInfo         string                `json:"attachedInfo,omitempty"`
	Ex                   string                `json:"ex,omitempty"`
	TextElem             TextElem              `json:"textElem,omitempty"`
}
```



åˆ›å»ºç»“æ„ä½“çš„é€»è¾‘éƒ¨åˆ†ï¼š

```go
func (c *Conversation) initBasicInfo(ctx context.Context, message *sdk_struct.MsgStruct, msgFrom, contentType int32) error {
	message.CreateTime = utils.GetCurrentTimestampByMill()
	message.SendTime = message.CreateTime
	message.IsRead = false
	message.Status = constant.MsgStatusSending
	message.SendID = c.loginUserID
	userInfo, err := c.db.GetLoginUser(ctx, c.loginUserID)
	if err != nil {
		return err
	} else {
		message.SenderFaceURL = userInfo.FaceURL
		message.SenderNickname = userInfo.Nickname
	}
	ClientMsgID := utils.GetMsgID(message.SendID)
	message.ClientMsgID = ClientMsgID
	message.MsgFrom = msgFrom
	message.ContentType = contentType
	message.SenderPlatformID = c.platformID
	message.IsExternalExtensions = c.IsExternalExtensions
	return nil
}
```







## END é“¾æ¥

<ul><li><div><a href = '44.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '46.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
