+ [author](http://nsddd.top)

# ç¬¬67èŠ‚ æ·±å…¥å­¦ä¹  beego æºç 

<div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8sï¼Œdockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## ä»‹ç»

Beego ç”¨äºå¿«é€Ÿå¼€å‘ Go ä¸­çš„ä¼ä¸šåº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ RESTful APIã€Web åº”ç”¨ç¨‹åºå’Œåç«¯æœåŠ¡ã€‚

**GitHubåœ°å€ï¼š**

+ [https://github.com/beego/beego/](https://github.com/beego/beego/)

---

![architecture](http://sm.nsddd.top/sm202305191917988.png)



**Beegoç”±å››ä¸ªéƒ¨åˆ†ç»„æˆï¼š**

1. åŸºç¡€æ¨¡å—ï¼šåŒ…æ‹¬æ—¥å¿—æ¨¡å—ã€é…ç½®æ¨¡å—ã€è°ƒé€Ÿå™¨æ¨¡å—;
2. ä»»åŠ¡ï¼šç”¨äºè¿è¡Œå®šæ—¶ä»»åŠ¡æˆ–å‘¨æœŸæ€§ä»»åŠ¡;
3. å®¢æˆ·ç«¯ï¼šåŒ…æ‹¬ORMæ¨¡å—ã€httplibæ¨¡å—ã€ç¼“å­˜æ¨¡å—;
4. æœåŠ¡å™¨ï¼šåŒ…æ‹¬ç½‘ç»œæ¨¡å—ã€‚æˆ‘ä»¬å°†æ¥æ”¯æŒ gRPC;

Beego å°±ç›¸å½“äºæ˜¯ä¸€ä¸ª **ç§¯æœ¨å¼é›†åˆ**ï¼Œå°†æ¯ä¸€ä¸ªæ¨¡å—éƒ½é›†æˆåœ¨é¡¹ç›®ä¸­ï¼Œæ¯”å¦‚è¯´ cache çš„ç¼“å­˜æ¨¡å—ã€‚



### MVC æ¶æ„

è¿™é‡Œä½¿ç”¨markdown Draw.ioçš„mermaidæ‰©å±•æ¥ç”»MVCæ¶æ„å›¾:

```mermaid
graph LR
    client(Client) --> view(View)
    view --> controller(Controller)
    controller --> model(Model)
    model --> database(Database)

    classDef blue fill:#bbf,stroke:#f66,stroke-width:2px;
    classDef orange fill:#f96,stroke:#f66,stroke-width:2px;
    classDef green fill:#9f9,stroke:#0f0,stroke-width:2px;

    class Client blue
    class View blue
    class Controller orange
    class Model orange
    class Database green
```

è¿™ä¸ªå›¾å±•ç¤ºäº†ä¸€ä¸ªåŸºæœ¬çš„MVCæ¶æ„:- å®¢æˆ·ç«¯(Client)è°ƒç”¨Viewå±‚

- å®¢æˆ·ç«¯(Client)è°ƒç”¨Viewå±‚
- Viewå±‚æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå§”æ‰˜ç»™Controllerå±‚
- Controllerå±‚è°ƒç”¨Modelå±‚è·å–æ•°æ®æˆ–ä¸šåŠ¡é€»è¾‘
- Modelå±‚å°†è¯·æ±‚è½¬å‘ç»™æ•°æ®åº“
- æ•°æ®åº“æŸ¥è¯¢å“åº”ï¼ŒModelå±‚å°†ç»“æœè¿”å›ç»™Controller
- Controllerå±‚å°†Modelå±‚ç»“æœè¿”å›ç»™Viewå±‚
- Viewå±‚å°†ç»“æœå‘ˆç°ç»™å®¢æˆ·ç«¯

beego ä½¿ç”¨çš„æ¶æ„æ˜¯ MVC æ¶æ„ï¼š

![Http Request](http://sm.nsddd.top/sm202305191932281.png)



 æµç¨‹å›¾è¯´æ˜ï¼š

1. httpè¯·æ±‚ä»å·¦ä¾§mainå…¥å£å‡½æ•°å¼€å§‹è¿›å…¥æ¡†æ¶
2. UrLè·¯ç”±è§£æç„¶åç¡®å®šæ‰§è¡Œé‚£ä¸ªæ§åˆ¶å™¨(controller)
3. æ‰§è¡Œè¯·æ±‚å‰çš„è¿‡æ»¤å™¨ ï¼ˆè¿‡æ»¤å™¨ä¸€èˆ¬ç”¨æ¥æ‹¦æˆªè¯·æ±‚ï¼Œä¾‹å¦‚åšapiç­¾åæ ¡éªŒï¼Œsessionå¤„ç†ï¼Œå®‰å…¨éªŒè¯ç­‰ç­‰ï¼‰
4. æ‰§è¡Œæ§åˆ¶å™¨ ï¼ˆæ§åˆ¶å™¨æ ¹æ®éœ€è¦è°ƒç”¨modelï¼Œsession, æ—¥å¿—ç­‰æ¨¡å—ï¼‰
5. æ‰§è¡Œè¯·æ±‚åçš„è¿‡æ»¤å™¨
6. è§†å›¾è¾“å‡ºè¿”å›ç»™ç”¨æˆ·



## ç›®å½•ç»“æ„

beego æ˜¯ä¸€ä¸ª Go è¯­è¨€å¼€å‘çš„ Web æ¡†æ¶ï¼Œå®ƒçš„ç›®å½•ç»“æ„å¦‚ä¸‹:

- `app`: ç”¨äºæ”¾ç½®åº”ç”¨ç¨‹åºçš„æ§åˆ¶å™¨ã€æ¨¡å‹ã€è§†å›¾ç­‰ã€‚

- `conf`: ç”¨äºæ”¾ç½®é…ç½®æ–‡ä»¶ï¼Œå¦‚ app.confã€‚

- `controllers`: ç”¨äºæ”¾ç½®æ§åˆ¶å™¨ä»£ç ï¼Œæ§åˆ¶å™¨è´Ÿè´£è§£æç”¨æˆ·çš„è¾“å…¥ï¼Œå¤„ç†åè¿”å›ç›¸åº”çš„ç»“æœã€‚

- `models`: ç”¨äºæ”¾ç½®æ¨¡å‹ä»£ç ï¼Œæ¨¡å‹æ˜¯ä¸æ•°æ®åº“äº¤äº’çš„éƒ¨åˆ†ã€‚

- `routers`: ç”¨äºè®¾ç½® URL è·¯ç”±æ˜ å°„ï¼Œæ¯”å¦‚å°† /user æ˜ å°„åˆ° controllers/user.goã€‚

- `static`: ç”¨äºæ”¾ç½®é™æ€èµ„æºï¼Œå¦‚ JSã€CSSã€å›¾ç‰‡ç­‰ã€‚

- `tests`: ç”¨äºæ”¾ç½®æµ‹è¯•ä»£ç ã€‚

- `views`: ç”¨äºæ”¾ç½®æ¨¡æ¿æ–‡ä»¶ï¼Œbeego æ”¯æŒå¤šç§æ¨¡æ¿ï¼Œå¦‚ goTemplateã€fastTemplate ç­‰ã€‚

- `main.go`: ç¨‹åºå…¥å£æ–‡ä»¶ï¼Œç”¨äºåˆå§‹åŒ– Beegoã€‚

- `conf/`: ç”¨äºå­˜æ”¾é…ç½®æ–‡ä»¶

- `logs/`: ç”¨äºå­˜æ”¾æ—¥å¿—æ–‡ä»¶

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰:

- `cache`: ç”¨äºè®¾ç½®ç¼“å­˜ï¼Œå¦‚ redisã€memcached ç­‰ã€‚
- `toolbox`: ç”¨äºæ”¾ç½®å·¥å…·å‡½æ•°ã€‚
- `docs`: ç”¨äºæ”¾ç½®æ–‡æ¡£ã€‚
- `plugins`: beego çš„æ’ä»¶æœºåˆ¶å…è®¸å¼€å‘è€…æ‰©å±•æ›´å¤šåŠŸèƒ½ã€‚



### Beego å®‰è£…

```bash
go get github.com/beego/beego/v2@latest
```

**å‘½ä»¤ï¼š**

+ newï¼šåŸºäºç½‘ç«™å¼€å‘
+ apiï¼šæ‰‹æœºæ¥å£å¼€å‘
+ runï¼šè¿è¡Œ



## Beego ä½¿ç”¨

### new

`new`: ç”¨äºåˆ›å»ºä¸€ä¸ª beego é¡¹ç›®çš„è„šæ‰‹æ¶

```bash
beego new PROJECT_NAME
```

è¿™ä¸ªå‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ PROJECT_NAME,å¹¶åœ¨é‡Œé¢åˆå§‹åŒ– beego é¡¹ç›®çš„åŸºæœ¬ç›®å½•ç»“æ„å’Œæ–‡ä»¶ã€‚



### api

 `api`:ç”¨äºå¿«é€Ÿåˆ›å»º RESTful API æœåŠ¡ã€‚æ ¼å¼ä¸º:

```bash
beego api [name] 
```

è¿™ä¸ªå‘½ä»¤ä¼šè‡ªåŠ¨åœ¨ controllers ç›®å½•ä¸‹åˆ›å»ºåä¸º name çš„ API æ§åˆ¶å™¨,å¹¶åœ¨ `conf/app.conf` é‡Œæ³¨å†Œè¯¥ APIã€‚



### run

`run`: ç”¨äºè¿è¡Œå’Œç¼–è¯‘ beego é¡¹ç›®ã€‚

```bash
beego run   # è¿è¡Œé¡¹ç›®
beego build # ç¼–è¯‘é¡¹ç›®
```

run å‘½ä»¤ä¼šç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨ç¼–è¯‘å’Œé‡è½½,æ–¹ä¾¿å¼€å‘è°ƒè¯•ã€‚build å‘½ä»¤ä¼šç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶,ç”¨äºéƒ¨ç½²ä¸Šçº¿ã€‚

æ‰€ä»¥,å¦‚æœä½ è¦å¼€å‘ä¸€ä¸ª beego Webåº”ç”¨,é€šå¸¸çš„æµç¨‹æ˜¯:

1. ä½¿ç”¨ beego new myproject åˆå§‹åŒ–é¡¹ç›®

2. ç¼–å†™ä»£ç (æ§åˆ¶å™¨ã€æ¨¡å‹ã€è·¯ç”±ç­‰)

3. ä½¿ç”¨ beego run è¿è¡Œé¡¹ç›®è¿›è¡Œå¼€å‘è°ƒè¯•

4. ä½¿ç”¨ beego build ç¼–è¯‘å‘å¸ƒå¯æ‰§è¡Œæ–‡ä»¶

5. éƒ¨ç½²å¯æ‰§è¡Œæ–‡ä»¶åˆ°ç”Ÿäº§ç¯å¢ƒ



## ä½¿ç”¨

### æ§åˆ¶å™¨çš„é€»è¾‘

```go
package controllers

import (
	beego "github.com/beego/beego/v2/server/web"
)

// å®šä¹‰ä¸€ä¸ªæ§åˆ¶å™¨ç»“æ„ä½“
// æˆ‘ä»¬ä¸€èˆ¬ä¸€ä¸ªæ¨¡å—å®šä¹‰ä¸€ä¸ªæ§åˆ¶å™¨
type MainController struct {
    // åµŒå¥—beegoåŸºç¡€æ§åˆ¶å™¨ï¼Œåœ¨goè¯­è¨€ä¸­åµŒå¥—structï¼Œå°±ç±»ä¼¼ç»§æ‰¿çš„æ¦‚å¿µã€‚
    // è¿™é‡Œå°±ç›¸å½“äºï¼Œç»§æ‰¿äº†beego.Controllerçš„æ–¹æ³•å’Œå±æ€§ã€‚
	beego.Controller 
}

// è¦†ç›–beego.Controllerçš„Getæ–¹æ³•ï¼Œç”¨äºå¤„ç†RESTfulè¯·æ±‚ä¸­çš„getè¯·æ±‚
// beego.Controlleré»˜è®¤æ”¯æŒå¤šç§RESTfulæ–¹æ³•ï¼Œä¾‹å¦‚ï¼šPostã€Putã€Deleteç­‰ç­‰
func (c *MainController) Get() {
    // Dataæ˜¯ç»§æ‰¿è¿‡æ¥çš„å±æ€§ï¼Œæ˜¯mapç±»å‹ï¼Œå¯ä»¥ä¿å­˜ä»»æ„ç±»å‹æ•°æ®ï¼Œä¸»è¦ç”¨äºä¿å­˜è¯·æ±‚å“åº”æ•°æ®
    // æˆ‘ä»¬å¯ä»¥é€šè¿‡Dataå°†å‚æ•°ï¼Œä¼ å…¥è§†å›¾æ¨¡æ¿æ–‡ä»¶ã€‚
	// è¿™é‡Œè®¾ç½®äº†ä¸¤ä¸ªå‚æ•°
	c.Data["Website"] = "nsddd.com"
	c.Data["Email"] = "nsddd@demo.com"
	
	// è®¾ç½®éœ€è¦æ¸²æŸ“çš„æ¨¡æ¿æ–‡ä»¶ï¼Œæ¡†æ¶ä¼šå»viewsç›®å½•æŸ¥æ‰¾è¿™ä¸ªæ¨¡æ¿æ–‡ä»¶
	c.TplName = "index.tpl"
}
```



### è®¾ç½®Urlè·¯ç”±

```go
package routers

import (
	"nsddd/controllers"
	beego "github.com/beego/beego/v2/server/web"
)

// go åŒ…åˆå§‹åŒ–å‡½æ•°ï¼Œgoè¯­è¨€ä¸­åœ¨å¯¼å…¥ä¸€ä¸ªåŒ…çš„æ—¶å€™ï¼Œå¦‚æœè¢«å¯¼å…¥åŒ…å­˜åœ¨initå‡½æ•°ï¼Œä¼šæ‰§è¡Œinitå‡½æ•°
// å› æ­¤è¿™é‡Œå¯ä»¥ä½¿ç”¨initå‡½æ•°åˆå§‹åŒ–è·¯ç”±è®¾ç½®
func init() {
    // ä½¿ç”¨beego.Routerå‡½æ•°ï¼Œæ³¨å†Œè·¯ç”±è§„åˆ™ã€‚
    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯urlè·¯ç”±ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ§åˆ¶å™¨
    // è¿™é‡Œçš„æ„æ€å°±æ˜¯å°†è®¿é—® / è¿™ä¸ªurlçš„è¯·æ±‚ï¼Œäº¤ç»™controllers.MainControlleræ§åˆ¶å™¨å¤„ç†ã€‚
    beego.Router("/", &controllers.MainController{})
}
```

å¦‚æœæˆ‘ä»¬å¢åŠ ä¸‹é¢è·¯ç”±è®¾ç½®:

```go
beego.Router("/nsddd", &controllers.MainController{})
```

è®¿é—®:http://localhost:8080/nsddd å’Œ http://localhost:8080/ å¾—åˆ°çš„ç»“æœä¸€æ ·ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªurlåœ°å€éƒ½æ˜¯ç”±åŒä¸€ä¸ªæ§åˆ¶å™¨å¤„ç†ã€‚

`beego RESTful`è·¯ç”±è§„åˆ™ï¼Œé»˜è®¤æ˜¯é€šè¿‡ **è¯·æ±‚æ–¹æ³•** ç¡®è®¤ç”±é‚£ä¸ªæ§åˆ¶å™¨æ–¹æ³•æ‰§è¡Œï¼Œä¾‹å¦‚getè¯·æ±‚ï¼Œç”±Getæ–¹æ³•æ‰§è¡Œï¼ŒPOSTè¯·æ±‚ç”±Postæ–¹æ³•æ‰§è¡Œã€‚



### ç¼–å†™modelé€»è¾‘

è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸ªmysqlæ•°æ®åº“æ“ä½œçš„ä¾‹å­ã€‚

*å®šä¹‰è¡¨çš„ç»“æ„ï¼š*

```mysql
CREATE TABLE `users` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'è‡ªå¢ID',
  `username` varchar(30) NOT NULL COMMENT 'è´¦å·',
  `password` varchar(100) NOT NULL COMMENT 'å¯†ç ',
   PRIMARY KEY (`id`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8
```



### åˆå§‹åŒ–æ•°æ®åº“è¿æ¥

ä¸€èˆ¬åˆå§‹åŒ–æ•°æ®åº“è¿æ¥éƒ½æ˜¯åœ¨main.goå…¥å£çš„åœ°æ–¹è®¾ç½®ä¸€æ¬¡å°±è¡Œï¼Œä¸‹é¢çœ‹ä¸‹main.goæ–‡ä»¶æ”¹æˆä»€ä¹ˆæ ·äº†ã€‚

```go
package main

import (
	beego "github.com/beego/beego/v2/server/web"
	"github.com/beego/beego/v2/client/orm"
	_ "nsddd/routers"
	//å¯¼å…¥mysqlé©±åŠ¨ï¼Œè¿™æ˜¯å¿…é¡»çš„
	_ "github.com/go-sql-driver/mysql"
)

//åˆå§‹åŒ–åº”ç”¨è®¾ç½®ï¼Œ æˆ‘ä»¬é€šè¿‡initå‡½æ•°åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œgoè¯­è¨€ä¸­è¿™ä¸ªå‡½æ•°ä¼šä¼˜å…ˆæ‰§è¡Œ
func init() {
    // è¿™é‡Œæ³¨å†Œä¸€ä¸ªdefaulté»˜è®¤æ•°æ®åº“ï¼Œæ•°æ®åº“é©±åŠ¨æ˜¯mysql.
    // ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ•°æ®åº“dsn, é…ç½®æ•°æ®åº“çš„è´¦å·å¯†ç ï¼Œæ•°æ®åº“åç­‰å‚æ•°
    //  dsnå‚æ•°è¯´æ˜ï¼š
    //      username    - mysqlè´¦å·
    //      password    - mysqlå¯†ç 
    //      db_name     - æ•°æ®åº“å
    //      127.0.0.1:3306 - æ•°æ®åº“çš„åœ°å€å’Œç«¯å£
	orm.RegisterDataBase("default", "mysql", "username:password@tcp(127.0.0.1:3306)/db_name?charset=utf8")
}

func main() {
	beego.Run()
}
```



### åˆå§‹åŒ–æ•°æ®åº“è¿æ¥

> ä¸€èˆ¬åˆå§‹åŒ–æ•°æ®åº“è¿æ¥éƒ½æ˜¯åœ¨main.goå…¥å£çš„åœ°æ–¹è®¾ç½®ä¸€æ¬¡å°±è¡Œï¼Œä¸‹é¢çœ‹ä¸‹main.goæ–‡ä»¶æ”¹æˆä»€ä¹ˆæ ·äº†ã€‚

```go
package main

import (
	beego "github.com/beego/beego/v2/server/web"
	"github.com/beego/beego/v2/client/orm"
	_ "nsddd/routers"
	//å¯¼å…¥mysqlé©±åŠ¨ï¼Œè¿™æ˜¯å¿…é¡»çš„
	_ "github.com/go-sql-driver/mysql"
)

//åˆå§‹åŒ–åº”ç”¨è®¾ç½®ï¼Œ æˆ‘ä»¬é€šè¿‡initå‡½æ•°åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ï¼Œgoè¯­è¨€ä¸­è¿™ä¸ªå‡½æ•°ä¼šä¼˜å…ˆæ‰§è¡Œ
func init() {
    // è¿™é‡Œæ³¨å†Œä¸€ä¸ªdefaulté»˜è®¤æ•°æ®åº“ï¼Œæ•°æ®åº“é©±åŠ¨æ˜¯mysql.
    // ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ•°æ®åº“dsn, é…ç½®æ•°æ®åº“çš„è´¦å·å¯†ç ï¼Œæ•°æ®åº“åç­‰å‚æ•°
    //  dsnå‚æ•°è¯´æ˜ï¼š
    //      username    - mysqlè´¦å·
    //      password    - mysqlå¯†ç 
    //      db_name     - æ•°æ®åº“å
    //      127.0.0.1:3306 - æ•°æ®åº“çš„åœ°å€å’Œç«¯å£
	orm.RegisterDataBase("default", "mysql", "username:password@tcp(127.0.0.1:3306)/db_name?charset=utf8")
}

func main() {
	beego.Run()
}
```

ä¸ºäº†åˆå§‹åŒ–mysqlè¿æ¥ï¼Œåœ¨å…¥å£main.goæ–‡ä»¶ï¼Œå¢åŠ initå‡½æ•°åˆå§‹åŒ–æ•°æ®åº“è®¾ç½®ã€‚



### åˆ›å»ºmodel

ç„¶ååˆ›å»ºä¸€ä¸ªuser model, æ–‡ä»¶è·¯å¾„ï¼šnsddd/models/user.go , ä»£ç å¦‚ä¸‹

```go
package models

import (
	"github.com/beego/beego/v2/client/orm"
)

// å®šä¹‰Useræ¨¡å‹ï¼Œç»‘å®šusersè¡¨ç»“æ„, å…¶å®å°±æ˜¯ç”¨æ¥ä¿å­˜sqlæŸ¥è¯¢ç»“æœã€‚
type User struct {
	Id int
	Username string
	Password string
}

// å®šä¹‰User æ¨¡å‹ç»‘å®šé‚£ä¸ªè¡¨ï¼Ÿ
func (u *User) TableName() string {
    // è¿”å›mysqlè¡¨å
	return "users"
}

//åˆå§‹åŒ–å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥å‘ormæ³¨å†Œmodel
func init() {
    // å‘ormæ³¨å†Œuseræ¨¡å‹
	orm.RegisterModel(&User{})
}

// æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
func GetUserById(id int) *User {
	if  id == 0 {
		return  nil
	}
    
    // åˆ›å»ºormå¯¹è±¡, åé¢éƒ½æ˜¯é€šè¿‡ormå¯¹è±¡æ“ä½œæ•°æ®åº“
	o := orm.NewOrm()
	
	// åˆå§‹åŒ–ä¸€ä¸ªUseræ¨¡å‹å¯¹è±¡
	user := User{}
	// è®¾ç½®æŸ¥è¯¢å‚æ•°
	user.Id = id
	
	// è°ƒç”¨Readæ–¹æ³•ï¼Œæ ¹æ®userè®¾ç½®çš„å‚æ•°ï¼ŒæŸ¥è¯¢ä¸€æ¡è®°å½•ï¼Œç»“æœä¿å­˜åˆ°userç»“æ„ä½“å˜é‡ä¸­
	// é»˜è®¤æ˜¯æ ¹æ®ä¸»é”®è¿›è¡ŒæŸ¥è¯¢
	// ç­‰ä»·sqlï¼š SELECT `id`, `username`, `password` FROM `users` WHERE `id` = 1
	err := o.Read(&user)
	
	// æ£€æµ‹æŸ¥è¯¢ç»“æœï¼Œ
	if err == orm.ErrNoRows {
		// æ‰¾ä¸åˆ°è®°å½•
		return nil
	} else if err == orm.ErrMissPK {
		// æ‰¾ä¸åˆ°ä½å»º
		return nil
	}
	
	return &user
}
```



### é€šè¿‡æ§åˆ¶å™¨è°ƒç”¨model

ä¿®æ”¹ æ§åˆ¶å™¨çš„ä»£ç ï¼Œäº‹å®ä¸Š æ§åˆ¶å™¨ä¹Ÿæ˜¯æœ€åå»æ“ä½œçš„ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ­¥åº”è¯¥å¤„ç†æ•°æ®åº“çš„ä¸€äº›æ“ä½œã€‚

```go
func (c *MainController) Get() {
	c.Data["Website"] = "nsddd.com"
	c.Data["Email"] = "nsddd@demo.com"
	
	// è°ƒç”¨modelï¼ŒæŸ¥è¯¢ç”¨æˆ·idä¸º1 çš„ç”¨æˆ·ä¿¡æ¯
    user := models.GetUserById(1)
	
	// ç„¶åå°†useræ•°æ®ä¿å­˜åˆ°Dataä¸­, å°†å‚æ•°ä¼ ç»™åé¢çš„viewsè§†å›¾æ¨¡æ¿å¤„ç†
	c.Data["user"] = user
	
	// ä½¿ç”¨æ–°çš„è§†å›¾æ¨¡æ¿user.tpl
	c.TplName = "user.tpl"
}
```



### ç¼–å†™viewè§†å›¾é€»è¾‘

è¿™é‡Œç¼–å†™ä¸€ä¸ªæ–°çš„è§†å›¾æ¨¡æ¿, ä»£ç å¦‚ä¸‹:

```go
<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<title>Demo</title>
	<meta charset="utf-8">
</head>
<body>
<h1>ç½‘ç«™: {{.Website}}</h1>
{{ if .user }}
ç”¨æˆ·å: {{.user.Username}}
{{else}}
æŸ¥æ‰¾ä¸åˆ°ç”¨æˆ·
{{ end }}
</body>
</html>
```

è®¿é—®url: [http://localhost:8080](http://localhost:8080/), å¦‚æœæŸ¥è¯¢çš„ç”¨æˆ·å­˜åœ¨ï¼Œåˆ™æ˜¾ç¤ºç”¨æˆ·åï¼Œå¦åˆ™æ˜¾ç¤ºæŸ¥æ‰¾ä¸åˆ°ç”¨æˆ·ã€‚



### é¡¹ç›®æ‰“åŒ…

é¡¹ç›®å®Œæˆåéœ€è¦å°†ä»£ç æ‰“åŒ…å‘å¸ƒåˆ°çº¿ä¸Šï¼Œè¿™é‡Œä¾ç„¶æ¨èä½¿ç”¨beeå·¥å…·æ‰“åŒ…ï¼Œbeeå·¥å…·å¯ä»¥ä¸€é”®å°†é¡¹ç›®éœ€è¦çš„ç›¸å…³æ–‡ä»¶ä¸€èµ·æ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©åŒ…ï¼Œåªéœ€è¦åˆ°çº¿ä¸Šè§£å‹å³å¯ã€‚

ä¸‹é¢æ˜¯beeæ‰“åŒ…çš„ä¾‹å­ï¼Œ é¦–å…ˆå°†å‘½ä»¤çª—å£çš„ç›®å½•åˆ‡æ¢åˆ° "é¡¹ç›®æ ¹ç›®å½•", ç„¶åæ‰§è¡Œä¸‹é¢å‘½ä»¤

```go
bee pack
```

æ‰“åŒ…æˆåŠŸåå†é¡¹ç›®æ ¹ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª `nsddd.tar.gz` çš„å‹ç¼©åŒ…ï¼Œå‘½åæ ¼å¼: `${é¡¹ç›®å}.tar.gz`

æˆ‘ä»¬å¯ä»¥è§£å‹ç¼©ï¼Œçœ‹çœ‹å‹ç¼©åŒ…åŒ…å«ä»€ä¹ˆå†…å®¹ï¼š

```
nsddd.tar.gz
â”œâ”€â”€ conf            - é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•,è¿™é‡ŒåŒ…å«æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ static          - é™æ€èµ„æºç›®å½•ï¼ŒåŒ…å«æˆ‘ä»¬é™æ€èµ„æºæ–‡ä»¶
â”œâ”€â”€ views           - è§†å›¾æ¨¡æ¿ç›®å½•ï¼ŒåŒ…å«æ¨¡æ¿æ–‡ä»¶
â””â”€â”€ nsddd         - è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬çš„é¡¹ç›®æ‰“åŒ…åçš„å¯æ‰§è¡Œç¨‹åºï¼ŒæŒ‰æˆ‘ä»¬é¡¹ç›®å‘½å
```



## beego æºç 

å®˜æ–¹æä¾›çš„ç¤ºä¾‹éå¸¸ç®€å•ï¼š

```go
package main

import "github.com/astaxie/beego"

func main() {
    beego.Run()
}
```

é‚£ä¹ˆï¼Œä»`Run()`æ–¹æ³•å¼€å§‹ï¼Œåœ¨[beego.go#179](https://github.com/astaxie/beego/blob/master/beego.go#L179)ï¼š

```go
func Run() {
    initBeforeHTTPRun()

    if EnableAdmin {
        go beeAdminApp.Run()
    }

    BeeApp.Run()
}
```

åœ¨æœ€é‡Œé¢çš„çœ‹çœ‹ `initBeforeHTTPRun()`

```go
// TODO move to module init function
func initBeforeHTTPRun() {
	initHttpOnce.Do(func() {
		// init hooks
		AddAPPStartHook(
			registerMime,
			registerDefaultErrorHandler,
			registerSession,
			registerTemplate,
			registerAdmin,
			registerGzip,
			// registerCommentRouter,
		)

		for _, hk := range hooks {
			if err := hk(); err != nil {
				panic(err)
			}
		}
	})
}
```

ä»ä»£ç çœ‹åˆ°åœ¨`Run()`çš„ç¬¬ä¸€æ­¥ï¼Œåˆå§‹åŒ–`AppConfig`ï¼Œè°ƒç”¨`hooks`ï¼Œåˆå§‹åŒ–`GlobalSessions`ï¼Œç¼–è¯‘æ¨¡æ¿`BuildTemplate()`ï¼Œå’ŒåŠ è½½ä¸­é—´ä»¶`middleware.RegisterErrorHandler()`ï¼Œåˆ†åˆ«ç®€å•å™è¿°ã€‚



### åŠ è½½é…ç½®

åŠ è½½é…ç½®çš„ä»£ç æ˜¯ï¼š

```go
if AppConfigPath != filepath.Join(AppPath, "conf", "app.conf") {
    err := ParseConfig()
    if err != nil && AppConfigPath != filepath.Join(workPath, "conf", "app.conf") {
        // configuration is critical to app, panic here if parse failed
        panic(err)
    }
}
```

åˆ¤æ–­é…ç½®æ–‡ä»¶æ˜¯ä¸æ˜¯`AppPath/conf/app.conf`ï¼Œå¦‚æœä¸æ˜¯å°±`ParseConfig()`ã€‚æ˜¾ç„¶ä»–ä¹‹å‰å°±å·²ç»åŠ è½½è¿‡ä¸€æ¬¡äº†ã€‚æ‰¾äº†ä¸€ä¸‹ï¼Œåœ¨[config.go#L152](https://github.com/astaxie/beego/blob/master/config.go#L152)ï¼Œå…·ä½“åŠ è½½ä»€ä¹ˆå°±ä¸è¯´æ˜äº†ã€‚éœ€è¦è¯´æ˜çš„æ˜¯`AppPath`å’Œ`workPath`è¿™ä¿©å˜é‡ã€‚æ‰¾åˆ°å®šä¹‰[config.go#72](https://github.com/astaxie/beego/blob/master/config.go#L72)ï¼š

```go
workPath, _ = os.Getwd()
workPath, _ = filepath.Abs(workPath)
// initialize default configurations
AppPath, _ = filepath.Abs(filepath.Dir(os.Args[0]))

AppConfigPath = filepath.Join(AppPath, "conf", "app.conf")

if workPath != AppPath {
    if utils.FileExists(AppConfigPath) {
        os.Chdir(AppPath)
    } else {
        AppConfigPath = filepath.Join(workPath, "conf", "app.conf")
    }
}
```

`workPath`æ˜¯`os.Getwd()`ï¼Œå³å½“å‰çš„ç›®å½•ï¼›`AppPath`æ˜¯`os.Args[0]`ï¼Œå³äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚æœ‰äº›æƒ…å†µä¸‹è¿™ä¸¤ä¸ªæ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚æŠŠå‘½ä»¤åŠ åˆ°`PATH`ä¸­ï¼Œç„¶åcdåˆ°åˆ«çš„ç›®å½•æ‰§è¡Œã€‚`beego`ä»¥äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸ºä¼˜å…ˆã€‚å¦‚æœäºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ç›®å½•æ²¡æœ‰å‘ç°`conf/app.conf`ï¼Œå†å»`workPath`é‡Œæ‰¾ã€‚



### Hooks

`hooks`å°±æ˜¯é’©å­ï¼Œåœ¨åŠ è½½é…ç½®åå°±æ‰§è¡Œï¼Œè¿™æ˜¯è¦åšå•¥å‘¢ï¼Ÿåœ¨ [beego.go#L173](https://github.com/astaxie/beego/blob/master/beego.go#L173) æ·»åŠ æ–°çš„hookï¼š

```go
// The hookfunc will run in beego.Run()
// such as sessionInit, middlerware start, buildtemplate, admin start
func AddAPPStartHook(hf hookfunc) {
    hooks = append(hooks, hf)
}
```

`hooks`çš„å®šä¹‰åœ¨[beego.go#L19](https://github.com/astaxie/beego/blob/master/beego.go#L19)ï¼š

```go
type hookfunc func() error //hook function to run
var hooks []hookfunc       //hook function slice to store the hookfunc
```

`hook`å°±æ˜¯`func() error`ç±»å‹çš„å‡½æ•°ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè°ƒç”¨`hooks`å¯ä»¥å®ç°ä»£ç æ³¨é‡Šä¸­çš„å¦‚`middleware start, build template`å‘¢ï¼Ÿå› ä¸º`beego`ä½¿ç”¨çš„æ˜¯å•å®ä¾‹çš„æ¨¡å¼ã€‚



### å•å®ä¾‹

`beego`çš„æ ¸å¿ƒç»“æ„æ˜¯`beego.APP`ï¼Œä¿å­˜è·¯ç”±è°ƒåº¦ç»“æ„`*beego.ControllerRegistor`ã€‚ä»`beego.Run()`æ–¹æ³•çš„ä»£ç `BeeApp.Run()`å‘ç°ï¼Œ`beego`æœ‰ä¸€ä¸ªå…¨å±€å˜é‡`BeeApp`æ˜¯å®é™…è°ƒç”¨çš„`*beego.APP`å®ä¾‹ã€‚ä¹Ÿå°±æ˜¯è¯´æ•´ä¸ª`beego`å°±æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œä¸éœ€è¦ç±»ä¼¼`NewApp()`è¿™æ ·çš„å†™æ³•ã€‚

å› æ­¤ï¼Œå¾ˆå¤šç»“æ„éƒ½ä½œä¸ºå…¨å±€å˜é‡å¦‚`beego.BeeApp`æš´éœ²åœ¨å¤–ã€‚è¯¦ç»†çš„å®šä¹‰åœ¨ [config.go#L18](https://github.com/astaxie/beego/blob/master/config.go#L18)ï¼Œç‰¹åˆ«æ³¨æ„ä¸€ä¸‹`SessionProvider(string)`ï¼Œé©¬ä¸Šå°±è¦æåˆ°ã€‚



### ä¼šè¯ `GlobalSessions`

ç»§ç»­`beego.Run()`çš„é˜…è¯»ï¼Œ`hooks`è°ƒç”¨å®Œæ¯•åï¼Œåˆå§‹åŒ–ä¼šè¯`GlobalSessions`ï¼š

```
if SessionOn {
    var err error
    sessionConfig := AppConfig.String("sessionConfig")
    if sessionConfig == "" {
        sessionConfig = `{"cookieName":"` + SessionName + `",` +
            `"gclifetime":` + strconv.FormatInt(SessionGCMaxLifetime, 10) + `,` +
            `"providerConfig":"` + SessionSavePath + `",` +
            `"secure":` + strconv.FormatBool(HttpTLS) + `,` +
            `"sessionIDHashFunc":"` + SessionHashFunc + `",` +
            `"sessionIDHashKey":"` + SessionHashKey + `",` +
            `"enableSetCookie":` + strconv.FormatBool(SessionAutoSetCookie) + `,` +
            `"cookieLifeTime":` + strconv.Itoa(SessionCookieLifeTime) + `}`
    }
    GlobalSessions, err = session.NewManager(SessionProvider,
        sessionConfig)
    if err != nil {
        panic(err)
    }
    go GlobalSessions.GC()
}
```

`beego.SessionOn`å®šä¹‰æ˜¯å¦å¯åŠ¨SessionåŠŸèƒ½ï¼Œç„¶å`sessionConfig`æ˜¯Sessionçš„é…ç½®ï¼Œå¦‚æœé…ç½®ä¸ºç©ºï¼Œå°±ä½¿ç”¨æ‹¼æ¥çš„é»˜è®¤é…ç½®ã€‚`sessionConfig`æ˜¯jsonæ ¼å¼ã€‚

`session.NewManager()`è¿”å›`*session.Manager`ï¼Œsessionçš„æ•°æ®å­˜å‚¨å¼•æ“æ˜¯`beego.SessionProvider`å®šä¹‰ï¼Œæ¯”å¦‚"fileâ€ï¼Œæ–‡ä»¶å­˜å‚¨ã€‚

`go GlobalSessions.GC()`å¼€å¯ä¸€ä¸ªgoroutineæ¥å¤„ç†sessionçš„å›æ”¶ã€‚é˜…è¯»ä¸€ä¸‹`GC()`çš„ä»£ç ï¼Œåœ¨ [session/session.go#L183](https://github.com/astaxie/beego/blob/master/session/session.go#L183)ï¼š

```
func (manager *Manager) GC() {
    manager.provider.SessionGC()
    time.AfterFunc(time.Duration(manager.config.Gclifetime)*time.Second, func() { manager.GC() })
}
```

è¿™æ˜¯ä¸ª**æ— é™å¾ªç¯**ã€‚`time.AfterFunc()`åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´é—´éš”`time.Duration(...)`ä¹‹åï¼Œåˆè°ƒç”¨è‡ªå·±ï¼Œç›¸å½“äºåˆå¼€å§‹å¯åŠ¨`time.AfterFunc()`ç­‰å¾…ä¸‹ä¸€æ¬¡åˆ°æœŸã€‚`manager.provider.SessionGC()`æ˜¯ä¸åŒsessionå­˜å‚¨å¼•æ“çš„å›æ”¶æ–¹æ³•ï¼ˆå…¶å®æ˜¯`session.Provider`æ¥å£çš„ï¼‰ã€‚



###  æ¨¡æ¿æ„å»º

ç»§ç»­`beego.Run()`ï¼Œsessionåˆå§‹åŒ–åï¼Œæ„å»ºæ¨¡æ¿ï¼š

```
err := BuildTemplate(ViewsPath)
```

`beego.ViewsPath`æ˜¯æ¨¡æ¿çš„ç›®å½•å•¦ï¼Œä¸å¤šè¯´ã€‚ä»”ç»†æ¥çœ‹çœ‹`BuildTemplate()`å‡½æ•°ï¼Œ[template.goL#114](https://github.com/astaxie/beego/blob/master/template.go#L114)ï¼š

```
// build all template files in a directory.
// it makes beego can render any template file in view directory.
func BuildTemplate(dir string) error {
    if _, err := os.Stat(dir); err != nil {
        if os.IsNotExist(err) {
            return nil
        } else {
            return errors.New("dir open err")
        }
    }
    self := &templatefile{
        root:  dir,
        files: make(map[string][]string),
    }
    err := filepath.Walk(dir, func(path string, f os.FileInfo, err error) error {
        return self.visit(path, f, err)
    })
    if err != nil {
        fmt.Printf("filepath.Walk() returned %v\n", err)
        return err
    }
    for _, v := range self.files {
        for _, file := range v {
            t, err := getTemplate(self.root, file, v...)
            if err != nil {
                Trace("parse template err:", file, err)
            } else {
                BeeTemplates[file] = t
            }
        }
    }
    return nil
}
```

æ¯”è¾ƒå¤æ‚ã€‚ä¸€ç‚¹ç‚¹æ¥çœ‹ï¼Œ`os.Stat(dir)`åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨ã€‚`filepath.Walk()`èµ°ä¸€è¾¹ç›®å½•é‡Œçš„æ–‡ä»¶ï¼Œè®°å½•åœ¨`self.files`é‡Œé¢ã€‚å¾ªç¯`self.files`ä¸­çš„`file`ï¼ˆmap[dir][]file])ï¼Œç”¨`getTemplate`è·å–`*template.Template`å®ä¾‹ï¼Œä¿å­˜åœ¨`beego.BeeTemplates`ï¼ˆmap[string]*template.Templateï¼‰ã€‚

ä¸ºä»€ä¹ˆè¦**é¢„å…ˆç¼–è¯‘**æ¨¡æ¿ï¼Ÿæƒ³åƒä¸€ä¸‹ï¼Œå¦‚æœæ¯æ¬¡è¯·æ±‚ï¼Œéƒ½å»å¯»æ‰¾æ¨¡æ¿å†ç¼–è¯‘ä¸€éã€‚è¿™æ˜¾ç„¶æ˜¯ä¸ªæµªè´¹çš„ã€‚è€Œä¸”å¦‚æœæ¨¡æ¿å¤æ‚ï¼ŒåµŒå¥—ä¼—å¤šï¼Œç¼–è¯‘é€Ÿåº¦ä¼šæ˜¯å¾ˆå¤§çš„é—®é¢˜ã€‚å› æ­¤å­˜ä¸‹ç¼–è¯‘å¥½çš„`*template.Template`æ˜¯å¿…ç„¶çš„é€‰æ‹©ã€‚ä½†æ˜¯ï¼Œç¼–è¯‘åæ¨¡æ¿çš„ä¿®æ”¹ä¸èƒ½ç«‹å³å“åº”äº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿå…ˆç»§ç»­çœ‹ä¸‹å»ã€‚



### ä¸­é—´ä»¶

`middleware`åŒ…ç›®å‰ä¼¼ä¹åªæœ‰é”™è¯¯å¤„ç†çš„åŠŸèƒ½ã€‚

```
middleware.RegisterErrorHandler()
```

åªæ˜¯æ³¨å†Œé»˜è®¤çš„é”™è¯¯å¤„ç†æ–¹æ³• `middleware.NotFound` ç­‰å‡ ä¸ªã€‚



### beeAdminApp

```
if EnableAdmin {
    go beeAdminApp.Run()
}
```

`beeAdminApp`ä¹Ÿæ˜¯ä¸€ä¸ª`*beego.adminApp`ï¼Œè´Ÿè´£ç³»ç»Ÿç›‘æ§ã€æ€§èƒ½æ£€æµ‹ã€è®¿é—®ç»Ÿè®¡å’Œå¥åº·æ£€æŸ¥ç­‰ã€‚å…·ä½“çš„ä»‹ç»å’Œä½¿ç”¨å¯ä»¥è®¿é—®[æ–‡æ¡£](http://www.oschina.net/#)ã€‚



## HTTPæœåŠ¡

å†™äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºè¦å¼€å§‹è®²æ ¸å¿ƒç»“æ„`beego.BeeApp`çš„å¯åŠ¨ï¼š

```
BeeApp.Run()
```

`Run()`çš„å®ç°ä»£ç åœ¨[app.go#L29](https://github.com/astaxie/beego/blob/master/app.go#L29)ã€‚ä»£ç è¾ƒé•¿ï¼Œçœ‹çœ‹æœ€é‡è¦çš„ä¸€æ®µï¼š

```
if UseFcgi {
    if HttpPort == 0 {
        l, err = net.Listen("unix", addr)
    } else {
        l, err = net.Listen("tcp", addr)
    }
    if err != nil {
        BeeLogger.Critical("Listen: ", err)
    }
    err = fcgi.Serve(l, app.Handlers)
} else {
    if EnableHotUpdate {
        server := &http.Server{
            Handler:      app.Handlers,
            ReadTimeout:  time.Duration(HttpServerTimeOut) * time.Second,
            WriteTimeout: time.Duration(HttpServerTimeOut) * time.Second,
        }
        laddr, err := net.ResolveTCPAddr("tcp", addr)
        if nil != err {
            BeeLogger.Critical("ResolveTCPAddr:", err)
        }
        l, err = GetInitListener(laddr)
        theStoppable = newStoppable(l)
        err = server.Serve(theStoppable)
        theStoppable.wg.Wait()
        CloseSelf()
    } else {
        s := &http.Server{
            Addr:         addr,
            Handler:      app.Handlers,
            ReadTimeout:  time.Duration(HttpServerTimeOut) * time.Second,
            WriteTimeout: time.Duration(HttpServerTimeOut) * time.Second,
        }
        if HttpTLS {
            err = s.ListenAndServeTLS(HttpCertFile, HttpKeyFile)
        } else {
            err = s.ListenAndServe()
        }
    }
}
```

`beego.UseFcgi`å®šä¹‰æ˜¯å¦ä½¿ç”¨`fast-cgi`æœåŠ¡ï¼Œè€Œä¸æ˜¯HTTPã€‚å¦ä¸€éƒ¨åˆ†æ˜¯å¯åŠ¨HTTPã€‚é‡Œé¢æœ‰ä¸ªé‡è¦åŠŸèƒ½`EnableHotUpdate`â€”â€”â€”â€”**çƒ­æ›´æ–°**ã€‚å¯¹ä»–çš„æè¿°ï¼Œå¯ä»¥çœ‹çœ‹å®˜æ–¹[æ–‡æ¡£](http://beego.me/docs/advantage/reload.md)ã€‚



### 2.1 HTTPè¿‡ç¨‹æ€»è§ˆ

ä¸Šé¢çš„ä»£ç çœ‹å¾—åˆ°`*http.Server.Handler`æ˜¯`app.Handlers`ï¼Œå³`*beego.ControllerRegistor`ï¼Œ`ServeHTTP`å°±å®šä¹‰åœ¨ä»£ç [router.go#L431](https://github.com/astaxie/beego/blob/master/router.go#L431)ã€‚éå¸¸é•¿ï¼Œæˆ‘ä»¬æ£€å‡ºé‡è¦çš„éƒ¨åˆ†æ¥è¯´è¯´ã€‚

é¦–å…ˆæ˜¯è¦åˆ›å»ºå½“å‰è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼š

```
// init context
context := &beecontext.Context{
    ResponseWriter: w,
    Request:        r,
    Input:          beecontext.NewInput(r),
    Output:         beecontext.NewOutput(),
}
context.Output.Context = context
context.Output.EnableGzip = EnableGzip
```

`context`çš„ç±»å‹æ˜¯`*context.Context`ï¼ŒæŠŠå½“å‰çš„`w(http.ResponseWriter)`å’Œ`r(*http.Request)`å†™åœ¨`context`çš„å­—æ®µä¸­ã€‚

ç„¶åï¼Œå®šä¹‰äº†è¿‡æ»¤å™¨`filter`çš„è°ƒç”¨æ–¹æ³•ï¼ŒæŠŠ`context`ä¼ é€’ç»™è¿‡æ»¤å™¨æ“ä½œï¼š

```
do_filter := func(pos int) (started bool) {
    if p.enableFilter {
        if l, ok := p.filters[pos]; ok {
            for _, filterR := range l {
                if ok, p := filterR.ValidRouter(r.URL.Path); ok {
                    context.Input.Params = p
                    filterR.filterFunc(context)
                    if w.started {
                        return true
                    }
                }
            }
        }
    }
    return false
}
```

ç„¶åï¼ŒåŠ è½½Sessionï¼š

```
if SessionOn {
    context.Input.CruSession = GlobalSessions.SessionStart(w, r)
    defer func() {
        context.Input.CruSession.SessionRelease(w)
    }()
}
```

`defer`ä¸­çš„`SessionRelease()`æ˜¯å°†sessionæŒä¹…åŒ–åˆ°å­˜å‚¨å¼•æ“ä¸­ï¼Œæ¯”å¦‚å†™å…¥æ–‡ä»¶ä¿å­˜ã€‚

ç„¶åï¼Œåˆ¤æ–­è¯·æ±‚æ–¹å¼æ˜¯å¦æ”¯æŒï¼š

```
if !utils.InSlice(strings.ToLower(r.Method), HTTPMETHOD) {
    http.Error(w, "Method Not Allowed", 405)
    goto Admin
}
```

è¿™é‡Œçœ‹ä¸€çœ‹åˆ° `goto Admin`ï¼Œå°±æ˜¯æ‰§è¡Œ`AdminApp`çš„ç›‘æ§æ“ä½œï¼Œè®°å½•è¿™æ¬¡è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ã€‚`Admin`å®šä¹‰åœ¨æ•´ä¸ªHTTPæ‰§è¡Œçš„æœ€åï¼š

```
Admin:
    //admin module record QPS
    if EnableAdmin {
        timeend := time.Since(starttime)
        if FilterMonitorFunc(r.Method, requestPath, timeend) {
            if runrouter != nil {
                go toolbox.StatisticsMap.AddStatistics(r.Method, requestPath, runrouter.Name(), timeend)
            } else {
                go toolbox.StatisticsMap.AddStatistics(r.Method, requestPath, "", timeend)
            }
        }
    }
```

æ‰€ä»¥`goto Admin`ç›´æ¥å°±è·³è¿‡ä¸­é—´è¿‡ç¨‹ï¼Œèµ°åˆ°HTTPæ‰§è¡Œçš„æœ€åäº†ã€‚æ˜¾ç„¶ï¼Œå½“è¯·æ±‚æ–¹å¼ä¸æ”¯æŒçš„æ—¶å€™ï¼Œç›´æ¥è·³åˆ°HTTPæ‰§è¡Œæœ€åã€‚å¦‚æœä¸å¯ç”¨`AdminApp`ï¼Œé‚£å°±æ˜¯HTTPæ‰§è¡Œè¿‡ç¨‹ç»“æŸã€‚

ç»§ç»­é˜…è¯»ï¼Œå¼€å§‹å¤„ç†é™æ€æ–‡ä»¶äº†ï¼š

```
if serverStaticRouter(context) {
    goto Admin
}
```

ç„¶åå¤„ç†POSTè¯·æ±‚çš„å†…å®¹ä½“ï¼š

```
if context.Input.IsPost() {
    if CopyRequestBody && !context.Input.IsUpload() {
        context.Input.CopyBody()
    }
    context.Input.ParseFormOrMulitForm(MaxMemory)
}
```

æ‰§è¡Œä¸¤ä¸ªå‰ç½®çš„è¿‡æ»¤å™¨ï¼š

```
if do_filter(BeforeRouter) {
    goto Admin
}

if do_filter(AfterStatic) {
    goto Admin
}
```

ä¸è¿‡æˆ‘è§‰å¾—è¿™ä¿©é¡ºåºæ€ªæ€ªçš„ï¼Œåº”è¯¥å…ˆ`AfterStatic`å`BeforeRouter`ã€‚éœ€è¦æ³¨æ„ï¼Œè¿‡æ»¤å™¨å¦‚æœè¿”å›`false`ï¼Œæ•´ä¸ªæ‰§è¡Œå°±ç»“æŸï¼ˆè·³åˆ°æœ€åï¼‰ã€‚

ç»§ç»­é˜…è¯»ï¼Œç„¶ååˆ¤æ–­æœ‰æ²¡æœ‰æŒ‡å®šæ‰§è¡Œçš„æ§åˆ¶å™¨å’Œæ–¹æ³•ï¼š

```
if context.Input.RunController != nil && context.Input.RunMethod != "" {
    findrouter = true
    runMethod = context.Input.RunMethod
    runrouter = context.Input.RunController
}
```

å¦‚æœè¿‡æ»¤å™¨æ‰§è¡Œåï¼Œå¯¹`context`æŒ‡å®šäº†æ‰§è¡Œçš„æ§åˆ¶å™¨å’Œæ–¹æ³•ï¼Œå°±ç”¨æŒ‡å®šçš„ã€‚

ç»§ç»­ï¼Œè·¯ç”±çš„å¯»æ‰¾å¼€å§‹ï¼Œæœ‰ä¸‰ç§è·¯ç”±ï¼š

```
if !findrouter {
    for _, route := range p.fixrouters {
        n := len(requestPath)
        if requestPath == route.pattern {
            runMethod = p.getRunMethod(r.Method, context, route)
            if runMethod != "" {
                runrouter = route.controllerType
                findrouter = true
                break
            }
        }
        //......
    }
}
```

`p.fixrouters`å°±æ˜¯ä¸å¸¦æ­£åˆ™çš„è·¯ç”±ï¼Œæ¯”å¦‚`/user`ã€‚`route.controllerType`çš„ç±»å‹æ˜¯`reflect.Type`ï¼Œåé¢ä¼šç”¨æ¥åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹ã€‚`p.getRunMethod()`è·å–å®é™…è¯·æ±‚æ–¹å¼ã€‚ä¸ºäº†æ»¡è¶³æµè§ˆå™¨æ— æ³•å‘é€è¡¨å•`PUT`å’Œ`DELETE`æ–¹æ³•ï¼Œå¯ä»¥ç”¨è¡¨å•åŸŸ`_method`å€¼ä»£æ›¿ã€‚ï¼ˆæ³¨æ˜ä¸€ä¸‹`p`å°±æ˜¯`*beego.ControllerRegistor`ã€‚

æ¥ä¸‹æ¥å½“ç„¶æ˜¯æ­£åˆ™çš„è·¯ç”±ï¼š

```
if !findrouter {
    //find a matching Route
    for _, route := range p.routers {

        //check if Route pattern matches url
        if !route.regex.MatchString(requestPath) {
            continue
        }
        // ......
        runMethod = p.getRunMethod(r.Method, context, route)
        if runMethod != "" {
            runrouter = route.controllerType
            context.Input.Params = params
            findrouter = true
            break
        }
    }
}
```

æ­£åˆ™è·¯ç”±æ¯”å¦‚`/user/:id:int`ï¼Œè¿™ç§å¸¦å‚æ•°çš„ã€‚åŒ¹é…åçš„å‚æ•°ä¼šè®°å½•åœ¨`context.Input.Params`ä¸­ã€‚

è¿˜æ²¡æ‰¾åˆ°ï¼Œå°±çœ‹çœ‹æ˜¯å¦éœ€è¦è‡ªåŠ¨è·¯ç”±ï¼š

```
if !findrouter && p.enableAuto {
    // ......
    for cName, methodmap := range p.autoRouter {
        // ......
    }
}
```

æŠŠæ‰€æœ‰è·¯ç”±è§„åˆ™èµ°å®Œï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è§„åˆ™ï¼š

```
if !findrouter {
    middleware.Exception("404", rw, r, "")
    goto Admin
}
```

å¦ä¸€ç§æƒ…å†µå°±æ˜¯æ‰¾åˆ°è·¯ç”±è§„åˆ™å’¯ï¼Œä¸”çœ‹ä¸‹æ–‡ã€‚



### 2.2 è·¯ç”±è°ƒç”¨

ä¸Šé¢çš„ä»£ç å‘ç°è·¯ç”±çš„è°ƒç”¨ä¾èµ–`runrouter`å’Œ`runmethod`å˜é‡ã€‚ä»–ä»¬å€¼è§‰å¾—äº†åˆ°åº•è°ƒç”¨ä»€ä¹ˆæ§åˆ¶å™¨å’Œæ–¹æ³•ã€‚æ¥çœ‹çœ‹å…·ä½“å®ç°ï¼š

```
if findrouter {
    //execute middleware filters
    if do_filter(BeforeExec) {
        goto Admin
    }

    //Invoke the request handler
    vc := reflect.New(runrouter)
    execController, ok := vc.Interface().(ControllerInterface)
    if !ok {
        panic("controller is not ControllerInterface")
    }

    //call the controller init function
    execController.Init(context, runrouter.Name(), runMethod, vc.Interface())

    //if XSRF is Enable then check cookie where there has any cookie in the  request's cookie _csrf
    if EnableXSRF {
        execController.XsrfToken()
        if r.Method == "POST" || r.Method == "DELETE" || r.Method == "PUT" ||
            (r.Method == "POST" && (r.Form.Get("_method") == "delete" || r.Form.Get("_method") == "put")) {
            execController.CheckXsrfCookie()
        }
    }

    //call prepare function
    execController.Prepare()

    if !w.started {
        //exec main logic
        switch runMethod {
        case "Get":
            execController.Get()
        case "Post":
            execController.Post()
        case "Delete":
            execController.Delete()
        case "Put":
            execController.Put()
        case "Head":
            execController.Head()
        case "Patch":
            execController.Patch()
        case "Options":
            execController.Options()
        default:
            in := make([]reflect.Value, 0)
            method := vc.MethodByName(runMethod)
            method.Call(in)
        }

        //render template
        if !w.started && !context.Input.IsWebsocket() {
            if AutoRender {
                if err := execController.Render(); err != nil {
                    panic(err)
                }

            }
        }
    }

    // finish all runrouter. release resource
    execController.Finish()

    //execute middleware filters
    if do_filter(AfterExec) {
        goto Admin
    }
}
```

ç ”è¯»ä¸€ä¸‹ï¼Œæœ€å¼€å§‹çš„åˆæ˜¯è¿‡æ»¤å™¨ï¼š

```
if do_filter(BeforeExec) {
    goto Admin
}
```

`BeforeExec`æ‰§è¡Œæ§åˆ¶å™¨æ–¹æ³•å‰çš„è¿‡æ»¤ã€‚

ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ§åˆ¶å™¨å®ä¾‹ï¼š

```
vc := reflect.New(runrouter)
execController, ok := vc.Interface().(ControllerInterface)
if !ok {
    panic("controller is not ControllerInterface")
}

//call the controller init function
execController.Init(context, runrouter.Name(), runMethod, vc.Interface())
```

`reflect.New()`åˆ›å»ºæ–°çš„å®ä¾‹ï¼Œç”¨`vc.Interface().(ControllerInterface)`å–å‡ºï¼Œè°ƒç”¨æ¥å£çš„`Init`æ–¹æ³•ï¼Œå°†è¯·æ±‚çš„ä¸Šä¸‹æ–‡ç­‰ä¼ é€’è¿›å»ã€‚
è¿™é‡Œå°±è¯´æ˜ä¸ºä»€ä¹ˆä¸èƒ½å­˜ä¸‹æ§åˆ¶å™¨å®ä¾‹ç»™æ¯æ¬¡è¯·æ±‚ä½¿ç”¨ï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚çš„ä¸Šä¸‹æ–‡æ˜¯**ä¸åŒçš„**ã€‚

```
execController.Prepare()
```

æ§åˆ¶å™¨çš„å‡†å¤‡å·¥ä½œï¼Œè¿™é‡Œå¯ä»¥å†™ç”¨æˆ·ç™»å½•éªŒè¯ç­‰ã€‚

ç„¶åæ ¹æ®`runmethod`æ‰§è¡Œæ§åˆ¶å™¨å¯¹åº”çš„æ–¹æ³•ï¼Œéæ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨`reflect.Call`è°ƒç”¨ã€‚

```
if !w.started && !context.Input.IsWebsocket() {
    if AutoRender {
        if err := execController.Render(); err != nil {
            panic(err)
        }
    }
}
```

å¦‚æœè‡ªåŠ¨æ¸²æŸ“`AutoRender`ï¼Œå°±è°ƒç”¨`Render()`æ–¹æ³•æ¸²æŸ“é¡µé¢ã€‚

```
execController.Finish()

//execute middleware filters
if do_filter(AfterExec) {
    goto Admin
}
```

æ§åˆ¶å™¨æœ€åä¸€åˆ€`Finish`æå®šï¼Œç„¶åè¿‡æ»¤å™¨`AfterExec`ä½¿ç”¨ã€‚

æ€»ç»“èµ·æ¥ï¼Œ`beego.ControllerInterface`æ¥å£æ–¹æ³•çš„`Init`,`Prepare`,`Render`å’Œ`Finish`å‘æŒ¥å¾ˆå¤§ä½œç”¨ã€‚é‚£å°±æ¥ç ”ç©¶ä¸€ä¸‹ã€‚



##  æ§åˆ¶å™¨å’Œè§†å›¾



###  æ§åˆ¶å™¨æ¥å£

æ§åˆ¶å™¨æ¥å£`beego.ControllerInterface`çš„å®šä¹‰åœ¨[controller.go#L47](https://github.com/astaxie/beego/blob/master/controller.go#L47)ï¼š

```
type ControllerInterface interface {
    Init(ct *context.Context, controllerName, actionName string, app interface{})
    Prepare()
    Get()
    Post()
    Delete()
    Put()
    Head()
    Patch()
    Options()
    Finish()
    Render() error
    XsrfToken() string
    CheckXsrfCookie() bool
}
```

å®˜æ–¹çš„å®ç°`beego.Controller`å®šä¹‰åœ¨[controller.go#L29](https://github.com/astaxie/beego/blob/master/controller.go#L29)ï¼š

```
type Controller struct {
    Ctx            *context.Context
    Data           map[interface{}]interface{}
    controllerName string
    actionName     string
    TplNames       string
    Layout         string
    LayoutSections map[string]string // the key is the section name and the value is the template name
    TplExt         string
    _xsrf_token    string
    gotofunc       string
    CruSession     session.SessionStore
    XSRFExpire     int
    AppController  interface{}
    EnableReander  bool
}
```

å†…å®¹å¥½å¤šï¼Œæ²¡å¿…è¦å…¨éƒ¨éƒ½çœ‹çœ‹ï¼Œé‡ç‚¹åœ¨`Init`,`Prepare`,`Render`å’Œ`Finish`è¿™å››ä¸ªã€‚



###  æ§åˆ¶å™¨çš„å®

`Init`æ–¹æ³•ï¼š

```
// Init generates default values of controller operations.
func (c *Controller) Init(ctx *context.Context, controllerName, actionName string, app interface{}) {
    c.Layout = ""
    c.TplNames = ""
    c.controllerName = controllerName
    c.actionName = actionName
    c.Ctx = ctx
    c.TplExt = "tpl"
    c.AppController = app
    c.EnableReander = true
    c.Data = ctx.Input.Data
}
```

æ²¡ä»€ä¹ˆè¯è¯´ï¼Œä¸€å †èµ‹å€¼ã€‚å”¯ä¸€è¦è°ˆçš„æ˜¯`c.EnableReander`ï¼Œè¿™ç§æ‹¼å†™é”™è¯¯å®åœ¨æ˜¯ï¼Œæ‰é˜´æ²Ÿé‡Œã€‚å®é™…çš„æ„æ€æ˜¯`EnableRender`ã€‚

`Prepare`å’Œ`Finish`æ–¹æ³•ï¼š

```
// Prepare runs after Init before request function execution.
func (c *Controller) Prepare() {

}

// Finish runs after request function execution.
func (c *Controller) Finish() {

}
```

ç©ºçš„ï¼åŸæ¥æˆ‘è¦è‡ªå·±å¡«å†…å®¹å•Šã€‚

`Render`æ–¹æ³•ï¼š

```
// Render sends the response with rendered template bytes as text/html type.
func (c *Controller) Render() error {
    if !c.EnableReander {
        return nil
    }
    rb, err := c.RenderBytes()

    if err != nil {
        return err
    } else {
        c.Ctx.Output.Header("Content-Type", "text/html; charset=utf-8")
        c.Ctx.Output.Body(rb)
    }
    return nil
}
```



### è§†å›¾æ¸²æŸ“

æ¸²æŸ“çš„æ ¸å¿ƒæ–¹æ³•æ˜¯`c.RenderBytes()`:

```
// RenderBytes returns the bytes of rendered template string. Do not send out response.
func (c *Controller) RenderBytes() ([]byte, error) {
    //if the controller has set layout, then first get the tplname's content set the content to the layout
    if c.Layout != "" {
        if c.TplNames == "" {
            c.TplNames = strings.ToLower(c.controllerName) + "/" + strings.ToLower(c.actionName) + "." + c.TplExt
        }
        if RunMode == "dev" {
            BuildTemplate(ViewsPath)
        }
        newbytes := bytes.NewBufferString("")
        if _, ok := BeeTemplates[c.TplNames]; !ok {
            panic("can't find templatefile in the path:" + c.TplNames)
            return []byte{}, errors.New("can't find templatefile in the path:" + c.TplNames)
        }
        err := BeeTemplates[c.TplNames].ExecuteTemplate(newbytes, c.TplNames, c.Data)
        if err != nil {
            Trace("template Execute err:", err)
            return nil, err
        }
        tplcontent, _ := ioutil.ReadAll(newbytes)
        c.Data["LayoutContent"] = template.HTML(string(tplcontent))

        if c.LayoutSections != nil {
            for sectionName, sectionTpl := range c.LayoutSections {
                if sectionTpl == "" {
                    c.Data[sectionName] = ""
                    continue
                }

                sectionBytes := bytes.NewBufferString("")
                err = BeeTemplates[sectionTpl].ExecuteTemplate(sectionBytes, sectionTpl, c.Data)
                if err != nil {
                    Trace("template Execute err:", err)
                    return nil, err
                }
                sectionContent, _ := ioutil.ReadAll(sectionBytes)
                c.Data[sectionName] = template.HTML(string(sectionContent))
            }
        }

        ibytes := bytes.NewBufferString("")
        err = BeeTemplates[c.Layout].ExecuteTemplate(ibytes, c.Layout, c.Data)
        if err != nil {
            Trace("template Execute err:", err)
            return nil, err
        }
        icontent, _ := ioutil.ReadAll(ibytes)
        return icontent, nil
    } else {
        //......
    }
    return []byte{}, nil
}
```

çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œä¸»è¦æ˜¯ä¸¤ç§æƒ…å†µï¼Œæœ‰æ²¡æœ‰Layoutã€‚å¦‚æœæœ‰Layoutï¼š

```
err := BeeTemplates[c.TplNames].ExecuteTemplate(newbytes, c.TplNames, c.Data)
// ......
tplcontent, _ := ioutil.ReadAll(newbytes)
c.Data["LayoutContent"] = template.HTML(string(tplcontent))
```

æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶ï¼Œå°±æ˜¯å¸ƒå±€çš„ä¸»å†…å®¹ã€‚

```
for sectionName, sectionTpl := range c.LayoutSections {
    if sectionTpl == "" {
        c.Data[sectionName] = ""
        continue
    }

    sectionBytes := bytes.NewBufferString("")
    err = BeeTemplates[sectionTpl].ExecuteTemplate(sectionBytes, sectionTpl, c.Data)
    // ......
    sectionContent, _ := ioutil.ReadAll(sectionBytes)
    c.Data[sectionName] = template.HTML(string(sectionContent))
}
```

æ¸²æŸ“å¸ƒå±€é‡Œçš„åˆ«çš„åŒºå—`c.LayoutSections`ã€‚

```
ibytes := bytes.NewBufferString("")
err = BeeTemplates[c.Layout].ExecuteTemplate(ibytes, c.Layout, c.Data)
// ......
icontent, _ := ioutil.ReadAll(ibytes)
return icontent, nil
```

æœ€åæ˜¯æ¸²æŸ“å¸ƒå±€æ–‡ä»¶ï¼Œ`c.Data`é‡Œå¸¦æœ‰æ‰€æœ‰å¸ƒå±€çš„ä¸»å†…å®¹å’ŒåŒºå—ï¼Œå¯ä»¥ç›´æ¥èµ‹å€¼åœ¨å¸ƒå±€é‡Œã€‚

æ¸²æŸ“è¿‡ç¨‹æœ‰è¶£çš„ä»£ç ï¼š

```
if RunMode == "dev" {
    BuildTemplate(ViewsPath)
}
```

å¼€å‘çŠ¶æ€ä¸‹ï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°`BuildTemplate()`ã€‚è¿™æ ·å°±å¯ä»¥ç†è§£ï¼Œæœ€åˆæ¸²æŸ“æ¨¡æ¿å¹¶å­˜ä¸‹`*template.Template`ï¼Œç”Ÿäº§æ¨¡å¼ä¸‹ï¼Œæ˜¯ä¸ä¼šå“åº”å³æ—¶çš„æ¨¡ç‰ˆä¿®æ”¹ã€‚



## END é“¾æ¥

<ul><li><div><a href = '66.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '68.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
