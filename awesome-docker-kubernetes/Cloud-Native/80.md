+ [author](http://nsddd.top)

# ç¬¬80èŠ‚ è·¨å¹³å°ç¼–è¯‘

<div><a href = '79.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '81.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## å‰è¨€

https://github.com/OpenIMSDK/Open-IM-Server/issues/432

ç°åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¯¹æœåŠ¡çš„å›½äº§åŒ–é€‚é…æœ‰æ‰€è¦æ±‚ï¼Œä¸€èˆ¬çš„å›½äº§åŒ–å¹³å°éƒ½æä¾›armç‰ˆæœ¬çš„linuxäº‘ç¯å¢ƒä¾›æˆ‘ä»¬è¿›è¡ŒæœåŠ¡éƒ¨ç½²ï¼Œå› æ­¤éœ€è¦æ„å»ºarmç‰ˆæœ¬çš„é•œåƒã€‚

## æ„å»ºæ–¹æ¡ˆ

åœ¨ä¸Šé¢çš„ issue ä¸­æˆ‘ä»¬æè¿°äº†å¤§è‡´çš„æ„å»ºæ€è·¯å’Œè§£å†³çš„æ­¥éª¤ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ„å»ºçš„æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä»¥æœ€å¸¸ç”¨çš„ amd æœºå™¨ä¸ºä¾‹ï¼Œæ¥ç¼–è¯‘ armã€‚å¯¹äºæ„å»ºé•œåƒçš„ARMç‰ˆæœ¬ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š

1. åœ¨ARMæœºå™¨ä¸Šä½¿ç”¨ docker build è¿›è¡Œæ„å»ºï¼›
2. åœ¨X86/AMD64 çš„æœºå™¨ä¸Šä½¿ç”¨ docker buildx è¿›è¡Œäº¤å‰æ„å»ºï¼›

> **âš ï¸æ³¨æ„ï¼š**
>
> 1. äº¤å‰æ„å»ºå’Œäº¤å‰è¿è¡Œçš„æ–¹å¼ä¼šæœ‰ä¸€äº›æ— æ³•é¢„çŸ¥çš„é—®é¢˜ï¼Œå»ºè®®ç®€å•çš„æ„å»ºæ­¥éª¤ï¼ˆå¦‚åªæ˜¯ä¸‹è½½è§£å‹å¯¹åº”æ¶æ„çš„æ–‡ä»¶ï¼‰å¯è€ƒè™‘åœ¨x86ä¸‹äº¤å‰æ„å»ºï¼Œå¤æ‚çš„ï¼ˆå¦‚éœ€è¦ç¼–è¯‘çš„ï¼‰åˆ™ç›´æ¥åœ¨armæœºå™¨ä¸Šè¿›è¡Œæ„å»ºï¼›
> 2. å®é™…æµ‹è¯•å‘ç°ï¼Œä½¿ç”¨[qemuæ–¹å¼](https://github.com/multiarch/qemu-user-static)åœ¨x86å¹³å°ä¸‹è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒæ—¶ï¼Œæ‰§è¡Œç®€å•çš„å‘½ä»¤å¯ä»¥æˆåŠŸï¼ˆå¦‚archï¼‰ï¼Œæ‰§è¡ŒæŸäº›å¤æ‚çš„ç¨‹åºæ—¶ï¼ˆå¦‚å¯åŠ¨javaè™šæ‹Ÿæœºï¼‰ï¼Œä¼šæ— å“åº”ï¼Œæ‰€ä»¥é•œåƒçš„éªŒè¯å·¥ä½œåº”å°½é‡æ”¾ç½®åˆ°armæœºå™¨ä¸Šè¿›è¡Œï¼›
>
> **ä¸Šé¢ç¬¬äºŒç‚¹æŒ‰å¦‚ä¸‹æ–¹å¼æµ‹è¯•ï¼š**
>
> + `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine arch` å¯æ­£å¸¸è¾“å‡ºï¼›
> + `docker run --rm --platform=linux/arm64 openjdk:8u212-jre-alpine java -version` åˆ™ä¼š **å¡ä½**ï¼Œä¸”éœ€è¦ä½¿ç”¨`docker stop`åœæ­¢å®¹å™¨æ‰å¯ä»¥é€€å‡ºå®¹å™¨ï¼›

## å¯ç”¨è¯•éªŒæ€§åŠŸèƒ½

> ğŸ’¡ æ³¨æ„ï¼šbuildx ä»…æ”¯æŒ docker19.03 åŠä»¥ä¸Šdockerç‰ˆæœ¬

å¦‚éœ€ä½¿ç”¨ buildxï¼Œéœ€è¦å¼€å¯dockerçš„å®éªŒåŠŸèƒ½åï¼Œæ‰å¯ä»¥ä½¿ç”¨ï¼Œå¼€å¯æ–¹å¼ï¼š

ç¼–è¾‘ `/etc/docker/daemon.json` ï¼Œæ·»åŠ ï¼š

```jsx
{
    "experimental": true
}
```

ç¼–è¾‘ `ï½/.docker/config.json` æ·»åŠ ï¼š

```jsx
"experimental" : "enabled"
```

é‡å¯Dockerä½¿ç”Ÿæ•ˆï¼š

+ `sudo systemctl daemon-reload`
+ `sudo systemctl restart docker`

ç¡®è®¤æ˜¯å¦å¼€å¯ï¼š

+ `docker version -f'{{.Server.Experimental}}'`
+ å¦‚æœè¾“å‡ºtrueï¼Œåˆ™è¡¨ç¤ºå¼€å¯æˆåŠŸ

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­æ„å»ºå¤šç§ç³»ç»Ÿæ¶æ„æ”¯æŒçš„ Docker é•œåƒï¼Œè¦æƒ³ä½¿ç”¨ç»Ÿä¸€çš„åå­—å¿…é¡»ä½¿ç”¨ `[$ docker manifest](notion://www.notion.so/docker_practice/image/manifest)` å‘½ä»¤ã€‚

åœ¨ Docker 19.03+ ç‰ˆæœ¬ä¸­å¯ä»¥ä½¿ç”¨ `$ docker buildx build` å‘½ä»¤ä½¿ç”¨ `BuildKit` æ„å»ºé•œåƒã€‚è¯¥å‘½ä»¤æ”¯æŒ `--platform` å‚æ•°å¯ä»¥åŒæ—¶æ„å»ºæ”¯æŒå¤šç§ç³»ç»Ÿæ¶æ„çš„ Docker é•œåƒï¼Œå¤§å¤§ç®€åŒ–äº†æ„å»ºæ­¥éª¤ã€‚

## ä½¿ç”¨buildxæ„å»º

buildx çš„è¯¦ç»†ä½¿ç”¨å¯å‚è€ƒï¼š[Dockerå®˜æ–¹æ–‡æ¡£-Reference-buildx](https://docs.docker.com/engine/reference/commandline/buildx/?fileGuid=0l3NVKX0BgflYN3R)

### **åˆ›å»º buildx æ„å»ºå™¨**

ä½¿ç”¨ docker buildx ls å‘½ä»¤æŸ¥çœ‹ç°æœ‰çš„æ„å»ºå™¨

```bash
root@rbqntnwlflfxvigv:~# docker buildx ls
NAME/NODE DRIVER/ENDPOINT STATUS  BUILDKIT PLATFORMS
default * docker                           
  default default         running 20.10.24 linux/amd64, linux/386
```

åˆ›å»ºå¹¶æ„å»ºå™¨ï¼š

```bash
# ä¸‹é¢çš„åˆ›å»ºå‘½ä»¤ä»»é€‰ä¸€æ¡ç¬¦åˆæƒ…å†µçš„å³å¯
# 1. ä¸æŒ‡å®šä»»ä½•å‚æ•°åˆ›å»º
docker buildx create --use --name multiarch-builder
# 2. å¦‚åˆ›å»ºåä½¿ç”¨docker buildx ls å‘ç°æ„å»ºèµ·æ²¡æœ‰armæ¶æ„æ”¯æŒï¼Œå¯ä½¿ç”¨--platformæ˜ç¡®æŒ‡å®šè¦æ”¯æŒçš„æ„å»ºç±»å‹ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤
docker buildx create --platform linux/arm64,linux/arm/v7,linux/arm/v6 --name multiarch-builder
# 3. å¦‚éœ€åœ¨buildxè®¿é—®ç§æœ‰registryï¼Œå¯ä½¿ç”¨hostæ¨¡å¼ï¼Œå¹¶æ‰‹åŠ¨æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œé¿å…buildxæ—¶æ— æ³•è®¿é—®æœ¬åœ°çš„registryä¸»æœº
docker buildx create --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6  --driver-opt network=host --config=/Users/hanlyjiang/.docker/buildx-config.toml --use --name multiarch-builder
```

buildx-config.toml é…ç½®æ–‡ä»¶å†™æ³•ç±»ä¼¼ï¼š

```bash
# <https://github.com/moby/buildkit/blob/master/docs/buildkitd.toml.md>
# registry configures a new Docker register used for cache import or output.
[registry."zh-registry.geostar.com.cn"]
  mirrors = ["zh-registry.geostar.com.cn"]
  http = true
  insecure = true
```

**å¯ç”¨æ„å»ºå™¨**

```bash
# åˆå§‹åŒ–å¹¶æ¿€æ´»
docker buildx inspect multiarch-builder --bootstrap
```

**ç¡®è®¤æˆåŠŸ**

```bash
# ä½¿ç”¨ docker buildx ls æŸ¥çœ‹
docker buildx ls
```

Docker åœ¨ Linux ç³»ç»Ÿæ¶æ„ä¸‹æ˜¯ä¸æ”¯æŒ arm æ¶æ„é•œåƒï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€ä¸ªæ–°çš„å®¹å™¨è®©å…¶æ”¯æŒè¯¥ç‰¹æ€§ï¼ŒDocker æ¡Œé¢ç‰ˆåˆ™æ— éœ€è¿›è¡Œæ­¤é¡¹è®¾ç½®ï¼ˆmacç³»ç»Ÿï¼‰ã€‚

+ åœ¨å†…æ ¸ä¸­ä½¿ç”¨ QEMU ä»¿çœŸæ”¯æŒæ¥è¿›è¡Œå¤šæ¶æ„é•œåƒæ„å»º

```bash
# å®‰è£…æ¨¡æ‹Ÿå™¨ï¼ˆç”¨äºå¤šå¹³å°é•œåƒæ„å»ºï¼‰
$ docker run --rm --privileged tonistiigi/binfmt:latest --install all
```

ç”±äº Docker é»˜è®¤çš„ `builder` å®ä¾‹ä¸æ”¯æŒåŒæ—¶æŒ‡å®šå¤šä¸ª `--platform`ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ `builder` å®ä¾‹ã€‚åŒæ—¶ç”±äºå›½å†…æ‹‰å–é•œåƒè¾ƒç¼“æ…¢ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é…ç½®äº† [é•œåƒåŠ é€Ÿåœ°å€](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmoby%2Fbuildkit%2Fblob%2Fmaster%2Fdocs%2Fbuildkitd.toml.md) `[dockerpracticesig/buildkit:master](<https://github.com/docker-practice/buildx>)` é•œåƒæ›¿æ¢å®˜æ–¹é•œåƒ

```
# é€‚ç”¨äºå›½å†…ç¯å¢ƒ
root@i-3uavns2y:~# docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master

# é€‚ç”¨äºè…¾è®¯äº‘ç¯å¢ƒ(è…¾è®¯äº‘ä¸»æœºã€coding.net æŒç»­é›†æˆ)
root@i-3uavns2y:~# docker buildx create --use --name=mybuilder-cn --driver docker-container --driver-opt image=dockerpracticesig/buildkit:master-tencent
# ä½¿ç”¨é»˜è®¤é•œåƒ
root@i-3uavns2y:~# docker buildx create --name mybuilder --driver docker-container

# ä½¿ç”¨æ–°åˆ›å»ºå¥½çš„ builder å®ä¾‹
root@i-3uavns2y:~# docker buildx use mybuilder
```

æŸ¥çœ‹å·²æœ‰çš„ builder å®ä¾‹

```go
root@i-tpmja312:~# docker buildx ls
NAME/NODE    DRIVER/ENDPOINT             STATUS   PLATFORMS
mybuilder *  docker-container
  mybuilder0 unix:///var/run/docker.sock inactivedefault      docker
  default    default                     running  linux/amd64, linux/386
```

æ„å»ºï¼š

```yaml
docker buildx build --platform linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/386,linux/ppc64le,linux/s390x -t kubecub/hello . --push
```

### **ä¿®æ”¹Dockerfile**

å¯¹ Dockerfile çš„ä¿®æ”¹ï¼Œå¤§è‡´éœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

1. ç¡®è®¤åŸºç¡€é•œåƒï¼ˆFROMï¼‰æ˜¯å¦æœ‰armç‰ˆæœ¬ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å¯ä»¥ä¸ç”¨æ”¹åŠ¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦å¯»æ‰¾æ›¿ä»£é•œåƒï¼Œå¦‚æ²¡æœ‰æ›¿ä»£é•œåƒï¼Œåˆ™å¯èƒ½éœ€è¦è‡ªè¡Œç¼–è¯‘ï¼›
2. ç¡®è®¤dockerfileçš„å„ä¸ªæ­¥éª¤ä¸­æ˜¯å¦æœ‰ä¾èµ–CPUæ¶æ„çš„ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éœ€è¦æ›¿æ¢æˆarmæ¶æ„çš„ï¼Œå¦‚åœ¨æ„å»ºjitisçš„é•œåƒæ—¶ï¼ŒDockerfileä¸­æœ‰æ·»åŠ ä¸€ä¸ªamd64æ¶æ„çš„è½¯ä»¶

```
ADD <https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-amd64.tar.gz> /tmp/s6-overlay.tar.gz
```

æ­¤æ—¶éœ€è¦æ›¿æ¢ä¸ºä¸‹é¢çš„åœ°å€(æ³¨æ„amd64æ›¿æ¢æˆäº†aarch64ï¼Œå½“ç„¶ï¼Œéœ€è¦å…ˆç¡®è®¤ä¸‹è½½åœ°å€ä¸­æœ‰æ— å¯¹åº”æ¶æ„çš„gzåŒ…ï¼Œä¸èƒ½ç®€å•åšå­—ç¬¦æ›¿æ¢)ï¼š

```
ADD <https://github.com/just-containers/s6-overlay/releases/download/v1.21.4.0/s6-overlay-aarch64.tar.gz> /tmp/s6-overlay.tar.gz
```

å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤è¯¥è½¯ä»¶æœ‰æ­¤æ¶æ„çš„å½’æ¡£åŒ…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦è€ƒè™‘ä»æºç æ„å»ºï¼›

> æç¤ºï¼š
>
> æ€ä¹ˆç¡®å®šä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ `/so` åº“çš„å¯¹åº”çš„æ‰§è¡Œæ¶æ„ï¼Ÿ å¯ä»¥é€šè¿‡ `file {å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„}` æ¥æŸ¥çœ‹ï¼Œ
>
> å¦‚ä¸‹é¢æ—¶macOSä¸Šæ‰§è¡Œfileå‘½ä»¤çš„è¾“å…¥ï¼Œå¯ä»¥å‘ç°macOSä¸Šçš„gitç¨‹åºå¯ä»¥å…¼å®¹ä¸¤ç§æ¶æ„-`x86_64&arm64e`ï¼š
>
> ```
> file $(which git)
> /usr/bin/git: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
> /usr/bin/git (for architecture x86_64):	Mach-O 64-bit executable x86_64
> /usr/bin/git (for architecture arm64e):	Mach-O 64-bit executable arm64e
> ```
>
> ä¸‹é¢çš„å‘½ä»¤åˆ™å¯¹ä¸€ä¸ªsoæ–‡ä»¶æ‰§è¡Œäº†fileï¼Œå¯ä»¥çœ‹åˆ°å…¶ä¸­çš„æ¶æ„ä¿¡æ¯ `ARM aarch64`ï¼š
>
> ```
> file /lib/aarch64-linux-gnu/libpthread-2.23.so
> /lib/aarch64-linux-gnu/libpthread-2.23.so: ELF 64-bit LSB shared object, ARM aarch64, version 1 (GNU/Linux), dynamically linked, interpreter /lib/ld-linux-aarch64.so.1, BuildID[sha1]=880365ebb22114e4c10108b73243144d5fa315dc, for GNU/Linux 3.7.0, not stripped
> ```

### docker buildx æ„å»ºarm64é•œåƒçš„å‘½ä»¤

ä½¿ç”¨ --platformæ¥æŒ‡å®šæ¶æ„ï¼Œä½¿ç”¨ `--push` æˆ– `--load` æ¥æŒ‡å®šæ„å»ºå®Œæ¯•åçš„åŠ¨ä½œã€‚

```
docker buildx build --platform=linux/arm64,linux/amd64 -t xxxx:tag . --push
```

> æç¤ºï¼šå½“æŒ‡å®šå¤šä¸ªæ¶æ„æ—¶ï¼Œåªèƒ½ä½¿ç”¨ --push æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼Œæ— æ³• `--load`ï¼Œæ¨é€æˆåŠŸåå†é€šè¿‡ `docker pull --platform` æ¥æ‹‰å–æŒ‡å®šæ¶æ„çš„é•œåƒ

### **æ£€æŸ¥æ„å»ºæˆæœ**

1. é€šè¿‡ `docker buildx imagetools inspect` å‘½ä»¤æŸ¥çœ‹é•œåƒä¿¡æ¯ï¼Œçœ‹æ˜¯å¦æœ‰å¯¹åº”çš„armæ¶æ„ä¿¡æ¯ï¼›
2. å®é™…è¿è¡Œé•œåƒï¼Œç¡®è®¤è¿è¡Œæ­£å¸¸ï¼›ï¼ˆåœ¨armæœºå™¨ä¸Šæ‰§è¡Œï¼‰

> æç¤ºï¼šå¦‚è¿è¡Œæ—¶è¾“å‡º `exec format error` ç±»ä¼¼é”™è¯¯ï¼Œåˆ™è¡¨ç¤ºé•œåƒä¸­éƒ¨åˆ†å¯æ‰§è¡Œæ–‡ä»¶æ¶æ„ä¸åŒ¹é…ã€‚

## **åœ¨x86ä¸Šè¿è¡Œarmé•œåƒ**

å¯å‚è€ƒ [github/qemu-user-static](https://github.com/multiarch/qemu-user-static) ,ç®€è¦æè¿°å¦‚ä¸‹ï¼š

+ æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å®‰è£…ï¼š

  `docker run --rm --privileged multiarch/qemu-user-static --reset -p yes`

+ ä¹‹åå³å¯è¿è¡Œarmç‰ˆæœ¬çš„é•œåƒï¼Œå¦‚ï¼š

  ```
  docker run --rm -t arm64v8/fedora uname -m
  ```

## **åœ¨x86å¹³å°ä¸‹ä½¿ç”¨Buildxæ„å»ºè·¨å¹³å°é•œåƒå¹¶è¿è¡Œarmåº”ç”¨**

æˆ‘ä»¬æ¼”ç¤ºäº†ä¸€ä¸‹ç®€å•çš„æ„å»ºæ–¹æ³•ï¼Œ

### å®‰è£… qemu å¤šå¹³å°æ”¯æŒ

è¿è¡Œä»¥ä¸‹å®¹å™¨ï¼š

```
docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
```

è¯¥å®¹å™¨ä¼šä¸ºä½ çš„è®¾å¤‡å®‰è£… qemu å¤šå¹³å°æ”¯æŒï¼Œå¦‚æœä½ éœ€è¦è¿è¡Œè·¨å¹³å°å®¹å™¨ï¼Œä¹Ÿä¼šç”¨åˆ°å®ƒã€‚

### **åˆ›å»ºæ–°çš„ builder å®ä¾‹å¹¶è®¾ä¸ºé»˜è®¤**

```
docker buildx create --use --name mybuilder
```

çœ‹åˆ°è¾“å‡º `mybuilder` å³è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼Œä½¿ç”¨ `--use` æŒ‡ä»¤å°†åœ¨ builder å®ä¾‹åˆ›å»ºå®Œæˆæ—¶è‡ªåŠ¨å°†å…¶è®¾ä¸ºé»˜è®¤ï¼Œå¦åˆ™éœ€è¦æ‰‹åŠ¨ä½¿ç”¨ `docker buildx use mybuilder` å°†åˆ›å»ºçš„å®ä¾‹è®¾ä¸ºé»˜è®¤ã€‚

### **ä½¿ç”¨ Buildx æ„å»ºå¤šå¹³å°é•œåƒ**

Buildx çš„ä½¿ç”¨ä¸ docker build ååˆ†ç›¸ä¼¼ï¼ŒåŸºæœ¬ä¸Šåªéœ€è¦å°†å‘½ä»¤ä¸­çš„ `docker build` æ›¿æ¢æˆ `docker buildx build` å³å¯ã€‚å¦‚æœä½¿ç”¨ `docker buildx install` å°†é»˜è®¤çš„ docker build æ›¿æ¢ä¸º Buildxï¼Œé‚£ä¹ˆç›´æ¥ä½¿ç”¨ `docker build` å³å¯ã€‚

ä¾‹å¦‚ï¼Œå°†å½“å‰ç›®å½•ä¸‹çš„ Dockerfile æ–‡ä»¶æ‰“åŒ…æˆé•œåƒï¼Œéœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```
docker buildx build -t xxx/xxx:tag . --push
```

å¦‚æœæ›¿æ¢äº†é»˜è®¤ docker buildï¼Œå°†æ˜¯è¿™æ ·çš„ï¼š

```
docker build -t xxx/xxx:tag . --push
```

`-push` æŒ‡ä»¤ä¼šè‡ªåŠ¨æŠŠæ„å»ºå¥½çš„é•œåƒæ¨é€åˆ°è¿œç«¯ä»“åº“ï¼Œå¦åˆ™åªä¼šåœ¨å­˜æ”¾åœ¨ cache ä¸­ã€‚

å¦‚æœè¦æ„å»ºå¤šå¹³å°é•œåƒï¼Œåœ¨æŒ‡ä»¤ä¸­åŠ å…¥ `--platform=` å³å¯ï¼Œç­‰å·åå¡«å†™éœ€è¦æ„å»ºçš„å¹³å°ï¼Œå¦‚ `linux/arm`ï¼Œ`linux/arm64`ï¼Œ`linux/amd64` ç­‰ï¼Œç”¨ `,` éš”å¼€ã€‚Dockerfile æœ¬èº«å¹¶ä¸éœ€è¦åšå‡ºæ›´æ”¹ï¼Œé™¤éä½ éœ€è¦åšçš„æ“ä½œåœ¨ä¸åŒå¹³å°ä¸‹æœ‰æ‰€åŒºåˆ«ï¼Œæ¯”å¦‚æ ¹æ®å¹³å°ä¸‹è½½ä¸åŒæ–‡ä»¶ç­‰ã€‚

```docker
docker buildx build --platform=linux/arm,linux/arm64,linux/amd64 -t xxx/xxx:tag . --push
```

Buildx å°†æ ¹æ®ä»¥ä¸ŠæŒ‡ä»¤è‡ªåŠ¨æ„å»ºä¸‰ä¸ªå¹³å°çš„é•œåƒå¹¶æ¨é€åˆ°è¿œç«¯ï¼Œè¿™ä¸‰ä¸ªé•œåƒä¼šä½¿ç”¨å‘½ä»¤ä¸­æŒ‡å®šçš„åŒä¸€ä¸ª tagã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‡å®šçš„å¹³å°å¿…é¡»æ˜¯åº•å±‚é•œåƒæ‰€æ”¯æŒçš„ã€‚

æœ¬åœ°æ”¯æŒä¸ƒç§æ„å»ºï¼š

```yaml
docker buildx build --platform linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/386,linux/ppc64le,linux/s390x -t doubledong/hello . --push
```

åœ¨ [Docker Documents](https://docs.docker.com/buildx/working-with-buildx/) æŸ¥çœ‹æ›´å¤šè¯¦ç»†çš„è¯´æ˜ã€‚

## ä½¿ç”¨ GitHub Action è‡ªåŠ¨æ„å»ºå¤šå¹³å°é•œåƒ

ç”±äº DockerHub çš„è‡ªåŠ¨æ„å»ºå·¥å…·å¯¹å¤šå¹³å°æ”¯æŒå¹¶ä¸å‹å¥½ï¼Œæ¨èä½¿ç”¨ GitHub Action æ¥æ„å»ºã€‚å…·ä½“çš„ yaml  æ–‡ä»¶å¦‚ä¸‹ï¼š

```yaml
name: docker build and push

on:
  release:
    branches: [ main ]
    types: released
    # å°†åœ¨mainåˆ†æ”¯çš„releaseå‘å¸ƒæ—¶è‡ªåŠ¨è¿è¡Œè¯¥æµç¨‹
  workflow_dispatch:
    # å°†åœ¨GitHub Actionç•Œé¢åˆ›å»ºä¸€ä¸ªrun workflowæŒ‰é’®ï¼Œç‚¹å‡»åæ‰§è¡Œè¯¥æµç¨‹
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get the tag name
        run: echo "TAG=${GITHUB_REF/refs\\/tags\\//}" >> $GITHUB_ENV
        # è·å–release tagï¼Œåœ¨åˆ›å»ºé•œåƒæ—¶ä¼šç”¨åˆ°
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v1

      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v1.3.0
        # å¯ç”¨Buildx
      - name: Login
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
            # ç™»é™†DockerHubè´¦å·ï¼Œä¾›æ¨é€é•œåƒä½¿ç”¨ï¼Œè¿™é‡Œçš„secretséœ€è¦åœ¨ä»“åº“è®¾ç½®é¡µé¢æ·»åŠ 
      - name: Build and Push with Version Tag
        uses: docker/build-push-action@v2
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm
          push: true
          tags: xxx/abc:${{ env.TAG }}
          # ä½¿ç”¨ä»“åº“æ ¹ç›®å½•ä¸­çš„Dockerfileæ„å»ºä¸‰ä¸ªå¹³å°çš„é•œåƒï¼Œå¹¶æ¨é€åˆ°xxx/abcä»“åº“ï¼Œä½¿ç”¨ä¹‹å‰è·å–çš„tag
```

### è·¨å¹³å°è¿è¡Œå®¹å™¨çš„ç­–ç•¥

æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•è·¨å¹³å°ç¼–è¯‘ï¼Œé‚£ä¹ˆæ‹‰å–é•œåƒçš„ç­–ç•¥æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ã€‚é»˜è®¤ä½¿ç”¨ docker pull æŒ‡ä»¤åªä¼šæ‹‰å–å’Œå½“å‰å¹³å°ä¸€è‡´çš„é•œåƒï¼Œè¦æ‹‰å–å…¶ä»–å¹³å°çš„é•œåƒï¼Œä½¿ç”¨â€“platform æŒ‡å®šå¯¹åº”çš„å¹³å°ã€‚

åŒæ ·ï¼Œåœ¨ä½¿ç”¨ docker run è¿è¡Œå®¹å™¨æ—¶ä¹Ÿéœ€è¦ä½¿ç”¨â€“platform æŒ‡å®šå¹³å°ã€‚

å¦‚æœä½¿ç”¨ docker-compose æ¥ç®¡ç†å®¹å™¨ï¼Œéœ€è¦åœ¨ image çš„åŒçº§æ·»åŠ ç±»ä¼¼ `platform: linux/arm` çš„æŒ‡ä»¤æ¥æŒ‡å®šå¹³å°ã€‚å¦‚æœæœ¬åœ°å·²æœ‰ç›¸åŒ tag çš„å…¶ä»–å¹³å°é•œåƒï¼Œéœ€è¦ä½¿ç”¨ `docker-compose pull` æ¥æ‹‰å–éœ€è¦å¹³å°çš„é•œåƒ

### æ¡ˆä¾‹æ¼”ç¤º

å‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„ golang ç¨‹åºæºç ï¼š

```yaml
â¯ cat hello.go
/*************************************************************************
   > File Name: hello.go
   > Author: smile
   > Mail: 3293172751nss@gmail.com
   > Created Time: Sun Jun 11 12:37:18 2023
************************************************************************/
package main

import (
        "fmt"
        "runtime"
)

func main() {
        fmt.Printf("Hello, %s!\\n", runtime.GOARCH)
}
```

åˆ›å»ºä¸€ä¸ª Dockerfile å°†è¯¥åº”ç”¨å®¹å™¨åŒ–ï¼š

```yaml
â¯ cat Dockerfile
FROM golang:alpine AS builder
RUN mkdir /app
ADD . /app/
WORKDIR /app
RUN go build -o hello .

FROM alpine
RUN mkdir /app
WORKDIR /app
COPY --from=builder /app/hello .
CMD ["./hello"]
```

è¿™æ˜¯ä¸€ä¸ªå¤šé˜¶æ®µæ„å»º Dockerfileï¼Œä½¿ç”¨ Go ç¼–è¯‘å™¨æ¥æ„å»ºåº”ç”¨ï¼Œå¹¶å°†æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‹·è´åˆ° alpine é•œåƒä¸­ã€‚

ç°åœ¨å°±å¯ä»¥ä½¿ç”¨ buildx æ„å»ºä¸€ä¸ªæ”¯æŒ armã€arm64 å’Œ amd64 å¤šæ¶æ„çš„ Docker é•œåƒäº†ï¼ŒåŒæ—¶å°†å…¶æ¨é€åˆ° **Docker Hub**ï¼š

```yaml
â†’ docker buildx build -t cubxxw/hello-arch --platform=linux/arm,linux/arm64,linux/amd64 . --push
```

> éœ€è¦æå‰é€šè¿‡ docker login å‘½ä»¤ç™»å½•è®¤è¯ Docker Hubã€‚

ç°åœ¨å°±å¯ä»¥é€šè¿‡ `docker pull mirailabs/hello-arch` æ‹‰å–åˆšåˆšåˆ›å»ºçš„é•œåƒäº†ï¼ŒDocker å°†ä¼šæ ¹æ®ä½ çš„ CPU æ¶æ„æ‹‰å–åŒ¹é…çš„é•œåƒã€‚

èƒŒåçš„åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œä¹‹å‰å·²ç»æåˆ°è¿‡äº†ï¼Œbuildx ä¼šé€šè¿‡ `QEMU` å’Œ `binfmt_misc` åˆ†åˆ«ä¸º 3 ä¸ªä¸åŒçš„ CPU æ¶æ„ï¼ˆarmï¼Œarm64 å’Œ amd64ï¼‰æ„å»º 3 ä¸ªä¸åŒçš„é•œåƒã€‚æ„å»ºå®Œæˆåï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª **manifest** ï¼Œå…¶ä¸­åŒ…å«äº†æŒ‡å‘è¿™ 3 ä¸ªé•œåƒçš„æŒ‡é’ˆã€‚

ç°åœ¨å°±å¯ä»¥é€šè¿‡ `docker pull mirailabs/hello-arch` æ‹‰å–åˆšåˆšåˆ›å»ºçš„é•œåƒäº†ï¼ŒDocker å°†ä¼šæ ¹æ®ä½ çš„ CPU æ¶æ„æ‹‰å–åŒ¹é…çš„é•œåƒã€‚

èƒŒåçš„åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œä¹‹å‰å·²ç»æåˆ°è¿‡äº†ï¼Œbuildx ä¼šé€šè¿‡ `QEMU` å’Œ `binfmt_misc` åˆ†åˆ«ä¸º 3 ä¸ªä¸åŒçš„ CPU æ¶æ„ï¼ˆarmï¼Œarm64 å’Œ amd64ï¼‰æ„å»º 3 ä¸ªä¸åŒçš„é•œåƒã€‚æ„å»ºå®Œæˆåï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª **manifest list**ï¼Œå…¶ä¸­åŒ…å«äº†æŒ‡å‘è¿™ 3 ä¸ªé•œåƒçš„æŒ‡é’ˆã€‚

**ä¿å­˜åœ¨æœ¬åœ°ï¼š**

å¦‚æœæƒ³å°†æ„å»ºå¥½çš„é•œåƒä¿å­˜åœ¨æœ¬åœ°ï¼Œå¯ä»¥å°† `type` æŒ‡å®šä¸º `docker`ï¼Œä½†å¿…é¡»åˆ†åˆ«ä¸ºä¸åŒçš„ CPU æ¶æ„æ„å»ºä¸åŒçš„é•œåƒï¼Œä¸èƒ½åˆå¹¶æˆä¸€ä¸ªé•œåƒï¼Œå³ï¼š

```yaml
â†’ docker buildx build -t cubxxw/hello-arch --platform=linux/arm -o type=docker .
â†’ docker buildx build -t cubxxw/hello-arch --platform=linux/arm64 -o type=docker .
â†’ docker buildx build -t cubxxw/hello-arch --platform=linux/amd64 -o type=docker .
```

### **æµ‹è¯•å¤šå¹³å°é•œåƒ**

ç”±äºä¹‹å‰å·²ç»å¯ç”¨äº† `binfmt_misc`ï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥è¿è¡Œä»»ä½• CPU æ¶æ„çš„ Docker é•œåƒäº†ï¼Œå› æ­¤å¯ä»¥åœ¨æœ¬åœ°ç³»ç»Ÿä¸Šæµ‹è¯•ä¹‹å‰ç”Ÿæˆçš„ 3 ä¸ªé•œåƒæ˜¯å¦æœ‰é—®é¢˜ã€‚

é¦–å…ˆåˆ—å‡ºæ¯ä¸ªé•œåƒçš„ `digests`ï¼š

```yaml
? â†’ docker buildx imagetools inspect cubxxw/hello-arch

Name:      docker.io/cubxxw/hello-arch:latest
MediaType: application/vnd.docker.distribution.manifest.list.v2+json
Digest:    sha256:ec55f5ece9a12db0c6c367acda8fd1214f50ee502902f97b72f7bff268ebc35a

Manifests:
  Name:      docker.io/cubxxw/hello-arch:latest@sha256:38e083870044cfde7f23a2eec91e307ec645282e76fd0356a29b32122b11c639
  MediaType: application/vnd.docker.distribution.manifest.v2+json
  Platform:  linux/arm/v7

  Name:      docker.io/cubxxw/hello-arch:latest@sha256:de273a2a3ce92a5dc1e6f2d796bb85a81fe1a61f82c4caaf08efed9cf05af66d
  MediaType: application/vnd.docker.distribution.manifest.v2+json
  Platform:  linux/arm64

  Name:      docker.io/cubxxw/hello-arch:latest@sha256:8b735708d7d30e9cd6eb993449b1047b7229e53fbcebe940217cb36194e9e3a2
  MediaType: application/vnd.docker.distribution.manifest.v2+json
  Platform:  linux/amd64
```

è¿è¡Œæ¯ä¸€ä¸ªé•œåƒå¹¶è§‚å¯Ÿè¾“å‡ºç»“æœï¼š

```yaml
? â†’ docker run --rm docker.io/cubxxw/hello-arch:latest@sha256:38e083870044cfde7f23a2eec91e307ec645282e76fd0356a29b32122b11c639
Hello, arm!

? â†’ docker run --rm docker.io/cubxxw/hello-arch:latest@sha256:de273a2a3ce92a5dc1e6f2d796bb85a81fe1a61f82c4caaf08efed9cf05af66d
Hello, arm64!

? â†’ docker run --rm docker.io/cubxxw/hello-arch:latest@sha256:8b735708d7d30e9cd6eb993449b1047b7229e53fbcebe940217cb36194e9e3a2
Hello, amd64!
```

## **[buildx çš„è·¨å¹³å°æ„å»ºç­–ç•¥](https://waynerv.com/posts/building-multi-architecture-images-with-docker-buildx/#contents:buildx-çš„è·¨å¹³å°æ„å»ºç­–ç•¥)**

æ ¹æ®æ„å»ºèŠ‚ç‚¹å’Œç›®æ ‡ç¨‹åºè¯­è¨€ä¸åŒï¼Œ`buildx` æ”¯æŒä»¥ä¸‹ä¸‰ç§è·¨å¹³å°æ„å»ºç­–ç•¥ï¼š

1. é€šè¿‡ QEMU çš„ç”¨æˆ·æ€æ¨¡å¼åˆ›å»ºè½»é‡çº§çš„è™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºç³»ç»Ÿä¸­æ„å»ºé•œåƒã€‚
2. åœ¨ä¸€ä¸ª builder å®ä¾‹ä¸­åŠ å…¥å¤šä¸ªä¸åŒç›®æ ‡å¹³å°çš„èŠ‚ç‚¹ï¼Œé€šè¿‡åŸç”ŸèŠ‚ç‚¹æ„å»ºå¯¹åº”å¹³å°é•œåƒã€‚
3. åˆ†é˜¶æ®µæ„å»ºå¹¶ä¸”äº¤å‰ç¼–è¯‘åˆ°ä¸åŒçš„ç›®æ ‡æ¶æ„ã€‚

QEMU é€šå¸¸ç”¨äºæ¨¡æ‹Ÿå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡ç”¨æˆ·æ€æ¨¡å¼è¿è¡Œï¼šä»¥ `binfmt_misc` åœ¨å®¿ä¸»æœºç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªäºŒè¿›åˆ¶è½¬æ¢å¤„ç†ç¨‹åºï¼Œå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€ç¿»è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦å°†ç³»ç»Ÿè°ƒç”¨ä»ç›®æ ‡ CPU æ¶æ„è½¬æ¢ä¸ºå½“å‰ç³»ç»Ÿçš„ CPU æ¶æ„ã€‚æœ€ç»ˆçš„æ•ˆæœå°±åƒåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œç›®æ ‡ CPU æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚Docker Desktop å†…ç½®äº† QEMU æ”¯æŒï¼Œå…¶ä»–æ»¡è¶³è¿è¡Œè¦æ±‚çš„å¹³å°å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š

```yaml
docker run --privileged --rm tonistiigi/binfmt --install all
```

## OpenIM è·¨å¹³å°ç¼–è¯‘å®æˆ˜

æˆ‘ä»¬éœ€è¦åˆ¶ä½œ OpenIM ç¦»çº¿éƒ¨ç½²çš„æ–¹æ¡ˆï¼Œé¦–å…ˆæ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦ç†Ÿæ‚‰ OpenIM éƒ¨ç½²éœ€è¦å“ªäº›ç»„ä»¶ï¼ŒæŸ¥çœ‹

| Service Name       | Image                                   | Supported Architectures | Ports                   |
| ------------------ | --------------------------------------- | ----------------------- | ----------------------- |
| mysql              | mysql:5.7                               | amd64, arm64v8, arm32v7 | 13306:3306, 23306:33060 |
| mongodb            | mongo:4.0                               | amd64, arm64v8, arm32v7 | 37017:27017             |
| redis              | redis                                   | amd64, arm64v8, arm32v7 | 16379:6379              |
| zookeeper          | wurstmeister/zookeeper                  | amd64                   | 2181:2181               |
| kafka              | wurstmeister/kafka                      | amd64, arm              | 9092:9092               |
| etcd               | http://quay.io/coreos/etcd              | amd64, arm64v8          | 2379:2379, 2380:2380    |
| minio              | minio/minio                             | amd64, arm64v8, arm32v7 | 10005:9000, 9090:9090   |
| open_im_server     | openim/open_im_server:v2.3.9            | amd64                   | N/A                     |
| open_im_enterprise | openim/open_im_enterprise:v1.0.3        | amd64                   | N/A                     |
| prometheus         | prom/prometheus                         | amd64, arm64v8, arm32v7 | N/A                     |
| grafana            | grafana/grafana                         | amd64, arm64v8, arm32v7 | N/A                     |
| node-exporter      | http://quay.io/prometheus/node-exporter | amd64, arm64v8, arm32v7 | 9100:9100               |

æ³¨æ„çœ‹ï¼Œ zookeeper å’Œ openim å¹¶æ²¡æœ‰æä¾› arm æ¶æ„çš„è®¾è®¡æ–¹æ¡ˆã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±å»ç¼–è¯‘ arm æ¶æ„çš„é•œåƒï¼Œè¿™ä¸€å±‚è®¾è®¡æ¯”è¾ƒå¤æ‚ã€‚ä¸ºäº†å½¢æˆæ„å»ºçš„è‡ªåŠ¨åŒ–ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ CICD å’Œ Makefile é›†æˆã€‚



## END é“¾æ¥
<ul><li><div><a href = '79.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '81.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
