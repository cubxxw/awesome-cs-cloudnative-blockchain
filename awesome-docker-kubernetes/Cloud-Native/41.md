+ [author](http://nsddd.top)

# ç¬¬41èŠ‚ é€Ÿè¯» horizon æºç ï¼Œæ ¸å¿ƒè®¾è®¡æ€æƒ³

<div><a href = '40.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '42.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## å¼€å§‹

ç”±äº horzon é¡¹ç›®ç†è§£çš„å¹¶æ²¡æœ‰ sealerã€sealos æ·±å…¥ï¼Œç®—æ˜¯ä¸€ä¸ªä»é›¶å¼€å§‹å­¦ä¹ çš„é¡¹ç›®ã€‚

å‡†å¤‡é€Ÿè¿‡ä¸€é horzon çš„æºç ï¼Œä»¥åŠéƒ¨åˆ†çš„ç»†èŠ‚ï¼Œå…ˆçœ‹ç›®å½•ç»“æ„ï¼Œåˆ†æç°åœ¨çš„åŸºæœ¬åŠŸèƒ½ï¼Œå†è§‚å¯Ÿç¬¬ä¸€ä¸ª PRï¼Œä»¥åŠæœ€å¼€å§‹çš„ `Important issue`ã€‚



## ç›®å½•ç»“æ„

```bash
â¯ tree -L 2
.
â”œâ”€â”€ CODE-OF-CONDUCT.md
â”œâ”€â”€ CONTRIBUTING.md
â”œâ”€â”€ Horizon.svg
â”œâ”€â”€ LICENSE
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ README_ZH-CN.md
â”œâ”€â”€ bin
â”‚   â””â”€â”€ app
â”œâ”€â”€ build
â”‚   â”œâ”€â”€ build.sh
â”‚   â”œâ”€â”€ core
â”‚   â””â”€â”€ swagger
â”œâ”€â”€ build-json-schema.json
â”œâ”€â”€ build-ui-schema.json
â”œâ”€â”€ config.yaml
â”œâ”€â”€ core
â”‚   â”œâ”€â”€ cmd
â”‚   â”œâ”€â”€ common
â”‚   â”œâ”€â”€ config
â”‚   â”œâ”€â”€ controller
â”‚   â”œâ”€â”€ errors
â”‚   â”œâ”€â”€ http
â”‚   â”œâ”€â”€ main.go
â”‚   â””â”€â”€ middleware
â”œâ”€â”€ db
â”‚   â”œâ”€â”€ 20210908_initial_schema.sql
â”‚   â”œâ”€â”€ 20211124.sql
â”‚   â”œâ”€â”€ 20211125.sql
â”‚   â”œâ”€â”€ 20220113.sql
â”‚   â”œâ”€â”€ 20220124.sql
â”‚   â”œâ”€â”€ 20220330.sql
â”‚   â”œâ”€â”€ 20220516.sql
â”‚   â”œâ”€â”€ 20220519.sql
â”‚   â”œâ”€â”€ 20220712.sql
â”‚   â”œâ”€â”€ 20220722.sql
â”‚   â”œâ”€â”€ 20220816.sql
â”‚   â”œâ”€â”€ 20220823.sql
â”‚   â”œâ”€â”€ 20220824.sql
â”‚   â”œâ”€â”€ 20220908.sql
â”‚   â”œâ”€â”€ 20220920.sql
â”‚   â”œâ”€â”€ 20220921.sql
â”‚   â”œâ”€â”€ 20221031.sql
â”‚   â”œâ”€â”€ 20221110.sql
â”‚   â”œâ”€â”€ 20221111.sql
â”‚   â”œâ”€â”€ 20221117.sql
â”‚   â”œâ”€â”€ 20221121.sql
â”‚   â”œâ”€â”€ 20221201.sql
â”‚   â”œâ”€â”€ 20230302.sql
â”‚   â””â”€â”€ migrations
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ image
â”‚   â””â”€â”€ readme
â”œâ”€â”€ integrationtest
â”‚   â””â”€â”€ authpagerender_test.go
â”œâ”€â”€ lib
â”‚   â”œâ”€â”€ gitlab
â”‚   â”œâ”€â”€ orm
â”‚   â”œâ”€â”€ q
â”‚   â””â”€â”€ s3
â”œâ”€â”€ mock
â”‚   â”œâ”€â”€ lib
â”‚   â””â”€â”€ pkg
â”œâ”€â”€ openapi
â”‚   â”œâ”€â”€ v1
â”‚   â””â”€â”€ v2
â”œâ”€â”€ pkg
â”‚   â”œâ”€â”€ accesstoken
â”‚   â”œâ”€â”€ application
â”‚   â”œâ”€â”€ applicationregion
â”‚   â”œâ”€â”€ auth
â”‚   â”œâ”€â”€ authentication
â”‚   â”œâ”€â”€ cluster
â”‚   â”œâ”€â”€ common
â”‚   â”œâ”€â”€ config
â”‚   â”œâ”€â”€ context
â”‚   â”œâ”€â”€ environment
â”‚   â”œâ”€â”€ environmentregion
â”‚   â”œâ”€â”€ errors
â”‚   â”œâ”€â”€ event
â”‚   â”œâ”€â”€ eventhandler
â”‚   â”œâ”€â”€ git
â”‚   â”œâ”€â”€ grafana
â”‚   â”œâ”€â”€ group
â”‚   â”œâ”€â”€ hook
â”‚   â”œâ”€â”€ horizonapp
â”‚   â”œâ”€â”€ idp
â”‚   â”œâ”€â”€ jobs
â”‚   â”œâ”€â”€ member
â”‚   â”œâ”€â”€ oauth
â”‚   â”œâ”€â”€ param
â”‚   â”œâ”€â”€ pipelinerun
â”‚   â”œâ”€â”€ rbac
â”‚   â”œâ”€â”€ region
â”‚   â”œâ”€â”€ registry
â”‚   â”œâ”€â”€ server
â”‚   â”œâ”€â”€ tag
â”‚   â”œâ”€â”€ template
â”‚   â”œâ”€â”€ templaterelease
â”‚   â”œâ”€â”€ templaterepo
â”‚   â”œâ”€â”€ templateschematag
â”‚   â”œâ”€â”€ token
â”‚   â”œâ”€â”€ user
â”‚   â”œâ”€â”€ userlink
â”‚   â”œâ”€â”€ util
â”‚   â””â”€â”€ webhook
â”œâ”€â”€ roles.yaml
â”œâ”€â”€ scopes.yaml
â””â”€â”€ scripts
    â”œâ”€â”€ install.sh
    â”œâ”€â”€ k3s
    â””â”€â”€ make-rules
```

æ³¨æ„ k3s å’Œ make-rules è¿˜æ²¡æœ‰åˆå¹¶è¿›å»ï¼Œæˆ‘ä»¬ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

+ `CODE-OF-CONDUCT.md`ï¼šè¡Œä¸ºå®ˆåˆ™ã€‚
+ `CONTRIBUTING.md`ï¼šè´¡çŒ®æŒ‡å—ã€‚
+ `Horizon.svg`ï¼šé¡¹ç›®å›¾æ ‡ã€‚
+ `LICENSE`ï¼šå¼€æºè®¸å¯è¯ã€‚
+ `Makefile`ï¼šæ„å»ºè„šæœ¬ã€‚
+ `README.md`ï¼šé¡¹ç›®è¯´æ˜æ–‡æ¡£ã€‚
+ `README_ZH-CN.md`ï¼šä¸­æ–‡è¯´æ˜æ–‡æ¡£ã€‚
+ `bin/app`ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ã€‚
+ `build/build.sh`ï¼šæ„å»ºè„šæœ¬ã€‚
+ `build/core`ï¼šæ„å»ºæ ¸å¿ƒã€‚
+ `build/swagger`ï¼šæ„å»º swagger æ–‡æ¡£ã€‚
+ `build-json-schema.json`ï¼šJSON æ¶æ„æ–‡ä»¶ã€‚
+ `build-ui-schema.json`ï¼šUI æ¶æ„æ–‡ä»¶ã€‚
+ `config.yaml`ï¼šé…ç½®æ–‡ä»¶ã€‚
+ `core`ï¼šæ ¸å¿ƒä»£ç ã€‚
+ `db`ï¼šæ•°æ®åº“è„šæœ¬ã€‚
+ `go.mod` å’Œ `go.sum`ï¼šä¾èµ–ç®¡ç†æ–‡ä»¶ã€‚
+ `image/readme`ï¼šé•œåƒè¯´æ˜æ–‡æ¡£ã€‚
+ `integrationtest/authpagerender_test.go`ï¼šé›†æˆæµ‹è¯•ä»£ç ã€‚
+ `lib/gitlab`ï¼šGitLab ç›¸å…³ä»£ç ã€‚
+ `lib/orm`ï¼šORM ç›¸å…³ä»£ç ã€‚
+ `lib/q`ï¼šæŸ¥è¯¢ç›¸å…³ä»£ç ã€‚
+ `lib/s3`ï¼šS3 ç›¸å…³ä»£ç ã€‚
+ `mock`ï¼šæ¨¡æ‹Ÿä»£ç ã€‚
+ `openapi`ï¼šOpenAPI ç›¸å…³ä»£ç ã€‚
+ `pkg`ï¼šå…¬å…±åŒ…ã€‚
+ `roles.yaml`ï¼šè§’è‰²é…ç½®æ–‡ä»¶ã€‚
+ `scopes.yaml`ï¼šä½œç”¨åŸŸé…ç½®æ–‡ä»¶ã€‚
+ `scripts`ï¼šè„šæœ¬æ–‡ä»¶ã€‚



Maybe it can be fixï¼š

+ `build` è¿ç§»åˆ° `scripts` ä¸­ï¼ŒDockerfile è¿ç§»å‡ºæ¥
+ `core` ç›®å½•æ”¹æˆ `internal` ç›®å½•



## ç¬¬ä¸€ç‰ˆ

å¾ˆå¯æƒœçš„æ˜¯ `horizon` å¹¶æ²¡æœ‰ `0.1` ç‰ˆæœ¬çš„ï¼Œè€Œæ˜¯ä» `2.0.1` å¼€å§‹å¼€æºçš„ï¼š

```bash
v2.0.1
v2.0.10
v2.0.11
v2.0.12
v2.0.2
v2.0.2-rc1
v2.0.3
v2.0.4
v2.0.5
v2.0.6
v2.0.7
v2.0.8
v2.0.9
```

è¿™æ ·çœ‹ç€å¤ªä¸å‹å¥½äº†ï¼ŒåŒæ ·å¯¹äº **åˆ†æ”¯çš„** è®¾å®šï¼š

```go
dependabot/go_modules/github.com/prometheus/client_golang-1.11.1
dependabot/go_modules/golang.org/x/net-0.7.0
dependabot/go_modules/helm.sh/helm/v3-3.11.1
kilosonc-patch-1
kilosonc-patch-2
kilosonc-patch-3
main
```

é¡¹ç›®ä¸­ä¹Ÿæ²¡ç”¨ `CHANGELOG` æ¥æè¿°ç‰ˆæœ¬ä¿¡æ¯çš„å˜æ›´ï¼Œè¿™é‡Œå¯ä»¥æ”¹å˜ä¸‹ï¼Œå¥½æœ‰ CHANGELOG ç”¨æ¥å±•ç¤ºæ¯ä¸ªç‰ˆæœ¬ä¹‹é—´çš„å˜æ›´å†…å®¹ï¼Œä½œä¸º Release Note çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨ç¼–å†™ CHANGELOGï¼Œä¼šå¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸å®¹æ˜“åšæŒï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©[git-chglogopen in new window](https://github.com/git-chglog/git-chglog)å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆã€‚ 

ä¸ä»…å¦‚æ­¤ï¼Œä¸€ä¸ªé¡¹ç›®ä¹Ÿéœ€è¦æœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œå½“å‰ç”¨å¾—æ¯”è¾ƒå¤šçš„æ˜¯è¯­ä¹‰åŒ–ç‰ˆæœ¬å·è§„èŒƒã€‚ä½†å¦‚æœé å¼€å‘è€…æ‰‹åŠ¨æ‰“ç‰ˆæœ¬å·ï¼Œå·¥ä½œæ•ˆç‡ä½ä¸è¯´ï¼Œç»å¸¸è¿˜ä¼šå‡ºç°æ¼æ‰“ã€æ‰“çš„ç‰ˆæœ¬å·ä¸è§„èŒƒç­‰é—®é¢˜ã€‚æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯ï¼Œç‰ˆæœ¬å·ä¹Ÿé€šè¿‡å·¥å…·è‡ªåŠ¨ç”Ÿæˆã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨[gsemveropen in new window](https://github.com/arnaud-deprez/gsemver)å·¥å…·æ¥è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·ã€‚

æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¾å…¥åˆ° `scripts/ensure_tag.sh` è„šæœ¬ä¸­ï¼Œå¯ä»¥é€šè¿‡ Makefile å’Œ CI æµç¨‹è¿›è¡Œè°ƒç”¨ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œå¯¹äºä¸€ä¸ªä¼˜è´¨çš„å¼€æºé¡¹ç›®æ¥è¯´ï¼Œåˆ†ä¸ºå¼€å‘é˜¶æ®µå’Œæµ‹è¯•è§£å†³ï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥ç”¨ CICD æµç¨‹è¿›è¡Œæ§åˆ¶çš„ã€‚åœ¨å¼€å‘é˜¶æ®µç”Ÿæˆä»£ç ã€ç‰ˆæƒæ£€æŸ¥ã€ä»£ç æ ¼å¼åŒ–ã€é™æ€ä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€æ„å»ºç­‰æ“ä½œéƒ½æ˜¯å¯ä»¥åº”ç”¨åˆ° Makefile å’Œ CICD æµçš„ã€‚

æˆ‘ä»¬ é˜…è¯»ä¸‹ horizon æœ€æ—©çš„ç‰ˆæœ¬ï¼ˆç”±äºå¹¶æ²¡æœ‰å¯¹åº”åˆé€‚çš„ branch å’Œ tagï¼Œæˆ‘ä»¬é€‰æ‹© Frist commitï¼‰ï¼š

![image-20230416104617735](http://sm.nsddd.top/sm202304161046942.png)

ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„æäº¤æ˜¯å¯¹ openAPI çš„è§„èŒƒ

> OpenAPI æ˜¯ä¸€ç§è§„èŒƒï¼Œç”¨äºå®šä¹‰ RESTful APIï¼Œå®ƒåŸºäº JSON æˆ– YAML æ ¼å¼ï¼Œç”¨äºæè¿° API çš„è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœç­‰è¯¦ç»†ä¿¡æ¯ï¼Œä»¥ä¾¿äºç”Ÿæˆå®¢æˆ·ç«¯ SDK å’Œ API æ–‡æ¡£ã€‚åœ¨ Horizon é¡¹ç›®ä¸­ï¼Œopenapi æ–‡ä»¶å¤¹å­˜æ”¾ç€ OpenAPI ç›¸å…³çš„ä»£ç ã€‚

```yaml
openapi: 3.0.0
info:
  title: Horizon Group API
  description: |
    This API
  version: 1.0.0
tags:
  - name: group
paths:
  /groups:
    get:
      operationId: listGroups
      summary: list groups
      parameters:
        - $ref: "#/components/parameters/searchParam"
      responses:
        "201":
          description: null response
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/error"
  /group:
    post:
      operationId: createGroup
      summary: create a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/newGroup"
      responses:
        "201":
          description: null response
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/error"
  /group/{group}:
    parameters:
      - $ref: "#/components/parameters/groupParam"
    get:
      operationId: getGroupDetail
      summary: get the detail of a group
      responses:
        '200':
          description: Expected response to a valid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/groupDetail"
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/error"
    put:
      operationId: updateGroupDetail
      summary: update detail of a group
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/groupDetail'
      responses:
        '200':
          description: Update result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/groupDetail'
        default:
          description:  Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/error'
    delete:
      operationId: deleteGroup
      summary: delete an empty group
      responses:
        '200':
          description: null response
        default:
          description:  Unexpected error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/error'
  /group/{group}/subgroups:
    parameters:
      - $ref: "#/components/parameters/groupParam"
      - $ref: "#/components/parameters/searchParam"
    get:
      operationId: listSubGroups
      responses:
        '200':
          description: Return the list of groups
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/groupDetail'
  /group/{group}/services:
    parameters:
      - $ref: "#/components/parameters/groupParam"
      - $ref: "#/components/parameters/searchParam"
    get:
      operationId: listGroupService
      responses:
        '200':
          description: Return the list of service
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: 'service.yaml#/components/schemas/serviceDetail'
components:
  parameters:
    groupParam:
      name: group
      in: path
      required: true
      schema:
        type: string
    searchParam:
      name: search
      in: query
      description: Return the list of authorized groups matching the search criteria
      required: false
      schema:
        type: string
  schemas:
    queryGroup:
      type: string
      maxLength: 100
      description: param for querying group
    newGroup:
      type: object
      required:
        - name
        - path
        - visibilityLevel
      properties:
        name:
          $ref: '#/components/schemas/groupName'
        path:
          $ref: '#/components/schemas/groupPath'
        description:
          $ref: '#/components/schemas/groupDescription'
        visibilityLevel:
          $ref: '#/components/schemas/visibilityLevel'
        parantId:
          $ref: '#/components/schemas/groupId'

    groupDetail:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/groupId'
        name:
          $ref: '#/components/schemas/groupName'
        path:
          $ref: '#/components/schemas/groupPath'
        description:
          $ref: '#/components/schemas/groupDescription'
        visibilityLevel:
          $ref: '#/components/schemas/visibilityLevel'
        createTime:
          $ref: '#/components/schemas/date'
    date:
      type: string
      format: date
      pattern: full-date
    groupId:
      type: integer
      format: int64
      description: the parent id of the subgroup,if not provided. a root group
    groupName:
      type: string
      maxLength: 64
      description: the group Name
    groupPath:
      type: string
      maxLength: 1024
      description: the group path
    visibilityLevel:
      type: integer
      format: int32
      enum: [0,1]
      default: 0
      description: 0 means public(every one can see the group), 1 means private one member can see
    groupDescription:
      type: string
      maxLength: 1024
      description: the group description
    error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: integer
          format: int32
        message:
          type: string

```



**Swagger å’Œ OpenAPI çš„åŒºåˆ«ï¼š**

+ [æ–‡ç« ](https://k8s-iam.nsddd.top/iam/projects/10.html#%E5%BC%80%E5%A7%8B)

ä¼˜åŒ–ï¼š ç”¨ [go-swagger](https://github.com/go-swagger/go-swagger) æ¥ç”Ÿæˆ Swagger API æ–‡æ¡£

ä¸ºä»€ä¹ˆä¸ç”¨ swagï¼Ÿ

+ **go-swagger æ¯” swag åŠŸèƒ½æ›´å¼ºå¤§ï¼š** go-swagger æä¾›äº†æ›´çµæ´»ã€æ›´å¤šçš„åŠŸèƒ½æ¥æè¿°æˆ‘ä»¬çš„ APIã€‚
+ **ä½¿æˆ‘ä»¬çš„ä»£ç æ›´æ˜“è¯»**ï¼šå¦‚æœä½¿ç”¨ swagï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ª API éƒ½éœ€è¦æœ‰ä¸€ä¸ªå†—é•¿çš„æ³¨é‡Šï¼Œæœ‰æ—¶å€™ä»£ç æ³¨é‡Šæ¯”ä»£ç è¿˜è¦é•¿ï¼Œä½†æ˜¯é€šè¿‡ go-swagger æˆ‘ä»¬å¯ä»¥å°†ä»£ç å’Œæ³¨é‡Šåˆ†å¼€ç¼–å†™ï¼Œä¸€æ–¹é¢å¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç ä¿æŒç®€æ´ï¼Œæ¸…æ™°æ˜“è¯»ï¼Œå¦ä¸€æ–¹é¢æˆ‘ä»¬å¯ä»¥åœ¨å¦å¤–ä¸€ä¸ªåŒ…ä¸­ï¼Œç»Ÿä¸€ç®¡ç†è¿™äº› Swagger API æ–‡æ¡£å®šä¹‰ã€‚
+ **æ›´å¥½çš„ç¤¾åŒºæ”¯æŒ**ï¼šgo-swagger ç›®å‰æœ‰éå¸¸å¤šçš„ Github star æ•°ï¼Œå‡ºç° Bug çš„æ¦‚ç‡å¾ˆå°ï¼Œå¹¶ä¸”å¤„åœ¨ä¸€ä¸ªé¢‘ç¹æ›´æ–°çš„æ´»è·ƒçŠ¶æ€ã€‚



## nocalhost

+ [å¿«é€Ÿä¸Šæ‰‹](https://nocalhost.dev/zh-CN/docs/quick-start/)

`nocalhost` æ˜¯ä¸€ç§åŸºäº Kubernetes çš„æœ¬åœ°å¼€å‘å¹³å°ï¼Œå®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨æœ¬åœ°å¿«é€Ÿæ„å»ºå’Œæµ‹è¯•åº”ç”¨ç¨‹åºã€‚ä½¿ç”¨ `nocalhost`ï¼Œä½ å¯ä»¥è½»æ¾åœ°åœ¨æœ¬åœ°è¿è¡Œå®Œæ•´çš„ Kubernetes ç¯å¢ƒï¼Œå¹¶åœ¨å…¶ä¸­éƒ¨ç½²å’Œæµ‹è¯•åº”ç”¨ç¨‹åºã€‚ä»¥ä¸‹æ˜¯ `nocalhost` çš„ä¸»è¦åŠŸèƒ½ï¼š

+ é€šè¿‡ `nocalhost`ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªå®Œæ•´çš„ Kubernetes ç¯å¢ƒï¼ŒåŒ…æ‹¬æ‰€æœ‰å¿…è¦çš„ç»„ä»¶å’Œæ’ä»¶ã€‚
+ `nocalhost` æ”¯æŒå„ç§ä¸åŒç±»å‹çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…æ‹¬ Javaã€Node.jsã€Python ç­‰ã€‚
+ ä½ å¯ä»¥ä½¿ç”¨ `nocalhost` åœ¨æœ¬åœ°æ„å»ºå’Œè¿è¡Œåº”ç”¨ç¨‹åºï¼Œä»¥ä¾¿äºå¼€å‘å’Œæµ‹è¯•ã€‚
+ `nocalhost` è¿˜æä¾›äº†ä¸€äº›æœ‰ç”¨çš„å·¥å…·å’Œæ’ä»¶ï¼Œä¾‹å¦‚è°ƒè¯•å™¨ã€æ—¥å¿—æŸ¥çœ‹å™¨ã€æ•°æ®åº“ç®¡ç†å™¨ç­‰ã€‚
+ `nocalhost` è¿˜æä¾›äº†å®Œæ•´çš„æ–‡æ¡£å’Œæ•™ç¨‹ï¼Œä»¥ä¾¿äºå¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ã€‚



## main å…¥å£

ä» main.go å‡½æ•°å¼€å§‹é˜…è¯»ï¼š

```go
func main() {
	cmd.Run(cmd.ParseFlags())
}
```

ä» Run å‡½æ•°å¼€å§‹å®ç°é€»è¾‘ï¼š

```go
// Run runs the agent.
func Run(flags *Flags) {
	ctx, cancelFunc := context.WithCancel(context.Background())
	setTasksBeforeExit(cancelFunc)
	configs, err := LoadConfig(flags)
	if err != nil {
		panic(err)
	}
	// enable pprof
	runPProfServer(&configs.PProf)
	// init api
	Init(ctx, flags, configs)
}
```

Run å‡½æ•°å®ç°çš„é€»è¾‘å¾ˆç®€å•ï¼š

+ æ¥å—ä¸€ä¸ª `flags` å‚æ•°ï¼Œå®ƒåŒ…å«äº†ä»£ç†è¿è¡Œçš„ä¸€äº›é…ç½®ä¿¡æ¯ã€‚
+ åˆ›å»ºäº†ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆ`ctx`ï¼‰å’Œä¸€ä¸ªå–æ¶ˆå‡½æ•°ï¼ˆ`cancelFunc`ï¼‰ã€‚è¿™äº›å˜é‡ç”¨äºåœ¨ä»£ç†è¿è¡Œè¿‡ç¨‹ä¸­æ§åˆ¶ç¨‹åºçš„è¡Œä¸ºã€‚
+ è°ƒç”¨äº† `LoadConfig` å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºåŠ è½½ä»£ç†çš„é…ç½®ä¿¡æ¯ã€‚å¦‚æœä»£ç†é…ç½®ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚
+ è°ƒç”¨äº† `runPProfServer` å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºå¯åŠ¨ `pprof` æœåŠ¡å™¨ï¼Œä»¥ä¾¿äºè¿›è¡Œæ€§èƒ½è°ƒè¯•å’Œä¼˜åŒ–ã€‚
+ æœ€åï¼Œ`Run` å‡½æ•°è°ƒç”¨äº† `Init` å‡½æ•°ï¼Œè¯¥å‡½æ•°ç”¨äºåˆå§‹åŒ–ä»£ç†å¹¶å¯åŠ¨ API æœåŠ¡ã€‚



æŸ¥çœ‹ `Init()` å‡½æ•°çš„å®ç°é€»è¾‘ï¼š

> åˆå§‹åŒ–é€»è¾‘æœ‰äº›å¤æ‚ï¼Œå®ç°çš„éƒ¨åˆ†åº”è¯¥å°½å¯èƒ½çš„æ”¾åœ¨ `pkg` æˆ–è€… `internal` ç›®å½•ä¸‹é¢ã€‚

å¤§è‡´çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. åˆå§‹åŒ–ç¾¤ç»„æœåŠ¡ã€ç®¡ç†å™¨
2. åˆå§‹åŒ–é›†ç¾¤æœåŠ¡ã€ç”¨æˆ·æœåŠ¡ã€ä»¤ç‰ŒæœåŠ¡ã€Grafana æœåŠ¡ç­‰
3. åˆ›å»ºä¸€ä¸ªå‚æ•°å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«äº†æ‰€æœ‰æœåŠ¡å’ŒæœåŠ¡æ‰€éœ€çš„å‚æ•°
4. åˆå§‹åŒ–æ§åˆ¶å™¨ï¼Œä¾‹å¦‚æˆå‘˜æ§åˆ¶å™¨ã€åº”ç”¨ç¨‹åºæ§åˆ¶å™¨ã€ç¯å¢ƒæ¨¡æ¿æ§åˆ¶å™¨ç­‰
5. åˆå§‹åŒ– APIï¼ŒåŒ…æ‹¬ v1 API å’Œ v2 APIï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°è·¯ç”±ä¸­
6. å¯åŠ¨äº‘äº‹ä»¶æœåŠ¡å™¨ï¼Œä»¥ä¾¿åœ¨äº‘ä¸­å¤„ç†äº‹ä»¶
7. å¯åŠ¨ API æœåŠ¡å™¨å¹¶ç›‘å¬ç«¯å£



ä½¿ç”¨ gorm ä½œä¸ºå›è°ƒå‡½æ•°ï¼š

```go
func RegisterCustomCallbacks(db *gorm.DB) {
	_ = db.Callback().Create().After("gorm:before_create").Before("gorm:create").
		Register("add_created_by", addCreatedByUpdatedByForCreateCallback)

	_ = db.Callback().Update().After("gorm:before_update").Before("gorm:update").
		Register("add_updated_by", addUpdatedByForUpdateDeleteCallback)

	_ = db.Callback().Delete().After("gorm:before_delete").Before("gorm:delete").
		Register("add_updated_by", addUpdatedByForUpdateDeleteCallback)
}
```

ä¸»è¦æ˜¯åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œå‰åæ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„é€»è¾‘ã€‚å®ƒåŒ…å«äº†ä¸‰ä¸ªå›è°ƒå‡½æ•°ï¼š`Create`ã€`Update` å’Œ `Delete`ã€‚æ¯ä¸ªå›è°ƒå‡½æ•°éƒ½åœ¨ GORM çš„æŸä¸ªæ“ä½œä¹‹å‰æˆ–ä¹‹åè¢«è°ƒç”¨ï¼Œå¹¶åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„é€»è¾‘ã€‚ä¾‹å¦‚ï¼Œå›è°ƒå‡½æ•° "add_created_by" å’Œ "add_updated_by" ç”¨äºåœ¨åˆ›å»ºæˆ–æ›´æ–°æ•°æ®æ—¶æ·»åŠ ä¸€ä¸ª "created_by" æˆ– "updated_by" å­—æ®µï¼Œç”¨äºè®°å½•æ•°æ®çš„åˆ›å»ºæˆ–æ›´æ–°è€…ã€‚å…¶ä¸­ï¼Œ`addCreatedByUpdatedByForCreateCallback` å’Œ `addUpdatedByForUpdateDeleteCallback` æ˜¯ä¸¤ä¸ªè‡ªå®šä¹‰å‡½æ•°ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äºåˆ›å»ºå’Œæ›´æ–°/åˆ é™¤æ“ä½œä¸­çš„å›è°ƒé€»è¾‘ã€‚è¯¥å‡½æ•°è¿˜åŒ…æ‹¬äº†ä¸€äº› GORM çš„å›è°ƒæ³¨å†Œé€»è¾‘ï¼Œç”¨äºå°†è‡ªå®šä¹‰çš„å›è°ƒå‡½æ•°æ³¨å†Œåˆ° GORM ä¸­ï¼Œä»¥ä¾¿åœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œæ—¶è‡ªåŠ¨è°ƒç”¨è¿™äº›å›è°ƒå‡½æ•°ã€‚



## dao

å’Œ Java çš„é£æ ¼ç±»ä¼¼ï¼Œ horizon ä¸­æœ‰å¾ˆå¤šéƒ½æ˜¯ dao ç›®å½•ï¼Œdaoç›®å½•æ˜¯ä¸€ç§å¸¸è§çš„å‘½åè§„èŒƒï¼Œä»£è¡¨æ•°æ®è®¿é—®å¯¹è±¡ï¼ˆData Access Objectï¼‰ã€‚å®ƒé€šå¸¸ç”¨äºå­˜å‚¨ä¸æ•°æ®åº“äº¤äº’çš„ä»£ç å’Œç›¸å…³é€»è¾‘ã€‚DAOæ¨¡å¼åˆ†ç¦»äº†ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®é€»è¾‘ï¼Œä½¿å¾—ä»£ç æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

åœ¨ horizon ä¸­ï¼Œdaoç›®å½•é€šå¸¸åŒ…å«ä¸€äº›æ–‡ä»¶ï¼Œå¦‚dao.goç­‰ï¼Œå…¶ä¸­åŒ…å«ä¸æ•°æ®åº“äº¤äº’çš„æ–¹æ³•å’Œå‡½æ•°ã€‚è¿™äº›æ–¹æ³•å’Œå‡½æ•°å¯ä»¥åœ¨å…¶ä»–ä»£ç ä¸­è¢«å¼•ç”¨ï¼Œç”¨äºæ•°æ®çš„è¯»å–ã€å†™å…¥å’Œæ›´æ–°ç­‰æ“ä½œã€‚

è¿™æ ·å¯ä»¥ä¿æŒä»£ç çš„æ¸…æ™°ï¼Œé€»è¾‘æ˜ç¡®ã€‚

dao çš„è®¾è®¡å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä»¥å…¶ä¸­çš„ `registry` ç›®å½•ä¸ºä¾‹ï¼š

åŒ…å«äº†æ¥å£ä½œä¸ºæŠ½è±¡å±‚ï¼Œä¾›å¤–éƒ¨è°ƒç”¨ï¼š

```go
type DAO interface {
	// Create a registry
	Create(ctx context.Context, registry *models.Registry) (uint, error)
	// UpdateByID update a registry
	UpdateByID(ctx context.Context, id uint, registry *models.Registry) error
	// DeleteByID delete a registry by id
	DeleteByID(ctx context.Context, id uint) error
	// GetByID get by id
	GetByID(ctx context.Context, id uint) (*models.Registry, error)
	// ListAll list all registries
	ListAll(ctx context.Context) ([]*models.Registry, error)
}
```

DAO æ¥å£ä¸­çš„ `Create`ã€`UpdateByID`ã€`DeleteByID`ã€`GetByID` å’Œ ListAll æ–¹æ³•éƒ½æ˜¯å¯¹ registry è¡¨è¿›è¡Œäº†ä¸åŒçš„æ“ä½œã€‚Create æ–¹æ³•æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ registryï¼ŒUpdateByID æ–¹æ³•æ˜¯ç”¨æ¥æ›´æ–° registry è¡¨ä¸­æŒ‡å®š ID çš„è®°å½•ï¼ŒDeleteByID æ–¹æ³•æ˜¯ç”¨æ¥åˆ é™¤ registry è¡¨ä¸­æŒ‡å®š ID çš„è®°å½•ï¼ŒGetByID æ–¹æ³•æ˜¯ç”¨æ¥è·å– registry è¡¨ä¸­æŒ‡å®š ID çš„è®°å½•ï¼Œè€Œ ListAll æ–¹æ³•æ˜¯ç”¨æ¥è·å– registry è¡¨ä¸­æ‰€æœ‰è®°å½•çš„åˆ—è¡¨ã€‚

DAO æ¥å£å®šä¹‰äº†å¯¹ registry è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè€Œ dao ç»“æ„ä½“å®ç°äº†è¿™äº›æ¥å£ã€‚å®ƒéƒ½ä½¿ç”¨äº† GORM åº“æ¥æ“ä½œæ•°æ®åº“:

```go
type dao struct{ db *gorm.DB }
// NewDAO returns an instance of the default DAO
func NewDAO(db *gorm.DB) DAO {
	return &dao{db: db}
}
```

è¿˜æœ‰ä¸€ä¸ª `NewDAO` å‡½æ•°ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå› ä¸º DAO å°†æ•°æ®å±‚é¢å’Œä¸šåŠ¡å±‚é¢å‰¥å¼€äº†ã€‚

éœ€è¦ `NewDAO` å‡½æ•°çš„åŸå› æ˜¯å› ä¸º DAO æ¥å£å’Œ dao ç»“æ„ä½“æ˜¯åˆ†ç¦»çš„ã€‚DAO æ¥å£åªå®šä¹‰äº†å¯¹ `registry` è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè€Œ dao ç»“æ„ä½“å®ç°äº†è¿™äº›æ“ä½œã€‚ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ DAO æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥åˆ›å»º dao ç»“æ„ä½“çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å¯ä»¥è¢«ç”¨æ¥è°ƒç”¨ DAO æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚

åœ¨ GORM ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ¥è¿›è¡Œæ“ä½œã€‚å› æ­¤ï¼ŒNewDAO å‡½æ•°éœ€è¦ä¸€ä¸ª GORM æ•°æ®åº“è¿æ¥ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªæ•°æ®åº“è¿æ¥å¯ä»¥é€šè¿‡ GORM åº“çš„ Open å‡½æ•°æ¥åˆ›å»ºï¼Œç„¶åå†ä¼ é€’ç»™ NewDAO å‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥åˆ›å»ºä¸€ä¸ª dao ç»“æ„ä½“çš„å®ä¾‹ï¼Œç”¨æ¥å¯¹æ•°æ®åº“ä¸­çš„ registry è¡¨è¿›è¡Œ `CURD` æ“ä½œäº†ã€‚



## manager

æˆ‘ä¸€ç›´å¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰äº† `dao` è¿˜éœ€è¦ `manager` ï¼Œ è¿™é‡Œä½¿ç”¨äº† DAO è®¾è®¡æ¨¡å¼å’Œä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰è®¾è®¡æ¨¡å¼ã€‚

```go
package manager

import (
	"context"

	"github.com/horizoncd/horizon/pkg/registry/dao"
	"github.com/horizoncd/horizon/pkg/registry/models"
	"gorm.io/gorm"
)

type Manager interface {
	// Create a registry
	Create(ctx context.Context, registry *models.Registry) (uint, error)
	// UpdateByID update a registry
	UpdateByID(ctx context.Context, id uint, registry *models.Registry) error
	// DeleteByID delete a registry by id
	DeleteByID(ctx context.Context, id uint) error
	// GetByID get by id
	GetByID(ctx context.Context, id uint) (*models.Registry, error)
	// ListAll list all registries
	ListAll(ctx context.Context) ([]*models.Registry, error)
}

type manager struct {
	registryDAO dao.DAO
}

func New(db *gorm.DB) Manager {
	return &manager{
		registryDAO: dao.NewDAO(db),
	}
}

func (m manager) Create(ctx context.Context, registry *models.Registry) (uint, error) {
	return m.registryDAO.Create(ctx, registry)
}

func (m manager) GetByID(ctx context.Context, id uint) (*models.Registry, error) {
	return m.registryDAO.GetByID(ctx, id)
}

func (m manager) ListAll(ctx context.Context) ([]*models.Registry, error) {
	return m.registryDAO.ListAll(ctx)
}

func (m manager) UpdateByID(ctx context.Context, id uint, registry *models.Registry) error {
	return m.registryDAO.UpdateByID(ctx, id, registry)
}

func (m manager) DeleteByID(ctx context.Context, id uint) error {
	return m.registryDAO.DeleteByID(ctx, id)
}
```

manager ç›®å½•å®ç°äº† Manager æ¥å£ã€‚Manager æ¥å£æ˜¯å¯¹ `DAO` æ¥å£çš„è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚å®ƒå®šä¹‰äº†å¯¹ registry è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯é€šè¿‡ DAO æ¥å£æ¥å®ç°çš„ã€‚

å®ƒå¯¹ DAO æ¥å£è¿›è¡Œäº†è¿›ä¸€æ­¥çš„å°è£…ï¼Œæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚è¿™æ ·å°±å¯ä»¥å°† DAO æ¥å£ä¸å…·ä½“çš„å®ç°åˆ†ç¦»ï¼Œä½¿ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚ã€‚

å½“ç„¶ï¼Œåœ¨è¿™é‡Œ horizon å®ç°çš„åŠŸèƒ½å°±æ˜¯è¿™ä¹ˆä¸€äº›ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜å¯ä»¥å¯¹ DAO æ¥å£ä¸­çš„æ–¹æ³•è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œä¾‹å¦‚è¿›è¡Œé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ã€‚è¿™æ ·å°±å¯ä»¥æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯è¯»æ€§ã€‚



## models

models åŒ…å®šä¹‰äº†ä¸ registry è¡¨ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚å®ƒåŒ…å«äº†ä¸€ä¸ªåä¸º Registry çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤º registry è¡¨ä¸­çš„ä¸€æ¡è®°å½•ã€‚

```go
package models

import (
	"github.com/horizoncd/horizon/pkg/server/global"
)

type Registry struct {
	global.Model

	Name   string
	Server string
	Path   string
	Token  string
	// for delete
	InsecureSkipTLSVerify bool `gorm:"column:insecure_skip_tls_verify"`
	Kind                  string
}
```

`Registry` ç»“æ„ä½“çš„å­—æ®µä¸ `registry` è¡¨ä¸­çš„å­—æ®µä¸€ä¸€å¯¹åº”ã€‚å®ƒåŒ…å«äº† IDã€Nameã€Serverã€Pathã€Tokenã€InsecureSkipTLSVerify å’Œ Kind ä¸ƒä¸ªå­—æ®µã€‚

+ IDï¼šregistry è®°å½•çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
+ CreatedAtï¼šregistry è®°å½•çš„åˆ›å»ºæ—¶é—´ã€‚
+ UpdatedAtï¼šregistry è®°å½•çš„æ›´æ–°æ—¶é—´ã€‚
+ DeletedAtï¼šregistry è®°å½•çš„åˆ é™¤æ—¶é—´ã€‚
+ Nameï¼šregistry çš„åç§°ã€‚
+ Serverï¼šregistry çš„æœåŠ¡å™¨åœ°å€ã€‚
+ Pathï¼šregistry çš„åœ°å€è·¯å¾„ã€‚
+ Tokenï¼šregistry çš„è®¿é—®ä»¤ç‰Œã€‚
+ InsecureSkipTLSVerifyï¼šæ˜¯å¦å¿½ç•¥ TLS éªŒè¯ã€‚
+ Kindï¼šregistry çš„ç±»å‹ã€‚

Registry ç»“æ„ä½“è¿˜å®šä¹‰äº† TableName æ–¹æ³•ï¼Œç”¨æ¥æŒ‡å®šè¯¥ç»“æ„ä½“å¯¹åº”çš„è¡¨åã€‚

Registry ç»“æ„ä½“ä¸­çš„è¿™äº›å­—æ®µéƒ½æ˜¯é€šè¿‡ GORM åº“çš„ tags æ¥æ˜ å°„åˆ°æ•°æ®åº“ä¸­çš„è¡¨å’Œåˆ—çš„ã€‚ä¾‹å¦‚ï¼ŒID å­—æ®µæ˜ å°„åˆ°äº† registry è¡¨ä¸­çš„ id åˆ—ï¼ŒName å­—æ®µæ˜ å°„åˆ°äº† registry è¡¨ä¸­çš„ name åˆ—ã€‚

è¯¥ models åŒ…çš„ä½œç”¨æ˜¯å®šä¹‰äº†ä¸ registry è¡¨ç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œç”¨äºåœ¨ DAO å’Œ manager ä¸­è¿›è¡Œæ•°æ®çš„ä¼ é€’å’Œæ“ä½œã€‚



## è®¾è®¡æ€æƒ³

å’Œ registry ç›®å½•ç±»ä¼¼ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ user ç›®å½•åˆ†æï¼š

```go
â¯ tree user
user
â”œâ”€â”€ dao
â”‚   â””â”€â”€ dao.go
â”œâ”€â”€ manager
â”‚   â”œâ”€â”€ manager.go
â”‚   â””â”€â”€ manager_test.go
â”œâ”€â”€ models
â”‚   â””â”€â”€ user.go
â”œâ”€â”€ service
â”‚   â”œâ”€â”€ service.go
â”‚   â””â”€â”€ service_test.go
â””â”€â”€ util
    â””â”€â”€ session.go
```

### dao

dao ç›®å½•ä¸­åŒ…å«äº†ä¸ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„æ•°æ®è®¿é—®å¯¹è±¡ï¼ˆData Access Objectï¼‰ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª DAO æ¥å£ï¼Œç”¨äºå¯¹ user è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚dao ç›®å½•çš„ä¸»è¦ä½œç”¨æ˜¯å°è£…äº†å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®é€»è¾‘åˆ†ç¦»å¼€æ¥ã€‚

### manager

manager ç›®å½•ä¸­åŒ…å«äº†ä¸ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª Manager æ¥å£ï¼Œç”¨äºå¯¹ user è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚manager ç›®å½•çš„ä¸»è¦ä½œç”¨æ˜¯å°† DAO æ¥å£è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚

### models

models ç›®å½•ä¸­å®šä¹‰äº†ä¸ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚å®ƒåŒ…å«äº†ä¸€ä¸ªåä¸º User çš„ç»“æ„ä½“ï¼Œç”¨æ¥è¡¨ç¤º user è¡¨ä¸­çš„ä¸€æ¡è®°å½•ã€‚User ç»“æ„ä½“çš„å­—æ®µä¸ user è¡¨ä¸­çš„å­—æ®µä¸€ä¸€å¯¹åº”ã€‚å®ƒè¿˜å®šä¹‰äº† TableName æ–¹æ³•ï¼Œç”¨æ¥æŒ‡å®šè¯¥ç»“æ„ä½“å¯¹åº”çš„è¡¨åã€‚

### service

```go
type Service interface {
	// CheckUsersExists check users all exists, if true, return nil
	CheckUsersExists(ctx context.Context, emails []string) error
}

type service struct {
	userManager usermanager.Manager
}
```

service ç›®å½•ä¸­åŒ…å«äº†ä¸ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„æœåŠ¡ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª Service æ¥å£ï¼Œç”¨äºå¯¹ user è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œã€‚service ç›®å½•çš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸šåŠ¡é€»è¾‘(manager) è¿›ä¸€æ­¥å°è£…ï¼Œæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚



### util

util ç›®å½•ä¸­åŒ…å«äº†ä¸ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„å·¥å…·å‡½æ•°ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªåä¸º Session çš„ç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤ºç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚Session ç»“æ„ä½“çš„å­—æ®µåŒ…æ‹¬äº†ç”¨æˆ·çš„ IDã€ç™»å½•æ—¶é—´å’Œè¿‡æœŸæ—¶é—´ç­‰ä¿¡æ¯ã€‚å®ƒè¿˜åŒ…å«äº†ä¸€äº›æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆå’ŒéªŒè¯ä¼šè¯ä¿¡æ¯ã€‚util ç›®å½•çš„ä¸»è¦ä½œç”¨æ˜¯å°è£…äº†ä¸ä¼šè¯ç›¸å…³çš„æ“ä½œã€‚



**è®¾è®¡æ¨¡å¼çš„è®¾è®¡æ€è·¯å’Œæ–¹æ³•**ï¼š

DAO è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§ç”¨äºå°†æ•°æ®è®¿é—®é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»çš„è®¾è®¡æ¨¡å¼ã€‚å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯å°†æ•°æ®è®¿é—®é€»è¾‘å°è£…åˆ°ä¸€ä¸ªå•ç‹¬çš„ç±»æˆ–æ¥å£ä¸­ï¼Œå¹¶ç”±ä¸€ä¸ªæˆ–å¤šä¸ªä¸šåŠ¡é€»è¾‘ç»„ä»¶ä½¿ç”¨å®ƒã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œdao åŒ…å®šä¹‰äº† DAO æ¥å£å’Œ dao ç»“æ„ä½“ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨äºå®šä¹‰å’Œå®ç°å¯¹ registry è¡¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚Manager æ¥å£å’Œ manager ç»“æ„ä½“æ˜¯ DAO æ¥å£çš„é«˜å±‚æ¬¡å°è£…ï¼Œå®ƒä»¬è¿›ä¸€æ­¥å°†æ•°æ®è®¿é—®é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»å¼€æ¥ã€‚è¿™æ ·å°±å¯ä»¥ä½¿ä»£ç æ›´åŠ æ¸…æ™°æ˜“æ‡‚ï¼Œå¹¶ä¸”æ–¹ä¾¿ç»´æŠ¤å’Œæ‰©å±•ã€‚

ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§ç”¨äºè§£è€¦ç»„ä»¶ä¹‹é—´ä¾èµ–å…³ç³»çš„è®¾è®¡æ¨¡å¼ã€‚å®ƒçš„ä¸»è¦æ€æƒ³æ˜¯å°†ä¸€ä¸ªç»„ä»¶æ‰€ä¾èµ–çš„å…¶ä»–ç»„ä»¶é€šè¿‡æ„é€ å‡½æ•°ã€æ–¹æ³•å‚æ•°æˆ–å±æ€§æ³¨å…¥çš„æ–¹å¼æ¥å®ç°ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼ŒNewDAO å‡½æ•°ä½¿ç”¨äº† GORM æ•°æ®åº“è¿æ¥ä½œä¸ºå‚æ•°ï¼Œç„¶åå°†è¿™ä¸ªå‚æ•°ä¼ é€’ç»™ dao.NewDAO å‡½æ•°æ¥åˆ›å»º dao ç»“æ„ä½“çš„å®ä¾‹ã€‚è¿™æ ·å°±å¯ä»¥å°†æ•°æ®åº“è¿æ¥ä¸ dao ç»“æ„ä½“è§£è€¦å¼€æ¥ï¼Œä½¿ä»£ç æ›´åŠ çµæ´»å’Œå¯æ‰©å±•ã€‚



## rbac ç›®å½•

ä½œä¸ºä¸€ä¸ªè®¿é—®æ§åˆ¶é¢—ç²’åº¦ä»…ä»…æ¬¡äº  ABAC çš„ RBACï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„æºç ï¼š

ç›®å½•ç»“æ„ï¼š

```bash
â”œâ”€â”€ rbac
â”‚   â”œâ”€â”€ auth.go
â”‚   â”œâ”€â”€ auth_test.go
â”‚   â”œâ”€â”€ role
â”‚   â”‚   â”œâ”€â”€ roles.go
â”‚   â”‚   â””â”€â”€ roles_test.go
â”‚   â””â”€â”€ types
â”‚       â”œâ”€â”€ eveluation_helpers.go
â”‚       â”œâ”€â”€ types.go
â”‚       â””â”€â”€ types_test.go
```

ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

## roles

```go
type CompResult uint8

const (
	RoleEqual CompResult = iota
	RoleBigger
	RoleSmaller
	RoleCanNotCompare
)

const (
	PE         string = "pe"
	Owner      string = "owner"
	Maintainer string = "maintainer"
	Guest      string = "guest"
)

var (
	ErrorRoleNotFound   = errors.New("role not found")
	ErrorLoadCheckError = errors.New("load check error")
)

type Service interface {
	// ListRole Lists all the role
	ListRole(ctx context.Context) ([]types.Role, error)
	// GetRole get role by the role name
	GetRole(ctx context.Context, roleName string) (*types.Role, error)
	// RoleCompare compare if the role1's permission is higher than role2
	RoleCompare(ctx context.Context, role1, role2 string) (CompResult, error)
	// GetDefaultRole return the default role(no default role will return nil)
	GetDefaultRole(ctx context.Context) *types.Role
}

type roleRankMapItem struct {
	rank int
	role types.Role
}
type fileRoleService struct {
	RolePriorityRankDesc []string
	DefaultRoleName      string
	Roles                []types.Role
	DefaultRole          *types.Role
	roleRankMap          map[string]roleRankMapItem
}
```

### roles

`roles.go` æ–‡ä»¶å®šä¹‰äº† `Service` æ¥å£åŠå…¶é»˜è®¤å®ç° `fileRoleService`ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäºæ–‡ä»¶çš„è§’è‰²æœåŠ¡ï¼Œå®ƒä» JSON æ–‡ä»¶ä¸­è¯»å–è§’è‰²ä¿¡æ¯ã€‚

`Service` æ¥å£å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•ï¼š

+ `ListRole`ï¼šåˆ—å‡ºæ‰€æœ‰è§’è‰²ã€‚
+ `GetRole`ï¼šæ ¹æ®è§’è‰²åç§°è·å–è§’è‰²ä¿¡æ¯ã€‚
+ `RoleCompare`ï¼šæ¯”è¾ƒä¸¤ä¸ªè§’è‰²çš„ä¼˜å…ˆçº§ã€‚
+ `GetDefaultRole`ï¼šè·å–é»˜è®¤è§’è‰²ã€‚

`fileRoleService` ç»“æ„ä½“å®ç°äº† `Service` æ¥å£ ~

+ `RolePriorityRankDesc`ï¼šè¡¨ç¤ºè§’è‰²ä¼˜å…ˆçº§çš„å­—ç¬¦ä¸²åˆ‡ç‰‡ã€‚
+ `DefaultRoleName`ï¼šè¡¨ç¤ºé»˜è®¤è§’è‰²çš„åç§°ã€‚
+ `Roles`ï¼šè¡¨ç¤ºæ‰€æœ‰è§’è‰²çš„ `[]Role` ç±»å‹çš„åˆ‡ç‰‡ã€‚
+ `DefaultRole`ï¼šè¡¨ç¤ºé»˜è®¤è§’è‰²çš„ `Role` ç±»å‹ã€‚

è¿™ä¸ªç»“æ„ä½“è¿˜åŒ…å«ä¸€ä¸ªç§æœ‰å­—æ®µ `roleRankMap`ï¼Œç”¨äºç¼“å­˜è§’è‰²çš„ä¼˜å…ˆçº§ä¿¡æ¯ã€‚

`Roles` å­—æ®µä¸­å­˜å‚¨äº†æ‰€æœ‰è§’è‰²çš„ä¿¡æ¯ï¼Œæ¯ä¸ªè§’è‰²éƒ½æ˜¯ä¸€ä¸ª `Role` ç»“æ„ä½“ï¼ŒåŒ…å«è§’è‰²åç§°ã€æè¿°å’Œæƒé™è§„åˆ™ã€‚å…¶ä¸­ `PolicyRules` å­—æ®µæ˜¯ä¸€ä¸ª `[]PolicyRule` ç±»å‹çš„åˆ‡ç‰‡ï¼Œè¡¨ç¤ºè¯¥è§’è‰²çš„æ‰€æœ‰æƒé™è§„åˆ™ã€‚

`GetRole` æ–¹æ³•æ ¹æ®è§’è‰²åç§°è·å–è§’è‰²ä¿¡æ¯ã€‚å¦‚æœæŒ‡å®šåç§°çš„è§’è‰²ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ `ErrorRoleNotFound`ã€‚

`RoleCompare` æ–¹æ³•æ¯”è¾ƒä¸¤ä¸ªè§’è‰²çš„ä¼˜å…ˆçº§ã€‚å¦‚æœè§’è‰² `role1` çš„æƒé™ä¼˜å…ˆçº§é«˜äº `role2`ï¼Œåˆ™è¿”å›ç»“æœ `RoleBigger`ï¼›å¦‚æœ `role1` çš„æƒé™ä¼˜å…ˆçº§ä½äº `role2`ï¼Œåˆ™è¿”å›ç»“æœ `RoleSmaller`ã€‚å¦‚æœä¸¤ä¸ªè§’è‰²çš„æƒé™ä¼˜å…ˆçº§ç›¸ç­‰ï¼Œåˆ™è¿”å›ç»“æœ `RoleEqual`ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªè§’è‰²ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ `ErrorRoleNotFound`ã€‚

`GetDefaultRole` æ–¹æ³•è¿”å›é»˜è®¤è§’è‰²ã€‚å¦‚æœæ²¡æœ‰é»˜è®¤è§’è‰²ï¼Œåˆ™è¿”å› `nil`ã€‚



###  auth

```go
// Authorizer use the basic rbac rules to check if the user
// have the permissions
type Authorizer interface {
	Authorize(ctx context.Context, attributes auth.Attributes) (auth.Decision, string, error)
}

type VisitorFunc func(fmt.Stringer, *types.PolicyRule, error) bool

func NewAuthorizer(roleservice role.Service, memberservice memberservice.Service) Authorizer {
	return &authorizer{
		roleService:   roleservice,
		memberService: memberservice,
	}
}

type authorizer struct {
	roleService   role.Service
	memberService memberservice.Service
}

const (
	NotChecked        = "not checked"
	ResourceFormatErr = "format error"
	AnonymousUser     = "anonymous user"
	InternalError     = "internal error"
	MemberNotExist    = "member not exist"
	RoleNotExist      = "role not exist"
	AdminAllow        = "admin allows everything"
)
```

`auth` åŒ…å®šä¹‰äº†ç”¨äºèº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶çš„ä»£ç ã€‚åœ¨è¿™ä¸ªåŒ…ä¸­ï¼Œ`auth.go` æ–‡ä»¶å®šä¹‰äº† `Authorizer` æ¥å£åŠå…¶é»˜è®¤å®ç° `authorizer`ï¼Œç”¨äºæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™ã€‚

**`Authorizer` æ¥å£ï¼š**

`Authorizer` æ¥å£å®šä¹‰äº†ä¸€ä¸ª `Authorize` æ–¹æ³•ï¼Œç”¨äºæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª `auth.Attributes` ç±»å‹çš„å‚æ•°ï¼Œè¯¥å‚æ•°åŒ…å«ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åã€è§’è‰²ç­‰ï¼‰ä»¥åŠèµ„æºä¿¡æ¯ï¼ˆå¦‚èµ„æºåç§°ã€æ“ä½œæ–¹å¼ç­‰ï¼‰ã€‚è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª `auth.Decision` ç±»å‹çš„å†³ç­–ç»“æœã€ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„æ¶ˆæ¯ä»¥åŠä¸€ä¸ª `error` ç±»å‹çš„é”™è¯¯ã€‚å…¶ä¸­ `auth.Decision` ç±»å‹è¡¨ç¤ºå†³ç­–çš„ç»“æœï¼Œå¯ä»¥æ˜¯ `auth.Allow`ã€`auth.Deny` æˆ– `auth.Abstain`ã€‚



**`authorizer` ç»“æ„ä½“ï¼š**

`authorizer` ç»“æ„ä½“å®ç°äº† `Authorizer` æ¥å£ï¼Œå®ƒçš„å­—æ®µåŒ…æ‹¬ `roleService` å’Œ `memberService`ã€‚å…¶ä¸­ `roleService` æ˜¯ä¸€ä¸ª `role.Service` ç±»å‹çš„æ¥å£ï¼Œç”¨äºè·å–è§’è‰²ä¿¡æ¯ï¼Œ`memberService` æ˜¯ä¸€ä¸ª `memberservice.Service` ç±»å‹çš„æ¥å£ï¼Œç”¨äºè·å–ç”¨æˆ·ä¿¡æ¯ã€‚

`authorizer` ç»“æ„ä½“è¿˜åŒ…å«ä¸€äº›å¸¸é‡ï¼Œå¦‚ `NotChecked`ã€`ResourceFormatErr`ã€`AnonymousUser`ã€`InternalError`ã€`MemberNotExist` å’Œ `RoleNotExist`ï¼Œåˆ†åˆ«è¡¨ç¤ºæœªæ£€æŸ¥ã€èµ„æºæ ¼å¼é”™è¯¯ã€åŒ¿åç”¨æˆ·ã€å†…éƒ¨é”™è¯¯ã€ç”¨æˆ·ä¸å­˜åœ¨å’Œè§’è‰²ä¸å­˜åœ¨ã€‚

`authorizer` ç»“æ„ä½“å®ç°äº† `Authorize` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é¦–å…ˆæ£€æŸ¥èµ„æºæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œç„¶åè·å–ç”¨æˆ·å’Œè§’è‰²ä¿¡æ¯ï¼Œæœ€åæ ¹æ®è§’è‰²å’Œæƒé™è§„åˆ™åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·æœ‰æ“ä½œèµ„æºçš„æƒé™ã€‚



### `types` åŒ…è¯¦è§£

`types` åŒ…å®šä¹‰äº†ä¸è§’è‰²å’Œæƒé™ç›¸å…³çš„æ•°æ®ç±»å‹ã€‚åœ¨è¿™ä¸ªåŒ…ä¸­ï¼Œ`types.go` æ–‡ä»¶å®šä¹‰äº† `Role` å’Œ `PolicyRule` ç»“æ„ä½“ã€‚



**`Role` ç»“æ„ä½“ï¼š**

`Role` ç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªè§’è‰²ï¼ŒåŒ…å«è§’è‰²çš„åç§°ã€æè¿°å’Œæƒé™è§„åˆ™ã€‚å®šä¹‰å¦‚ä¸‹ï¼š

```go
type Role struct {
    Name        string       `yaml:"name" json:"name"`
    Desc        string       `yaml:"desc" json:"desc"`
    PolicyRules []PolicyRule `yaml:"rules" json:"rules"`
}
```

å…¶ä¸­ `Name` å­—æ®µè¡¨ç¤ºè§’è‰²åç§°ï¼Œ`Desc` å­—æ®µè¡¨ç¤ºè§’è‰²æè¿°ï¼Œ`PolicyRules` å­—æ®µæ˜¯ä¸€ä¸ª `[]PolicyRule` ç±»å‹çš„åˆ‡ç‰‡ï¼Œè¡¨ç¤ºè¯¥è§’è‰²çš„æ‰€æœ‰æƒé™è§„åˆ™ã€‚

**`PolicyRule` ç»“æ„ä½“ï¼š**

`PolicyRule` ç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªæƒé™è§„åˆ™ï¼ŒåŒ…å«æƒé™çš„è®¿é—®æ–¹å¼ã€èµ„æºã€æ“ä½œèŒƒå›´ç­‰ä¿¡æ¯ã€‚å®šä¹‰å¦‚ä¸‹ï¼š

```go
type PolicyRule struct {
    Verbs           []string `yaml:"verbs" json:"verbs"`
    APIGroups       []string `yaml:"apiGroups" json:"apiGroups"`
    Resources       []string `yaml:"resources" json:"resources"`
    Scopes          []string `yaml:"scopes" json:"scopes"`
    NonResourceURLs []string `yaml:"nonResourceURLs" json:"nonResourceURLs"`
}
```

å…¶ä¸­ `Verbs` å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºæƒé™çš„è®¿é—®æ–¹å¼ï¼ˆä¾‹å¦‚ getã€listã€createã€update ç­‰ï¼‰ï¼Œ`APIGroups` å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºèµ„æºæ‰€å±çš„ API ç»„ï¼Œ`Resources` å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºèµ„æºåç§°ï¼Œ`Scopes` å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºæ“ä½œçš„èŒƒå›´ï¼ˆä¾‹å¦‚ namespace ç­‰ï¼‰ï¼Œ`NonResourceURLs` å­—æ®µæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œè¡¨ç¤ºéèµ„æº URLã€‚

åœ¨ `types.go` æ–‡ä»¶ä¸­è¿˜å®šä¹‰äº†ä¸€äº›å¸¸é‡ï¼š

```go
const (
    APIGroupAll    = "*"
    ResourceAll    = "*"
    VerbAll        = "*"
    ScopeAll       = "*"
    NonResourceAll = "*"
)
```

å…¶ä¸­ `APIGroupAll`ã€`ResourceAll`ã€`VerbAll`ã€`ScopeAll`ã€`NonResourceAll` åˆ†åˆ«è¡¨ç¤ºæ‰€æœ‰ API ç»„ã€æ‰€æœ‰èµ„æºã€æ‰€æœ‰è®¿é—®æ–¹å¼ã€æ‰€æœ‰æ“ä½œèŒƒå›´ã€æ‰€æœ‰éèµ„æº URLã€‚



## END é“¾æ¥

<ul><li><div><a href = '40.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '42.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
