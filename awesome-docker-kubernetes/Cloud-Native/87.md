+ [author](http://nsddd.top)

# ç¬¬87èŠ‚ OpenIM wasm ä»»åŠ¡

<div><a href = '86.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '88.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

**å‰æçŸ¥è¯†ï¼š**

1. Golang çš„åŸºæœ¬è¯­æ³•å’Œå¸¸ç”¨åº“çš„ä½¿ç”¨ï¼›
2. WebAssembly çš„åŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨æ–¹æ³•ï¼›
3. ç´¢å¼•æ•°æ®åº“çš„åŸºæœ¬åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚

## wasm å­¦ä¹ 

ä¸€èˆ¬æåˆ° WebAssembly æŠ€æœ¯æˆ‘ä»¬æœ€å…ˆæƒ³åˆ°çš„æ˜¯æœ€è¿‘æ¯”è¾ƒç«çš„ rust è¯­è¨€ï¼Œå…¶å® WebAssembly æ˜¯ä¸€ç§äºŒè¿›åˆ¶çš„ç¼–ç æ ¼å¼ï¼Œå…¶ä»–è¯­è¨€å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨æ”¯æŒï¼Œè€Œå†™å‡ºèƒ½å¤Ÿåœ¨æµè§ˆå™¨å‰ç«¯è¿è¡Œçš„ä»£ç ã€‚

ğŸ’¡ **ä»‹ç»ï¼š**

WebAssemblyæ˜¯ä¸€ç§æ–°çš„ç¼–ç æ–¹å¼ï¼Œå¯ä»¥åœ¨ç°ä»£çš„ç½‘ç»œæµè§ˆå™¨ä¸­è¿è¡Œ ï¼ å®ƒæ˜¯ä¸€ç§ä½çº§çš„ç±»æ±‡ç¼–è¯­è¨€ï¼Œå…·æœ‰ç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå¯ä»¥æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½è¿è¡Œï¼Œå¹¶ä¸ºè¯¸å¦‚C / C ++ç­‰è¯­è¨€æä¾›ä¸€ä¸ªç¼–è¯‘ç›®æ ‡ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨Webä¸Šè¿è¡Œã€‚å®ƒä¹Ÿè¢«è®¾è®¡ä¸ºå¯ä»¥ä¸JavaScriptå…±å­˜ï¼Œå…è®¸ä¸¤è€…ä¸€èµ·å·¥ä½œã€‚ â€”â€” [MDN web docs - mozilla.org](https://developer.mozilla.org/zh-CN/docs/WebAssembly)

**æˆ‘ä»¬æ¥è°ˆè°ˆ Go è¯­è¨€ï¼š**

Go è¯­è¨€åœ¨ 1.11 ç‰ˆæœ¬(2018å¹´8æœˆ) åŠ å…¥äº†å¯¹ WebAssembly (Wasm) çš„åŸç”Ÿæ”¯æŒï¼Œä½¿ç”¨ Go è¯­è¨€å¼€å‘ `WebAssembly` ç›¸å…³çš„åº”ç”¨å˜å¾—æ›´åŠ åœ°ç®€å•ã€‚Go è¯­è¨€çš„å†…å»ºæ”¯æŒæ˜¯ Go è¯­è¨€è¿›å†›å‰ç«¯çš„ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘ã€‚åœ¨è¿™ä¹‹å‰ï¼Œå¦‚æœæƒ³ä½¿ç”¨ Go è¯­è¨€å¼€å‘å‰ç«¯ï¼Œéœ€è¦ä½¿ç”¨ [GopherJS](https://github.com/gopherjs/gopherjs)ï¼ŒGopherJS æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå¯ä»¥å°† Go è¯­è¨€è½¬æ¢æˆå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„ JavaScript ä»£ç ã€‚æ–°ç‰ˆæœ¬çš„ Go åˆ™ç›´æ¥å°† Go ä»£ç ç¼–è¯‘ä¸º wasm äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸å†éœ€è¦è½¬ä¸º JavaScript ä»£ç ã€‚æ›´å·§çš„æ˜¯ï¼Œå®ç° GopherJS å’Œåœ¨ Go è¯­è¨€ä¸­å†…å»ºæ”¯æŒ WebAssembly çš„æ˜¯åŒä¸€æ‹¨äººã€‚

**æœ€å¼€å§‹ï¼Œhello world:**

ç¬¬ä¸€æ­¥ï¼Œæ–°å»ºæ–‡ä»¶ `main.go`ï¼Œä½¿ç”¨ `js.Global().get('alert')` è·å–å…¨å±€çš„ alert å¯¹è±¡ï¼Œé€šè¿‡ Invoke æ–¹æ³•è°ƒç”¨ã€‚ç­‰ä»·äºåœ¨ js ä¸­è°ƒç”¨ `window.alert("Hello World")`ã€‚

```bash
// main.go
package main

import "syscall/js"

func main() {
	alert := js.Global().Get("alert")
	alert.Invoke("Hello World!")
}
```

ç¬¬äºŒæ­¥ï¼Œå°† main.go ç¼–è¯‘ä¸º `static/main.wasm`

> å¦‚æœå¯ç”¨äº† `GO MODULES`ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `go mod init` åˆå§‹åŒ–æ¨¡å—ï¼Œæˆ–è®¾ç½® `GO111MODULE=auto`ã€‚

```bash
GOOS=js GOARCH=wasm go build -o static/main.wasm
```

ç¬¬ä¸‰æ­¥ï¼Œæ‹·è´ `wasm_exec.js` (JavaScript æ”¯æŒæ–‡ä»¶ï¼ŒåŠ è½½ wasm æ–‡ä»¶æ—¶éœ€è¦) åˆ° static æ–‡ä»¶å¤¹

ç¬¬ä¸‰æ­¥ï¼Œæ‹·è´ wasm_exec.js (JavaScript æ”¯æŒæ–‡ä»¶ï¼ŒåŠ è½½ wasm æ–‡ä»¶æ—¶éœ€è¦) åˆ° static æ–‡ä»¶å¤¹

```bash
cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" static
```

ç¬¬å››æ­¥ï¼Œåˆ›å»º index.htmlï¼Œå¼•ç”¨ `static/main.wasm` å’Œ `static/wasm_exec.js`ã€‚

```bash
<html>
<script src="static/wasm_exec.js"></script>
<script>
	const go = new Go();
	WebAssembly.instantiateStreaming(fetch("static/main.wasm"), go.importObject)
		.then((result) => go.run(result.instance));
</script>

</html>
```

ç¬¬äº”æ­¥ï¼Œä½¿ç”¨ goexec å¯åŠ¨ Web æœåŠ¡

> å¦‚æœæ²¡æœ‰å®‰è£… goexecï¼Œå¯ç”¨ `go get -u github.com/shurcooL/goexec` å®‰è£…ï¼Œéœ€è¦å°† `$GOBIN` æˆ– `$GOPATH/bin` åŠ å…¥ç¯å¢ƒå˜é‡

å½“å‰çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```bash
# tree
.
â”œâ”€â”€ go.mod
â”œâ”€â”€ index.html
â”œâ”€â”€ main.go
â””â”€â”€ static
    â”œâ”€â”€ main.wasm
    â””â”€â”€ wasm_exec.js
```

æµè§ˆå™¨è®¿é—® `localhost:9999`ï¼Œåˆ™ä¼šæœ‰ä¸€ä¸ªå¼¹å‡ºçª—å£ï¼Œä¸Šé¢å†™ç€ `*Hello World!*`

ä¸ºäº†é¿å…æ¯æ¬¡ç¼–è¯‘éƒ½éœ€è¦è¾“å…¥ç¹ççš„å‘½ä»¤ï¼Œå¯å°†è¿™ä¸ªè¿‡ç¨‹å†™åœ¨ `Makefile` ä¸­

```bash
all: static/main.wasm static/wasm_exec.js
	goexec 'http.ListenAndServe(`:9999`, http.FileServer(http.Dir(`.`)))'

static/wasm_exec.js:
	cp "$(shell go env GOROOT)/misc/wasm/wasm_exec.js" static

static/main.wasm : main.go
	GO111MODULE=auto GOOS=js GOARCH=wasm go build -o static/main.wasm .
```

è¿™æ ·ä¸€ä¸ªæ•²ä¸€ä¸‹ make å°±å¤Ÿäº†ï¼Œä»£ç å·²ç»ä¸Šä¼ åˆ° [7days-golang - github.com](https://github.com/geektutu/7days-golang/tree/master/demo-wasm)ã€‚

###  æ³¨å†Œå‡½æ•°(Register Functions)

åœ¨ Go è¯­è¨€ä¸­è°ƒç”¨ JavaScript å‡½æ•°æ˜¯ä¸€æ–¹é¢ï¼Œå¦ä¸€æ–¹é¢ï¼Œå¦‚æœä»…ä»…æ˜¯ä½¿ç”¨ WebAssembly æ›¿ä»£æ€§èƒ½è¦æ±‚é«˜çš„æ¨¡å—ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨å†Œå‡½æ•°ï¼Œä»¥ä¾¿å…¶ä»– JavaScript ä»£ç è°ƒç”¨ã€‚

å‡è®¾æˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‡½æ•°ï¼Œå¯ä»¥è¿™ä¹ˆå®ç°ã€‚

```bash
// main.go
package main

import "syscall/js"

func fib(i int) int {
	if i == 0 || i == 1 {
		return 1
	}
	return fib(i-1) + fib(i-2)
}

func fibFunc(this js.Value, args []js.Value) interface{} {
	return js.ValueOf(fib(args[0].Int()))
}

func main() {
	done := make(chan int, 0)
	js.Global().Set("fibFunc", js.FuncOf(fibFunc))
	<-done
}
```

+ fib æ˜¯ä¸€ä¸ªæ™®é€šçš„ Go å‡½æ•°ï¼Œé€šè¿‡é€’å½’è®¡ç®—ç¬¬ i ä¸ªæ–æ³¢é‚£å¥‘æ•°ï¼Œæ¥æ”¶ä¸€ä¸ª int å…¥å‚ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯ intã€‚
+ å®šä¹‰äº† `fibFunc` å‡½æ•°ï¼Œä¸º fib å‡½æ•°å¥—äº†ä¸€ä¸ªå£³ï¼Œä» `args[0]` è·å–å…¥å‚ï¼Œè®¡ç®—ç»“æœç”¨ `js.ValueOf` åŒ…è£…ï¼Œå¹¶è¿”å›ã€‚
+ ä½¿ç”¨ `js.Global().Set()` æ–¹æ³•ï¼Œå°†æ³¨å†Œå‡½æ•° fibFunc åˆ°å…¨å±€ï¼Œä»¥ä¾¿åœ¨æµè§ˆå™¨ä¸­èƒ½å¤Ÿè°ƒç”¨ã€‚

`js.Value` å¯ä»¥å°† Js çš„å€¼è½¬æ¢ä¸º Go çš„å€¼ï¼Œæ¯”å¦‚ `args[0].Int()`ï¼Œåˆ™æ˜¯è½¬æ¢ä¸º Go è¯­è¨€ä¸­çš„æ•´å‹ã€‚`js.ValueOf`ï¼Œåˆ™ç”¨æ¥å°† Go çš„å€¼ï¼Œè½¬æ¢ä¸º Js çš„å€¼ã€‚å¦å¤–ï¼Œæ³¨å†Œå‡½æ•°çš„æ—¶å€™ï¼Œä½¿ç”¨ `js.FuncOf` å°†å‡½æ•°è½¬æ¢ä¸º `Func` ç±»å‹(`js.FuncOf()`æ–¹æ³•åˆ™å°†Goè¯­è¨€ä¸­çš„`fibFunc`å‡½æ•°è½¬æ¢ä¸ºJavaScriptä¸­çš„å‡½æ•°å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨JavaScriptä¸­è°ƒç”¨ã€‚)ï¼Œåªæœ‰ `Func` ç±»å‹çš„å‡½æ•°ï¼Œæ‰èƒ½åœ¨ `JavaScript` ä¸­è°ƒç”¨ã€‚å¯ä»¥è®¤ä¸ºè¿™æ˜¯ Go ä¸ `JavaScript` ä¹‹é—´çš„ `æ¥å£/çº¦å®š`ã€‚

`js.Func()` æ¥å—ä¸€ä¸ªå‡½æ•°ç±»å‹ä½œä¸ºå…¶å‚æ•°ï¼Œè¯¥å‡½æ•°çš„å®šä¹‰å¿…é¡»æ˜¯ï¼š

```go
func(this Value, args []Value) interface{}
// this å³ JavaScript ä¸­çš„ this
// args æ˜¯åœ¨ JavaScript ä¸­è°ƒç”¨è¯¥å‡½æ•°çš„å‚æ•°åˆ—è¡¨ã€‚
// è¿”å›å€¼éœ€ç”¨ js.ValueOf æ˜ å°„æˆ JavaScript çš„å€¼
```

åœ¨ main å‡½æ•°ä¸­ï¼Œåˆ›å»ºäº†ä¿¡é“(chan) doneï¼Œé˜»å¡ä¸»åç¨‹(goroutine)ã€‚fibFunc å¦‚æœåœ¨ JavaScript ä¸­è¢«è°ƒç”¨ï¼Œä¼šå¼€å¯ä¸€ä¸ªæ–°çš„å­åç¨‹æ‰§è¡Œã€‚

ğŸ’¡ æ³¨æ„è¿™ä¸ªç®¡é“ï¼Œå› ä¸ºæœ€å¼€å§‹è®¾ç½®çš„æ˜¯ 0ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªéç¼“å†²çš„ç®¡é“ï¼Œéç¼“å†²çš„ç®¡é“åªèƒ½åœ¨å‘é€å’Œæ¥æ”¶æ“ä½œéƒ½å‡†å¤‡å¥½æ—¶æ‰èƒ½è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡`<-done`è¯­å¥ï¼Œä¸»goroutineä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°ä»`done`é€šé“ä¸­æ¥æ”¶åˆ°ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚è¿™ä¸ªè¯­å¥çš„ä½œç”¨æ˜¯ç­‰å¾…å…¶ä»–goroutineçš„æ‰§è¡Œå®Œæˆï¼Œä»¥ä¿è¯ç¨‹åºä¸ä¼šåœ¨ä¸»goroutineé€€å‡ºä¹‹å‰ç»ˆæ­¢ã€‚


æ¥ä¸‹æ¥ï¼Œä¿®æ”¹ä¹‹å‰çš„ `index.html`ï¼Œåœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªè¾“å…¥æ¡†(num)ï¼Œä¸€ä¸ªæŒ‰é’®(btn) å’Œä¸€ä¸ªæ–‡æœ¬æ¡†(ansï¼Œç”¨æ¥æ˜¾ç¤ºè®¡ç®—ç»“æœ)ï¼Œå¹¶ç»™æŒ‰é’®æ·»åŠ äº†ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ï¼Œè°ƒç”¨ fibFuncï¼Œå¹¶å°†è®¡ç®—ç»“æœæ˜¾ç¤ºåœ¨æ–‡æœ¬æ¡†(ans)ä¸­ã€‚

```go
<html>
...
<body>
	<input id="num" type="number" />
	<button id="btn" onclick="ans.innerHTML=fibFunc(num.value * 1)">Click</button>
	<p id="ans">1</p>
</body>
</html>
```

###  æ“ä½œ DOM

åœ¨ä¸Šä¸€ä¸ªä¾‹å­ä¸­ï¼Œä»…ä»…æ˜¯æ³¨å†Œäº†å…¨å±€å‡½æ•° fibFuncï¼Œäº‹ä»¶æ³¨å†Œï¼Œè°ƒç”¨ï¼Œå¯¹ DOM å…ƒç´ çš„æ“ä½œéƒ½æ˜¯åœ¨ HTML ä¸­é€šè¿‡åŸç”Ÿçš„ JavaScript å‡½æ•°å®ç°çš„ã€‚è¿™äº›äº‹æƒ…ï¼Œèƒ½ä¸èƒ½å…¨éƒ¨åœ¨ Go è¯­è¨€ä¸­å®Œæˆå‘¢ï¼Ÿç­”æ¡ˆå¯ä»¥ã€‚

é¦–å…ˆä¿®æ”¹ `index.html`ï¼Œåˆ é™¤äº‹ä»¶æ³¨å†Œéƒ¨åˆ†å’Œ å¯¹ DOM å…ƒç´ çš„æ“ä½œéƒ¨åˆ†ã€‚

```go
<html>
...
<body>
	<input id="num" type="number" />
	<button id="btn">Click</button>
	<p id="ans">1</p>
</body>
</html>
```

**ä¿®æ”¹ main.goï¼š**

```go
package main

import (
	"strconv"
	"syscall/js"
)

func fib(i int) int {
	if i == 0 || i == 1 {
		return 1
	}
	return fib(i-1) + fib(i-2)
}

var (
	document = js.Global().Get("document")
	numEle   = document.Call("getElementById", "num")
	ansEle   = document.Call("getElementById", "ans")
	btnEle   = js.Global().Get("btn")
)

func fibFunc(this js.Value, args []js.Value) interface{} {
	v := numEle.Get("value")
	if num, err := strconv.Atoi(v.String()); err == nil {
		ansEle.Set("innerHTML", js.ValueOf(fib(num)))
	}
	return nil
}

func main() {
	done := make(chan int, 0)
	btnEle.Call("addEventListener", "click", js.FuncOf(fibFunc))
	<-done
}
```

+ é€šè¿‡ `js.Global().Get("btn")` æˆ– `document.Call("getElementById", "num")` ä¸¤ç§æ–¹å¼è·å–åˆ° DOM å…ƒç´ ã€‚
+ btnEle è°ƒç”¨ `addEventListener` ä¸º btn ç»‘å®šç‚¹å‡»äº‹ä»¶ fibFuncã€‚
+ åœ¨ fibFunc ä¸­ä½¿ç”¨ `numEle.Get("value")` è·å–åˆ° numEle çš„å€¼ï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œè½¬ä¸ºæ•´å‹å¹¶è°ƒç”¨ fib è®¡ç®—å‡ºç»“æœã€‚
+ ansEle è°ƒç”¨ `Set("innerHTML", ...)` æ¸²æŸ“è®¡ç®—ç»“æœã€‚

é‡æ–°ç¼–è¯‘ main.goï¼Œè®¿é—® `localhost:9999`ï¼Œæ•ˆæœä¸ä¹‹å‰æ˜¯ä¸€è‡´çš„ã€‚

## **å›è°ƒå‡½æ•°(Callback Functions)**

åœ¨ JavaScript ä¸­ï¼Œå¼‚æ­¥+å›è°ƒæ˜¯éå¸¸å¸¸è§çš„ï¼Œæ¯”å¦‚è¯·æ±‚ä¸€ä¸ª Restful APIï¼Œæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¾…æ•°æ®è·å–åˆ°ï¼Œå†æ‰§è¡Œå›è°ƒå‡½æ•°çš„é€»è¾‘ï¼Œè¿™ä¸ªæœŸé—´ç¨‹åºå¯ä»¥ç»§ç»­åšå…¶ä»–çš„äº‹æƒ…ã€‚Go è¯­è¨€å¯ä»¥é€šè¿‡åç¨‹å®ç°å¼‚æ­¥ã€‚

å‡è®¾ fib çš„è®¡ç®—éå¸¸è€—æ—¶ï¼Œé‚£ä¹ˆå¯ä»¥å¯åŠ¨æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¾… fib è®¡ç®—å®Œæˆåï¼Œå†æŠŠè®¡ç®—ç»“æœæ˜¾ç¤ºå‡ºæ¥ã€‚

æˆ‘ä»¬å…ˆä¿®æ”¹ `main.go`ï¼Œä½¿å¾— `fibFunc` æ”¯æŒä¼ å…¥å›è°ƒå‡½æ•°ã€‚

```go
package main

import (
	"syscall/js"
	"time"
)

func fib(i int) int {
	if i == 0 || i == 1 {
		return 1
	}
	return fib(i-1) + fib(i-2)
}

func fibFunc(this js.Value, args []js.Value) interface{} {
	callback := args[len(args)-1]
	go func() {
		time.Sleep(3 * time.Second)
		v := fib(args[0].Int())
		callback.Invoke(v)
	}()

	js.Global().Get("ans").Set("innerHTML", "Waiting 3s...")
	return nil
}

func main() {
	done := make(chan int, 0)
	js.Global().Set("fibFunc", js.FuncOf(fibFunc))
	<-done
}
```

+ å‡è®¾è°ƒç”¨ fibFunc æ—¶ï¼Œå›è°ƒå‡½æ•°ä½œä¸ºæœ€åä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆé€šè¿‡ args[len(args)-1] ä¾¿å¯ä»¥è·å–åˆ°è¯¥å‡½æ•°ã€‚è¿™ä¸å…¶ä»–ç±»å‹å‚æ•°çš„ä¼ é€’å¹¶æ— åŒºåˆ«ã€‚
+ ä½¿ç”¨ `go func()` å¯åŠ¨å­åç¨‹ï¼Œè°ƒç”¨ fib è®¡ç®—ç»“æœï¼Œè®¡ç®—ç»“æŸåï¼Œè°ƒç”¨å›è°ƒå‡½æ•° `callback`ï¼Œå¹¶å°†è®¡ç®—ç»“æœä¼ é€’ç»™å›è°ƒå‡½æ•°ï¼Œä½¿ç”¨ time.Sleep() æ¨¡æ‹Ÿ 3s çš„è€—æ—¶æ“ä½œã€‚
+ è®¡ç®—ç»“æœå‡ºæ¥å‰ï¼Œå…ˆåœ¨ç•Œé¢ä¸Šæ˜¾ç¤º `Waiting 3s...`

æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ index.htmlï¼Œä¸ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè°ƒç”¨ fibFunc

```go
<html>
...
<body>
	<input id="num" type="number" />
	<button id="btn" onclick="fibFunc(num.value * 1, (v)=> ans.innerHTML=v)">Click</button>
	<p id="ans"></p>
</body>
</html>
```

+ ä¸º btn æ³¨å†Œäº†ç‚¹å‡»äº‹ä»¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¾…è®¡ç®—çš„æ•°å­—ï¼Œä» num è¾“å…¥æ¡†è·å–ã€‚
+ ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå°†å‚æ•° v æ˜¾ç¤ºåœ¨ ans æ–‡æœ¬æ¡†ä¸­ã€‚

æ¥ä¸‹æ¥ï¼Œé‡æ–°ç¼–è¯‘ main.goï¼Œè®¿é—® localhost:9999ï¼Œéšä¾¿è¾“å…¥ä¸€ä¸ªæ•°å­—ï¼Œç‚¹å‡» Clickã€‚é¡µé¢ä¼šå…ˆæ˜¾ç¤º `Waiting 3s...`ï¼Œ3sè¿‡åæ˜¾ç¤ºè®¡ç®—ç»“æœã€‚

### **å·¥å…·æ¡†æ¶**

+ WebAssembly çš„äºŒè¿›åˆ¶åˆ†æå·¥å…· [WebAssembly Code Explorer](https://wasdk.github.io/wasmcodeexplorer/)
+ ä½¿ç”¨NodeJs æˆ–æµè§ˆå™¨æµ‹è¯• Go Wasm ä»£ç  [Github Wiki](https://github.com/golang/go/wiki/WebAssembly#executing-webassembly-with-nodejs)
+ å€Ÿé‰´ Vue å®ç°çš„ Golang WebAssembly å‰ç«¯æ¡†æ¶ [Vugu](https://www.vugu.org/doc/start)ï¼Œå®Œå…¨ä½¿ç”¨ Goï¼Œä¸ç”¨å†™ä»»ä½•çš„ JavaScript ä»£ç ã€‚

## Gorm å­¦ä¹ æ•™ç¨‹

### ç»“æ„ä½“æ ‡è®°ï¼ˆtagsï¼‰

ä½¿ç”¨ç»“æ„ä½“å£°æ˜æ¨¡å‹æ—¶ï¼Œæ ‡è®°ï¼ˆtagsï¼‰æ˜¯å¯é€‰é¡¹ã€‚gormæ”¯æŒä»¥ä¸‹æ ‡è®°:

### æ”¯æŒçš„ç»“æ„ä½“æ ‡è®°ï¼ˆStruct tagsï¼‰

| ç»“æ„ä½“æ ‡è®°ï¼ˆTagï¼‰ | æè¿°                                                     |
| ----------------- | -------------------------------------------------------- |
| Column            | æŒ‡å®šåˆ—å                                                 |
| Type              | æŒ‡å®šåˆ—æ•°æ®ç±»å‹                                           |
| Size              | æŒ‡å®šåˆ—å¤§å°, é»˜è®¤å€¼255                                    |
| PRIMARY_KEY       | å°†åˆ—æŒ‡å®šä¸ºä¸»é”®                                           |
| UNIQUE            | å°†åˆ—æŒ‡å®šä¸ºå”¯ä¸€                                           |
| DEFAULT           | æŒ‡å®šåˆ—é»˜è®¤å€¼                                             |
| PRECISION         | æŒ‡å®šåˆ—ç²¾åº¦                                               |
| NOT NULL          | å°†åˆ—æŒ‡å®šä¸ºé NULL                                        |
| AUTO_INCREMENT    | æŒ‡å®šåˆ—æ˜¯å¦ä¸ºè‡ªå¢ç±»å‹                                     |
| INDEX             | åˆ›å»ºå…·æœ‰æˆ–ä¸å¸¦åç§°çš„ç´¢å¼•, å¦‚æœå¤šä¸ªç´¢å¼•åŒååˆ™åˆ›å»ºå¤åˆç´¢å¼• |
| UNIQUE_INDEX      | å’Œ INDEX ç±»ä¼¼ï¼Œåªä¸è¿‡åˆ›å»ºçš„æ˜¯å”¯ä¸€ç´¢å¼•                    |
| EMBEDDED          | å°†ç»“æ„è®¾ç½®ä¸ºåµŒå…¥                                         |
| EMBEDDED_PREFIX   | è®¾ç½®åµŒå…¥ç»“æ„çš„å‰ç¼€                                       |
| -                 | å¿½ç•¥æ­¤å­—æ®µ                                               |

### å…³è”ç›¸å…³æ ‡è®°ï¼ˆtagsï¼‰

| ç»“æ„ä½“æ ‡è®°ï¼ˆTagï¼‰                | æè¿°                               |
| -------------------------------- | ---------------------------------- |
| MANY2MANY                        | æŒ‡å®šè¿æ¥è¡¨                         |
| FOREIGNKEY                       | è®¾ç½®å¤–é”®                           |
| ASSOCIATION_FOREIGNKEY           | è®¾ç½®å…³è”å¤–é”®                       |
| POLYMORPHIC                      | æŒ‡å®šå¤šæ€ç±»å‹                       |
| POLYMORPHIC_VALUE                | æŒ‡å®šå¤šæ€å€¼                         |
| JOINTABLE_FOREIGNKEY             | æŒ‡å®šè¿æ¥è¡¨çš„å¤–é”®                   |
| ASSOCIATION_JOINTABLE_FOREIGNKEY | æŒ‡å®šè¿æ¥è¡¨çš„å…³è”å¤–é”®               |
| SAVE_ASSOCIATIONS                | æ˜¯å¦è‡ªåŠ¨å®Œæˆ save çš„ç›¸å…³æ“ä½œ       |
| ASSOCIATION_AUTOUPDATE           | æ˜¯å¦è‡ªåŠ¨å®Œæˆ update çš„ç›¸å…³æ“ä½œ     |
| ASSOCIATION_AUTOCREATE           | æ˜¯å¦è‡ªåŠ¨å®Œæˆ create çš„ç›¸å…³æ“ä½œ     |
| ASSOCIATION_SAVE_REFERENCE       | æ˜¯å¦è‡ªåŠ¨å®Œæˆå¼•ç”¨çš„ save çš„ç›¸å…³æ“ä½œ |
| PRELOAD                          | æ˜¯å¦è‡ªåŠ¨å®Œæˆé¢„åŠ è½½çš„ç›¸å…³æ“ä½œ       |

## OpenIM å®¢æœç«¯çš„ Wasm è®¾è®¡

```bash
root@PS2023EVRHNCXG:~/workspaces/openim/openim-sdk-core/wasm# tree
.
â”œâ”€â”€ cmd
â”‚   â”œâ”€â”€ Makefile                    # æ„å»º wasm åŒ…çš„ Makefile æ–‡ä»¶
â”‚   â””â”€â”€ main.go                     # wasm åŒ…çš„å…¥å£æ–‡ä»¶
â”œâ”€â”€ event_listener
â”‚   â”œâ”€â”€ callback_writer.go          # å›è°ƒå‡½æ•°å†™å…¥å™¨ï¼Œç”¨äºå°†äº‹ä»¶ç›‘å¬å™¨çš„å›è°ƒå‡½æ•°å†™å…¥åˆ° wasm åŒ…ä¸­
â”‚   â”œâ”€â”€ caller.go                   # è°ƒç”¨å™¨ï¼Œç”¨äºè°ƒç”¨ wasm åŒ…ä¸­çš„å‡½æ•°
â”‚   â””â”€â”€ listener.go                 # äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬ wasm åŒ…ä¸­çš„äº‹ä»¶
â”œâ”€â”€ indexdb
â”‚   â”œâ”€â”€ black_model.go              # é»‘åå•æ¨¡å‹ï¼Œç”¨äºå®šä¹‰é»‘åå•æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ cache_message.go            # ç¼“å­˜æ¶ˆæ¯æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ç¼“å­˜æ¶ˆæ¯æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ chat_log_model.go           # èŠå¤©è®°å½•æ¨¡å‹ï¼Œç”¨äºå®šä¹‰èŠå¤©è®°å½•æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ chat_log_reaction_extension_model.go  # èŠå¤©è®°å½•ååº”æ‰©å±•æ¨¡å‹ï¼Œç”¨äºå®šä¹‰èŠå¤©è®°å½•ååº”æ‰©å±•æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ conversation_model.go       # ä¼šè¯æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ä¼šè¯æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ conversation_unread_message_model.go  # æœªè¯»æ¶ˆæ¯æ¨¡å‹ï¼Œç”¨äºå®šä¹‰æœªè¯»æ¶ˆæ¯æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ friend_model.go             # å¥½å‹æ¨¡å‹ï¼Œç”¨äºå®šä¹‰å¥½å‹æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ friend_request_model.go     # å¥½å‹è¯·æ±‚æ¨¡å‹ï¼Œç”¨äºå®šä¹‰å¥½å‹è¯·æ±‚æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ group_member_model.go       # ç¾¤æˆå‘˜æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ç¾¤æˆå‘˜æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ group_model.go              # ç¾¤ç»„æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ç¾¤ç»„æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ group_request.model.go      # ç¾¤ç»„è¯·æ±‚æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ç¾¤ç»„è¯·æ±‚æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ indexdb.go                  # ç´¢å¼•æ•°æ®åº“ï¼Œç”¨äºå®šä¹‰ç´¢å¼•æ•°æ®åº“çš„æ¥å£å’Œå®ç°
â”‚   â”œâ”€â”€ notification_model.go       # é€šçŸ¥æ¨¡å‹ï¼Œç”¨äºå®šä¹‰é€šçŸ¥æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ super_group_chat_log_model.go  # è¶…çº§ç¾¤èŠå¤©è®°å½•æ¨¡å‹ï¼Œç”¨äºå®šä¹‰è¶…çº§ç¾¤èŠå¤©è®°å½•æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ super_group_model.go        # è¶…çº§ç¾¤æ¨¡å‹ï¼Œç”¨äºå®šä¹‰è¶…çº§ç¾¤æ•°æ®è¡¨ç»“æ„
â”‚   â”œâ”€â”€ temp_struct                 # ä¸´æ—¶ç»“æ„ä½“æ–‡ä»¶å¤¹ï¼Œç”¨äºå­˜æ”¾ä¸€äº›ä¸´æ—¶çš„ç»“æ„ä½“å®šä¹‰
â”‚   â”‚   â””â”€â”€ struct.go
â”‚   â””â”€â”€ user_model.go               # ç”¨æˆ·æ¨¡å‹ï¼Œç”¨äºå®šä¹‰ç”¨æˆ·æ•°æ®è¡¨ç»“æ„
â””â”€â”€ wasm_wrapper
    â”œâ”€â”€ wasm_conversation_msg.go    # wasm åŒ…ä¸­çš„ä¼šè¯æ¶ˆæ¯ç›¸å…³å‡½æ•°
    â”œâ”€â”€ wasm_friend.go              # wasm åŒ…ä¸­çš„å¥½å‹ç›¸å…³å‡½æ•°
    â”œâ”€â”€ wasm_group.go               # wasm åŒ…ä¸­çš„ç¾¤ç»„ç›¸å…³å‡½æ•°
    â”œâ”€â”€ wasm_init_login.go          # wasm åŒ…ä¸­çš„åˆå§‹åŒ–å’Œç™»å½•ç›¸å…³å‡½æ•°
    â”œâ”€â”€ wasm_signaling.go           # wasm åŒ…ä¸­çš„ä¿¡ä»¤ç›¸å…³å‡½æ•°
    â”œâ”€â”€ wasm_third.go               # wasm åŒ…ä¸­çš„ç¬¬ä¸‰æ–¹ç›¸å…³å‡½æ•°
    â””â”€â”€ wasm_user.go                # wasm åŒ…ä¸­çš„ç”¨æˆ·ç›¸å…³å‡½æ•°
```

wasm ä¸­è´Ÿè´£çš„æ¨¡å—ï¼š

+ `wasm/indexdb/chat_log_model.go`
+ `wasm/indexdb/black_model.go`
+ `wasm/indexdb/conversation_model.go`

**æµ‹è¯•æ¨¡å—çš„ä»£ç ï¼š**

```go
testv2/
â”œâ”€â”€ callback.go // å›è°ƒå‡½æ•°
â”œâ”€â”€ config.go // é…ç½®æ–‡ä»¶
â”œâ”€â”€ conversation_test.go // å¯¹è¯æµ‹è¯•
â”œâ”€â”€ create_msg_test.go // åˆ›å»ºæ¶ˆæ¯æµ‹è¯•
â”œâ”€â”€ empty_test.go // ç©ºæµ‹è¯•
â”œâ”€â”€ file_test.go // æ–‡ä»¶æµ‹è¯•
â”œâ”€â”€ friend_test.go // å¥½å‹æµ‹è¯•
â”œâ”€â”€ group_test.go // ç¾¤ç»„æµ‹è¯•
â”œâ”€â”€ init.go // åˆå§‹åŒ–
â”œâ”€â”€ listener.go // ç›‘å¬å™¨
â”œâ”€â”€ signaling_test.go // ä¿¡ä»¤æµ‹è¯•
â”œâ”€â”€ sync_test.go // åŒæ­¥æµ‹è¯•
â”œâ”€â”€ user_test.go // ç”¨æˆ·æµ‹è¯•
â””â”€â”€ work_moment_test.go // å·¥ä½œæ—¶åˆ»æµ‹è¯•
```

### chat_log_model

è·å–åˆ° messge:

```go
func (i *LocalChatLogs) GetMessage(ctx context.Context, conversationID, clientMsgID string) (*model_struct.LocalChatLog, error) {
	msg, err := Exec(conversationID, clientMsgID)
	if err != nil {
		return nil, err
	} else {
		if v, ok := msg.(string); ok {
			result := model_struct.LocalChatLog{}
			err := utils.JsonStringToStruct(v, &result)
			if err != nil {
				return nil, err
			}
			return &result, err
		} else {
			return nil, ErrType
		}
	}
}
```

å¯¹åº”çš„ db message:

```go
func (d *DataBase) GetMessage(ctx context.Context, conversationID string, clientMsgID string) (*model_struct.LocalChatLog, error) {
	d.initChatLog(ctx, conversationID)
	var c model_struct.LocalChatLog
	return &c, utils.Wrap(d.conn.WithContext(ctx).Table(utils.GetTableName(conversationID)).Where("client_msg_id = ?",
		clientMsgID).Take(&c).Error, "GetMessage failed")
}
```

+ getMessage

| è¾“å…¥å‚æ•°    | ç±»å‹   | è¯´æ˜   | å¤‡æ³¨ |
| ----------- | ------ | ------ | ---- |
| clientMsgID | string | æ¶ˆæ¯ID |      |

| è¿”å›å‚æ•° | ç±»å‹   | è¯´æ˜                           | å¤‡æ³¨                           |
| -------- | ------ | ------------------------------ | ------------------------------ |
| errCode  | number | è‡ªå®šä¹‰å³å¯ï¼Œ0æˆåŠŸï¼Œé0å¤±è´¥     | å¦‚æœè·å–ä¸åˆ°æ¶ˆæ¯ä¹Ÿéœ€è¦è¿”å›é”™è¯¯ |
| errMsg   | string | è¯¦ç»†çš„errä¿¡æ¯                  |                                |
| data     | string | LocalChatLogï¼ˆæ¶ˆæ¯è¡¨å¯¹è±¡æ•°æ®ï¼‰ | å¯¹è±¡è½¬æ¢æˆstring               |

**å‚è€ƒsqlè¯­å¥è¯´æ˜ï¼š**

```
SELECT * FROM `local_chat_logs` WHERE client_msg_id = "063031b86f8e503c6038efb2b835f216" LIMIT 1
```

### **chat_log_model**

### **wasm æ¨¡å—è·å–åˆ° messgae å®ç°**

```
func (i *LocalChatLogs) GetMessage(ctx context.Context, conversationID, clientMsgID string) (*model_struct.LocalChatLog, error) {
    msg, err := Exec(conversationID, clientMsgID)
    if err != nil {
        return nil, err
    } else {
        if v, ok := msg.(string); ok {
            result := model_struct.LocalChatLog{}
            err := utils.JsonStringToStruct(v, &result)
            if err != nil {
                return nil, err
            }
            return &result, err
        } else {
            return nil, ErrType
        }
    }
}
```

### **å¯¹åº”çš„ db æ¨¡å— messageå®ç°:**

```
func (d *DataBase) GetMessage(ctx context.Context, conversationID string, clientMsgID string) (*model_struct.LocalChatLog, error) {
    d.initChatLog(ctx, conversationID)
    var c model_struct.LocalChatLog
    return &c, utils.Wrap(d.conn.WithContext(ctx).Table(utils.GetTableName(conversationID)).Where("client_msg_id = ?",
        clientMsgID).Take(&c).Error, "GetMessage failed")
}
```

### **æ–‡æ¡£çš„å®ç°ï¼ˆç»™å‰ç«¯åŒå­¦çœ‹çš„ï¼Œåªéœ€è¦ä¿®æ”¹ data çš„å¤‡æ³¨ï¼Œæ˜¯å¯¹è±¡è½¬åŒ–ä¸ºä»€ä¹ˆç±»å‹ï¼‰**

+ getMessage

| è¾“å…¥å‚æ•°    | ç±»å‹   | è¯´æ˜   | å¤‡æ³¨ |
| ----------- | ------ | ------ | ---- |
| clientMsgID | string | æ¶ˆæ¯ID |      |

| è¿”å›å‚æ•° | ç±»å‹   | è¯´æ˜                           | å¤‡æ³¨                           |
| -------- | ------ | ------------------------------ | ------------------------------ |
| errCode  | number | è‡ªå®šä¹‰å³å¯ï¼Œ0æˆåŠŸï¼Œé0å¤±è´¥     | å¦‚æœè·å–ä¸åˆ°æ¶ˆæ¯ä¹Ÿéœ€è¦è¿”å›é”™è¯¯ |
| errMsg   | string | è¯¦ç»†çš„errä¿¡æ¯                  |                                |
| data     | string | LocalChatLogï¼ˆæ¶ˆæ¯è¡¨å¯¹è±¡æ•°æ®ï¼‰ | å¯¹è±¡è½¬æ¢æˆstring               |

**å‚è€ƒsqlè¯­å¥è¯´æ˜ï¼š**

```
SELECT * FROM `local_chat_logs` WHERE client_msg_id = "063031b86f8e503c6038efb2b835f216" LIMIT 1
```

### **wasm çš„getMessageList çš„å®ç°**

```
func (i *LocalChatLogs) GetMessageList(ctx context.Context, conversationID string, count int, startTime int64, isReverse bool) (result []*model_struct.LocalChatLog, err error) {
    msgList, err := Exec(conversationID, count, startTime, isReverse, i.loginUserID)
    if err != nil {
        return nil, err
    } else {
        if v, ok := msgList.(string); ok {
            var temp []model_struct.LocalChatLog
            err := utils.JsonStringToStruct(v, &temp)
            if err != nil {
                return nil, err
            }
            for _, v := range temp {
                v1 := v
                result = append(result, &v1)
            }
            return result, err
        } else {
            return nil, ErrType
        }
    }
}
```

### **å¯¹åº”çš„ db æ¨¡å— messageå®ç°**

```
func (d *DataBase) GetMessageList(ctx context.Context, conversationID string, count int, startTime int64, isReverse bool) (result []*model_struct.LocalChatLog, err error) {
    d.mRWMutex.Lock()
    defer d.mRWMutex.Unlock()
    var condition, timeOrder, timeSymbol string
    if isReverse {
        timeOrder = "send_time ASC"
        timeSymbol = ">"
    } else {
        timeOrder = "send_time DESC"
        timeSymbol = "<"
    }
    condition = "send_time " + timeSymbol + " ?"

    err = utils.Wrap(d.conn.WithContext(ctx).Table(utils.GetTableName(conversationID)).Where(condition, startTime).
        Order(timeOrder).Offset(0).Limit(count).Find(&result).Error, "GetMessageList failed")
    if err != nil {
        return nil, err
    }
    return result, err
}
```

### **æ–‡æ¡£çš„å®ç°ï¼ˆç»™å‰ç«¯åŒå­¦çœ‹çš„ï¼Œåªéœ€è¦ä¿®æ”¹ data çš„å¤‡æ³¨ï¼Œæ˜¯å¯¹è±¡è½¬åŒ–ä¸ºä»€ä¹ˆç±»å‹ï¼‰**

+ getMessageList

| è¾“å…¥å‚æ•°    | ç±»å‹    | è¯´æ˜                                 | å¤‡æ³¨                                                         |
| ----------- | ------- | ------------------------------------ | ------------------------------------------------------------ |
| sourceID    | string  | å…³äºæŸäººçš„IDä¹Ÿå¯èƒ½æ˜¯å†™æ‰©æ•£æ¨¡å¼ä¸‹ç¾¤ID |                                                              |
| sessionType | number  | ä¼šè¯ç±»å‹ï¼Œå•èŠ1ã€è¯»æ‰©æ•£ç¾¤2ã€å¤§ç¾¤ä¸º3  |                                                              |
| count       | number  | è·å–æ¶ˆæ¯çš„æ•°é‡                       |                                                              |
| startTime   | number  | æ¶ˆæ¯å‘é€æ—¶é—´ï¼Œæ¯«ç§’                   |                                                              |
| isReverse   | boolean | æ¶ˆæ¯ä¸ºæ­£å‘æ‹‰å–è¿˜æ˜¯åå‘æ‹‰å–           | é»˜è®¤æƒ…å†µä¸ºfalseï¼Œå³ä¸ºæ­£å‘æ‹‰å–ï¼ˆä»æ–°æ¶ˆæ¯åˆ°è€æ¶ˆæ¯ï¼‰ï¼Œorder by åé¢çš„æ’åºè§„åˆ™ä¸ºsend_time DESC é™åºæ’åˆ—ï¼Œsend_timeä¸º <;å½“ä¸ºtrueçš„æƒ…å†µï¼Œå³ä¸ºåå‘æ‹‰å–ï¼Œorder by åé¢çš„æ’åºè§„åˆ™ä¸ºsend_time ASC å‡åºæ’åˆ—,send_timeä¸º > |
| loginUserID | string  | ç”¨æˆ·ç™»å½•ID                           | éœ€è¦æ ¹æ®ä¼šè¯çš„ç±»å‹å’ŒsourceIDåˆ¤æ–­ï¼Œå½“sessionTypeä¸º1å¹¶ä¸”sourceIDä¸ºç™»å½•è€…IDæ—¶å€™ï¼Œæœç´¢sqlä¸º AND |

| è¿”å›å‚æ•° | ç±»å‹   | è¯´æ˜                                 | å¤‡æ³¨                                   |
| -------- | ------ | ------------------------------------ | -------------------------------------- |
| errCode  | number | è‡ªå®šä¹‰å³å¯ï¼Œ0æˆåŠŸï¼Œé0å¤±è´¥           | è·å–ä¸åˆ°çš„æ—¶å€™è¿”å›ç©ºæ•°ç»„ä¸éœ€è¦è¿”å›é”™è¯¯ |
| errMsg   | string | è¯¦ç»†çš„errä¿¡æ¯                        |                                        |
| data     | string | []LocalChatLogï¼ˆæ¶ˆæ¯è¡¨å¯¹è±¡æ•°ç»„æ•°æ®ï¼‰ | å¯¹è±¡è½¬æ¢æˆstring                       |

**å‚è€ƒsqlè¯­å¥è¯´æ˜ï¼š**

```
-- 1ã€sessionType == 1 && sourceID == d.loginUserID
SELECT * FROM `local_chat_logs` WHERE send_id = "812146266" And  recv_id = "812146266" AND status <=1 And session_type = 3 And send_time < 1664357584025 ORDER BY send_time DESC LIMIT 30;
-- æ³¨ï¼šå…¶ä¸­statuså›ºå®šä¸º3
-- 2ã€å…¶ä»–åœºæ™¯
SELECT * FROM `local_chat_logs` WHERE send_id = "812146266" OR  recv_id = "812146266" AND status <=1 And session_type = 3 And send_time < 1664357584025 ORDER BY send_time DESC LIMIT 30;
```



## END é“¾æ¥
<ul><li><div><a href = '86.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '88.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
