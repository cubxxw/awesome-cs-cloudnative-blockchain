+ [author](http://nsddd.top)

# ç¬¬34èŠ‚ localregistry save Kubernetes secret

<div><a href = '33.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '35.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/cubxxw/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/cubxxw/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[TOC]

## Kubernetes çš„ Marshal

åœ¨ Kubernetes ä¸­ï¼ŒMarshal æ˜¯ä¸€ç§å°†æ•°æ®ç¼–ç ä¸º YAML æˆ– JSON æ ¼å¼çš„æ–¹æ³•ã€‚åœ¨ [sigs.k8s.io/yaml](http://sigs.k8s.io/yaml) ä¸­ï¼Œæä¾›äº†ä¸€ä¸ª YAML åº“ï¼Œç”¨äºå°† Go å¯¹è±¡è½¬æ¢ä¸º YAMLã€‚è¯¥åº“æ”¯æŒ Kubernetes å’Œå…¶ä»–ä½¿ç”¨ YAML çš„é¡¹ç›®ã€‚

[sigs.k8s.io/yaml](http://sigs.k8s.io/yaml) åº“æä¾›äº†ä¸€ä¸ªåä¸º yaml.Marshal çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸€ä¸ª Go å¯¹è±¡å¹¶è¿”å›ä¸€ä¸ªå­—èŠ‚æ•°ç»„å’Œä¸€ä¸ªé”™è¯¯ã€‚å­—èŠ‚æ•°ç»„åŒ…å«ç¼–ç åçš„ YAML æ•°æ®ï¼Œé”™è¯¯ç”¨äºæŒ‡ç¤ºæ˜¯å¦å‡ºç°äº†ä»»ä½•é—®é¢˜ã€‚è¿™ä½¿å¾—åœ¨ Kubernetes ä¸­å°† Go å¯¹è±¡è½¬æ¢ä¸º YAML æ•°æ®å˜å¾—éå¸¸ç®€å•ã€‚

é™¤äº† yaml.Marshal å‡½æ•°ä¹‹å¤–ï¼Œ[sigs.k8s.io/yaml](http://sigs.k8s.io/yaml) è¿˜æä¾›äº†å…¶ä»–ä¸€äº›å‡½æ•°ï¼Œç”¨äºè§£ç  YAML æ•°æ®å¹¶å°†å…¶è½¬æ¢å› Go å¯¹è±¡ã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬ yaml.Unmarshal å’Œ yaml.NewDecoderã€‚å®ƒä»¬ä¸ yaml.Marshal å‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥è®©ä½ è½»æ¾åœ°åœ¨ Kubernetes ä¸­ç¼–ç å’Œè§£ç  YAML æ•°æ®ã€‚

æ€»ä¹‹ï¼Œ[sigs.k8s.io/yaml](http://sigs.k8s.io/yaml) åº“ä¸º Kubernetes æä¾›äº†ä¸€ç§å¼ºå¤§çš„æ–¹å¼æ¥å¤„ç† YAML æ•°æ®ã€‚é€šè¿‡ä½¿ç”¨ yaml.Marshal å’Œå…¶ä»–ç›¸å…³å‡½æ•°ï¼Œå¯ä»¥è½»æ¾åœ°å°† Go å¯¹è±¡ç¼–ç ä¸º YAMLï¼Œç„¶åå°†å…¶ä¿å­˜åˆ° Kubernetes ä¸­ã€‚è¿™ä½¿å¾—åœ¨ Kubernetes ä¸­å¤„ç† YAML æ•°æ®å˜å¾—éå¸¸å®¹æ˜“ï¼Œè€Œä¸”éå¸¸æ–¹ä¾¿ã€‚

### yaml.Builder

`yaml.Builder` æ˜¯ `sigs.k8s.io/yaml` åº“ä¸­çš„ä¸€ä¸ªç±»å‹ï¼Œå®ƒå…è®¸å°† Go å¯¹è±¡ç¼–ç ä¸º YAML æ ¼å¼ã€‚å®ƒä½¿ç”¨ `Encoder` å±æ€§æ¥æŒ‡å®šåºåˆ—åŒ–å™¨ï¼Œè¯¥åºåˆ—åŒ–å™¨å°† Go å¯¹è±¡è½¬æ¢ä¸º YAML æ ¼å¼ã€‚å®ƒè¿˜æä¾›äº† `Encode` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª Go å¯¹è±¡å¹¶è¿”å›ä¸€ä¸ªå­—èŠ‚æ•°ç»„å’Œä¸€ä¸ªé”™è¯¯ï¼Œå­—èŠ‚æ•°ç»„åŒ…å«ç¼–ç åçš„ YAML æ•°æ®ï¼Œé”™è¯¯ç”¨äºæŒ‡ç¤ºæ˜¯å¦å‡ºç°äº†ä»»ä½•é—®é¢˜ã€‚

åœ¨ Kubernetes ä¸­ï¼Œ`yaml.Builder` å¯ä»¥ä¸ `json.NewSerializerWithOptions` å’Œ `runtime.NewScheme` ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å°† Kubernetes å¯¹è±¡ç¼–ç ä¸º YAML æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `yaml.Builder` å°† `Pod` å¯¹è±¡ç¼–ç ä¸º YAML æ ¼å¼ã€‚

### [k8s.io/apimachinery/pkg/runtime/serializer/json](http://k8s.io/apimachinery/pkg/runtime/serializer/json)

`k8s.io/apimachinery/pkg/runtime/serializer/json` æ˜¯ Kubernetes çš„ä¸€ä¸ª Go ä»£ç åŒ…ï¼Œç”¨äºå°† Kubernetes å¯¹è±¡åºåˆ—åŒ–ä¸º JSON æ ¼å¼ã€‚å®ƒä½¿ç”¨ `runtime.ObjectConvertor` æ¥å£æ¥å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è¯¥ä»£ç åŒ…è¿˜æä¾›äº†ä¸€äº›é€‰é¡¹ï¼Œä¾‹å¦‚ `json.SerializerOptions`ï¼Œä½¿ç”¨æˆ·å¯ä»¥æ§åˆ¶åºåˆ—åŒ–çš„è¡Œä¸ºï¼Œä¾‹å¦‚é€‰æ‹©æ˜¯å¦ä½¿ç”¨ YAML æˆ– JSON æ ¼å¼ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `json.NewSerializerWithOptions` å‡½æ•°å°†ä¸€ä¸ª `Pod` å¯¹è±¡ç¼–ç ä¸º JSON æ ¼å¼ï¼š

```go
package main

import (
	"fmt"
	"os"

	"k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/schema"
	"k8s.io/apimachinery/pkg/runtime/serializer/json"
)

type Pod struct {
	v1.TypeMeta   `json:",inline"`
	v1.ObjectMeta `json:"metadata"`
	Spec          v1.PodSpec `json:"spec"`
}

func main() {
	pod := &Pod{
		TypeMeta: v1.TypeMeta{
			APIVersion: "v1",
			Kind:       "Pod",
		},
		ObjectMeta: v1.ObjectMeta{
			Name:      "example-pod",
			Namespace: "default",
		},
		Spec: v1.PodSpec{
			Containers: []v1.Container{
				{
					Name:  "example-container",
					Image: "nginx",
				},
			},
		},
	}

	s := runtime.NewScheme()
	s.AddKnownTypes(schema.GroupVersion{Group: "", Version: "v1"}, pod)

	jsonSerializer := json.NewSerializerWithOptions(json.DefaultMetaFactory, s, s, json.SerializerOptions{})

	err := jsonSerializer.Encode(pod, os.Stdout)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Error: %v\n", err)
		os.Exit(1)
	}
}
```

æ­¤ç¤ºä¾‹å°†è¾“å‡ºä»¥ä¸‹ JSON æ•°æ®ï¼š

```
{
  "apiVersion": "v1",
  "kind": "Pod",
  "metadata": {
    "name": "example-pod",
    "namespace": "default"
  },
  "spec": {
    "containers": [
      {
        "name": "example-container",
        "image": "nginx"
      }
    ]
  }
}
```

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ `Pod` å¯¹è±¡ï¼Œå®ƒåªåŒ…å«ä¸€ä¸ªå®¹å™¨ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦é€šè¿‡ä¿®æ”¹æ­¤ç¤ºä¾‹æ¥åˆ›å»ºæ›´å¤æ‚çš„ Kubernetes å¯¹è±¡ã€‚

æ€»ä¹‹ï¼Œ`k8s.io/apimachinery/pkg/runtime/serializer/json` ä»£ç åŒ…ä¸º Kubernetes æä¾›äº†ä¸€ç§å¼ºå¤§çš„æ–¹å¼æ¥å¤„ç† JSON æ•°æ®ã€‚é€šè¿‡ä½¿ç”¨ `json.NewSerializerWithOptions` å‡½æ•°ï¼Œå¯ä»¥è½»æ¾åœ°å°† Kubernetes å¯¹è±¡ç¼–ç ä¸º JSONï¼Œç„¶åå°†å…¶ä¿å­˜åˆ° Kubernetes ä¸­ã€‚è¿™ä½¿å¾—åœ¨ Kubernetes ä¸­å¤„ç† JSON æ•°æ®å˜å¾—éå¸¸å®¹æ˜“ï¼Œè€Œä¸”éå¸¸æ–¹ä¾¿ã€‚

## `yaml.Unmarshal`

```
package main

import (
	"fmt"

	"k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/util/yaml"
)

type Pod struct {
	v1.TypeMeta   `json:",inline" yaml:",inline"`
	v1.ObjectMeta `json:"metadata" yaml:"metadata"`
	Spec          v1.PodSpec `json:"spec" yaml:"spec"`
}

func main() {
	data := []byte(`
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
spec:
  containers:
  - name: example-container
    image: nginx
`)

	pod := &Pod{}
	err := yaml.Unmarshal(data, pod)
	if err != nil {
		fmt.Printf("error: %v\\n", err)
		return
	}

	fmt.Printf("pod name: %s\\n", pod.ObjectMeta.Name)
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åœ¨ `Pod` ç»“æ„ä½“ä¸­å®šä¹‰äº† `v1.TypeMeta` å’Œ `v1.ObjectMeta` å­—æ®µï¼Œè¿™äº›å­—æ®µç”± `json` å’Œ `yaml` æ ‡è®°æ³¨é‡Šã€‚ç„¶åæˆ‘ä»¬åœ¨ `main` å‡½æ•°ä¸­å®šä¹‰äº†ä¸€ä¸ª YAML å­—ç¬¦ä¸²ï¼Œå®ƒåŒ…å«ä¸€ä¸ªç®€å•çš„ `Pod` å¯¹è±¡çš„å®šä¹‰ã€‚æˆ‘ä»¬ä½¿ç”¨ `yaml.Unmarshal` å‡½æ•°å°† YAML å­—ç¬¦ä¸²è§£ç ä¸º `Pod` å¯¹è±¡ã€‚ç„¶åæˆ‘ä»¬æ‰“å°äº†è¯¥å¯¹è±¡çš„åç§°ã€‚

`yaml.Unmarshal` å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šè¦è§£ç çš„å­—èŠ‚æ•°ç»„å’Œä¸€ä¸ªæŒ‡å‘è¦è§£ç çš„å¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† YAML å­—ç¬¦ä¸²è§£ç ä¸º `Pod` å¯¹è±¡ã€‚å¦‚æœè§£ç æˆåŠŸï¼Œ`Unmarshal` å‡½æ•°å°†å¡«å……æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¹¶è¿”å› `nil`ã€‚å¦‚æœè§£ç å¤±è´¥ï¼Œ`Unmarshal` å‡½æ•°å°†è¿”å›ä¸€ä¸ª `error`ã€‚

æ€»ä¹‹ï¼Œ`yaml.Unmarshal` å‡½æ•°æ˜¯å°† YAML æ•°æ®è§£ç ä¸º Go å¯¹è±¡çš„ä¸€ç§æ–¹æ³•ã€‚å®ƒæ˜¯ `sigs.k8s.io/yaml` åº“æä¾›çš„ä¸€ç³»åˆ—å‡½æ•°ä¹‹ä¸€ï¼Œè¿™äº›å‡½æ•°ç”¨äºç¼–ç å’Œè§£ç  Kubernetes å¯¹è±¡å’Œå…¶ä»–ä½¿ç”¨ YAML çš„é¡¹ç›®ã€‚

## `yaml.NewDecoder`

`yaml.NewDecoder`å‡½æ•°æ˜¯`sigs.k8s.io/yaml`åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…è®¸å°†YAMLæ•°æ®è§£ç ä¸ºGoå¯¹è±¡ã€‚ä¸`yaml.Marshal`å‡½æ•°ç±»ä¼¼ï¼Œ`yaml.NewDecoder`å‡½æ•°éœ€è¦ä¸€ä¸ªæ¥å—å­—èŠ‚æ•°ç»„çš„å‚æ•°ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜éœ€è¦ä¸€ä¸ªç”¨äºå°†YAMLæ•°æ®è§£ç ä¸ºGoå¯¹è±¡çš„æ¥æ”¶å™¨ã€‚

åœ¨Kubernetesä¸­ï¼Œ`yaml.NewDecoder`å¯ä»¥ä¸`scheme.Codecs.UniversalDeserializer()`ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å°†Kuberneteså¯¹è±¡è§£ç ä¸ºGoå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`yaml.NewDecoder`å°†YAMLæ ¼å¼çš„`Pod`å¯¹è±¡è§£ç ä¸ºGoå¯¹è±¡ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `yaml.NewDecoder` å°† YAML æ ¼å¼çš„ `Pod` å¯¹è±¡è§£ç ä¸º Go å¯¹è±¡çš„ç¤ºä¾‹ä»£ç ï¼š

```
package main

import (
	"fmt"
	"io/ioutil"

	"k8s.io/apimachinery/pkg/apis/meta/v1"
	"k8s.io/apimachinery/pkg/runtime"
	"k8s.io/apimachinery/pkg/runtime/schema"
	"k8s.io/apimachinery/pkg/util/yaml"
)

type Pod struct {
	v1.TypeMeta   `json:",inline"`
	v1.ObjectMeta `json:"metadata"`
	Spec          v1.PodSpec `json:"spec"`
}

func main() {
	data, err := ioutil.ReadFile("pod.yaml")
	if err != nil {
		fmt.Printf("error: %v\n", err)
		return
	}

	pod := &Pod{}
	obj, _, err := yaml.NewDecoder(data).Decode(pod, nil, nil)
	if err != nil {
		fmt.Printf("error: %v\n", err)
		return
	}

	pod = obj.(*Pod)
	fmt.Printf("pod name: %s\n", pod.ObjectMeta.Name)
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `ioutil.ReadFile` å‡½æ•°è¯»å–åä¸º `pod.yaml` çš„ YAML æ–‡ä»¶çš„å†…å®¹ã€‚ç„¶åæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª `Pod` ç»“æ„ä½“ï¼ŒåŒ…å« `v1.TypeMeta`ã€`v1.ObjectMeta` å’Œ `v1.PodSpec` å­—æ®µã€‚æˆ‘ä»¬ä½¿ç”¨ `yaml.NewDecoder` å‡½æ•°å°† YAML æ•°æ®è§£ç ä¸º `Pod` å¯¹è±¡ã€‚ç„¶åæˆ‘ä»¬æ‰“å°äº†è¯¥å¯¹è±¡çš„åç§°ã€‚

`yaml.NewDecoder` å‡½æ•°æ¥å—ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªè§£ç å™¨å¯¹è±¡ã€‚è¯¥è§£ç å™¨å¯¹è±¡åŒ…å« `Decode` æ–¹æ³•ï¼Œç”¨äºå°† YAML æ•°æ®è§£ç ä¸º Go å¯¹è±¡ã€‚`Decode` æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼šè¦è§£ç çš„å­—èŠ‚æ•°ç»„ï¼Œä¸€ä¸ªæŒ‡å‘è¦è§£ç çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œä»¥åŠä¸€ä¸ª `DecoderConfig` å¯¹è±¡ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† YAML æ•°æ®è§£ç ä¸º `Pod` å¯¹è±¡ï¼Œå¹¶å°†å…¶å¡«å……åˆ°æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆä¸­ã€‚å¦‚æœè§£ç æˆåŠŸï¼Œ`Decode` æ–¹æ³•å°†è¿”å›è§£ç å¯¹è±¡ã€å­—èŠ‚æ•°ç»„å’Œ `nil`ã€‚å¦‚æœè§£ç å¤±è´¥ï¼Œ`Decode` æ–¹æ³•å°†è¿”å› `nil`ã€å­—èŠ‚æ•°ç»„å’Œä¸€ä¸ª `error`ã€‚

## [k8s.io/apimachinery/pkg](http://k8s.io/apimachinery/pkg)

[k8s.io/apimachinery/pkg](https://github.com/kubernetes/apimachinery/tree/master/pkg) æ˜¯ Kubernetes çš„æ ¸å¿ƒåº“ä¹‹ä¸€ï¼Œæä¾›äº†è®¸å¤šç”¨äºå¤„ç† Kubernetes å¯¹è±¡å’Œèµ„æºçš„ Go ä»£ç åŒ…ã€‚è¿™äº›ä»£ç åŒ…åŒ…æ‹¬ç”¨äºç¼–ç å’Œè§£ç  Kubernetes å¯¹è±¡çš„åºåˆ—åŒ–å™¨ï¼Œç”¨äºå¤„ç† Kubernetes èµ„æºçš„å®¢æˆ·ç«¯ï¼Œä»¥åŠå…¶ä»–å„ç§å®ç”¨ç¨‹åºå’Œåº“ã€‚

[sigs.k8s.io/controller-runtime](https://github.com/kubernetes-sigs/controller-runtime) ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ Kubernetes åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ªé«˜çº§çš„å·¥å…·é›†ï¼Œç”¨äºç¼–å†™ Kubernetes æ§åˆ¶å™¨ã€‚å®ƒä½¿ç”¨äº† [k8s.io/apimachinery/pkg](https://github.com/kubernetes/apimachinery/tree/master/pkg) ä¸­çš„è®¸å¤šä»£ç åŒ…ï¼Œä½¿å…¶æˆä¸º Kubernetes åº”ç”¨ç¨‹åºå¼€å‘çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ã€‚

å¦‚æœä½ æƒ³å­¦ä¹  [k8s.io/apimachinery/pkg](https://github.com/kubernetes/apimachinery/tree/master/pkg) æˆ– [sigs.k8s.io/controller-runtime](https://github.com/kubernetes-sigs/controller-runtime) ï¼Œä½ å¯ä»¥æŸ¥çœ‹å®ƒä»¬çš„ GitHub å­˜å‚¨åº“ï¼Œå¹¶é˜…è¯»å…¶æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç ã€‚åœ¨è¿™äº›åº“ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°è®¸å¤šæœ‰ç”¨çš„åŠŸèƒ½å’Œå·¥å…·ï¼Œç”¨äºå¤„ç† Kubernetes å¯¹è±¡å¹¶æ„å»º Kubernetes åº”ç”¨ç¨‹åºã€‚

[k8s.io/apimachinery/pkg](https://github.com/kubernetes/apimachinery/tree/master/pkg) æ˜¯ Kubernetes çš„æ ¸å¿ƒåº“ä¹‹ä¸€ï¼Œæä¾›äº†è®¸å¤šç”¨äºå¤„ç† Kubernetes å¯¹è±¡å’Œèµ„æºçš„ Go ä»£ç åŒ…ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„æ–¹æ³•ï¼š

+ `runtime.NewScheme()`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ `Scheme` å¯¹è±¡ï¼Œç”¨äºç®¡ç† Kubernetes API å¯¹è±¡çš„ç±»å‹å’Œç‰ˆæœ¬ã€‚
+ `runtime.NewObject()`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Kubernetes å¯¹è±¡ã€‚
+ `runtime.ObjectConvertor`ï¼šæä¾›äº†å°† Kubernetes å¯¹è±¡è½¬æ¢ä¸ºä¸åŒæ ¼å¼çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSON æˆ– YAML æ ¼å¼ã€‚
+ `NewClient()`ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Kubernetes å®¢æˆ·ç«¯ï¼Œç”¨äºä¸ Kubernetes API äº¤äº’ã€‚
+ `meta.Accessor`ï¼šæä¾›äº†è®¿é—® Kubernetes å¯¹è±¡å…ƒæ•°æ®çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬è·å–å¯¹è±¡åç§°ã€å‘½åç©ºé—´å’Œæ ‡ç­¾ã€‚
+ `labels.Selector`ï¼šæä¾›äº†ä¸€ç§ç”¨äºé€‰æ‹© Kubernetes å¯¹è±¡çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨æ¥è¿‡æ»¤å’ŒæŸ¥è¯¢ Kubernetes å¯¹è±¡ã€‚

æ€»ä¹‹ï¼Œ[k8s.io/apimachinery/pkg](https://github.com/kubernetes/apimachinery/tree/master/pkg) åº“æä¾›äº†è®¸å¤šæœ‰ç”¨çš„å·¥å…·å’ŒåŠŸèƒ½ï¼Œç”¨äºå¤„ç† Kubernetes å¯¹è±¡å’Œæ„å»º Kubernetes åº”ç”¨ç¨‹åºã€‚å¦‚æœä½ æƒ³å­¦ä¹ æ›´å¤šå…³äºè¯¥åº“çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹å…¶ GitHub å­˜å‚¨åº“å¹¶é˜…è¯»å…¶æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç ã€‚



## context

Context æ˜¯ Goè¯­è¨€ ä¸­ç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´æ•°æ®çš„æ ‡å‡†æ–¹æ³•ã€‚å®ƒå¯ä»¥åœ¨ç¨‹åºçš„å¤šä¸ª Goroutine ä¸­ä¼ é€’æ•°æ®ï¼Œå¹¶ä¸”æ”¯æŒè¶…æ—¶ã€å–æ¶ˆæ“ä½œï¼Œä»¥åŠè¯·æ±‚ä½œç”¨åŸŸå†…å€¼çš„å­˜å‚¨å’Œæ£€ç´¢ã€‚Context æ˜¯ Goè¯­è¨€ å¹¶å‘ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œç‰¹åˆ«æ˜¯åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ã€‚

Context æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®ƒå®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼š

1. Done() <-chan struct{}ï¼šè¿”å›ä¸€ä¸ªåªè¯»çš„ channelï¼Œå½“ Context è¢«å–æ¶ˆæˆ–è¶…æ—¶æ—¶ï¼Œè¯¥ channel ä¼šè¢«å…³é—­ã€‚
2. Err() errorï¼šè¿”å› Context æ˜¯å¦è¢«å–æ¶ˆæˆ–è¶…æ—¶çš„åŸå› ã€‚
3. Deadline() (deadline time.Time, ok bool)ï¼šè¿”å› Context çš„è¶…æ—¶æ—¶é—´å’Œæ˜¯å¦è®¾ç½®è¿‡è¶…æ—¶æ—¶é—´ã€‚
4. Value(key interface{}) interface{}ï¼šè¿”å›ä¸æŒ‡å®šé”®å…³è”çš„å€¼ï¼Œå¦‚æœè¯¥é”®ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› nilã€‚

åœ¨ Goè¯­è¨€ ä¸­ï¼ŒContext å¯ä»¥é€šè¿‡ WithCancelã€WithDeadlineã€WithTimeout å’Œ WithValue å‡½æ•°æ¥åˆ›å»ºã€‚å…¶ä¸­ï¼ŒWithCancel å¯ä»¥ç”¨æ¥å–æ¶ˆ Contextï¼ŒWithDeadline å’Œ WithTimeout å¯ä»¥è®¾ç½® Context çš„è¶…æ—¶æ—¶é—´ï¼ŒWithValue å¯ä»¥åœ¨ Context ä¸­å­˜å‚¨å’Œæ£€ç´¢è¯·æ±‚ä½œç”¨åŸŸå†…çš„å€¼ã€‚

ä½¿ç”¨ Context çš„ä¸»è¦å¥½å¤„æ˜¯å¯ä»¥æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†ç¨‹åºåœ¨å¹¶å‘æ‰§è¡Œæ—¶çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§ã€‚åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼ŒContext è¿˜å¯ä»¥ç”¨äºä¼ é€’è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚è¯·æ±‚ IDã€ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚

æ€»ä¹‹ï¼ŒContext æ˜¯ Goè¯­è¨€ å¹¶å‘ç¼–ç¨‹ä¸­å¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥è®©ç¨‹åºåœ¨å¹¶å‘æ‰§è¡Œæ—¶æ›´åŠ å®‰å…¨ã€å¯é å’Œé«˜æ•ˆã€‚



### context.Background()

context.Background() å‡½æ•°è¿”å›ä¸€ä¸ªç©ºçš„ Contextï¼Œé€šå¸¸ç”¨ä½œçˆ¶ Contextã€‚å½“ä¸€ä¸ª Goroutine åˆ›å»ºæ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçˆ¶ Contextï¼Œå°±å¯ä»¥ä½¿ç”¨ `context.Background()`ã€‚åœ¨å¤šä¸ª Goroutine ä¸­ä½¿ç”¨åŒä¸€ä¸ª Context å¯ä»¥ä¿è¯å®ƒä»¬ä¹‹é—´èƒ½å¤ŸååŒå·¥ä½œï¼Œè€Œä¸ä¼šå‡ºç°ç«äº‰æ¡ä»¶å’Œèµ„æºå†²çªç­‰é—®é¢˜ã€‚

```go
package main

import (
    "context"
    "fmt"
    "time"
)

func main() {
    // åˆ›å»ºä¸€ä¸ªç©ºçš„ Context
    ctx := context.Background()

    // åœ¨ Goroutine ä¸­ä½¿ç”¨ WithValue è®¾ç½®é”®å€¼å¯¹
    ctx = context.WithValue(ctx, "hello", "world")

    // åœ¨ Goroutine ä¸­ä½¿ç”¨ WithCancel å–æ¶ˆ Context
    cancelCtx, cancel := context.WithCancel(ctx)
    go func() {
        defer fmt.Println("Goroutine canceled")
        select {
        case <-time.After(2 * time.Second):
            fmt.Println("Goroutine finished")
        case <-cancelCtx.Done():
            fmt.Println("Goroutine canceled")
        }
    }()

    // åœ¨ä¸» Goroutine ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´åå–æ¶ˆ Context
    time.Sleep(1 * time.Second)
    cancel()

    // åœ¨ä¸» Goroutine ä¸­è¾“å‡º Context ä¸­çš„å€¼
    fmt.Println(ctx.Value("hello"))

    // åœ¨ä¸» Goroutine ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´åè¾“å‡º Done channel çš„çŠ¶æ€
    select {
    case <-ctx.Done():
        fmt.Println("Context canceled")
    case <-time.After(3 * time.Second):
        fmt.Println("Context not canceled")
    }
}
```

è¾“å‡ºï¼š

```
world
Goroutine canceled
Context canceled
```

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªç©ºçš„ Contextï¼Œå¹¶ä½¿ç”¨ WithValue åœ¨å…¶ä¸­å­˜å‚¨é”®å€¼å¯¹ã€‚ç„¶åï¼Œä½¿ç”¨ WithCancel åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„ Contextï¼Œå¹¶åœ¨ä¸€ä¸ª Goroutine ä¸­ç­‰å¾…ä¸€æ®µæ—¶é—´åè¾“å‡ºç»“æœã€‚ä¸» Goroutine åœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´åå–æ¶ˆ Contextï¼Œç„¶åè¾“å‡ºå­˜å‚¨åœ¨ Context ä¸­çš„å€¼ï¼Œæœ€åç­‰å¾…ä¸€æ®µæ—¶é—´åè¾“å‡º Done channel çš„çŠ¶æ€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Goroutine ä¸­ä½¿ç”¨ cancelCtx.Done() å¯ä»¥æ£€æµ‹åˆ° Context è¢«å–æ¶ˆçš„çŠ¶æ€ï¼Œè€Œä¸» Goroutine ä¸­çš„ ctx.Done() ä¹Ÿå¯ä»¥æ£€æµ‹åˆ°ç›¸åŒçš„çŠ¶æ€ã€‚





## END é“¾æ¥
<ul><li><div><a href = '33.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '35.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
