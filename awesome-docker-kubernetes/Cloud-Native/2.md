+ [author](http://nsddd.top)

# ç¬¬2èŠ‚ ç¬¬äºŒé˜¶æ®µ

<br>

<div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>

<br>

> â¤ï¸ğŸ’•ğŸ’•è®°å½•[sealos](https://github.com/3293172751/sealos)å¼€æºé¡¹ç›®çš„å­¦ä¹ è¿‡ç¨‹ã€‚[k8s,dockerå’Œäº‘åŸç”Ÿçš„å­¦ä¹ ](https://github.com/3293172751/sealos)ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---

[TOC]

## å…³äºsealosæ­å»ºk8s

+ [x] [æ–‡æ¡£åœ°å€](https://docker.nsddd.top/Cloud-Native-k8s/6.html)



## å…³äºsealos

![image-20221023205145184](http://sm.nsddd.top/smimage-20221023205145184.png)





::: tip sealoså°±æ˜¯ï¼Ÿ
sealos æ˜¯ç”¨æ¥ç®¡ç†æ•°æ®ä¸­å¿ƒæ‰€æœ‰æœºå™¨çš„äº‘æ“ä½œç³»ç»Ÿï¼Œkubernetes å°±æ˜¯è¿™ä¸ªæ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œsealosä¸Š é¢ä¼šè·‘å„ç§å„æ ·çš„åˆ†å¸ƒå¼åº”ç”¨ã€‚

+ æ—©æœŸå•æœºæ“ä½œç³»ç»Ÿä¹Ÿæ˜¯åˆ†å±‚æ¶æ„ï¼Œåé¢æ‰æ¼”åŒ–æˆä»Šå¤©çš„å®å†…æ ¸å¾®å†…æ ¸æ¶æ„ï¼Œäº‘æ“ä½œç³»ç»Ÿä¹Ÿä¸€å®šä¼šæœ‰ç±»ä¼¼å‘å±•è¶‹åŠ¿ã€‚
+ ä»¥å‰éƒ½æ˜¯å•æœºåº”ç”¨ï¼Œè€Œç°ä»£åº”ç”¨å‡ ä¹éƒ½æ˜¯åˆ†å¸ƒå¼åº”ç”¨ï¼Œkubernetes å·²ç»æˆä¸ºäº‹å®ä¸Šçš„â€œäº‘æ“ä½œç³»ç»Ÿå†…æ ¸â€ï¼Œèƒ½è®©å†…æ ¸æ™®åŠçš„å‘å‹ç‰ˆå‘¼ä¹‹æ¬²å‡ºã€‚
+ sealos æŠ›å¼ƒäº† IaaS, åŸºäºäº‘å†…æ ¸çš„é«˜å†…èšè®¾è®¡ï¼Œå†³å®šäº† sealos å¯ä»¥è®©äº‘æ›´ç®€å•ï¼Œæ›´ä¾¿å®œï¼Œä»è€Œåƒ linux å‘è¡Œç‰ˆä¸€æ ·æ™®åŠã€‚

:::



## è§£å†³æ–¹æ¡ˆ

![image-20221023205623196](http://sm.nsddd.top/smimage-20221023205623196.png)

> æä¾›ä¸€ä¸ªå¼€æºå¼€æ”¾çš„äº‘æ“ä½œç³»ç»Ÿï¼Œåˆ©ç”¨äº‘åŸç”Ÿçš„èƒ½åŠ›åšä¸€ä¸ªç›®å‰äº‘å‚å•†çš„å¯æ›¿ä»£å“

+ å¼€æº sealosï¼Œæä¾›å‡ºä¸€ä¸ªæŠ½è±¡çš„äº‘æ“ä½œç³»ç»Ÿï¼Œä¸€åˆ‡çš†åº”ç”¨çš„è®¾è®¡ç†å¿µã€‚
+ sealos cloud - ç¯ç•Œè‡ªå·±è¿è¡Œçš„ sealos å…¬æœ‰äº‘ç‰ˆæœ¬ï¼ŒæœåŠ¡èƒ½åŠ›å¯¹æ ‡ aws é˜¿é‡Œäº‘ç­‰å…¬æœ‰äº‘
+ ç”¨æˆ·è‡ªç”±ä¸‹è½½ç¤¾åŒºç‰ˆæˆ–å•†ä¸šç‰ˆæœ¬ sealosï¼Œåœ¨ä»»æ„åœ°æ–¹å¯åŠ¨ä¸€ä¸ªå±äºè‡ªå·±çš„ `sealos cloud`

> åˆ†å¸ƒå¼åº”ç”¨ç”Ÿæ€æ„å»º

+ å¹¿åº¦ï¼Œå¸¸ç”¨åˆ†å¸ƒå¼è½¯ä»¶å¦‚ `mysql` é›†ç¾¤ï¼Œ`redis` é›†ç¾¤ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰é€æ­¥è¦†ç›–ï¼Œä¸æ–­æ‰©å±•å¸¸ç”¨åˆ†å¸ƒå¼åº”ç”¨æ•°é‡
+ æ·±åº¦ï¼Œ`åŸºæœ¬å®‰è£… -> é«˜å¯ç”¨ -> å¯ç›‘æ§ -> è‡ªè¿ç»´ -> é«˜æ€§èƒ½ / å®‰å…¨æ€§ -> GUIç®¡æ§`ï¼Œå…­ä¸ªé˜¶æ®µè¡¡é‡ä¸€ä¸ªåˆ†å¸ƒå¼åº”ç”¨æˆç†Ÿåº¦

åº”ç”¨åŒ…å«ä¸‰ä¸ªæ¥æºï¼šç¯ç•Œè‡ªç ”åº”ç”¨å¦‚å‡½æ•°è®¡ç®—ï¼Œå¼€æºäºŒæ¬¡å°è£…åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å¦‚ä¸è®¯é£åˆä½œçš„ AI èƒ½åŠ›åº”ç”¨ä¸ `sealos` ç»“åˆã€‚



## è¿è¡Œä¹‹å

::: warning æ³¨æ„
ä½ è¿è¡Œèµ·æ¥çš„å¯ä»¥ä¸æ˜¯`kubernetes`ï¼Œå¯ä»¥æ˜¯ä¸ª `k0s` æˆ–è€…æ˜¯ `k3s`

```bash
#å•ä¸»æœº
$ sealos run labring/kubernetes:v1.25.0 labring/helm:v3.8.2 labring/calico:v3.24.1 --single
# remove taint
$ kubectl taint node --all node-role.kubernetes.io/control-plane-
```

:::



::: danger ä½¿ç”¨ docker ä½œä¸º run labring
é»˜è®¤æ˜¯ä½¿ç”¨`kubernetes`

```bash
sealos run labring/kubernetes-docker:v1.20.5-4.1.3 labring/calico:v3.24.1 \
     --masters 192.168.64.2,192.168.64.22,192.168.64.20 \
     --nodes 192.168.64.21,192.168.64.19 -p [your-ssh-passwd]
```

:::



æˆ‘ä»¬å¯ä»¥åœ¨ `sealos` ä¸Šé¢è¿è¡Œå¯¹è±¡å­˜å‚¨ã€ç½‘å…³ã€æ•°æ®åº“ç­‰ç­‰ä¸œè¥¿ï¼Œéƒ½å¯ä»¥é€šè¿‡`sealos run` ä¸€é”®åœ¨äº‘æ“ä½œç³»ç»Ÿä¸Šé¢`run`èµ·æ¥ã€‚

> docker é•œåƒæœ¬è´¨æ˜¯ä¸€å †æ–‡ä»¶ç»„æˆï¼Œé€šè¿‡ `commit` æˆ–è€… `dockerfile` ä¸€å±‚å±‚å åŠ ï¼Œè€Œ `sealos run` å¯ä»¥ `run` æ•´ä¸ªé›†ç¾¤é•œåƒï¼Œä¸ç®¡æ˜¯ `Kubernetes` é›†ç¾¤ï¼Œ `Mysql` é›†ç¾¤ï¼Œ è¿˜æ˜¯ `Redis` é›†ç¾¤ã€‚`sealos build` å¯ä»¥ build æ•´ä¸ªé›†ç¾¤ã€‚
>
> + `docker` æ•°æ®ä¸­å¿ƒä½œä¸ºæ•´ä½“ï¼ˆrunå•æœºæ“ä½œç³»ç»Ÿï¼‰
> + `kubernetes` ä½œä¸ºæ“ä½œç³»ç»Ÿ 
> + `sealos run` å‡ºæ¥çš„éƒ½æ˜¯é›†ç¾¤çš„ï¼Œè¿è¡Œåœ¨ `kubernetes` ä¸Š

```bash
sealos run labring/helm:v3.8.2 # install helm
sealos run labring/openebs:v1.9.0 # install openebs
sealos run labring/minio-operator:v4.4.16 labring/ingress-nginx:4.1.0 \
   labring/mysql-operator:8.0.23-14.1 labring/redis-operator:3.1.4 # oneliner
```

> `labring/ingress-nginx`ï¼šè¡¨ç¤ºçš„æ˜¯é›†ç¾¤é•œåƒï¼Œä»–ä»¬æ˜¯å¦‚ä½•è¢«æ‰“åŒ…çš„å‘¢ï¼Ÿ
>
> è¿™ä¸ªæ—¶å€™æ¶‰åŠåˆ°äº† [build an Exmple Cloudmage](https://www.sealos.io/docs/getting-started/build-example-cloudimage)



::: details ä»€ä¹ˆæ—¶å€™éœ€è¦é›†ç¾¤é•œåƒ
ç”¨æˆ·å¸Œæœ›å¾—åˆ°ä¸€ä¸ªé›†ç¾¤

sealos ä¸ä¼šè®°å½•å¯åŠ¨çš„å®ä¾‹åç§°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å‚æ•°æ¥è®°å½•ä¸‹æ¥ã€‚

:::



### æ„å»ºé•œåƒ

ä¸‹é¢ä»‹ç»å¦‚ä½•ä½¿ç”¨ `helm` æ„å»º `nginx`-å…¥å£ç¾¤é›†æ˜ åƒã€‚

> `helm` æœ€æ ¸å¿ƒçš„é—®é¢˜æ˜¯ï¼šæ¨¡æ¿æ¸²æŸ“ï¼Œ`sealos` å¯ä»¥é€‰æ‹© `helm` ã€‚



::: details helmä»‹ç»
helmçš„å®˜ç½‘æ–‡æ¡£åœ°å€ï¼š

+ [æ–‡æ¡£åœ°å€](https://docker.nsddd.top/Cloud-Native-k8s/15.html)

**Helm æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿ**

Helm æ˜¯ Kubernetes çš„åŒ…ç®¡ç†å™¨ã€‚åŒ…ç®¡ç†å™¨ç±»ä¼¼äºæˆ‘ä»¬åœ¨ Ubuntu ä¸­ä½¿ç”¨çš„aptã€Centosä¸­ä½¿ç”¨çš„yum æˆ–è€…Pythonä¸­çš„ pip ä¸€æ ·ï¼Œèƒ½å¿«é€ŸæŸ¥æ‰¾ã€ä¸‹è½½å’Œå®‰è£…è½¯ä»¶åŒ…ã€‚Helm ç”±å®¢æˆ·ç«¯ç»„ä»¶ helm å’ŒæœåŠ¡ç«¯ç»„ä»¶ Tiller ç»„æˆ, èƒ½å¤Ÿå°†ä¸€ç»„K8Sèµ„æºæ‰“åŒ…ç»Ÿä¸€ç®¡ç†, æ˜¯æŸ¥æ‰¾ã€å…±äº«å’Œä½¿ç”¨ä¸ºKubernetesæ„å»ºçš„è½¯ä»¶çš„æœ€ä½³æ–¹å¼ã€‚

**Helm è§£å†³äº†ä»€ä¹ˆç—›ç‚¹ï¼Ÿ**

åœ¨ Kubernetesä¸­éƒ¨ç½²ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„åº”ç”¨ï¼Œéœ€è¦æ¶‰åŠåˆ°å¾ˆå¤šçš„ Kubernetes èµ„æºçš„å…±åŒåä½œã€‚æ¯”å¦‚ä½ å®‰è£…ä¸€ä¸ª WordPress åšå®¢ï¼Œç”¨åˆ°äº†ä¸€äº› Kubernetes (ä¸‹é¢å…¨éƒ¨ç®€ç§°k8s)çš„ä¸€äº›èµ„æºå¯¹è±¡ï¼ŒåŒ…æ‹¬ Deployment ç”¨äºéƒ¨ç½²åº”ç”¨ã€Service æä¾›æœåŠ¡å‘ç°ã€Secret é…ç½® WordPress çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå¯èƒ½è¿˜éœ€è¦ pv å’Œ pvc æ¥æä¾›æŒä¹…åŒ–æœåŠ¡ã€‚å¹¶ä¸” WordPress æ•°æ®æ˜¯å­˜å‚¨åœ¨mariadbé‡Œé¢çš„ï¼Œæ‰€ä»¥éœ€è¦ mariadb å¯åŠ¨å°±ç»ªåæ‰èƒ½å¯åŠ¨ WordPressã€‚è¿™äº› k8s èµ„æºè¿‡äºåˆ†æ•£ï¼Œä¸æ–¹ä¾¿è¿›è¡Œç®¡ç†ï¼Œç›´æ¥é€šè¿‡ kubectl æ¥ç®¡ç†ä¸€ä¸ªåº”ç”¨ï¼Œä½ ä¼šå‘ç°è¿™ååˆ†è›‹ç–¼ã€‚

 æ‰€ä»¥æ€»ç»“ä»¥ä¸Šï¼Œæˆ‘ä»¬åœ¨ `k8s` ä¸­éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ï¼Œé€šå¸¸é¢ä¸´ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

+ å¦‚ä½•ç»Ÿä¸€ç®¡ç†ã€é…ç½®å’Œæ›´æ–°è¿™äº›åˆ†æ•£çš„ `k8s` çš„åº”ç”¨èµ„æºæ–‡ä»¶
+ å¦‚ä½•åˆ†å‘å’Œå¤ç”¨ä¸€å¥—åº”ç”¨æ¨¡æ¿
+ å¦‚ä½•å°†åº”ç”¨çš„ä¸€ç³»åˆ—èµ„æºå½“åšä¸€ä¸ªè½¯ä»¶åŒ…ç®¡ç†

**Helm ç›¸å…³ç»„ä»¶åŠæ¦‚å¿µï¼š**

Helm åŒ…å«ä¸¤ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ helm å®¢æˆ·ç«¯ å’Œ Tiller æœåŠ¡å™¨ï¼š

+ **helm** æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºæœ¬åœ°å¼€å‘åŠç®¡ç†`chart`ï¼Œ`chart`ä»“åº“ç®¡ç†ç­‰
+ **Tiller** æ˜¯ `Helm` çš„æœåŠ¡ç«¯ã€‚`Tiller` è´Ÿè´£æ¥æ”¶ `Helm` çš„è¯·æ±‚ï¼Œä¸ `k8s` çš„ `apiserver` äº¤äº’ï¼Œæ ¹æ®`chart` æ¥ç”Ÿæˆä¸€ä¸ª `release` å¹¶ç®¡ç† `release`
+ **chart** Helmçš„æ‰“åŒ…æ ¼å¼å«åš`chart`ï¼Œæ‰€è°“ `chart` å°±æ˜¯ä¸€ç³»åˆ—æ–‡ä»¶, å®ƒæè¿°äº†ä¸€ç»„ç›¸å…³çš„ `k8s` é›†ç¾¤èµ„æº
+ **release** ä½¿ç”¨ `helm install` å‘½ä»¤åœ¨ `Kubernetes` é›†ç¾¤ä¸­éƒ¨ç½²çš„ `Chart` ç§°ä¸º `Release`
+ `Repoistory Helm chart` çš„ä»“åº“ï¼Œ`Helm` å®¢æˆ·ç«¯é€šè¿‡ `HTTP` åè®®æ¥è®¿é—®å­˜å‚¨åº“ä¸­ `chart` çš„ç´¢å¼•æ–‡ä»¶å’Œå‹ç¼©åŒ…

:::



**Helm åŸç†ï¼š**

ä¸‹é¢ä¸¤å¼ å›¾æè¿°äº† Helm çš„å‡ ä¸ªå…³é”®ç»„ä»¶ Helmï¼ˆå®¢æˆ·ç«¯ï¼‰ã€Tillerï¼ˆæœåŠ¡å™¨ï¼‰ã€Repositoryï¼ˆChart è½¯ä»¶ä»“åº“ï¼‰ã€Chartï¼ˆè½¯ä»¶åŒ…ï¼‰ä¹‹é—´çš„å…³ç³»ä»¥åŠå®ƒä»¬ä¹‹é—´å¦‚ä½•é€šä¿¡ã€‚

![image-20221023214555169](http://sm.nsddd.top/smimage-20221023214555169.png)

**helm ç»„ä»¶é€šä¿¡ï¼š**

![image-20221023214604275](http://sm.nsddd.top/smimage-20221023214604275.png)



**helm æ¶æ„**

**åˆ›å»ºreleaseï¼š**

+ `helm` å®¢æˆ·ç«¯ä»æŒ‡å®šçš„ç›®å½•æˆ–æœ¬åœ° `tar` æ–‡ä»¶æˆ–è¿œç¨‹ `repo` ä»“åº“è§£æå‡º `chart` çš„ç»“æ„ä¿¡æ¯
+ `helm` å®¢æˆ·ç«¯æŒ‡å®šçš„ `chart` ç»“æ„å’Œ `values` ä¿¡æ¯é€šè¿‡ `gRPC` ä¼ é€’ç»™ `Tiller`
+ `Tiller` æœåŠ¡ç«¯æ ¹æ® `chart` å’Œ `values` ç”Ÿæˆä¸€ä¸ª `release`
+ `Tiller` å°† `install release` è¯·æ±‚ç›´æ¥ä¼ é€’ç»™ `kube-apiserver`

**åˆ é™¤releaseï¼š**

+ `helm` å®¢æˆ·ç«¯ä»æŒ‡å®šçš„ç›®å½•æˆ–æœ¬åœ° `tar` æ–‡ä»¶æˆ–è¿œç¨‹ `repo` ä»“åº“è§£æå‡º `chart` çš„ç»“æ„ä¿¡æ¯
+ `helm` å®¢æˆ·ç«¯æŒ‡å®šçš„ `chart` ç»“æ„å’Œ `values` ä¿¡æ¯é€šè¿‡ gRPC ä¼ é€’ç»™ Tiller
+ `Tiller` æœåŠ¡ç«¯æ ¹æ® `chart` å’Œ `values` ç”Ÿæˆä¸€ä¸ª `release`
+ `Tiller` å°† `delete release` è¯·æ±‚ç›´æ¥ä¼ é€’ç»™ `kube-apiserver`

**æ›´æ–°releaseï¼š**

+ `helm` å®¢æˆ·ç«¯å°†éœ€è¦æ›´æ–°çš„ `chart` çš„ `release` åç§° `chart` ç»“æ„å’Œ `value` ä¿¡æ¯ä¼ ç»™ `Tiller`
+ `Tiller` å°†æ”¶åˆ°çš„ä¿¡æ¯ç”Ÿæˆæ–°çš„ `release`ï¼Œå¹¶åŒæ—¶æ›´æ–°è¿™ä¸ª `release` çš„ `history`
+ `Tiller` å°†æ–°çš„ `release` ä¼ é€’ç»™ `kube-apiserver` è¿›è¡Œæ›´æ–°



### chart çš„åŸºæœ¬ç»“æ„

Helmçš„æ‰“åŒ…æ ¼å¼å«åšchartï¼Œæ‰€è°“`chart`å°±æ˜¯ä¸€ç³»åˆ—æ–‡ä»¶, å®ƒæè¿°äº†ä¸€ç»„ç›¸å…³çš„ k8s é›†ç¾¤èµ„æºã€‚Chartä¸­çš„æ–‡ä»¶å®‰è£…ç‰¹å®šçš„ç›®å½•ç»“æ„ç»„ç»‡, æœ€ç®€å•çš„ `chart` ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20221023214623073](http://sm.nsddd.top/smimage-20221023214623073.png)

chart ç»“æ„

+ `charts` ç›®å½•å­˜æ”¾ä¾èµ–çš„chart
+ `Chart.yaml` åŒ…å«Chartçš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬chartç‰ˆæœ¬ï¼Œåç§°ç­‰
+ `templates` ç›®å½•ä¸‹å­˜æ”¾åº”ç”¨ä¸€ç³»åˆ— k8s èµ„æºçš„ yaml æ¨¡æ¿
+ `_helpers.tpl` æ­¤æ–‡ä»¶ä¸­å®šä¹‰ä¸€äº›å¯é‡ç”¨çš„æ¨¡æ¿ç‰‡æ–­ï¼Œæ­¤æ–‡ä»¶ä¸­çš„å®šä¹‰åœ¨ä»»ä½•èµ„æºå®šä¹‰æ¨¡æ¿ä¸­å¯ç”¨
+ `NOTES.txt` ä»‹ç»chart éƒ¨ç½²åçš„å¸®åŠ©ä¿¡æ¯ï¼Œå¦‚ä½•ä½¿ç”¨chartç­‰
+ `values.yaml` åŒ…å«äº†å¿…è¦çš„å€¼å®šä¹‰ï¼ˆé»˜è®¤å€¼ï¼‰, ç”¨äºå­˜å‚¨ templates ç›®å½•ä¸­æ¨¡æ¿æ–‡ä»¶ä¸­ç”¨åˆ°å˜é‡çš„å€¼



**å®‰è£…Helmï¼š**

Helm æä¾›äº†å‡ ç§å®‰è£…æ–¹å¼ï¼Œæœ¬æ–‡æä¾›ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œæƒ³è¦æŸ¥çœ‹æ›´å¤šå®‰è£…æ–¹å¼ï¼Œè¯·é˜…è¯» Helm çš„[å®˜æ–¹æ–‡æ¡£](https://links.jianshu.com/go?to=https%3A%2F%2Fdocs.helm.sh%2Fusing_helm%2F%23installing-helm)ï¼š

+ æ‰‹åŠ¨å®‰è£…æ–¹å¼

```ruby
$ ä¸‹è½½ Helm äºŒè¿›åˆ¶æ–‡ä»¶
$ wget https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz
$ è§£å‹ç¼©
$ tar -zxvf helm-v2.9.1-linux-amd64.tar.gz
$ å¤åˆ¶ helm äºŒè¿›åˆ¶ åˆ°binç›®å½•ä¸‹
$cp linux-amd64/helm /usr/local/bin/
```

+ ä½¿ç”¨å®˜æ–¹æä¾›çš„è„šæœ¬ä¸€é”®å®‰è£…

```ruby
$ curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get > get_helm.sh
$ chmod 700 get_helm.sh
$ ./get_helm.sh
```

> ä½ è¿˜å¯ä»¥é€šè¿‡ Helm çš„ [github](https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Fhelm%2Fhelm%2Freleases) é¡¹ç›®ä¸‹æ‰¾åˆ°ä½ æƒ³è¦çš„ Helm ç‰ˆæœ¬çš„äºŒè¿›åˆ¶ï¼Œç„¶åé€šè¿‡æ‰‹åŠ¨å®‰è£…æ–¹å¼ä¸€æ ·å®‰è£…å³å¯
>
> **å›½å†…é•œåƒåŠ é€Ÿä¸‹è½½ï¼š**
>
> ```bash
> wget https://mirrors.huaweicloud.com/helm/v3.9.2/helm-v3.9.2-linux-386.tar.gz && tar -zxvf helm-v3.9.2-linux-386.tar.gz && cp  linux-386/helm /usr/local/bin/ && helm version
> ```



**å®‰è£… Tillerï¼š**

å®‰è£…å¥½ helm å®¢æˆ·ç«¯åï¼Œå°±å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å°† Tiller å®‰è£…åœ¨ kubernetes é›†ç¾¤ä¸­ï¼š

```kotlin
helm init
```

è¿™ä¸ªåœ°æ–¹é»˜è®¤ä½¿ç”¨ â€œ[https://kubernetes-charts.storage.googleapis.com](https://links.jianshu.com/go?to=https%3A%2F%2Fkubernetes-charts.storage.googleapis.com)â€ ä½œä¸ºç¼ºçœçš„ stable repository çš„åœ°å€ï¼Œä½†ç”±äºå›½å†…æœ‰ä¸€å¼ æ— å½¢çš„å¢™çš„å­˜åœ¨ï¼Œ[googleapis.com](https://links.jianshu.com/go?to=http%3A%2F%2Fgoogleapis.com) æ˜¯ä¸èƒ½è®¿é—®çš„ã€‚å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„æºæ¥é…ç½®ï¼š

```kotlin
helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.9.1  --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
```

æ‰§è¡Œä¸Šé¢å‘½ä»¤åï¼Œå¯ä»¥é€šè¿‡ `kubectl get po -n kube-system` æ¥æŸ¥çœ‹ `tiller` çš„å®‰è£…æƒ…å†µã€‚

ç”±äº `kubernetes` ä»1.6 ç‰ˆæœ¬å¼€å§‹åŠ å…¥äº† `RBAC` æˆæƒã€‚å½“å‰çš„ `Tiller` æ²¡æœ‰å®šä¹‰ç”¨äºæˆæƒçš„ `ServiceAccount`ï¼Œ è®¿é—® `API Server` æ—¶ä¼šè¢«æ‹’ç»ï¼Œéœ€è¦ç»™ `Tiller` åŠ å…¥æˆæƒã€‚

+ åˆ›å»º `Kubernetes` çš„æœåŠ¡å¸å·å’Œç»‘å®šè§’è‰²

```ruby
$ kubectl create serviceaccount --namespace kube-system tiller                               
serviceaccount "tiller" created

$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
clusterrolebinding.rbac.authorization.k8s.io "tiller-cluster-rule" created
```

+ ç»™ `Tiller` çš„ `deployments` æ·»åŠ åˆšæ‰åˆ›å»ºçš„ `ServiceAccount`

```rust
# ç»™ Tiller çš„ deployments æ·»åŠ åˆšæ‰åˆ›å»ºçš„ ServiceAccount
$ kubectl patch deploy --namespace kube-system tiller-deploy -p '{"spec":{"template":{"spec":{"serviceAccount":"tiller"}}}}'
deployment.extensions "tiller-deploy" patched
```

+ æŸ¥çœ‹ `Tiller deployments` èµ„æºæ˜¯å¦ç»‘å®š `ServiceAccount`

```csharp
$ kubectl get deploy -n kube-system tiller-deploy -o yaml | grep serviceAccount
serviceAccount: tiller
serviceAccountName: tiller
```

+ æŸ¥çœ‹ `Tiller` æ˜¯å¦å®‰è£…æˆåŠŸ

```ruby
$ helm version 
Client: &version.Version{SemVer:"v2.9.1", GitCommit:"20adb27c7c5868466912eebdf6664e7390ebe710", GitTreeState:"clean"}
Server: &version.Version{SemVer:"v2.9.1", GitCommit:"20adb27c7c5868466912eebdf6664e7390ebe710", GitTreeState:"clean"}
```

å®‰è£…æˆåŠŸåï¼Œå³å¯ä½¿ç”¨ `helm install xxx` æ¥å®‰è£… `helm` åº”ç”¨ã€‚å¦‚æœéœ€è¦åˆ é™¤ `Tiller`ï¼Œå¯ä»¥é€šè¿‡ `kubectl delete deployment tiller-deploy --namespace kube-system`  æ¥åˆ é™¤ `Tiller` çš„ `deployment` æˆ–è€…ä½¿ç”¨ `helm reset` æ¥åˆ é™¤ã€‚

**ä½¿ç”¨ Helm æ“ä½œ Chartï¼š**

è¿™ä¸€èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ helm æ¥æ“ä½œ chartï¼ŒåŒ…æ‹¬åˆ›å»ºã€åˆ é™¤ã€æ‰“åŒ…ã€å®‰è£…ç­‰ä½¿ç”¨ã€‚

å…ˆä»‹ç»ä¸€ä¸‹ Helm çš„æ ¸å¿ƒå‘½ä»¤ï¼š

+ helm create åˆ›å»ºä¸€ä¸ª Chart æ¨¡æ¿

```bash
$ helm create test
Creating test
```

+ helm package æ‰“åŒ…ä¸€ä¸ª Chart æ¨¡æ¿

```bash
$ helm package test                                                                          
Successfully packaged chart and saved it to: /root/test-0.1.0.tgz
```

+ `helm search` æŸ¥æ‰¾å¯ç”¨çš„ Chart æ¨¡æ¿

```ruby
$ helm search nginx                                  
NAME                    CHART VERSION   APP VERSION DESCRIPTION
stable/nginx-ingress    0.9.5           0.10.2      An nginx Ingress controller that uses ConfigMap...
stable/nginx-lego       0.3.1                       Chart for nginx-ingress-controller and kube-lego
stable/gcloud-endpoints 0.1.0                       Develop, deploy, protect and monitor your APIs ...
```

+ `helm inspect` æŸ¥çœ‹æŒ‡å®š Chart çš„åŸºæœ¬ä¿¡æ¯

```yaml
apiVersion: v1
appVersion: "1.0"
description: A Helm chart for Kubernetes
name: test
version: 0.1.0

ç•¥...(çœç•¥ä¸€å¤§æ®µä¿¡æ¯ï¼‰
```

+ `helm install` æ ¹æ®æŒ‡å®šçš„ Chart éƒ¨ç½²ä¸€ä¸ª Release åˆ° Kubernetes é›†ç¾¤

**Chart æ–‡ä»¶ç»“æ„ï¼š**

```css
wordpress
â”œâ”€â”€ charts
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ README.md
â”œâ”€â”€ requirements.lock
â”œâ”€â”€ requirements.yaml
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ externaldb-secrets.yaml
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â”œâ”€â”€ pvc.yaml
â”‚   â”œâ”€â”€ secrets.yaml
â”‚   â”œâ”€â”€ svc.yaml
â”‚   â””â”€â”€ tls-secrets.yaml
â””â”€â”€ values.yaml
```

ä¸€ä¸ª wordpress chart å¦‚ä¸Šï¼ˆå»é™¤éƒ¨åˆ† test å’Œ charts ä¾èµ–ï¼‰ï¼Œ åŸºæœ¬ç»“æ„ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

+ charts å­˜æ”¾å­Chart (Subchart) çš„å®šä¹‰ï¼ŒSubchart æŒ‡çš„æ˜¯å½“å‰ Chart ä¾èµ–çš„ Chart ï¼Œ åœ¨ requirements.yaml ä¸­å®šä¹‰
+ Chart.yaml åŒ…å« Chart ä¿¡æ¯çš„ YAML æ–‡ä»¶ï¼Œ åŒ…æ‹¬ Chart çš„ç‰ˆæœ¬ã€åç§°ç­‰ï¼Œåœ¨ DCE Helm æ’ä»¶ä¸­è¿˜åŒ…å« Chart çš„ **å›¢é˜Ÿæˆæƒ** ä¿¡æ¯ å’Œ **æ˜¯å¦å…¬å¼€** çš„ä¿¡æ¯
+ README.md å¯é€‰ï¼šChart çš„ä»‹ç»ä¿¡æ¯ç­‰ï¼ˆè¯¥æ–‡ä»¶å¯¹äºä¸€ä¸ªå¤§å‹ Chart æ¥è¯´ååˆ†é‡è¦ï¼‰
+ `Requirements.yaml` å¯é€‰ï¼šåˆ—ä¸¾å½“å‰ Chart çš„éœ€è¦ä¾èµ–çš„ Chart
+ `templates`ï¼š
  + è¯¥ç›®å½•ä¸‹å­˜æ”¾ Chart æ‰€æœ‰çš„ K8s èµ„æºå®šä¹‰æ¨¡æ¿ï¼Œé€šå¸¸ä¸åŒçš„èµ„æºæ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼ŒDCE Helm æ’ä»¶ä¸­è‡ªå®šä¹‰æ¨¡æ¿çš„ K8s èµ„æºç»Ÿä¸€æ”¾åœ¨ all_sources.yaml æ–‡ä»¶ä¸­
  + _helpers.tpl ï¼Œ é€šå¸¸è¿™ä¸ªæ–‡ä»¶å­˜æ”¾å¯é‡ç”¨çš„æ¨¡æ¿ç‰‡æ®µï¼Œè¯¥æ–‡ä»¶ä¸­çš„å®šä¹‰å¯ä»¥åœ¨ Chart å…¶å®ƒèµ„æºå®šä¹‰æ¨¡æ¿ä¸­ä½¿ç”¨
  + NOTES.txtï¼Œå¯é€‰ï¼šä¸€æ®µç®€çŸ­ä½¿ç”¨è¯´æ˜çš„æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºå®‰è£… Release åæç¤ºç”¨æˆ·ä½¿ç”¨
+ values.yaml å½“å‰ Chart çš„é»˜è®¤é…ç½®çš„å€¼



### ç¼–å†™ä¸€ä¸ªç®€å•çš„ Chart ç¤ºä¾‹

æœ¬èŠ‚ä»¥æ„å»ºä¸€ä¸ªåç§°ä¸º `nginx-test Chart` ä¸ºç¤ºä¾‹ï¼Œæ¥æè¿°ä¸€ä¸ª `chart` å¿…è¦æ¡ä»¶ã€‚
 1ã€`Chart.yaml` æ–‡ä»¶æ˜¯ ä¸€ä¸ª `chart` å¿…è¦æ–‡ä»¶ï¼Œ è¯¥æ–‡ä»¶å¯ä»¥ç®€å•åŒ…æ‹¬ä»¥ä¸‹å­—æ®µï¼ˆå…·ä½“å­—æ®µè¯·å‚è€ƒ[Helmå®˜ç½‘](https://links.jianshu.com/go?to=https%3A%2F%2Fhelm.sh%2F))

```yaml
apiVersion: v1  (chart çš„APIç‰ˆæœ¬, æ€»æ˜¯"v1", å¿…è¦)
name: hello     (chart çš„åç§°, å¿…è¦)
version: 0.0.1  (chart çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬å¿…é¡»å¿…è¦éµå¾ª SemVer 2æ ‡å‡†)
description: A Helm chart for Kubernetes   (chart æ¨¡æ¿çš„ç®€ä»‹æè¿°)
...
ä¸‹é¢çœç•¥ä¸€äº›å­—æ®µï¼Œé»˜è®¤æƒ…å†µä¸‹æœ‰è¿™å‡ ä¸ªå­—æ®µå®šä¹‰å°±å¯ä»¥äº†
```

2ã€values.yaml æ–‡ä»¶æ˜¯ chart çš„å¿…è¦æ–‡ä»¶ï¼Œä»¥ nginx ä¸ºç¤ºä¾‹ï¼š

```yaml
# Default values for test.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.
replicaCount: 1

image:
  repository: nginx
  tag: stable
  pullPolicy: IfNotPresent
service:
  type: ClusterIP
  port: 80

ingress:
  enabled: false
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  path: /
  hosts:
    - chart-example.local
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #  cpu: 100m
  #  memory: 128Mi
  # requests:
  #  cpu: 100m
  #  memory: 128Mi

nodeSelector: {}

tolerations: []

affinity: {}
```

ä»ç¤ºä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œ`values.yaml` ä¸­å®šä¹‰äº†ä¸€äº›å½“å‰`chart` çš„ä¸€äº›é»˜è®¤å€¼ï¼Œç”¨äº `templates` ä¸‹çš„ K8s èµ„æº yaml æ¸²æŸ“æ—¶å¡«å……é»˜è®¤å€¼ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨ helm install æ¥éƒ¨ç½²ä¸€ä¸ª Release , å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŒ‡å®šä¸€ä»½yaml æ–‡ä»¶ä½œä¸ºå¡«å……å€¼ï¼š

```bash
$ helm install --values=myvals.yaml nginx
```

3ã€åˆ›å»º templates ä¸‹çš„æ¨¡æ¿æ–‡ä»¶ï¼Œ ç”¨äºç”Ÿæˆ `Kubernetes` èµ„æºæ¸…å•(manifests) å¦‚ä¸‹æ‰€ç¤º:

```yaml
# nginx-test/templates/deployments.yaml 
apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: {{ template "nginx-test.fullname" . }}
  labels:
    app: {{ template "nginx-test.name" . }}
    chart: {{ template "nginx-test.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: {{ template "nginx-test.name" . }}
      release: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ template "nginx-test.name" . }}
        release: {{ .Release.Name }}
    spec:
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
{{ toYaml .Values.resources | indent 12 }}
    {{- with .Values.nodeSelector }}
      nodeSelector:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.affinity }}
      affinity:
{{ toYaml . | indent 8 }}
    {{- end }}
    {{- with .Values.tolerations }}
      tolerations:
{{ toYaml . | indent 8 }}
    {{- end }}
    
# nginx-test/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ template "nginx-test.fullname" . }}
  labels:
    app: {{ template "nginx-test.name" . }}
    chart: {{ template "nginx-test.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http 
      protocol: TCP
      name: http
  selector:
    app: {{ template "nginx-test.name" . }}
    release: {{ .Release.Name }}
```

ä¸Šé¢å®šä¹‰äº† ä¸€ä¸ª `deployments.yaml` å’Œ `service.yaml` èµ„æºæ–‡ä»¶ï¼Œé‡Œé¢ä½¿ç”¨ `{{ }}` ç¬¦å·çš„æ˜¯ `Go` æ¨¡æ¿è¯­è¨€çš„æ ‡å‡†ã€‚å…¶ä¸­å¯ä»¥é€šè¿‡ï¼š

+ `.Values` å¯¹è±¡è®¿é—® `values.yaml` æ–‡ä»¶çš„å†…å®¹ï¼Œ å‰é¢çš„dot(.) è¡¨ç¤ºä»é¡¶å±‚å‘½åç©ºé—´å¼€å§‹ï¼Œæ‰¾åˆ° Values å¯¹è±¡(ä¸‹åŒ)
+ `.Release`ã€`.Chart` å¼€å¤´çš„é¢„å®šä¹‰å€¼å¯ç”¨äºä»»ä½•çš„æ¨¡æ¿ä¸­
+ `.Chart` å¯¹è±¡ç”¨æ¥è®¿é—® `Chart.yaml` æ–‡ä»¶çš„å†…å®¹
+ `.Release` å¯¹è±¡æ˜¯ Helmçš„å†…ç½®å¯¹è±¡ä¹‹ä¸€ï¼Œ ä½¿ç”¨ Helm å®‰è£…ä¸€ä¸ª release æ—¶ï¼Œç”± Tiller åˆ†é… release çš„åç§°

4ã€å‘½åæ¨¡æ¿(_helper.tpl) ï¼šå¯ä»¥ä»ä¸Šé¢çœ‹åˆ°æœ‰ `{{ template "nginx-test.fullname" . }}` å®šä¹‰ã€‚è¯¥å®šä¹‰ç”± `_helper.tpl` æ–‡ä»¶å®šä¹‰çš„å­—æ®µæ¥å®ç°ï¼Œæ¯”å¦‚ä¸‹é¢ä¸€ä¸ª `_helper.tpl`ï¼š

```yaml
{{/* vim: set filetype=mustache: */}}
{{/*
Expand the name of the chart.
*/}}
{{- define "nginx-test.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" -}}
{{- end -}}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.
*/}}
{{- define "nginx-test.fullname" -}}
{{- if .Values.fullnameOverride -}}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- $name := default .Chart.Name .Values.nameOverride -}}
{{- if contains $name .Release.Name -}}
{{- .Release.Name | trunc 63 | trimSuffix "-" -}}
{{- else -}}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" -}}
{{- end -}}
{{- end -}}
{{- end -}}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "nginx-test.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" -}}
{{- end -}}
```

è¯¥æ¨¡æ¿å®šä¹‰äº† "nginx-test.name"ã€"nginx-test.fullname"ã€"nginx-test.chart" ç­‰å¯é‡ç”¨æ¨¡æ¿éƒ¨åˆ†ï¼Œå½“æ¨¡æ¿å¼•æ“è¯»å–è¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå­˜å‚¨å¯¹ nginx-test.nameç­‰çš„å¼•ç”¨ï¼Œ ç›´åˆ°è°ƒç”¨ template "nginx-test.name" ä¸ºæ­¢ã€‚ç„¶åæŠŠå€¼æ¸²æŸ“åˆ°æ¨¡æ¿ä¸­ã€‚

æ³¨æ„ `{{ template "nginx-test.chart" . }}` åé¢æœ‰ä¸ª`dot(.)`ï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªå·²å‘½åçš„æ¨¡æ¿ï¼ˆç”¨äºåˆ›å»º `define`) è¢«æ¸²æŸ“æ—¶ï¼Œå®ƒå°†æ¥æ”¶ç”±è¯¥ `template` è°ƒç”¨ä¼ å…¥çš„èŒƒå›´`ï¼ˆscope)`ã€‚æ²¡æœ‰èŒƒå›´ä¼ å…¥ï¼Œåœ¨æ¨¡æ¿ä¸­æ— æ³•è®¿é—®ä»»ä½•å†…å®¹ï¼Œå› æ­¤åœ¨ï¼š

```yaml
{{- define "nginx-test.chart" -}}
è¿™é‡Œé¢çš„ .Chart å°†æ— æ³•è®¿é—®ï¼Œå¯¼è‡´åœ¨æ¨¡æ¿ä¸­æ— æ³•çœ‹åˆ°å†…å®¹ï¼Œå› ä¸ºè¿™é‡Œå€¼ä¸ºç©º
{{- end -}}
```

å› æ­¤åœ¨æ¨¡æ¿ä¸­å°† èŒƒå›´(scope) ä¼ å…¥å³å¯æ­£å¸¸ä½¿ç”¨ï¼š

```yaml
# nginx-test/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ template "nginx-test.fullname" . }}
  åœ¨æœ«å°¾ä¼ é€’äº† . è¿™æ ·å°±å¯ä»¥ä½¿ç”¨ .Values æˆ–è€… .Chart æˆ–å…¶å®ƒèŒƒå›´(scope)
```

5ã€Chart ä¾èµ–ï¼ˆrequirements.yaml)ï¼šæ¯”å¦‚ `WordPress Chart` ä¾èµ–äº mariadb Chartï¼Œ ä¸‹é¢æ˜¯ WordPress çš„ä¾èµ–(requirements.yaml)ï¼š

```yaml
dependencies:
- name: mariadb
  version: 5.x.x
  repository: https://kubernetes-charts.storage.googleapis.com/
  condition: mariadb.enabled
  tags:
    - wordpress-database
```

è¯¥æ–‡ä»¶åˆ—ä¸¾å½“å‰ Chart æ‰€æœ‰çš„ ä¾èµ–ï¼ˆsubchart)ã€‚æœ‰å‡ ä¸ªå­—æ®µæ˜¯å¿…è¦çš„ï¼š

+ name: ä¾èµ– Chart çš„åç§°ï¼ˆå¿…è¦ï¼‰
+ version: ä¾èµ– Chart çš„ç‰ˆæœ¬å·ï¼ˆå¿…è¦ï¼‰
+ repository: ä¾èµ– Chart çš„å­˜å‚¨åº“å®Œæ•´URLï¼Œå¿…é¡»é€šè¿‡ helm repo add æ·»åŠ  repositoryï¼ˆå­˜å‚¨åº“ï¼‰åˆ°æœ¬åœ°





## Clusterfileæ–‡ä»¶

> å½“æˆ‘ä»¬ä½¿ç”¨ `sealos` å¯åŠ¨ä¸€ä¸ªé›†ç¾¤é•œåƒçš„æ—¶å€™æˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ª `Clusterfile` æ–‡ä»¶ã€‚

```
root@VM-4-3-ubuntu:~/.sealos/default# cat Clusterfile 
```

::: details å±•å¼€

```yaml
root@VM-4-3-ubuntu:~/.sealos/default# cat Clusterfile 
apiVersion: apps.sealos.io/v1beta1
kind: Cluster
metadata:
  creationTimestamp: "2022-10-20T13:12:33Z"
  name: default
spec:
  hosts:
  - ips:
    - 10.0.4.3:22
    roles:
    - master
    - amd64
  image:
  - labring/kubernetes:v1.25.0
  - labring/helm:v3.8.2
  - labring/calico:v3.24.1
  - labring/kubernetes:v1.25.0
  - labring/helm:v3.8.2
  - labring/calico:v3.24.1
  - labring/kubernetes-docker:v1.20.5-4.1.3
  - labring/calico:v3.24.1
  - labring/kubernetes-docker:v1.20.5-4.1.3
  ssh:
    passwd: '[your-ssh-passwd]'
    pk: /root/.ssh/id_rsa
    port: 22
    user: root
status:
  conditions:
  - lastHeartbeatTime: "2022-11-03T11:10:06Z"
    message: Applied to cluster successfully
    reason: Ready
    status: "True"
    type: ApplyClusterSuccess
  mounts:
  - env:
      criData: /var/lib/containerd
      registryConfig: /etc/registry
      registryData: /var/lib/registry
      registryDomain: sealos.hub
      registryPassword: passw0rd
      registryPort: "5000"
      registryUsername: admin
    imageName: labring/kubernetes:v1.25.0
    labels:
      auth: auth.sh
      check: check.sh $registryData
      clean: clean.sh $criData
      clean-registry: clean-registry.sh $registryData $registryConfig
      image: ghcr.io/labring/lvscare:v4.1.3
      init: init.sh $registryDomain $registryPort
      init-registry: init-registry.sh $registryData $registryConfig
      io.buildah.version: 1.25.0-dev
      sealos.io.type: rootfs
      version: v1.25.0
    mountPoint: /var/lib/containers/storage/overlay/d6743e52e7bd4635107a4e7b586892dd505c9f5e4c5d040f16004f571934bb33/merged
    name: default-a26bij8e
    type: rootfs
  - cmd:
    - cp opt/helm /usr/bin/
    imageName: labring/helm:v3.8.2
    labels:
      io.buildah.version: 1.25.0-dev
    mountPoint: /var/lib/containers/storage/overlay/a673232bd58b472065d8741c307394e0371b0b8e5e4c199e7e1c3f5df05285d0/merged
    name: default-7bztc4cy
    type: application
  - cmd:
    - kubectl create namespace tigera-operator
    - helm install calico charts/calico --namespace tigera-operator
    imageName: labring/calico:v3.24.1
    labels:
      io.buildah.version: 1.25.0-dev
    mountPoint: /var/lib/containers/storage/overlay/89823056d3a1c3d2daaa7d4c90e3a50c03ff82cb70dfed0ec22b06307a875411/merged
    name: default-orerq6tp
    type: application
  - env:
      criData: /var/lib/docker
      criDockerdData: /var/lib/cri-dockerd
      registryConfig: /etc/registry
      registryData: /var/lib/registry
      registryDomain: sealos.hub
      registryPassword: passw0rd
      registryPort: "5000"
      registryUsername: admin
    imageName: labring/kubernetes-docker:v1.20.5-4.1.3
    labels:
      auth: auth.sh $registryDomain $registryPort $registryUsername $registryPassword
      check: check.sh $registryData
      clean: clean.sh $criData $criDockerdData
      clean-registry: clean-registry.sh $registryData $registryConfig
      image: ghcr.io/labring/lvscare:v4.1.3
      init: init.sh
      init-registry: init-registry.sh $registryData $registryConfig
      io.buildah.version: 1.25.0-dev
      sealos.io.type: rootfs
      sealos.io.version: v1beta1
      version: v1.20.5
    mountPoint: /var/lib/containers/storage/overlay/4af662552ff4c7c5b2fa7ca9995664911e72528ad964f0c181a7f5d718716e2d/merged
    name: default-km12aep7
    type: rootfs
  phase: ClusterSuccess
```

:::



æˆ‘ä»¬è¿›å…¥ `/var/lib/containers/storage/overlay/4af662552ff4c7c5b2fa7ca9995664911e72528ad964f0c181a7f5d718716e2d/` ç›®å½•ï¼ˆè¿™é‡Œé¢å°±æ˜¯ rootfsï¼‰ï¼š

```bash
cd /var/lib/containers/storage/overlay/4af662552ff4c7c5b2fa7ca9995664911e72528ad964f0c181a7f5d718716e2d/merged
```

**è¿™ä¸ªé‡Œé¢å°±æœ‰æ‰€æœ‰æ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œé¢æœ‰å®‰è£… `k8s` æ‰€æœ‰çš„ä¾èµ– **

```bash
ca9995664911e72528ad964f0c181a7f5d718716e2d/merged# ls
bin  cri  etc  images  Kubefile  opt  README.md  registry  scripts  statics
```

+ `bin` å¸¦ç€ä¸€äº›é›†ç¾¤éœ€è¦çš„ `kubeadm` ã€`kubelet`
+ `images` é‡Œé¢æ–‡ä»¶ä¸­æœ‰ `docker` é•œåƒåˆ—è¡¨å’Œåœ°å€ï¼ˆè½¬k8sé›†ç¾¤éœ€è¦çš„ï¼Œä¼šè‡ªåŠ¨æ‹‰å–ä¸‹é¢çš„~ï¼‰
+ `etcd` å„ç§é…ç½®æ–‡ä»¶

```bash
/merged# cat images/shim/DefaultI
mageList 
k8s.gcr.io/kube-apiserver:v1.20.5
k8s.gcr.io/kube-controller-manager:v1.20.5
k8s.gcr.io/kube-scheduler:v1.20.5
k8s.gcr.io/kube-proxy:v1.20.5
k8s.gcr.io/pause:3.2
k8s.gcr.io/etcd:3.4.13-0
k8s.gcr.io/coredns:1.7.0
```

**æ‰€ä»¥ `sealos run` çš„æ—¶å€™å…ˆæ‰¾`sealos` é•œåƒä»“åº“ä¸­çš„ã€‚**



**æ„å»ºå½“å‰é›†ç¾¤é•œåƒï¼š**

```dockerfile
ca9995664911e72528ad964f0c181a7f5d718716e2d/merged# cat Kubefile 
FROM scratch
MAINTAINER sealos
LABEL init="init.sh"
LABEL version="v1.20.5"
LABEL image="ghcr.io/labring/lvscare:v4.1.3"
LABEL clean="clean.sh \$criData \$criDockerdData"
LABEL check="check.sh \$registryData"
LABEL init-registry="init-registry.sh \$registryData \$registryConfig"
LABEL clean-registry="clean-registry.sh \$registryData \$registryConfig"
LABEL auth="auth.sh \$registryDomain \$registryPort \$registryUsername \$registryPassword"
LABEL sealos.io.type="rootfs"
LABEL sealos.io.version="v1beta1"
ENV criData=/var/lib/docker
ENV criDockerdData=/var/lib/cri-dockerd
ENV registryData=/var/lib/registry
ENV registryConfig=/etc/registry
ENV registryDomain=sealos.hub
ENV registryPort=5000
ENV registryUsername=admin
ENV registryPassword=passw0rd
COPY . .
```



**æˆ‘ä»¬å¯ä»¥ç›´æ¥ build å‡ºä¸€ä¸ªé•œåƒï¼š**

```bash
sealos build -t calico:latest .
```

æˆ‘ä»¬ä¼šæŠŠ `calica` ä¾èµ–çš„æ‰€æœ‰é•œåƒæ‹‰å–ä¸‹æ¥ï¼Œæ”¾åˆ° `registry` ç›®å½•ä¸‹é¢ã€‚



## END é“¾æ¥

<ul><li><div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

