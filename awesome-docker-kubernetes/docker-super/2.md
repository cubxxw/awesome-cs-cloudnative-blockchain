+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/awesome-cloud-native)

# ç¬¬2èŠ‚ å‘½åç©ºé—´

<br>
<div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•å®ç°å½“åˆå­¦ä¹ dockerçš„æ„¿æœ›ï¼Œè‡ªå·±æ’¸ä¸€ä¸ªdockerï¼Œä¸ºäº‘åŸç”Ÿå¼€å‘å……å®åŸºç¡€ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å‰è¨€

::: tip 
åŸºç¡€ç¯‡ä¸¤ç¯‡è®²è§£ rootfs æˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹å³å¯

:::

## Linux Namespace

|   Namespaceç±»å‹   | ç³»ç»Ÿè°ƒç”¨å‚æ•°  | å†…æ ¸ç‰ˆæœ¬ |                   ç”¨é€”                   |
| :---------------: | :-----------: | :------: | :--------------------------------------: |
|  Mount Namespace  |  CLONE NEWNS  |  2.4.19  |          éš”ç¦»è¿›ç¨‹çœ‹åˆ°æŒ‚è½½ç‚¹è§†å›¾          |
|   UTS Namespace   | CLONE NEWUTS  |  2.6.19  |         éš”ç¦»nodenameå’Œdomainname         |
|   IPC Namespace   | CLONE NEWIPC  |  2.6.19  | éš”ç¦»System V IPC å’Œ POSIX Message Queues |
|   PID Namespace   | CLONE NEWPID  |  2.6.24  |                éš”ç¦»è¿›ç¨‹ID                |
| Network Namespace | CLONE NEWNET  |  2.6.29  |     éš”ç¦»ç½‘ç»œè®¾å¤‡ï¼ŒIPåœ°å€ç«¯å£ç­‰ç½‘ç»œæ ˆ     |
|  User Namespace   | CLONE NEWUSER |   3.8    |               éš”ç¦»ç”¨æˆ·ç»„ID               |

Linux kernel Clone flags https://man7.org/linux/man-pages/man2/clone.2.html

> æ‰€ä»¥è¯´ å½’åˆ°åº•è¿˜æ˜¯å’ŒLinuxç‰¹åˆ«ç†Ÿæ‚‰~ï¼Œè¿™ç§ç†Ÿæ‚‰å¯èƒ½ä¸ä»…ä»…æ˜¯cmd



## create a  pid 

```
[root@VM-4-6-centos ~]# sudo unshare --fork --pid --mount-proc bash
[root@VM-4-6-centos ~]# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 22:18 pts/1    00:00:00 bash
root        32     1  0 22:18 pts/1    00:00:00 ps -ef
```

> *Of course you can set it yourself*
>
> ```
> unshare --help
> ```



**run cmd in child and parent shell:**

```bash
[root@VM-4-6-centos ~]# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 22:18 pts/1    00:00:00 bash
root        32     1  0 22:18 pts/1    00:00:00 ps -ef
[root@VM-4-6-centos ~]# sleep 1000 &
[1] 33
[root@VM-4-6-centos ~]# ll /proc/33/n
net/       ns/        numa_maps  
[root@VM-4-6-centos ~]# ll /proc/33/ns
total 0
lrwxrwxrwx 1 root root 0 Nov 15 22:22 ipc -> ipc:[4026531839]
lrwxrwxrwx 1 root root 0 Nov 15 22:22 mnt -> mnt:[4026532627]
lrwxrwxrwx 1 root root 0 Nov 15 22:22 net -> net:[4026531956]
lrwxrwxrwx 1 root root 0 Nov 15 22:22 pid -> pid:[4026532628]
lrwxrwxrwx 1 root root 0 Nov 15 22:22 user -> user:[4026531837]
lrwxrwxrwx 1 root root 0 Nov 15 22:22 uts -> uts:[4026531838]
```



**compare the /procï¼š**

```bash
ll /proc/<pid>/ns
```



## update go-code about unshare

```go
package main
import(
	"os"
	"fmt"
	"os/exec"
	"syscall"
)

func main(){
	fmt.Println(os.Args)
	switch os.Args[1]{
		case "run":
			run()
		default:
			panic("have not define")
	}
}
func run(){
	cmd := exec.Command(os.Args[2])
	cmd.SysProcAttr = &syscall.SysProcAttr{
		Cloneflags: syscall.CLONE_NEWUTS,
	}
	cmd.Stdin = os.Stdin
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr
	if err:=cmd.Run(); err!=nil{
		panic(err)
	}
}
```



### Issues

```go
panic: fork/exec /bin/sh: operation not permitted

goroutine 1 [running]:
main.run()
	/go/src/main.go:28 +0x15c
main.main() 
	/go/src/main.go:13 +0xcc
```



### Solution

```
docker run -itd --privileged golang
```



### Ref

exec.Command: https://pkg.go.dev/os/exec@go1.18.3#Command

SysProcAttr: https://pkg.go.dev/syscall@go1.18.3#SysProcAttr





## END é“¾æ¥

<ul><li><div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 
