# 1. Publishæ¨¡å¼ï¼ˆè®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯è¢«è·¯ç”±æŠ•é€’ç»™å¤šä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…è·å–ï¼‰

![img](https://s2.loli.net/2022/04/10/pByLhoERkiSM78l.jpg)

- Xä»£è¡¨äº¤æ¢æœºrabbitMQå†…éƒ¨ç»„ä»¶,erlang æ¶ˆæ¯äº§ç”Ÿè€…æ˜¯ä»£ç å®Œæˆ,ä»£ç çš„æ‰§è¡Œæ•ˆç‡ä¸é«˜,æ¶ˆæ¯äº§ç”Ÿè€…å°†æ¶ˆæ¯æ”¾å…¥äº¤æ¢æœº,äº¤æ¢æœºå‘å¸ƒè®¢é˜…æŠŠæ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­,å¯¹åº”æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…æ‹¿åˆ°æ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹
- ç›¸å…³åœºæ™¯:é‚®ä»¶ç¾¤å‘,ç¾¤èŠå¤©,å¹¿æ’­(å¹¿å‘Š)

ç›®å½•ç»“æ„

![img](https://s2.loli.net/2022/04/10/xpnXUDedwVA6Nbt.png)

kuteng-RabbitMQ

-RabbitMQ

--rabitmq.go //è¿™ä¸ªæ˜¯RabbitMQçš„å°è£…

-Pub

--mainPub.go //Publish å…ˆå¯åŠ¨

-Sub

--mainSub.go

-Sub2

--mainSub.go

rabitmq.goä»£ç 

```go
package RabbitMQ

import (
    "fmt"
    "log"

    "github.com/streadway/amqp"
)

//è¿æ¥ä¿¡æ¯
const MQURL = "amqp://kuteng:kuteng@127.0.0.1:5672/kuteng"

//rabbitMQç»“æ„ä½“
type RabbitMQ struct {
    conn    *amqp.Connection
    channel *amqp.Channel
    //é˜Ÿåˆ—åç§°
    QueueName string
    //äº¤æ¢æœºåç§°
    Exchange string
    //bind Key åç§°
    Key string
    //è¿æ¥ä¿¡æ¯
    Mqurl string
}

//åˆ›å»ºç»“æ„ä½“å®ä¾‹
func NewRabbitMQ(queueName string, exchange string, key string) *RabbitMQ {
    return &RabbitMQ{QueueName: queueName, Exchange: exchange, Key: key, Mqurl: MQURL}
}

//æ–­å¼€channel å’Œ connection
func (r *RabbitMQ) Destory() {
    r.channel.Close()
    r.conn.Close()
}

//é”™è¯¯å¤„ç†å‡½æ•°
func (r *RabbitMQ) failOnErr(err error, message string) {
    if err != nil {
        log.Fatalf("%s:%s", message, err)
        panic(fmt.Sprintf("%s:%s", message, err))
    }
}

//è®¢é˜…æ¨¡å¼åˆ›å»ºRabbitMQå®ä¾‹
func NewRabbitMQPubSub(exchangeName string) *RabbitMQ {
    //åˆ›å»ºRabbitMQå®ä¾‹
    rabbitmq := NewRabbitMQ("", exchangeName, "")
    var err error
    //è·å–connection
    rabbitmq.conn, err = amqp.Dial(rabbitmq.Mqurl)
    rabbitmq.failOnErr(err, "failed to connect rabbitmq!")
    //è·å–channel
    rabbitmq.channel, err = rabbitmq.conn.Channel()
    rabbitmq.failOnErr(err, "failed to open a channel")
    return rabbitmq
}

//è®¢é˜…æ¨¡å¼ç”Ÿäº§
func (r *RabbitMQ) PublishPub(message string) {
    //1.å°è¯•åˆ›å»ºäº¤æ¢æœº
    err := r.channel.ExchangeDeclare(
        r.Exchange,
        "fanout",
        true,
        false,
        //trueè¡¨ç¤ºè¿™ä¸ªexchangeä¸å¯ä»¥è¢«clientç”¨æ¥æ¨é€æ¶ˆæ¯ï¼Œä»…ç”¨æ¥è¿›è¡Œexchangeå’Œexchangeä¹‹é—´çš„ç»‘å®š
        false,
        false,
        nil,
    )

    r.failOnErr(err, "Failed to declare an excha"+
        "nge")

    //2.å‘é€æ¶ˆæ¯
    err = r.channel.Publish(
        r.Exchange,
        "",
        false,
        false,
        amqp.Publishing{
            ContentType: "text/plain",
            Body:        []byte(message),
        })
}

//è®¢é˜…æ¨¡å¼æ¶ˆè´¹ç«¯ä»£ç 
func (r *RabbitMQ) RecieveSub() {
    //1.è¯•æ¢æ€§åˆ›å»ºäº¤æ¢æœº
    err := r.channel.ExchangeDeclare(
        r.Exchange,
        //äº¤æ¢æœºç±»å‹
        "fanout",
        true,
        false,
        //YESè¡¨ç¤ºè¿™ä¸ªexchangeä¸å¯ä»¥è¢«clientç”¨æ¥æ¨é€æ¶ˆæ¯ï¼Œä»…ç”¨æ¥è¿›è¡Œexchangeå’Œexchangeä¹‹é—´çš„ç»‘å®š
        false,
        false,
        nil,
    )
    r.failOnErr(err, "Failed to declare an exch"+
        "ange")
    //2.è¯•æ¢æ€§åˆ›å»ºé˜Ÿåˆ—ï¼Œè¿™é‡Œæ³¨æ„é˜Ÿåˆ—åç§°ä¸è¦å†™
    q, err := r.channel.QueueDeclare(
        "", //éšæœºç”Ÿäº§é˜Ÿåˆ—åç§°
        false,
        false,
        true,
        false,
        nil,
    )
    r.failOnErr(err, "Failed to declare a queue")

    //ç»‘å®šé˜Ÿåˆ—åˆ° exchange ä¸­
    err = r.channel.QueueBind(
        q.Name,
        //åœ¨pub/subæ¨¡å¼ä¸‹ï¼Œè¿™é‡Œçš„keyè¦ä¸ºç©º
        "",
        r.Exchange,
        false,
        nil)

    //æ¶ˆè´¹æ¶ˆæ¯
    messges, err := r.channel.Consume(
        q.Name,
        "",
        true,
        false,
        false,
        false,
        nil,
    )

    forever := make(chan bool)

    go func() {
        for d := range messges {
            log.Printf("Received a message: %s", d.Body)
        }
    }()
    fmt.Println("é€€å‡ºè¯·æŒ‰ CTRL+C\n")
    <-forever
}
```

mainPub.goä»£ç 

```go
package main

import (
    "fmt"
    "strconv"
    "time"

    "github.com/student/kuteng-RabbitMQ/RabbitMQ"
)

func main() {
    rabbitmq := RabbitMQ.NewRabbitMQPubSub("" +
        "newProduct")
    for i := 0; i < 100; i++ {
        rabbitmq.PublishPub("è®¢é˜…æ¨¡å¼ç”Ÿäº§ç¬¬" +
            strconv.Itoa(i) + "æ¡" + "æ•°æ®")
        fmt.Println("è®¢é˜…æ¨¡å¼ç”Ÿäº§ç¬¬" +
            strconv.Itoa(i) + "æ¡" + "æ•°æ®")
        time.Sleep(1 * time.Second)
    }

}
```

mainSub.goä»£ç (ä¸¤ä¸ªæ¶ˆè´¹è€…ä»£ç æ˜¯ä¸€æ ·çš„)

```go
package main

import "github.com/student/kuteng-RabbitMQ/RabbitMQ"

func main() {
    rabbitmq := RabbitMQ.NewRabbitMQPubSub("" +
        "newProduct")
    rabbitmq.RecieveSub()
}
```

## END é“¾æ¥
<ul><li><div><a href = '46.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '48.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

