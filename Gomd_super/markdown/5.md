# 1. TCPé»åŒ…

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// socket_stick/server/main.go

func process(conn net.Conn) {
    defer conn.Close()
    reader := bufio.NewReader(conn)
    var buf [1024]byte
    for {
        n, err := reader.Read(buf[:])
        if err == io.EOF {
            break
        }
        if err != nil {
            fmt.Println("read from client failed, err:", err)
            break
        }
        recvStr := string(buf[:n])
        fmt.Println("æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š", recvStr)
    }
}

func main() {

    listen, err := net.Listen("tcp", "127.0.0.1:30000")
    if err != nil {
        fmt.Println("listen failed, err:", err)
        return
    }
    defer listen.Close()
    for {
        conn, err := listen.Accept()
        if err != nil {
            fmt.Println("accept failed, err:", err)
            continue
        }
        go process(conn)
    }
}
```

å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// socket_stick/client/main.go

func main() {
    conn, err := net.Dial("tcp", "127.0.0.1:30000")
    if err != nil {
        fmt.Println("dial failed, err", err)
        return
    }
    defer conn.Close()
    for i := 0; i < 20; i++ {
        msg := `Hello, Hello. How are you?`
        conn.Write([]byte(msg))
    }
}
```

å°†ä¸Šé¢çš„ä»£ç ä¿å­˜åï¼Œåˆ†åˆ«ç¼–è¯‘ã€‚å…ˆå¯åŠ¨æœåŠ¡ç«¯å†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?Hello, Hello. How are you?
æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š Hello, Hello. How are you?Hello, Hello. How are you?
```

å®¢æˆ·ç«¯åˆ†10æ¬¡å‘é€çš„æ•°æ®ï¼Œåœ¨æœåŠ¡ç«¯å¹¶æ²¡æœ‰æˆåŠŸçš„è¾“å‡º10æ¬¡ï¼Œè€Œæ˜¯å¤šæ¡æ•°æ®â€œç²˜â€åˆ°äº†ä¸€èµ·ã€‚

### 1.1.1. ä¸ºä»€ä¹ˆä¼šå‡ºç°ç²˜åŒ…

ä¸»è¦åŸå› å°±æ˜¯tcpæ•°æ®ä¼ é€’æ¨¡å¼æ˜¯æµæ¨¡å¼ï¼Œåœ¨ä¿æŒé•¿è¿æ¥çš„æ—¶å€™å¯ä»¥è¿›è¡Œå¤šæ¬¡çš„æ”¶å’Œå‘ã€‚

â€œç²˜åŒ…â€å¯å‘ç”Ÿåœ¨å‘é€ç«¯ä¹Ÿå¯å‘ç”Ÿåœ¨æ¥æ”¶ç«¯ï¼š

```
    1.ç”±Nagleç®—æ³•é€ æˆçš„å‘é€ç«¯çš„ç²˜åŒ…ï¼šNagleç®—æ³•æ˜¯ä¸€ç§æ”¹å–„ç½‘ç»œä¼ è¾“æ•ˆç‡çš„ç®—æ³•ã€‚ç®€å•æ¥è¯´å°±æ˜¯å½“æˆ‘ä»¬æäº¤ä¸€æ®µæ•°æ®ç»™TCPå‘é€æ—¶ï¼ŒTCPå¹¶ä¸ç«‹åˆ»å‘é€æ­¤æ®µæ•°æ®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€å°æ®µæ—¶é—´çœ‹çœ‹åœ¨ç­‰å¾…æœŸé—´æ˜¯å¦è¿˜æœ‰è¦å‘é€çš„æ•°æ®ï¼Œè‹¥æœ‰åˆ™ä¼šä¸€æ¬¡æŠŠè¿™ä¸¤æ®µæ•°æ®å‘é€å‡ºå»ã€‚
    2.æ¥æ”¶ç«¯æ¥æ”¶ä¸åŠæ—¶é€ æˆçš„æ¥æ”¶ç«¯ç²˜åŒ…ï¼šTCPä¼šæŠŠæ¥æ”¶åˆ°çš„æ•°æ®å­˜åœ¨è‡ªå·±çš„ç¼“å†²åŒºä¸­ï¼Œç„¶åé€šçŸ¥åº”ç”¨å±‚å–æ•°æ®ã€‚å½“åº”ç”¨å±‚ç”±äºæŸäº›åŸå› ä¸èƒ½åŠæ—¶çš„æŠŠTCPçš„æ•°æ®å–å‡ºæ¥ï¼Œå°±ä¼šé€ æˆTCPç¼“å†²åŒºä¸­å­˜æ”¾äº†å‡ æ®µæ•°æ®ã€‚
```

### 1.1.2. è§£å†³åŠæ³•

å‡ºç°â€ç²˜åŒ…â€çš„å…³é”®åœ¨äºæ¥æ”¶æ–¹ä¸ç¡®å®šå°†è¦ä¼ è¾“çš„æ•°æ®åŒ…çš„å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹æ•°æ®åŒ…è¿›è¡Œå°åŒ…å’Œæ‹†åŒ…çš„æ“ä½œã€‚

å°åŒ…ï¼šå°åŒ…å°±æ˜¯ç»™ä¸€æ®µæ•°æ®åŠ ä¸ŠåŒ…å¤´ï¼Œè¿™æ ·ä¸€æ¥æ•°æ®åŒ…å°±åˆ†ä¸ºåŒ…å¤´å’ŒåŒ…ä½“ä¸¤éƒ¨åˆ†å†…å®¹äº†(è¿‡æ»¤éæ³•åŒ…æ—¶å°åŒ…ä¼šåŠ å…¥â€åŒ…å°¾â€å†…å®¹)ã€‚åŒ…å¤´éƒ¨åˆ†çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”å®ƒå­˜å‚¨äº†åŒ…ä½“çš„é•¿åº¦ï¼Œæ ¹æ®åŒ…å¤´é•¿åº¦å›ºå®šä»¥åŠåŒ…å¤´ä¸­å«æœ‰åŒ…ä½“é•¿åº¦çš„å˜é‡å°±èƒ½æ­£ç¡®çš„æ‹†åˆ†å‡ºä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚

æˆ‘ä»¬å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªåè®®ï¼Œæ¯”å¦‚æ•°æ®åŒ…çš„å‰4ä¸ªå­—èŠ‚ä¸ºåŒ…å¤´ï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯å‘é€çš„æ•°æ®çš„é•¿åº¦ã€‚

```go
// socket_stick/proto/proto.go
package proto

import (
    "bufio"
    "bytes"
    "encoding/binary"
)

// Encode å°†æ¶ˆæ¯ç¼–ç 
func Encode(message string) ([]byte, error) {
    // è¯»å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œè½¬æ¢æˆint32ç±»å‹ï¼ˆå 4ä¸ªå­—èŠ‚ï¼‰
    var length = int32(len(message))
    var pkg = new(bytes.Buffer)
    // å†™å…¥æ¶ˆæ¯å¤´
    err := binary.Write(pkg, binary.LittleEndian, length)
    if err != nil {
        return nil, err
    }
    // å†™å…¥æ¶ˆæ¯å®ä½“
    err = binary.Write(pkg, binary.LittleEndian, []byte(message))
    if err != nil {
        return nil, err
    }
    return pkg.Bytes(), nil
}

// Decode è§£ç æ¶ˆæ¯
func Decode(reader *bufio.Reader) (string, error) {
    // è¯»å–æ¶ˆæ¯çš„é•¿åº¦
    lengthByte, _ := reader.Peek(4) // è¯»å–å‰4ä¸ªå­—èŠ‚çš„æ•°æ®
    lengthBuff := bytes.NewBuffer(lengthByte)
    var length int32
    err := binary.Read(lengthBuff, binary.LittleEndian, &length)
    if err != nil {
        return "", err
    }
    // Bufferedè¿”å›ç¼“å†²ä¸­ç°æœ‰çš„å¯è¯»å–çš„å­—èŠ‚æ•°ã€‚
    if int32(reader.Buffered()) < length+4 {
        return "", err
    }

    // è¯»å–çœŸæ­£çš„æ¶ˆæ¯æ•°æ®
    pack := make([]byte, int(4+length))
    _, err = reader.Read(pack)
    if err != nil {
        return "", err
    }
    return string(pack[4:]), nil
}
```

æ¥ä¸‹æ¥åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åˆ†åˆ«ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„protoåŒ…çš„Decodeå’ŒEncodeå‡½æ•°å¤„ç†æ•°æ®ã€‚

æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// socket_stick/server2/main.go

func process(conn net.Conn) {
    defer conn.Close()
    reader := bufio.NewReader(conn)
    for {
        msg, err := proto.Decode(reader)
        if err == io.EOF {
            return
        }
        if err != nil {
            fmt.Println("decode msg failed, err:", err)
            return
        }
        fmt.Println("æ”¶åˆ°clientå‘æ¥çš„æ•°æ®ï¼š", msg)
    }
}

func main() {

    listen, err := net.Listen("tcp", "127.0.0.1:30000")
    if err != nil {
        fmt.Println("listen failed, err:", err)
        return
    }
    defer listen.Close()
    for {
        conn, err := listen.Accept()
        if err != nil {
            fmt.Println("accept failed, err:", err)
            continue
        }
        go process(conn)
    }
}
```

å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// socket_stick/client2/main.go

func main() {
    conn, err := net.Dial("tcp", "127.0.0.1:30000")
    if err != nil {
        fmt.Println("dial failed, err", err)
        return
    }
    defer conn.Close()
    for i := 0; i < 20; i++ {
        msg := `Hello, Hello. How are you?`
        data, err := proto.Encode(msg)
        if err != nil {
            fmt.Println("encode msg failed, err:", err)
            return
        }
        conn.Write(data)
    }
}
```

## END é“¾æ¥
<ul><li><div><a href = '4.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '6.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

