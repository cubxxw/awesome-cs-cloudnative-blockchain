# 1. åŸå­æ“ä½œ(atomicåŒ…)

### 1.1.1. åŸå­æ“ä½œ

ä»£ç ä¸­çš„åŠ é”æ“ä½œå› ä¸ºæ¶‰åŠå†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šæ¯”è¾ƒè€—æ—¶ã€ä»£ä»·æ¯”è¾ƒé«˜ã€‚é’ˆå¯¹åŸºæœ¬æ•°æ®ç±»å‹æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨åŸå­æ“ä½œæ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå› ä¸ºåŸå­æ“ä½œæ˜¯Goè¯­è¨€æä¾›çš„æ–¹æ³•å®ƒåœ¨ç”¨æˆ·æ€å°±å¯ä»¥å®Œæˆï¼Œå› æ­¤æ€§èƒ½æ¯”åŠ é”æ“ä½œæ›´å¥½ã€‚Goè¯­è¨€ä¸­åŸå­æ“ä½œç”±å†…ç½®çš„æ ‡å‡†åº“sync/atomicæä¾›ã€‚

### 1.1.2. atomicåŒ…

| æ–¹æ³•                                                         | è§£é‡Š           |
| ------------------------------------------------------------ | -------------- |
| func LoadInt32(addr *int32) (val int32) func LoadInt64(addr `*int64`) (val int64)<br>func LoadUint32(addr`*uint32`) (val uint32)<br>func LoadUint64(addr`*uint64`) (val uint64)<br>func LoadUintptr(addr`*uintptr`) (val uintptr)<br>func LoadPointer(addr`*unsafe.Pointer`) (val unsafe.Pointer) | è¯»å–æ“ä½œ       |
| func StoreInt32(addr `*int32`, val int32) func StoreInt64(addr `*int64`, val int64) func StoreUint32(addr `*uint32`, val uint32) func StoreUint64(addr `*uint64`, val uint64) func StoreUintptr(addr `*uintptr`, val uintptr) func StorePointer(addr `*unsafe.Pointer`, val unsafe.Pointer) | å†™å…¥æ“ä½œ       |
| func AddInt32(addr `*int32`, delta int32) (new int32) func AddInt64(addr `*int64`, delta int64) (new int64) func AddUint32(addr `*uint32`, delta uint32) (new uint32) func AddUint64(addr `*uint64`, delta uint64) (new uint64) func AddUintptr(addr `*uintptr`, delta uintptr) (new uintptr) | ä¿®æ”¹æ“ä½œ       |
| func SwapInt32(addr `*int32`, new int32) (old int32) func SwapInt64(addr `*int64`, new int64) (old int64) func SwapUint32(addr `*uint32`, new uint32) (old uint32) func SwapUint64(addr `*uint64`, new uint64) (old uint64) func SwapUintptr(addr `*uintptr`, new uintptr) (old uintptr) func SwapPointer(addr `*unsafe.Pointer`, new unsafe.Pointer) (old unsafe.Pointer) | äº¤æ¢æ“ä½œ       |
| func CompareAndSwapInt32(addr `*int32`, old, new int32) (swapped bool) func CompareAndSwapInt64(addr `*int64`, old, new int64) (swapped bool) func CompareAndSwapUint32(addr `*uint32`, old, new uint32) (swapped bool) func CompareAndSwapUint64(addr `*uint64`, old, new uint64) (swapped bool) func CompareAndSwapUintptr(addr `*uintptr`, old, new uintptr) (swapped bool) func CompareAndSwapPointer(addr `*unsafe.Pointer`, old, new unsafe.Pointer) (swapped bool) | æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œ |

### 1.1.3. ç¤ºä¾‹

æˆ‘ä»¬å¡«å†™ä¸€ä¸ªç¤ºä¾‹æ¥æ¯”è¾ƒä¸‹äº’æ–¥é”å’ŒåŸå­æ“ä½œçš„æ€§èƒ½ã€‚

```go
var x int64
var l sync.Mutex
var wg sync.WaitGroup

// æ™®é€šç‰ˆåŠ å‡½æ•°
func add() {
    // x = x + 1
    x++ // ç­‰ä»·äºä¸Šé¢çš„æ“ä½œ
    wg.Done()
}

// äº’æ–¥é”ç‰ˆåŠ å‡½æ•°
func mutexAdd() {
    l.Lock()
    x++
    l.Unlock()
    wg.Done()
}

// åŸå­æ“ä½œç‰ˆåŠ å‡½æ•°
func atomicAdd() {
    atomic.AddInt64(&x, 1)
    wg.Done()
}

func main() {
    start := time.Now()
    for i := 0; i < 10000; i++ {
        wg.Add(1)
        // go add()       // æ™®é€šç‰ˆaddå‡½æ•° ä¸æ˜¯å¹¶å‘å®‰å…¨çš„
        // go mutexAdd()  // åŠ é”ç‰ˆaddå‡½æ•° æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œä½†æ˜¯åŠ é”æ€§èƒ½å¼€é”€å¤§
        go atomicAdd() // åŸå­æ“ä½œç‰ˆaddå‡½æ•° æ˜¯å¹¶å‘å®‰å…¨ï¼Œæ€§èƒ½ä¼˜äºåŠ é”ç‰ˆ
    }
    wg.Wait()
    end := time.Now()
    fmt.Println(x)
    fmt.Println(end.Sub(start))
}
```

atomicåŒ…æä¾›äº†åº•å±‚çš„åŸå­çº§å†…å­˜æ“ä½œï¼Œå¯¹äºåŒæ­¥ç®—æ³•çš„å®ç°å¾ˆæœ‰ç”¨ã€‚è¿™äº›å‡½æ•°å¿…é¡»è°¨æ…åœ°ä¿è¯æ­£ç¡®ä½¿ç”¨ã€‚é™¤äº†æŸäº›ç‰¹æ®Šçš„åº•å±‚åº”ç”¨ï¼Œä½¿ç”¨é€šé“æˆ–è€…syncåŒ…çš„å‡½æ•°/ç±»å‹å®ç°åŒæ­¥æ›´å¥½ã€‚

## END é“¾æ¥
<ul><li><div><a href = '16.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '18.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

