# çˆ¬è™«å°æ¡ˆä¾‹

[[toc]]

[toc]

### 1.1.1. çˆ¬è™«æ­¥éª¤

- æ˜ç¡®ç›®æ ‡ï¼ˆç¡®å®šåœ¨å“ªä¸ªç½‘ç«™æœç´¢ï¼‰
- çˆ¬ï¼ˆçˆ¬ä¸‹å†…å®¹ï¼‰
- å–ï¼ˆç­›é€‰æƒ³è¦çš„ï¼‰
- å¤„ç†æ•°æ®ï¼ˆæŒ‰ç…§ä½ çš„æƒ³æ³•å»å¤„ç†ï¼‰

```go
package main

import (
    "fmt"
    "io/ioutil"
    "net/http"
    "regexp"
)

//è¿™ä¸ªåªæ˜¯ä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬åªæ˜¯è·å–QQé‚®ç®±å¹¶ä¸”æ²¡æœ‰è¿›è¡Œå°è£…æ“ä½œï¼Œå¦å¤–çˆ¬å‡ºæ¥çš„æ•°æ®ä¹Ÿæ²¡æœ‰è¿›è¡Œå»é‡æ“ä½œ
var (
    // \dæ˜¯æ•°å­—
    reQQEmail = `(\d+)@qq.com`
)

// çˆ¬é‚®ç®±
func GetEmail() {
    // 1.å»ç½‘ç«™æ‹¿æ•°æ®
    resp, err := http.Get("https://tieba.baidu.com/p/6051076813?red_tag=1573533731")
    HandleError(err, "http.Get url")
    defer resp.Body.Close()
    // 2.è¯»å–é¡µé¢å†…å®¹
    pageBytes, err := ioutil.ReadAll(resp.Body)
    HandleError(err, "ioutil.ReadAll")
    // å­—èŠ‚è½¬å­—ç¬¦ä¸²
    pageStr := string(pageBytes)
    //fmt.Println(pageStr)
    // 3.è¿‡æ»¤æ•°æ®ï¼Œè¿‡æ»¤qqé‚®ç®±
    re := regexp.MustCompile(reQQEmail)
    // -1ä»£è¡¨å–å…¨éƒ¨
    results := re.FindAllStringSubmatch(pageStr, -1)
    //fmt.Println(results)

    // éå†ç»“æœ
    for _, result := range results {
        fmt.Println("email:", result[0])
        fmt.Println("qq:", result[1])
    }
}

// å¤„ç†å¼‚å¸¸
func HandleError(err error, why string) {
    if err != nil {
        fmt.Println(why, err)
    }
}
func main() {
    GetEmail()
}
```

### 1.1.2. æ­£åˆ™è¡¨è¾¾å¼

- æ–‡æ¡£ï¼šhttps://studygolang.com/pkgdoc
- API
  - re := regexp.MustCompile(reStr)ï¼Œä¼ å…¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¾—åˆ°æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
  - ret := re.FindAllStringSubmatch(srcStr,-1)ï¼šç”¨æ­£åˆ™å¯¹è±¡ï¼Œè·å–é¡µé¢é¡µé¢ï¼ŒsrcStræ˜¯é¡µé¢å†…å®¹ï¼Œ-1ä»£è¡¨å–å…¨éƒ¨
- çˆ¬é‚®ç®±
- æ–¹æ³•æŠ½å–
- çˆ¬è¶…é“¾æ¥
- çˆ¬æ‰‹æœºå·
  - http://www.zhaohaowang.com/ å¦‚æœè¿æ¥å¤±æ•ˆäº†è‡ªå·±æ‰¾ä¸€ä¸ªæœ‰æ‰‹æœºå·çš„å°±å¥½äº†
- çˆ¬èº«ä»½è¯å·
  - http://henan.qq.com/a/20171107/069413.htm å¦‚æœè¿æ¥å¤±æ•ˆäº†è‡ªå·±æ‰¾ä¸€ä¸ªå°±å¥½äº†
- çˆ¬å›¾ç‰‡é“¾æ¥

```go
package main

import (
    "fmt"
    "io/ioutil"
    "net/http"
    "regexp"
)

var (
    // wä»£è¡¨å¤§å°å†™å­—æ¯+æ•°å­—+ä¸‹åˆ’çº¿
    reEmail = `\w+@\w+\.\w+`
    // s?æœ‰æˆ–è€…æ²¡æœ‰s
    // +ä»£è¡¨å‡º1æ¬¡æˆ–å¤šæ¬¡
    //\s\Så„ç§å­—ç¬¦
    // +?ä»£è¡¨è´ªå©ªæ¨¡å¼
    reLinke  = `href="(https?://[\s\S]+?)"`
    rePhone  = `1[3456789]\d\s?\d{4}\s?\d{4}`
    reIdcard = `[123456789]\d{5}((19\d{2})|(20[01]\d))((0[1-9])|(1[012]))((0[1-9])|([12]\d)|(3[01]))\d{3}[\dXx]`
    reImg    = `https?://[^"]+?(\.((jpg)|(png)|(jpeg)|(gif)|(bmp)))`
)

// å¤„ç†å¼‚å¸¸
func HandleError(err error, why string) {
    if err != nil {
        fmt.Println(why, err)
    }
}

func GetEmail2(url string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(reEmail)
    results := re.FindAllStringSubmatch(pageStr, -1)
    for _, result := range results {
        fmt.Println(result)
    }
}

// æŠ½å–æ ¹æ®urlè·å–å†…å®¹
func GetPageStr(url string) (pageStr string) {
    resp, err := http.Get(url)
    HandleError(err, "http.Get url")
    defer resp.Body.Close()
    // 2.è¯»å–é¡µé¢å†…å®¹
    pageBytes, err := ioutil.ReadAll(resp.Body)
    HandleError(err, "ioutil.ReadAll")
    // å­—èŠ‚è½¬å­—ç¬¦ä¸²
    pageStr = string(pageBytes)
    return pageStr
}

func main() {
    // 2.æŠ½å–çš„çˆ¬é‚®ç®±
    // GetEmail2("https://tieba.baidu.com/p/6051076813?red_tag=1573533731")
    // 3.çˆ¬é“¾æ¥
    //GetLink("http://www.baidu.com/s?wd=%E8%B4%B4%E5%90%A7%20%E7%95%99%E4%B8%8B%E9%82%AE%E7%AE%B1&rsv_spt=1&rsv_iqid=0x98ace53400003985&issp=1&f=8&rsv_bp=1&rsv_idx=2&ie=utf-8&tn=baiduhome_pg&rsv_enter=1&rsv_dl=ib&rsv_sug2=0&inputT=5197&rsv_sug4=6345")
    // 4.çˆ¬æ‰‹æœºå·
    //GetPhone("https://www.zhaohaowang.com/")
    // 5.çˆ¬èº«ä»½è¯å·
    //GetIdCard("https://henan.qq.com/a/20171107/069413.htm")
    // 6.çˆ¬å›¾ç‰‡
    // GetImg("http://image.baidu.com/search/index?tn=baiduimage&ps=1&ct=201326592&lm=-1&cl=2&nc=1&ie=utf-8&word=%E7%BE%8E%E5%A5%B3")
}

func GetIdCard(url string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(reIdcard)
    results := re.FindAllStringSubmatch(pageStr, -1)
    for _, result := range results {
        fmt.Println(result)
    }
}

// çˆ¬é“¾æ¥
func GetLink(url string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(reLinke)
    results := re.FindAllStringSubmatch(pageStr, -1)
    for _, result := range results {
        fmt.Println(result[1])
    }
}

//çˆ¬æ‰‹æœºå·
func GetPhone(url string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(rePhone)
    results := re.FindAllStringSubmatch(pageStr, -1)
    for _, result := range results {
        fmt.Println(result)
    }
}

func GetImg(url string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(reImg)
    results := re.FindAllStringSubmatch(pageStr, -1)
    for _, result := range results {
        fmt.Println(result[0])
    }
}
```

### 1.1.3. å¹¶å‘çˆ¬å–ç¾å›¾

ä¸‹é¢çš„ä¸¤ä¸ªæ˜¯å³å°†è¦çˆ¬çš„ç½‘ç«™ï¼Œå¦‚æœç½‘å€å¤±æ•ˆè‡ªå·±æ¢ä¸€ä¸ªå°±å¥½äº†

- [https://www.bizhizu.cn/shouji/tag-%E5%8F%AF%E7%88%B1/1.html](https://www.bizhizu.cn/shouji/tag-å¯çˆ±/1.html)

```go
package main

import (
    "fmt"
    "io/ioutil"
    "net/http"
    "regexp"
    "strconv"
    "strings"
    "sync"
    "time"
)

func HandleError(err error, why string) {
    if err != nil {
        fmt.Println(why, err)
    }
}

// ä¸‹è½½å›¾ç‰‡ï¼Œä¼ å…¥çš„æ˜¯å›¾ç‰‡å«ä»€ä¹ˆ
func DownloadFile(url string, filename string) (ok bool) {
    resp, err := http.Get(url)
    HandleError(err, "http.get.url")
    defer resp.Body.Close()
    bytes, err := ioutil.ReadAll(resp.Body)
    HandleError(err, "resp.body")
    filename = "E:/topgoer.com/src/github.com/student/3.0/img/" + filename
    // å†™å‡ºæ•°æ®
    err = ioutil.WriteFile(filename, bytes, 0666)
    if err != nil {
        return false
    } else {
        return true
    }
}

// å¹¶å‘çˆ¬æ€è·¯ï¼š
// 1.åˆå§‹åŒ–æ•°æ®ç®¡é“
// 2.çˆ¬è™«å†™å‡ºï¼š26ä¸ªåç¨‹å‘ç®¡é“ä¸­æ·»åŠ å›¾ç‰‡é“¾æ¥
// 3.ä»»åŠ¡ç»Ÿè®¡åç¨‹ï¼šæ£€æŸ¥26ä¸ªä»»åŠ¡æ˜¯å¦éƒ½å®Œæˆï¼Œå®Œæˆåˆ™å…³é—­æ•°æ®ç®¡é“
// 4.ä¸‹è½½åç¨‹ï¼šä»ç®¡é“é‡Œè¯»å–é“¾æ¥å¹¶ä¸‹è½½

var (
    // å­˜æ”¾å›¾ç‰‡é“¾æ¥çš„æ•°æ®ç®¡é“
    chanImageUrls chan string
    waitGroup     sync.WaitGroup
    // ç”¨äºç›‘æ§åç¨‹
    chanTask chan string
    reImg    = `https?://[^"]+?(\.((jpg)|(png)|(jpeg)|(gif)|(bmp)))`
)

func main() {
    // myTest()
    // DownloadFile("http://i1.shaodiyejin.com/uploads/tu/201909/10242/e5794daf58_4.jpg", "1.jpg")

    // 1.åˆå§‹åŒ–ç®¡é“
    chanImageUrls = make(chan string, 1000000)
    chanTask = make(chan string, 26)
    // 2.çˆ¬è™«åç¨‹
    for i := 1; i < 27; i++ {
        waitGroup.Add(1)
        go getImgUrls("https://www.bizhizu.cn/shouji/tag-%E5%8F%AF%E7%88%B1/" + strconv.Itoa(i) + ".html")
    }
    // 3.ä»»åŠ¡ç»Ÿè®¡åç¨‹ï¼Œç»Ÿè®¡26ä¸ªä»»åŠ¡æ˜¯å¦éƒ½å®Œæˆï¼Œå®Œæˆåˆ™å…³é—­ç®¡é“
    waitGroup.Add(1)
    go CheckOK()
    // 4.ä¸‹è½½åç¨‹ï¼šä»ç®¡é“ä¸­è¯»å–é“¾æ¥å¹¶ä¸‹è½½
    for i := 0; i < 5; i++ {
        waitGroup.Add(1)
        go DownloadImg()
    }
    waitGroup.Wait()
}

// ä¸‹è½½å›¾ç‰‡
func DownloadImg() {
    for url := range chanImageUrls {
        filename := GetFilenameFromUrl(url)
        ok := DownloadFile(url, filename)
        if ok {
            fmt.Printf("%s ä¸‹è½½æˆåŠŸ\n", filename)
        } else {
            fmt.Printf("%s ä¸‹è½½å¤±è´¥\n", filename)
        }
    }
    waitGroup.Done()
}

// æˆªå–urlåå­—
func GetFilenameFromUrl(url string) (filename string) {
    // è¿”å›æœ€åä¸€ä¸ª/çš„ä½ç½®
    lastIndex := strings.LastIndex(url, "/")
    // åˆ‡å‡ºæ¥
    filename = url[lastIndex+1:]
    // æ—¶é—´æˆ³è§£å†³é‡å
    timePrefix := strconv.Itoa(int(time.Now().UnixNano()))
    filename = timePrefix + "_" + filename
    return
}

// ä»»åŠ¡ç»Ÿè®¡åç¨‹
func CheckOK() {
    var count int
    for {
        url := <-chanTask
        fmt.Printf("%s å®Œæˆäº†çˆ¬å–ä»»åŠ¡\n", url)
        count++
        if count == 26 {
            close(chanImageUrls)
            break
        }
    }
    waitGroup.Done()
}

// çˆ¬å›¾ç‰‡é“¾æ¥åˆ°ç®¡é“
// urlæ˜¯ä¼ çš„æ•´é¡µé“¾æ¥
func getImgUrls(url string) {
    urls := getImgs(url)
    // éå†åˆ‡ç‰‡é‡Œæ‰€æœ‰é“¾æ¥ï¼Œå­˜å…¥æ•°æ®ç®¡é“
    for _, url := range urls {
        chanImageUrls <- url
    }
    // æ ‡è¯†å½“å‰åç¨‹å®Œæˆ
    // æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œå†™ä¸€æ¡æ•°æ®
    // ç”¨äºç›‘æ§åç¨‹çŸ¥é“å·²ç»å®Œæˆäº†å‡ ä¸ªä»»åŠ¡
    chanTask <- url
    waitGroup.Done()
}

// è·å–å½“å‰é¡µå›¾ç‰‡é“¾æ¥
func getImgs(url string) (urls []string) {
    pageStr := GetPageStr(url)
    re := regexp.MustCompile(reImg)
    results := re.FindAllStringSubmatch(pageStr, -1)
    fmt.Printf("å…±æ‰¾åˆ°%dæ¡ç»“æœ\n", len(results))
    for _, result := range results {
        url := result[0]
        urls = append(urls, url)
    }
    return
}

// æŠ½å–æ ¹æ®urlè·å–å†…å®¹
func GetPageStr(url string) (pageStr string) {
    resp, err := http.Get(url)
    HandleError(err, "http.Get url")
    defer resp.Body.Close()
    // 2.è¯»å–é¡µé¢å†…å®¹
    pageBytes, err := ioutil.ReadAll(resp.Body)
    HandleError(err, "ioutil.ReadAll")
    // å­—èŠ‚è½¬å­—ç¬¦ä¸²
    pageStr = string(pageBytes)
    return pageStr
}
```

## END é“¾æ¥
<ul><li><div><a href = '18.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '20.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

