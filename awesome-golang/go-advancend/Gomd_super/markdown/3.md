# Go TCP Socket-Server-Client

[[toc]]

[toc]

## Goè¯­è¨€å®ç°TCPé€šä¿¡

### TCPåè®®

`TCP/IP` (Transmission Control Protocol/Internet Protocol) å³ä¼ è¾“æ§åˆ¶åè®®/ç½‘é—´åè®®ï¼Œæ˜¯ä¸€ç§é¢å‘è¿æ¥ï¼ˆè¿æ¥å¯¼å‘ï¼‰çš„ã€å¯é çš„ã€åŸºäºå­—èŠ‚æµçš„ä¼ è¾“å±‚ï¼ˆTransport layerï¼‰é€šä¿¡åè®®ï¼Œå› ä¸ºæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œæ•°æ®åƒæ°´æµä¸€æ ·ä¼ è¾“ï¼Œä¼šå­˜åœ¨é»åŒ…é—®é¢˜ã€‚ 

> tcpé€šä¿¡æ˜¯æœåŠ¡ç«¯å…ˆå‘èµ·çš„ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æœåŠ¡ç«¯



## A simple communication rule

::: details å±•å¼€æŸ¥çœ‹åŸºç¡€çš„ä»£ç 
æœåŠ¡ç«¯ä»£ç ï¼š

![code](http://sm.nsddd.top/smcode.png)



å®¢æˆ·ç«¯ä»£ç ï¼š

![code1](http://sm.nsddd.top/smcode1.png)

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

```bash
D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\socket>go run 57-main.go
è¿æ¥æœåŠ¡å™¨æˆåŠŸ &{{0xc000004c80}}
        sadf
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 4
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ SADF

D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\socket>go run 56-main.go
ç›‘å¬ä¸­...
ç›‘å¬æˆåŠŸ 127.0.0.1:8080
æ¥å—å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ &{{0xc000004f00}}
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ sadf
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ SADF
è½¬åŒ–ä¸ºå°å†™æˆåŠŸ sadf
```

:::



## å¤šæ¬¡è¯·æ±‚å’Œè¿æ¥

::: tip ä¸Šé¢çš„é—®é¢˜ï¼Ÿ
æˆ‘ä»¬åªèƒ½æ¥æ”¶æˆ–è€…å‘é€ä¸€ä¸²æ•°æ®ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨ `for` è¿™æ ·å¯ä»¥å‘é€æ›´å¤šçš„æ•°æ®ã€‚

+ ä¸» Go ç¨‹è´Ÿè´£ç›‘å¬ï¼Œå­ Go ç¨‹åºè´Ÿè´£æ•°æ®å¤„ç†ã€‚

å¦‚æœæœåŠ¡ç«¯ï¼šå®¢æˆ·ç«¯æ˜¯ `1 : n` é‚£ä¹ˆå¯ä¸å¯ä»¥ç”¨ `goroutine` å®ç°é«˜æ•ˆå¤„ç†

ä¸€ä¸ª `TCP` æœåŠ¡ç«¯å¯ä»¥åŒæ—¶è¿æ¥å¾ˆå¤šä¸ªå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ä¸–ç•Œå„åœ°çš„ç”¨æˆ·ä½¿ç”¨è‡ªå·±ç”µè„‘ä¸Šçš„æµè§ˆå™¨è®¿é—®æ·˜å®ç½‘ã€‚å› ä¸ºGoè¯­è¨€ä¸­åˆ›å»ºå¤šä¸ª `goroutine` å®ç°å¹¶å‘éå¸¸æ–¹ä¾¿å’Œé«˜æ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ¯å»ºç«‹ä¸€æ¬¡é“¾æ¥å°±åˆ›å»ºä¸€ä¸ª `goroutine` å»å¤„ç†ã€‚

:::

::: details æ”¹è¿›ä»£ç 
å®¢æˆ·ç«¯ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š

```go
/*
Listen on an address and port for incoming connections.

:param ip: IP address to listen on
:param port: Port to listen on
:returns: A listener object
*/
package main

import (
	"fmt"
	"net"
	"strings"
	"time"
)

func main() {
	// åˆ›å»ºç›‘å¬
	ip := "127.0.0.1"
	port := 8080
	address := fmt.Sprintf("%s:%d", ip, port) //Sprintfæ ¼å¼åŒ–å¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ‰“å°å®ƒ

	listener, err := net.Listen("tcp", address)

	if err != nil {
		fmt.Println("ç›‘å¬å¤±è´¥", err)
		return
	}
	defer listener.Close()
	fmt.Println("ç›‘å¬æˆåŠŸ", address)

	// æ¸…é™¤ç»ˆç«¯
	fmt.Println("\033[2J")

	for {
		//listernerè¡¨ç¤ºç›‘å¬å™¨ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚
		conn, err := listener.Accept() // è¡¨ç¤ºæ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚
		if err != nil {
			fmt.Println("æ¥å—å®¢æˆ·ç«¯è¿æ¥å¤±è´¥", err)
			return
		}
		fmt.Println("æ¥å—å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ", conn)

		go func() {
			for {
				// è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
				buf := make([]byte, 1024) // åˆ›å»ºä¸€ä¸ªåˆ‡ç‰‡ï¼Œç”¨äºå­˜å‚¨å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
				n, err := conn.Read(buf)  // è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
				if err != nil {
					fmt.Println("è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®å¤±è´¥", err)
					return
				}
				fmt.Println("è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ", string(buf[:n]))

				// æ•°æ®è½¬åŒ–ä¸ºå¤§å†™
				upper := strings.ToUpper(string(buf[:n]))
				fmt.Println("è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ", upper)

				// å°†æ•°æ®è½¬åŒ–ä¸ºå°å†™
				lower := strings.ToLower(string(buf[:n]))
				fmt.Println("è½¬åŒ–ä¸ºå°å†™æˆåŠŸ", lower)

				// å°†æ•°æ®å†™å›ç»™å®¢æˆ·ç«¯
				conn.Write([]byte(upper))
				conn.Write([]byte(lower))

				// ç»™å®¢æˆ·ç«¯å‘é€æ•°æ®
				conn.Write([]byte("hello, client"))

				//ç­‰å¾…ä¸€åˆ†é’Ÿæ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œå°±å…³é—­æœåŠ¡
				time.Sleep(time.Minute)
				listener.Close()
			}
			// å…³é—­è¿æ¥
			conn.Close()
		}()
	}
}

```

æœåŠ¡ç«¯ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š

```go
package main

import (
	"fmt"
	"net"
	"time"
)

/*
go

	Here's what the selected code is doing:
	1.Import the socket module.
	2. Create a socket object.
	3. Get the local hostname.
	4. Print the hostname to the console.
	5. Set the default port number.
	6. Bind the socket to the port.
	7. Listen for incoming connections.
	8. Accept an incoming connection.

	å®¢æˆ·ç«¯

	:param conn: è¿æ¥æœåŠ¡å™¨
	:param err: é”™è¯¯
	:return:
*/
func main() {
	// å®¢æˆ·ç«¯
	conn, err := net.Dial("tcp", ":8080")
	if err != nil {
		fmt.Println("è¿æ¥æœåŠ¡å™¨å¤±è´¥", err)
		return
	}
	fmt.Println("è¿æ¥æœåŠ¡å™¨æˆåŠŸ", conn)

	for {
		// è¾“å…¥æ•°æ®åˆ‡ç‰‡ç±»å‹
		fmt.Println("è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯")
		var input []byte
		fmt.Scanln(&input)

		// ç»™æœåŠ¡å™¨å‘é€æ•°æ®
		cnt, err := conn.Write([]byte(input))
		if err != nil {
			fmt.Println("ç»™æœåŠ¡å™¨å‘é€æ•°æ®å¤±è´¥", err)
			return
		}

		fmt.Println("ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ", cnt)

		// è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®
		buf := make([]byte, 1024)
		n, err := conn.Read(buf)
		if err != nil {
			fmt.Println("è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®å¤±è´¥", err)
			return
		}

		fmt.Println("è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ", string(buf[:n]))

		time.Sleep(time.Second * 2)
	}
	// å…³é—­è¿æ¥
	defer conn.Close()
}

```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

```bash
PS D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\socket> go run .\56-main.go
æ¥å—å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ &{{0xc000004f00}}
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ 12
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ 12
è½¬åŒ–ä¸ºå°å†™æˆåŠŸ 12
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ 312
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ 312
è½¬åŒ–ä¸ºå°å†™æˆåŠŸ 312
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ 4213412
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ 4213412
è½¬åŒ–ä¸ºå°å†™æˆåŠŸ 4213412
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ AFSSDFAS
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ AFSSDFAS
è½¬åŒ–ä¸ºå°å†™æˆåŠŸ afssdfas
è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®æˆåŠŸ aFASSaffdF
è½¬åŒ–ä¸ºå¤§å†™æˆåŠŸ AFASSAFFDF

D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\socket>go run 57-main.go
è¿æ¥æœåŠ¡å™¨æˆåŠŸ &{{0xc0000cca00}}
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
12
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 2
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ 12
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
312
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 3
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ 12hello, client
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
4213412
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 7
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ 312312hello, client
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
AFSSDFAS
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 8
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ 42134124213412hello, client
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
aFASSaffdF
ç»™æœåŠ¡å™¨å‘é€æ•°æ®æˆåŠŸ 10
è¯»å–æœåŠ¡å™¨å‘é€çš„æ•°æ®æˆåŠŸ AFSSDFASafssdfashello, client
è¯·å‘é€æ•°æ® -> å®¢æˆ·ç«¯
```

:::



### TCP æœåŠ¡ç«¯

**TCPæœåŠ¡ç«¯ç¨‹åºçš„å¤„ç†æµç¨‹ï¼š**

1. ç›‘å¬ç«¯å£

2. æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚å»ºç«‹é“¾æ¥

3. åˆ›å»ºgoroutineå¤„ç†é“¾æ¥ã€‚

æˆ‘ä»¬ä½¿ç”¨Goè¯­è¨€çš„netåŒ…å®ç°çš„TCPæœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// tcp/server/main.go

// TCP serverç«¯

// å¤„ç†å‡½æ•°
func process(conn net.Conn) {
    defer conn.Close()  // å…³é—­è¿æ¥
    for {
        reader := bufio.NewReader(conn)
        var buf [128]byte
        n, err := reader.Read(buf[:]) // è¯»å–æ•°æ®
        if err != nil {
            fmt.Println("read from client failed, err:", err)
            break
        }
        recvStr := string(buf[:n])
        fmt.Println("æ”¶åˆ°clientç«¯å‘æ¥çš„æ•°æ®ï¼š", recvStr)
        conn.Write([]byte(recvStr))  // å‘é€æ•°æ®
    }
}

func main() {
    listen, err := net.Listen("tcp", "127.0.0.1:20000")
    if err != nil {
        fmt.Println("listen failed, err:", err)
        return
    }
    for {
        conn, err := listen.Accept() // å»ºç«‹è¿æ¥
        if err != nil {
            fmt.Println("accept failed, err:", err)
            continue
        }
        go process(conn) // å¯åŠ¨ä¸€ä¸ªgoroutineå¤„ç†è¿æ¥
    }
}
```

å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ä¹‹åç¼–è¯‘æˆ`server`æˆ–`server.exe`å¯æ‰§è¡Œæ–‡ä»¶ã€‚



### TCP å®¢æˆ·ç«¯

**ä¸€ä¸ªTCPå®¢æˆ·ç«¯è¿›è¡ŒTCPé€šä¿¡çš„æµç¨‹å¦‚ä¸‹ï¼š**

1. å»ºç«‹ä¸æœåŠ¡ç«¯çš„é“¾æ¥
2. è¿›è¡Œæ•°æ®æ”¶å‘
3. å…³é—­é“¾æ¥

ä½¿ç”¨Goè¯­è¨€çš„ `net` åŒ…å®ç°çš„ `TCP` å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š

```go
// tcp/client/main.go

// å®¢æˆ·ç«¯
func main() {
    conn, err := net.Dial("tcp", "127.0.0.1:20000")
    if err != nil {
        fmt.Println("err :", err)
        return
    }
    defer conn.Close() // å…³é—­è¿æ¥
    inputReader := bufio.NewReader(os.Stdin)
    for {
        input, _ := inputReader.ReadString('\n') // è¯»å–ç”¨æˆ·è¾“å…¥
        inputInfo := strings.Trim(input, "\r\n")
        if strings.ToUpper(inputInfo) == "Q" { // å¦‚æœè¾“å…¥qå°±é€€å‡º
            return
        }
        _, err = conn.Write([]byte(inputInfo)) // å‘é€æ•°æ®
        if err != nil {
            return
        }
        buf := [512]byte{}
        n, err := conn.Read(buf[:])
        if err != nil {
            fmt.Println("recv failed, err:", err)
            return
        }
        fmt.Println(string(buf[:n]))
    }
}
```

âš ï¸ å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘æˆ `client` æˆ– `client.exe` å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…ˆå¯åŠ¨ `server` ç«¯å†å¯åŠ¨clientç«¯ï¼Œåœ¨clientç«¯è¾“å…¥ä»»æ„å†…å®¹å›è½¦ä¹‹åå°±èƒ½å¤Ÿåœ¨serverç«¯çœ‹åˆ°clientç«¯å‘é€çš„æ•°æ®ï¼Œä»è€Œå®ç°TCPé€šä¿¡ã€‚

å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘æˆ`client`æˆ–`client.exe`å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…ˆå¯åŠ¨`server`ç«¯å†å¯åŠ¨`client`ç«¯ï¼Œåœ¨`client`ç«¯è¾“å…¥ä»»æ„å†…å®¹å›è½¦ä¹‹åå°±èƒ½å¤Ÿåœ¨`server`ç«¯çœ‹åˆ°`client`ç«¯å‘é€çš„æ•°æ®ï¼Œä»è€Œå®ç°TCPé€šä¿¡ã€‚

## END é“¾æ¥

<ul><li><div><a href = '2.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '4.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

