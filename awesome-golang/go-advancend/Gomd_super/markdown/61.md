# Http

Goè¯­è¨€å†…ç½®çš„net/httpåŒ…ååˆ†çš„ä¼˜ç§€ï¼Œæä¾›äº†HTTPå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å®ç°ã€‚

##  net/httpä»‹ç»

Goè¯­è¨€å†…ç½®çš„net/httpåŒ…æä¾›äº†HTTPå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å®ç°ã€‚

## HTTPåè®®

è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼ˆHTTPï¼ŒHyperText Transfer Protocol)æ˜¯äº’è”ç½‘ä¸Šåº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¸€ç§ç½‘ç»œä¼ è¾“åè®®ï¼Œæ‰€æœ‰çš„WWWæ–‡ä»¶éƒ½å¿…é¡»éµå®ˆè¿™ä¸ªæ ‡å‡†ã€‚è®¾è®¡HTTPæœ€åˆçš„ç›®çš„æ˜¯ä¸ºäº†æä¾›ä¸€ç§å‘å¸ƒå’Œæ¥æ”¶HTMLé¡µé¢çš„æ–¹æ³•ã€‚

## HTTPå®¢æˆ·ç«¯

åŸºæœ¬çš„HTTP/HTTPSè¯·æ±‚ Getã€Headã€Postå’ŒPostFormå‡½æ•°å‘å‡ºHTTP/HTTPSè¯·æ±‚ã€‚

```go
resp, err := http.Get("http://5lmh.com/")
...
resp, err := http.Post("http://5lmh.com/upload", "image/jpeg", &buf)
...
resp, err := http.PostForm("http://5lmh.com/form",
    url.Values{"key": {"Value"}, "id": {"123"}})
```

ç¨‹åºåœ¨ä½¿ç”¨å®Œresponseåå¿…é¡»å…³é—­å›å¤çš„ä¸»ä½“ã€‚

```go
resp, err := http.Get("http://5lmh.com/")
if err != nil {
    // handle error
}
defer resp.Body.Close()
body, err := ioutil.ReadAll(resp.Body)  //è¯»å–æ‰€æœ‰çš„
// ...
```

## GETè¯·æ±‚ç¤ºä¾‹

ä½¿ç”¨net/httpåŒ…ç¼–å†™ä¸€ä¸ªç®€å•çš„å‘é€HTTPè¯·æ±‚çš„Clientç«¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
package main

import (
    "fmt"
    "io/ioutil"
    "net/http"
)

func main() {
    resp, err := http.Get("https://www.5lmh.com/")
    if err != nil {
        fmt.Println("get failed, err:", err)
        return
    }
    defer resp.Body.Close()
    body, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        fmt.Println("read from resp.Body failed,err:", err)
        return
    }
    fmt.Print(string(body))
}
```

> å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ä¹‹åç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰§è¡Œä¹‹åå°±èƒ½åœ¨ç»ˆç«¯æ‰“å°liwenzhou.comç½‘ç«™é¦–é¡µçš„å†…å®¹äº†ï¼Œæˆ‘ä»¬çš„æµè§ˆå™¨å…¶å®å°±æ˜¯ä¸€ä¸ªå‘é€å’Œæ¥æ”¶HTTPåè®®æ•°æ®çš„å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¹³æ—¶é€šè¿‡æµè§ˆå™¨è®¿é—®ç½‘é¡µå…¶å®å°±æ˜¯ä»ç½‘ç«™çš„æœåŠ¡å™¨æ¥æ”¶HTTPæ•°æ®ï¼Œç„¶åæµè§ˆå™¨ä¼šæŒ‰ç…§HTMLã€CSSç­‰è§„åˆ™å°†ç½‘é¡µæ¸²æŸ“å±•ç¤ºå‡ºæ¥ã€‚



## å¸¦å‚æ•°çš„GETè¯·æ±‚ç¤ºä¾‹

å…³äºGETè¯·æ±‚çš„å‚æ•°éœ€è¦ä½¿ç”¨Goè¯­è¨€å†…ç½®çš„net/urlè¿™ä¸ªæ ‡å‡†åº“æ¥å¤„ç†ã€‚

```go
func main() {
    apiUrl := "http://127.0.0.1:9090/get"
    // URL param
    data := url.Values{}
    data.Set("name", "æ¯è—¤")
    data.Set("age", "18")
    u, err := url.ParseRequestURI(apiUrl)
    if err != nil {
        fmt.Printf("parse url requestUrl failed,err:%v\n", err)
    }
    u.RawQuery = data.Encode() // URL encode
    fmt.Println(u.String())
    resp, err := http.Get(u.String())
    if err != nil {
        fmt.Println("post failed, err:%v\n", err)
        return
    }
    defer resp.Body.Close()
    b, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        fmt.Println("get resp failed,err:%v\n", err)
        return
    }
    fmt.Println(string(b))
}
```

å¯¹åº”çš„Serverç«¯HandlerFuncå¦‚ä¸‹ï¼š

```go
func getHandler(w http.ResponseWriter, r *http.Request) {
    defer r.Body.Close()
    data := r.URL.Query()
    fmt.Println(data.Get("name"))
    fmt.Println(data.Get("age"))
    answer := `{"status": "ok"}`
    w.Write([]byte(answer))
}
```

## Postè¯·æ±‚ç¤ºä¾‹

ä¸Šé¢æ¼”ç¤ºäº†ä½¿ç”¨net/httpåŒ…å‘é€GETè¯·æ±‚çš„ç¤ºä¾‹ï¼Œå‘é€POSTè¯·æ±‚çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
package main

import (
    "fmt"
    "io/ioutil"
    "net/http"
    "strings"
)

// net/http post demo

func main() {
    url := "http://127.0.0.1:9090/post"
    // è¡¨å•æ•°æ®
    //contentType := "application/x-www-form-urlencoded"
    //data := "name=æ¯è—¤&age=18"
    // json
    contentType := "application/json"
    data := `{"name":"æ¯è—¤","age":18}`
    resp, err := http.Post(url, contentType, strings.NewReader(data))
    if err != nil {
        fmt.Println("post failed, err:%v\n", err)
        return
    }
    defer resp.Body.Close()
    b, err := ioutil.ReadAll(resp.Body)
    if err != nil {
        fmt.Println("get resp failed,err:%v\n", err)
        return
    }
    fmt.Println(string(b))
}
```

å¯¹åº”çš„Serverç«¯HandlerFuncå¦‚ä¸‹ï¼š

```go
func postHandler(w http.ResponseWriter, r *http.Request) {
    defer r.Body.Close()
    // 1. è¯·æ±‚ç±»å‹æ˜¯application/x-www-form-urlencodedæ—¶è§£æformæ•°æ®
    r.ParseForm()
    fmt.Println(r.PostForm) // æ‰“å°formæ•°æ®
    fmt.Println(r.PostForm.Get("name"), r.PostForm.Get("age"))
    // 2. è¯·æ±‚ç±»å‹æ˜¯application/jsonæ—¶ä»r.Bodyè¯»å–æ•°æ®
    b, err := ioutil.ReadAll(r.Body)
    if err != nil {
        fmt.Println("read request.Body failed, err:%v\n", err)
        return
    }
    fmt.Println(string(b))
    answer := `{"status": "ok"}`
    w.Write([]byte(answer))
}
```

## è‡ªå®šä¹‰Client

è¦ç®¡ç†HTTPå®¢æˆ·ç«¯çš„å¤´åŸŸã€é‡å®šå‘ç­–ç•¥å’Œå…¶ä»–è®¾ç½®ï¼Œåˆ›å»ºä¸€ä¸ªClientï¼š

```go
client := &http.Client{
    CheckRedirect: redirectPolicyFunc,
}
resp, err := client.Get("http://5lmh.com")
// ...
req, err := http.NewRequest("GET", "http://5lmh.com", nil)
// ...
req.Header.Add("If-None-Match", `W/"wyzzy"`)
resp, err := client.Do(req)
// ...
```

## è‡ªå®šä¹‰Transport

è¦ç®¡ç†ä»£ç†ã€TLSé…ç½®ã€keep-aliveã€å‹ç¼©å’Œå…¶ä»–è®¾ç½®ï¼Œåˆ›å»ºä¸€ä¸ªTransportï¼š

```go
tr := &http.Transport{
    TLSClientConfig:    &tls.Config{RootCAs: pool},
    DisableCompression: true,
}
client := &http.Client{Transport: tr}
resp, err := client.Get("https://5lmh.com")
```

Clientå’ŒTransportç±»å‹éƒ½å¯ä»¥å®‰å…¨çš„è¢«å¤šä¸ªgoç¨‹åŒæ—¶ä½¿ç”¨ã€‚å‡ºäºæ•ˆç‡è€ƒè™‘ï¼Œåº”è¯¥ä¸€æ¬¡å»ºç«‹ã€å°½é‡é‡ç”¨ã€‚

## æœåŠ¡ç«¯

### é»˜è®¤çš„Server

ListenAndServeä½¿ç”¨æŒ‡å®šçš„ç›‘å¬åœ°å€å’Œå¤„ç†å™¨å¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡ç«¯ã€‚å¤„ç†å™¨å‚æ•°é€šå¸¸æ˜¯nilï¼Œè¿™è¡¨ç¤ºé‡‡ç”¨åŒ…å˜é‡DefaultServeMuxä½œä¸ºå¤„ç†å™¨ã€‚

Handleå’ŒHandleFuncå‡½æ•°å¯ä»¥å‘DefaultServeMuxæ·»åŠ å¤„ç†å™¨ã€‚

```go
http.Handle("/foo", fooHandler)
http.HandleFunc("/bar", func(w http.ResponseWriter, r *http.Request) {
    fmt.Fprintf(w, "Hello, %q", html.EscapeString(r.URL.Path))
})
log.Fatal(http.ListenAndServe(":8080", nil))
```

### é»˜è®¤çš„Serverç¤ºä¾‹

ä½¿ç”¨Goè¯­è¨€ä¸­çš„net/httpåŒ…æ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„æ¥æ”¶HTTPè¯·æ±‚çš„Serverç«¯ç¤ºä¾‹ï¼Œnet/httpåŒ…æ˜¯å¯¹netåŒ…çš„è¿›ä¸€æ­¥å°è£…ï¼Œä¸“é—¨ç”¨æ¥å¤„ç†HTTPåè®®çš„æ•°æ®ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š

```go
// http server

func sayHello(w http.ResponseWriter, r *http.Request) {
    fmt.Fprintln(w, "Hello æ¯è—¤ï¼")
}

func main() {
    http.HandleFunc("/", sayHello)
    err := http.ListenAndServe(":9090", nil)
    if err != nil {
        fmt.Printf("http server failed, err:%v\n", err)
        return
    }
}
```

å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘ä¹‹åæ‰§è¡Œï¼Œæ‰“å¼€ä½ ç”µè„‘ä¸Šçš„æµè§ˆå™¨åœ¨åœ°å€æ è¾“å…¥127.0.0.1:9090å›è½¦ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿçœ‹åˆ° `Hello æ¯è—¤ï¼`

### è‡ªå®šä¹‰Server

è¦ç®¡ç†æœåŠ¡ç«¯çš„è¡Œä¸ºï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Serverï¼š

```go
s := &http.Server{
    Addr:           ":8080",
    Handler:        myHandler,
    ReadTimeout:    10 * time.Second,
    WriteTimeout:   10 * time.Second,
    MaxHeaderBytes: 1 << 20,
}
log.Fatal(s.ListenAndServe())
```

## END é“¾æ¥
<ul><li><div><a href = '60.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '62.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

