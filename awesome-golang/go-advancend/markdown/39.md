+ [author](https://github.com/3293172751)

# ç¬¬39èŠ‚ å†…å­˜ç®¡ç†

+ [å›åˆ°ç›®å½•](../README.md)
+ [ä¸Šä¸€èŠ‚](38.md)
> â¤ï¸ğŸ’•ğŸ’•Goè¯­è¨€é«˜çº§ç¯‡ç« ,åœ¨æ­¤ä¹‹å‰å»ºè®®æ‚¨å…ˆäº†è§£åŸºç¡€å’Œè¿›é˜¶ç¯‡ã€‚Myblog:[http://nsddd.top](http://nsddd.top/)
>
> ###  **[Goè¯­è¨€åŸºç¡€ç¯‡](https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/TOC.md)**
>
> ###  **[Goè¯­è¨€100ç¯‡è¿›é˜¶](https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/Gomd_super/README.md)**
---
[TOC]

## å†…å­˜ç®¡ç†

ç¨‹åºä¸­çš„æ•°æ®å’Œå˜é‡éƒ½ä¼šè¢«åˆ†é…åˆ°ç¨‹åºæ‰€åœ¨çš„è™šæ‹Ÿå†…å­˜ä¸­

**å†…å­˜ç©ºé—´åŒ…å«ä¸¤ä¸ªé‡è¦åŒºåŸŸï¼š**

+ æ ˆåŒºï¼ˆStackï¼‰
+ å †åŒºï¼ˆHeapï¼‰

å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€è¿”å›å€¼ä»¥åŠå±€éƒ¨å˜é‡å¤§éƒ½ä¼šè¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¼šç”±ç¼–è¯‘å™¨è¿›è¡Œç®¡ç†ï¼›ä¸åŒç¼–ç¨‹è¯­è¨€ä½¿ç”¨ä¸åŒçš„æ–¹æ³•ç®¡ç†å †åŒºçš„å†…å­˜ï¼ŒC++ ç­‰ç¼–ç¨‹è¯­è¨€ä¼šç”±å·¥ç¨‹å¸ˆä¸»åŠ¨ç”³è¯·å’Œé‡Šæ”¾å†…å­˜ï¼ŒGo ä»¥åŠ Java ç­‰ ç¼–ç¨‹è¯­è¨€ ä¼šç”±å·¥ç¨‹å¸ˆå’Œç¼–è¯‘å™¨å…±åŒç®¡ç†ï¼Œå †ä¸­çš„å¯¹è±¡ç”±å†…å­˜åˆ†é…å™¨åˆ†é…å¹¶ç”±åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚

> å¯¹äº Java å’Œ Golang æ‰€æ¨å´‡çš„å†…å­˜ç®¡ç†æ–¹å¼æ˜¯ï¼š æ‰‹åŠ¨ç®¡ç†éº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ã€‚æˆ‘æœ‰èƒ½åŠ›æ¥å¸®ä½ åšå†…å­˜ç®¡ç†
>
> å¯¹äº C å’Œ CPP æ‰€æ¨å´‡çš„å†…å­˜ç®¡ç†çš„æ–¹å¼æ˜¯ï¼š å†…å­˜ç®¡ç†å¤ªé‡è¦äº†ï¼Œæ‰€ä»¥å¦‚æœäº¤ç»™æœºå™¨ç®¡ç†æˆ‘ä¸èƒ½æ”¾å¿ƒã€‚



## è®¾è®¡åŸç†

å†…å­˜ç®¡ç†ä¸€èˆ¬åŒ…å«ä¸‰ä¸ªä¸åŒçš„ç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯ç”¨æˆ·ç¨‹åºï¼ˆMutatorï¼‰ã€åˆ†é…å™¨ï¼ˆAllocatorï¼‰å’Œæ”¶é›†å™¨ï¼ˆCollectorï¼‰ï¼Œå½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œå®ƒä¼šé€šè¿‡å†…å­˜åˆ†é…å™¨ç”³è¯·æ–°å†…å­˜ï¼Œè€Œåˆ†é…å™¨ä¼šè´Ÿè´£ä»å †ä¸­åˆå§‹åŒ–ç›¸åº”çš„å†…å­˜åŒºåŸŸã€‚

![image-20230301163511423](http://sm.nsddd.top/sm202303011635560.png)

åœ¨å‰ä¸¤èŠ‚ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº† `Heap`ï¼š

`Heap`ï¼šå †ç©ºé—´ã€‚è¿™ä¸ªå°±æ˜¯ç¨‹åºé‡ŒåŠ¨æ€åˆ†é…çš„ç©ºé—´ã€‚linuxä¸‹ä½¿ç”¨ malloc è°ƒç”¨æ‰©å±•ï¼ˆç”¨brk/sbrk æ‰©å±•å†…å­˜ç©ºé—´ï¼‰ï¼Œfree å‡½æ•°é‡Šæ”¾ï¼ˆä¹Ÿå°±æ˜¯ç¼©å‡å†…å­˜ç©ºé—´ï¼‰ 

å¯¹äº Goè¯­è¨€ æ¥è¯´ï¼Œå°±æ˜¯æœ‰ Conllectorï¼ˆåƒåœ¾å›æ”¶å™¨ï¼‰ï¼Œå›æ”¶å†…å­˜ç©ºé—´ï¼Œç»å¸¸å»æ‰«æã€‚

+ åˆå§‹åŒ–è¿ç»­å†…å­˜å—ä½œä¸ºå †
+ åœ¨å†…å­˜ç”³è¯·çš„æ—¶å€™ï¼ŒAllocator ä»å †å†…å­˜çš„æœªåˆ†é…åŒºåŸŸåˆ†å‰²å°çš„å†…å­˜å—
+ ç”¨é“¾è¡¨å°†å·²ç»åˆ†é…çš„å†…å­˜é“¾æ¥
+ éœ€è¦ä¿¡æ¯æ‰«ææ¯ä¸ªå†…å­˜å—çš„ å…ƒæ•°æ® ï¼ˆmatedata) ï¼šå¤§å°ã€æ—¶å€™ä½¿ç”¨ã€ä¸‹ä¸€ä¸ªå†…å­˜å—çš„åœ°å€
+ å†…å­˜å›æ”¶å°±æ˜¯æ‰«æå †ç©ºé—´ï¼Œå°†ä¸åœ¨ä½¿ç”¨çš„å†…å­˜è®¾ç½®ä¸º `unused`



**Goè¯­è¨€çš„å†…å­˜åˆ†é…å™¨æ€ä¹ˆæ ·ï¼Ÿ**

> Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨å®ç°éå¸¸å¤æ‚ï¼Œåœ¨åˆ†æå†…å­˜åˆ†é…å™¨çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å†…å­˜åˆ†é…çš„è®¾è®¡åŸç†ï¼ŒæŒæ¡å†…å­˜çš„åˆ†é…è¿‡ç¨‹ã€‚è¿™é‡Œä¼šè¯¦ç»†ä»‹ç»å†…å­˜åˆ†é…å™¨çš„åˆ†é…æ–¹æ³•ä»¥åŠ Go è¯­è¨€å†…å­˜åˆ†é…å™¨çš„åˆ†çº§åˆ†é…ã€è™šæ‹Ÿå†…å­˜å¸ƒå±€å’Œåœ°å€ç©ºé—´ã€‚



### åˆ†é…æ–¹æ³•

ç¼–ç¨‹è¯­è¨€çš„å†…å­˜åˆ†é…å™¨ä¸€èˆ¬åŒ…å«ä¸¤ç§åˆ†é…æ–¹æ³•ï¼Œ

+ ä¸€ç§æ˜¯çº¿æ€§åˆ†é…å™¨ï¼ˆSequential Allocatorï¼ŒBump Allocatorï¼‰
+ å¦ä¸€ç§æ˜¯ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰



#### çº¿æ€§åˆ†é…å™¨

**çº¿æ€§åˆ†é…ï¼ˆBump Allocatorï¼‰æ˜¯ä¸€ç§é«˜æ•ˆçš„å†…å­˜åˆ†é…æ–¹æ³•**ï¼Œä½†æ˜¯æœ‰è¾ƒå¤§çš„å±€é™æ€§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨çº¿æ€§åˆ†é…å™¨æ—¶ï¼Œåªéœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªæŒ‡å‘å†…å­˜ç‰¹å®šä½ç½®çš„æŒ‡é’ˆï¼Œå¦‚æœç”¨æˆ·ç¨‹åºå‘åˆ†é…å™¨ç”³è¯·å†…å­˜ï¼Œåˆ†é…å™¨åªéœ€è¦æ£€æŸ¥å‰©ä½™çš„ç©ºé—²å†…å­˜ã€è¿”å›åˆ†é…çš„å†…å­˜åŒºåŸŸå¹¶ä¿®æ”¹æŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œå³ç§»åŠ¨ä¸‹å›¾ä¸­çš„æŒ‡é’ˆï¼š

![image-20230301164247852](http://sm.nsddd.top/sm202303011642926.png)

è™½ç„¶çº¿æ€§åˆ†é…å™¨å®ç°ä¸ºå®ƒå¸¦æ¥äº†è¾ƒå¿«çš„æ‰§è¡Œé€Ÿåº¦ä»¥åŠè¾ƒä½çš„å®ç°å¤æ‚åº¦ï¼Œ**ä½†æ˜¯çº¿æ€§åˆ†é…å™¨æ— æ³•åœ¨å†…å­˜è¢«é‡Šæ”¾æ—¶é‡ç”¨å†…å­˜ã€‚**

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœå·²ç»åˆ†é…çš„å†…å­˜è¢«å›æ”¶ï¼Œçº¿æ€§åˆ†é…å™¨æ— æ³•é‡æ–°åˆ©ç”¨çº¢è‰²çš„å†…å­˜ï¼š

![image-20230301164710407](http://sm.nsddd.top/sm202303011647507.png)

å› ä¸ºçº¿æ€§åˆ†é…å™¨å…·æœ‰ä¸Šè¿°ç‰¹æ€§ï¼Œ**æ‰€ä»¥éœ€è¦ä¸åˆé€‚çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆä½¿ç”¨**ï¼Œä¾‹å¦‚ï¼šæ ‡è®°å‹ç¼©ï¼ˆMark-Compactï¼‰ã€å¤åˆ¶å›æ”¶ï¼ˆCopying GCï¼‰å’Œåˆ†ä»£å›æ”¶ï¼ˆGenerational GCï¼‰ç­‰ç®—æ³•ï¼Œå®ƒä»¬å¯ä»¥é€šè¿‡æ‹·è´çš„æ–¹å¼æ•´ç†å­˜æ´»å¯¹è±¡çš„ç¢ç‰‡ï¼Œå°†ç©ºé—²å†…å­˜å®šæœŸåˆå¹¶ï¼Œè¿™æ ·å°±èƒ½åˆ©ç”¨çº¿æ€§åˆ†é…å™¨çš„æ•ˆç‡æå‡å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½äº†ã€‚

**å› ä¸ºçº¿æ€§åˆ†é…å™¨éœ€è¦ä¸å…·æœ‰æ‹·è´ç‰¹æ€§çš„åƒåœ¾å›æ”¶ç®—æ³•é…åˆï¼Œæ‰€ä»¥ C å’Œ C++ ç­‰éœ€è¦ç›´æ¥å¯¹å¤–æš´éœ²æŒ‡é’ˆçš„è¯­è¨€å°±æ— æ³•ä½¿ç”¨è¯¥ç­–ç•¥**ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€èŠ‚è¯¦ç»†ä»‹ç»å¸¸è§åƒåœ¾å›æ”¶ç®—æ³•çš„è®¾è®¡åŸç†ã€‚



#### ç©ºé—²é“¾è¡¨åˆ†é…å™¨

ç©ºé—²é“¾è¡¨åˆ†é…å™¨ï¼ˆFree-List Allocatorï¼‰å¯ä»¥é‡ç”¨å·²ç»è¢«é‡Šæ”¾çš„å†…å­˜ï¼Œ**å®ƒåœ¨å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚**å½“ç”¨æˆ·ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œç©ºé—²é“¾è¡¨åˆ†é…å™¨ä¼šä¾æ¬¡éå†ç©ºé—²çš„å†…å­˜å—ï¼Œæ‰¾åˆ°è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç”³è¯·æ–°çš„èµ„æºå¹¶ä¿®æ”¹é“¾è¡¨ï¼š

![image-20230301165138387](http://sm.nsddd.top/sm202303011651611.png)

å› ä¸ºä¸åŒçš„å†…å­˜å—é€šè¿‡æŒ‡é’ˆæ„æˆäº†é“¾è¡¨ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼çš„åˆ†é…å™¨å¯ä»¥é‡æ–°åˆ©ç”¨å›æ”¶çš„èµ„æºï¼Œä½†æ˜¯å› ä¸ºåˆ†é…å†…å­˜æ—¶éœ€è¦éå†é“¾è¡¨ï¼Œæ‰€ä»¥å®ƒçš„æ—¶é—´å¤æ‚åº¦æ˜¯ `O(n)`ã€‚

ç©ºé—²é“¾è¡¨åˆ†é…å™¨å¯ä»¥é€‰æ‹©ä¸åŒçš„ç­–ç•¥åœ¨é“¾è¡¨ä¸­çš„å†…å­˜å—ä¸­è¿›è¡Œé€‰æ‹©ï¼Œæœ€å¸¸è§çš„æ˜¯ä»¥ä¸‹å››ç§ï¼š

+ é¦–æ¬¡é€‚åº”ï¼ˆFirst-Fitï¼‰â€” ä»é“¾è¡¨å¤´å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
+ å¾ªç¯é¦–æ¬¡é€‚åº”ï¼ˆNext-Fitï¼‰â€” ä»ä¸Šæ¬¡éå†çš„ç»“æŸä½ç½®å¼€å§‹éå†ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¤§å°å¤§äºç”³è¯·å†…å­˜çš„å†…å­˜å—ï¼›
+ æœ€ä¼˜é€‚åº”ï¼ˆBest-Fitï¼‰â€” ä»é“¾è¡¨å¤´éå†æ•´ä¸ªé“¾è¡¨ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å†…å­˜å—ï¼›
+ éš”ç¦»é€‚åº”ï¼ˆSegregated-Fitï¼‰â€” å°†å†…å­˜åˆ†å‰²æˆå¤šä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­çš„å†…å­˜å—å¤§å°ç›¸åŒï¼Œç”³è¯·å†…å­˜æ—¶å…ˆæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„é“¾è¡¨ï¼Œå†ä»é“¾è¡¨ä¸­é€‰æ‹©åˆé€‚çš„å†…å­˜å—ï¼›



ä¸Šè¿°å››ç§ç­–ç•¥çš„å‰ä¸‰ç§å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼ŒGo è¯­è¨€ä½¿ç”¨çš„å†…å­˜åˆ†é…ç­–ç•¥ä¸ç¬¬å››ç§ç­–ç•¥æœ‰äº›ç›¸ä¼¼ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹å›¾äº†è§£è¯¥ç­–ç•¥çš„åŸç†ï¼š

![image-20230301165249539](http://sm.nsddd.top/sm202303011652621.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¯¥ç­–ç•¥ä¼šå°†å†…å­˜åˆ†å‰²æˆç”± 4ã€8ã€16ã€32 å­—èŠ‚çš„å†…å­˜å—ç»„æˆçš„é“¾è¡¨ï¼Œå½“æˆ‘ä»¬å‘å†…å­˜åˆ†é…

å™¨ç”³è¯· 8 å­—èŠ‚çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šåœ¨ä¸Šå›¾ä¸­æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—²å†…å­˜å—å¹¶è¿”å›ã€‚éš”ç¦»é€‚åº”çš„åˆ†é…ç­–ç•¥å‡å°‘äº†éœ€è¦éå†çš„å†…å­˜å—æ•°é‡ï¼Œæé«˜äº†å†…å­˜åˆ†é…çš„æ•ˆç‡ã€‚



**åˆ†çº§åˆ†é…:**

çº¿ç¨‹ç¼“å­˜åˆ†é…ï¼ˆThread-Caching Mallocï¼ŒTCMallocï¼‰æ˜¯ç”¨äºåˆ†é…å†…å­˜çš„æœºåˆ¶ï¼Œå®ƒæ¯” glibc ä¸­çš„ `malloc` è¿˜è¦å¿«å¾ˆå¤šã€‚Go è¯­è¨€çš„å†…å­˜åˆ†é…å™¨å°±å€Ÿé‰´äº† TCMalloc çš„è®¾è®¡å®ç°é«˜é€Ÿçš„å†…å­˜åˆ†é…ï¼Œå®ƒçš„æ ¸å¿ƒç†å¿µæ˜¯ä½¿ç”¨å¤šçº§ç¼“å­˜å°†å¯¹è±¡æ ¹æ®å¤§å°åˆ†ç±»ï¼Œå¹¶æŒ‰ç…§ç±»åˆ«å®æ–½ä¸åŒçš„åˆ†é…ç­–ç•¥ã€‚



## ThreadCacheMalloc

åœ¨äº†è§£Golangçš„å†…å­˜ç®¡ç†ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸‹åŸºæœ¬ç”³è¯·å†…å­˜æ¨¡å¼ï¼Œå³TCMalloc(Thread Cache malloc)ã€‚

golangçš„å†…å­˜ç®¡ç†å°±æ˜¯åŸºäºTCMallocçš„æ ¸å¿ƒæ€æƒ³æ¥æ„å»ºçš„ã€‚

TCMalloc æ˜¯ä¸€ç§å†…å­˜åˆ†é…å™¨ï¼Œæ—¨åœ¨æ›¿ä»£å…·æœ‰ä»¥ä¸‹ç‰¹å¾çš„ç³»ç»Ÿé»˜è®¤åˆ†é…å™¨ï¼š

> **TCMallocæœ€å¤§ä¼˜åŠ¿å°±æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„ç‹¬ç«‹å†…å­˜æ± ã€‚**

+ å¯¹å¤§å¤šæ•°å¯¹è±¡è¿›è¡Œå¿«é€Ÿã€æ— äº‰è®®çš„åˆ†é…å’Œè§£é™¤åˆ†é…ã€‚æ ¹æ®æ¨¡å¼ï¼ŒæŒ‰çº¿ç¨‹æˆ–æŒ‰é€»è¾‘ CPU ç¼“å­˜å¯¹è±¡ã€‚å¤§å¤šæ•°åˆ†é…ä¸éœ€è¦é‡‡ç”¨é”ï¼Œå› æ­¤å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºçš„äº‰ç”¨ç‡è¾ƒä½ä¸”å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ã€‚
+ çµæ´»ä½¿ç”¨å†…å­˜ï¼Œå› æ­¤é‡Šæ”¾çš„å†…å­˜å¯ä»¥é’ˆå¯¹ä¸åŒçš„å¯¹è±¡å¤§å°é‡å¤ä½¿ç”¨ï¼Œæˆ–è¿”å›ç»™æ“ä½œç³»ç»Ÿã€‚
+ é€šè¿‡åˆ†é…ç›¸åŒå¤§å°çš„å¯¹è±¡çš„â€œé¡µâ€æ¥é™ä½æ¯ä¸ªå¯¹è±¡çš„å†…å­˜å¼€é”€ã€‚ä»è€ŒèŠ‚çœç©ºé—´åœ°è¡¨ç¤ºå°ç‰©ä½“ã€‚
+ ä½å¼€é”€é‡‡æ ·ï¼Œå¯è¯¦ç»†äº†è§£åº”ç”¨ç¨‹åºå†…å­˜ä½¿ç”¨æƒ…å†µã€‚

![image-20230301165846390](http://sm.nsddd.top/sm202303011658491.png)

**å¯¹è±¡å¤§å°å®šä¹‰ï¼š**

+ **å°å¯¹è±¡å¤§å°**ï¼š0 ~ 256 kb
+ **ä¸­å¯¹è±¡å¤§å°**ï¼š256kb ~ 1 MB 
+ **å¤§å¯¹è±¡å¤§å°**ï¼š> 1MB

ä¸‹é¢åˆ†åˆ«ä»‹ç»ä¸‹ç›¸å…³å†…å­˜æ± ï¼š



### ThreadCacheï¼ˆå°å¯¹è±¡å†…å­˜å¿«çš„ç”³è¯·ï¼‰:

ThreadCacheæ˜¯æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ç¼“å­˜ï¼Œèƒ½å¤Ÿæ˜æ˜¾æé«˜Threadè·å–é«˜å‘½ä¸­çš„æ•°æ®ã€‚

Thread Cacheä½œä¸ºçº¿ç¨‹ç‹¬ç«‹çš„äº¤äº’å†…å­˜ï¼Œè®¿é—®æ— éœ€åŠ é”ã€‚

ThreadCacheæ˜¯ä»å †ç©ºé—´ä¸€æ¬¡æ€§ç”³è¯·ï¼Œåªè§¦å‘ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ã€‚



### CentralCacheï¼ˆå°å¯¹è±¡å†…å­˜å¿«çš„ç”³è¯·ï¼‰:

å½“ThreadCacheç¼“å­˜ä¸è¶³æ—¶ï¼Œå°±ä¼šä»CentralCacheè·å–ã€‚

å½“ThreadCacheç¼“å­˜å……è¶³æˆ–è¿‡å¤šæ—¶ï¼Œåˆ™ä¼šå°†å†…å­˜é€€è¿˜ç»™Central Cacheã€‚

Central Cacheç”±äºå…±äº«ï¼Œè®¿é—®çš„æ—¶å€™æ—¶å€™éœ€è¦åŠ é”ã€‚



### PageHeapï¼ˆä¸­ã€å¤§å¯¹è±¡å†…å­˜å¿«çš„ç”³è¯·ï¼‰:

Page Heapä¹Ÿæ˜¯ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ä»è™šæ‹Ÿå†…å­˜ä¸­ç”³è¯·ã€‚

Page Heapä¹Ÿæ˜¯å…¨å±€çš„ï¼Œè®¿é—®éœ€è¦åŠ é”ã€‚

Central Cacheæ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜æ—¶ï¼Œå°±ä¼šä»Page Heapè·å–ã€‚

å½“Central Cacheå†…å­˜è¿‡å¤šæˆ–è€…å……è¶³æ—¶ï¼Œä¼šç›´æ¥ä»Page Heapè·å–ã€‚



## TCMallocæ¨¡å‹ç›¸å…³åŸºç¡€ç»“æ„ï¼ˆPageã€Spanã€Size Classï¼‰

### Page

TCMallocå°†è™šæ‹Ÿå†…å­˜ç©ºé—´åˆ’åˆ†ä¸ºåŒç­‰å¤§å°çš„Pageï¼Œæ¯ä¸ªPageé»˜è®¤æ˜¯8KBï¼Œå¹¶ä¸”æ¯åˆ†Pageéƒ½æ ‡è®°äº†IDç¼–å·ï¼ŒIDç¼–å·çš„å¥½å¤„æ˜¯ï¼š**å¯ä»¥æ ¹æ®ä»»æ„å†…å­˜çš„åœ°å€æŒ‡é’ˆï¼Œæ ¹æ®å›ºå®šç®—æ³•åç§»è®¡ç®—å‡ºæ‰€åœ¨çš„Pageã€‚**

![image-20230301170643817](http://sm.nsddd.top/sm202303011706945.png)



### Span

å¤šä¸ªè¿ç»­çš„Pageç§°ä¸ºä¸€ä¸ªSpanã€‚

**TCMallocæ˜¯ä»¥Spanä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„ã€‚**

æ¯ä¸ªspanè®°å½•äº†èµ·å§‹Pageçš„ç¼–å·startå’Œä¸€å…±æœ‰å¤šå°‘ä¸ªè¿ç»­Pageçš„æ•°é‡lengthã€‚

Spanå’ŒSpanä¹‹é—´çš„ç®¡ç†æ˜¯ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼æ„å»ºã€‚

![image-20230301170705593](http://sm.nsddd.top/sm202303011707724.png)



### Size Class

åŒå±äºåŒä¸€ä¸ªå†…å­˜å¤§å°çš„é›†åˆï¼Œè¯¥é›†åˆä¸ºä¸€ä¸ªSize Class ã€‚

ä¾‹å¦‚ï¼šå†…å­˜å—å¤§å°ä¸º8B çš„éƒ½å±äºSizeClass1ï¼Œå†…å­˜å—å¤§å°ä¸º16B çš„éƒ½å±äºSizeClass2ã€‚

SizeClassã€Spanã€Pageç”¨ä¸€å¼ å›¾è¡¨ç¤ºå¦‚ä¸‹ã€‚

![image-20230301170727758](http://sm.nsddd.top/sm202303011707888.png)



**Golangå†…å­˜ç®¡ç†æ¨¡å‹ä¸TCMallocè®¾è®¡å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯ä¸€äº›è§„åˆ™å’Œæµç¨‹å­˜åœ¨å·®å¼‚ã€‚**

<img src="http://sm.nsddd.top/sm202303011711729.png" alt="image-20230301171114542" style="zoom:33%;" />



Golangå†…å­˜ç®¡ç†ä¸­ä¾ç„¶ä¿ç•™TCMallocä¸­çš„Pageã€Spanã€Size Classç­‰æ¦‚å¿µã€‚

### Pageï¼ˆåŒTCMallocç›¸åŒï¼‰

ä¸TCMallocä¸­çš„Pageä¸€æ ·ï¼Œä¸€ä¸ªPageå¤§å°ä»ç„¶æ—¶8KBã€‚

Pageæ˜¯å†…å­˜ç®¡ç†ä¸è™šæ‹Ÿå†…å­˜äº¤äº’çš„æœ€å°å•å…ƒã€‚

### mSpanï¼ˆåŒTCMallocç›¸åŒï¼‰

ä¸TCMallocä¸­çš„spanä¸€è‡´ï¼Œmspnä¹Ÿæ˜¯ä¸€ç»„è¿ç»­çš„Pageã€‚

### object(TCMallocä¸­æ²¡æœ‰)

ä¸€ä¸ªspanåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè¢«åˆ‡å‰²æˆä¸€å †ç›¸åŒå¤§å°çš„object.

ä¾‹å¦‚ï¼šä¸€ä¸ªobjectå¤§å°ä¸º16bï¼Œspanå¤§å°æ—¶8K ï¼Œé‚£ä¹ˆå°±ä¼šåˆå§‹åŒ–å‡º8+1024/16=512ä¸ªobjectã€‚

> Pageæ˜¯Golangå†…å­˜ç®¡ç†ä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„åŸºæœ¬å•å…ƒã€‚
>
> Objectæ˜¯å¯¹è±¡å­˜å‚¨çš„åŸºæœ¬å•å…ƒã€‚



## æœ€å

Goè¯­è¨€åœ¨æ—©æœŸçš„æ—¶å€™ç¡®å® GC ä¸æ€ä¹ˆæ ·ï¼Œæ—¶é—´å¤ªä¹…äº†ï¼Œä½†æ˜¯ç»è¿‡å‡ ä»£çš„ä¼˜åŒ–ï¼Œè¶Šæ¥è¶Šå¥½äº†ã€‚



## END é“¾æ¥

+ [å›åˆ°ç›®å½•](../README.md)
+ [ä¸Šä¸€èŠ‚](38.md)
+ [ä¸‹ä¸€èŠ‚](40.md)
---
+ [å‚ä¸è´¡çŒ®â¤ï¸ğŸ’•ğŸ’•](https://github.com/cubxxw/awesome-cs-cloudnative-blockchain/blob/master/Git/git-contributor.md)



### Links

Memory management in Go generally consists of three different components: the user program (Mutator), allocator, and collector. When a user program requests memory, it does so through the memory allocator, and when the memory is no longer needed, it is returned to the allocator.

Go is a garbage-collected language that has pointers but does not have as much flexibility in pointer operations as C. In most cases, users do not need to manage memory themselves, but understanding how Go manages memory is essential to writing efficient code.

Go's memory management system consists of two primary components: a memory allocator and a garbage collector. The allocator is responsible for allocating and deallocating memory, while the garbage collector is responsible for freeing memory that is no longer in use.

The Go memory allocator is a modified version of the Hoard allocator. The allocator uses per-thread caches and multiple page sizes to reduce contention and improve performance. When a user program requests memory, the allocator first checks the per-thread cache for available memory. If the cache is empty, the allocator allocates a new page of memory from the operating system and adds it to the per-thread cache.

The garbage collector in Go is a concurrent, mark-and-sweep collector that runs in the background while the user program continues to execute. When the garbage collector runs, it marks all the memory that is still in use, and then frees the memory that is not marked. The garbage collector is designed to minimize pauses in the user program, so it runs concurrently with the user program and only stops the program briefly to perform mark and sweep operations.

Overall, Go's memory management system is designed to be efficient and minimize the burden on users, while still providing strong guarantees about memory safety.

**å‚è€ƒèµ„æ–™ï¼š**

+ [Go è¯­è¨€å†…å­˜åˆ†é…å™¨çš„å®ç°åŸç† - é¢å‘ä¿¡ä»°ç¼–ç¨‹](https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/)
+ [å†…å­˜ç®¡ç†Â· æ·±å…¥è§£æGo - tiancaiamao](https://tiancaiamao.gitbooks.io/go-internals/content/zh/06.0.html)
+ [è¶…å¹²è´§ï¼å½»åº•ææ‡‚Golangå†…å­˜ç®¡ç†å’Œåƒåœ¾å›æ”¶ - è…¾è®¯äº‘](https://cloud.tencent.com/developer/article/2051585)
+ https://draveness.me/golang/docs/part3-runtime/ch07-memory/golang-memory-allocator/
+ https://blog.51cto.com/u_10983441/5358688
