+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬11èŠ‚ è®¾è®¡ä¸€å¥—ç§‘å­¦çš„é”™è¯¯ç 

<br>

<div><a href = '10.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '12.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]

[TOC]

## å¦‚ä½•è®¾è®¡ä¸€å¥—ç§‘å­¦çš„é”™è¯¯ç 

ç°ä»£çš„è½¯ä»¶æ¶æ„ï¼Œå¾ˆå¤šéƒ½æ˜¯å¯¹å¤–æš´éœ² RESTful API æ¥å£ï¼Œå†…éƒ¨ç³»ç»Ÿé€šä¿¡é‡‡ç”¨ RPC åè®®ã€‚å› ä¸º RESTful API æ¥å£æœ‰ä¸€äº›å¤©ç”Ÿçš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚è§„èŒƒã€è°ƒè¯•å‹å¥½ã€æ˜“æ‡‚ï¼Œæ‰€ä»¥é€šå¸¸ä½œä¸ºç›´æ¥é¢å‘ç”¨æˆ·çš„é€šä¿¡è§„èŒƒã€‚

æ—¢ç„¶æ˜¯ç›´æ¥é¢å‘ç”¨æˆ·ï¼Œé‚£ä¹ˆé¦–å…ˆå°±è¦æ±‚æ¶ˆæ¯è¿”å›æ ¼å¼æ˜¯è§„èŒƒçš„ï¼›å…¶æ¬¡ï¼Œå¦‚æœæ¥å£æŠ¥é”™ï¼Œè¿˜è¦èƒ½ç»™ç”¨æˆ·æä¾›ä¸€äº›æœ‰ç”¨çš„æŠ¥é”™ä¿¡æ¯ï¼Œ**é€šå¸¸éœ€è¦åŒ…å« Code ç ï¼ˆç”¨æ¥å”¯ä¸€å®šä½ä¸€æ¬¡é”™è¯¯ï¼‰å’Œ Messageï¼ˆç”¨æ¥å±•ç¤ºå‡ºé”™çš„ä¿¡æ¯ï¼‰**ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬è®¾è®¡ä¸€å¥—è§„èŒƒçš„ã€ç§‘å­¦çš„é”™è¯¯ç ã€‚

**å¯¹äºé”™è¯¯ç å¤„ç†æœ‰ä»¥ä¸‹çš„å»ºè®®ï¼š**

1. å”¯ä¸€æ€§ï¼šç¡®ä¿æ¯ä¸ªé”™è¯¯ç éƒ½æ˜¯å”¯ä¸€çš„ï¼Œè¿™æœ‰åŠ©äºå‡å°‘æ··æ·†å’Œè¯¯è§£ã€‚
2. å¯è¯»æ€§ï¼šå°½å¯èƒ½è®©é”™è¯¯ç çš„å«ä¹‰æ¸…æ™°æ˜“æ‡‚ï¼Œä»¥ä¾¿äºç¨‹åºå‘˜æˆ–ç”¨æˆ·å¿«é€Ÿäº†è§£é”™è¯¯çš„ç±»å‹å’Œå«ä¹‰ã€‚
3. å±‚çº§ç»“æ„ï¼šå°†é”™è¯¯ç åˆ†ä¸ºä¸åŒçš„å±‚çº§ç»“æ„ï¼Œä»¥ä¾¿äºæ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œåˆ†ç±»å’Œå¤„ç†ã€‚
4. ç®€æ´æ€§ï¼šé”™è¯¯ç åº”è¯¥å°½å¯èƒ½ç®€çŸ­ï¼Œä»¥èŠ‚çœå­˜å‚¨ç©ºé—´å¹¶æé«˜å¤„ç†æ•ˆç‡ã€‚
5. å¯æ‰©å±•æ€§ï¼šè€ƒè™‘åˆ°æœªæ¥å¯èƒ½å‡ºç°æ–°çš„é”™è¯¯ç±»å‹ï¼Œåº”è¯¥ä¸ºé”™è¯¯ç è®¾è®¡ä¸€ä¸ªå¯æ‰©å±•çš„æ¶æ„ã€‚
6. æ˜“äºç»´æŠ¤ï¼šä¸ºäº†æ–¹ä¾¿ç»´æŠ¤å’Œç®¡ç†ï¼Œå»ºè®®å°†é”™è¯¯ç ç»Ÿä¸€ä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ï¼Œä»¥ä¾¿äºæ›´æ–°å’Œç»´æŠ¤ã€‚
7. æ˜“äºå®šä½ï¼šé”™è¯¯ç åº”è¯¥åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä»¥ä¾¿äºç¨‹åºå‘˜æˆ–ç”¨æˆ·èƒ½å¤Ÿå¿«é€Ÿå®šä½é”™è¯¯çš„åŸå› å’Œä½ç½®ã€‚
8. è¯­ä¹‰åŒ–ï¼šé”™è¯¯ç åº”è¯¥å°½å¯èƒ½åœ°ä¸å®é™…é”™è¯¯ç›¸å…³ï¼Œä»¥ä¾¿äºç¨‹åºå‘˜æˆ–ç”¨æˆ·æ›´å¥½åœ°ç†è§£é”™è¯¯ã€‚



### æœŸæœ›é”™è¯¯ç å®ç°çš„åŠŸèƒ½

RESTful API æ˜¯åŸºäº HTTP åè®®çš„ä¸€ç³»åˆ— API å¼€å‘è§„èŒƒï¼ŒHTTP è¯·æ±‚ç»“æŸåï¼Œæ— è®º API è¯·æ±‚æˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½éœ€è¦è®©å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å†³å®šä¸‹ä¸€æ­¥è¯¥å¦‚ä½•å¤„ç†ã€‚

ä¸ºäº†è®©ç”¨æˆ·æ‹¥æœ‰æœ€å¥½çš„ä½“éªŒï¼Œéœ€è¦æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é”™è¯¯ç å®ç°æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»‹ç»ä¸‹åœ¨è®¾è®¡é”™è¯¯ç æ—¶ï¼ŒæœŸæœ›èƒ½å¤Ÿå®ç°çš„åŠŸèƒ½ã€‚

**ç¬¬ä¸€ä¸ªåŠŸèƒ½æ˜¯æœ‰ä¸šåŠ¡ Code ç æ ‡è¯†ã€‚**

å› ä¸º HTTP Code ç æœ‰é™ï¼Œå¹¶ä¸”éƒ½æ˜¯è·Ÿ HTTP Transport å±‚ç›¸å…³çš„ Code ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›èƒ½æœ‰è‡ªå·±çš„é”™è¯¯ Code ç ã€‚ä¸€æ–¹é¢ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œæ‰©å±•ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¤Ÿç²¾å‡†åœ°å®šä½åˆ°å…·ä½“æ˜¯å“ªä¸ªé”™è¯¯ã€‚åŒæ—¶ï¼Œå› ä¸º Code ç é€šå¸¸æ˜¯å¯¹è®¡ç®—æœºå‹å¥½çš„ 10 è¿›åˆ¶æ•´æ•°ï¼ŒåŸºäº Code ç ï¼Œè®¡ç®—æœºä¹Ÿå¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œä¸€äº›åˆ†æ”¯å¤„ç†ã€‚å½“ç„¶äº†ï¼Œä¸šåŠ¡ç ä¹Ÿè¦æœ‰ä¸€å®šè§„åˆ™ï¼Œå¯ä»¥é€šè¿‡ä¸šåŠ¡ç è¿…é€Ÿå®šä½å‡ºæ˜¯å“ªç±»é”™è¯¯ã€‚



**ç¬¬äºŒä¸ªåŠŸèƒ½ï¼Œè€ƒè™‘åˆ°å®‰å…¨ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹å¤–å¯¹å†…åˆ†åˆ«å±•ç¤ºä¸åŒçš„é”™è¯¯ä¿¡æ¯ã€‚**

å½“å¼€å‘ä¸€ä¸ªå¯¹å¤–çš„ç³»ç»Ÿï¼Œä¸šåŠ¡å‡ºé”™æ—¶ï¼Œéœ€è¦ä¸€äº›æœºåˆ¶å‘Šè¯‰ç”¨æˆ·å‡ºäº†ä»€ä¹ˆé”™è¯¯ï¼Œå¦‚æœèƒ½å¤Ÿæä¾›ä¸€äº›å¸®åŠ©æ–‡æ¡£ä¼šæ›´å¥½ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æŠŠæ‰€æœ‰çš„é”™è¯¯éƒ½æš´éœ²ç»™å¤–éƒ¨ç”¨æˆ·ï¼Œè¿™ä¸ä»…æ²¡å¿…è¦ï¼Œä¹Ÿä¸å®‰å…¨ã€‚æ‰€ä»¥ä¹Ÿéœ€è¦èƒ½è®©æˆ‘ä»¬è·å–åˆ°æ›´è¯¦ç»†çš„å†…éƒ¨é”™è¯¯ä¿¡æ¯çš„æœºåˆ¶ï¼Œè¿™äº›å†…éƒ¨é”™è¯¯ä¿¡æ¯å¯èƒ½åŒ…å«ä¸€äº›æ•æ„Ÿçš„æ•°æ®ï¼Œä¸å®œå¯¹å¤–å±•ç¤ºï¼Œä½†å¯ä»¥ååŠ©æˆ‘ä»¬è¿›è¡Œé—®é¢˜å®šä½ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡çš„é”™è¯¯ç åº”è¯¥æ˜¯è§„èŒƒçš„ï¼Œèƒ½æ–¹ä¾¿å®¢æˆ·ç«¯æ„ŸçŸ¥åˆ° HTTP æ˜¯å¦è¯·æ±‚æˆåŠŸï¼Œå¹¶å¸¦æœ‰ä¸šåŠ¡ç å’Œå‡ºé”™ä¿¡æ¯ã€‚



## å¸¸è§çš„é”™è¯¯ç è®¾è®¡æ–¹å¼

åœ¨ä¸šåŠ¡ä¸­ï¼Œå¤§è‡´æœ‰ä¸‰ç§é”™è¯¯ç å®ç°æ–¹å¼ã€‚æˆ‘ç”¨ä¸€æ¬¡å› ä¸ºç”¨æˆ·è´¦å·æ²¡æœ‰æ‰¾åˆ°è€Œè¯·æ±‚å¤±è´¥çš„ä¾‹å­ï¼Œåˆ†åˆ«ç»™ä½ è§£é‡Šä¸€ä¸‹ï¼š

**ç¬¬ä¸€ç§æ–¹å¼ï¼Œä¸è®ºè¯·æ±‚æˆåŠŸæˆ–å¤±è´¥ï¼Œå§‹ç»ˆè¿”å› `200 http status code`ï¼Œåœ¨ HTTP Body ä¸­åŒ…å«ç”¨æˆ·è´¦å·æ²¡æœ‰æ‰¾åˆ°çš„é”™è¯¯ä¿¡æ¯ã€‚**

ä¾‹å¦‚ Facebook API çš„é”™è¯¯ Code è®¾è®¡ï¼Œå§‹ç»ˆè¿”å› 200 http status codeï¼š

```json
{
  "error": {
    "message": "Syntax error \"Field picture specified more than once. This is only possible before version 2.1\" at character 23: id,name,picture,picture",
    "type": "OAuthException",
    "code": 2500,
    "fbtrace_id": "xxxxxxxxxxx"
  }
}
```

é‡‡ç”¨å›ºå®šè¿”å›200 http status codeçš„æ–¹å¼ï¼Œæœ‰å…¶åˆç†æ€§ã€‚æ¯”å¦‚ï¼ŒHTTP Code é€šå¸¸ä»£è¡¨ HTTP Transport å±‚çš„çŠ¶æ€ä¿¡æ¯ã€‚å½“æˆ‘ä»¬æ”¶åˆ° HTTP è¯·æ±‚ï¼Œå¹¶è¿”å›æ—¶ï¼ŒHTTP Transport å±‚æ˜¯æˆåŠŸçš„ï¼Œæ‰€ä»¥ä»è¿™ä¸ªå±‚é¢ä¸Šæ¥çœ‹ï¼ŒHTTP Status å›ºå®šä¸º 200 ä¹Ÿæ˜¯åˆç†çš„ã€‚

ä½†æ˜¯è¿™ä¸ªæ–¹å¼çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼šå¯¹äºæ¯ä¸€æ¬¡è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½è¦å»è§£æ HTTP Bodyï¼Œä»ä¸­è§£æå‡ºé”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ã€‚å®é™…ä¸Šï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯¹äºæˆåŠŸçš„è¯·æ±‚ï¼Œè¦ä¹ˆç›´æ¥è½¬å‘ï¼Œè¦ä¹ˆç›´æ¥è§£æåˆ°æŸä¸ªç»“æ„ä½“ä¸­ï¼›å¯¹äºå¤±è´¥çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿæ›´ç›´æ¥åœ°æ„ŸçŸ¥åˆ°è¯·æ±‚å¤±è´¥ã€‚è¿™ç§æ–¹å¼å¯¹æ€§èƒ½ä¼šæœ‰ä¸€å®šçš„å½±å“ï¼Œå¯¹å®¢æˆ·ç«¯ä¸å‹å¥½ã€‚æ‰€ä»¥æˆ‘ä¸å»ºè®®ä½ ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚



**ç¬¬äºŒç§æ–¹å¼ï¼Œè¿”å›http 404 Not Foundé”™è¯¯ç ï¼Œå¹¶åœ¨ Body ä¸­è¿”å›ç®€å•çš„é”™è¯¯ä¿¡æ¯ã€‚**

ä¾‹å¦‚ï¼šTwitter API çš„é”™è¯¯è®¾è®¡ï¼Œä¼šæ ¹æ®é”™è¯¯ç±»å‹ï¼Œè¿”å›åˆé€‚çš„ HTTP Codeï¼Œå¹¶åœ¨ Body ä¸­è¿”å›é”™è¯¯ä¿¡æ¯å’Œè‡ªå®šä¹‰ä¸šåŠ¡ Codeã€‚

```json
HTTP/1.1 400 Bad Request
x-connection-hash: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
set-cookie: guest_id=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Date: Thu, 01 Jun 2017 03:04:23 GMT
Content-Length: 62
x-response-time: 5
strict-transport-security: max-age=631138519
Connection: keep-alive
Content-Type: application/json; charset=utf-8
Server: tsa_b

{"errors":[{"code":215,"message":"Bad Authentication data."}]}
```

è¿™ç§æ–¹å¼æ¯”ç¬¬ä¸€ç§è¦å¥½ä¸€äº›ï¼Œé€šè¿‡http status codeå¯ä»¥ä½¿å®¢æˆ·ç«¯éå¸¸ç›´æ¥åœ°æ„ŸçŸ¥åˆ°è¯·æ±‚å¤±è´¥ï¼Œå¹¶ä¸”æä¾›ç»™å®¢æˆ·ç«¯ä¸€äº›é”™è¯¯ä¿¡æ¯ä¾›å‚è€ƒã€‚ä½†æ˜¯ä»…ä»…é è¿™äº›ä¿¡æ¯ï¼Œè¿˜ä¸èƒ½å‡†ç¡®åœ°å®šä½å’Œè§£å†³é—®é¢˜ã€‚



**ç¬¬ä¸‰ç§æ–¹å¼ï¼Œè¿”å›http 404 Not Foundé”™è¯¯ç ï¼Œå¹¶åœ¨ Body ä¸­è¿”å›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚**

ä¾‹å¦‚ï¼šå¾®è½¯ Bing API çš„é”™è¯¯è®¾è®¡ï¼Œä¼šæ ¹æ®é”™è¯¯ç±»å‹ï¼Œè¿”å›åˆé€‚çš„ HTTP Codeï¼Œå¹¶åœ¨ Body ä¸­è¿”å›è¯¦å°½çš„é”™è¯¯ä¿¡æ¯ã€‚

```json
HTTP/1.1 400
Date: Thu, 01 Jun 2017 03:40:55 GMT
Content-Length: 276
Connection: keep-alive
Content-Type: application/json; charset=utf-8
Server: Microsoft-IIS/10.0
X-Content-Type-Options: nosniff

{"SearchResponse":{"Version":"2.2","Query":{"SearchTerms":"api error codes"},"Errors":[{"Code":1001,"Message":"Required parameter is missing.","Parameter":"SearchRequest.AppId","HelpUrl":"http\u003a\u002f\u002fmsdn.microsoft.com\u002fen-us\u002flibrary\u002fdd251042.aspx"}]}}
```

è¿™æ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„ä¸€ç§æ–¹å¼ï¼Œæ—¢èƒ½é€šè¿‡http status codeä½¿å®¢æˆ·ç«¯æ–¹ä¾¿åœ°çŸ¥é“è¯·æ±‚å‡ºé”™ï¼Œåˆå¯ä»¥ä½¿ç”¨æˆ·æ ¹æ®è¿”å›çš„ä¿¡æ¯çŸ¥é“å“ªé‡Œå‡ºé”™ï¼Œä»¥åŠå¦‚ä½•è§£å†³é—®é¢˜ã€‚åŒæ—¶ï¼Œè¿”å›äº†æœºå™¨å‹å¥½çš„ä¸šåŠ¡ Code ç ï¼Œå¯ä»¥åœ¨æœ‰éœ€è¦æ—¶è®©ç¨‹åºè¿›ä¸€æ­¥åˆ¤æ–­å¤„ç†ã€‚



## é”™è¯¯ç è®¾è®¡å»ºè®®

**ç»¼åˆåˆšæ‰è®²åˆ°çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€å¥—ä¼˜ç§€çš„é”™è¯¯ç è®¾è®¡æ€è·¯ï¼š**

+ æœ‰åŒºåˆ«äºhttp status codeçš„ä¸šåŠ¡ç ï¼Œä¸šåŠ¡ç éœ€è¦æœ‰ä¸€å®šè§„åˆ™ï¼Œå¯ä»¥é€šè¿‡ä¸šåŠ¡ç åˆ¤æ–­å‡ºæ˜¯å“ªç±»é”™è¯¯ã€‚
+ è¯·æ±‚å‡ºé”™æ—¶ï¼Œå¯ä»¥é€šè¿‡http status codeç›´æ¥æ„ŸçŸ¥åˆ°è¯·æ±‚å‡ºé”™ã€‚
+ éœ€è¦åœ¨è¯·æ±‚å‡ºé”™æ—¶ï¼Œè¿”å›è¯¦ç»†çš„ä¿¡æ¯ï¼Œé€šå¸¸åŒ…æ‹¬ 3 ç±»ä¿¡æ¯ï¼š
  + ä¸šåŠ¡ Code ç 
  + é”™è¯¯ä¿¡æ¯
  + å‚è€ƒæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
+ è¿”å›çš„é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦æ˜¯å¯ä»¥ç›´æ¥å±•ç¤ºç»™ç”¨æˆ·çš„å®‰å…¨ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼›åŒæ—¶ä¹Ÿè¦æœ‰å†…éƒ¨æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿ debugã€‚
+ è¿”å›çš„æ•°æ®æ ¼å¼åº”è¯¥æ˜¯å›ºå®šçš„ã€è§„èŒƒçš„ã€‚
+ é”™è¯¯ä¿¡æ¯è¦ä¿æŒç®€æ´ï¼Œå¹¶ä¸”æä¾›æœ‰ç”¨çš„ä¿¡æ¯ã€‚

è¿™é‡Œå…¶å®è¿˜æœ‰ä¸¤ä¸ªåŠŸèƒ½ç‚¹éœ€è¦æˆ‘ä»¬å®ç°ï¼šä¸šåŠ¡ Code ç è®¾è®¡ï¼Œä»¥åŠè¯·æ±‚å‡ºé”™æ—¶ï¼Œå¦‚ä½•è®¾ç½®http status codeã€‚



### ä¸šåŠ¡ Code ç è®¾è®¡

åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¼•å…¥ä¸šåŠ¡Codeç æœ‰ä¸‹é¢å‡ ä¸ªå¥½å¤„ï¼š

+ å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®šä½é—®é¢˜å’Œå®šä½ä»£ç è¡Œï¼ˆçœ‹åˆ°é”™è¯¯ç çŸ¥é“ä»€ä¹ˆæ„æ€ã€grepé”™è¯¯ç å¯ä»¥å®šä½åˆ°é”™è¯¯ç æ‰€åœ¨è¡Œã€æŸä¸ªé”™è¯¯ç±»å‹çš„å”¯ä¸€æ ‡è¯†ï¼‰ã€‚
+ é”™è¯¯ç åŒ…å«ä¸€å®šçš„ä¿¡æ¯ï¼Œé€šè¿‡é”™è¯¯ç å¯ä»¥åˆ¤æ–­å‡ºé”™è¯¯çº§åˆ«ã€é”™è¯¯æ¨¡å—å’Œå…·ä½“é”™è¯¯ä¿¡æ¯ã€‚
+ Goä¸­çš„HTTPæœåŠ¡å™¨å¼€å‘éƒ½æ˜¯å¼•ç”¨ `net/http` åŒ…ï¼Œè¯¥åŒ…ä¸­åªæœ‰60ä¸ªé”™è¯¯ç ï¼ŒåŸºæœ¬éƒ½æ˜¯è·ŸHTTPè¯·æ±‚ç›¸å…³çš„é”™è¯¯ç ï¼Œåœ¨ä¸€ä¸ªå¤§å‹ç³»ç»Ÿä¸­ï¼Œè¿™äº›é”™è¯¯ç å®Œå…¨ä¸å¤Ÿç”¨ï¼Œè€Œä¸”è¿™äº›é”™è¯¯ç è·Ÿä¸šåŠ¡æ²¡æœ‰ä»»ä½•å…³è”ï¼Œæ»¡è¶³ä¸äº†ä¸šåŠ¡çš„éœ€æ±‚ã€‚å¼•å…¥ä¸šåŠ¡çš„Codeç ï¼Œåˆ™å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ã€‚
+ ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½éœ€è¦åˆ¤æ–­é”™è¯¯æ˜¯å“ªç§ç±»å‹ï¼Œä»¥ä¾¿åšç›¸åº”çš„é€»è¾‘å¤„ç†ï¼Œé€šè¿‡å®šåˆ¶çš„é”™è¯¯å¯ä»¥å¾ˆå®¹æ˜“åšåˆ°è¿™ç‚¹ï¼Œä¾‹å¦‚ï¼š

```go
if err == code.ErrBind {
	...
}
```

è¿™é‡Œè¦æ³¨æ„ï¼Œä¸šåŠ¡Codeç å¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ•´å‹å­—ç¬¦ä¸²ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦å‹å­—ç¬¦ä¸²ï¼Œå®ƒæ˜¯é”™è¯¯çš„å”¯ä¸€æ ‡è¯†ã€‚

**âš ï¸ Code ç è®¾è®¡è§„èŒƒï¼šçº¯æ•°å­—è¡¨ç¤ºï¼Œä¸åŒéƒ¨ä½ä»£è¡¨ä¸åŒçš„æœåŠ¡ï¼Œä¸åŒçš„æ¨¡å—ã€‚**

**é”™è¯¯ä»£ç è¯´æ˜ï¼š100101:**

+ **10:** æœåŠ¡ã€‚
+ **01:** æŸä¸ªæœåŠ¡ä¸‹çš„æŸä¸ªæ¨¡å—ã€‚
+ **01:** æ¨¡å—ä¸‹çš„é”™è¯¯ç åºå·ï¼Œæ¯ä¸ªæ¨¡å—å¯ä»¥æ³¨å†Œ100ä¸ªé”™è¯¯ã€‚

é€šè¿‡`100101`å¯ä»¥çŸ¥é“è¿™ä¸ªé”™è¯¯æ˜¯**æœåŠ¡ A**ï¼Œ**æ•°æ®åº“**æ¨¡å—ä¸‹çš„**è®°å½•æ²¡æœ‰æ‰¾åˆ°é”™è¯¯**ã€‚

> ä½ å¯èƒ½ä¼šé—®ï¼šæŒ‰è¿™ç§è®¾è®¡ï¼Œæ¯ä¸ªæ¨¡å—ä¸‹æœ€å¤šèƒ½æ³¨å†Œ100ä¸ªé”™è¯¯ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å°‘ï¼Ÿå…¶å®åœ¨æˆ‘çœ‹æ¥ï¼Œå¦‚æœæ¯ä¸ªæ¨¡å—çš„é”™è¯¯ç è¶…è¿‡100ä¸ªï¼Œè¦ä¹ˆè¯´æ˜è¿™ä¸ªæ¨¡å—å¤ªå¤§äº†ï¼Œå»ºè®®æ‹†åˆ†ï¼›è¦ä¹ˆè¯´æ˜é”™è¯¯ç è®¾è®¡å¾—ä¸åˆç†ï¼Œå…±äº«æ€§å·®ï¼Œéœ€è¦é‡æ–°è®¾è®¡ã€‚



### å¦‚ä½•è®¾ç½®HTTP Status Code

**Go net/httpåŒ…æä¾›äº†60ä¸ªé”™è¯¯ç **ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹5ç±»ï¼š

+ `1XX -` ï¼ˆæŒ‡ç¤ºä¿¡æ¯ï¼‰è¡¨ç¤ºè¯·æ±‚å·²æ¥æ”¶ï¼Œç»§ç»­å¤„ç†ã€‚
+ `2XX -` ï¼ˆè¯·æ±‚æˆåŠŸï¼‰è¡¨ç¤ºæˆåŠŸå¤„ç†äº†è¯·æ±‚çš„çŠ¶æ€ä»£ç ã€‚
+ `3XX -` ï¼ˆè¯·æ±‚è¢«é‡å®šå‘ï¼‰è¡¨ç¤ºè¦å®Œæˆè¯·æ±‚ï¼Œéœ€è¦è¿›ä¸€æ­¥æ“ä½œã€‚é€šå¸¸ï¼Œè¿™äº›çŠ¶æ€ä»£ç ç”¨æ¥é‡å®šå‘ã€‚
+ `4XX -` ï¼ˆè¯·æ±‚é”™è¯¯ï¼‰è¿™äº›çŠ¶æ€ä»£ç è¡¨ç¤ºè¯·æ±‚å¯èƒ½å‡ºé”™ï¼Œå¦¨ç¢äº†æœåŠ¡å™¨çš„å¤„ç†ï¼Œé€šå¸¸æ˜¯å®¢æˆ·ç«¯å‡ºé”™ï¼Œéœ€è¦å®¢æˆ·ç«¯åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚
+ `5XX -` ï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰è¿™äº›çŠ¶æ€ä»£ç è¡¨ç¤ºæœåŠ¡å™¨åœ¨å°è¯•å¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿå†…éƒ¨é”™è¯¯ã€‚è¿™äº›é”™è¯¯å¯èƒ½æ˜¯æœåŠ¡å™¨æœ¬èº«çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯çš„é—®é¢˜ã€‚

å¯ä»¥çœ‹åˆ°HTTP Codeæœ‰å¾ˆå¤šç§ï¼Œå¦‚æœæ¯ä¸ªCodeéƒ½åšé”™è¯¯æ˜ å°„ï¼Œä¼šé¢ä¸´å¾ˆå¤šé—®é¢˜ã€‚æ¯”å¦‚ï¼Œç ”å‘åŒå­¦ä¸å¤ªå¥½åˆ¤æ–­é”™è¯¯å±äºå“ªç§`http status code`ï¼Œåˆ°æœ€åå¾ˆå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æˆ–è€…`http status code`ä¸åŒ¹é…ï¼Œå˜æˆä¸€ç§å½¢å¼ã€‚è€Œä¸”ï¼Œå®¢æˆ·ç«¯ä¹Ÿéš¾ä»¥åº”å¯¹è¿™ä¹ˆå¤šçš„HTTPé”™è¯¯ç ã€‚

æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®®`http status code`ä¸è¦å¤ªå¤šï¼ŒåŸºæœ¬ä¸Šåªéœ€è¦è¿™3ä¸ªHTTP Code:

+ 200 - è¡¨ç¤ºè¯·æ±‚æˆåŠŸæ‰§è¡Œã€‚
+ 400 - è¡¨ç¤ºå®¢æˆ·ç«¯å‡ºé—®é¢˜ã€‚
+ 500 - è¡¨ç¤ºæœåŠ¡ç«¯å‡ºé—®é¢˜ã€‚

**å¦‚æœè§‰å¾—è¿™3ä¸ªé”™è¯¯ç ä¸å¤Ÿç”¨ï¼Œæœ€å¤šå¯ä»¥åŠ å¦‚ä¸‹3ä¸ªé”™è¯¯ç ï¼š**

+ 401 - è¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚
+ 403 - è¡¨ç¤ºæˆæƒå¤±è´¥ã€‚
+ 404 - è¡¨ç¤ºèµ„æºæ‰¾ä¸åˆ°ï¼Œè¿™é‡Œçš„èµ„æºå¯ä»¥æ˜¯`URL`æˆ–è€…`RESTful`èµ„æºã€‚

å°†é”™è¯¯ç æ§åˆ¶åœ¨é€‚å½“çš„æ•°ç›®å†…ï¼Œå®¢æˆ·ç«¯æ¯”è¾ƒå®¹æ˜“å¤„ç†å’Œåˆ¤æ–­ï¼Œå¼€å‘ä¹Ÿæ¯”è¾ƒå®¹æ˜“è¿›è¡Œé”™è¯¯ç æ˜ å°„ã€‚





## IAMé¡¹ç›®é”™è¯¯ç è®¾è®¡è§„èŒƒ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹IAMé¡¹ç›®çš„é”™è¯¯ç æ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚

### Code è®¾è®¡è§„èŒƒ

å…ˆæ¥çœ‹ä¸‹IAMé¡¹ç›®ä¸šåŠ¡çš„Codeç è®¾è®¡è§„èŒƒï¼Œå…·ä½“å®ç°å¯å‚è€ƒ[internal/pkg/codeç›®å½•](https://github.com/marmotedu/iam/tree/master/internal/pkg/code)ã€‚IAMé¡¹ç›®çš„é”™è¯¯ç è®¾è®¡è§„èŒƒç¬¦åˆä¸Šé¢ä»‹ç»çš„é”™è¯¯ç è®¾è®¡æ€è·¯å’Œè§„èŒƒï¼Œå…·ä½“è§„èŒƒè§ä¸‹ã€‚

Code ä»£ç ä» **100001** å¼€å§‹ï¼Œ1000 ä»¥ä¸‹ä¸º `github.com/marmotedu/errors` ä¿ç•™ codeã€‚

> æ¯”å¦‚é”™è¯¯ä»£ç 100101ï¼Œå…¶ä¸­ 10 ä»£è¡¨æœåŠ¡ï¼›ä¸­é—´çš„ 01 ä»£è¡¨æŸä¸ªæœåŠ¡ä¸‹çš„æŸä¸ªæ¨¡å—ï¼›æœ€åçš„ 01 ä»£è¡¨æ¨¡å—ä¸‹çš„é”™è¯¯ç åºå·ï¼Œæ¯ä¸ªæ¨¡å—å¯ä»¥æ³¨å†Œ 100 ä¸ªé”™è¯¯ã€‚

**é”™è¯¯ä»£ç è¯´æ˜ï¼š**`100001`

![image-20230221222717542](http://sm.nsddd.top/sm202302212227600.png)



**æœåŠ¡å’Œæ¨¡å—è¯´æ˜**

![img](http://sm.nsddd.top/sm202302212229011.png)
**é€šç”¨ï¼šè¯´æ˜æ‰€æœ‰æœåŠ¡éƒ½é€‚ç”¨çš„é”™è¯¯ï¼Œæé«˜å¤ç”¨æ€§ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚**

**é”™è¯¯ä¿¡æ¯è§„èŒƒè¯´æ˜**

+ å¯¹å¤–æš´éœ²çš„é”™è¯¯ï¼Œç»Ÿä¸€å¤§å†™å¼€å¤´ï¼Œç»“å°¾ä¸è¦åŠ `.`ã€‚
+ å¯¹å¤–æš´éœ²çš„é”™è¯¯è¦ç®€æ´ï¼Œå¹¶èƒ½å‡†ç¡®è¯´æ˜é—®é¢˜ã€‚
+ å¯¹å¤–æš´éœ²çš„é”™è¯¯è¯´æ˜ï¼Œåº”è¯¥æ˜¯ `è¯¥æ€ä¹ˆåš` è€Œä¸æ˜¯ `å“ªé‡Œé”™äº†`ã€‚

è¿™é‡Œä½ éœ€è¦æ³¨æ„ï¼Œé”™è¯¯ä¿¡æ¯æ˜¯ç›´æ¥æš´éœ²ç»™ç”¨æˆ·çš„ï¼Œä¸èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚



### IAM APIæ¥å£è¿”å›å€¼è¯´æ˜

å¦‚æœè¿”å›ç»“æœä¸­å­˜åœ¨ `code` å­—æ®µï¼Œåˆ™è¡¨ç¤ºè°ƒç”¨ API æ¥å£å¤±è´¥ã€‚ä¾‹å¦‚ï¼š

```json
{
  "code": 100101,
  "message": "Database error",
  "reference": "https://github.com/marmotedu/iam/tree/master/docs/guide/zh-CN/faq/iam-apiserver"
}
```

ä¸Šè¿°è¿”å›ä¸­ `code` è¡¨ç¤ºé”™è¯¯ç ï¼Œ`message` è¡¨ç¤ºè¯¥é”™è¯¯çš„å…·ä½“ä¿¡æ¯ã€‚æ¯ä¸ªé”™è¯¯åŒæ—¶ä¹Ÿå¯¹åº”ä¸€ä¸ª HTTP çŠ¶æ€ç ã€‚æ¯”å¦‚ä¸Šè¿°é”™è¯¯ç å¯¹åº”äº† HTTP çŠ¶æ€ç  `500(Internal Server Error)`ã€‚å¦å¤–ï¼Œåœ¨å‡ºé”™æ—¶ï¼Œä¹Ÿè¿”å›äº†`reference`å­—æ®µï¼Œè¯¥å­—æ®µåŒ…å«äº†å¯ä»¥è§£å†³è¿™ä¸ªé”™è¯¯çš„æ–‡æ¡£é“¾æ¥åœ°å€ã€‚

å…³äºIAM ç³»ç»Ÿæ”¯æŒçš„é”™è¯¯ç ï¼Œæˆ‘ç»™ä½ åˆ—äº†ä¸€ä¸ªè¡¨æ ¼ï¼Œä½ å¯ä»¥çœ‹çœ‹ï¼š

![image-20230221223015911](http://sm.nsddd.top/sm202302212230006.png)

![image-20230221223033185](http://sm.nsddd.top/sm202302212230302.png)



## å¦‚ä½•è®¾è®¡é”™è¯¯åŒ…

åœ¨ Go é¡¹ç›®å¼€å‘ä¸­ï¼Œé”™è¯¯æ˜¯æˆ‘ä»¬å¿…é¡»è¦å¤„ç†çš„ä¸€ä¸ªäº‹é¡¹ã€‚é™¤äº†æˆ‘ä»¬ä¸Šä¸€è®²å­¦ä¹ è¿‡çš„é”™è¯¯ç ï¼Œå¤„ç†é”™è¯¯ä¹Ÿç¦»ä¸å¼€é”™è¯¯åŒ…ã€‚

ä¸šç•Œæœ‰å¾ˆå¤šä¼˜ç§€çš„ã€å¼€æºçš„é”™è¯¯åŒ…å¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚ Go æ ‡å‡†åº“è‡ªå¸¦çš„errorsåŒ…ã€`github.com/pkg/errors`åŒ…ã€‚ä½†æ˜¯è¿™äº›åŒ…ç›®å‰è¿˜ä¸æ”¯æŒä¸šåŠ¡é”™è¯¯ç ï¼Œå¾ˆéš¾æ»¡è¶³ç”Ÿäº§çº§åº”ç”¨çš„éœ€æ±‚ã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å¼€å‘å‡ºé€‚åˆè‡ªå·±é”™è¯¯ç è®¾è®¡çš„é”™è¯¯åŒ…ã€‚å½“ç„¶ï¼Œ**æˆ‘ä»¬ä¹Ÿæ²¡å¿…è¦è‡ªå·±ä» 0 å¼€å‘ï¼Œå¯ä»¥åŸºäºä¸€äº›ä¼˜ç§€çš„åŒ…æ¥è¿›è¡ŒäºŒæ¬¡å°è£…ã€‚**

è¦æƒ³è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—çŸ¥é“ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…éœ€è¦å…·å¤‡å“ªäº›åŠŸèƒ½ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œè‡³å°‘éœ€è¦æœ‰ä¸‹é¢è¿™å…­ä¸ªåŠŸèƒ½ï¼š

**é¦–å…ˆï¼Œåº”è¯¥èƒ½æ”¯æŒé”™è¯¯å †æ ˆã€‚**æˆ‘ä»¬æ¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼Œå‡è®¾ä¿å­˜åœ¨[bad.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/bad.go)æ–‡ä»¶ä¸­ï¼š

```go
package main

import (
  "fmt"
  "log"
)

func main() {
  if err := funcA(); err != nil {
    log.Fatalf("call func got failed: %v", err)
    return
  }

  log.Println("call func success")
}

func funcA() error {
  if err := funcB(); err != nil {
    return err
  }

  return fmt.Errorf("func called error")
}

func funcB() error {
  return fmt.Errorf("func called error")
}
```

**æ‰§è¡Œä¸Šé¢çš„ä»£ç **ï¼š

```bash
$ go run bad.go
2021/07/02 08:06:55 call func got failed: func called error
exit status 1
```

è¿™æ—¶æˆ‘ä»¬æƒ³å®šä½é—®é¢˜ï¼Œä½†ä¸çŸ¥é“å…·ä½“æ˜¯å“ªè¡Œä»£ç æŠ¥çš„é”™è¯¯ï¼Œåªèƒ½é çŒœï¼Œè¿˜ä¸ä¸€å®šèƒ½çŒœåˆ°ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸€äº›Debugä¿¡æ¯ï¼Œæ¥ååŠ©æˆ‘ä»¬å®šä½é—®é¢˜ã€‚è¿™æ ·åšåœ¨æµ‹è¯•ç¯å¢ƒæ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯åœ¨çº¿ä¸Šç¯å¢ƒï¼Œä¸€æ–¹é¢ä¿®æ”¹ã€å‘å¸ƒéƒ½æ¯”è¾ƒéº»çƒ¦ï¼Œå¦ä¸€æ–¹é¢é—®é¢˜å¯èƒ½æ¯”è¾ƒéš¾é‡ç°ã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¼šæƒ³ï¼Œè¦æ˜¯èƒ½æ‰“å°é”™è¯¯çš„å †æ ˆå°±å¥½äº†ã€‚ä¾‹å¦‚ï¼š

```bash

2021/07/02 14:17:03 call func got failed: func called error
main.funcB
  /home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:27
main.funcA
  /home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:19
main.main
  /home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/good.go:10
runtime.main
  /home/colin/go/go1.16.2/src/runtime/proc.go:225
runtime.goexit
  /home/colin/go/go1.16.2/src/runtime/asm_amd64.s:1371
exit status 1
```

é€šè¿‡ä¸Šé¢çš„é”™è¯¯è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°çŸ¥é“æ˜¯å“ªè¡Œä»£ç æŠ¥çš„é”™ï¼Œä»è€Œæå¤§æé«˜é—®é¢˜å®šä½çš„æ•ˆç‡ï¼Œé™ä½å®šä½çš„éš¾åº¦ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘çœ‹æ¥ï¼Œä¸€ä¸ªä¼˜ç§€çš„errorsåŒ…ï¼Œé¦–å…ˆéœ€è¦æ”¯æŒé”™è¯¯å †æ ˆã€‚



**å…¶æ¬¡ï¼Œèƒ½å¤Ÿæ”¯æŒä¸åŒçš„æ‰“å°æ ¼å¼ã€‚**ä¾‹å¦‚`%+v`ã€`%v`ã€`%s`ç­‰æ ¼å¼ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰“å°ä¸åŒä¸°å¯Œåº¦çš„é”™è¯¯ä¿¡æ¯ã€‚



**å†æ¬¡ï¼Œèƒ½æ”¯æŒWrap/UnwrapåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åœ¨å·²æœ‰çš„é”™è¯¯ä¸Šï¼Œè¿½åŠ ä¸€äº›æ–°çš„ä¿¡æ¯ã€‚**ä¾‹å¦‚`errors.Wrap(err, "open file failed")` ã€‚Wrapé€šå¸¸ç”¨åœ¨è°ƒç”¨å‡½æ•°ä¸­ï¼Œè°ƒç”¨å‡½æ•°å¯ä»¥åŸºäºè¢«è°ƒå‡½æ•°æŠ¥é”™æ—¶çš„é”™è¯¯Wrapä¸€äº›è‡ªå·±çš„ä¿¡æ¯ï¼Œä¸°å¯ŒæŠ¥é”™ä¿¡æ¯ï¼Œæ–¹ä¾¿åæœŸçš„é”™è¯¯å®šä½ï¼Œä¾‹å¦‚ï¼š

```go
func funcA() error {
    if err := funcB(); err != nil {
        return errors.Wrap(err, "call funcB failed")
    }

    return errors.New("func called error")
}

func funcB() error {
    return errors.New("func called error")
}
```

è¿™é‡Œè¦æ³¨æ„ï¼Œä¸åŒçš„é”™è¯¯ç±»å‹ï¼ŒWrapå‡½æ•°çš„é€»è¾‘ä¹Ÿå¯ä»¥ä¸åŒã€‚å¦å¤–ï¼Œåœ¨è°ƒç”¨Wrapæ—¶ï¼Œä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªé”™è¯¯å †æ ˆèŠ‚ç‚¹ã€‚æˆ‘ä»¬æ—¢ç„¶èƒ½å¤ŸåµŒå¥—errorï¼Œé‚£æœ‰æ—¶å€™è¿˜å¯èƒ½éœ€è¦è·å–è¢«åµŒå¥—çš„errorï¼Œè¿™æ—¶å°±éœ€è¦é”™è¯¯åŒ…æä¾›`Unwrap`å‡½æ•°ã€‚

**è¿˜æœ‰ï¼Œé”™è¯¯åŒ…åº”è¯¥æœ‰`Is`æ–¹æ³•**ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åˆ¤æ–­æŸä¸ªerroræ˜¯å¦æ˜¯æŒ‡å®šçš„errorã€‚åœ¨Go 1.13ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰wrapping errorçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­erroræ˜¯ä¸æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š

```go
if err == os.ErrNotExist {	// normal code}
```

ä½†æ˜¯ç°åœ¨ï¼Œå› ä¸ºæœ‰äº†wrapping errorï¼Œè¿™æ ·åˆ¤æ–­å°±ä¼šæœ‰é—®é¢˜ã€‚å› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“è¿”å›çš„erræ˜¯ä¸æ˜¯ä¸€ä¸ªåµŒå¥—çš„errorï¼ŒåµŒå¥—äº†å‡ å±‚ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„é”™è¯¯åŒ…å°±éœ€è¦æä¾›`Is`å‡½æ•°ï¼š

```go
func Is(err, target error) bool
```

å½“errå’Œtargetæ˜¯åŒä¸€ä¸ªï¼Œæˆ–è€…erræ˜¯ä¸€ä¸ªwrapping errorçš„æ—¶å€™ï¼Œå¦‚æœtargetä¹ŸåŒ…å«åœ¨è¿™ä¸ªåµŒå¥—erroré“¾ä¸­ï¼Œè¿”å›trueï¼Œå¦åˆ™è¿”å›fasleã€‚



**å¦å¤–ï¼Œé”™è¯¯åŒ…åº”è¯¥æ”¯æŒ** `As` **å‡½æ•°ã€‚**

åœ¨Go 1.13ä¹‹å‰ï¼Œæ²¡æœ‰wrapping errorçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦æŠŠerrorè½¬ä¸ºå¦å¤–ä¸€ä¸ªerrorï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨type assertionæˆ–è€…type switchï¼Œä¹Ÿå°±æ˜¯ç±»å‹æ–­è¨€ã€‚ä¾‹å¦‚ï¼š

```go
if perr, ok := err.(*os.PathError); ok {	fmt.Println(perr.Path)}
```

ä½†æ˜¯ç°åœ¨ï¼Œè¿”å›çš„errå¯èƒ½æ˜¯åµŒå¥—çš„errorï¼Œç”šè‡³å¥½å‡ å±‚åµŒå¥—ï¼Œè¿™ç§æ–¹å¼å°±ä¸èƒ½ç”¨äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç° `As` å‡½æ•°æ¥å®Œæˆè¿™ç§åŠŸèƒ½ã€‚ç°åœ¨æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­ï¼Œç”¨ `As` å‡½æ•°å®ç°ä¸€ä¸‹ï¼š

```go
var perr *os.PathError
if errors.As(err, &perr) {
  fmt.Println(perr.Path)
}
```

è¿™æ ·å°±å¯ä»¥å®Œå…¨å®ç°ç±»å‹æ–­è¨€çš„åŠŸèƒ½ï¼Œè€Œä¸”è¿˜æ›´å¼ºå¤§ï¼Œå› ä¸ºå®ƒå¯ä»¥å¤„ç† `wrapping error`ã€‚

**æœ€åï¼Œèƒ½å¤Ÿæ”¯æŒä¸¤ç§é”™è¯¯åˆ›å»ºæ–¹å¼ï¼šéæ ¼å¼åŒ–åˆ›å»ºå’Œæ ¼å¼åŒ–åˆ›å»ºã€‚**ä¾‹å¦‚ï¼š

```go
errors.New("file not found")
errors.Errorf("file %s not found", "iam-apiserver")
```

ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…åº”è¯¥å…·å¤‡çš„åŠŸèƒ½ã€‚ä¸€ä¸ªå¥½æ¶ˆæ¯æ˜¯ï¼ŒGithubä¸Šæœ‰ä¸å°‘å®ç°äº†è¿™äº›åŠŸèƒ½çš„é”™è¯¯åŒ…ï¼Œå…¶ä¸­`github.com/pkg/errors`åŒ…æœ€å—æ¬¢è¿ã€‚æ‰€ä»¥ï¼Œæˆ‘åŸºäº`github.com/pkg/errors`åŒ…è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼Œç”¨æ¥æ”¯æŒä¸Šä¸€è®²æ‰€ä»‹ç»çš„é”™è¯¯ç ã€‚



## é”™è¯¯åŒ…å®ç°

æ˜ç¡®ä¼˜ç§€çš„é”™è¯¯åŒ…åº”è¯¥å…·å¤‡çš„åŠŸèƒ½åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é”™è¯¯åŒ…çš„å®ç°ã€‚å®ç°çš„æºç å­˜æ”¾åœ¨[github.com/marmotedu/errors](https://github.com/marmotedu/errors)ã€‚

æˆ‘é€šè¿‡åœ¨æ–‡ä»¶[github.com/pkg/errors/errors.go](https://github.com/marmotedu/errors/blob/master/errors.go#L299)ä¸­å¢åŠ æ–°çš„`withCode`ç»“æ„ä½“ï¼Œæ¥å¼•å…¥ä¸€ç§æ–°çš„é”™è¯¯ç±»å‹ï¼Œè¯¥é”™è¯¯ç±»å‹å¯ä»¥è®°å½•é”™è¯¯ç ã€stackã€causeå’Œå…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚

```go

type withCode struct {
    err   error // error é”™è¯¯
    code  int // ä¸šåŠ¡é”™è¯¯ç 
    cause error // cause error
    *stack // é”™è¯¯å †æ ˆ
}
```

ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¥äº†è§£ä¸‹`github.com/marmotedu/errors`æ‰€æä¾›çš„åŠŸèƒ½ã€‚å‡è®¾ä¸‹è¿°ä»£ç ä¿å­˜åœ¨`errors.go`æ–‡ä»¶ä¸­ï¼š

```go

package main

import (
  "fmt"

  "github.com/marmotedu/errors"
  code "github.com/marmotedu/sample-code"
)

func main() {
  if err := bindUser(); err != nil {
    // %s: Returns the user-safe error string mapped to the error code or the error message if none is specified.
    fmt.Println("====================> %s <====================")
    fmt.Printf("%s\n\n", err)

    // %v: Alias for %s.
    fmt.Println("====================> %v <====================")
    fmt.Printf("%v\n\n", err)

    // %-v: Output caller details, useful for troubleshooting.
    fmt.Println("====================> %-v <====================")
    fmt.Printf("%-v\n\n", err)

    // %+v: Output full error stack details, useful for debugging.
    fmt.Println("====================> %+v <====================")
    fmt.Printf("%+v\n\n", err)

    // %#-v: Output caller details, useful for troubleshooting with JSON formatted output.
    fmt.Println("====================> %#-v <====================")
    fmt.Printf("%#-v\n\n", err)

    // %#+v: Output full error stack details, useful for debugging with JSON formatted output.
    fmt.Println("====================> %#+v <====================")
    fmt.Printf("%#+v\n\n", err)

    // do some business process based on the error type
    if errors.IsCode(err, code.ErrEncodingFailed) {
      fmt.Println("this is a ErrEncodingFailed error")
    }

    if errors.IsCode(err, code.ErrDatabase) {
      fmt.Println("this is a ErrDatabase error")
    }

    // we can also find the cause error
    fmt.Println(errors.Cause(err))
  }
}

func bindUser() error {
  if err := getUser(); err != nil {
    // Step3: Wrap the error with a new error message and a new error code if needed.
    return errors.WrapC(err, code.ErrEncodingFailed, "encoding user 'Lingfei Kong' failed.")
  }

  return nil
}

func getUser() error {
  if err := queryDatabase(); err != nil {
    // Step2: Wrap the error with a new error message.
    return errors.Wrap(err, "get user failed.")
  }

  return nil
}

func queryDatabase() error {
  // Step1. Create error with specified error code.
  return errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡[WithCode](https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L306)å‡½æ•°æ¥åˆ›å»ºæ–°çš„withCodeç±»å‹çš„é”™è¯¯ï¼›é€šè¿‡[WrapC](https://github.com/marmotedu/errors/blob/v1.0.2/errors.go#L314)æ¥å°†ä¸€ä¸ªerrorå°è£…æˆä¸€ä¸ªwithCodeç±»å‹çš„é”™è¯¯ï¼›é€šè¿‡[IsCode](https://github.com/marmotedu/errors/blob/v1.0.2/code.go#L121)æ¥åˆ¤æ–­ä¸€ä¸ªerroré“¾ä¸­æ˜¯å¦åŒ…å«æŒ‡å®šçš„codeã€‚

withCodeé”™è¯¯å®ç°äº†ä¸€ä¸ª`func (w *withCode) Format(state fmt.State, verb rune)`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨æ¥æ‰“å°ä¸åŒæ ¼å¼çš„é”™è¯¯ä¿¡æ¯ï¼Œè§ä¸‹è¡¨ï¼š

![image-20230221225636739](http://sm.nsddd.top/sm202302212256819.png)

ä¾‹å¦‚ï¼Œ`%+v`ä¼šæ‰“å°ä»¥ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

```go
get user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error
```

é‚£ä¹ˆä½ å¯èƒ½ä¼šé—®ï¼Œè¿™äº›é”™è¯¯ä¿¡æ¯ä¸­çš„`100101`é”™è¯¯ç ï¼Œè¿˜æœ‰`Database error`è¿™ç§å¯¹å¤–å±•ç¤ºçš„æŠ¥é”™ä¿¡æ¯ç­‰ç­‰ï¼Œæ˜¯ä»å“ªé‡Œè·å–çš„ï¼Ÿè¿™é‡Œæˆ‘ç®€å•è§£é‡Šä¸€ä¸‹ã€‚

é¦–å…ˆï¼Œ `withCode` ä¸­åŒ…å«äº†intç±»å‹çš„é”™è¯¯ç ï¼Œä¾‹å¦‚`100101`ã€‚

å…¶æ¬¡ï¼Œå½“ä½¿ç”¨`github.com/marmotedu/errors`åŒ…çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨`Register`æˆ–è€…`MustRegister`ï¼Œå°†ä¸€ä¸ªCoderæ³¨å†Œåˆ°`github.com/marmotedu/errors`å¼€è¾Ÿçš„å†…å­˜ä¸­ï¼Œæ•°æ®ç»“æ„ä¸ºï¼š

```
var codes = map[int]Coder{}
```

**Coderæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰ä¸ºï¼š**

```go

type Coder interface {
    // HTTP status that should be used for the associated error code.
    HTTPStatus() int

    // External (user) facing error text.
    String() string

    // Reference returns the detail documents for user.
    Reference() string

    // Code returns the code of the coder
    Code() int
}
```

è¿™æ · `withCode` çš„`Format`æ–¹æ³•ï¼Œå°±èƒ½å¤Ÿé€šè¿‡ `withCode` ä¸­çš„codeå­—æ®µè·å–åˆ°å¯¹åº”çš„Coderï¼Œå¹¶é€šè¿‡Coderæä¾›çš„HTTPStatusã€Stringã€Referenceã€Codeå‡½æ•°ï¼Œæ¥è·å– `withCode` ä¸­codeçš„è¯¦ç»†ä¿¡æ¯ï¼Œæœ€åæ ¼å¼åŒ–æ‰“å°ã€‚

**è¿™é‡Œè¦æ³¨æ„ï¼Œæˆ‘ä»¬å®ç°äº†ä¸¤ä¸ªæ³¨å†Œå‡½æ•°ï¼š`Register`å’Œ`MustRegister`ï¼ŒäºŒè€…å”¯ä¸€åŒºåˆ«æ˜¯ï¼šå½“é‡å¤å®šä¹‰åŒä¸€ä¸ªé”™è¯¯Codeæ—¶ï¼Œ`MustRegister`ä¼španicï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢åé¢æ³¨å†Œçš„é”™è¯¯è¦†ç›–æ‰ä¹‹å‰æ³¨å†Œçš„é”™è¯¯ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ä½¿ç”¨`MustRegister`ã€‚**

`XXX()`å’Œ`MustXXX()`çš„å‡½æ•°å‘½åæ–¹å¼ï¼Œæ˜¯ä¸€ç§Goä»£ç è®¾è®¡æŠ€å·§ï¼Œåœ¨Goä»£ç ä¸­ç»å¸¸ä½¿ç”¨ï¼Œä¾‹å¦‚Goæ ‡å‡†åº“ä¸­`regexp`åŒ…æä¾›çš„`Compile`å’Œ`MustCompile`å‡½æ•°ã€‚å’Œ`XXX`ç›¸æ¯”ï¼Œ`MustXXX` ä¼šåœ¨æŸç§æƒ…å†µä¸æ»¡è¶³æ—¶panicã€‚å› æ­¤ä½¿ç”¨`MustXXX`çš„å¼€å‘è€…çœ‹åˆ°å‡½æ•°åå°±ä¼šæœ‰ä¸€ä¸ªå¿ƒç†é¢„æœŸï¼šä½¿ç”¨ä¸å½“ï¼Œä¼šé€ æˆç¨‹åºpanicã€‚

æœ€åï¼Œæˆ‘è¿˜æœ‰ä¸€ä¸ªå»ºè®®ï¼šåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨JSONæ ¼å¼æ‰“å°æ—¥å¿—ï¼ŒJSONæ ¼å¼çš„æ—¥å¿—å¯ä»¥éå¸¸æ–¹ä¾¿çš„ä¾›æ—¥å¿—ç³»ç»Ÿè§£æã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€‰æ‹©`%#-v`æˆ–`%#+v`ä¸¤ç§æ ¼å¼ã€‚

é”™è¯¯åŒ…åœ¨ä»£ç ä¸­ï¼Œç»å¸¸è¢«è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯é”™è¯¯åŒ…ä¸€å®šè¦æ˜¯é«˜æ€§èƒ½çš„ï¼Œå¦åˆ™å¾ˆå¯èƒ½ä¼šå½±å“æ¥å£çš„æ€§èƒ½ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹`github.com/marmotedu/errors`åŒ…çš„æ€§èƒ½ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé”™è¯¯åŒ…è·Ÿgoæ ‡å‡†åº“çš„ `errors` åŒ…ï¼Œä»¥åŠ `github.com/pkg/errors` åŒ…è¿›è¡Œå¯¹æ¯”ï¼Œæ¥çœ‹çœ‹å®ƒä»¬çš„æ€§èƒ½ï¼š

```bash
$  go test -test.bench=BenchmarkErrors -benchtime="3s"
goos: linux
goarch: amd64
pkg: github.com/marmotedu/errors
BenchmarkErrors/errors-stack-10-8           57658672          61.8 ns/op        16 B/op         1 allocs/op
BenchmarkErrors/pkg/errors-stack-10-8        2265558        1547 ns/op       320 B/op         3 allocs/op
BenchmarkErrors/marmot/errors-stack-10-8     1903532        1772 ns/op       360 B/op         5 allocs/op
BenchmarkErrors/errors-stack-100-8           4883659         734 ns/op        16 B/op         1 allocs/op
BenchmarkErrors/pkg/errors-stack-100-8       1202797        2881 ns/op       320 B/op         3 allocs/op
BenchmarkErrors/marmot/errors-stack-100-8    1000000        3116 ns/op       360 B/op         5 allocs/op
BenchmarkErrors/errors-stack-1000-8           505636        7159 ns/op        16 B/op         1 allocs/op
BenchmarkErrors/pkg/errors-stack-1000-8       327681       10646 ns/op       320 B/op         3 allocs/op
BenchmarkErrors/marmot/errors-stack-1000-8             304160       11896 ns/op       360 B/op         5 allocs/op
PASS
ok    github.com/marmotedu/errors  39.200s
```

å¯ä»¥çœ‹åˆ°`github.com/marmotedu/errors`å’Œ`github.com/pkg/errors`åŒ…çš„æ€§èƒ½åŸºæœ¬æŒå¹³ã€‚åœ¨å¯¹æ¯”æ€§èƒ½æ—¶ï¼Œé‡ç‚¹å…³æ³¨**ns/op**ï¼Œä¹Ÿå³æ¯æ¬¡erroræ“ä½œè€—è´¹çš„çº³ç§’æ•°ã€‚å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ä¸åŒerroråµŒå¥—æ·±åº¦ä¸‹çš„erroræ“ä½œæ€§èƒ½ï¼ŒåµŒå¥—è¶Šæ·±ï¼Œæ€§èƒ½è¶Šå·®ã€‚ä¾‹å¦‚ï¼šåœ¨åµŒå¥—æ·±åº¦ä¸º10çš„æ—¶å€™ï¼Œ `github.com/pkg/errors` åŒ… `ns/op` å€¼ä¸º1547ï¼Œ `github.com/marmotedu/errors` åŒ… `ns/op`  å€¼ä¸º1772ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒäºŒè€…æ€§èƒ½åŸºæœ¬ä¿æŒä¸€è‡´ã€‚

å…·ä½“æ€§èƒ½æ•°æ®å¯¹æ¯”è§ä¸‹è¡¨ï¼š

![imgasdfas](http://sm.nsddd.top/sm202302212258478.png)

æˆ‘ä»¬æ˜¯é€šè¿‡[BenchmarkErrors](https://github.com/marmotedu/errors/blob/v1.0.2/bench_test.go#L39)æµ‹è¯•å‡½æ•°æ¥æµ‹è¯•erroråŒ…æ€§èƒ½çš„ï¼Œä½ æ„Ÿå…´è¶£å¯ä»¥æ‰“å¼€é“¾æ¥çœ‹çœ‹ã€‚



## å¦‚ä½•è®°å½•é”™è¯¯ï¼Ÿ

ä¸Šé¢ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹äº†æ€ä¹ˆè®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„é”™è¯¯åŒ…ï¼Œé‚£å¦‚ä½•ç”¨æˆ‘ä»¬è®¾è®¡çš„é”™è¯¯åŒ…æ¥è®°å½•é”™è¯¯å‘¢ï¼Ÿ

æ ¹æ®æˆ‘çš„å¼€å‘ç»éªŒï¼Œæˆ‘æ¨èä¸¤ç§è®°å½•é”™è¯¯çš„æ–¹å¼ï¼Œå¯ä»¥å¸®ä½ å¿«é€Ÿå®šä½é—®é¢˜ã€‚

æ–¹å¼ä¸€ï¼šé€šè¿‡`github.com/marmotedu/errors`åŒ…æä¾›çš„é”™è¯¯å †æ ˆèƒ½åŠ›ï¼Œæ¥è·Ÿè¸ªé”™è¯¯ã€‚

å…·ä½“ä½ å¯ä»¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ã€‚ä»¥ä¸‹ä»£ç ä¿å­˜åœ¨[errortrack_errors.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_errors.go)ä¸­ã€‚

```go

package main

import (
  "fmt"

  "github.com/marmotedu/errors"

  code "github.com/marmotedu/sample-code"
)

func main() {
  if err := getUser(); err != nil {
    fmt.Printf("%+v\n", err)
  }
}

func getUser() error {
  if err := queryDatabase(); err != nil {
    return errors.Wrap(err, "get user failed.")
  }

  return nil
}

func queryDatabase() error {
  return errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
}
```

æ‰§è¡Œä¸Šè¿°çš„ä»£ç ï¼š

```bash
$ go run errortrack_errors.go
get user failed. - #1 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:19 (main.getUser)] (100101) Database error; user 'Lingfei Kong' not found. - #0 [/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/errors/errortrack_errors.go:26 (main.queryDatabase)] (100101) Database error
```

å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°çš„æ—¥å¿—ä¸­æ‰“å°å‡ºäº†è¯¦ç»†çš„é”™è¯¯å †æ ˆï¼ŒåŒ…æ‹¬é”™è¯¯å‘ç”Ÿçš„å‡½æ•°ã€æ–‡ä»¶åã€è¡Œå·å’Œé”™è¯¯ä¿¡æ¯ï¼Œé€šè¿‡è¿™äº›é”™è¯¯å †æ ˆï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®šä½é—®é¢˜ã€‚

ä½ ä½¿ç”¨è¿™ç§æ–¹æ³•æ—¶ï¼Œæˆ‘æ¨èçš„ç”¨æ³•æ˜¯ï¼Œåœ¨é”™è¯¯æœ€å¼€å§‹å¤„ä½¿ç”¨ `errors.WithCode()` åˆ›å»ºä¸€ä¸ª withCodeç±»å‹çš„é”™è¯¯ã€‚ä¸Šå±‚åœ¨å¤„ç†åº•å±‚è¿”å›çš„é”™è¯¯æ—¶ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä½¿ç”¨Wrapå‡½æ•°åŸºäºè¯¥é”™è¯¯å°è£…æ–°çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœè¦åŒ…è£…çš„errorä¸æ˜¯ç”¨`github.com/marmotedu/errors`åŒ…åˆ›å»ºçš„ï¼Œå»ºè®®ç”¨ `errors.WithCode()` æ–°å»ºä¸€ä¸ªerrorã€‚

æ–¹å¼äºŒï¼šåœ¨é”™è¯¯äº§ç”Ÿçš„æœ€åŸå§‹ä½ç½®è°ƒç”¨æ—¥å¿—åŒ…è®°å½•å‡½æ•°ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œå…¶ä»–ä½ç½®ç›´æ¥è¿”å›ï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æ€§çš„è¿½åŠ ä¸€äº›é”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿æ•…éšœå®šä½ï¼‰ã€‚ç¤ºä¾‹ä»£ç ï¼ˆä¿å­˜åœ¨[errortrack_log.go](https://github.com/marmotedu/gopractise-demo/blob/master/errors/errortrack_log.go)ï¼‰å¦‚ä¸‹ï¼š

```go

package main

import (
  "fmt"

  "github.com/marmotedu/errors"
  "github.com/marmotedu/log"

  code "github.com/marmotedu/sample-code"
)

func main() {
  if err := getUser(); err != nil {
    fmt.Printf("%v\n", err)
  }
}

func getUser() error {
  if err := queryDatabase(); err != nil {
    return err
  }

  return nil
}

func queryDatabase() error {
  opts := &log.Options{
    Level:            "info",
    Format:           "console",
    EnableColor:      true,
    EnableCaller:     true,
    OutputPaths:      []string{"test.log", "stdout"},
    ErrorOutputPaths: []string{},
  }

  log.Init(opts)
  defer log.Flush()

  err := errors.WithCode(code.ErrDatabase, "user 'Lingfei Kong' not found.")
  if err != nil {
    log.Errorf("%v", err)
  }
  return err
}
```

æ‰§è¡Œä»¥ä¸Šä»£ç ï¼š

```bash
$ go run errortrack_log.go
2021-07-03 14:37:31.597  ERROR  errors/errortrack_log.go:41  Database error
Database error
```

å½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œè°ƒç”¨logåŒ…æ‰“å°é”™è¯¯ã€‚é€šè¿‡logåŒ…çš„calleråŠŸèƒ½ï¼Œå¯ä»¥å®šä½åˆ°logè¯­å¥çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯å®šä½åˆ°é”™è¯¯å‘ç”Ÿçš„ä½ç½®ã€‚ä½ ä½¿ç”¨è¿™ç§æ–¹å¼æ¥æ‰“å°æ—¥å¿—æ—¶ï¼Œæˆ‘æœ‰ä¸¤ä¸ªå»ºè®®ã€‚

+ åªåœ¨é”™è¯¯äº§ç”Ÿçš„æœ€åˆä½ç½®æ‰“å°æ—¥å¿—ï¼Œå…¶ä»–åœ°æ–¹ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸€èˆ¬ä¸éœ€è¦å†å¯¹é”™è¯¯è¿›è¡Œå°è£…ã€‚
+ å½“ä»£ç è°ƒç”¨ç¬¬ä¸‰æ–¹åŒ…çš„å‡½æ•°æ—¶ï¼Œç¬¬ä¸‰æ–¹åŒ…å‡½æ•°å‡ºé”™æ—¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚æ¯”å¦‚ï¼š

```go
if err := os.Chdir("/root"); err != nil {    log.Errorf("change dir failed: %v", err)}
```



## ä¸€ä¸ªé”™è¯¯ç çš„å…·ä½“å®ç°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ªä¾æ®ä¸Šä¸€è®²ä»‹ç»çš„é”™è¯¯ç è§„èŒƒçš„å…·ä½“é”™è¯¯ç å®ç°`github.com/marmotedu/sample-code`ã€‚

`sample-code`å®ç°äº†ä¸¤ç±»é”™è¯¯ç ï¼Œåˆ†åˆ«æ˜¯é€šç”¨é”™è¯¯ç ï¼ˆ[sample-code/base.go](https://github.com/marmotedu/sample-code/blob/master/base.go)ï¼‰å’Œä¸šåŠ¡æ¨¡å—ç›¸å…³çš„é”™è¯¯ç ï¼ˆ[sample-code/apiserver.go](https://github.com/marmotedu/sample-code/blob/master/apiserver.go)ï¼‰ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹é€šç”¨é”™è¯¯ç çš„å®šä¹‰ï¼š

```go

// é€šç”¨: åŸºæœ¬é”™è¯¯
// Code must start with 1xxxxx
const (
    // ErrSuccess - 200: OK.
    ErrSuccess int = iota + 100001

    // ErrUnknown - 500: Internal server error.
    ErrUnknown

    // ErrBind - 400: Error occurred while binding the request body to the struct.
    ErrBind

    // ErrValidation - 400: Validation failed.
    ErrValidation

    // ErrTokenInvalid - 401: Token invalid.
    ErrTokenInvalid
)
```

åœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ•´å‹å¸¸é‡ï¼ˆErrSuccessï¼‰æ¥ä»£æ›¿æ•´å‹é”™è¯¯ç ï¼ˆ100001ï¼‰ï¼Œå› ä¸ºä½¿ç”¨ErrSuccessæ—¶ï¼Œä¸€çœ‹å°±çŸ¥é“å®ƒä»£è¡¨çš„é”™è¯¯ç±»å‹ï¼Œå¯ä»¥æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ã€‚

é”™è¯¯ç ç”¨æ¥æŒ‡ä»£ä¸€ä¸ªé”™è¯¯ç±»å‹ï¼Œè¯¥é”™è¯¯ç±»å‹éœ€è¦åŒ…å«ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å¯¹åº”çš„HTTP Status Codeã€å¯¹å¤–å±•ç¤ºçš„Messageï¼Œä»¥åŠè·Ÿè¯¥é”™è¯¯åŒ¹é…çš„å¸®åŠ©æ–‡æ¡£ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ªCoderæ¥æ‰¿è½½è¿™äº›ä¿¡æ¯ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå®ç°äº†`github.com/marmotedu/errors.Coder`æ¥å£çš„`ErrCode`ç»“æ„ä½“ï¼š

```go

// ErrCode implements `github.com/marmotedu/errors`.Coder interface.
type ErrCode struct {
    // C refers to the code of the ErrCode.
    C int

    // HTTP status that should be used for the associated error code.
    HTTP int

    // External (user) facing error text.
    Ext string

    // Ref specify the reference document.
    Ref string
}
```

å¯ä»¥çœ‹åˆ°`ErrCode`ç»“æ„ä½“åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š

+ intç±»å‹çš„ä¸šåŠ¡ç ã€‚
+ å¯¹åº”çš„HTTP Status Codeã€‚
+ æš´éœ²ç»™å¤–éƒ¨ç”¨æˆ·çš„æ¶ˆæ¯ã€‚
+ é”™è¯¯çš„å‚è€ƒæ–‡æ¡£ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„Coderç¤ºä¾‹ï¼š

```go
coder := &ErrCode{
    C:    100001,
    HTTP: 200,
    Ext:  "OK",
    Ref:  "https://github.com/marmotedu/sample-code/blob/master/README.md",
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨`github.com/marmotedu/errors`åŒ…æä¾›çš„`Register`æˆ–è€…`MustRegister`å‡½æ•°ï¼Œå°†Coderæ³¨å†Œåˆ°`github.com/marmotedu/errors`åŒ…ç»´æŠ¤çš„å†…å­˜ä¸­ã€‚

ä¸€ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šä¸ªé”™è¯¯ç ï¼Œå¦‚æœæ¯ä¸ªé”™è¯¯ç éƒ½æ‰‹åŠ¨è°ƒç”¨`MustRegister`å‡½æ•°ä¼šå¾ˆéº»çƒ¦ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•ï¼Œæ¥ç”Ÿæˆregisterå‡½æ•°è°ƒç”¨ï¼š

```bash
//go:generate codegen -type=int
//go:generate codegen -type=int -doc -output ./error_code_generated.md
```

`//go:generate codegen -type=int` ä¼šè°ƒç”¨[codegen](https://github.com/marmotedu/iam/tree/master/tools/codegen)å·¥å…·ï¼Œç”Ÿæˆ[sample_code_generated.go](https://github.com/marmotedu/sample-code/blob/master/sample_code_generated.go)æºç æ–‡ä»¶ï¼š

```go
func init() {
  register(ErrSuccess, 200, "OK")
  register(ErrUnknown, 500, "Internal server error")
  register(ErrBind, 400, "Error occurred while binding the request body to the struct")
  register(ErrValidation, 400, "Validation failed")
    // other register function call
}
```

è¿™äº›[register](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/code/code.go#L58)è°ƒç”¨æ”¾åœ¨initå‡½æ•°ä¸­ï¼Œåœ¨åŠ è½½ç¨‹åºçš„æ—¶å€™è¢«åˆå§‹åŒ–ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œåœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ£€æŸ¥HTTP Status Codeï¼Œåªå…è®¸å®šä¹‰200ã€400ã€401ã€403ã€404ã€500è¿™6ä¸ªHTTPé”™è¯¯ç ã€‚è¿™é‡Œé€šè¿‡ç¨‹åºä¿è¯äº†é”™è¯¯ç æ˜¯ç¬¦åˆHTTP Status Codeä½¿ç”¨è¦æ±‚çš„ã€‚

`//go:generate codegen -type=int -doc -output ./error_code_generated.md`ä¼šç”Ÿæˆé”™è¯¯ç æè¿°æ–‡æ¡£ [error_code_generated.md](https://github.com/marmotedu/sample-code/blob/master/error_code_generated.md)ã€‚å½“æˆ‘ä»¬æä¾›APIæ–‡æ¡£æ—¶ï¼Œä¹Ÿéœ€è¦è®°ç€æä¾›ä¸€ä»½é”™è¯¯ç æè¿°æ–‡æ¡£ï¼Œè¿™æ ·å®¢æˆ·ç«¯æ‰å¯ä»¥æ ¹æ®é”™è¯¯ç ï¼ŒçŸ¥é“è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œä»¥åŠå…·ä½“å‘ç”Ÿå“ªç±»é”™è¯¯ï¼Œå¥½é’ˆå¯¹æ€§åœ°åšä¸€äº›é€»è¾‘å¤„ç†ã€‚

`codegen`å·¥å…·ä¼šæ ¹æ®é”™è¯¯ç æ³¨é‡Šç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`æ–‡ä»¶ï¼š

```bash
// ErrSuccess - 200: OK. ErrSuccess int = iota + 100001
```

codegenå·¥å…·ä¹‹æ‰€ä»¥èƒ½å¤Ÿç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„é”™è¯¯ç æ³¨é‡Šæ˜¯æœ‰è§„å®šæ ¼å¼çš„ï¼š`// <é”™è¯¯ç æ•´å‹å¸¸é‡> - <å¯¹åº”çš„HTTP Status Code>: <External Message>.`ã€‚

codegenå·¥å…·å¯ä»¥åœ¨IAMé¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…ï¼š

```bash
$ make tools.install.codegen
```

å®‰è£…å®Œ `codegen` å·¥å…·åï¼Œå¯ä»¥åœ¨ `github.com/marmotedu/sample-code` åŒ…æ ¹ç›®å½•ä¸‹æ‰§è¡Œ `go generate` å‘½ä»¤ï¼Œæ¥ç”Ÿæˆ`sample_code_generated.go`å’Œ`error_code_generated.md`ã€‚è¿™é‡Œæœ‰ä¸ªæŠ€å·§éœ€è¦ä½ æ³¨æ„ï¼šç”Ÿæˆçš„æ–‡ä»¶å»ºè®®ç»Ÿä¸€ç”¨ `xxxx_generated.xx` æ¥å‘½åï¼Œè¿™æ ·é€šè¿‡ `generated` ï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿™ä¸ªæ–‡ä»¶æ˜¯ä»£ç è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç†è§£å’Œä½¿ç”¨ã€‚

åœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†é”™è¯¯ç ç‹¬ç«‹æˆä¸€ä¸ªåŒ…ï¼Œæ”¾åœ¨ `internal/pkg/code/`ç›®å½•ä¸‹ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿æ•´ä¸ªåº”ç”¨è°ƒç”¨ã€‚ä¾‹å¦‚IAMçš„é”™è¯¯ç å°±æ”¾åœ¨IAMé¡¹ç›®æ ¹ç›®å½•ä¸‹çš„[internal/pkg/code/](https://github.com/marmotedu/iam/tree/master/internal/pkg/code)ç›®å½•ä¸‹ã€‚

æˆ‘ä»¬çš„é”™è¯¯ç æ˜¯åˆ†æœåŠ¡å’Œæ¨¡å—çš„ï¼Œæ‰€ä»¥è¿™é‡Œå»ºè®®ä½ æŠŠç›¸åŒçš„æœåŠ¡æ”¾åœ¨åŒä¸€ä¸ªGoæºæ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚IAMçš„é”™è¯¯ç å­˜æ”¾æ–‡ä»¶ï¼š

```bash
$ ls base.go apiserver.go authzserver.go apiserver.go  authzserver.go  base.go
```

ä¸€ä¸ªåº”ç”¨ä¸­ä¼šæœ‰å¤šä¸ªæœåŠ¡ï¼Œä¾‹å¦‚IAMåº”ç”¨ä¸­ï¼Œå°±åŒ…å«äº†`iam-apiserver`ã€`iam-authz-server`ã€`iam-pump`ä¸‰ä¸ªæœåŠ¡ã€‚è¿™äº›æœåŠ¡æœ‰ä¸€äº›é€šç”¨çš„é”™è¯¯ç ï¼Œä¸ºäº†ä¾¿äºç»´æŠ¤ï¼Œå¯ä»¥å°†è¿™äº›é€šç”¨çš„é”™è¯¯ç ç»Ÿä¸€æ”¾åœ¨`base.go`æºç æ–‡ä»¶ä¸­ã€‚å…¶ä»–çš„é”™è¯¯ç ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰æœåŠ¡åˆ†åˆ«æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­ï¼š`iam-apiserver`æœåŠ¡çš„é”™è¯¯ç ç»Ÿä¸€æ”¾åœ¨`apiserver.go`æ–‡ä»¶ä¸­ï¼›`iam-authz-server`çš„é”™è¯¯ç ç»Ÿä¸€å­˜æ”¾åœ¨`authzserver.go`æ–‡ä»¶ä¸­ã€‚å…¶ä»–æœåŠ¡ä»¥æ­¤ç±»æ¨ã€‚

å¦å¤–ï¼ŒåŒä¸€ä¸ªæœåŠ¡ä¸­ä¸åŒæ¨¡å—çš„é”™è¯¯ç ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ ¼å¼æ¥ç»„ç»‡ï¼šç›¸åŒæ¨¡å—çš„é”™è¯¯ç æ”¾åœ¨åŒä¸€ä¸ª`const`ä»£ç å—ä¸­ï¼Œä¸åŒæ¨¡å—çš„é”™è¯¯ç æ”¾åœ¨ä¸åŒçš„constä»£ç å—ä¸­ã€‚æ¯ä¸ªconstä»£ç å—çš„å¼€å¤´æ³¨é‡Šå°±æ˜¯è¯¥æ¨¡å—çš„é”™è¯¯ç å®šä¹‰ã€‚ä¾‹å¦‚ï¼š

```go
// iam-apiserver: user errors.
const (
    // ErrUserNotFound - 404: User not found.
    ErrUserNotFound int = iota + 110001

    // ErrUserAlreadyExist - 400: User already exist.
    ErrUserAlreadyExist
)

// iam-apiserver: secret errors.
const (
    // ErrEncrypt - 400: Secret reach the max count.
    ErrReachMaxCount int = iota + 110101

    //  ErrSecretNotFound - 404: Secret not found.
    ErrSecretNotFound
)
```

æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†é”™è¯¯ç å®šä¹‰è®°å½•åœ¨é¡¹ç›®çš„æ–‡ä»¶ä¸­ï¼Œä¾›å¼€å‘è€…æŸ¥é˜…ã€éµå®ˆå’Œä½¿ç”¨ï¼Œä¾‹å¦‚IAMé¡¹ç›®çš„é”™è¯¯ç å®šä¹‰è®°å½•æ–‡æ¡£ä¸º[code_specification.md](https://github.com/marmotedu/iam/blob/master/docs/guide/zh-CN/api/code_specification.md)ã€‚è¿™ä¸ªæ–‡æ¡£ä¸­è®°å½•äº†é”™è¯¯ç è¯´æ˜ã€é”™è¯¯æè¿°è§„èŒƒå’Œé”™è¯¯è®°å½•è§„èŒƒç­‰ã€‚



## é”™è¯¯ç å®é™…ä½¿ç”¨æ–¹æ³•ç¤ºä¾‹

ä¸Šé¢ï¼Œæˆ‘è®²è§£äº†é”™è¯¯åŒ…å’Œé”™è¯¯ç çš„å®ç°æ–¹å¼ï¼Œé‚£ä½ ä¸€å®šæƒ³çŸ¥é“åœ¨å®é™…å¼€å‘ä¸­æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚è¿™é‡Œï¼Œæˆ‘å°±ä¸¾ä¸€ä¸ªåœ¨gin webæ¡†æ¶ä¸­ä½¿ç”¨è¯¥é”™è¯¯ç çš„ä¾‹å­ï¼š

```go
// Response defines project response format which in marmotedu organization.
type Response struct {
    Code      errors.Code `json:"code,omitempty"`
    Message   string      `json:"message,omitempty"`
    Reference string      `json:"reference,omitempty"`
    Data      interface{} `json:"data,omitempty"`
}

// WriteResponse used to write an error and JSON data into response.
func WriteResponse(c *gin.Context, err error, data interface{}) {
    if err != nil {
        coder := errors.ParseCoder(err)

        c.JSON(coder.HTTPStatus(), Response{
            Code:      coder.Code(),
            Message:   coder.String(),
            Reference: coder.Reference(),
            Data:      data,
        })
    }

    c.JSON(http.StatusOK, Response{Data: data})
}

func GetUser(c *gin.Context) {
    log.Info("get user function called.", "X-Request-Id", requestid.Get(c))
    // Get the user by the `username` from the database.
    user, err := store.Client().Users().Get(c.Param("username"), metav1.GetOptions{})
    if err != nil {
        core.WriteResponse(c, errors.WithCode(code.ErrUserNotFound, err.Error()), nil)
        return
    }

    core.WriteResponse(c, nil, user)
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œé€šè¿‡`WriteResponse`ç»Ÿä¸€å¤„ç†é”™è¯¯ã€‚åœ¨ `WriteResponse` å‡½æ•°ä¸­ï¼Œå¦‚æœ`err != nil`ï¼Œåˆ™ä»errorä¸­è§£æå‡ºCoderï¼Œå¹¶è°ƒç”¨Coderæä¾›çš„æ–¹æ³•ï¼Œè·å–é”™è¯¯ç›¸å…³çš„Http Status Codeã€intç±»å‹çš„ä¸šåŠ¡ç ã€æš´éœ²ç»™ç”¨æˆ·çš„ä¿¡æ¯ã€é”™è¯¯çš„å‚è€ƒæ–‡æ¡£é“¾æ¥ï¼Œå¹¶è¿”å›JSONæ ¼å¼çš„ä¿¡æ¯ã€‚å¦‚æœ `err == nil` åˆ™è¿”å›200å’Œæ•°æ®ã€‚



## END é“¾æ¥

<ul><li><div><a href = '10.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '12.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

