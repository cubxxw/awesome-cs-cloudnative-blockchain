+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬43èŠ‚ åŸºäº GitHub Actions çš„ CI å®æˆ˜

<br>
<div><a href = '42.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '44.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]



ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚è¿™æ˜¯æœ¬ä¸“æ æ­£æ–‡çš„æœ€åä¸€è®²äº†ï¼Œæ­å–œä½ åšæŒåˆ°äº†æœ€åï¼

åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬è¦é¢‘ç¹åœ°æ‰§è¡Œé™æ€ä»£ç æ£€æŸ¥ã€æµ‹è¯•ã€ç¼–è¯‘ã€æ„å»ºç­‰æ“ä½œã€‚å¦‚æœæ¯ä¸€æ­¥æˆ‘ä»¬éƒ½æ‰‹åŠ¨æ‰§è¡Œï¼Œæ•ˆç‡ä½ä¸è¯´ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é€šå¸¸å€ŸåŠ©CIç³»ç»Ÿæ¥è‡ªåŠ¨åŒ–æ‰§è¡Œè¿™äº›æ“ä½œã€‚

å½“å‰ä¸šç•Œæœ‰å¾ˆå¤šä¼˜ç§€çš„CIç³»ç»Ÿå¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚ [CircleCI](https://circleci.com/)ã€[TravisCI](https://travis-ci.org/)ã€[Jenkins](https://github.com/jenkinsci/jenkins)ã€[CODING](https://coding.net/)ã€[GitHub Actions](https://github.com/features/actions) ç­‰ã€‚è¿™äº›ç³»ç»Ÿåœ¨è®¾è®¡ä¸Šå¤§åŒå°å¼‚ï¼Œä¸ºäº†å‡å°‘ä½ çš„å­¦ä¹ æˆæœ¬ï¼Œæˆ‘é€‰æ‹©äº†ç›¸å¯¹æ¥è¯´å®¹æ˜“å®è·µçš„GitHub Actionsï¼Œæ¥ç»™ä½ å±•ç¤ºå¦‚ä½•é€šè¿‡CIæ¥è®©å·¥ä½œè‡ªåŠ¨åŒ–ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘ä¼šå…ˆä»‹ç»ä¸‹GitHub ActionsåŠå…¶ç”¨æ³•ï¼Œå†å‘ä½ å±•ç¤ºä¸€ä¸ªCIç¤ºä¾‹ï¼Œæœ€åç»™ä½ æ¼”ç¤ºä¸‹IAMæ˜¯å¦‚ä½•æ„å»ºCIä»»åŠ¡çš„ã€‚

## GitHub Actionsçš„åŸºæœ¬ç”¨æ³•

GitHub Actionsæ˜¯GitHubä¸ºæ‰˜ç®¡åœ¨github.comç«™ç‚¹çš„é¡¹ç›®æä¾›çš„æŒç»­é›†æˆæœåŠ¡ï¼Œäº2018å¹´10æœˆæ¨å‡ºã€‚

GitHub Actionså…·æœ‰ä»¥ä¸‹åŠŸèƒ½ç‰¹æ€§ï¼š

+ æä¾›åŸå­çš„actionsé…ç½®å’Œç»„åˆactionsçš„workflowé…ç½®ä¸¤ç§èƒ½åŠ›ã€‚
+ å…¨å±€é…ç½®åŸºäº[YAMLé…ç½®](https://help.github.com/en/articles/migrating-github-actions-from-hcl-syntax-to-yaml-syntax)ï¼Œå…¼å®¹ä¸»æµCI/CDå·¥å…·é…ç½®ã€‚
+ Actions/WorkflowsåŸºäº[äº‹ä»¶è§¦å‘](https://help.github.com/en/articles/events-that-trigger-workflows)ï¼ŒåŒ…æ‹¬Event restrictionsã€Webhook eventsã€Scheduled eventsã€External eventsã€‚
+ æä¾›å¯ä¾›è¿è¡Œçš„æ‰˜ç®¡å®¹å™¨æœåŠ¡ï¼ŒåŒ…æ‹¬Dockerã€VMï¼Œå¯è¿è¡ŒLinuxã€macOSã€Windowsä¸»æµç³»ç»Ÿã€‚
+ æä¾›ä¸»æµè¯­è¨€çš„æ”¯æŒï¼ŒåŒ…æ‹¬Node.jsã€Pythonã€Javaã€Rubyã€PHPã€Goã€Rustã€.NETã€‚
+ æä¾›å®æ—¶æ—¥å¿—æµç¨‹ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚
+ æä¾›[å¹³å°å†…ç½®çš„Actions](https://help.github.com/en/articles/about-github-actions#discovering-actions-in-the-github-community)ä¸ç¬¬ä¸‰æ–¹æä¾›çš„Actionsï¼Œå¼€ç®±å³ç”¨ã€‚

### GitHub Actionsçš„åŸºæœ¬æ¦‚å¿µ

åœ¨æ„å»ºæŒç»­é›†æˆä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨ä»»åŠ¡ä¸­å¿ƒå®Œæˆå„ç§æ“ä½œï¼Œæ¯”å¦‚å…‹éš†ä»£ç ã€ç¼–è¯‘ä»£ç ã€è¿è¡Œå•å…ƒæµ‹è¯•ã€æ„å»ºå’Œå‘å¸ƒé•œåƒç­‰ã€‚GitHubæŠŠè¿™äº›æ“ä½œç§°ä¸ºActionsã€‚

Actionsåœ¨å¾ˆå¤šé¡¹ç›®ä¸­æ˜¯å¯ä»¥å…±äº«çš„ï¼ŒGitHubå…è®¸å¼€å‘è€…å°†è¿™äº›å¯å…±äº«çš„Actionsä¸Šä¼ åˆ°[GitHubçš„å®˜æ–¹Actionså¸‚åœº](https://github.com/marketplace?type=actions)ï¼Œå¼€å‘è€…åœ¨Actionså¸‚åœºä¸­å¯ä»¥æœç´¢åˆ°ä»–äººæäº¤çš„ Actionsã€‚å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª [awesome actions](https://github.com/sdras/awesome-actions) çš„ä»“åº“ï¼Œé‡Œé¢ä¹Ÿæœ‰ä¸å°‘çš„Actionå¯ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚å¦‚æœä½ éœ€è¦æŸä¸ª Actionï¼Œä¸å¿…è‡ªå·±å†™å¤æ‚çš„è„šæœ¬ï¼Œç›´æ¥å¼•ç”¨ä»–äººå†™å¥½çš„ Action å³å¯ã€‚æ•´ä¸ªæŒç»­é›†æˆè¿‡ç¨‹ï¼Œå°±å˜æˆäº†ä¸€ä¸ª Actions çš„ç»„åˆã€‚

Actionå…¶å®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è„šæœ¬ï¼Œå¯ä»¥å°†Actionå­˜æ”¾åœ¨GitHubä»£ç ä»“åº“ä¸­ï¼Œé€šè¿‡`<userName>/<repoName>`çš„è¯­æ³•å¼•ç”¨ Actionã€‚ä¾‹å¦‚ï¼Œ`actions/checkout@v2`è¡¨ç¤º`https://github.com/actions/checkout`è¿™ä¸ªä»“åº“ï¼Œtagæ˜¯v2ã€‚`actions/checkout@v2`ä¹Ÿä»£è¡¨ä¸€ä¸ª Actionï¼Œä½œç”¨æ˜¯å®‰è£… Goç¼–è¯‘ç¯å¢ƒã€‚GitHub å®˜æ–¹çš„ Actions éƒ½æ”¾åœ¨ [github.com/actions](https://github.com/actions) é‡Œé¢ã€‚

GitHub Actions æœ‰ä¸€äº›è‡ªå·±çš„æœ¯è¯­ï¼Œä¸‹é¢æˆ‘æ¥ä»‹ç»ä¸‹ã€‚

+ workflowï¼ˆå·¥ä½œæµç¨‹ï¼‰ï¼šä¸€ä¸ª `.yml` æ–‡ä»¶å¯¹åº”ä¸€ä¸ª workflowï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡æŒç»­é›†æˆã€‚ä¸€ä¸ª GitHub ä»“åº“å¯ä»¥åŒ…å«å¤šä¸ª workflowï¼Œåªè¦æ˜¯åœ¨ `.github/workflow` ç›®å½•ä¸‹çš„ `.yml` æ–‡ä»¶éƒ½ä¼šè¢« GitHub æ‰§è¡Œã€‚
+ jobï¼ˆä»»åŠ¡ï¼‰ï¼šä¸€ä¸ª workflow ç”±ä¸€ä¸ªæˆ–å¤šä¸ª job æ„æˆï¼Œæ¯ä¸ª job ä»£è¡¨ä¸€ä¸ªæŒç»­é›†æˆä»»åŠ¡ã€‚
+ stepï¼ˆæ­¥éª¤ï¼‰ï¼šæ¯ä¸ª job ç”±å¤šä¸ª step æ„æˆï¼Œä¸€æ­¥æ­¥å®Œæˆã€‚
+ actionï¼ˆåŠ¨ä½œï¼‰ï¼šæ¯ä¸ª step å¯ä»¥ä¾æ¬¡æ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå‘½ä»¤ï¼ˆactionï¼‰ã€‚
+ onï¼šä¸€ä¸ª workflow çš„è§¦å‘æ¡ä»¶ï¼Œå†³å®šäº†å½“å‰çš„ workflow åœ¨ä»€ä¹ˆæ—¶å€™è¢«æ‰§è¡Œã€‚

### workflowæ–‡ä»¶ä»‹ç»

GitHub Actions é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ä»£ç ä»“åº“çš„`.github/workflows`ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åç¼€ä¸º`.yml`ï¼Œæ”¯æŒåˆ›å»ºå¤šä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åå¯ä»¥ä»»æ„å–ï¼Œæ¯”å¦‚`iam.yml`ã€‚GitHub åªè¦å‘ç°`.github/workflows`ç›®å½•é‡Œé¢æœ‰`.yml`æ–‡ä»¶ï¼Œå°±ä¼šè‡ªåŠ¨è¿è¡Œè¯¥æ–‡ä»¶ï¼Œå¦‚æœè¿è¡Œè¿‡ç¨‹ä¸­å­˜åœ¨é—®é¢˜ï¼Œä¼šä»¥é‚®ä»¶çš„å½¢å¼é€šçŸ¥åˆ°ä½ ã€‚

workflow æ–‡ä»¶çš„é…ç½®å­—æ®µéå¸¸å¤šï¼Œå¦‚æœä½ æƒ³è¯¦ç»†äº†è§£ï¼Œå¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.github.com/cn/actions/reference/workflow-syntax-for-github-actions)ã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸€äº›åŸºæœ¬çš„é…ç½®å­—æ®µã€‚

1. `name`

`name`å­—æ®µæ˜¯ workflow çš„åç§°ã€‚å¦‚æœçœç•¥è¯¥å­—æ®µï¼Œé»˜è®¤ä¸ºå½“å‰ workflow çš„æ–‡ä»¶åã€‚

```yaml
name: GitHub Actions Demo
```

1. `on`

`on`å­—æ®µæŒ‡å®šè§¦å‘ workflow çš„æ¡ä»¶ï¼Œé€šå¸¸æ˜¯æŸäº›äº‹ä»¶ã€‚

```yaml
on: push
```

ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯ï¼Œ`push`äº‹ä»¶è§¦å‘ workflowã€‚`on`å­—æ®µä¹Ÿå¯ä»¥æ˜¯äº‹ä»¶çš„æ•°ç»„ï¼Œä¾‹å¦‚:

```yaml
on: push
```

ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯ï¼Œ`push`äº‹ä»¶æˆ–`pull_request`äº‹ä»¶éƒ½å¯ä»¥è§¦å‘ workflowã€‚

æƒ³äº†è§£å®Œæ•´çš„äº‹ä»¶åˆ—è¡¨ï¼Œä½ å¯ä»¥æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.github.com/en/actions/reference/events-that-trigger-workflows)ã€‚é™¤äº†ä»£ç åº“äº‹ä»¶ï¼ŒGitHub Actions ä¹Ÿæ”¯æŒå¤–éƒ¨äº‹ä»¶è§¦å‘ï¼Œæˆ–è€…å®šæ—¶è¿è¡Œã€‚

1. `on.<push|pull_request>.<tags|branches>`

æŒ‡å®šè§¦å‘äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šåˆ†æ”¯æˆ–æ ‡ç­¾ã€‚

```yaml
on:  push:    branches:      - master
```

ä¸Šé¢çš„é…ç½®æŒ‡å®šï¼Œåªæœ‰`master`åˆ†æ”¯å‘ç”Ÿ`push`äº‹ä»¶æ—¶ï¼Œæ‰ä¼šè§¦å‘ workflowã€‚

1. `jobs.<job_id>.name`

workflow æ–‡ä»¶çš„ä¸»ä½“æ˜¯`jobs`å­—æ®µï¼Œè¡¨ç¤ºè¦æ‰§è¡Œçš„ä¸€é¡¹æˆ–å¤šé¡¹ä»»åŠ¡ã€‚

`jobs`å­—æ®µé‡Œé¢ï¼Œéœ€è¦å†™å‡ºæ¯ä¸€é¡¹ä»»åŠ¡çš„`job_id`ï¼Œå…·ä½“åç§°è‡ªå®šä¹‰ã€‚`job_id`é‡Œé¢çš„`name`å­—æ®µæ˜¯ä»»åŠ¡çš„è¯´æ˜ã€‚

```yaml
jobs:  my_first_job:    name: My first job  my_second_job:    name: My second job
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`jobs`å­—æ®µåŒ…å«ä¸¤é¡¹ä»»åŠ¡ï¼Œ`job_id`åˆ†åˆ«æ˜¯`my_first_job`å’Œ`my_second_job`ã€‚

1. `jobs.<job_id>.needs`

`needs`å­—æ®µæŒ‡å®šå½“å‰ä»»åŠ¡çš„ä¾èµ–å…³ç³»ï¼Œå³è¿è¡Œé¡ºåºã€‚

```yaml
jobs:  job1:  job2:    needs: job1  job3:    needs: [job1, job2]
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`job1`å¿…é¡»å…ˆäº`job2`å®Œæˆï¼Œè€Œ`job3`ç­‰å¾…`job1`å’Œ`job2`å®Œæˆåæ‰èƒ½è¿è¡Œã€‚å› æ­¤ï¼Œè¿™ä¸ª workflow çš„è¿è¡Œé¡ºåºä¸ºï¼š`job1`ã€`job2`ã€`job3`ã€‚

1. `jobs.<job_id>.runs-on`

`runs-on`å­—æ®µæŒ‡å®šè¿è¡Œæ‰€éœ€è¦çš„è™šæ‹Ÿæœºç¯å¢ƒï¼Œå®ƒæ˜¯å¿…å¡«å­—æ®µã€‚ç›®å‰å¯ç”¨çš„è™šæ‹Ÿæœºå¦‚ä¸‹ï¼š

+ ubuntu-latestã€ubuntu-18.04æˆ–ubuntu-16.04ã€‚
+ windows-latestã€windows-2019æˆ–windows-2016ã€‚
+ macOS-latestæˆ–macOS-10.14ã€‚

ä¸‹é¢çš„é…ç½®æŒ‡å®šè™šæ‹Ÿæœºç¯å¢ƒä¸º`ubuntu-18.04`ã€‚

```yaml
runs-on: ubuntu-18.04
```

1. `jobs.<job_id>.steps`

`steps`å­—æ®µæŒ‡å®šæ¯ä¸ª Job çš„è¿è¡Œæ­¥éª¤ï¼Œå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤ã€‚æ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥æŒ‡å®šä¸‹é¢ä¸‰ä¸ªå­—æ®µã€‚

+ `jobs.<job_id>.steps.name`ï¼šæ­¥éª¤åç§°ã€‚
+ `jobs.<job_id>.steps.run`ï¼šè¯¥æ­¥éª¤è¿è¡Œçš„å‘½ä»¤æˆ–è€… actionã€‚
+ `jobs.<job_id>.steps.env`ï¼šè¯¥æ­¥éª¤æ‰€éœ€çš„ç¯å¢ƒå˜é‡ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ workflow æ–‡ä»¶çš„èŒƒä¾‹ï¼š

```yaml
name: Greeting from Monaon: pushjobs:  my-job:    name: My Job    runs-on: ubuntu-latest    steps:    - name: Print a greeting      env:        MY_VAR: Hello! My name is        FIRST_NAME: Lingfei        LAST_NAME: Kong      run: |        echo $MY_VAR $FIRST_NAME $LAST_NAME.
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`steps`å­—æ®µåªåŒ…æ‹¬ä¸€ä¸ªæ­¥éª¤ã€‚è¯¥æ­¥éª¤å…ˆæ³¨å…¥ä¸‰ä¸ªç¯å¢ƒå˜é‡ï¼Œç„¶åæ‰§è¡Œä¸€æ¡ Bash å‘½ä»¤ã€‚

1. `uses`

`uses` å¯ä»¥å¼•ç”¨åˆ«äººå·²ç»åˆ›å»ºçš„ actionsï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ actions å¸‚åœºä¸­çš„ actionsã€‚å¼•ç”¨æ ¼å¼ä¸º`userName/repoName@verison`ï¼Œä¾‹å¦‚`uses: actions/setup-go@v1`ã€‚

1. `with`

`with` æŒ‡å®šactionsçš„è¾“å…¥å‚æ•°ã€‚æ¯ä¸ªè¾“å…¥å‚æ•°éƒ½æ˜¯ä¸€ä¸ªé”®/å€¼å¯¹ã€‚è¾“å…¥å‚æ•°è¢«è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œè¯¥å˜é‡çš„å‰ç¼€ä¸º `INPUT_`ï¼Œå¹¶è½¬æ¢ä¸ºå¤§å†™ã€‚

è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å®šä¹‰ `hello_world` æ“ä½œæ‰€å®šä¹‰çš„ä¸‰ä¸ªè¾“å…¥å‚æ•°ï¼ˆ`first_name`ã€`middle_name` å’Œ `last_name`ï¼‰ï¼Œè¿™äº›è¾“å…¥å˜é‡å°†è¢« `hello-world` æ“ä½œä½œä¸º `INPUT_FIRST_NAME`ã€`INPUT_MIDDLE_NAME` å’Œ `INPUT_LAST_NAME` ç¯å¢ƒå˜é‡ä½¿ç”¨ã€‚

```yaml
jobs:  my_first_job:    steps:      - name: My first step        uses: actions/hello_world@master        with:          first_name: Lingfei          middle_name: Go          last_name: Kong
```

1. `run`

`run`æŒ‡å®šæ‰§è¡Œçš„å‘½ä»¤ã€‚å¯ä»¥æœ‰å¤šä¸ªå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š

```yaml
- name: Build      run: |      go mod tidy      go build -v -o helloci .
```

1. `id`

`id`æ˜¯stepçš„å”¯ä¸€æ ‡è¯†ã€‚

## GitHub Actionsçš„è¿›é˜¶ç”¨æ³•

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†GitHub Actionsçš„ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œè¿™é‡Œæˆ‘å†ä»‹ç»ä¸‹GitHub Actionsçš„è¿›é˜¶ç”¨æ³•ã€‚

### ä¸ºå·¥ä½œæµåŠ ä¸€ä¸ªBadge

åœ¨actionçš„é¢æ¿ä¸­ï¼Œç‚¹å‡»`Create status badge`å°±å¯ä»¥å¤åˆ¶Badgeçš„Markdownå†…å®¹åˆ°README.mdä¸­ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨README.mdä¸­çœ‹åˆ°å½“å‰çš„æ„å»ºç»“æœï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/45/af/453a97b0776281873dee5671c53347af.png?wh=1280x765)](https://static001.geekbang.org/resource/image/45/af/453a97b0776281873dee5671c53347af.png?wh=1280x765)

### ä½¿ç”¨æ„å»ºçŸ©é˜µ

å¦‚æœæˆ‘ä»¬æƒ³åœ¨å¤šä¸ªç³»ç»Ÿæˆ–è€…å¤šä¸ªè¯­è¨€ç‰ˆæœ¬ä¸Šæµ‹è¯•æ„å»ºï¼Œå°±éœ€è¦è®¾ç½®æ„å»ºçŸ©é˜µã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿã€å¤šä¸ªGoç‰ˆæœ¬ä¸‹è·‘æµ‹è¯•ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹workflowé…ç½®ï¼š

```yaml
name: Go Teston: [push, pull_request]jobs:  helloci-build:    name: Test with go ${} on ${}    runs-on: ${}    strategy:      matrix:        go_version: [1.15, 1.16]        os: [ubuntu-latest, macOS-latest]    steps:      - name: Set up Go ${}        uses: actions/setup-go@v2        with:          go-version: ${}        id: go
```

ä¸Šé¢çš„workflowé…ç½®ï¼Œé€šè¿‡`strategy.matrix`é…ç½®äº†è¯¥å·¥ä½œæµç¨‹è¿è¡Œçš„ç¯å¢ƒçŸ©é˜µï¼ˆæ ¼å¼ä¸º`go_version.os`ï¼‰ï¼š`ubuntu-latest.1.15`ã€`ubuntu-latest.1.16`ã€`macOS-latest.1.15`ã€`macOS-latest.1.16`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼šåœ¨4å°ä¸åŒé…ç½®çš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¯¥workflowã€‚

### ä½¿ç”¨Secrets

åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç”¨åˆ°`ssh`æˆ–è€…`token`ç­‰æ•æ„Ÿæ•°æ®ï¼Œè€Œæˆ‘ä»¬ä¸å¸Œæœ›è¿™äº›æ•°æ®ç›´æ¥æš´éœ²åœ¨ä»“åº“ä¸­ï¼Œæ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨`secrets`ã€‚

æˆ‘ä»¬åœ¨å¯¹åº”é¡¹ç›®ä¸­é€‰æ‹©`Settings`-> `Secrets`ï¼Œå°±å¯ä»¥åˆ›å»º`secret`ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046)](https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046)

é…ç½®æ–‡ä»¶ä¸­çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```yaml
name: Go Teston: [push, pull_request]jobs:  helloci-build:    name: Test with go    runs-on: [ubuntu-latest]    environment:      name: helloci    steps:      - name: use secrets        env:          super_secret: ${}
```

secret nameä¸åŒºåˆ†å¤§å°å†™ï¼Œæ‰€ä»¥å¦‚æœæ–°å»ºsecretçš„åå­—æ˜¯nameï¼Œä½¿ç”¨æ—¶ç”¨ `secrets.name` æˆ–è€… `secrets.Name` éƒ½æ˜¯å¯ä»¥çš„ã€‚è€Œä¸”ï¼Œå°±ç®—æ­¤æ—¶ç›´æ¥ä½¿ç”¨ `echo` æ‰“å° `secret` , æ§åˆ¶å°ä¹Ÿåªä¼šæ‰“å°å‡º``*æ¥ä¿æŠ¤secretã€‚
è¿™é‡Œè¦æ³¨æ„ï¼Œä½ çš„secretæ˜¯å±äºæŸä¸€ä¸ªç¯å¢ƒå˜é‡çš„ï¼Œæ‰€ä»¥è¦æŒ‡æ˜ç¯å¢ƒçš„åå­—ï¼š`environment.name`ã€‚ä¸Šé¢çš„workflowé…ç½®ä¸­çš„`secrets.YourSecrets`å±äº`helloci`ç¯å¢ƒã€‚*

### *ä½¿ç”¨Artifactä¿å­˜æ„å»ºäº§ç‰©*

*åœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è¾“å‡ºä¸€äº›æ„å»ºäº§ç‰©ï¼Œæ¯”å¦‚æ—¥å¿—æ–‡ä»¶ã€æµ‹è¯•ç»“æœç­‰ã€‚è¿™äº›äº§ç‰©å¯ä»¥ä½¿ç”¨Github Actions Artifact æ¥å­˜å‚¨ã€‚ä½ å¯ä»¥ä½¿ç”¨[action/upload-artifact](https://github.com/actions/upload-artifact) å’Œ [download-artifact](https://github.com/actions/download-artifact) è¿›è¡Œæ„å»ºå‚æ•°çš„ç›¸å…³æ“ä½œã€‚*

*è¿™é‡Œæˆ‘ä»¥è¾“å‡ºJestæµ‹è¯•æŠ¥å‘Šä¸ºä¾‹æ¥æ¼”ç¤ºä¸‹å¦‚ä½•ä¿å­˜Artifactäº§ç‰©ã€‚Jestæµ‹è¯•åçš„æµ‹è¯•äº§ç‰©æ˜¯coverageï¼š*

```
steps:      - run: npm ci      - run: npm test      - name: Collect Test Coverage File        uses: actions/upload-artifact@v1.0.0        with:          name: coverage-output          path: coverage
```

*æ‰§è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬å°±èƒ½åœ¨å¯¹åº”actioné¢æ¿çœ‹åˆ°ç”Ÿæˆçš„Artifactï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/4c/66/4c4a8d6aec12a5dd1cdc80d238472566.png?wh=1280x208)](https://static001.geekbang.org/resource/image/4c/66/4c4a8d6aec12a5dd1cdc80d238472566.png?wh=1280x208)*

## *GitHub Actionså®æˆ˜*

*ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†GitHub Actionsçš„ç”¨æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥å®æˆ˜ä¸‹ï¼Œçœ‹ä¸‹ä½¿ç”¨GitHub Actionsçš„6ä¸ªå…·ä½“æ­¥éª¤ã€‚*

***ç¬¬ä¸€æ­¥ï¼Œ**åˆ›å»ºä¸€ä¸ªæµ‹è¯•ä»“åº“ã€‚*

*ç™»é™†[GitHubå®˜ç½‘](https://github.com/)ï¼Œç‚¹å‡»**New repository**åˆ›å»ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/6d/a0/6d76d02f0418671a32f5346fccf616a0.png?wh=1920x810)](https://static001.geekbang.org/resource/image/6d/a0/6d76d02f0418671a32f5346fccf616a0.png?wh=1920x810)*

*è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå«`helloci`çš„æµ‹è¯•é¡¹ç›®ã€‚*

***ç¬¬äºŒæ­¥ï¼Œ**å°†æ–°çš„ä»“åº“ clone ä¸‹æ¥ï¼Œå¹¶æ·»åŠ ä¸€äº›æ–‡ä»¶ï¼š*

```
$ git clone https://github.com/marmotedu/helloci
```

*ä½ å¯ä»¥å…‹éš†[marmotedu/helloci](https://github.com/marmotedu/helloci)ï¼Œå¹¶å°†é‡Œé¢çš„æ–‡ä»¶æ‹·è´åˆ°ä½ åˆ›å»ºçš„é¡¹ç›®ä»“åº“ä¸­ã€‚*

***ç¬¬ä¸‰æ­¥ï¼Œ**åˆ›å»ºGitHub Actions workflowé…ç½®ç›®å½•ï¼š*

```
$ mkdir -p .github/workflows                     
```

***ç¬¬å››æ­¥ï¼Œ**åˆ›å»ºGitHub Actions workflowé…ç½®ã€‚*

*åœ¨`.github/workflows`ç›®å½•ä¸‹æ–°å»º`helloci.yml`æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š*

```
name: CI Workflowjobs:  helloci-build:    name: Test with go ${} on ${}    runs-on: ${}    environment:      name: helloci    strategy:      matrix:        go_version: [1.16]        os: [ubuntu-latest]    steps:      - name: Set up Go ${}        uses: actions/setup-go@v2        with:          go-version: ${}        id: go      - name: Check out code into the Go module directory        uses: actions/checkout@v2      - name: Tidy        run: |          go mod tidy      - name: Build        run: |          go build -v -o helloci .      - name: Collect main.go file        uses: actions/upload-artifact@v1.0.0        with:          name: main-output          path: main.go      - name: Publish to Registry        uses: elgohr/Publish-Docker-GitHub-Action@master        with:          name: ccr.ccs.tencentyun.com/marmotedu/helloci:beta  # docker image çš„åå­—          username: ${} # ç”¨æˆ·å          password: ${} # å¯†ç           registry: ccr.ccs.tencentyun.com # è…¾è®¯äº‘Registry          dockerfile: Dockerfile # æŒ‡å®š Dockerfile çš„ä½ç½®          tag_names: true # æ˜¯å¦å°† release çš„ tag ä½œä¸º docker image çš„ tag
```

*ä¸Šé¢çš„workflowæ–‡ä»¶å®šä¹‰äº†å½“GitHubä»“åº“æœ‰`push`ã€`pull_request`äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘GitHub Actionså·¥ä½œæµç¨‹ï¼Œæµç¨‹ä¸­å®šä¹‰äº†ä¸€ä¸ªä»»åŠ¡ï¼ˆJobï¼‰`helloci-build`ï¼ŒJobä¸­åŒ…å«äº†å¤šä¸ªæ­¥éª¤ï¼ˆStepï¼‰ï¼Œæ¯ä¸ªæ­¥éª¤åˆåŒ…å«ä¸€äº›åŠ¨ä½œï¼ˆActionï¼‰ã€‚*

*ä¸Šé¢çš„workflowé…ç½®ä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‹é¢çš„6ä¸ªæ­¥éª¤ã€‚*

1. *å‡†å¤‡ä¸€ä¸ªGoç¼–è¯‘ç¯å¢ƒã€‚*
2. *ä»[marmotedu/helloci](https://github.com/marmotedu/helloci)ä¸‹è½½æºç ã€‚*
3. *æ·»åŠ æˆ–åˆ é™¤ç¼ºå¤±çš„ä¾èµ–åŒ…ã€‚*
4. *ç¼–è¯‘Goæºç ã€‚*
5. *ä¸Šä¼ æ„å»ºäº§ç‰©ã€‚*
6. *æ„å»ºé•œåƒï¼Œå¹¶å°†é•œåƒpushåˆ°`ccr.ccs.tencentyun.com/marmotedu/helloci:beta`ã€‚*

***ç¬¬äº”æ­¥ï¼Œ**åœ¨pushä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»º`DOCKER_USERNAME`å’Œ`DOCKER_PASSWORD` secretã€‚*

*å…¶ä¸­ï¼Œ`DOCKER_USERNAME`ä¿å­˜è…¾è®¯äº‘é•œåƒæœåŠ¡ï¼ˆCCRï¼‰çš„ç”¨æˆ·åï¼Œ`DOCKER_PASSWORD`ä¿å­˜CCRçš„å¯†ç ã€‚æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªsecretä¿å­˜åœ¨`helloci` Environmentsä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046)](https://static001.geekbang.org/resource/image/c0/d3/c00b11a1709838c1a205ace7976768d3.png?wh=1920x1046)*

***ç¬¬å…­æ­¥ï¼Œ**å°†é¡¹ç›®pushåˆ°GitHubï¼Œè§¦å‘workflowå·¥ä½œæµï¼š*

```
$ git add .$ git push origin master
```

*æ‰“å¼€æˆ‘ä»¬çš„ä»“åº“ Actions æ ‡ç­¾é¡µï¼Œå¯ä»¥å‘ç°GitHub Actions workflowæ­£åœ¨æ‰§è¡Œï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1a/8a/1afb7860d68635c5e3eaba4ff8da208a.png?wh=1920x691)](https://static001.geekbang.org/resource/image/1a/8a/1afb7860d68635c5e3eaba4ff8da208a.png?wh=1920x691)*

*ç­‰workflowæ‰§è¡Œå®Œï¼Œç‚¹å‡» **Go Test** è¿›å…¥æ„å»ºè¯¦æƒ…é¡µé¢ï¼Œåœ¨è¯¦æƒ…é¡µé¢èƒ½å¤Ÿçœ‹åˆ°æˆ‘ä»¬çš„æ„å»ºå†å²ï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a4/95/a4b83a122379db4f2fe9538afdfb5a95.png?wh=1920x701)](https://static001.geekbang.org/resource/image/a4/95/a4b83a122379db4f2fe9538afdfb5a95.png?wh=1920x701)*

*ç„¶åï¼Œé€‰æ‹©å…¶ä¸­ä¸€ä¸ªæ„å»ºè®°å½•ï¼ŒæŸ¥çœ‹å…¶è¿è¡Œè¯¦æƒ…ï¼ˆå…·ä½“å¯å‚è€ƒ[chore: update step name Go Test #10](https://github.com/marmotedu/helloci/actions/runs/1144156183)ï¼‰ï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/48/4f/481f64aabccf30ed61d0a7c85ab30d4f.png?wh=1920x1084)](https://static001.geekbang.org/resource/image/48/4f/481f64aabccf30ed61d0a7c85ab30d4f.png?wh=1920x1084)*

*ä½ å¯ä»¥çœ‹åˆ°ï¼Œ`Go Test`å·¥ä½œæµç¨‹æ‰§è¡Œäº†6ä¸ªJobï¼Œæ¯ä¸ªJobæ‰§è¡Œäº†ä¸‹é¢è¿™äº›è‡ªå®šä¹‰Stepï¼š*

1. *Set up Go 1.16ã€‚*
2. *Check out code into the Go module directoryã€‚*
3. *Tidyã€‚*
4. *Buildã€‚*
5. *Collect main.go fileã€‚*
6. *Publish to Registryã€‚*

*å…¶ä»–æ­¥éª¤æ˜¯GitHub Actionsè‡ªå·±æ·»åŠ çš„æ­¥éª¤ï¼š`Setup Job`ã€`Post Check out code into the Go module directory`ã€`Complete job`ã€‚ç‚¹å‡»æ¯ä¸€ä¸ªæ­¥éª¤ï¼Œä½ éƒ½èƒ½çœ‹åˆ°å®ƒä»¬çš„è¯¦ç»†è¾“å‡ºã€‚*

## *IAM GitHub Actionså®æˆ˜*

*æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹IAMé¡¹ç›®çš„GitHub Actionså®æˆ˜ã€‚*

*å‡è®¾IAMé¡¹ç›®æ ¹ç›®å½•ä¸º `$`ï¼Œå®ƒçš„workflowé…ç½®æ–‡ä»¶ä¸ºï¼š*

```bash
$ cat $/.github/workflows/iamci.yamlname: IamCIon:  push:    branchs:    - ''  pull_request:    types: [opened, reopened]jobs:  iamci:    name: Test with go ${} on ${}    runs-on: ${}    environment:      name: iamci    strategy:      matrix:        go_version: [1.16]        os: [ubuntu-latest]    steps:      - name: Set up Go ${}        uses: actions/setup-go@v2        with:          go-version: ${}        id: go      - name: Check out code into the Go module directory        uses: actions/checkout@v2      - name: Run go modules Tidy        run: |          make tidy      - name: Generate all necessary files, such as error code files        run: |          make gen      - name: Check syntax and styling of go sources        run: |          make lint      - name: Run unit test and get test coverage        run: |          make cover      - name: Build source code for host platform        run: |          make build      - name: Collect Test Coverage File        uses: actions/upload-artifact@v1.0.0        with:          name: main-output          path: _output/coverage.out      - name: Set up Docker Buildx        uses: docker/setup-buildx-action@v1      - name: Login to DockerHub        uses: docker/login-action@v1        with:          username: ${}          password: ${}      - name: Build docker images for host arch and push images to registry        run: |          make push
```

ä¸Šé¢çš„workflowä¾æ¬¡æ‰§è¡Œäº†ä»¥ä¸‹æ­¥éª¤ï¼š

1. è®¾ç½®Goç¼–è¯‘ç¯å¢ƒã€‚
2. ä¸‹è½½IAMé¡¹ç›®æºç ã€‚
3. æ·»åŠ /åˆ é™¤ä¸éœ€è¦çš„GoåŒ…ã€‚
4. ç”Ÿæˆæ‰€æœ‰çš„ä»£ç æ–‡ä»¶ã€‚
5. å¯¹IAMæºç è¿›è¡Œé™æ€ä»£ç æ£€æŸ¥ã€‚
6. è¿è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶è®¡ç®—å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ˜¯å¦è¾¾æ ‡ã€‚
7. ç¼–è¯‘ä»£ç ã€‚
8. æ”¶é›†æ„å»ºäº§ç‰©`_output/coverage.out`ã€‚
9. é…ç½®Dockeræ„å»ºç¯å¢ƒã€‚
10. ç™»é™†DockerHubã€‚
11. æ„å»ºDockeré•œåƒï¼Œå¹¶pushåˆ°DockerHubã€‚

IamCI workflowè¿è¡Œå†å²å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2b/b0/2b542f9101be0c3a83576fb99bf882b0.png?wh=1920x844)](https://static001.geekbang.org/resource/image/2b/b0/2b542f9101be0c3a83576fb99bf882b0.png?wh=1920x844)

IamCI workflowçš„å…¶ä¸­ä¸€æ¬¡å·¥ä½œæµç¨‹è¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e9/6a/e9ebf13fdb6e4f41a1b00406e646ec6a.png?wh=1920x887)](https://static001.geekbang.org/resource/image/e9/6a/e9ebf13fdb6e4f41a1b00406e646ec6a.png?wh=1920x887)

## æ€»ç»“

åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡CIä»»åŠ¡æ¥å°†éœ€è¦é¢‘ç¹æ“ä½œçš„ä»»åŠ¡è‡ªåŠ¨åŒ–ï¼Œè¿™ä¸ä»…å¯ä»¥æé«˜å¼€å‘æ•ˆç‡ï¼Œè¿˜èƒ½å‡å°‘æ‰‹åŠ¨æ“ä½œå¸¦æ¥çš„å¤±è¯¯ã€‚è¿™ä¸€è®²ï¼Œæˆ‘é€‰æ‹©äº†æœ€æ˜“å®è·µçš„GitHub Actionsï¼Œæ¥ç»™ä½ æ¼”ç¤ºå¦‚ä½•æ„å»ºCIä»»åŠ¡ã€‚

GitHub Actionsæ”¯æŒé€šè¿‡pushäº‹ä»¶æ¥è§¦å‘CIæµç¨‹ã€‚ä¸€ä¸ªCIæµç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªworkflowï¼Œworkflowä¸­åŒ…å«å¤šä¸ªä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡æ˜¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„ã€‚ä¸€ä¸ªä»»åŠ¡åˆåŒ…å«å¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸€æ­¥åˆç”±å¤šä¸ªåŠ¨ä½œç»„æˆã€‚åŠ¨ä½œï¼ˆActionï¼‰å…¶å®æ˜¯ä¸€ä¸ªå‘½ä»¤/è„šæœ¬ï¼Œç”¨æ¥å®Œæˆæˆ‘ä»¬æŒ‡å®šçš„ä»»åŠ¡ï¼Œå¦‚ç¼–è¯‘ç­‰ã€‚

å› ä¸ºGitHub Actionså†…å®¹æ¯”è¾ƒå¤šï¼Œè¿™ä¸€è®²åªä»‹ç»äº†ä¸€äº›æ ¸å¿ƒçš„çŸ¥è¯†ï¼Œæ›´è¯¦ç»†çš„GitHub Actionsæ•™ç¨‹ï¼Œä½ å¯ä»¥å‚è€ƒ [å®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://docs.github.com/cn/actions)ã€‚

## è¯¾åç»ƒä¹ 

1. ä½¿ç”¨CODINGå®ç°IAMçš„CIä»»åŠ¡ï¼Œå¹¶æ€è€ƒä¸‹ï¼šGitHub Actionså’ŒCODINGåœ¨CIä»»åŠ¡æ„å»ºä¸Šï¼Œæœ‰æ²¡æœ‰æœ¬è´¨çš„å·®å¼‚ï¼Ÿ
2. è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å€ŸåŠ©GitHub Actionså®ç°äº†CIï¼Œè¯·ä½ ç»“åˆå‰é¢æ‰€å­¦çš„çŸ¥è¯†ï¼Œå®ç°IAMçš„CDåŠŸèƒ½ã€‚æ¬¢è¿æäº¤Pull Requestã€‚



## END é“¾æ¥
<ul><li><div><a href = '42.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '44.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

