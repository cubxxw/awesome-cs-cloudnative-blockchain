+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬42èŠ‚ æœåŠ¡ç¼–æ’ï¼ˆä¸‹ï¼‰ï¼šåŸºäºHelmçš„æœåŠ¡ç¼–æ’éƒ¨ç½²å®æˆ˜

<br>
<div><a href = '41.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '43.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

ä¸Šä¸€è®²ï¼Œæˆ‘ä»‹ç»äº† Helm çš„åŸºç¡€çŸ¥è¯†ï¼Œå¹¶å¸¦ç€ä½ éƒ¨ç½²äº†ä¸€ä¸ªç®€å•çš„åº”ç”¨ã€‚æŒæ¡Helmçš„åŸºç¡€çŸ¥è¯†ä¹‹åï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å®æˆ˜ä¸‹ï¼Œä¸€èµ·é€šè¿‡Helméƒ¨ç½²ä¸€ä¸ªIAMåº”ç”¨ã€‚

é€šè¿‡Helméƒ¨ç½²IAMåº”ç”¨ï¼Œé¦–å…ˆéœ€è¦åˆ¶ä½œIAM ChartåŒ…ï¼Œç„¶åé€šè¿‡ChartåŒ…æ¥ä¸€é”®éƒ¨ç½²IAMåº”ç”¨ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†åº”ç”¨éƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒä¸­ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¼šç»™ä½ æ¼”ç¤ºä¸‹å¦‚ä½•åœ¨å¤šç¯å¢ƒä¸­éƒ¨ç½²IAMåº”ç”¨ã€‚

## åˆ¶ä½œIAM ChartåŒ…

åœ¨éƒ¨ç½²IAMåº”ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ¶ä½œä¸€ä¸ªIAM ChartåŒ…ã€‚

æˆ‘ä»¬å‡è®¾IAMé¡¹ç›®æºç æ ¹ç›®å½•ä¸º`$`ï¼Œè¿›å…¥ `$/deployments`ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹åˆ›å»ºChartåŒ…ã€‚å…·ä½“åˆ›å»ºæµç¨‹åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼Œä¸‹é¢æˆ‘æ¥è¯¦ç»†ä»‹ç»ä¸‹ã€‚

**ç¬¬ä¸€æ­¥ï¼Œ**åˆ›å»ºä¸€ä¸ªæ¨¡æ¿Chartã€‚

Chartæ˜¯ä¸€ä¸ªç»„ç»‡åœ¨æ–‡ä»¶ç›®å½•ä¸­çš„é›†åˆï¼Œç›®å½•åç§°å°±æ˜¯Chartåç§°ï¼ˆæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼‰ã€‚ä½ å¯ä»¥çœ‹çœ‹è¿™ä¸ª [Chart å¼€å‘æŒ‡å—](https://helm.sh/zh/docs/topics/charts) ï¼Œå®ƒä»‹ç»äº†å¦‚ä½•å¼€å‘ä½ è‡ªå·±çš„Chartã€‚

ä¸è¿‡ï¼Œè¿™é‡Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `helm create` å‘½ä»¤æ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæ¨¡æ¿Chartï¼Œå¹¶åŸºäºè¯¥Chartè¿›è¡Œä¿®æ”¹ï¼Œå¾—åˆ°ä½ è‡ªå·±çš„Chartã€‚åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ helm create iam
```

`helm create iam`ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª`iam`ç›®å½•ï¼Œé‡Œé¢å­˜æ”¾çš„å°±æ˜¯Chartæ–‡ä»¶ã€‚Chartç›®å½•ç»“æ„åŠæ–‡ä»¶å¦‚ä¸‹ï¼š

```bash
$ tree -FC iam/â”œâ”€â”€ charts/                            # [å¯é€‰]: è¯¥ç›®å½•ä¸­æ”¾ç½®å½“å‰Chartä¾èµ–çš„å…¶ä»–Chartâ”œâ”€â”€ Chart.yaml                         # YAMLæ–‡ä»¶ï¼Œç”¨äºæè¿°Chartçš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ç‰ˆæœ¬ç­‰â”œâ”€â”€ templates/                         # [å¯é€‰]: éƒ¨ç½²æ–‡ä»¶æ¨¡ç‰ˆç›®å½•ï¼Œæ¨¡ç‰ˆä½¿ç”¨çš„å€¼æ¥è‡ªvalues.yamlå’Œç”±Tilleræä¾›çš„å€¼â”‚   â”œâ”€â”€ deployment.yaml                # Kubernetes Deployment objectâ”‚   â”œâ”€â”€ helpers.tpl                   # ç”¨äºä¿®æ”¹Kubernetes objceté…ç½®çš„æ¨¡æ¿â”‚   â”œâ”€â”€ hpa.yaml                       # Kubernetes HPA objectâ”‚   â”œâ”€â”€ ingress.yaml                   # Kubernetes Ingress objectâ”‚   â”œâ”€â”€ NOTES.txt                      # [å¯é€‰]: æ”¾ç½®Chartçš„ä½¿ç”¨æŒ‡å—â”‚   â”œâ”€â”€ serviceaccount.yamlâ”‚   â”œâ”€â”€ service.yamlâ”‚   â””â”€â”€ tests/                         # å®šä¹‰äº†ä¸€äº›æµ‹è¯•èµ„æºâ”‚       â””â”€â”€ test-connection.yamlâ””â”€â”€ values.yaml                        # Chartçš„é»˜è®¤é…ç½®æ–‡ä»¶
```

*ä¸Šé¢çš„ç›®å½•ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ–‡ä»¶ï¼š*

+ *Chart.yaml æ–‡ä»¶*
+ *templatesç›®å½•*

*ä¸‹é¢æˆ‘æ¥è¯¦ç»†ä»‹ç»ä¸‹è¿™ä¸¤ä¸ªæ–‡ä»¶ã€‚**æˆ‘ä»¬å…ˆæ¥çœ‹Chart.yaml æ–‡ä»¶ã€‚***

*Chart.yamlç”¨æ¥æè¿°Chartçš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬åç§°ã€ç‰ˆæœ¬ç­‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š*

```
apiVersion: Chart API ç‰ˆæœ¬ ï¼ˆå¿…éœ€ï¼‰name: Chartåç§° ï¼ˆå¿…éœ€ï¼‰version: è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰kubeVersion: å…¼å®¹Kubernetesç‰ˆæœ¬çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰description: å¯¹è¿™ä¸ªé¡¹ç›®çš„ä¸€å¥è¯æè¿°ï¼ˆå¯é€‰ï¼‰type: Chartç±»å‹ ï¼ˆå¯é€‰ï¼‰keywords:  - å…³äºé¡¹ç›®çš„ä¸€ç»„å…³é”®å­—ï¼ˆå¯é€‰ï¼‰home: é¡¹ç›®homeé¡µé¢çš„URL ï¼ˆå¯é€‰ï¼‰sources:  - é¡¹ç›®æºç çš„URLåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰dependencies: # chart å¿…è¦æ¡ä»¶åˆ—è¡¨ ï¼ˆå¯é€‰ï¼‰  - name: Chartåç§° (nginx)    version: Chartç‰ˆæœ¬ ("1.2.3")    repository: ï¼ˆå¯é€‰ï¼‰ä»“åº“URL ("https://example.com/charts") æˆ–åˆ«å ("@repo-name")    condition: ï¼ˆå¯é€‰ï¼‰ è§£æä¸ºå¸ƒå°”å€¼çš„YAMLè·¯å¾„ï¼Œç”¨äºå¯ç”¨/ç¦ç”¨Chart(e.g. subchart1.enabled )    tags: # ï¼ˆå¯é€‰ï¼‰      - ç”¨äºä¸€æ¬¡å¯ç”¨/ç¦ç”¨ ä¸€ç»„Chartçš„tag    import-values: # ï¼ˆå¯é€‰ï¼‰      - ImportValue ä¿å­˜æºå€¼åˆ°å¯¼å…¥çˆ¶é”®çš„æ˜ å°„ã€‚æ¯é¡¹å¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–è€…ä¸€å¯¹å­/çˆ¶åˆ—è¡¨é¡¹    alias: ï¼ˆå¯é€‰ï¼‰ Chartä¸­ä½¿ç”¨çš„åˆ«åã€‚å½“ä½ è¦å¤šæ¬¡æ·»åŠ ç›¸åŒçš„Chartæ—¶ä¼šå¾ˆæœ‰ç”¨maintainers: # ï¼ˆå¯é€‰ï¼‰  - name: ç»´æŠ¤è€…åå­— ï¼ˆæ¯ä¸ªç»´æŠ¤è€…éƒ½éœ€è¦ï¼‰    email: ç»´æŠ¤è€…é‚®ç®± ï¼ˆæ¯ä¸ªç»´æŠ¤è€…å¯é€‰ï¼‰    url: ç»´æŠ¤è€…URL ï¼ˆæ¯ä¸ªç»´æŠ¤è€…å¯é€‰ï¼‰icon: ç”¨ä½œiconçš„SVGæˆ–PNGå›¾ç‰‡URL ï¼ˆå¯é€‰ï¼‰appVersion: åŒ…å«çš„åº”ç”¨ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰ã€‚ä¸éœ€è¦æ˜¯è¯­ä¹‰åŒ–ï¼Œå»ºè®®ä½¿ç”¨å¼•å·deprecated: ä¸è¢«æ¨èçš„Chartï¼ˆå¯é€‰ï¼Œå¸ƒå°”å€¼ï¼‰annotations:  example: æŒ‰åç§°è¾“å…¥çš„æ‰¹æ³¨åˆ—è¡¨ ï¼ˆå¯é€‰ï¼‰.
```

***æˆ‘ä»¬å†æ¥çœ‹ä¸‹\**\*\*templatesç›®å½•\*\**\*è¿™ä¸ªæ–‡ä»¶ã€‚***

*templatesç›®å½•ä¸­åŒ…å«äº†åº”ç”¨ä¸­å„ä¸ªKubernetesèµ„æºçš„YAMLæ ¼å¼èµ„æºå®šä¹‰æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼š*

```
apiVersion: v1kind: Servicemetadata:  labels:    app: {}  name: {}spec:  ports:  - name: http    protocol: TCP    {{- toYaml .Values.pump.service.http| nindent 4 }}  selector:    app: {}  sessionAffinity: None  type: {}
```

*`{}`ä¼šè¢«`deployments/iam/values.yaml`æ–‡ä»¶ä¸­`pump.name`çš„å€¼æ›¿æ¢ã€‚ä¸Šé¢çš„æ¨¡ç‰ˆè¯­æ³•æ‰©å±•äº† Go `text/template`åŒ…çš„è¯­æ³•ï¼š*

```
# è¿™ç§æ–¹å¼å®šä¹‰çš„æ¨¡ç‰ˆï¼Œä¼šå»é™¤testæ¨¡ç‰ˆå°¾éƒ¨æ‰€æœ‰çš„ç©ºè¡Œ{{- define "test"}}æ¨¡ç‰ˆå†…å®¹{{- end}}# å»é™¤testæ¨¡ç‰ˆå¤´éƒ¨çš„ç¬¬ä¸€ä¸ªç©ºè¡Œ{{- template "test" }}
```

*ä¸‹é¢æ˜¯ç”¨äºYAMLæ–‡ä»¶å‰ç½®ç©ºæ ¼çš„è¯­æ³•ï¼š*

```
# è¿™ç§æ–¹å¼å®šä¹‰çš„æ¨¡ç‰ˆï¼Œä¼šå»é™¤testæ¨¡ç‰ˆå¤´éƒ¨å’Œå°¾éƒ¨æ‰€æœ‰çš„ç©ºè¡Œ{ define "test" }æ¨¡ç‰ˆå†…å®¹{ end }# å¯ä»¥åœ¨testæ¨¡ç‰ˆæ¯ä¸€è¡Œçš„å¤´éƒ¨å¢åŠ 4ä¸ªç©ºæ ¼ï¼Œç”¨äºYAMLæ–‡ä»¶çš„å¯¹é½{{ include "test" | indent 4}}
```

*æœ€åï¼Œè¿™é‡Œæœ‰ä¸‰ç‚¹éœ€è¦ä½ æ³¨æ„ï¼š*

+ *Chartåç§°å¿…é¡»æ˜¯å°å†™å­—æ¯å’Œæ•°å­—ï¼Œå•è¯ä¹‹é—´å¯ä»¥ä½¿ç”¨æ¨ªæ `-`åˆ†éš”ï¼ŒChartåç§°ä¸­ä¸èƒ½ç”¨å¤§å†™å­—æ¯ï¼Œä¹Ÿä¸èƒ½ç”¨ä¸‹åˆ’çº¿ï¼Œ`.`å·ä¹Ÿä¸è¡Œã€‚*
+ *å°½å¯èƒ½ä½¿ç”¨[SemVer 2](https://semver.org/)æ¥è¡¨ç¤ºç‰ˆæœ¬å·ã€‚*
+ *YAML æ–‡ä»¶åº”è¯¥æŒ‰ç…§åŒç©ºæ ¼çš„å½¢å¼ç¼©è¿›(ä¸€å®šä¸è¦ä½¿ç”¨tabé”®)ã€‚*

***ç¬¬äºŒæ­¥ï¼Œ**ç¼–è¾‘ `iam` ç›®å½•ä¸‹çš„Chartæ–‡ä»¶ã€‚*

*æˆ‘ä»¬å¯ä»¥åŸºäº`helm create`ç”Ÿæˆçš„æ¨¡æ¿Chartæ¥æ„å»ºè‡ªå·±çš„ChartåŒ…ã€‚è¿™é‡Œæˆ‘ä»¬æ·»åŠ äº†åˆ›å»ºiam-apiserverã€iam-authz-serverã€iam-pumpã€iamctlæœåŠ¡éœ€è¦çš„YAMLæ ¼å¼çš„Kubernetesèµ„æºæ–‡ä»¶æ¨¡æ¿ï¼š*

```
$ ls -1 iam/templates/*.yamliam/templates/hpa.yaml                                   # Kubernetes HPAæ¨¡æ¿æ–‡ä»¶iam/templates/iam-apiserver-deployment.yaml              # iam-apiserveræœåŠ¡deploymentæ¨¡æ¿æ–‡ä»¶iam/templates/iam-apiserver-service.yaml                 # iam-apiserveræœåŠ¡serviceæ¨¡æ¿æ–‡ä»¶iam/templates/iam-authz-server-deployment.yaml           # iam-authz-serveræœåŠ¡deploymentæ¨¡æ¿æ–‡ä»¶iam/templates/iam-authz-server-service.yaml              # iam-authz-serveræœåŠ¡serviceæ¨¡æ¿æ–‡ä»¶iam/templates/iamctl-deployment.yaml                     # iamctlæœåŠ¡deploymentæ¨¡æ¿æ–‡ä»¶iam/templates/iam-pump-deployment.yaml                   # iam-pumpæœåŠ¡deploymentæ¨¡æ¿æ–‡ä»¶iam/templates/iam-pump-service.yaml                      # iam-pumpæœåŠ¡serviceæ¨¡æ¿æ–‡ä»¶
```

*æ¨¡æ¿çš„å…·ä½“å†…å®¹ï¼Œä½ å¯ä»¥æŸ¥çœ‹[deployments/iam/templates/](https://github.com/marmotedu/iam/tree/v1.1.0/deployments/iam/templates)ã€‚*

*åœ¨ç¼–è¾‘ Chart æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `helm lint` éªŒè¯æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œä¾‹å¦‚ï¼š*

```
$ helm lint iam==> Linting iam1 chart(s) linted, 0 chart(s) failed
```

*`0 chart(s) failed` è¯´æ˜å½“å‰Iam ChartåŒ…æ˜¯é€šè¿‡æ ¡éªŒçš„ã€‚*

***ç¬¬ä¸‰æ­¥ï¼Œ**ä¿®æ”¹Chartçš„é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ è‡ªå®šä¹‰é…ç½®ã€‚*

*æˆ‘ä»¬å¯ä»¥ç¼–è¾‘`deployments/iam/values.yaml`æ–‡ä»¶ï¼Œå®šåˆ¶è‡ªå·±çš„é…ç½®ã€‚å…·ä½“é…ç½®ä½ å¯ä»¥å‚è€ƒ[deployments/iam/values.yaml](https://github.com/marmotedu/iam/blob/v1.1.0/deployments/iam/values.yaml)ã€‚*

*åœ¨ä¿®æ”¹ `values.yaml` æ–‡ä»¶æ—¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›æœ€ä½³å®è·µã€‚*

+ *å˜é‡åç§°ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œå•è¯æŒ‰é©¼å³°åŒºåˆ†ï¼Œä¾‹å¦‚`chickenNoodleSoup`ã€‚*
+ *ç»™æ‰€æœ‰å­—ç¬¦ä¸²ç±»å‹çš„å€¼åŠ ä¸Šå¼•å·ã€‚*
+ *ä¸ºäº†é¿å…æ•´æ•°è½¬æ¢é—®é¢˜ï¼Œå°†æ•´å‹å­˜å‚¨ä¸ºå­—ç¬¦ä¸²æ›´å¥½ï¼Œå¹¶ç”¨ `{{ int $value }}` åœ¨æ¨¡æ¿ä¸­å°†å­—ç¬¦ä¸²è½¬å›æ•´å‹ã€‚*
+ *`values.yaml`ä¸­å®šä¹‰çš„æ¯ä¸ªå±æ€§éƒ½åº”è¯¥æ–‡æ¡£åŒ–ã€‚æ–‡æ¡£å­—ç¬¦ä¸²åº”è¯¥ä»¥å®ƒè¦æè¿°çš„å±æ€§å¼€å¤´ï¼Œå¹¶è‡³å°‘ç»™å‡ºä¸€å¥æè¿°ã€‚ä¾‹å¦‚ï¼š*

```
# serverHost is the host name for the webserverserverHost: example# serverPort is the HTTP listener port for the webserverserverPort: 9191
```

*è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ‰€æœ‰çš„Helmå†…ç½®å˜é‡éƒ½ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œä»¥ä¾¿ä¸ç”¨æˆ·å®šä¹‰çš„valueè¿›è¡ŒåŒºåˆ†ï¼Œä¾‹å¦‚`.Release.Name`ã€`.Capabilities.KubeVersion`ã€‚*

*ä¸ºäº†å®‰å…¨ï¼Œvalues.yamlä¸­åªé…ç½®Kubernetesèµ„æºç›¸å…³çš„é…ç½®é¡¹ï¼Œä¾‹å¦‚Deploymentå‰¯æœ¬æ•°ã€Serviceç«¯å£ç­‰ã€‚è‡³äºiam-apiserverã€iam-authz-serverã€iam-pumpã€iamctlç»„ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬åˆ›å»ºå•ç‹¬çš„ConfigMapï¼Œå¹¶åœ¨Deploymentä¸­å¼•ç”¨ã€‚*

***ç¬¬å››æ­¥ï¼Œ**æ‰“åŒ…Chartï¼Œå¹¶ä¸Šä¼ åˆ°Chartä»“åº“ä¸­ã€‚*

*è¿™æ˜¯ä¸€ä¸ªå¯é€‰æ­¥éª¤ï¼Œå¯ä»¥æ ¹æ®ä½ çš„å®é™…éœ€è¦æ¥é€‰æ‹©ã€‚å¦‚æœæƒ³äº†è§£å…·ä½“æ“ä½œï¼Œä½ å¯ä»¥æŸ¥çœ‹ [Helm chart ä»“åº“](https://helm.sh/zh/docs/topics/chart_repository)è·å–æ›´å¤šä¿¡æ¯ã€‚*

*æœ€åï¼ŒIAMåº”ç”¨çš„ChartåŒ…è§[deployments/iam](https://github.com/marmotedu/iam/tree/v1.1.0/deployments/iam)ã€‚*

## *IAM Chartéƒ¨ç½²*

*ä¸Šé¢ï¼Œæˆ‘ä»¬åˆ¶ä½œäº†IAMåº”ç”¨çš„ChartåŒ…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ªChartåŒ…æ¥ä¸€é”®åˆ›å»ºIAMåº”ç”¨ã€‚IAM Chartéƒ¨ç½²ä¸€å…±åˆ†ä¸º10ä¸ªæ­¥éª¤ï¼Œä½ å¯ä»¥è·Ÿç€æˆ‘ä¸€æ­¥æ­¥æ“ä½œä¸‹ã€‚*

***ç¬¬ä¸€æ­¥ï¼Œ**é…ç½®`scripts/install/environment.sh`ã€‚*

*`scripts/install/environment.sh`æ–‡ä»¶ä¸­åŒ…å«äº†å„ç±»è‡ªå®šä¹‰é…ç½®ï¼Œä½ ä¸»è¦é…ç½®ä¸‹é¢è¿™äº›è·Ÿæ•°æ®åº“ç›¸å…³çš„å°±å¯ä»¥ï¼Œå…¶ä»–é…ç½®ä½¿ç”¨é»˜è®¤å€¼ã€‚*

+ *MariaDBé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`MARIADB`*å¼€å¤´çš„å˜é‡ã€‚
+ Redisé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`REDIS_`å¼€å¤´çš„å˜é‡ã€‚
+ MongoDBé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`MONGO_`å¼€å¤´çš„å˜é‡ã€‚

**ç¬¬äºŒæ­¥ï¼Œ**åˆ›å»ºIAMåº”ç”¨çš„é…ç½®æ–‡ä»¶ã€‚

```bash
$ cd $$ make gen.defaultconfigs # ç”Ÿæˆiam-apiserverã€iam-authz-serverã€iam-pumpã€iamctlç»„ä»¶çš„é»˜è®¤é…ç½®æ–‡ä»¶$ make gen.ca # ç”Ÿæˆ CA è¯ä¹¦
```

ä¸Šé¢çš„å‘½ä»¤ä¼šå°†IAMçš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨ç›®å½•`$/_output/configs/`ä¸‹ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œ**åˆ›å»º `iam` å‘½åç©ºé—´ã€‚

æˆ‘ä»¬å°†IAMåº”ç”¨æ¶‰åŠåˆ°çš„å„ç±»èµ„æºéƒ½åˆ›å»ºåœ¨`iam`å‘½åç©ºé—´ä¸­ã€‚å°†IAMèµ„æºåˆ›å»ºåœ¨ç‹¬ç«‹çš„å‘½åç©ºé—´ä¸­ï¼Œä¸ä»…æ–¹ä¾¿ç»´æŠ¤ï¼Œè¿˜å¯ä»¥æœ‰æ•ˆé¿å…å½±å“å…¶ä»–Kubernetesèµ„æºã€‚

```bash
$ kubectl create namespace iam
```

**ç¬¬å››æ­¥ï¼Œ**å°†IAMå„æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ConfigMapèµ„æºçš„å½¢å¼ä¿å­˜åœ¨Kubernetesé›†ç¾¤ä¸­ã€‚

```bash
$ kubectl -n iam create configmap iam --from-file=$/_output/configs/$ kubectl -n iam get configmap iamNAME   DATA   AGEiam    4      13s
```

**ç¬¬äº”æ­¥ï¼Œ**å°†IAMå„æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦æ–‡ä»¶ï¼Œä»¥ConfigMapèµ„æºçš„å½¢å¼ä¿å­˜åœ¨Kubernetesé›†ç¾¤ä¸­ã€‚

```bash
$ kubectl -n iam create configmap iam-cert --from-file=$/_output/cert$ kubectl -n iam get configmap iam-certNAME       DATA   AGEiam-cert   14     12s
```

**ç¬¬å…­æ­¥ï¼Œ**åˆ›å»ºé•œåƒä»“åº“è®¿é—®å¯†é’¥ã€‚

åœ¨å‡†å¤‡é˜¶æ®µï¼Œæˆ‘ä»¬å¼€é€šäº†[è…¾è®¯äº‘é•œåƒä»“åº“æœåŠ¡](http://ccr.ccs.tencentyun.com/)ï¼Œå¹¶åˆ›å»ºäº†ç”¨æˆ·`10000099``xxxx`ï¼Œå¯†ç ä¸º`iam59!z$`ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºdocker-registry secretäº†ã€‚Kubernetesåœ¨ä¸‹è½½Dockeré•œåƒæ—¶ï¼Œéœ€è¦docker-registry secretæ¥è¿›è¡Œè®¤è¯ã€‚åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ kubectl -n iam create secret docker-registry ccr-registry --docker-server=ccr.ccs.tencentyun.com --docker-username=10000099xxxx --docker-password='iam59!z$'
```

**ç¬¬ä¸ƒæ­¥ï¼Œ**åˆ›å»ºDockeré•œåƒï¼Œå¹¶Pushåˆ°é•œåƒä»“åº“ã€‚

```bash
$ make push REGISTRY_PREFIX=ccr.ccs.tencentyun.com/marmotedu VERSION=v1.1.0
```

**ç¬¬å…«æ­¥ï¼Œ**å®‰è£…IAM ChartåŒ…ã€‚

åœ¨[49è®²](https://time.geekbang.org/column/article/420940)é‡Œï¼Œæˆ‘ä»‹ç»äº†4ç§å®‰è£…ChartåŒ…çš„æ–¹æ³•ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡æœªæ‰“åŒ…çš„IAM Chartè·¯å¾„æ¥å®‰è£…ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
$ cd $$ helm -n iam install iam deployments/iamNAME: iamLAST DEPLOYED: Sat Aug 21 17:46:56 2021NAMESPACE: iamSTATUS: deployedREVISION: 1TEST SUITE: None
```

æ‰§è¡Œ `helm install` åï¼ŒKubernetesä¼šè‡ªåŠ¨éƒ¨ç½²åº”ç”¨ï¼Œç­‰åˆ°IAMåº”ç”¨çš„Podéƒ½å¤„åœ¨ `Running` çŠ¶æ€æ—¶ï¼Œè¯´æ˜IAMåº”ç”¨å·²ç»æˆåŠŸå®‰è£…ï¼š

```bash
$ kubectl -n iam get pods|grep iamiam-apiserver-cb4ff955-hs827        1/1     Running   0          66siam-authz-server-7fccc7db8d-chwnn   1/1     Running   0          66siam-pump-78b57b4464-rrlbf           1/1     Running   0          66siamctl-59fdc4995-xrzhn              1/1     Running   0          66s
```

**ç¬¬ä¹æ­¥ï¼Œ**æµ‹è¯•IAMåº”ç”¨ã€‚

æˆ‘ä»¬é€šè¿‡`helm install`åœ¨`iam`å‘½ä»¤ç©ºé—´ä¸‹åˆ›å»ºäº†ä¸€ä¸ªæµ‹è¯•Deployment `iamctl`ã€‚ä½ å¯ä»¥ç™»é™†`iamctl` Deploymentæ‰€åˆ›å»ºå‡ºæ¥çš„Podï¼Œæ‰§è¡Œä¸€äº›è¿ç»´æ“ä½œå’Œå†’çƒŸæµ‹è¯•ã€‚ç™»é™†å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ kubectl -n iam exec -it kubectl -n iam get pods -l app=iamctl | awk '/iamctl/{print $1}' -- bash
```

ç™»é™†åˆ°`iamctl-xxxxxxxxxx-xxxxx` Podä¸­åï¼Œä½ å°±å¯ä»¥æ‰§è¡Œè¿ç»´æ“ä½œå’Œå†’çƒŸæµ‹è¯•äº†ã€‚

**å…ˆæ¥çœ‹è¿ç»´æ“ä½œã€‚**iamctlå·¥å…·ä»¥å­å‘½ä»¤çš„æ–¹å¼å¯¹å¤–æä¾›åŠŸèƒ½ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæä¾›çš„å„ç±»åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/69/y2/693f608aa571cbfd6e06c8cfdb242yy2.png?wh=1920x337)](https://static001.geekbang.org/resource/image/69/y2/693f608aa571cbfd6e06c8cfdb242yy2.png?wh=1920x337)

**å†æ¥çœ‹å†’çƒŸæµ‹è¯•ï¼š**

```bash
# cd /opt/iam/scripts/install# ./test.sh iam::test::smoke
```

å¦‚æœ`./test.sh iam::test::smoke`å‘½ä»¤æ‰“å°çš„è¾“å‡ºä¸­ï¼Œæœ€åä¸€è¡Œä¸º`congratulations, smoke test passed!`å­—ç¬¦ä¸²ï¼Œå°±è¯´æ˜IAMåº”ç”¨å®‰è£…æˆåŠŸã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9d/8c/9dcc557952b3586f7b37b065bf2bd58c.png?wh=1920x314)](https://static001.geekbang.org/resource/image/9d/8c/9dcc557952b3586f7b37b065bf2bd58c.png?wh=1920x314)

**ç¬¬åæ­¥ï¼Œ**é”€æ¯EKSé›†ç¾¤çš„èµ„æºã€‚

```bash
$ kubectl delete namespace iam
```

ä½ å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ˜¯å¦åˆ é™¤EKSé›†ç¾¤ï¼Œå¦‚æœä¸éœ€è¦äº†å°±å¯ä»¥é€‰æ‹©åˆ é™¤ã€‚

## IAMåº”ç”¨å¤šç¯å¢ƒéƒ¨ç½²

åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†IAMåº”ç”¨éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒä¸­ï¼Œä¸åŒç¯å¢ƒçš„é…ç½®æ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œé‚£ä¹ˆIAMé¡¹ç›®æ˜¯å¦‚ä½•è¿›è¡Œå¤šç¯å¢ƒéƒ¨ç½²çš„å‘¢ï¼Ÿ

IAMé¡¹ç›®åœ¨[configs](https://leeshengis.com/archives/421843)ç›®å½•ä¸‹åˆ›å»ºäº†å¤šä¸ªHelm valuesæ–‡ä»¶ï¼ˆæ ¼å¼ä¸º`values--env.yaml`ï¼‰ï¼š

+ values-test-env.yamlï¼Œæµ‹è¯•ç¯å¢ƒHelm valuesæ–‡ä»¶ã€‚
+ values-pre-env.yamlï¼Œé¢„å‘ç¯å¢ƒHelm valuesæ–‡ä»¶ã€‚
+ values-prod-env.yamlï¼Œç”Ÿäº§ç¯å¢ƒHelm valuesæ–‡ä»¶ã€‚

åœ¨éƒ¨ç½²IAMåº”ç”¨æ—¶ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡ŒæŒ‡å®š`-f`å‚æ•°ï¼Œä¾‹å¦‚ï¼š

```bash
$ helm -n iam install -f configs/values-test-env.yaml iam deployments/iam # å®‰è£…åˆ°æµ‹è¯•ç¯å¢ƒã€‚
```

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬é€šè¿‡ `helm create iam` åˆ›å»ºäº†ä¸€ä¸ªæ¨¡æ¿Chartï¼Œå¹¶åŸºäºè¿™ä¸ªæ¨¡æ¿ChartåŒ…è¿›è¡Œäº†äºŒæ¬¡å¼€å‘ï¼Œæœ€ç»ˆåˆ›å»ºäº†IAMåº”ç”¨çš„Helm ChartåŒ…ï¼š[deployments/iam](https://github.com/marmotedu/iam/tree/v1.1.0/deployments/iam)ã€‚

æœ‰äº†Helm ChartåŒ…ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `helm -n iam install iam deployments/iam` å‘½ä»¤æ¥ä¸€é”®éƒ¨ç½²å¥½æ•´ä¸ªIAMåº”ç”¨ã€‚å½“IAMåº”ç”¨ä¸­çš„æ‰€æœ‰Podéƒ½å¤„åœ¨ `Running` çŠ¶æ€åï¼Œè¯´æ˜IAMåº”ç”¨è¢«æˆåŠŸéƒ¨ç½²ã€‚

æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ç™»å½•iamctlå®¹å™¨ï¼Œæ‰§è¡Œ `test.sh iam::test::smoke` å‘½ä»¤ï¼Œæ¥å¯¹IAMåº”ç”¨è¿›è¡Œå†’çƒŸæµ‹è¯•ã€‚

## è¯¾åç»ƒä¹ 

1. è¯•ç€åœ¨Helm Chartä¸­åŠ å…¥MariaDBã€MongoDBã€Redisæ¨¡æ¿ï¼Œé€šè¿‡Helmä¸€é”®éƒ¨ç½²å¥½æ•´ä¸ªIAMåº”ç”¨ã€‚
2. è¯•ç€é€šè¿‡ `helm` å‘½ä»¤å‡çº§ã€å›æ»šå’Œåˆ é™¤IAMåº”ç”¨ã€‚



## END é“¾æ¥
<ul><li><div><a href = '41.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '43.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

