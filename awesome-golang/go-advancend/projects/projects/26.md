+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬26èŠ‚  SDK è®¾è®¡ï¼ˆä¸‹ï¼‰ï¼šIAMé¡¹ç›®Go SDKè®¾è®¡å’Œå®ç°

<br>
<div><a href = '25.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '27.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å¼€å§‹

ä¸Šä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†å…¬æœ‰äº‘å‚å•†æ™®éé‡‡ç”¨çš„SDKè®¾è®¡æ–¹å¼ã€‚å…¶å®ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒä¼˜ç§€çš„SDKè®¾è®¡æ–¹å¼ï¼Œæ¯”å¦‚ Kubernetesçš„ [client-go](https://github.com/kubernetes/client-go) SDKè®¾è®¡æ–¹å¼ã€‚IAMé¡¹ç›®å‚è€ƒclient-goï¼Œä¹Ÿå®ç°äº†client-goé£æ ¼çš„SDKï¼š[marmotedu-sdk-go](https://github.com/marmotedu/marmotedu-sdk-go)ã€‚

å’Œ [33è®²](https://time.geekbang.org/column/article/406389) ä»‹ç»çš„SDKè®¾è®¡æ–¹å¼ç›¸æ¯”ï¼Œclient-goé£æ ¼çš„SDKå…·æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

+ å¤§é‡ä½¿ç”¨äº†Go interfaceç‰¹æ€§ï¼Œå°†æ¥å£çš„å®šä¹‰å’Œå®ç°è§£è€¦ï¼Œå¯ä»¥æ”¯æŒå¤šç§å®ç°æ–¹å¼ã€‚
+ æ¥å£è°ƒç”¨å±‚çº§è·Ÿèµ„æºçš„å±‚çº§ç›¸åŒ¹é…ï¼Œè°ƒç”¨æ–¹å¼æ›´åŠ å‹å¥½ã€‚
+ å¤šç‰ˆæœ¬å…±å­˜ã€‚

æ‰€ä»¥ï¼Œæˆ‘æ›´æ¨èä½ ä½¿ç”¨marmotedu-sdk-goã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹marmotedu-sdk-goæ˜¯å¦‚ä½•è®¾è®¡å’Œå®ç°çš„ã€‚

## marmotedu-sdk-goè®¾è®¡

å’Œmedu-sdk-goç›¸æ¯”ï¼Œmarmotedu-sdk-goçš„è®¾è®¡å’Œå®ç°è¦å¤æ‚ä¸€äº›ï¼Œä½†åŠŸèƒ½æ›´å¼ºå¤§ï¼Œä½¿ç”¨ä½“éªŒä¹Ÿæ›´å¥½ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªä½¿ç”¨SDKè°ƒç”¨iam-authz-server `/v1/authz` æ¥å£çš„ç¤ºä¾‹ï¼Œä»£ç ä¿å­˜åœ¨[ marmotedu-sdk-go/examples/authz_clientset/main.go](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/examples/authz_clientset/main.go)æ–‡ä»¶ä¸­ï¼š

```go
package mainimport (	"context"	"flag"	"fmt"	"path/filepath"	"github.com/ory/ladon"	metav1 "github.com/marmotedu/component-base/pkg/meta/v1"	"github.com/marmotedu/component-base/pkg/util/homedir"	"github.com/marmotedu/marmotedu-sdk-go/marmotedu"	"github.com/marmotedu/marmotedu-sdk-go/tools/clientcmd")func main() {	var iamconfig *string	if home := homedir.HomeDir(); home != "" {		iamconfig = flag.String(			"iamconfig",			filepath.Join(home, ".iam", "config"),			"(optional) absolute path to the iamconfig file",		)	} else {		iamconfig = flag.String("iamconfig", "", "absolute path to the iamconfig file")	}	flag.Parse()	// use the current context in iamconfig	config, err := clientcmd.BuildConfigFromFlags("", *iamconfig)	if err != nil {		panic(err.Error())	}	// create the clientset	clientset, err := marmotedu.NewForConfig(config)	if err != nil {		panic(err.Error())	}	request := &ladon.Request{		Resource: "resources:articles:ladon-introduction",		Action:   "delete",		Subject:  "users:peter",		Context: ladon.Context{			"remoteIP": "192.168.0.5",		},	}	// Authorize the request	fmt.Println("Authorize request...")	ret, err := clientset.Iam().AuthzV1().Authz().Authorize(context.TODO(), request, metav1.AuthorizeOptions{})	if err != nil {		panic(err.Error())	}	fmt.Printf("Authorize response: %s.n", ret.ToString())}
```

åœ¨ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼ŒåŒ…å«äº†ä¸‹é¢çš„æ“ä½œã€‚

+ é¦–å…ˆï¼Œè°ƒç”¨ `BuildConfigFromFlags` å‡½æ•°ï¼Œåˆ›å»ºå‡ºSDKçš„é…ç½®å®ä¾‹configï¼›
+ æ¥ç€ï¼Œè°ƒç”¨ `marmotedu.NewForConfig(config)` åˆ›å»ºäº†IAMé¡¹ç›®çš„å®¢æˆ·ç«¯ `clientset` ;
+ æœ€åï¼Œè°ƒç”¨ä»¥ä¸‹ä»£ç è¯·æ±‚ `/v1/authz` æ¥å£æ‰§è¡Œèµ„æºæˆæƒè¯·æ±‚ï¼š

```go
ret, err := clientset.Iam().AuthzV1().Authz().Authorize(context.TODO(), request, metav1.AuthorizeOptions{})    if err != nil {               panic(err.Error())    }    fmt.Printf("Authorize response: %s.n", ret.ToString())
```

è°ƒç”¨æ ¼å¼ä¸º`é¡¹ç›®å®¢æˆ·ç«¯.åº”ç”¨å®¢æˆ·ç«¯.æœåŠ¡å®¢æˆ·ç«¯.èµ„æºå.æ¥å£` ã€‚

æ‰€ä»¥ï¼Œä¸Šé¢çš„ä»£ç é€šè¿‡åˆ›å»ºé¡¹ç›®çº§åˆ«çš„å®¢æˆ·ç«¯ã€åº”ç”¨çº§åˆ«çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡çº§åˆ«çš„å®¢æˆ·ç«¯ï¼Œæ¥è°ƒç”¨èµ„æºçš„APIæ¥å£ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•åˆ›å»ºè¿™äº›å®¢æˆ·ç«¯ã€‚

### marmotedu-sdk-goå®¢æˆ·ç«¯è®¾è®¡

åœ¨è®²å®¢æˆ·ç«¯åˆ›å»ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®¢æˆ·ç«¯çš„è®¾è®¡æ€è·¯ã€‚

Goé¡¹ç›®çš„ç»„ç»‡æ–¹å¼æ˜¯æœ‰å±‚çº§çš„ï¼š**Project -> Application -> Service**ã€‚marmotedu-sdk-goå¾ˆå¥½åœ°ä½“ç°äº†è¿™ç§å±‚çº§å…³ç³»ï¼Œä½¿å¾—SDKçš„è°ƒç”¨æ›´åŠ æ˜“æ‡‚ã€æ˜“ç”¨ã€‚marmotedu-sdk-goçš„å±‚çº§å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![img](https://static001.geekbang.org/resource/image/3a/21/3a4721afa7fe365c0954019087d82021.jpg?wh=2248x1043)](https://static001.geekbang.org/resource/image/3a/21/3a4721afa7fe365c0954019087d82021.jpg?wh=2248x1043)

marmotedu-sdk-goå®šä¹‰äº†3ç±»æ¥å£ï¼Œåˆ†åˆ«ä»£è¡¨äº†é¡¹ç›®ã€åº”ç”¨å’ŒæœåŠ¡çº§åˆ«çš„APIæ¥å£ï¼š

```go
// é¡¹ç›®çº§åˆ«çš„æ¥å£type Interface interface {    Iam() iam.IamInterface    Tms() tms.TmsInterface}// åº”ç”¨çº§åˆ«çš„æ¥å£type IamInterface interface {    APIV1() apiv1.APIV1Interface    AuthzV1() authzv1.AuthzV1Interface}// æœåŠ¡çº§åˆ«çš„æ¥å£type APIV1Interface interface {    RESTClient() rest.Interface    SecretsGetter    UsersGetter    PoliciesGetter}// èµ„æºçº§åˆ«çš„å®¢æˆ·ç«¯type SecretsGetter interface {    Secrets() SecretInterface}// èµ„æºçš„æ¥å£å®šä¹‰type SecretInterface interface {    Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) (*v1.Secret, error)    Update(ctx context.Context, secret *v1.Secret, opts metav1.UpdateOptions) (*v1.Secret, error)    Delete(ctx context.Context, name string, opts metav1.DeleteOptions) error    DeleteCollection(ctx context.Context, opts metav1.DeleteOptions, listOpts metav1.ListOptions) error    Get(ctx context.Context, name string, opts metav1.GetOptions) (*v1.Secret, error)    List(ctx context.Context, opts metav1.ListOptions) (*v1.SecretList, error)    SecretExpansion}
```

`Interface` ä»£è¡¨äº†é¡¹ç›®çº§åˆ«çš„æ¥å£ï¼Œé‡Œé¢åŒ…å«äº† `Iam` å’Œ `Tms` ä¸¤ä¸ªåº”ç”¨ï¼› `IamInterface` ä»£è¡¨äº†åº”ç”¨çº§åˆ«çš„æ¥å£ï¼Œé‡Œé¢åŒ…å«äº†apiï¼ˆiam-apiserverï¼‰å’Œauthzï¼ˆiam-authz-serverï¼‰ä¸¤ä¸ªæœåŠ¡çº§åˆ«çš„æ¥å£ã€‚apiå’ŒauthzæœåŠ¡ä¸­ï¼ŒåˆåŒ…å«äº†å„è‡ªæœåŠ¡ä¸­RESTèµ„æºçš„CURDæ¥å£ã€‚

marmotedu-sdk-goé€šè¿‡ `XxxV1` è¿™ç§å‘½åæ–¹å¼æ¥æ”¯æŒä¸åŒç‰ˆæœ¬çš„APIæ¥å£ï¼Œå¥½å¤„æ˜¯å¯ä»¥åœ¨ç¨‹åºä¸­åŒæ—¶è°ƒç”¨åŒä¸€ä¸ªAPIæ¥å£çš„ä¸åŒç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š

`clientset.Iam().AuthzV1().Authz().Authorize()` ã€`clientset.Iam().AuthzV2().Authz().Authorize()` åˆ†åˆ«è°ƒç”¨äº† `/v1/authz` å’Œ `/v2/authz` ä¸¤ä¸ªç‰ˆæœ¬çš„APIæ¥å£ã€‚

ä¸Šè¿°å…³ç³»ä¹Ÿå¯ä»¥ä»ç›®å½•ç»“æ„ä¸­åæ˜ å‡ºæ¥ï¼Œmarmotedu-sdk-goç›®å½•è®¾è®¡å¦‚ä¸‹ï¼ˆåªåˆ—å‡ºäº†ä¸€äº›é‡è¦çš„æ–‡ä»¶ï¼‰ï¼š

```bash
â”œâ”€â”€ examples                        # å­˜æ”¾SDKçš„ä½¿ç”¨ç¤ºä¾‹â”œâ”€â”€ Makefile                        # ç®¡ç†SDKæºç ï¼Œé™æ€ä»£ç æ£€æŸ¥ã€ä»£ç æ ¼å¼åŒ–ã€æµ‹è¯•ã€æ·»åŠ ç‰ˆæƒä¿¡æ¯ç­‰â”œâ”€â”€ marmoteduâ”‚   â”œâ”€â”€ clientset.go                # clientsetå®ç°ï¼Œclientsetä¸­åŒ…å«å¤šä¸ªåº”ç”¨ï¼Œå¤šä¸ªæœåŠ¡çš„APIæ¥å£â”‚   â”œâ”€â”€ fake                        # clientsetçš„fakeå®ç°ï¼Œä¸»è¦ç”¨äºå•å…ƒæµ‹è¯•â”‚   â””â”€â”€ service                     # æŒ‰åº”ç”¨è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ”¾åº”ç”¨ä¸­å„æœåŠ¡APIæ¥å£çš„å…·ä½“å®ç°â”‚       â”œâ”€â”€ iam                     # iamåº”ç”¨çš„APIæ¥å£å®ç°ï¼ŒåŒ…å«å¤šä¸ªæœåŠ¡â”‚       â”‚   â”œâ”€â”€ apiserver           # iamåº”ç”¨ä¸­ï¼ŒapiserveræœåŠ¡çš„APIæ¥å£ï¼ŒåŒ…å«å¤šä¸ªç‰ˆæœ¬â”‚       â”‚   â”‚   â””â”€â”€ v1              # apiserver v1ç‰ˆæœ¬APIæ¥å£â”‚       â”‚   â”œâ”€â”€ authz               # iamåº”ç”¨ä¸­ï¼ŒauthzæœåŠ¡çš„APIæ¥å£â”‚       â”‚   â”‚   â””â”€â”€ v1              # authzæœåŠ¡v1ç‰ˆæœ¬æ¥å£â”‚       â”‚   â””â”€â”€ iam_client.go       # iamåº”ç”¨çš„å®¢æˆ·ç«¯ï¼ŒåŒ…å«äº†apiserverå’Œauthz 2ä¸ªæœåŠ¡çš„å®¢æˆ·ç«¯â”‚       â””â”€â”€ tms                     # tmsåº”ç”¨çš„APIæ¥å£å®ç°â”œâ”€â”€ pkg                             # å­˜æ”¾ä¸€äº›å…±äº«åŒ…ï¼Œå¯å¯¹å¤–æš´éœ²â”œâ”€â”€ rest                            # HTTPè¯·æ±‚çš„åº•å±‚å®ç°â”œâ”€â”€ third_party                     # å­˜æ”¾ä¿®æ”¹è¿‡çš„ç¬¬ä¸‰æ–¹åŒ…ï¼Œä¾‹å¦‚ï¼šgorequestâ””â”€â”€ tools    â””â”€â”€ clientcmd                   # ä¸€äº›å‡½æ•°ç”¨æ¥å¸®åŠ©åˆ›å»ºrest.Configé…ç½®
```

æ¯ç§ç±»å‹çš„å®¢æˆ·ç«¯ï¼Œéƒ½å¯ä»¥é€šè¿‡ä»¥ä¸‹ç›¸ä¼¼çš„æ–¹å¼æ¥åˆ›å»ºï¼š

```go
config, err := clientcmd.BuildConfigFromFlags("", "/root/.iam/config")clientset, err := xxxx.NewForConfig(config)
```

`/root/.iam/config` ä¸ºé…ç½®æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«äº†æœåŠ¡çš„åœ°å€å’Œè®¤è¯ä¿¡æ¯ã€‚`BuildConfigFromFlags` å‡½æ•°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºå¹¶è¿”å› `rest.Config` ç±»å‹çš„é…ç½®å˜é‡ï¼Œå¹¶é€šè¿‡ `xxxx.NewForConfig` å‡½æ•°åˆ›å»ºéœ€è¦çš„å®¢æˆ·ç«¯ã€‚`xxxx` æ˜¯æ‰€åœ¨å±‚çº§çš„clientåŒ…ï¼Œä¾‹å¦‚ iamã€tmsã€‚

marmotedu-sdk-goå®¢æˆ·ç«¯å®šä¹‰äº†3ç±»æ¥å£ï¼Œè¿™å¯ä»¥å¸¦æ¥ä¸¤ä¸ªå¥½å¤„ã€‚

ç¬¬ä¸€ï¼ŒAPIæ¥å£è°ƒç”¨æ ¼å¼è§„èŒƒï¼Œå±‚æ¬¡æ¸…æ™°ï¼Œå¯ä»¥ä½¿APIæ¥å£è°ƒç”¨æ›´åŠ æ¸…æ™°æ˜“è®°ã€‚

ç¬¬äºŒï¼Œå¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªè¡Œé€‰æ‹©å®¢æˆ·ç«¯ç±»å‹ï¼Œè°ƒç”¨çµæ´»ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨AæœåŠ¡ä¸­éœ€è¦åŒæ—¶ç”¨åˆ°iam-apiserver å’Œ iam-authz-serveræä¾›çš„æ¥å£ï¼Œå°±å¯ä»¥åˆ›å»ºåº”ç”¨çº§åˆ«çš„å®¢æˆ·ç«¯IamClientï¼Œç„¶åé€šè¿‡ `iamclient.APIV1()` å’Œ `iamclient.AuthzV1()` ï¼Œæ¥åˆ‡æ¢è°ƒç”¨ä¸åŒæœåŠ¡çš„APIæ¥å£ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åˆ›å»ºä¸‰ä¸ªä¸åŒçº§åˆ«çš„å®¢æˆ·ç«¯ã€‚

### é¡¹ç›®çº§åˆ«å®¢æˆ·ç«¯åˆ›å»º

`Interface` å¯¹åº”çš„å®¢æˆ·ç«¯å®ç°ä¸º[Clientset](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/marmotedu/clientset.go#L20-L23)ï¼Œæ‰€åœ¨çš„åŒ…ä¸º [marmotedu-sdk-go/marmotedu](https://github.com/marmotedu/marmotedu-sdk-go/tree/v1.0.2/marmotedu)ï¼ŒClientsetå®¢æˆ·ç«¯çš„åˆ›å»ºæ–¹å¼ä¸ºï¼š

```go
config, err := clientcmd.BuildConfigFromFlags("", "/root/.iam/config")clientset, err := marmotedu.NewForConfig(config)
```

è°ƒç”¨æ–¹å¼ä¸º `clientset.åº”ç”¨.æœåŠ¡.èµ„æºå.æ¥å£` ï¼Œä¾‹å¦‚ï¼š

```go
rsp, err := clientset.Iam().AuthzV1().Authz().Authorize()
```

å‚è€ƒç¤ºä¾‹ä¸º [marmotedu-sdk-go/examples/authz_clientset/main.go](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/examples/authz_clientset/main.go)ã€‚

### åº”ç”¨çº§åˆ«å®¢æˆ·ç«¯åˆ›å»º

`IamInterface` å¯¹åº”çš„å®¢æˆ·ç«¯å®ç°ä¸º[IamClient](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/marmotedu/service/iam/iam_client.go#L22-L25)ï¼Œæ‰€åœ¨çš„åŒ…ä¸º [marmotedu-sdk-go/marmotedu/service/iam](https://github.com/marmotedu/marmotedu-sdk-go/tree/v1.0.2/marmotedu/service/iam)ï¼ŒIamClientå®¢æˆ·ç«¯çš„åˆ›å»ºæ–¹å¼ä¸ºï¼š

```go
config, err := clientcmd.BuildConfigFromFlags("", "/root/.iam/config")iamclient,, err := iam.NewForConfig(config)
```

è°ƒç”¨æ–¹å¼ä¸º `iamclient.æœåŠ¡.èµ„æºå.æ¥å£` ï¼Œä¾‹å¦‚ï¼š

```go
rsp, err := iamclient.AuthzV1().Authz().Authorize()
```

å‚è€ƒç¤ºä¾‹ä¸º [marmotedu-sdk-go/examples/authz_iam/main.go](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/examples/authz_iam/main.go)ã€‚

### æœåŠ¡çº§åˆ«å®¢æˆ·ç«¯åˆ›å»º

`AuthzV1Interface` å¯¹åº”çš„å®¢æˆ·ç«¯å®ç°ä¸º[AuthzV1Client](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/marmotedu/service/iam/authz/v1/authz_client.go#L21-L23)ï¼Œæ‰€åœ¨çš„åŒ…ä¸º [marmotedu-sdk-go/marmotedu/service/iam/authz/v1](https://github.com/marmotedu/marmotedu-sdk-go/tree/v1.0.2/marmotedu/service/iam/authz/v1)ï¼ŒAuthzV1Clientå®¢æˆ·ç«¯çš„åˆ›å»ºæ–¹å¼ä¸ºï¼š

```go
config, err := clientcmd.BuildConfigFromFlags("", "/root/.iam/config")client, err := v1.NewForConfig(config)
```

è°ƒç”¨æ–¹å¼ä¸º `client.èµ„æºå.æ¥å£` ï¼Œä¾‹å¦‚ï¼š

```go
rsp, err := client.Authz().Authorize()
```

å‚è€ƒç¤ºä¾‹ä¸º [marmotedu-sdk-go/examples/authz/main.go](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/examples/authz/main.go)ã€‚

ä¸Šé¢æˆ‘ä»‹ç»äº†marmotedu-sdk-goçš„å®¢æˆ·ç«¯åˆ›å»ºæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼Œè¿™äº›å®¢æˆ·ç«¯å…·ä½“æ˜¯å¦‚ä½•æ‰§è¡ŒREST APIè¯·æ±‚çš„ã€‚

## marmotedu-sdk-goçš„å®ç°

marmotedu-sdk-goçš„å®ç°å’Œmedu-sdk-goä¸€æ ·ï¼Œä¹Ÿæ˜¯é‡‡ç”¨åˆ†å±‚ç»“æ„ï¼Œåˆ†ä¸ºAPIå±‚å’ŒåŸºç¡€å±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![img](https://static001.geekbang.org/resource/image/c4/b2/c40439c97998a01758923394116c33b2.jpg?wh=2248x2097)](https://static001.geekbang.org/resource/image/c4/b2/c40439c97998a01758923394116c33b2.jpg?wh=2248x2097)

[RESTClient](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/client.go#L95-L105)æ˜¯æ•´ä¸ªSDKçš„æ ¸å¿ƒï¼ŒRESTClientå‘ä¸‹é€šè¿‡è°ƒç”¨[Request](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/request.go#L28-L50)æ¨¡å—ï¼Œæ¥å®ŒæˆHTTPè¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„ã€è¯·æ±‚ä½“ã€è®¤è¯ä¿¡æ¯çš„æ„å»ºã€‚Requestæ¨¡å—æœ€ç»ˆé€šè¿‡è°ƒç”¨[gorequest](https://github.com/parnurzeal/gorequest)åŒ…æä¾›çš„æ–¹æ³•ï¼Œå®ŒæˆHTTPçš„POSTã€PUTã€GETã€DELETEç­‰è¯·æ±‚ï¼Œè·å–HTTPè¿”å›ç»“æœï¼Œå¹¶è§£æåˆ°æŒ‡å®šçš„ç»“æ„ä½“ä¸­ã€‚RESTClientå‘ä¸Šæä¾› `Post()` ã€ `Put()` ã€ `Get()` ã€ `Delete()` ç­‰æ–¹æ³•æ¥ä¾›å®¢æˆ·ç«¯å®ŒæˆHTTPè¯·æ±‚ã€‚

marmotedu-sdk-goæä¾›äº†ä¸¤ç±»å®¢æˆ·ç«¯ï¼Œåˆ†åˆ«æ˜¯RESTClientå®¢æˆ·ç«¯å’ŒåŸºäºRESTClientå°è£…çš„å®¢æˆ·ç«¯ã€‚

+ RESTClientï¼šRawç±»å‹çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šHTTPçš„è¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„ã€è¯·æ±‚å‚æ•°ç­‰ä¿¡æ¯ï¼Œç›´æ¥å‘é€HTTPè¯·æ±‚ï¼Œä¾‹å¦‚ `client.Get().AbsPath("/version").Do().Into()` ã€‚
+ åŸºäºRESTClientå°è£…çš„å®¢æˆ·ç«¯ï¼šä¾‹å¦‚AuthzV1Clientã€APIV1Clientç­‰ï¼Œæ‰§è¡Œç‰¹å®šRESTèµ„æºã€ç‰¹å®šAPIæ¥å£çš„è¯·æ±‚ï¼Œæ–¹ä¾¿å¼€å‘è€…è°ƒç”¨ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸‹å¦‚ä½•åˆ›å»ºRESTClientå®¢æˆ·ç«¯ï¼Œä»¥åŠRequestæ¨¡å—çš„å®ç°ã€‚

### RESTClientå®¢æˆ·ç«¯å®ç°

æˆ‘é€šè¿‡ä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼Œå®ç°äº†RESTClientå®¢æˆ·ç«¯ã€‚

**ç¬¬ä¸€æ­¥ï¼Œåˆ›å»º**[rest.Config](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/config.go#L29-L60)**ç±»å‹çš„å˜é‡ã€‚**

[BuildConfigFromFlags](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/tools/clientcmd/client_config.go#L190-L203)å‡½æ•°é€šè¿‡åŠ è½½yamlæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œæ¥åˆ›å»º `rest.Config` ç±»å‹çš„å˜é‡ï¼ŒåŠ è½½çš„yamlæ ¼å¼é…ç½®æ–‡ä»¶å†…å®¹ä¸ºï¼š

```yaml
apiVersion: v1user:  #token: # JWT Token  username: admin # iam ç”¨æˆ·å  password: Admin@2020 # iam å¯†ç   #secret-id: # å¯†é’¥ ID  #secret-key: # å¯†é’¥ Key  client-certificate: /home/colin/.iam/cert/admin.pem # ç”¨äº TLS çš„å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶è·¯å¾„  client-key: /home/colin/.iam/cert/admin-key.pem # ç”¨äº TLS çš„å®¢æˆ·ç«¯ key æ–‡ä»¶è·¯å¾„  #client-certificate-data:  #client-key-data:server:  address: https://127.0.0.1:8443 # iam api-server åœ°å€  timeout: 10s # è¯·æ±‚ api-server è¶…æ—¶æ—¶é—´  #max-retries: # æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 0  #retry-interval: # é‡è¯•é—´éš”ï¼Œé»˜è®¤ä¸º 1s  #tls-server-name: # TLS æœåŠ¡å™¨åç§°  #insecure-skip-tls-verify: # è®¾ç½®ä¸º true è¡¨ç¤ºè·³è¿‡ TLS å®‰å…¨éªŒè¯æ¨¡å¼ï¼Œå°†ä½¿å¾— HTTPS è¿æ¥ä¸å®‰å…¨  certificate-authority: /home/colin/.iam/cert/ca.pem # ç”¨äº CA æˆæƒçš„ cert æ–‡ä»¶è·¯å¾„  #certificate-authority-data:
```

åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šæœåŠ¡çš„åœ°å€ã€ç”¨æˆ·å/å¯†ç ã€å¯†é’¥ã€TLSè¯ä¹¦ã€è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰ä¿¡æ¯ã€‚

åˆ›å»ºæ–¹æ³•å¦‚ä¸‹ï¼š

```go
config, err := clientcmd.BuildConfigFromFlags("", *iamconfig)    if err != nil {                                                      panic(err.Error())    }  
```

è¿™é‡Œçš„ä»£ç ä¸­ï¼Œ`*iamconfig` æ˜¯yamlæ ¼å¼çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚`BuildConfigFromFlags` å‡½æ•°ä¸­ï¼Œè°ƒç”¨[LoadFromFile](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/tools/clientcmd/loader.go#L32-L56)å‡½æ•°æ¥è§£æyamlé…ç½®æ–‡ä»¶ã€‚LoadFromFileæœ€ç»ˆæ˜¯é€šè¿‡ `yaml.Unmarshal` çš„æ–¹å¼æ¥è§£æyamlæ ¼å¼çš„é…ç½®æ–‡ä»¶çš„ã€‚

**ç¬¬äºŒæ­¥ï¼Œæ ¹æ®rest.Configç±»å‹çš„å˜é‡ï¼Œåˆ›å»ºRESTClientå®¢æˆ·ç«¯ã€‚**

é€šè¿‡[RESTClientFor](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/config.go#L191-L237)å‡½æ•°æ¥åˆ›å»ºRESTClientå®¢æˆ·ç«¯ï¼š

```go
func RESTClientFor(config *Config) (*RESTClient, error) {    ...    baseURL, versionedAPIPath, err := defaultServerURLFor(config)    if err != nil {        return nil, err    }    // Get the TLS options for this client config    tlsConfig, err := TLSConfigFor(config)    if err != nil {        return nil, err    }    // Only retry when get a server side error.    client := gorequest.New().TLSClientConfig(tlsConfig).Timeout(config.Timeout).        Retry(config.MaxRetries, config.RetryInterval, http.StatusInternalServerError)    // NOTICE: must set DoNotClearSuperAgent to true, or the client will clean header befor http.Do    client.DoNotClearSuperAgent = true    ...    clientContent := ClientContentConfig{        Username:           config.Username,        Password:           config.Password,        SecretID:           config.SecretID,        SecretKey:          config.SecretKey,        ...    }    return NewRESTClient(baseURL, versionedAPIPath, clientContent, client)}
```

RESTClientForå‡½æ•°è°ƒç”¨[defaultServerURLFor(config)](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/url_utils.go#L69-L81)ç”ŸæˆåŸºæœ¬çš„HTTPè¯·æ±‚è·¯å¾„ï¼šbaseURL=http://127.0.0.1:8080ï¼ŒversionedAPIPath=/v1ã€‚ç„¶åï¼Œé€šè¿‡[TLSConfigFor](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/config.go#L241-L298)å‡½æ•°ç”ŸæˆTLSé…ç½®ï¼Œå¹¶è°ƒç”¨ `gorequest.New()` åˆ›å»ºgorequestå®¢æˆ·ç«¯ï¼Œå°†å®¢æˆ·ç«¯é…ç½®ä¿¡æ¯ä¿å­˜åœ¨å˜é‡ä¸­ã€‚æœ€åï¼Œè°ƒç”¨[NewRESTClient](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/client.go#L109-L130)å‡½æ•°åˆ›å»ºRESTClientå®¢æˆ·ç«¯ã€‚

RESTClientå®¢æˆ·ç«¯æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼Œæ¥ä¾›è°ƒç”¨è€…å®ŒæˆHTTPè¯·æ±‚ï¼š

```go
func (c *RESTClient) APIVersion() scheme.GroupVersionfunc (c *RESTClient) Delete() *Requestfunc (c *RESTClient) Get() *Requestfunc (c *RESTClient) Post() *Requestfunc (c *RESTClient) Put() *Requestfunc (c *RESTClient) Verb(verb string) *Request
```

å¯ä»¥çœ‹åˆ°ï¼ŒRESTClientæä¾›äº† `Delete` ã€ `Get` ã€ `Post` ã€ `Put` æ–¹æ³•ï¼Œåˆ†åˆ«ç”¨æ¥æ‰§è¡ŒHTTPçš„DELETEã€GETã€POSTã€PUTæ–¹æ³•ï¼Œæä¾›çš„ `Verb` æ–¹æ³•å¯ä»¥çµæ´»åœ°æŒ‡å®šHTTPæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•éƒ½è¿”å›äº† `Request` ç±»å‹çš„å˜é‡ã€‚`Request` ç±»å‹çš„å˜é‡æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œç”¨æ¥å®Œæˆå…·ä½“çš„HTTPè¯·æ±‚ï¼Œä¾‹å¦‚ï¼š

```go
  type Response struct {    Allowed bool   json:"allowed"    Denied  bool   json:"denied,omitempty"    Reason  string json:"reason,omitempty"    Error   string json:"error,omitempty"}func (c *authz) Authorize(ctx context.Context, request *ladon.Request, opts metav1.AuthorizeOptions) (result *Response, err error) {    result = &Response{}                                             err = c.client.Post().        Resource("authz").        VersionedParams(opts).        Body(request).        Do(ctx).        Into(result)    return}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ `c.client` æ˜¯RESTClientå®¢æˆ·ç«¯ï¼Œé€šè¿‡è°ƒç”¨RESTClientå®¢æˆ·ç«¯çš„ `Post` æ–¹æ³•ï¼Œè¿”å›äº† `*Request` ç±»å‹çš„å˜é‡ã€‚

`*Request` ç±»å‹çš„å˜é‡æä¾›äº† `Resource` å’Œ `VersionedParams` æ–¹æ³•ï¼Œæ¥æ„å»ºè¯·æ±‚HTTP URLä¸­çš„è·¯å¾„ `/v1/authz` ï¼›é€šè¿‡ `Body` æ–¹æ³•ï¼ŒæŒ‡å®šäº†HTTPè¯·æ±‚çš„Bodyã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åˆ†åˆ«æ„å»ºäº†HTTPè¯·æ±‚éœ€è¦çš„å‚æ•°ï¼šHTTP Methodã€è¯·æ±‚URLã€è¯·æ±‚Bodyã€‚æ‰€ä»¥ï¼Œä¹‹åå°±å¯ä»¥è°ƒç”¨ `Do` æ–¹æ³•æ¥æ‰§è¡ŒHTTPè¯·æ±‚ï¼Œå¹¶å°†è¿”å›ç»“æœé€šè¿‡ `Into` æ–¹æ³•ä¿å­˜åœ¨ä¼ å…¥çš„resultå˜é‡ä¸­ã€‚

### Requestæ¨¡å—å®ç°

RESTClientå®¢æˆ·ç«¯çš„æ–¹æ³•ä¼šè¿”å›Requestç±»å‹çš„å˜é‡ï¼ŒRequestç±»å‹çš„å˜é‡æä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ç”¨æ¥æ„å»ºHTTPè¯·æ±‚å‚æ•°ï¼Œå¹¶æ‰§è¡ŒHTTPè¯·æ±‚ã€‚

æ‰€ä»¥ï¼ŒRequestæ¨¡å—å¯ä»¥ç†è§£ä¸ºæœ€åº•å±‚çš„é€šä¿¡å±‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Requestæ¨¡å—å…·ä½“æ˜¯å¦‚ä½•å®ŒæˆHTTPè¯·æ±‚çš„ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹[Requestç»“æ„ä½“](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/rest/request.go#L28-L50)çš„å®šä¹‰ï¼š

```go
type RESTClient struct {               // base is the root URL for all invocations of the client        base *url.URL        // group stand for the client group, eg: iam.api, iam.authz                           group string                                                                              // versionedAPIPath is a path segment connecting the base URL to the resource root        versionedAPIPath string                                          // content describes how a RESTClient encodes and decodes responses.        content ClientContentConfig        Client  *gorequest.SuperAgent    }type Request struct {	c *RESTClient	timeout time.Duration	// generic components accessible via method setters	verb       string	pathPrefix string	subpath    string	params     url.Values	headers    http.Header	// structural elements of the request that are part of the IAM API conventions	// namespace    string	// namespaceSet bool	resource     string	resourceName string	subresource  string	// output	err  error	body interface{}}  
```

å†æ¥çœ‹ä¸‹Requestç»“æ„ä½“æä¾›çš„æ–¹æ³•ï¼š

```go
func (r *Request) AbsPath(segments ...string) *Requestfunc (r *Request) Body(obj interface{}) *Requestfunc (r *Request) Do(ctx context.Context) Resultfunc (r *Request) Name(resourceName string) *Requestfunc (r *Request) Param(paramName, s string) *Requestfunc (r *Request) Prefix(segments ...string) *Requestfunc (r *Request) RequestURI(uri string) *Requestfunc (r *Request) Resource(resource string) *Requestfunc (r *Request) SetHeader(key string, values ...string) *Requestfunc (r *Request) SubResource(subresources ...string) *Requestfunc (r *Request) Suffix(segments ...string) *Requestfunc (r *Request) Timeout(d time.Duration) *Requestfunc (r *Request) URL() *url.URLfunc (r *Request) Verb(verb string) *Requestfunc (r *Request) VersionedParams(v interface{}) *Request
```

é€šè¿‡Requestç»“æ„ä½“çš„å®šä¹‰å’Œä½¿ç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸éš¾çŒœæµ‹å‡ºï¼šRequestæ¨¡å—é€šè¿‡ `Name` ã€ `Resource` ã€ `Body` ã€ `SetHeader` ç­‰æ–¹æ³•æ¥è®¾ç½®Requestç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µã€‚è¿™äº›å­—æ®µæœ€ç»ˆç”¨æ¥æ„å»ºå‡ºä¸€ä¸ªHTTPè¯·æ±‚ï¼Œå¹¶é€šè¿‡ `Do` æ–¹æ³•æ¥æ‰§è¡ŒHTTPè¯·æ±‚ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•æ„å»ºå¹¶æ‰§è¡Œä¸€ä¸ªHTTPè¯·æ±‚å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹5æ­¥ï¼Œæ¥æ„å»ºå¹¶æ‰§è¡ŒHTTPè¯·æ±‚ï¼š

1. æ„å»ºHTTP URLï¼›
2. æ„å»ºHTTP Methodï¼›
3. æ„å»ºHTTP Bodyï¼›
4. æ‰§è¡ŒHTTPè¯·æ±‚ï¼›
5. ä¿å­˜HTTPè¿”å›ç»“æœã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å…·ä½“çœ‹ä¸‹Requestæ¨¡å—æ˜¯å¦‚ä½•æ„å»ºè¿™äº›è¯·æ±‚å‚æ•°ï¼Œå¹¶å‘é€HTTPè¯·æ±‚çš„ã€‚

**ç¬¬ä¸€æ­¥ï¼Œæ„å»ºHTTP URLã€‚**

é¦–å…ˆï¼Œé€šè¿‡[defaultServerURLFor](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/rest/url_utils.go#L69-L81)å‡½æ•°è¿”å›äº†`http://iam.api.marmotedu.com:8080` å’Œ `/v1` ï¼Œå¹¶å°†äºŒè€…åˆ†åˆ«ä¿å­˜åœ¨äº†Requestç±»å‹ç»“æ„ä½“å˜é‡ä¸­ `c` å­—æ®µçš„ `base` å­—æ®µå’Œ `versionedAPIPath` å­—æ®µä¸­ã€‚

é€šè¿‡ [Do](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/rest/request.go#L379-L416) æ–¹æ³•æ‰§è¡ŒHTTPæ—¶ï¼Œä¼šè°ƒç”¨[r.URL()](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/rest/request.go#L392)æ–¹æ³•æ¥æ„å»ºè¯·æ±‚URLã€‚ `r.URL` æ–¹æ³•ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹ä»£ç æ®µæ„å»ºäº†HTTPè¯·æ±‚URLï¼š

```go
func (r *Request) URL() *url.URL {    p := r.pathPrefix    if len(r.resource) != 0 {        p = path.Join(p, strings.ToLower(r.resource))    }    if len(r.resourceName) != 0 || len(r.subpath) != 0 || len(r.subresource) != 0 {        p = path.Join(p, r.resourceName, r.subresource, r.subpath)    }                                                                                       finalURL := &url.URL{}    if r.c.base != nil {        *finalURL = *r.c.bas    }     finalURL.Path = p    ...    }
```

`p := r.pathPrefix` å’Œ `r.c.base` ï¼Œæ˜¯é€šè¿‡ `defaultServerURLFor` è°ƒç”¨è¿”å›çš„ `v1` å’Œ `http://iam.api.marmotedu.com:8080` æ¥æ„å»ºçš„ã€‚

`resourceName` é€šè¿‡ `func (r *Request) Resource(resource string) *Request` æ¥æŒ‡å®šï¼Œä¾‹å¦‚ `authz` ã€‚

æ‰€ä»¥ï¼Œæœ€ç»ˆæˆ‘ä»¬æ„å»ºçš„è¯·æ±‚URLä¸º `http://iam.api.marmotedu.com:8080/v1/authz` ã€‚

**ç¬¬äºŒæ­¥ï¼Œæ„å»ºHTTP Methodã€‚**

HTTP Methodé€šè¿‡RESTClientæä¾›çš„ `Post` ã€`Delete` ã€`Get` ç­‰æ–¹æ³•æ¥è®¾ç½®ï¼Œä¾‹å¦‚ï¼š

```go
func (c *RESTClient) Post() *Request {                                                                                     return c.Verb("POST")                                                                                              }func (c *RESTClient) Verb(verb string) *Request {                                                                          return NewRequest(c).Verb(verb)                                                                                    }
```

`NewRequest(c).Verb(verb)` æœ€ç»ˆè®¾ç½®äº†Requestç»“æ„ä½“çš„ `verb` å­—æ®µï¼Œä¾› `Do` æ–¹æ³•ä½¿ç”¨ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œæ„å»ºHTTP Bodyã€‚**

HTTP Bodyé€šè¿‡Requestç»“æ„ä½“æä¾›çš„Bodyæ–¹æ³•æ¥æŒ‡å®šï¼š

```go
func (r *Request) Body(obj interface{}) *Request {                        if v := reflect.ValueOf(obj); v.Kind() == reflect.Struct {                      r.SetHeader("Content-Type", r.c.content.ContentType)                    }                                                                                                                                                                                                                                             r.body = obj                                                                                                                                                                                                                                  return r                                                                                                           } 
```

**ç¬¬å››æ­¥ï¼Œæ‰§è¡ŒHTTPè¯·æ±‚ã€‚**

é€šè¿‡Requestç»“æ„ä½“æä¾›çš„Doæ–¹æ³•æ¥æ‰§è¡Œå…·ä½“çš„HTTPè¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (r *Request) Do(ctx context.Context) Result {	client := r.c.Client	client.Header = r.headers	if r.timeout > 0 {		var cancel context.CancelFunc		ctx, cancel = context.WithTimeout(ctx, r.timeout)		defer cancel()	}	client.WithContext(ctx)	resp, body, errs := client.CustomMethod(r.verb, r.URL().String()).Send(r.body).EndBytes()	if err := combineErr(resp, body, errs); err != nil {		return Result{			response: &resp,			err:      err,			body:     body,		}	}	decoder, err := r.c.content.Negotiator.Decoder()	if err != nil {		return Result{			response: &resp,			err:      err,			body:     body,			decoder:  decoder,		}	}	return Result{		response: &resp,		body:     body,		decoder:  decoder,	}}
```

åœ¨Doæ–¹æ³•ä¸­ï¼Œä½¿ç”¨äº†Requestç»“æ„ä½“å˜é‡ä¸­å„ä¸ªå­—æ®µçš„å€¼ï¼Œé€šè¿‡ `client.CustomMethod` æ¥æ‰§è¡ŒHTTPè¯·æ±‚ã€‚ `client` æ˜¯ `*gorequest.SuperAgent` ç±»å‹çš„å®¢æˆ·ç«¯ã€‚

**ç¬¬äº”æ­¥ï¼Œä¿å­˜HTTPè¿”å›ç»“æœã€‚**

é€šè¿‡Requestç»“æ„ä½“çš„ `Into` æ–¹æ³•æ¥ä¿å­˜HTTPè¿”å›ç»“æœï¼š

```go
func (r Result) Into(v interface{}) error {    if r.err != nil {                                                  return r.Error()    }                                                                                                                                              if r.decoder == nil {                                                                            return fmt.Errorf("serializer doesn't exist")    }                                                             if err := r.decoder.Decode(r.body, &v); err != nil {        return err                                                                        }                                                                                                                                                         return nil                                                                      }
```

`r.body` æ˜¯åœ¨Doæ–¹æ³•ä¸­ï¼Œæ‰§è¡Œå®ŒHTTPè¯·æ±‚åè®¾ç½®çš„ï¼Œå®ƒçš„å€¼ä¸ºHTTPè¯·æ±‚è¿”å›çš„Bodyã€‚

### è¯·æ±‚è®¤è¯

æ¥ä¸‹æ¥ï¼Œæˆ‘å†æ¥ä»‹ç»ä¸‹marmotedu-sdk-goå¦å¤–ä¸€ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„åŠŸèƒ½ï¼šè¯·æ±‚è®¤è¯ã€‚

marmotedu-sdk-goæ”¯æŒä¸¤ç§è®¤è¯æ–¹å¼ï¼š

+ Basicè®¤è¯ï¼šé€šè¿‡ç»™è¯·æ±‚æ·»åŠ  `Authorization: Basic xxxx` æ¥å®ç°ã€‚
+ Bearerè®¤è¯ï¼šé€šè¿‡ç»™è¯·æ±‚æ·»åŠ  `Authorization: Bearer xxxx` æ¥å®ç°ã€‚è¿™ç§æ–¹å¼åˆæ”¯æŒç›´æ¥æŒ‡å®šJWT Tokenï¼Œæˆ–è€…é€šè¿‡æŒ‡å®šå¯†é’¥å¯¹ç”±SDKè‡ªåŠ¨ç”ŸæˆJWT Tokenã€‚

Basicè®¤è¯å’ŒBearerè®¤è¯ï¼Œæˆ‘åœ¨ [25è®²](https://time.geekbang.org/column/article/398410)ä»‹ç»è¿‡ï¼Œä½ å¯ä»¥è¿”å›æŸ¥çœ‹ä¸‹ã€‚

è®¤è¯å¤´æ˜¯RESTClientå®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚æ—¶æŒ‡å®šçš„ï¼Œå…·ä½“å®ç°ä½äº[NewRequest](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/request.go#L53-L102)å‡½æ•°ä¸­ï¼š

```go
switch {    case c.content.HasTokenAuth():        r.SetHeader("Authorization", fmt.Sprintf("Bearer %s", c.content.BearerToken))    case c.content.HasKeyAuth():        tokenString := auth.Sign(c.content.SecretID, c.content.SecretKey, "marmotedu-sdk-go", c.group+".marmotedu.com")        r.SetHeader("Authorization", fmt.Sprintf("Bearer %s", tokenString))    case c.content.HasBasicAuth():        // TODO: get token and set header        r.SetHeader("Authorization", "Basic "+basicAuth(c.content.Username, c.content.Password))}
```

ä¸Šé¢çš„ä»£ç ä¼šæ ¹æ®é…ç½®ä¿¡æ¯ï¼Œè‡ªåŠ¨åˆ¤æ–­ä½¿ç”¨å“ªç§è®¤è¯æ–¹å¼ã€‚

## æ€»ç»“

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»‹ç»äº†Kubernetes client-goé£æ ¼çš„SDKå®ç°æ–¹å¼ã€‚å’Œå…¬æœ‰äº‘å‚å•†çš„SDKè®¾è®¡ç›¸æ¯”ï¼Œclient-goé£æ ¼çš„SDKè®¾è®¡æœ‰å¾ˆå¤šä¼˜ç‚¹ã€‚

marmotedu-sdk-goåœ¨è®¾è®¡æ—¶ï¼Œé€šè¿‡æ¥å£å®ç°äº†3ç±»å®¢æˆ·ç«¯ï¼Œåˆ†åˆ«æ˜¯é¡¹ç›®çº§åˆ«çš„å®¢æˆ·ç«¯ã€åº”ç”¨çº§åˆ«çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡çº§åˆ«çš„å®¢æˆ·ç«¯ã€‚å¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªè¡Œåˆ›å»ºå®¢æˆ·ç«¯ç±»å‹ã€‚

marmotedu-sdk-goé€šè¿‡[RESTClientFor](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/config.go#L191-L237)ï¼Œåˆ›å»ºäº†RESTClientç±»å‹çš„å®¢æˆ·ç«¯ï¼ŒRESTClientå‘ä¸‹é€šè¿‡è°ƒç”¨[Request](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.2/rest/request.go#L28-L50)æ¨¡å—ï¼Œæ¥å®ŒæˆHTTPè¯·æ±‚æ–¹æ³•ã€è¯·æ±‚è·¯å¾„ã€è¯·æ±‚ä½“ã€è®¤è¯ä¿¡æ¯çš„æ„å»ºã€‚Requestæ¨¡å—æœ€ç»ˆé€šè¿‡è°ƒç”¨[gorequest](https://github.com/parnurzeal/gorequest)åŒ…æä¾›çš„æ–¹æ³•ï¼Œå®ŒæˆHTTPçš„POSTã€PUTã€GETã€DELETEç­‰è¯·æ±‚ï¼Œè·å–HTTPè¿”å›ç»“æœï¼Œå¹¶è§£æåˆ°æŒ‡å®šçš„ç»“æ„ä½“ä¸­ã€‚RESTClientå‘ä¸Šæä¾› `Post()` ã€ `Put()` ã€ `Get()` ã€ `Delete()` ç­‰æ–¹æ³•ï¼Œæ¥ä¾›å®¢æˆ·ç«¯å®ŒæˆHTTPè¯·æ±‚ã€‚

## è¯¾åç»ƒä¹ 

1. é˜…è¯»[defaultServerURLFor](https://github.com/marmotedu/marmotedu-sdk-go/blob/v1.0.3/rest/url_utils.go#L69-L81)æºç ï¼Œæ€è€ƒä¸‹defaultServerURLForæ˜¯å¦‚ä½•æ„å»ºè¯·æ±‚åœ°å€ `http://iam.api.marmotedu.com:8080` å’ŒAPIç‰ˆæœ¬ `/v1` çš„ã€‚
2. ä½¿ç”¨[gorequest](https://github.com/parnurzeal/gorequest)åŒ…ï¼Œç¼–å†™ä¸€ä¸ªå¯ä»¥æ‰§è¡Œä»¥ä¸‹HTTPè¯·æ±‚çš„ç¤ºä¾‹ï¼š

```bash
curl -XPOST http://example.com/v1/user -d '{"username":"colin","address":"shenzhen"}'
```



## END é“¾æ¥
<ul><li><div><a href = '25.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '27.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

