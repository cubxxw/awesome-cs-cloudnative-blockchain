+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬14èŠ‚ Pflagã€Viperã€Cobra æ ¸å¿ƒåŠŸèƒ½ä»‹ç»

<br>
<div><a href = '13.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '15.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å¦‚ä½•æ„å»ºåº”ç”¨æ¡†æ¶

æƒ³çŸ¥é“å¦‚ä½•æ„å»ºåº”ç”¨æ¡†æ¶ï¼Œé¦–å…ˆä½ è¦æ˜ç™½ï¼Œä¸€ä¸ªåº”ç”¨æ¡†æ¶åŒ…å«å“ªäº›éƒ¨åˆ†ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œä¸€ä¸ªåº”ç”¨æ¡†æ¶éœ€è¦åŒ…å«ä»¥ä¸‹ 3 ä¸ªéƒ¨åˆ†ï¼š

+ **å‘½ä»¤è¡Œå‚æ•°è§£æ**ï¼šä¸»è¦ç”¨æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™äº›å‘½ä»¤è¡Œå‚æ•°å¯ä»¥å½±å“å‘½ä»¤çš„è¿è¡Œæ•ˆæœã€‚

+ **é…ç½®æ–‡ä»¶è§£æ**ï¼šä¸€ä¸ªå¤§å‹åº”ç”¨ï¼Œé€šå¸¸å…·æœ‰å¾ˆå¤šå‚æ•°ï¼Œä¸ºäº†ä¾¿äºç®¡ç†å’Œé…ç½®è¿™äº›å‚æ•°ï¼Œé€šå¸¸ä¼šå°†è¿™äº›å‚æ•°æ”¾åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œä¾›ç¨‹åºè¯»å–å¹¶è§£æã€‚

+ **åº”ç”¨çš„å‘½ä»¤è¡Œæ¡†æ¶**ï¼šåº”ç”¨æœ€ç»ˆæ˜¯é€šè¿‡å‘½ä»¤æ¥å¯åŠ¨çš„ã€‚è¿™é‡Œæœ‰ 3 ä¸ªéœ€æ±‚ç‚¹ï¼Œ

  + ä¸€æ˜¯å‘½ä»¤éœ€è¦å…·å¤‡ Help åŠŸèƒ½ï¼Œè¿™æ ·æ‰èƒ½å‘Šè¯‰ä½¿ç”¨è€…å¦‚ä½•å»ä½¿ç”¨ï¼›

  + äºŒæ˜¯å‘½ä»¤éœ€è¦èƒ½å¤Ÿè§£æå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®æ–‡ä»¶ï¼›

  + ä¸‰æ˜¯å‘½ä»¤éœ€è¦èƒ½å¤Ÿåˆå§‹åŒ–ä¸šåŠ¡ä»£ç ï¼Œå¹¶æœ€ç»ˆå¯åŠ¨ä¸šåŠ¡è¿›ç¨‹ã€‚

    ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„å‘½ä»¤éœ€è¦å…·å¤‡æ¡†æ¶çš„èƒ½åŠ›ï¼Œæ¥çº³ç®¡è¿™ 3 ä¸ªéƒ¨åˆ†ã€‚

è¿™ 3 ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥è‡ªå·±å¼€å‘ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©ä¸šç•Œå·²æœ‰çš„æˆç†Ÿå®ç°ã€‚è·Ÿä¹‹å‰çš„æƒ³æ³•ä¸€æ ·ï¼Œæˆ‘ä¸å»ºè®®ä½ è‡ªå·±å¼€å‘ï¼Œæ›´å»ºè®®ä½ é‡‡ç”¨ä¸šç•Œå·²æœ‰çš„æˆç†Ÿå®ç°ã€‚å‘½ä»¤è¡Œå‚æ•°å¯ä»¥é€šè¿‡ [Pflag](https://github.com/spf13/pflag) æ¥è§£æï¼Œé…ç½®æ–‡ä»¶å¯ä»¥é€šè¿‡ [Viper](https://github.com/spf13/viper) æ¥è§£æï¼Œåº”ç”¨çš„å‘½ä»¤è¡Œæ¡†æ¶åˆ™å¯ä»¥é€šè¿‡ [Cobra](https://github.com/spf13/cobra) æ¥å®ç°ã€‚è¿™ 3 ä¸ªåŒ…ç›®å‰ä¹Ÿæ˜¯æœ€å—æ¬¢è¿çš„åŒ…ï¼Œå¹¶ä¸”è¿™ 3 ä¸ªåŒ…ä¸æ˜¯å‰²è£‚çš„ï¼Œè€Œæ˜¯æœ‰è”ç³»çš„ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æœºåœ°ç»„åˆè¿™ 3 ä¸ªåŒ…ï¼Œä»è€Œå®ç°ä¸€ä¸ªéå¸¸å¼ºå¤§ã€ä¼˜ç§€çš„åº”ç”¨å‘½ä»¤è¡Œæ¡†æ¶ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹ä¸‹ï¼Œè¿™ 3 ä¸ªåŒ…åœ¨ Go é¡¹ç›®å¼€å‘ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„ã€‚



## å‘½ä»¤è¡Œå‚æ•°è§£æå·¥å…·ï¼šPflag ä½¿ç”¨ä»‹ç»

Go æœåŠ¡å¼€å‘ä¸­ï¼Œç»å¸¸éœ€è¦ç»™å¼€å‘çš„ç»„ä»¶åŠ ä¸Šå„ç§å¯åŠ¨å‚æ•°æ¥é…ç½®æœåŠ¡è¿›ç¨‹ï¼Œå½±å“æœåŠ¡çš„è¡Œä¸ºã€‚åƒ kube-apiserver å°±æœ‰å¤šè¾¾ 200 å¤šä¸ªå¯åŠ¨å‚æ•°ï¼Œè€Œä¸”è¿™äº›å‚æ•°çš„ç±»å‹å„ä¸ç›¸åŒï¼ˆä¾‹å¦‚ï¼šstringã€intã€ip ç±»å‹ç­‰ï¼‰ï¼Œä½¿ç”¨æ–¹å¼ä¹Ÿä¸ç›¸åŒï¼ˆä¾‹å¦‚ï¼šéœ€è¦æ”¯æŒ`--`é•¿é€‰é¡¹ï¼Œ`-`çŸ­é€‰é¡¹ç­‰ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤è¡Œå‚æ•°è§£æå·¥å…·ã€‚

è™½ç„¶ Go æºç ä¸­æä¾›äº†ä¸€ä¸ªæ ‡å‡†åº“ Flag åŒ…ï¼Œç”¨æ¥å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æï¼Œä½†åœ¨å¤§å‹é¡¹ç›®ä¸­åº”ç”¨æ›´å¹¿æ³›çš„æ˜¯å¦å¤–ä¸€ä¸ªåŒ…ï¼šPflagã€‚Pflag æä¾›äº†å¾ˆå¤šå¼ºå¤§çš„ç‰¹æ€§ï¼Œéå¸¸é€‚åˆç”¨æ¥æ„å»ºå¤§å‹é¡¹ç›®ï¼Œä¸€äº›è€³ç†Ÿèƒ½è¯¦çš„å¼€æºé¡¹ç›®éƒ½æ˜¯ç”¨ Pflag æ¥è¿›è¡Œå‘½ä»¤è¡Œå‚æ•°è§£æçš„ï¼Œä¾‹å¦‚ï¼šKubernetesã€Istioã€Helmã€Dockerã€Etcd ç­‰ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨ Pflagã€‚Pflag ä¸»è¦æ˜¯é€šè¿‡åˆ›å»º Flag å’Œ FlagSet æ¥ä½¿ç”¨çš„ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ Flagã€‚



### Pflag åŒ… Flag å®šä¹‰

Pflag å¯ä»¥å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°åœ¨ Pflag åŒ…ä¸­ä¼šè§£æä¸ºä¸€ä¸ª Flag ç±»å‹çš„å˜é‡ã€‚Flag æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go

type Flag struct {
    Name                string // flagé•¿é€‰é¡¹çš„åç§°
    Shorthand           string // flagçŸ­é€‰é¡¹çš„åç§°ï¼Œä¸€ä¸ªç¼©å†™çš„å­—ç¬¦
    Usage               string // flagçš„ä½¿ç”¨æ–‡æœ¬
    Value               Value  // flagçš„å€¼
    DefValue            string // flagçš„é»˜è®¤å€¼
    Changed             bool // è®°å½•flagçš„å€¼æ˜¯å¦æœ‰è¢«è®¾ç½®è¿‡
    NoOptDefVal         string // å½“flagå‡ºç°åœ¨å‘½ä»¤è¡Œï¼Œä½†æ˜¯æ²¡æœ‰æŒ‡å®šé€‰é¡¹å€¼æ—¶çš„é»˜è®¤å€¼
    Deprecated          string // è®°å½•è¯¥flagæ˜¯å¦è¢«æ”¾å¼ƒ
    Hidden              bool // å¦‚æœå€¼ä¸ºtrueï¼Œåˆ™ä»help/usageè¾“å‡ºä¿¡æ¯ä¸­éšè—è¯¥flag
    ShorthandDeprecated string // å¦‚æœflagçš„çŸ­é€‰é¡¹è¢«åºŸå¼ƒï¼Œå½“ä½¿ç”¨flagçš„çŸ­é€‰é¡¹æ—¶æ‰“å°è¯¥ä¿¡æ¯
    Annotations         map[string][]string // ç»™flagè®¾ç½®æ³¨è§£
}
```

Flag çš„å€¼æ˜¯ä¸€ä¸ª Value ç±»å‹çš„æ¥å£ï¼ŒValue å®šä¹‰å¦‚ä¸‹ï¼š

```go
type Value interface {
    String() string // å°†flagç±»å‹çš„å€¼è½¬æ¢ä¸ºstringç±»å‹çš„å€¼ï¼Œå¹¶è¿”å›stringçš„å†…å®¹
    Set(string) error // å°†stringç±»å‹çš„å€¼è½¬æ¢ä¸ºflagç±»å‹çš„å€¼ï¼Œè½¬æ¢å¤±è´¥æŠ¥é”™
    Type() string // è¿”å›flagçš„ç±»å‹ï¼Œä¾‹å¦‚ï¼šstringã€intã€ipç­‰
}
```

é€šè¿‡å°† Flag çš„å€¼æŠ½è±¡æˆä¸€ä¸ª interface æ¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰ Flag çš„ç±»å‹äº†ã€‚åªè¦å®ç°äº† Value æ¥å£çš„ç»“æ„ä½“ï¼Œå°±æ˜¯ä¸€ä¸ªæ–°ç±»å‹ã€‚



### Pflag åŒ… FlagSet å®šä¹‰

Pflag é™¤äº†æ”¯æŒå•ä¸ªçš„ Flag ä¹‹å¤–ï¼Œè¿˜æ”¯æŒ FlagSetã€‚FlagSet æ˜¯ä¸€äº›é¢„å…ˆå®šä¹‰å¥½çš„ Flag çš„é›†åˆï¼Œå‡ ä¹æ‰€æœ‰çš„ Pflag æ“ä½œï¼Œéƒ½éœ€è¦å€ŸåŠ© FlagSet æä¾›çš„æ–¹æ³•æ¥å®Œæˆã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹æ³•æ¥è·å–å¹¶ä½¿ç”¨ FlagSetï¼š

+ æ–¹æ³•ä¸€ï¼Œè°ƒç”¨ NewFlagSet åˆ›å»ºä¸€ä¸ª FlagSetã€‚
+ æ–¹æ³•äºŒï¼Œä½¿ç”¨ Pflag åŒ…å®šä¹‰çš„å…¨å±€ FlagSetï¼š`CommandLine`ã€‚å®é™…ä¸Š CommandLine ä¹Ÿæ˜¯ç”± NewFlagSet å‡½æ•°åˆ›å»ºçš„ã€‚

**å…ˆæ¥çœ‹ä¸‹ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè‡ªå®šä¹‰ FlagSetã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ FlagSet çš„ç¤ºä¾‹ï¼š**

```go
var version bool
flagSet := pflag.NewFlagSet("test", pflag.ContinueOnError)
flagSet.BoolVar(&version, "version", true, "Print version information and quit.")
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªæ–°çš„ FlagSet æ¥å®šä¹‰å‘½ä»¤åŠå…¶å­å‘½ä»¤çš„ Flagã€‚

**å†æ¥çœ‹ä¸‹ç¬¬äºŒç§æ–¹æ³•ï¼Œä½¿ç”¨å…¨å±€ FlagSetã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å…¨å±€ FlagSet çš„ç¤ºä¾‹ï¼š**

```go
import (
    "github.com/spf13/pflag"
)

pflag.BoolVarP(&version, "version", "v", true, "Print version information and quit.")
```

> `FlagSet`å¯ä»¥ä½¿ç”¨`pflag.NewFlagSet()`æ–¹æ³•æ¥åˆ›å»ºã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨`FlagSet`çš„ç®€å•ç¤ºä¾‹ï¼š
>
> ```go
> package main
> 
> import (
> 	"fmt"
> 	"github.com/spf13/pflag"
> )
> 
> func main() {
> 	fs := pflag.NewFlagSet("test", pflag.ExitOnError)
> 	fs.String("name", "", "Your name")
> 	fs.Int("age", 0, "Your age")
> 	fs.Parse([]string{"--name=Tom", "--age=20"})
> 	name, _ := fs.GetString("name")
> 	age, _ := fs.GetInt("age")
> 	fmt.Printf("Name: %s, Age: %d\n", name, age)
> }
> ```
>
> åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`pflag.NewFlagSet()`æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªåä¸º`test`çš„`FlagSet`ã€‚ç„¶åï¼Œæˆ‘ä»¬å‘è¿™ä¸ª`FlagSet`ä¸­æ·»åŠ äº†ä¸¤ä¸ª`Flag`ï¼š`name`å’Œ`age`ã€‚æœ€åï¼Œæˆ‘ä»¬é€šè¿‡`fs.Parse()`æ–¹æ³•å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æï¼Œå¹¶ä½¿ç”¨`fs.GetString()`å’Œ`fs.GetInt()`æ–¹æ³•è·å–`name`å’Œ`age`çš„å€¼ï¼Œå¹¶è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Šã€‚
>
> ```
> Name: Tom, Age: 20
> ```
>
> ä½¿ç”¨`FlagSet`å¯ä»¥æ–¹ä¾¿åœ°å°†ç›¸å…³çš„`Flag`è¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œå¹¶ä¸”é¿å…äº†åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šä¹‰è¿‡å¤šçš„`Flag`ã€‚æ­¤å¤–ï¼Œé€šè¿‡ä½¿ç”¨`FlagSet`ï¼Œè¿˜å¯ä»¥æ›´åŠ çµæ´»åœ°æ§åˆ¶ä¸åŒæ¨¡å—ä¸­çš„`Flag`ï¼Œä»¥æ»¡è¶³ä¸åŒæ¨¡å—çš„éœ€æ±‚ã€‚
>
> `Parse()`æ–¹æ³•æ˜¯`pflag`åº“ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè§£æå‘½ä»¤è¡Œå‚æ•°ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†å‘½ä»¤è¡Œå‚æ•°è§£æä¸º`Flag`çš„å€¼ï¼Œå¹¶å°†è¿™äº›å€¼ä¿å­˜åˆ°`FlagSet`ä¸­ï¼Œä»¥ä¾¿åç»­çš„ä½¿ç”¨ã€‚
>
> åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`fs.Parse()`æ–¹æ³•å¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œè§£æï¼Œè§£æçš„å‚æ•°æ˜¯`[]string{"--name=Tom", "--age=20"}`ï¼Œå³`name`çš„å€¼ä¸º`Tom`ï¼Œ`age`çš„å€¼ä¸º`20`ã€‚è§£æåï¼Œ`name`å’Œ`age`çš„å€¼è¢«ä¿å­˜åœ¨`FlagSet`ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`fs.GetString()`å’Œ`fs.GetInt()`æ–¹æ³•è·å–å®ƒä»¬çš„å€¼ï¼Œå¹¶è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Šã€‚
>
> ä½¿ç”¨`Parse()`æ–¹æ³•å¯ä»¥æ–¹ä¾¿åœ°å°†å‘½ä»¤è¡Œå‚æ•°è§£æä¸º`Flag`çš„å€¼ï¼Œå¹¶å°†è¿™äº›å€¼ä¿å­˜åœ¨`FlagSet`ä¸­ï¼Œä»¥ä¾¿åç»­çš„ä½¿ç”¨ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°åœ¨ç¨‹åºä¸­è·å–å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚



è¿™å…¶ä¸­ï¼Œ`pflag.BoolVarP` å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š

```go
func BoolVarP(p *bool, name, shorthand string, value bool, usage string) {
    flag := CommandLine.VarPF(newBoolValue(value, p), name, shorthand, usage)
    flag.NoOptDefVal = "true"
}
```

å¯ä»¥çœ‹åˆ° `pflag.BoolVarP` æœ€ç»ˆè°ƒç”¨äº† CommandLineï¼ŒCommandLine æ˜¯ä¸€ä¸ªåŒ…çº§åˆ«çš„å˜é‡ï¼Œå®šä¹‰ä¸ºï¼š

```go
// CommandLine is the default set of command-line flags, parsed from os.Args.var CommandLine = NewFlagSet(os.Args[0], ExitOnError)
```

åœ¨ä¸€äº›ä¸éœ€è¦å®šä¹‰å­å‘½ä»¤çš„å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨å…¨å±€çš„ FlagSetï¼Œæ›´åŠ ç®€å•æ–¹ä¾¿ã€‚



### Pflag ä½¿ç”¨æ–¹æ³•

ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä½¿ç”¨ Pflag åŒ…çš„ä¸¤ä¸ªæ ¸å¿ƒç»“æ„ä½“ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥è¯¦ç»†ä»‹ç»ä¸‹ Pflag çš„å¸¸è§ä½¿ç”¨æ–¹æ³•ã€‚Pflag æœ‰å¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ï¼Œæˆ‘è¿™é‡Œä»‹ç» 7 ä¸ªå¸¸è§çš„ä½¿ç”¨æ–¹æ³•ã€‚

#### æ”¯æŒå¤šç§å‘½ä»¤è¡Œå‚æ•°å®šä¹‰æ–¹å¼

**Pflag æ”¯æŒä»¥ä¸‹ 4 ç§å‘½ä»¤è¡Œå‚æ•°å®šä¹‰æ–¹å¼ï¼š**

+ æ”¯æŒé•¿é€‰é¡¹ã€é»˜è®¤å€¼å’Œä½¿ç”¨æ–‡æœ¬ï¼Œå¹¶å°†æ ‡å¿—çš„å€¼å­˜å‚¨åœ¨æŒ‡é’ˆä¸­ã€‚

```go
var name = pflag.String("name", "colin", "Input Your Name")
```

+ æ”¯æŒé•¿é€‰é¡¹ã€çŸ­é€‰é¡¹ã€é»˜è®¤å€¼å’Œä½¿ç”¨æ–‡æœ¬ï¼Œå¹¶å°†æ ‡å¿—çš„å€¼å­˜å‚¨åœ¨æŒ‡é’ˆä¸­ã€‚

```go
var name = pflag.StringP("name", "n", "colin", "Input Your Name")
```

+ æ”¯æŒé•¿é€‰é¡¹ã€é»˜è®¤å€¼å’Œä½¿ç”¨æ–‡æœ¬ï¼Œå¹¶å°†æ ‡å¿—çš„å€¼ç»‘å®šåˆ°å˜é‡ã€‚

```go
var name stringpflag.StringVar(&name, "name", "colin", "Input Your Name")
```

+ æ”¯æŒé•¿é€‰é¡¹ã€çŸ­é€‰é¡¹ã€é»˜è®¤å€¼å’Œä½¿ç”¨æ–‡æœ¬ï¼Œå¹¶å°†æ ‡å¿—çš„å€¼ç»‘å®šåˆ°å˜é‡ã€‚

```go
var name stringpflag.StringVarP(&name, "name", "n","colin", "Input Your Name")
```

**ä¸Šé¢çš„å‡½æ•°å‘½åæ˜¯æœ‰è§„åˆ™çš„ï¼š**

+ å‡½æ•°åå¸¦`Var`è¯´æ˜æ˜¯å°†æ ‡å¿—çš„å€¼ç»‘å®šåˆ°å˜é‡ï¼Œå¦åˆ™æ˜¯å°†æ ‡å¿—çš„å€¼å­˜å‚¨åœ¨æŒ‡é’ˆä¸­ã€‚
+ å‡½æ•°åå¸¦`P`è¯´æ˜æ”¯æŒçŸ­é€‰é¡¹ï¼Œå¦åˆ™ä¸æ”¯æŒçŸ­é€‰é¡¹ã€‚



#### ä½¿ç”¨`Get<Type>`è·å–å‚æ•°çš„å€¼

å¯ä»¥ä½¿ç”¨`Get<Type>`æ¥è·å–æ ‡å¿—çš„å€¼ï¼Œ`<Type>`ä»£è¡¨ Pflag æ‰€æ”¯æŒçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼šæœ‰ä¸€ä¸ª pflag.FlagSetï¼Œå¸¦æœ‰ä¸€ä¸ªåä¸º flagname çš„ int ç±»å‹çš„æ ‡å¿—ï¼Œå¯ä»¥ä½¿ç”¨`GetInt()`æ¥è·å– int å€¼ã€‚éœ€è¦æ³¨æ„ flagname å¿…é¡»å­˜åœ¨ä¸”å¿…é¡»æ˜¯ intï¼Œä¾‹å¦‚ï¼š

```go
i, err := flagset.GetInt("flagname")
```



#### è·å–éé€‰é¡¹å‚æ•°

ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
package main

import (
    "fmt"

    "github.com/spf13/pflag"
)

var (
    flagvar = pflag.Int("flagname", 1234, "help message for flagname")
)

func main() {
    pflag.Parse()

    fmt.Printf("argument number is: %v\n", pflag.NArg())
    fmt.Printf("argument list is: %v\n", pflag.Args())
    fmt.Printf("the first argument is: %v\n", pflag.Arg(0))
}
```

æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

```bash
$ go run example1.go arg1 arg2argument number is: 2argument list is: [arg1 arg2]the first argument is: arg1
```

åœ¨å®šä¹‰å®Œæ ‡å¿—ä¹‹åï¼Œå¯ä»¥è°ƒç”¨`pflag.Parse()`æ¥è§£æå®šä¹‰çš„æ ‡å¿—ã€‚è§£æåï¼Œå¯é€šè¿‡`pflag.Args()`è¿”å›æ‰€æœ‰çš„éé€‰é¡¹å‚æ•°ï¼Œé€šè¿‡`pflag.Arg(i)`è¿”å›ç¬¬ i ä¸ªéé€‰é¡¹å‚æ•°ã€‚å‚æ•°ä¸‹æ ‡ 0 åˆ° `pflag.NArg() - 1`ã€‚



#### æŒ‡å®šäº†é€‰é¡¹ä½†æ˜¯æ²¡æœ‰æŒ‡å®šé€‰é¡¹å€¼æ—¶çš„é»˜è®¤å€¼

åˆ›å»ºä¸€ä¸ª Flag åï¼Œå¯ä»¥ä¸ºè¿™ä¸ª Flag è®¾ç½®`pflag.NoOptDefVal`ã€‚å¦‚æœä¸€ä¸ª Flag å…·æœ‰ NoOptDefValï¼Œå¹¶ä¸”è¯¥ Flag åœ¨å‘½ä»¤è¡Œä¸Šæ²¡æœ‰è®¾ç½®è¿™ä¸ª Flag çš„å€¼ï¼Œåˆ™è¯¥æ ‡å¿—å°†è®¾ç½®ä¸º NoOptDefVal æŒ‡å®šçš„å€¼ã€‚ä¾‹å¦‚ï¼š

```go
var ip = pflag.IntP("flagname", "f", 1234, "help message")pflag.Lookup("flagname").NoOptDefVal = "4321"
```

ä¸Šé¢çš„ä»£ç ä¼šäº§ç”Ÿç»“æœï¼Œå…·ä½“ä½ å¯ä»¥å‚ç…§ä¸‹è¡¨ï¼š

[![img](http://sm.nsddd.top/sm202302222038386.png)](https://static001.geekbang.org/resource/image/fe/3f/fe76a52906c35b49b890225d1f5fc93f.png?wh=1428x336)



#### å¼ƒç”¨æ ‡å¿—æˆ–è€…æ ‡å¿—çš„ç®€å†™

Pflag å¯ä»¥å¼ƒç”¨æ ‡å¿—æˆ–è€…æ ‡å¿—çš„ç®€å†™ã€‚å¼ƒç”¨çš„æ ‡å¿—æˆ–æ ‡å¿—ç®€å†™åœ¨å¸®åŠ©æ–‡æœ¬ä¸­ä¼šè¢«éšè—ï¼Œå¹¶åœ¨ä½¿ç”¨ä¸æ¨èçš„æ ‡å¿—æˆ–ç®€å†™æ—¶æ‰“å°æ­£ç¡®çš„ç”¨æ³•æç¤ºã€‚ä¾‹å¦‚ï¼Œå¼ƒç”¨åä¸º logmode çš„æ ‡å¿—ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·åº”è¯¥ä½¿ç”¨å“ªä¸ªæ ‡å¿—ä»£æ›¿ï¼š

```go
// deprecate a flag by specifying its name and a usage messagepflag.CommandLine.MarkDeprecated("logmode", "please use --log-mode instead")
```

è¿™æ ·éšè—äº†å¸®åŠ©æ–‡æœ¬ä¸­çš„ logmodeï¼Œå¹¶ä¸”å½“ä½¿ç”¨ logmode æ—¶ï¼Œæ‰“å°äº†`Flag --logmode has been deprecated, please use --log-mode instead`ã€‚



#### ä¿ç•™åä¸º port çš„æ ‡å¿—ï¼Œä½†æ˜¯å¼ƒç”¨å®ƒçš„ç®€å†™å½¢å¼ã€‚

```go
pflag.IntVarP(&port, "port", "P", 3306, "MySQL service host port.")

// deprecate a flag shorthand by specifying its flag name and a usage message
pflag.CommandLine.MarkShorthandDeprecated("port", "please use --port only")
```

è¿™æ ·éšè—äº†å¸®åŠ©æ–‡æœ¬ä¸­çš„ç®€å†™ Pï¼Œå¹¶ä¸”å½“ä½¿ç”¨ç®€å†™ P æ—¶ï¼Œæ‰“å°äº†`Flag shorthand -P has been deprecated, please use --port only`ã€‚usage message åœ¨æ­¤å¤„å¿…ä¸å¯å°‘ï¼Œå¹¶ä¸”ä¸åº”ä¸ºç©ºã€‚



#### éšè—æ ‡å¿—

å¯ä»¥å°† Flag æ ‡è®°ä¸ºéšè—çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»å°†æ­£å¸¸è¿è¡Œï¼Œä½†ä¸ä¼šæ˜¾ç¤ºåœ¨ usage/help æ–‡æœ¬ä¸­ã€‚ä¾‹å¦‚ï¼šéšè—åä¸º secretFlag çš„æ ‡å¿—ï¼Œåªåœ¨å†…éƒ¨ä½¿ç”¨ï¼Œå¹¶ä¸”ä¸å¸Œæœ›å®ƒæ˜¾ç¤ºåœ¨å¸®åŠ©æ–‡æœ¬æˆ–è€…ä½¿ç”¨æ–‡æœ¬ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```go
// hide a flag by specifying its namepflag.CommandLine.MarkHidden("secretFlag")
```

è‡³æ­¤ï¼Œæˆ‘ä»¬ä»‹ç»äº† Pflag åŒ…çš„é‡è¦ç”¨æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å¦‚ä½•è§£æé…ç½®æ–‡ä»¶ã€‚



## é…ç½®è§£æç¥å™¨ï¼šViper ä½¿ç”¨ä»‹ç»

å‡ ä¹æ‰€æœ‰çš„åç«¯æœåŠ¡ï¼Œéƒ½éœ€è¦ä¸€äº›é…ç½®é¡¹æ¥é…ç½®æˆ‘ä»¬çš„æœåŠ¡ï¼Œä¸€äº›å°å‹çš„é¡¹ç›®ï¼Œé…ç½®ä¸æ˜¯å¾ˆå¤šï¼Œå¯ä»¥é€‰æ‹©åªé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥ä¼ é€’é…ç½®ã€‚ä½†æ˜¯å¤§å‹é¡¹ç›®é…ç½®å¾ˆå¤šï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ é€’å°±å˜å¾—å¾ˆéº»çƒ¦ï¼Œä¸å¥½ç»´æŠ¤ã€‚æ ‡å‡†çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†è¿™äº›é…ç½®ä¿¡æ¯ä¿å­˜åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œç”±ç¨‹åºå¯åŠ¨æ—¶åŠ è½½å’Œè§£æã€‚Go ç”Ÿæ€ä¸­æœ‰å¾ˆå¤šåŒ…å¯ä»¥åŠ è½½å¹¶è§£æé…ç½®æ–‡ä»¶ï¼Œç›®å‰æœ€å—æ¬¢è¿çš„æ˜¯ Viper åŒ…ã€‚

**Viper æ˜¯ Go åº”ç”¨ç¨‹åºç°ä»£åŒ–çš„ã€å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿå¤„ç†ä¸åŒæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬åœ¨æ„å»ºç°ä»£åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸å¿…æ‹…å¿ƒé…ç½®æ–‡ä»¶æ ¼å¼ã€‚Viper ä¹Ÿèƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¯¹åº”ç”¨é…ç½®çš„å„ç§éœ€æ±‚ã€‚**

**Viper å¯ä»¥ä»ä¸åŒçš„ä½ç½®è¯»å–é…ç½®ï¼Œä¸åŒä½ç½®çš„é…ç½®å…·æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œé«˜ä¼˜å…ˆçº§çš„é…ç½®ä¼šè¦†ç›–ä½ä¼˜å…ˆçº§ç›¸åŒçš„é…ç½®ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½æ’åˆ—å¦‚ä¸‹ï¼š**

1. é€šè¿‡ viper.Set å‡½æ•°æ˜¾ç¤ºè®¾ç½®çš„é…ç½®
2. å‘½ä»¤è¡Œå‚æ•°
3. ç¯å¢ƒå˜é‡
4. é…ç½®æ–‡ä»¶
5. Key/Value å­˜å‚¨
6. é»˜è®¤å€¼

è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒViper é…ç½®é”®ä¸åŒºåˆ†å¤§å°å†™ã€‚

Viper æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œæœ€é‡è¦çš„ä¸¤ç±»åŠŸèƒ½æ˜¯è¯»å…¥é…ç½®å’Œè¯»å–é…ç½®ï¼ŒViper æä¾›ä¸åŒçš„æ–¹å¼æ¥å®ç°è¿™ä¸¤ç±»åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†ä»‹ç»ä¸‹ Viper å¦‚ä½•è¯»å…¥é…ç½®å’Œè¯»å–é…ç½®ã€‚



### è¯»å…¥é…ç½®

**è¯»å…¥é…ç½®ï¼Œå°±æ˜¯å°†é…ç½®è¯»å…¥åˆ° Viper ä¸­ï¼Œæœ‰å¦‚ä¸‹è¯»å…¥æ–¹å¼ï¼š**

+ è®¾ç½®é»˜è®¤çš„é…ç½®æ–‡ä»¶åã€‚
+ è¯»å–é…ç½®æ–‡ä»¶ã€‚
+ ç›‘å¬å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚
+ ä» `io.Reader` è¯»å–é…ç½®ã€‚
+ ä»ç¯å¢ƒå˜é‡è¯»å–ã€‚
+ ä»å‘½ä»¤è¡Œæ ‡å¿—è¯»å–ã€‚
+ ä»è¿œç¨‹ `Key/Value` å­˜å‚¨è¯»å–ã€‚

è¿™å‡ ä¸ªæ–¹æ³•çš„å…·ä½“è¯»å…¥æ–¹å¼ï¼Œä½ å¯ä»¥çœ‹ä¸‹é¢çš„å±•ç¤ºã€‚



#### è®¾ç½®é»˜è®¤

ä¸€ä¸ªå¥½çš„é…ç½®ç³»ç»Ÿåº”è¯¥æ”¯æŒé»˜è®¤å€¼ã€‚Viper æ”¯æŒå¯¹ key è®¾ç½®é»˜è®¤å€¼ï¼Œå½“æ²¡æœ‰é€šè¿‡é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€è¿œç¨‹é…ç½®æˆ–å‘½ä»¤è¡Œæ ‡å¿—è®¾ç½® key æ—¶ï¼Œè®¾ç½®é»˜è®¤å€¼é€šå¸¸æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå¯ä»¥è®©ç¨‹åºåœ¨æ²¡æœ‰æ˜ç¡®æŒ‡å®šé…ç½®æ—¶ä¹Ÿèƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚ä¾‹å¦‚ï¼š

```go
viper.SetDefault("ContentDir", "content")
viper.SetDefault("LayoutDir", "layouts")
viper.SetDefault("Taxonomies", map[string]string{"tag": "tags", "category": "categories"})
```



#### è¯»å–é…ç½®æ–‡ä»¶

Viper å¯ä»¥è¯»å–é…ç½®æ–‡ä»¶æ¥è§£æé…ç½®ï¼Œæ”¯æŒ JSONã€TOMLã€YAMLã€YMLã€Propertiesã€Propsã€Propã€HCLã€Dotenvã€Env æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚Viper æ”¯æŒæœç´¢å¤šä¸ªè·¯å¾„ï¼Œå¹¶ä¸”é»˜è®¤ä¸é…ç½®ä»»ä½•æœç´¢è·¯å¾„ï¼Œå°†é»˜è®¤å†³ç­–ç•™ç»™åº”ç”¨ç¨‹åºã€‚

ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ Viper æœç´¢å’Œè¯»å–é…ç½®æ–‡ä»¶çš„ç¤ºä¾‹ï¼š

```go

package main

import (
  "fmt"

  "github.com/spf13/pflag"
  "github.com/spf13/viper"
)

var (
  cfg  = pflag.StringP("config", "c", "", "Configuration file.")
  help = pflag.BoolP("help", "h", false, "Show this help message.")
)

func main() {
  pflag.Parse()
  if *help {
    pflag.Usage()
    return
  }

  // ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®
  if *cfg != "" {
    viper.SetConfigFile(*cfg)   // æŒ‡å®šé…ç½®æ–‡ä»¶å
    viper.SetConfigType("yaml") // å¦‚æœé…ç½®æ–‡ä»¶åä¸­æ²¡æœ‰æ–‡ä»¶æ‰©å±•åï¼Œåˆ™éœ€è¦æŒ‡å®šé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå‘Šè¯‰viperä»¥ä½•ç§æ ¼å¼è§£ææ–‡ä»¶
  } else {
    viper.AddConfigPath(".")          // æŠŠå½“å‰ç›®å½•åŠ å…¥åˆ°é…ç½®æ–‡ä»¶çš„æœç´¢è·¯å¾„ä¸­
    viper.AddConfigPath("$HOME/.iam") // é…ç½®æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªé…ç½®æ–‡ä»¶æœç´¢è·¯å¾„
    viper.SetConfigName("config")     // é…ç½®æ–‡ä»¶åç§°ï¼ˆæ²¡æœ‰æ–‡ä»¶æ‰©å±•åï¼‰
  }

  if err := viper.ReadInConfig(); err != nil { // è¯»å–é…ç½®æ–‡ä»¶ã€‚å¦‚æœæŒ‡å®šäº†é…ç½®æ–‡ä»¶åï¼Œåˆ™ä½¿ç”¨æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼Œå¦åˆ™åœ¨æ³¨å†Œçš„æœç´¢è·¯å¾„ä¸­æœç´¢
    panic(fmt.Errorf("Fatal error config file: %s \n", err))
  }

  fmt.Printf("Used configuration file is: %s\n", viper.ConfigFileUsed())
}
```

Viper æ”¯æŒè®¾ç½®å¤šä¸ªé…ç½®æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œéœ€è¦æ³¨æ„æ·»åŠ æœç´¢è·¯å¾„çš„é¡ºåºï¼ŒViper ä¼šæ ¹æ®æ·»åŠ çš„è·¯å¾„é¡ºåºæœç´¢é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæ‰¾åˆ°åˆ™åœæ­¢æœç´¢ã€‚å¦‚æœè°ƒç”¨ SetConfigFile ç›´æ¥æŒ‡å®šäº†é…ç½®æ–‡ä»¶åï¼Œå¹¶ä¸”é…ç½®æ–‡ä»¶åæ²¡æœ‰æ–‡ä»¶æ‰©å±•åæ—¶ï¼Œéœ€è¦æ˜¾å¼æŒ‡å®šé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œä»¥ä½¿ Viper èƒ½å¤Ÿæ­£ç¡®è§£æé…ç½®æ–‡ä»¶ã€‚

å¦‚æœé€šè¿‡æœç´¢çš„æ–¹å¼æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œåˆ™éœ€è¦æ³¨æ„ï¼ŒSetConfigName è®¾ç½®çš„é…ç½®æ–‡ä»¶åæ˜¯ä¸å¸¦æ‰©å±•åçš„ï¼Œåœ¨æœç´¢æ—¶ Viper ä¼šåœ¨æ–‡ä»¶åä¹‹åè¿½åŠ æ–‡ä»¶æ‰©å±•åï¼Œå¹¶å°è¯•æœç´¢æ‰€æœ‰æ”¯æŒçš„æ‰©å±•ç±»å‹ã€‚



#### ç›‘å¬å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ã€‚

**Viper æ”¯æŒåœ¨è¿è¡Œæ—¶è®©åº”ç”¨ç¨‹åºå®æ—¶è¯»å–é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯çƒ­åŠ è½½é…ç½®ã€‚**å¯ä»¥é€šè¿‡ WatchConfig å‡½æ•°çƒ­åŠ è½½é…ç½®ã€‚åœ¨è°ƒç”¨ WatchConfig å‡½æ•°ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿å·²ç»æ·»åŠ äº†é…ç½®æ–‡ä»¶çš„æœç´¢è·¯å¾„ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥ä¸º Viper æä¾›ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä»¥ä¾¿åœ¨æ¯æ¬¡å‘ç”Ÿæ›´æ”¹æ—¶è¿è¡Œã€‚è¿™é‡Œæˆ‘ä¹Ÿç»™ä½ ä¸ªç¤ºä¾‹ï¼š

```go
viper.WatchConfig()
viper.OnConfigChange(func(e fsnotify.Event) {
   // é…ç½®æ–‡ä»¶å‘ç”Ÿå˜æ›´ä¹‹åä¼šè°ƒç”¨çš„å›è°ƒå‡½æ•°
  fmt.Println("Config file changed:", e.Name)
})
```

**ä¸å»ºè®®åœ¨å®é™…å¼€å‘ä¸­ä½¿ç”¨çƒ­åŠ è½½åŠŸèƒ½**ï¼Œå› ä¸ºå³ä½¿é…ç½®çƒ­åŠ è½½äº†ï¼Œç¨‹åºä¸­çš„ä»£ç ä¹Ÿä¸ä¸€å®šä¼šçƒ­åŠ è½½ã€‚ä¾‹å¦‚ï¼šä¿®æ”¹äº†æœåŠ¡ç›‘å¬ç«¯å£ï¼Œä½†æ˜¯æœåŠ¡æ²¡æœ‰é‡å¯ï¼Œè¿™æ—¶å€™æœåŠ¡è¿˜æ˜¯ç›‘å¬åœ¨è€çš„ç«¯å£ä¸Šï¼Œä¼šé€ æˆä¸ä¸€è‡´ã€‚



#### è®¾ç½®é…ç½®å€¼

æˆ‘ä»¬å¯ä»¥é€šè¿‡ viper.Set() å‡½æ•°æ¥æ˜¾å¼è®¾ç½®é…ç½®ï¼š

```
viper.Set("user.username", "colin")
```



#### ä½¿ç”¨ç¯å¢ƒå˜é‡

Viper è¿˜æ”¯æŒç¯å¢ƒå˜é‡ï¼Œé€šè¿‡å¦‚ä¸‹ 5 ä¸ªå‡½æ•°æ¥æ”¯æŒç¯å¢ƒå˜é‡ï¼š

+ `AutomaticEnv()`
+ `BindEnv(input â€¦string) error`
+ `SetEnvPrefix(in string)`
+ `SetEnvKeyReplacer(r *strings.Replacer)`
+ `AllowEmptyEnv(allowEmptyEnv bool)`

è¿™é‡Œè¦æ³¨æ„ï¼šViper è¯»å–ç¯å¢ƒå˜é‡æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚Viper æä¾›äº†ä¸€ç§æœºåˆ¶æ¥ç¡®ä¿ Env å˜é‡æ˜¯å”¯ä¸€çš„ã€‚é€šè¿‡ä½¿ç”¨ SetEnvPrefixï¼Œå¯ä»¥å‘Šè¯‰ Viper åœ¨è¯»å–ç¯å¢ƒå˜é‡æ—¶ä½¿ç”¨å‰ç¼€ã€‚BindEnv å’Œ AutomaticEnv éƒ½å°†ä½¿ç”¨æ­¤å‰ç¼€ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬è®¾ç½®äº† `viper.SetEnvPrefix(â€œVIPERâ€)`ï¼Œå½“ä½¿ç”¨ `viper.Get(â€œapiversionâ€)` æ—¶ï¼Œå®é™…è¯»å–çš„ç¯å¢ƒå˜é‡æ˜¯`VIPER_APIVERSION`ã€‚

BindEnv éœ€è¦ä¸€ä¸ªæˆ–ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é”®åï¼Œç¬¬äºŒä¸ªæ˜¯ç¯å¢ƒå˜é‡çš„åç§°ï¼Œç¯å¢ƒå˜é‡çš„åç§°åŒºåˆ†å¤§å°å†™ã€‚å¦‚æœæœªæä¾› Env å˜é‡åï¼Œåˆ™ Viper å°†å‡å®š Env å˜é‡åä¸ºï¼š`ç¯å¢ƒå˜é‡å‰ç¼€_é”®åå…¨å¤§å†™`ã€‚ä¾‹å¦‚ï¼šå‰ç¼€ä¸º VIPERï¼Œkey ä¸º usernameï¼Œåˆ™ Env å˜é‡åä¸º`VIPER_USERNAME`ã€‚å½“æ˜¾ç¤ºæä¾› Env å˜é‡åï¼ˆç¬¬äºŒä¸ªå‚æ•°ï¼‰æ—¶ï¼Œå®ƒä¸ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯ IDï¼ŒViper å°†æŸ¥æ‰¾ç¯å¢ƒå˜é‡ IDã€‚

åœ¨ä½¿ç”¨ Env å˜é‡æ—¶ï¼Œéœ€è¦æ³¨æ„çš„ä¸€ä»¶é‡è¦äº‹æƒ…æ˜¯ï¼šæ¯æ¬¡è®¿é—®è¯¥å€¼æ—¶éƒ½å°†è¯»å–å®ƒã€‚Viper åœ¨è°ƒç”¨ BindEnv æ—¶ä¸å›ºå®šè¯¥å€¼ã€‚

è¿˜æœ‰ä¸€ä¸ªé­”æ³•å‡½æ•° SetEnvKeyReplacerï¼ŒSetEnvKeyReplacer å…è®¸ä½ ä½¿ç”¨ strings.Replacer å¯¹è±¡æ¥é‡å†™ Env é”®ã€‚å¦‚æœä½ æƒ³åœ¨ Get() è°ƒç”¨ä¸­ä½¿ç”¨`-`æˆ–è€…`.`ï¼Œä½†å¸Œæœ›ä½ çš„ç¯å¢ƒå˜é‡ä½¿ç”¨`*`åˆ†éš”ç¬¦ï¼Œå¯ä»¥é€šè¿‡ SetEnvKeyReplacer æ¥å®ç°ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬è®¾ç½®äº†ç¯å¢ƒå˜é‡`USER_SECRET_KEY=bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb`ï¼Œä½†æˆ‘ä»¬æƒ³ç”¨`viper.Get("user.secret-key")`ï¼Œé‚£æˆ‘ä»¬å°±è°ƒç”¨å‡½æ•°ï¼š`*`

```
viper.SetEnvKeyReplacer(strings.NewReplacer(".", "
", "-", ""))
```

> ä¸Šé¢çš„ä»£ç ï¼Œåœ¨è°ƒç”¨ viper.Get() å‡½æ•°æ—¶ï¼Œä¼šç”¨_æ›¿æ¢`.`å’Œ`-`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç©ºç¯å¢ƒå˜é‡è¢«è®¤ä¸ºæ˜¯æœªè®¾ç½®çš„ï¼Œå¹¶å°†è¿”å›åˆ°ä¸‹ä¸€ä¸ªé…ç½®æºã€‚è‹¥è¦å°†ç©ºç¯å¢ƒå˜é‡è§†ä¸ºå·²è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ AllowEmptyEnv æ–¹æ³•ã€‚ä½¿ç”¨ç¯å¢ƒå˜é‡ç¤ºä¾‹å¦‚ä¸‹ï¼š

```go

// ä½¿ç”¨ç¯å¢ƒå˜é‡
os.Setenv("VIPER_USER_SECRET_ID", "QLdywI2MrmDVjSSv6e95weNRvmteRjfKAuNV")
os.Setenv("VIPER_USER_SECRET_KEY", "bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb")

viper.AutomaticEnv()                                             // è¯»å–ç¯å¢ƒå˜é‡
viper.SetEnvPrefix("VIPER")                                      // è®¾ç½®ç¯å¢ƒå˜é‡å‰ç¼€ï¼šVIPER_ï¼Œå¦‚æœæ˜¯viperï¼Œå°†è‡ªåŠ¨è½¬å˜ä¸ºå¤§å†™ã€‚
viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_", "-", "_")) // å°†viper.Get(key) keyå­—ç¬¦ä¸²ä¸­'.'å’Œ'-'æ›¿æ¢ä¸º'_'
viper.BindEnv("user.secret-key")
viper.BindEnv("user.secret-id", "USER_SECRET_ID") // ç»‘å®šç¯å¢ƒå˜é‡ååˆ°key
```



#### ä½¿ç”¨æ ‡å¿—

Viper æ”¯æŒ Pflag åŒ…ï¼Œèƒ½å¤Ÿç»‘å®š key åˆ° Flagã€‚ä¸ BindEnv ç±»ä¼¼ï¼Œåœ¨è°ƒç”¨ç»‘å®šæ–¹æ³•æ—¶ï¼Œä¸ä¼šè®¾ç½®è¯¥å€¼ï¼Œä½†åœ¨è®¿é—®å®ƒæ—¶ä¼šè®¾ç½®ã€‚å¯¹äºå•ä¸ªæ ‡å¿—ï¼Œå¯ä»¥è°ƒç”¨ BindPFlag() è¿›è¡Œç»‘å®šï¼š

```
viper.BindPFlag("token", pflag.Lookup("token")) // ç»‘å®šå•ä¸ªæ ‡å¿—
```

è¿˜å¯ä»¥ç»‘å®šä¸€ç»„ç°æœ‰çš„ pflagsï¼ˆpflag.FlagSetï¼‰ï¼š

```
viper.BindPFlags(pflag.CommandLine)             //ç»‘å®šæ ‡å¿—é›†
```



### è¯»å–é…ç½®

Viper æä¾›äº†å¦‚ä¸‹æ–¹æ³•æ¥è¯»å–é…ç½®ï¼š

+ `Get(key string) interface{}`
+ `Get<Type>(key string) <Type>`
+ `AllSettings() map[string]interface{}`
+ `IsSet(key string) : bool`

**æ¯ä¸€ä¸ª Get æ–¹æ³•åœ¨æ‰¾ä¸åˆ°å€¼çš„æ—¶å€™éƒ½ä¼šè¿”å›é›¶å€¼ã€‚**ä¸ºäº†æ£€æŸ¥ç»™å®šçš„é”®æ˜¯å¦å­˜åœ¨ï¼Œå¯ä»¥ä½¿ç”¨ `IsSet()` æ–¹æ³•ã€‚`<Type>`å¯ä»¥æ˜¯ Viper æ”¯æŒçš„ç±»å‹ï¼Œé¦–å­—æ¯å¤§å†™ï¼šBoolã€Float64ã€Intã€IntSliceã€Stringã€StringMapã€StringMapStringã€StringSliceã€Timeã€Durationã€‚ä¾‹å¦‚ï¼šGetInt()ã€‚

å¸¸è§çš„è¯»å–é…ç½®æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ã€‚



#### è®¿é—®åµŒå¥—çš„é”®

ä¾‹å¦‚ï¼ŒåŠ è½½ä¸‹é¢çš„ JSON æ–‡ä»¶ï¼š

```json

{
    "host": {
        "address": "localhost",
        "port": 5799
    },
    "datastore": {
        "metric": {
            "host": "127.0.0.1",
            "port": 3099
        },
        "warehouse": {
            "host": "198.0.0.1",
            "port": 2112
        }
    }
}
```

Viper å¯ä»¥é€šè¿‡ä¼ å…¥`.`åˆ†éš”çš„è·¯å¾„æ¥è®¿é—®åµŒå¥—å­—æ®µï¼š

```
viper.GetString("datastore.metric.host") // (è¿”å› "127.0.0.1")
```

å¦‚æœ`datastore.metric`è¢«ç›´æ¥èµ‹å€¼è¦†ç›–ï¼ˆè¢« Flagã€ç¯å¢ƒå˜é‡ã€set() æ–¹æ³•ç­‰ç­‰ï¼‰ï¼Œé‚£ä¹ˆ`datastore.metric`çš„æ‰€æœ‰å­é”®éƒ½å°†å˜ä¸ºæœªå®šä¹‰çŠ¶æ€ï¼Œå®ƒä»¬è¢«é«˜ä¼˜å…ˆçº§é…ç½®çº§åˆ«è¦†ç›–äº†ã€‚

**å¦‚æœå­˜åœ¨ä¸åˆ†éš”çš„é”®è·¯å¾„åŒ¹é…çš„é”®ï¼Œåˆ™ç›´æ¥è¿”å›å…¶å€¼ã€‚ä¾‹å¦‚ï¼š**

```json
{
    "datastore.metric.host": "0.0.0.0",
    "host": {
        "address": "localhost",
        "port": 5799
    },
    "datastore": {
        "metric": {
            "host": "127.0.0.1",
            "port": 3099
        },
        "warehouse": {
            "host": "198.0.0.1",
            "port": 2112
        }
    }
}
```

é€šè¿‡ `viper.GetString` è·å–å€¼ï¼š

```go
viper.GetString("datastore.metric.host") // è¿”å› "0.0.0.0"
```



#### ååºåˆ—åŒ–

Viper å¯ä»¥æ”¯æŒå°†æ‰€æœ‰æˆ–ç‰¹å®šçš„å€¼è§£æåˆ°ç»“æ„ä½“ã€map ç­‰ã€‚å¯ä»¥é€šè¿‡ä¸¤ä¸ªå‡½æ•°æ¥å®ç°ï¼š

+ `Unmarshal(rawVal interface{}) error`
+ `UnmarshalKey(key string, rawVal interface{}) error`

ä¸€ä¸ªç¤ºä¾‹ï¼š

```go
type config struct {
  Port int
  Name string
  PathMap string `mapstructure:"path_map"`
}

var C config

err := viper.Unmarshal(&C)
if err != nil {
  t.Fatalf("unable to decode into struct, %v", err)
}
```

å¦‚æœæƒ³è¦è§£æé‚£äº›é”®æœ¬èº«å°±åŒ…å«`.`(é»˜è®¤çš„é”®åˆ†éš”ç¬¦ï¼‰çš„é…ç½®ï¼Œåˆ™éœ€è¦ä¿®æ”¹åˆ†éš”ç¬¦ï¼š

```go

v := viper.NewWithOptions(viper.KeyDelimiter("::"))

v.SetDefault("chart::values", map[string]interface{}{
    "ingress": map[string]interface{}{
        "annotations": map[string]interface{}{
            "traefik.frontend.rule.type":                 "PathPrefix",
            "traefik.ingress.kubernetes.io/ssl-redirect": "true",
        },
    },
})

type config struct {
  Chart struct{
        Values map[string]interface{}
    }
}

var C config

v.Unmarshal(&C)
```

Viper åœ¨åå°ä½¿ç”¨`github.com/mitchellh/mapstructure`æ¥è§£æå€¼ï¼Œå…¶é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨`mapstructure tags`ã€‚å½“æˆ‘ä»¬éœ€è¦å°† Viper è¯»å–çš„é…ç½®ååºåˆ—åˆ°æˆ‘ä»¬å®šä¹‰çš„ç»“æ„ä½“å˜é‡ä¸­æ—¶ï¼Œä¸€å®šè¦ä½¿ç”¨ `mapstructure tags`ã€‚



#### åºåˆ—åŒ–æˆå­—ç¬¦ä¸²

æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å°† Viper ä¸­ä¿å­˜çš„æ‰€æœ‰è®¾ç½®åºåˆ—åŒ–åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go

import (
    yaml "gopkg.in/yaml.v2"
    // ...
)

func yamlStringSettings() string {
    c := viper.AllSettings()
    bs, err := yaml.Marshal(c)
    if err != nil {
        log.Fatalf("unable to marshal config to YAML: %v", err)
    }
    return string(bs)
}
```



## ç°ä»£åŒ–çš„å‘½ä»¤è¡Œæ¡†æ¶ï¼šCobra å…¨è§£

Cobra æ—¢æ˜¯ä¸€ä¸ªå¯ä»¥åˆ›å»ºå¼ºå¤§çš„ç°ä»£ CLI åº”ç”¨ç¨‹åºçš„åº“ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯ä»¥ç”Ÿæˆåº”ç”¨å’Œå‘½ä»¤æ–‡ä»¶çš„ç¨‹åºã€‚æœ‰è®¸å¤šå¤§å‹é¡¹ç›®éƒ½æ˜¯ç”¨ Cobra æ¥æ„å»ºåº”ç”¨ç¨‹åºçš„ï¼Œä¾‹å¦‚ Kubernetesã€Dockerã€etcdã€Rktã€Hugo ç­‰ã€‚

**Cobra å»ºç«‹åœ¨ commandsã€arguments å’Œ flags ç»“æ„ä¹‹ä¸Š**ã€‚commands ä»£è¡¨å‘½ä»¤ï¼Œarguments ä»£è¡¨éé€‰é¡¹å‚æ•°ï¼Œflags ä»£è¡¨é€‰é¡¹å‚æ•°ï¼ˆä¹Ÿå«æ ‡å¿—ï¼‰ã€‚ä¸€ä¸ªå¥½çš„åº”ç”¨ç¨‹åºåº”è¯¥æ˜¯æ˜“æ‡‚çš„ï¼Œç”¨æˆ·å¯ä»¥æ¸…æ™°åœ°çŸ¥é“å¦‚ä½•å»ä½¿ç”¨è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚åº”ç”¨ç¨‹åºé€šå¸¸éµå¾ªå¦‚ä¸‹æ¨¡å¼ï¼š`APPNAME VERB NOUN --ADJECTIVE`æˆ–è€…`APPNAME COMMAND ARG --FLAG`ï¼Œä¾‹å¦‚ï¼š

```bash
git clone URL --bare 
# clone æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼ŒURLæ˜¯ä¸€ä¸ªéé€‰é¡¹å‚æ•°ï¼Œbareæ˜¯ä¸€ä¸ªé€‰é¡¹å‚æ•°
```

è¿™é‡Œï¼ŒVERB ä»£è¡¨åŠ¨è¯ï¼ŒNOUN ä»£è¡¨åè¯ï¼ŒADJECTIVE ä»£è¡¨å½¢å®¹è¯ã€‚

Cobra æä¾›äº†ä¸¤ç§æ–¹å¼æ¥åˆ›å»ºå‘½ä»¤ï¼šCobra å‘½ä»¤å’Œ Cobra åº“ã€‚Cobra å‘½ä»¤å¯ä»¥ç”Ÿæˆä¸€ä¸ª Cobra å‘½ä»¤æ¨¡æ¿ï¼Œè€Œå‘½ä»¤æ¨¡æ¿ä¹Ÿæ˜¯é€šè¿‡å¼•ç”¨ Cobra åº“æ¥æ„å»ºå‘½ä»¤çš„ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ä»‹ç»å¦‚ä½•ä½¿ç”¨ Cobra åº“æ¥åˆ›å»ºå‘½ä»¤ã€‚



### ä½¿ç”¨ Cobra åº“åˆ›å»ºå‘½ä»¤

å¦‚æœè¦ç”¨ Cobra åº“ç¼–ç å®ç°ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œéœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ªç©ºçš„ main.go æ–‡ä»¶å’Œä¸€ä¸ª rootCmd æ–‡ä»¶ï¼Œä¹‹åå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–å‘½ä»¤ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

#### åˆ›å»º rootCmd

```bash
$ mkdir -p newApp2 && cd newApp2
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°† rootCmd æ”¾åœ¨æ–‡ä»¶ cmd/root.go ä¸­ã€‚

```go
var rootCmd = &cobra.Command{
  Use:   "hugo",
  Short: "Hugo is a very fast static site generator",
  Long: `A Fast and Flexible Static Site Generator built with
                love by spf13 and friends in Go.
                Complete documentation is available at http://hugo.spf13.com`,
  Run: func(cmd *cobra.Command, args []string) {
    // Do Stuff Here
  },
}

func Execute() {
  if err := rootCmd.Execute(); err != nil {
    fmt.Println(err)
    os.Exit(1)
  }
}
```

è¿˜å¯ä»¥åœ¨ `init()` å‡½æ•°ä¸­ **å®šä¹‰æ ‡å¿—å’Œå¤„ç†é…ç½®**ï¼Œä¾‹å¦‚ `cmd/root.go`ã€‚

```go

import (
  "fmt"
  "os"

  homedir "github.com/mitchellh/go-homedir"
  "github.com/spf13/cobra"
  "github.com/spf13/viper"
)

var (
    cfgFile     string
    projectBase string
    userLicense string
)

func init() {
  cobra.OnInitialize(initConfig)
  rootCmd.PersistentFlags().StringVar(&cfgFile, "config", "", "config file (default is $HOME/.cobra.yaml)")
  rootCmd.PersistentFlags().StringVarP(&projectBase, "projectbase", "b", "", "base project directory eg. github.com/spf13/")
  rootCmd.PersistentFlags().StringP("author", "a", "YOUR NAME", "Author name for copyright attribution")
  rootCmd.PersistentFlags().StringVarP(&userLicense, "license", "l", "", "Name of license for the project (can provide `licensetext` in config)")
  rootCmd.PersistentFlags().Bool("viper", true, "Use Viper for configuration")
  viper.BindPFlag("author", rootCmd.PersistentFlags().Lookup("author"))
  viper.BindPFlag("projectbase", rootCmd.PersistentFlags().Lookup("projectbase"))
  viper.BindPFlag("useViper", rootCmd.PersistentFlags().Lookup("viper"))
  viper.SetDefault("author", "NAME HERE <EMAIL ADDRESS>")
  viper.SetDefault("license", "apache")
}

func initConfig() {
  // Don't forget to read config either from cfgFile or from home directory!
  if cfgFile != "" {
    // Use config file from the flag.
    viper.SetConfigFile(cfgFile)
  } else {
    // Find home directory.
    home, err := homedir.Dir()
    if err != nil {
      fmt.Println(err)
      os.Exit(1)
    }

    // Search config in home directory with name ".cobra" (without extension).
    viper.AddConfigPath(home)
    viper.SetConfigName(".cobra")
  }

  if err := viper.ReadInConfig(); err != nil {
    fmt.Println("Can't read config:", err)
    os.Exit(1)
  }
}
```



#### åˆ›å»º main.go

æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ª main å‡½æ•°æ¥è°ƒç”¨ rootCmdï¼Œé€šå¸¸æˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª main.go æ–‡ä»¶ï¼Œåœ¨ main.go ä¸­è°ƒç”¨ rootCmd.Execute() æ¥æ‰§è¡Œå‘½ä»¤ï¼š

```go
package main

import (
  "{pathToYourApp}/cmd"
)

func main() {
  cmd.Execute()
}
```

éœ€è¦æ³¨æ„ï¼Œmain.go ä¸­ä¸å»ºè®®æ”¾å¾ˆå¤šä»£ç ï¼Œé€šå¸¸åªéœ€è¦è°ƒç”¨ cmd.Execute() å³å¯ã€‚



#### æ·»åŠ å‘½ä»¤

é™¤äº† rootCmdï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è°ƒç”¨ AddCommand æ·»åŠ å…¶ä»–å‘½ä»¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šæŠŠå…¶ä»–å‘½ä»¤çš„æºç æ–‡ä»¶æ”¾åœ¨ cmd / ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª version å‘½ä»¤ï¼Œå¯ä»¥åˆ›å»º `cmd/version.go` æ–‡ä»¶ï¼Œå†…å®¹ä¸ºï¼š

```go
package cmd

import (
  "fmt"

  "github.com/spf13/cobra"
)

func init() {
  rootCmd.AddCommand(versionCmd)
}

var versionCmd = &cobra.Command{
  Use:   "version",
  Short: "Print the version number of Hugo",
  Long:  `All software has versions. This is Hugo's`,
  Run: func(cmd *cobra.Command, args []string) {
    fmt.Println("Hugo Static Site Generator v0.9 -- HEAD")
  },
}
```

æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨`rootCmd.AddCommand(versionCmd)`ç»™ rootCmd å‘½ä»¤æ·»åŠ äº†ä¸€ä¸ª versionCmd å‘½ä»¤ã€‚



#### ç¼–è¯‘å¹¶è¿è¡Œ

å°† main.go ä¸­`{pathToYourApp}`æ›¿æ¢ä¸ºå¯¹åº”çš„è·¯å¾„ï¼Œä¾‹å¦‚æœ¬ç¤ºä¾‹ä¸­ `pathToYourApp` ä¸º`github.com/marmotedu/gopractise-demo/cobra/newApp2`ã€‚

```bash
$ go mod init github.com/marmotedu/gopractise-demo/cobra/newApp2
$ go build -v .
$ ./newApp2 -h
A Fast and Flexible Static Site Generator built with
love by spf13 and friends in Go.
Complete documentation is available at http://hugo.spf13.com
 
Usage:
hugo [flags]
hugo [command]
 
Available Commands:
help Help about any command
version Print the version number of Hugo
 
Flags:
-a, --author string Author name for copyright attribution (default "YOUR NAME")
--config string config file (default is $HOME/.cobra.yaml)
-h, --help help for hugo
-l, --license licensetext Name of license for the project (can provide licensetext in config)
-b, --projectbase string base project directory eg. github.com/spf13/
--viper Use Viper for configuration (default true)
 
Use "hugo [command] --help" for more information about a command.
```

é€šè¿‡æ­¥éª¤ä¸€ã€æ­¥éª¤äºŒã€æ­¥éª¤ä¸‰ï¼Œæˆ‘ä»¬å°±æˆåŠŸåˆ›å»ºå’Œæ·»åŠ äº† Cobra åº”ç”¨ç¨‹åºåŠå…¶å‘½ä»¤ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å†æ¥è¯¦ç»†ä»‹ç»ä¸‹ Cobra çš„æ ¸å¿ƒç‰¹æ€§ã€‚



### ä½¿ç”¨æ ‡å¿—

Cobra å¯ä»¥è·Ÿ `Pflag` ç»“åˆä½¿ç”¨ï¼Œå®ç°å¼ºå¤§çš„æ ‡å¿—åŠŸèƒ½ã€‚ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š



#### ä½¿ç”¨æŒä¹…åŒ–çš„æ ‡å¿—ã€‚

æ ‡å¿—å¯ä»¥æ˜¯ â€œæŒä¹…çš„â€ï¼Œè¿™æ„å‘³ç€è¯¥æ ‡å¿—å¯ç”¨äºå®ƒæ‰€åˆ†é…çš„å‘½ä»¤ä»¥åŠè¯¥å‘½ä»¤ä¸‹çš„æ¯ä¸ªå­å‘½ä»¤ã€‚å¯ä»¥åœ¨ rootCmd ä¸Šå®šä¹‰æŒä¹…æ ‡å¿—ï¼š

```go
rootCmd.PersistentFlags().BoolVarP(&Verbose, "verbose", "v", false, "verbose output")
```



#### ä½¿ç”¨æœ¬åœ°æ ‡å¿—

ä¹Ÿå¯ä»¥åˆ†é…ä¸€ä¸ªæœ¬åœ°æ ‡å¿—ï¼Œæœ¬åœ°æ ‡å¿—åªèƒ½åœ¨å®ƒæ‰€ç»‘å®šçš„å‘½ä»¤ä¸Šä½¿ç”¨ï¼š

```go
rootCmd.Flags().StringVarP(&Source, "source", "s", "", "Source directory to read from")
```

`--source`æ ‡å¿—åªèƒ½åœ¨ rootCmd ä¸Šå¼•ç”¨ï¼Œè€Œä¸èƒ½åœ¨ rootCmd çš„å­å‘½ä»¤ä¸Šå¼•ç”¨ã€‚



#### å°†æ ‡å¿—ç»‘å®šåˆ° Viper

æˆ‘ä»¬å¯ä»¥å°†æ ‡å¿—ç»‘å®šåˆ° Viperï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ `viper.Get()` è·å–æ ‡å¿—çš„å€¼ã€‚

```go
var author string

func init() {
  rootCmd.PersistentFlags().StringVar(&author, "author", "YOUR NAME", "Author name for copyright attribution")
  viper.BindPFlag("author", rootCmd.PersistentFlags().Lookup("author"))
}
```



#### è®¾ç½®æ ‡å¿—ä¸ºå¿…é€‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ ‡å¿—æ˜¯å¯é€‰çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®æ ‡å¿—ä¸ºå¿…é€‰ï¼Œå½“è®¾ç½®æ ‡å¿—ä¸ºå¿…é€‰ï¼Œä½†æ˜¯æ²¡æœ‰æä¾›æ ‡å¿—æ—¶ï¼ŒCobra ä¼šæŠ¥é”™ã€‚

```go
rootCmd.Flags().StringVarP(&Region, "region", "r", "", "AWS region (required)")
rootCmd.MarkFlagRequired("region")
```



### éé€‰é¡¹å‚æ•°éªŒè¯

åœ¨å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šä¼ å…¥éé€‰é¡¹å‚æ•°ï¼Œå¹¶ä¸”éœ€è¦å¯¹è¿™äº›éé€‰é¡¹å‚æ•°è¿›è¡ŒéªŒè¯ï¼ŒCobra æä¾›äº†æœºåˆ¶æ¥å¯¹éé€‰é¡¹å‚æ•°è¿›è¡ŒéªŒè¯ã€‚å¯ä»¥ä½¿ç”¨ Command çš„ Args å­—æ®µæ¥éªŒè¯éé€‰é¡¹å‚æ•°ã€‚Cobra ä¹Ÿå†…ç½®äº†ä¸€äº›éªŒè¯å‡½æ•°ï¼š

+ NoArgsï¼šå¦‚æœå­˜åœ¨ä»»ä½•éé€‰é¡¹å‚æ•°ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ ArbitraryArgsï¼šè¯¥å‘½ä»¤å°†æ¥å—ä»»ä½•éé€‰é¡¹å‚æ•°ã€‚
+ OnlyValidArgsï¼šå¦‚æœæœ‰ä»»ä½•éé€‰é¡¹å‚æ•°ä¸åœ¨ Command çš„ ValidArgs å­—æ®µä¸­ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ MinimumNArgs(int)ï¼šå¦‚æœæ²¡æœ‰è‡³å°‘ N ä¸ªéé€‰é¡¹å‚æ•°ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ MaximumNArgs(int)ï¼šå¦‚æœæœ‰å¤šäº N ä¸ªéé€‰é¡¹å‚æ•°ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ ExactArgs(int)ï¼šå¦‚æœéé€‰é¡¹å‚æ•°ä¸ªæ•°ä¸ä¸º Nï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ ExactValidArgs(int)ï¼šå¦‚æœéé€‰é¡¹å‚æ•°çš„ä¸ªæ•°ä¸ä¸º Nï¼Œæˆ–è€…éé€‰é¡¹å‚æ•°ä¸åœ¨ Command çš„ ValidArgs å­—æ®µä¸­ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚
+ RangeArgs(min, max)ï¼šå¦‚æœéé€‰é¡¹å‚æ•°çš„ä¸ªæ•°ä¸åœ¨ min å’Œ max ä¹‹é—´ï¼Œè¯¥å‘½ä»¤å°†æŠ¥é”™ã€‚

ä½¿ç”¨é¢„å®šä¹‰éªŒè¯å‡½æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
var cmd = &cobra.Command{
  Short: "hello",
  Args: cobra.MinimumNArgs(1), // ä½¿ç”¨å†…ç½®çš„éªŒè¯å‡½æ•°
  Run: func(cmd *cobra.Command, args []string) {
    fmt.Println("Hello, World!")
  },
}
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰éªŒè¯å‡½æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
var cmd = &cobra.Command{
  Short: "hello",
  // Args: cobra.MinimumNArgs(10), // ä½¿ç”¨å†…ç½®çš„éªŒè¯å‡½æ•°
  Args: func(cmd *cobra.Command, args []string) error { // è‡ªå®šä¹‰éªŒè¯å‡½æ•°
    if len(args) < 1 {
      return errors.New("requires at least one arg")
    }
    if myapp.IsValidColor(args[0]) {
      return nil
    }
    return fmt.Errorf("invalid color specified: %s", args[0])
  },
  Run: func(cmd *cobra.Command, args []string) {
    fmt.Println("Hello, World!")
  },
}
```



## PreRun and PostRun Hooks

åœ¨è¿è¡Œ Run å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€äº›é’©å­å‡½æ•°ï¼Œæ¯”å¦‚ `PersistentPreRun` å’Œ `PreRun` å‡½æ•°åœ¨ `Run` å‡½æ•°ä¹‹å‰æ‰§è¡Œï¼Œ`PersistentPostRun` å’Œ `PostRun` åœ¨ `Run` å‡½æ•°ä¹‹åæ‰§è¡Œã€‚å¦‚æœå­å‘½ä»¤æ²¡æœ‰æŒ‡å®š`Persistent*Run`å‡½æ•°ï¼Œåˆ™å­å‘½ä»¤å°†ä¼šç»§æ‰¿çˆ¶å‘½ä»¤çš„`Persistent*Run`å‡½æ•°ã€‚è¿™äº›å‡½æ•°çš„è¿è¡Œé¡ºåºå¦‚ä¸‹ï¼š

1. PersistentPreRun
2. PreRun
3. Run
4. PostRun
5. PersistentPostRun

æ³¨æ„ï¼Œçˆ¶çº§çš„ PreRun åªä¼šåœ¨çˆ¶çº§å‘½ä»¤è¿è¡Œæ—¶è°ƒç”¨ï¼Œå­å‘½ä»¤æ˜¯ä¸ä¼šè°ƒç”¨çš„ã€‚

Cobra è¿˜æ”¯æŒå¾ˆå¤šå…¶ä»–æœ‰ç”¨çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ï¼šè‡ªå®šä¹‰ Help å‘½ä»¤ï¼›å¯ä»¥è‡ªåŠ¨æ·»åŠ `--version`æ ‡å¿—ï¼Œè¾“å‡ºç¨‹åºç‰ˆæœ¬ä¿¡æ¯ï¼›å½“ç”¨æˆ·æä¾›æ— æ•ˆæ ‡å¿—æˆ–æ— æ•ˆå‘½ä»¤æ—¶ï¼ŒCobra å¯ä»¥æ‰“å°å‡º usage ä¿¡æ¯ï¼›å½“æˆ‘ä»¬è¾“å…¥çš„å‘½ä»¤æœ‰è¯¯æ—¶ï¼ŒCobra ä¼šæ ¹æ®æ³¨å†Œçš„å‘½ä»¤ï¼Œæ¨ç®—å‡ºå¯èƒ½çš„å‘½ä»¤ï¼Œç­‰ç­‰ã€‚



## æ€»ç»“

åœ¨å¼€å‘ Go é¡¹ç›®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Pflag æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œé€šè¿‡ Viper æ¥è§£æé…ç½®æ–‡ä»¶ï¼Œç”¨ Cobra æ¥å®ç°å‘½ä»¤è¡Œæ¡†æ¶ã€‚ä½ å¯ä»¥é€šè¿‡ pflag.String()ã€ pflag.StringP()ã€pflag.StringVar()ã€pflag.StringVarP() æ–¹æ³•æ¥è®¾ç½®å‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶ä½¿ç”¨ `Get<Type>`æ¥è·å–å‚æ•°çš„å€¼ã€‚

åŒæ—¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Viper ä»å‘½ä»¤è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ç­‰ä½ç½®è¯»å–é…ç½®é¡¹ã€‚æœ€å¸¸ç”¨çš„æ˜¯ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ï¼Œå¯ä»¥é€šè¿‡ viper.AddConfigPath æ¥è®¾ç½®é…ç½®æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œé€šè¿‡ viper.SetConfigFile å’Œ viper.SetConfigType æ¥è®¾ç½®é…ç½®æ–‡ä»¶åï¼Œé€šè¿‡ viper.ReadInConfig æ¥è¯»å–é…ç½®æ–‡ä»¶ã€‚è¯»å–å®Œé…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨ç¨‹åºä¸­ä½¿ç”¨ `Get/Get<Type>`æ¥è¯»å–é…ç½®é¡¹çš„å€¼ã€‚

æœ€åï¼Œä½ å¯ä»¥ä½¿ç”¨ Cobra æ¥æ„å»ºä¸€ä¸ªå‘½ä»¤è¡Œæ¡†æ¶ï¼Œ**Cobra å¯ä»¥å¾ˆå¥½åœ°é›†æˆ Pflag å’Œ Viperã€‚**



## END é“¾æ¥
<ul><li><div><a href = '13.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '15.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

