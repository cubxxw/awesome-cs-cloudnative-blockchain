+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬30èŠ‚ æ€§èƒ½åˆ†æï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•åˆ†æ Go è¯­è¨€ä»£ç çš„æ€§èƒ½ï¼Ÿ

<br>
<div><a href = '29.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '31.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

ä½œä¸ºå¼€å‘äººå‘˜ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½å±€é™åœ¨åŠŸèƒ½ä¸Šçš„å•å…ƒæµ‹è¯•ä¸­ï¼Œå¯¹ä¸€äº›æ€§èƒ½ä¸Šçš„ç»†èŠ‚å¾€å¾€ä¸ä¼šå¤ªå…³æ³¨ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸Šçº¿çš„æ—¶å€™å¯¹é¡¹ç›®çš„æ•´ä½“æ€§èƒ½æ²¡æœ‰ä¸€ä¸ªå…¨é¢çš„äº†è§£ï¼Œéšç€è¯·æ±‚é‡è¶Šæ¥è¶Šå¤§ï¼Œå¯èƒ½ä¼šå‡ºç°å„ç§å„æ ·çš„é—®é¢˜ï¼Œæ¯”å¦‚CPUå ç”¨é«˜ã€å†…å­˜ä½¿ç”¨ç‡é«˜ã€è¯·æ±‚å»¶æ—¶é«˜ç­‰ã€‚ä¸ºäº†é¿å…è¿™äº›æ€§èƒ½ç“¶é¢ˆï¼Œæˆ‘ä»¬åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­éœ€è¦é€šè¿‡ä¸€å®šçš„æ‰‹æ®µï¼Œæ¥å¯¹ç¨‹åºè¿›è¡Œæ€§èƒ½åˆ†æã€‚

Goè¯­è¨€å·²ç»ä¸ºå¼€å‘è€…å†…ç½®äº†å¾ˆå¤šæ€§èƒ½è°ƒä¼˜ã€ç›‘æ§çš„å·¥å…·å’Œæ–¹æ³•ï¼Œè¿™å¤§å¤§æå‡äº†æˆ‘ä»¬profileåˆ†æçš„æ•ˆç‡ï¼Œå€ŸåŠ©è¿™äº›å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹Goç¨‹åºè¿›è¡Œæ€§èƒ½åˆ†æã€‚åœ¨Goè¯­è¨€å¼€å‘ä¸­ï¼Œå¼€å‘è€…åŸºæœ¬éƒ½æ˜¯é€šè¿‡å†…ç½®çš„`pprof`å·¥å…·åŒ…æ¥è¿›è¡Œæ€§èƒ½åˆ†æçš„ã€‚

åœ¨è¿›è¡Œæ€§èƒ½åˆ†ææ—¶ï¼Œæˆ‘ä»¬ä¼šå…ˆå€ŸåŠ©ä¸€äº›å·¥å…·å’ŒåŒ…ï¼Œç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡`pprof`å·¥å…·åˆ†ææ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œä»è€Œåˆ†æä»£ç çš„æ€§èƒ½ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åˆ†åˆ«æ¥çœ‹ä¸‹å¦‚ä½•æ‰§è¡Œè¿™ä¸¤æ­¥æ“ä½œã€‚

## ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶

è¦æŸ¥çœ‹æ€§èƒ½æ•°æ®ï¼Œéœ€è¦å…ˆç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶æœ‰ä¸‰ç§æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯é€šè¿‡å‘½ä»¤è¡Œã€é€šè¿‡ä»£ç å’Œé€šè¿‡`net/http/pprof`åŒ…ã€‚è¿™äº›å·¥å…·å’ŒåŒ…ä¼šåˆ†åˆ«ç”ŸæˆCPUå’Œå†…å­˜æ€§èƒ½æ•°æ®ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹è¿™ä¸‰ç§æ–¹æ³•åˆ†åˆ«æ˜¯å¦‚ä½•ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶çš„ã€‚

### é€šè¿‡å‘½ä»¤è¡Œç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`go test -cpuprofile`æ¥ç”Ÿæˆæ€§èƒ½æµ‹è¯•æ•°æ®ã€‚è¿›å…¥[internal/apiserver/service/v1](https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/service/v1)ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ go test -bench="." -cpuprofile cpu.profile -memprofile mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	     280	   4283077 ns/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	1.798s
```

*ä¸Šé¢çš„å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆ3ä¸ªæ–‡ä»¶ï¼š*

+ *v1.testï¼Œæµ‹è¯•ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿›è¡Œæ€§èƒ½åˆ†ææ—¶å¯ä»¥ç”¨æ¥è§£æå„ç§ç¬¦å·ã€‚*
+ *cpu.profileï¼ŒCPUæ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚*
+ *mem.profileï¼Œå†…å­˜æ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚*

### *é€šè¿‡ä»£ç ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶*

*æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä»£ç æ¥ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œä¾‹å¦‚[pprof.go](https://github.com/marmotedu/gopractise-demo/blob/master/pprof/pprof.go)æ–‡ä»¶ï¼š*

```
package mainimport (	"os"	"runtime/pprof")func main() {	cpuOut, _ := os.Create("cpu.out")	defer cpuOut.Close()	pprof.StartCPUProfile(cpuOut)	defer pprof.StopCPUProfile()	memOut, _ := os.Create("mem.out")	defer memOut.Close()	defer pprof.WriteHeapProfile(memOut)	Sum(3, 5)}func Sum(a, b int) int {	return a + b}
```

*è¿è¡Œ`pprof.go`æ–‡ä»¶ï¼š*

```
$ go run pprof.go
```

*è¿è¡Œ`pprof.go`æ–‡ä»¶åï¼Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ`cpu.profile`å’Œ`mem.profile`æ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚*

### *é€šè¿‡`net/http/pprof`ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶*

*å¦‚æœè¦åˆ†æHTTP Serverçš„æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`net/http/pprof`åŒ…æ¥ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚*

*IAMé¡¹ç›®ä½¿ç”¨Ginæ¡†æ¶ä½œä¸ºHTTPå¼•æ“ï¼Œæ‰€ä»¥IAMé¡¹ç›®ä½¿ç”¨äº†`github.com/gin-contrib/pprof`åŒ…æ¥å¯ç”¨HTTPæ€§èƒ½åˆ†æã€‚`github.com/gin-contrib/pprof`åŒ…æ˜¯`net/http/pprof`çš„ä¸€ä¸ªç®€å•å°è£…ï¼Œé€šè¿‡å°è£…ä½¿pprofçš„åŠŸèƒ½å˜æˆäº†ä¸€ä¸ªGinä¸­é—´ä»¶ï¼Œè¿™æ ·å¯ä»¥æ ¹æ®éœ€è¦åŠ è½½pprofä¸­é—´ä»¶ã€‚*

*`github.com/gin-contrib/pprof`åŒ…ä¸­çš„[pprof.go](https://github.com/gin-contrib/pprof/blob/v1.3.0/pprof.go)æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹ä»£ç ï¼š*

```
func Register(r *gin.Engine, prefixOptions ...string) {    prefix := getPrefix(prefixOptions...)    prefixRouter := r.Group(prefix)    {        ...        prefixRouter.GET("/profile", pprofHandler(pprof.Profile))        ...    }}func pprofHandler(h http.HandlerFunc) gin.HandlerFunc {    handler := http.HandlerFunc(h)    return func(c *gin.Context) {        handler.ServeHTTP(c.Writer, c.Request)    }}
```

*é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œä½ å¯ä»¥çœ‹åˆ°`github.com/gin-contrib/pprof`åŒ…å°†`net/http/pprof.Profile`è½¬æ¢æˆäº†`gin.HandlerFunc`ï¼Œä¹Ÿå°±æ˜¯Ginä¸­é—´ä»¶ã€‚*

*è¦å¼€å¯HTTPæ€§èƒ½åˆ†æï¼Œåªéœ€è¦åœ¨ä»£ç ä¸­æ³¨å†Œpprofæä¾›çš„HTTP Handlerå³å¯ï¼ˆä½äº[internal/pkg/server/genericapiserver.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/pkg/server/genericapiserver.go#L75-L77)æ–‡ä»¶ä¸­ï¼‰ï¼š*

```
// install pprof handlerif s.enableProfiling {    pprof.Register(s.Engine)}
```

*ä¸Šé¢çš„ä»£ç æ ¹æ®é…ç½®`--feature.profiling`æ¥åˆ¤æ–­æ˜¯å¦å¼€å¯HTTPæ€§èƒ½åˆ†æåŠŸèƒ½ã€‚æˆ‘ä»¬å¼€å¯å®ŒHTTPæ€§èƒ½åˆ†æï¼Œå¯åŠ¨HTTPæœåŠ¡iam-apiserveråï¼Œå³å¯è®¿é—®`http:// x.x.x.x:8080/debug/pprof`ï¼ˆ`x.x.x.x`æ˜¯LinuxæœåŠ¡å™¨çš„åœ°å€ï¼‰æ¥æŸ¥çœ‹profilesä¿¡æ¯ã€‚profilesä¿¡æ¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/6a/6b/6a5fc33b87b6322162c39e9209b6396b.png?wh=1520x1170)](https://static001.geekbang.org/resource/image/6a/6b/6a5fc33b87b6322162c39e9209b6396b.png?wh=1520x1170)*

*æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ¥è·å–CPUæ€§èƒ½æ•°æ®æ–‡ä»¶ï¼š*

```
$ curl http://127.0.0.1:8080/debug/pprof/profile -o cpu.profile
```

*æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤åï¼Œéœ€è¦ç­‰å¾…30sï¼Œpprofä¼šé‡‡é›†è¿™30så†…çš„æ€§èƒ½æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿™æ®µæ—¶é—´å†…å‘æœåŠ¡å™¨è¿ç»­å‘é€å¤šæ¬¡è¯·æ±‚ï¼Œè¯·æ±‚çš„é¢‘åº¦å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„åœºæ™¯æ¥å†³å®šã€‚30sä¹‹åï¼Œ`/debug/pprof/profile`æ¥å£ä¼šç”ŸæˆCPU profileæ–‡ä»¶ï¼Œè¢«curlå‘½ä»¤ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„cpu.profileæ–‡ä»¶ä¸­ã€‚*

*åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆå†…å­˜æ€§èƒ½æ•°æ®æ–‡ä»¶ï¼š*

```
$ curl http://127.0.0.1:8080/debug/pprof/heap -o mem.profile
```

*ä¸Šé¢çš„å‘½ä»¤ä¼šè‡ªåŠ¨ä¸‹è½½heapæ–‡ä»¶ï¼Œå¹¶è¢«curlå‘½ä»¤ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹çš„mem.profileæ–‡ä»¶ä¸­ã€‚*

*æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`go tool pprof [mem|cpu].profile`å‘½ä»¤æ¥åˆ†æHTTPæ¥å£çš„CPUå’Œå†…å­˜æ€§èƒ½ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤`go tool pprof http://127.0.0.1:8080/debug/pprof/profile`ï¼Œæˆ–è€…`go tool pprof http://127.0.0.1:8080/debug/pprof/heap`ï¼Œæ¥ç›´æ¥è¿›å…¥pprofå·¥å…·çš„äº¤äº’Shellä¸­ã€‚`go tool pprof`ä¼šé¦–å…ˆä¸‹è½½å¹¶ä¿å­˜CPUå’Œå†…å­˜æ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œç„¶åå†åˆ†æè¿™äº›æ–‡ä»¶ã€‚*

*é€šè¿‡ä¸Šé¢çš„ä¸‰ç§æ–¹æ³•ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†cpu.profileå’Œmem.profileï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`go tool pprof`æ¥åˆ†æè¿™ä¸¤ä¸ªæ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œè¿›è€Œåˆ†ææˆ‘ä»¬ç¨‹åºçš„CPUå’Œå†…å­˜æ€§èƒ½äº†ã€‚ä¸‹é¢ï¼Œæˆ‘æ¥å…·ä½“è®²è®²æ€§èƒ½åˆ†æçš„è¿‡ç¨‹ã€‚*

## *æ€§èƒ½åˆ†æ*

*ä½¿ç”¨`go tool pprof`ï¼Œæ¥å¯¹æ€§èƒ½è¿›è¡Œåˆ†æçš„æµç¨‹ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d4/da/d41d03c41283ea00308682a9yy0400da.jpg?wh=1920x665)](https://static001.geekbang.org/resource/image/d4/da/d41d03c41283ea00308682a9yy0400da.jpg?wh=1920x665)*

*æ¥ä¸‹æ¥ï¼Œæˆ‘å…ˆç»™ä½ ä»‹ç»ä¸‹pprofå·¥å…·ï¼Œå†ä»‹ç»ä¸‹å¦‚ä½•ç”Ÿæˆæ€§èƒ½æ•°æ®ï¼Œæœ€åå†åˆ†åˆ«ä»‹ç»ä¸‹CPUå’Œå†…å­˜æ€§èƒ½åˆ†ææ–¹æ³•ã€‚*

### *pprofå·¥å…·ä»‹ç»*

*[pprof](https://github.com/google/pprof)æ˜¯ä¸€ä¸ªGoç¨‹åºæ€§èƒ½åˆ†æå·¥å…·ï¼Œç”¨å®ƒå¯ä»¥è®¿é—®å¹¶åˆ†ææ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œå®ƒè¿˜ä¼šæ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ï¼Œæä¾›é«˜å¯è¯»æ€§çš„è¾“å‡ºä¿¡æ¯ã€‚Goåœ¨è¯­è¨€å±‚é¢ä¸Šé›†æˆäº†profileé‡‡æ ·å·¥å…·ï¼Œåªéœ€åœ¨ä»£ç ä¸­ç®€å•åœ°å¼•å…¥`runtime/pprof`æˆ–è€…`net/http/pprof`åŒ…ï¼Œå³å¯è·å–ç¨‹åºçš„profileæ–‡ä»¶ï¼Œå¹¶é€šè¿‡profileæ–‡ä»¶æ¥è¿›è¡Œæ€§èƒ½åˆ†æã€‚*

*`net/http/pprof`åŸºäº`runtime/pprof`åŒ…è¿›è¡Œå°è£…ï¼Œå¹¶åœ¨ HTTP ç«¯å£ä¸Šæš´éœ²å‡ºæ¥ã€‚*

### *ç”Ÿæˆæ€§èƒ½æ•°æ®*

*æˆ‘ä»¬åœ¨åšæ€§èƒ½åˆ†ææ—¶ï¼Œä¸»è¦æ˜¯å¯¹å†…å­˜å’ŒCPUæ€§èƒ½è¿›è¡Œåˆ†æã€‚ä¸ºäº†åˆ†æå†…å­˜å’ŒCPUçš„æ€§èƒ½ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚åœ¨ IAM æºç ä¸­ï¼Œä¹Ÿæœ‰åŒ…å«æ€§èƒ½æµ‹è¯•çš„ç”¨ä¾‹ï¼Œä¸‹é¢æˆ‘ä¼šå€ŸåŠ© IAM æºç ä¸­çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œæ¥ä»‹ç»å¦‚ä½•åˆ†æç¨‹åºçš„æ€§èƒ½ã€‚*

*è¿›å…¥[internal/apiserver/service/v1](https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/service/v1)ç›®å½•ï¼Œuser_test.goæ–‡ä»¶åŒ…å«äº†æ€§èƒ½æµ‹è¯•å‡½æ•° [BenchmarkListUser](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go#L27-L41)ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ï¼š*

```bash
$ go test -benchtime=30s -benchmem -bench="." -cpuprofile cpu.profile -memprofile mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	     175	 204523677 ns/op	   15331 B/op	     268 allocs/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	56.514s
```

ä¸Šé¢çš„å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹äº§ç”Ÿ`cpu.profile`ã€`mem.profile`æ€§èƒ½æ•°æ®æ–‡ä»¶ï¼Œä»¥åŠ`v1.test`äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åŸºäº`cpu.profile`ã€`mem.profile`ã€`v1.test`æ–‡ä»¶æ¥åˆ†æä»£ç çš„CPUå’Œå†…å­˜æ€§èƒ½ã€‚ä¸ºäº†è·å–è¶³å¤Ÿçš„é‡‡æ ·æ•°æ®ï¼Œæˆ‘ä»¬å°†benchmarkæ—¶é—´è®¾ç½®ä¸º`30s`ã€‚

åœ¨åšæ€§èƒ½åˆ†ææ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸åŒçš„æ‰‹æ®µæ¥åˆ†ææ€§èƒ½ï¼Œæ¯”å¦‚åˆ†æé‡‡æ ·å›¾ã€åˆ†æç«ç„°å›¾ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`go tool pprof`äº¤äº’æ¨¡å¼ï¼ŒæŸ¥çœ‹å‡½æ•°CPUå’Œå†…å­˜æ¶ˆè€—æ•°æ®ã€‚ä¸‹é¢æˆ‘ä¼šè¿ç”¨è¿™äº›æ–¹æ³•ï¼Œæ¥åˆ†æCPUæ€§èƒ½å’Œå†…å­˜æ€§èƒ½ã€‚

### CPUæ€§èƒ½åˆ†æ

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒGoè¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿä¼šä»¥100 Hzçš„çš„é¢‘ç‡å¯¹CPUä½¿ç”¨æƒ…å†µè¿›è¡Œé‡‡æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ç§’é‡‡æ ·100æ¬¡ï¼Œæ¯10æ¯«ç§’é‡‡æ ·ä¸€æ¬¡ã€‚æ¯æ¬¡é‡‡æ ·æ—¶ï¼Œä¼šè®°å½•æ­£åœ¨è¿è¡Œçš„å‡½æ•°ï¼Œå¹¶ç»Ÿè®¡å…¶è¿è¡Œæ—¶é—´ï¼Œä»è€Œç”ŸæˆCPUæ€§èƒ½æ•°æ®ã€‚

ä¸Šé¢æˆ‘ä»¬å·²ç»ç”Ÿæˆäº†CPUæ€§èƒ½æ•°æ®æ–‡ä»¶`cpu.profile`ï¼Œæ¥ä¸‹æ¥ä¼šè¿ç”¨ä¸Šé¢æåˆ°çš„ä¸‰ç§æ–¹æ³•æ¥åˆ†æè¯¥æ€§èƒ½æ–‡ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½ã€‚

**æ–¹æ³•ä¸€ï¼šåˆ†æé‡‡æ ·å›¾**

è¦åˆ†ææ€§èƒ½ï¼Œæœ€ç›´è§‚çš„æ–¹å¼å½“ç„¶æ˜¯çœ‹å›¾ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬éœ€è¦ç”Ÿæˆé‡‡æ ·å›¾ï¼Œç”Ÿæˆè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥**ï¼Œç¡®ä¿ç³»ç»Ÿå®‰è£…äº†`graphviz`ï¼š

```bash
$ sudo yum -y install graphviz.x86_64
```

**ç¬¬äºŒæ­¥**ï¼Œæ‰§è¡Œ`go tool pprof`ç”Ÿæˆè°ƒç”¨å›¾ï¼š

```bash
$ go tool pprof -svg cpu.profile > cpu.svg  # svg æ ¼å¼$ go tool pprof -pdf cpu.profile > cpu.pdf # pdf æ ¼å¼$ go tool pprof -png cpu.profile > cpu.png # png æ ¼å¼
```

ä»¥ä¸Šå‘½ä»¤ä¼šç”Ÿæˆ`cpu.pdf`ã€`cpu.svg`å’Œ`cpu.png`æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­ç»˜åˆ¶äº†å‡½æ•°è°ƒç”¨å…³ç³»ä»¥åŠå…¶ä»–é‡‡æ ·æ•°æ®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a7/0c/a737e4d5f25775150545558872aa9e0c.png?wh=438x1259)](https://static001.geekbang.org/resource/image/a7/0c/a737e4d5f25775150545558872aa9e0c.png?wh=438x1259)

è¿™å¼ å›¾ç‰‡ç”±æœ‰å‘çº¿æ®µå’ŒçŸ©å½¢ç»„æˆã€‚**æˆ‘ä»¬å…ˆæ¥çœ‹æœ‰å‘çº¿æ®µçš„å«ä¹‰ã€‚**

æœ‰å‘çº¿æ®µæè¿°äº†å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼ŒçŸ©å½¢åŒ…å«äº†CPUé‡‡æ ·æ•°æ®ã€‚ä»å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æ²¡ç®­å¤´çš„ä¸€ç«¯è°ƒç”¨äº†æœ‰ç®­å¤´çš„ä¸€ç«¯ï¼Œå¯ä»¥çŸ¥é“`v1.(*userService).List`å‡½æ•°è°ƒç”¨äº†`fake.(*policies).List`ã€‚

çº¿æ®µæ—è¾¹çš„æ•°å­—`90ms`åˆ™è¯´æ˜ï¼Œ`v1.(*userService).List`è°ƒç”¨`fake.(*policies).List`å‡½æ•°ï¼Œåœ¨é‡‡æ ·å‘¨æœŸå†…ï¼Œä¸€å…±è€—ç”¨äº†`90ms`ã€‚é€šè¿‡å‡½æ•°è°ƒç”¨å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æŸä¸ªå‡½æ•°è°ƒç”¨äº†å“ªäº›å‡½æ•°ï¼Œå¹¶ä¸”è°ƒç”¨è¿™äº›å‡½æ•°è€—æ—¶å¤šä¹…ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¬¡è§£è¯»ä¸‹å›¾ä¸­è°ƒç”¨å…³ç³»ä¸­çš„é‡è¦ä¿¡æ¯ï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/70/32/70e964bc6d8f0b28d434cce47c4e1132.png?wh=835x818)](https://static001.geekbang.org/resource/image/70/32/70e964bc6d8f0b28d434cce47c4e1132.png?wh=835x818)

`runtime.schedule`çš„ç´¯ç§¯é‡‡æ ·æ—¶é—´ï¼ˆ140msï¼‰ä¸­ï¼Œæœ‰10msæ¥è‡ªäº`runtime.goschedImpl`å‡½æ•°çš„ç›´æ¥è°ƒç”¨ï¼Œæœ‰70msæ¥è‡ªäº`runtime.park_m`å‡½æ•°çš„ç›´æ¥è°ƒç”¨ã€‚è¿™äº›æ•°æ®å¯ä»¥è¯´æ˜`runtime.schedule`å‡½æ•°åˆ†åˆ«è¢«å“ªäº›å‡½æ•°è°ƒç”¨ï¼Œå¹¶ä¸”è°ƒç”¨é¢‘ç‡æœ‰å¤šå¤§ã€‚ä¹Ÿå› ä¸ºè¿™ä¸ªåŸå› ï¼Œå‡½æ•°`runtime.goschedImpl`å¯¹å‡½æ•°`runtime.schedule`çš„è°ƒç”¨æ—¶é—´å¿…å®šå°äºç­‰äºå‡½æ•°`runtime.schedule`çš„ç´¯ç§¯é‡‡æ ·æ—¶é—´ã€‚

**æˆ‘ä»¬å†æ¥çœ‹ä¸‹çŸ©å½¢é‡Œçš„é‡‡æ ·æ•°æ®ã€‚**è¿™äº›çŸ©å½¢åŸºæœ¬éƒ½åŒ…å«äº†3ç±»ä¿¡æ¯ï¼š

+ å‡½æ•°å/æ–¹æ³•åï¼Œè¯¥ç±»ä¿¡æ¯åŒ…å«äº†åŒ…åã€ç»“æ„ä½“åã€å‡½æ•°å/æ–¹æ³•åï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿå®šä½åˆ°å‡½æ•°/æ–¹æ³•ï¼Œä¾‹å¦‚`fake(*policies)List`è¯´æ˜æ˜¯fakeåŒ…ï¼Œpoliciesç»“æ„ä½“çš„Listæ–¹æ³•ã€‚
+ æœ¬åœ°é‡‡æ ·æ—¶é—´ï¼Œä»¥åŠå®ƒåœ¨é‡‡æ ·æ€»æ•°ä¸­æ‰€å çš„æ¯”ä¾‹ã€‚æœ¬åœ°é‡‡æ ·æ—¶é—´æ˜¯æŒ‡é‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„æ€»æ—¶é—´ã€‚
+ ç´¯ç§¯é‡‡æ ·æ—¶é—´ï¼Œä»¥åŠå®ƒåœ¨é‡‡æ ·æ€»æ•°ä¸­æ‰€å çš„æ¯”ä¾‹ã€‚ç´¯ç§¯é‡‡æ ·æ—¶é—´æ˜¯æŒ‡é‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ï¼Œä»¥åŠè¢«å®ƒç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨çš„å‡½æ•°ä¸­çš„æ€»æ—¶é—´ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡`OutDir`å‡½æ•°æ¥è§£é‡Šæœ¬åœ°é‡‡æ ·æ—¶é—´å’Œç´¯ç§¯é‡‡æ ·æ—¶é—´è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚`OutDir`å‡½æ•°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f5/a5/f55c738c09471094a9a8498e9b73faa5.png?wh=1020x558)](https://static001.geekbang.org/resource/image/f5/a5/f55c738c09471094a9a8498e9b73faa5.png?wh=1020x558)

æ•´ä¸ªå‡½æ•°çš„æ‰§è¡Œè€—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ˜¯ç´¯ç§¯é‡‡æ ·æ—¶é—´ï¼ŒåŒ…å«äº†ç™½è‰²éƒ¨åˆ†çš„ä»£ç è€—æ—¶å’Œçº¢è‰²éƒ¨åˆ†çš„å‡½æ•°è°ƒç”¨è€—æ—¶ã€‚ç™½è‰²éƒ¨åˆ†çš„ä»£ç è€—æ—¶ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æœ¬åœ°é‡‡æ ·æ—¶é—´ã€‚

é€šè¿‡ç´¯ç§¯é‡‡æ ·æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å‡½æ•°çš„æ€»è°ƒç”¨æ—¶é—´ï¼Œç´¯ç§¯é‡‡æ ·æ—¶é—´è¶Šå¤§ï¼Œè¯´æ˜è°ƒç”¨å®ƒæ‰€èŠ±è´¹çš„CPUæ—¶é—´è¶Šå¤šã€‚ä½†ä½ è¦æ³¨æ„ï¼Œè¿™å¹¶ä¸ä¸€å®šè¯´æ˜è¿™ä¸ªå‡½æ•°æœ¬èº«æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å‡½æ•°æ‰€è°ƒç”¨çš„å‡½æ•°æ€§èƒ½æœ‰ç“¶é¢ˆï¼Œè¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥æ ¹æ®å‡½æ•°è°ƒç”¨å…³ç³»é¡ºè—¤æ‘¸ç“œï¼Œå»å¯»æ‰¾è¿™ä¸ªå‡½æ•°ç›´æ¥æˆ–é—´æ¥è°ƒç”¨çš„å‡½æ•°ä¸­æœ€è€—è´¹CPUæ—¶é—´çš„é‚£äº›ã€‚

å¦‚æœå‡½æ•°çš„æœ¬åœ°é‡‡æ ·æ—¶é—´å¾ˆå¤§ï¼Œå°±è¯´æ˜è¿™ä¸ªå‡½æ•°è‡ªèº«è€—æ—¶ï¼ˆé™¤å»è°ƒç”¨å…¶ä»–å‡½æ•°çš„è€—æ—¶ï¼‰å¾ˆå¤§ï¼Œè¿™æ—¶å€™éœ€è¦æˆ‘ä»¬åˆ†æè¿™ä¸ªå‡½æ•°è‡ªèº«çš„ä»£ç ï¼Œè€Œä¸æ˜¯è¿™ä¸ªå‡½æ•°ç›´æ¥æˆ–è€…é—´æ¥è°ƒç”¨å‡½æ•°çš„ä»£ç ã€‚

é‡‡æ ·å›¾ä¸­ï¼ŒçŸ©å½¢æ¡†é¢ç§¯è¶Šå¤§ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°çš„ç´¯ç§¯é‡‡æ ·æ—¶é—´è¶Šå¤§ã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åˆ†æé‡‡æ ·å›¾ä¸­çš„çŸ©å½¢æ¡†é¢ç§¯å¾ˆå¤§ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦è®¤çœŸåˆ†æäº†ï¼Œå› ä¸ºå¾ˆå¯èƒ½è¿™ä¸ªå‡½æ•°å°±æœ‰éœ€è¦ä¼˜åŒ–æ€§èƒ½çš„åœ°æ–¹ã€‚

**æ–¹æ³•äºŒï¼šåˆ†æç«ç„°å›¾**

ä¸Šé¢ä»‹ç»çš„é‡‡æ ·å›¾ï¼Œå…¶å®åœ¨åˆ†ææ€§èƒ½çš„æ—¶å€™è¿˜ä¸å¤ªç›´è§‚ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç”Ÿæˆç«ç„°å›¾ï¼Œæ¥æ›´ç›´è§‚åœ°æŸ¥çœ‹æ€§èƒ½ç“¶é¢ˆã€‚ç«ç„°å›¾æ˜¯ç”±Brendan Greggå¤§å¸ˆå‘æ˜çš„ä¸“é—¨ç”¨æ¥æŠŠé‡‡æ ·åˆ°çš„å †æ ˆè½¨è¿¹ï¼ˆStack Traceï¼‰è½¬åŒ–ä¸ºç›´è§‚å›¾ç‰‡æ˜¾ç¤ºçš„å·¥å…·ï¼Œå› æ•´å¼ å›¾çœ‹èµ·æ¥åƒä¸€å›¢è·³åŠ¨çš„ç«ç„°è€Œå¾—åã€‚

`go tool pprof`æä¾›äº†`-http`å‚æ•°ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨æµè§ˆé‡‡æ ·å›¾å’Œç«ç„°å›¾ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ go tool pprof -http="0.0.0.0:8081" v1.test cpu.profile
```

ç„¶åè®¿é—®`http://x.x.x.x:8081/`ï¼ˆ`x.x.x.x`æ˜¯æ‰§è¡Œ`go tool pprof`å‘½ä»¤æ‰€åœ¨æœåŠ¡å™¨çš„IPåœ°å€ï¼‰ï¼Œåˆ™ä¼šåœ¨æµè§ˆå™¨æ˜¾ç¤ºå„ç±»é‡‡æ ·è§†å›¾æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/91/9d/91dab469d3d61dd4302d3ef5d483609d.png?wh=1920x679)](https://static001.geekbang.org/resource/image/91/9d/91dab469d3d61dd4302d3ef5d483609d.png?wh=1920x679)

ä¸Šé¢çš„UIé¡µé¢æä¾›äº†ä¸åŒçš„é‡‡æ ·æ•°æ®è§†å›¾ï¼š

+ Topï¼Œç±»ä¼¼äº linux top çš„å½¢å¼ï¼Œä»é«˜åˆ°ä½æ’åºã€‚
+ Graphï¼Œé»˜è®¤å¼¹å‡ºæ¥çš„å°±æ˜¯è¯¥æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€ä¸ªå›¾çš„é‚£ç§å¸¦æœ‰è°ƒç”¨å…³ç³»çš„å›¾ã€‚
+ Flame Graphï¼špprof ç«ç„°å›¾ã€‚
+ Peekï¼šç±»ä¼¼äº Top ä¹Ÿæ˜¯ä»é«˜åˆ°åº•çš„æ’åºã€‚
+ Sourceï¼šå’Œäº¤äº’å‘½ä»¤å¼çš„é‚£ç§ä¸€æ ·ï¼Œå¸¦æœ‰æºç æ ‡æ³¨ã€‚
+ Disassembleï¼šæ˜¾ç¤ºæ‰€æœ‰çš„æ€»é‡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸»è¦æ¥åˆ†æç«ç„°å›¾ã€‚åœ¨UIç•Œé¢é€‰æ‹©**Flame Graphï¼ˆVIEW -> Flame Graphï¼‰**ï¼Œå°±ä¼šå±•ç¤ºç«ç„°å›¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/33/e9/33e427f1a2419e0420e9ef8e9ddd69e9.png?wh=1920x609)](https://static001.geekbang.org/resource/image/33/e9/33e427f1a2419e0420e9ef8e9ddd69e9.png?wh=1920x609)

ç«ç„°å›¾ä¸»è¦æœ‰ä¸‹é¢è¿™å‡ ä¸ªç‰¹å¾ï¼š

+ æ¯ä¸€åˆ—ä»£è¡¨ä¸€ä¸ªè°ƒç”¨æ ˆï¼Œæ¯ä¸€ä¸ªæ ¼å­ä»£è¡¨ä¸€ä¸ªå‡½æ•°ã€‚
+ çºµè½´å±•ç¤ºäº†æ ˆçš„æ·±åº¦ï¼ŒæŒ‰ç…§è°ƒç”¨å…³ç³»ä»ä¸Šåˆ°ä¸‹æ’åˆ—ã€‚æœ€ä¸‹é¢çš„æ ¼å­ä»£è¡¨é‡‡æ ·æ—¶ï¼Œæ­£åœ¨å ç”¨CPUçš„å‡½æ•°ã€‚
+ è°ƒç”¨æ ˆåœ¨æ¨ªå‘ä¼šæŒ‰ç…§å­—æ¯æ’åºï¼Œå¹¶ä¸”åŒæ ·çš„è°ƒç”¨æ ˆä¼šåšåˆå¹¶ï¼Œæ‰€ä»¥ä¸€ä¸ªæ ¼å­çš„å®½åº¦è¶Šå¤§ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°è¶Šå¯èƒ½æ˜¯ç“¶é¢ˆã€‚
+ ç«ç„°å›¾æ ¼å­çš„é¢œè‰²æ˜¯éšæœºçš„æš–è‰²è°ƒï¼Œæ–¹ä¾¿åŒºåˆ†å„ä¸ªè°ƒç”¨ä¿¡æ¯ã€‚

æŸ¥çœ‹ç«ç„°å›¾æ—¶ï¼Œæ ¼å­è¶Šå®½çš„å‡½æ•°ï¼Œå°±è¶Šå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ†æè¯¥å‡½æ•°çš„ä»£ç ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚

**æ–¹æ³•ä¸‰ï¼šç”¨**`go tool pprof`**äº¤äº’æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ•°æ®**

æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ`go tool pprof`å‘½ä»¤ï¼Œæ¥æŸ¥çœ‹CPUçš„æ€§èƒ½æ•°æ®æ–‡ä»¶ï¼š

```bash
$ go tool pprof v1.test cpu.profileFile: v1.testType: cpuTime: Aug 17, 2021 at 2:17pm (CST)Duration: 56.48s, Total samples = 440ms ( 0.78%)Entering interactive mode (type "help" for commands, "o" for options)(pprof)
```

`go tool pprof`è¾“å‡ºäº†å¾ˆå¤šä¿¡æ¯ï¼š

+ Fileï¼ŒäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶åç§°ã€‚
+ Typeï¼Œé‡‡æ ·æ–‡ä»¶çš„ç±»å‹ï¼Œä¾‹å¦‚cpuã€memç­‰ã€‚
+ Timeï¼Œç”Ÿæˆé‡‡æ ·æ–‡ä»¶çš„æ—¶é—´ã€‚
+ Durationï¼Œç¨‹åºæ‰§è¡Œæ—¶é—´ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç¨‹åºæ€»æ‰§è¡Œæ—¶é—´ä¸º`37.43s`ï¼Œé‡‡æ ·æ—¶é—´ä¸º`42.37s`ã€‚é‡‡æ ·ç¨‹åºåœ¨é‡‡æ ·æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ†é…é‡‡æ ·ä»»åŠ¡ç»™å¤šä¸ªæ ¸å¿ƒï¼Œæ‰€ä»¥æ€»é‡‡æ ·æ—¶é—´å¯èƒ½ä¼šå¤§äºæ€»æ‰§è¡Œæ—¶é—´ã€‚
+ (pprof)ï¼Œå‘½ä»¤è¡Œæç¤ºï¼Œè¡¨ç¤ºå½“å‰åœ¨`go tool`çš„`pprof`å·¥å…·å‘½ä»¤è¡Œä¸­ï¼Œ`go tool`è¿˜åŒ…æ‹¬`cgo`ã€`doc`ã€`pprof`ã€`trace`ç­‰å¤šç§å‘½ä»¤ã€‚

æ‰§è¡Œ`go tool pprof`å‘½ä»¤åï¼Œä¼šè¿›å…¥ä¸€ä¸ªäº¤äº’shellã€‚åœ¨è¿™ä¸ªäº¤äº’shellä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œå¤šä¸ªå‘½ä»¤ï¼Œæœ€å¸¸ç”¨çš„å‘½ä»¤æœ‰ä¸‰ä¸ªï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d1/98/d10a2c6cbfa4e35fc4efc9a3760d1b98.jpg?wh=1920x1196)](https://static001.geekbang.org/resource/image/d1/98/d10a2c6cbfa4e35fc4efc9a3760d1b98.jpg?wh=1920x1196)

æˆ‘ä»¬åœ¨äº¤äº’ç•Œé¢ä¸­æ‰§è¡Œ`top`å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹æ€§èƒ½æ ·æœ¬æ•°æ®ï¼š

```bash
(pprof) topShowing nodes accounting for 350ms, 79.55% of 440ms totalShowing top 10 nodes out of 47      flat  flat%   sum%        cum   cum%     110ms 25.00% 25.00%      110ms 25.00%  runtime.futex      70ms 15.91% 40.91%       90ms 20.45%  github.com/marmotedu/iam/internal/apiserver/store/fake.(*policies).List      40ms  9.09% 50.00%       40ms  9.09%  runtime.epollwait      40ms  9.09% 59.09%      180ms 40.91%  runtime.findrunnable      30ms  6.82% 65.91%       30ms  6.82%  runtime.write1      20ms  4.55% 70.45%       30ms  6.82%  runtime.notesleep      10ms  2.27% 72.73%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List      10ms  2.27% 75.00%       10ms  2.27%  runtime.checkTimers      10ms  2.27% 77.27%       10ms  2.27%  runtime.doaddtimer      10ms  2.27% 79.55%       10ms  2.27%  runtime.mallocgc
```

ä¸Šé¢çš„è¾“å‡ºä¸­ï¼Œæ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ã€‚pprofç¨‹åºä¸­æœ€é‡è¦çš„å‘½ä»¤å°±æ˜¯topNï¼Œè¿™ä¸ªå‘½ä»¤ç”¨æ¥æ˜¾ç¤ºprofileæ–‡ä»¶ä¸­æœ€é å‰çš„Nä¸ªæ ·æœ¬ï¼ˆsampleï¼‰ï¼Œtopå‘½ä»¤ä¼šè¾“å‡ºå¤šè¡Œä¿¡æ¯ï¼Œæ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªå‡½æ•°çš„é‡‡æ ·æ•°æ®ï¼Œé»˜è®¤æŒ‰`flat%`æ’åºã€‚è¾“å‡ºä¸­ï¼Œå„åˆ—å«ä¹‰å¦‚ä¸‹ï¼š

+ flatï¼šé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„æ€»æ—¶é—´ã€‚
+ flat%ï¼šé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­æ—¶é—´çš„ç™¾åˆ†æ¯”ã€‚
+ sum%ï¼šå‰é¢æ‰€æœ‰è¡Œçš„flat%çš„ç´¯åŠ å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸€é¡¹çš„ç´¯ç§¯ç™¾åˆ†æ¯”ã€‚
+ cumï¼šé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„ï¼Œä»¥åŠè¢«å®ƒè°ƒç”¨çš„å‡½æ•°ä¸­çš„æ€»æ—¶é—´ã€‚
+ cum%ï¼šé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„ï¼Œä»¥åŠè¢«å®ƒè°ƒç”¨çš„å‡½æ•°ä¸­çš„æ€»æ¬¡æ•°ç™¾åˆ†æ¯”ã€‚
+ å‡½æ•°åã€‚

ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘ä»¬å‡½æ•°æ‰§è¡Œçš„æ—¶é—´å’Œè€—æ—¶æ’åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­å“ªäº›å‡½æ•°å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜ï¼Œæˆ–è€…å“ªäº›å‡½æ•°çš„æ€§èƒ½å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚

è¿™é‡Œæƒ³æç¤ºä¸‹ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯`go tool pprof mem.profile`ï¼Œé‚£ä¹ˆä¸Šé¢çš„å„å­—æ®µæ„ä¹‰æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡è¿™æ¬¡ä¸æ˜¯æ—¶é—´è€Œæ˜¯å†…å­˜åˆ†é…å¤§å°ï¼ˆå­—èŠ‚ï¼‰ã€‚

æ‰§è¡Œ`top`å‘½ä»¤é»˜è®¤æ˜¯æŒ‰`flat%`æ’åºçš„ï¼Œåœ¨åšæ€§èƒ½åˆ†ææ—¶ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŒ‰ç…§`cum`æ¥æ’åºï¼Œé€šè¿‡`cum`ï¼Œæˆ‘ä»¬å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°å“ªä¸ªå‡½æ•°æ€»è€—æ—¶æœ€å¤šï¼Œç„¶åå†å‚è€ƒè¯¥å‡½æ•°çš„æœ¬åœ°é‡‡æ ·æ—¶é—´å’Œè°ƒç”¨å…³ç³»ï¼Œæ¥åˆ¤æ–­æ˜¯è¯¥å‡½æ•°æ€§èƒ½è€—æ—¶å¤šï¼Œè¿˜æ˜¯å®ƒè°ƒç”¨çš„å‡½æ•°è€—æ—¶å¤šã€‚

æ‰§è¡Œ`top -cum`è¾“å‡ºå¦‚ä¸‹ï¼š

```bash
(pprof) top20 -cumShowing nodes accounting for 280ms, 63.64% of 440ms totalShowing top 20 nodes out of 47      flat  flat%   sum%        cum   cum%         0     0%     0%      320ms 72.73%  runtime.mcall         0     0%     0%      320ms 72.73%  runtime.park_m         0     0%     0%      280ms 63.64%  runtime.schedule      40ms  9.09%  9.09%      180ms 40.91%  runtime.findrunnable     110ms 25.00% 34.09%      110ms 25.00%  runtime.futex      10ms  2.27% 36.36%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List         0     0% 36.36%      100ms 22.73%  github.com/marmotedu/iam/internal/apiserver/service/v1.BenchmarkListUser         0     0% 36.36%      100ms 22.73%  runtime.futexwakeup         0     0% 36.36%      100ms 22.73%  runtime.notewakeup         0     0% 36.36%      100ms 22.73%  runtime.resetspinning         0     0% 36.36%      100ms 22.73%  runtime.startm         0     0% 36.36%      100ms 22.73%  runtime.wakep         0     0% 36.36%      100ms 22.73%  testing.(*B).launch         0     0% 36.36%      100ms 22.73%  testing.(*B).runN      70ms 15.91% 52.27%       90ms 20.45%  github.com/marmotedu/iam/internal/apiserver/store/fake.(*policies).List      10ms  2.27% 54.55%       50ms 11.36%  runtime.netpoll      40ms  9.09% 63.64%       40ms  9.09%  runtime.epollwait         0     0% 63.64%       40ms  9.09%  runtime.modtimer         0     0% 63.64%       40ms  9.09%  runtime.resetForSleep         0     0% 63.64%       40ms  9.09%  runtime.resettimer (inline)
```

ä»ä¸Šé¢çš„è¾“å‡ºå¯çŸ¥ï¼Œ`v1.BenchmarkListUser`ã€`testing.(*B).launch`ã€`testing.(*B).runN`çš„æœ¬åœ°é‡‡æ ·æ—¶é—´å æ¯”åˆ†åˆ«ä¸º`0%`ã€`0%`ã€`0%`ï¼Œä½†æ˜¯ä¸‰è€…çš„ç´¯ç§¯é‡‡æ ·æ—¶é—´å æ¯”å´æ¯”è¾ƒé«˜ï¼Œåˆ†åˆ«ä¸º`22.73%`ã€`22.73%`ã€`22.73%`ã€‚

æœ¬åœ°é‡‡æ ·æ—¶é—´å æ¯”å¾ˆå°ï¼Œä½†æ˜¯ç´¯ç§¯é‡‡æ ·æ—¶é—´å æ¯”å¾ˆé«˜ï¼Œè¯´æ˜è¿™3ä¸ªå‡½æ•°è€—æ—¶å¤šæ˜¯å› ä¸ºè°ƒç”¨äº†å…¶ä»–å‡½æ•°ï¼Œå®ƒä»¬è‡ªèº«å‡ ä¹æ²¡æœ‰è€—æ—¶ã€‚æ ¹æ®é‡‡æ ·å›¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡½æ•°çš„è°ƒç”¨å…³ç³»ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b0/4c/b0b7624a7922cea801de63b865f6ed4c.jpg?wh=1920x437)](https://static001.geekbang.org/resource/image/b0/4c/b0b7624a7922cea801de63b865f6ed4c.jpg?wh=1920x437)

ä»é‡‡æ ·å›¾ä¸­ï¼Œå¯ä»¥çŸ¥é“æœ€ç»ˆ`v1.BenchmarkListUser`è°ƒç”¨äº†`v1.(*userService).List`å‡½æ•°ã€‚`v1.(*userService).List`å‡½æ•°æ˜¯æˆ‘ä»¬ç¼–å†™çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„æœ¬åœ°é‡‡æ ·æ—¶é—´å æ¯”ä¸º`2.27%`ï¼Œä½†æ˜¯ç´¯ç§¯é‡‡æ ·æ—¶é—´å æ¯”å´é«˜è¾¾`22.73%`ï¼Œè¯´æ˜`v1.(*userService).List`è°ƒç”¨å…¶ä»–å‡½æ•°è€—ç”¨äº†å¤§é‡çš„CPUæ—¶é—´ã€‚

å†è§‚å¯Ÿé‡‡æ ·å›¾ï¼Œå¯ä»¥çœ‹å‡º`v1.(*userService).List`è€—æ—¶ä¹…æ˜¯å› ä¸ºè°ƒç”¨äº†`fake.(*policies).List`å‡½æ•°ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡`list`å‘½ä»¤æŸ¥çœ‹å‡½æ•°å†…éƒ¨çš„è€—æ—¶æƒ…å†µï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/81/23/81765c7e56cb45d03a0a61de5835d823.png?wh=1920x576)](https://static001.geekbang.org/resource/image/81/23/81765c7e56cb45d03a0a61de5835d823.png?wh=1920x576)

`list userService.*List`ä¼šåˆ—å‡º`userService`ç»“æ„ä½“`List`æ–¹æ³•å†…éƒ¨ä»£ç çš„è€—æ—¶æƒ…å†µï¼Œä»ä¸Šå›¾ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œ`u.store.Policies().List`è€—æ—¶æœ€å¤šã€‚`fake.(*policies).List`çš„æœ¬åœ°é‡‡æ ·æ—¶é—´å æ¯”ä¸º`15.91%`ï¼Œè¯´æ˜`fake.(*policies).List`å‡½æ•°æœ¬èº«å¯èƒ½å­˜åœ¨ç“¶é¢ˆã€‚èµ°è¯»`fake.(*policies).List`ä»£ç å¯çŸ¥ï¼Œè¯¥å‡½æ•°æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„å‡½æ•°ï¼ŒæŸ¥è¯¢æ•°æ®åº“ä¼šæœ‰å»¶æ—¶ã€‚ç»§ç»­æŸ¥çœ‹`v1.(*userService).List`ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä»¥ä¸‹è°ƒç”¨é€»è¾‘ï¼š

```go
func (u *userService) ListWithBadPerformance(ctx context.Context, opts metav1.ListOptions) (*v1.UserList, error) {    ...    for _, user := range users.Items {        policies, err := u.store.Policies().List(ctx, user.Name, metav1.ListOptions{})        ...        })    }    ...}
```

æˆ‘ä»¬åœ¨`for`å¾ªç¯ä¸­ï¼Œä¸²è¡Œè°ƒç”¨äº†`fake.(*policies).List`å‡½æ•°ï¼Œæ¯ä¸€æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨æœ‰å»¶æ—¶çš„`fake.(*policies).List`å‡½æ•°ã€‚å¤šæ¬¡è°ƒç”¨ï¼Œ`v1.(*userService).List`å‡½æ•°çš„è€—æ—¶è‡ªç„¶ä¼šç´¯åŠ èµ·æ¥ã€‚

ç°åœ¨é—®é¢˜æ‰¾åˆ°äº†ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿä½ å¯ä»¥åˆ©ç”¨CPUå¤šæ ¸ç‰¹æ€§ï¼Œå¼€å¯å¤šä¸ªgoroutineï¼Œè¿™æ ·æˆ‘ä»¬çš„æŸ¥è¯¢è€—æ—¶å°±ä¸æ˜¯ä¸²è¡Œç´¯åŠ çš„ï¼Œè€Œæ˜¯å–å†³äºæœ€æ…¢ä¸€æ¬¡çš„`fake.(*policies).List`è°ƒç”¨ã€‚ä¼˜åŒ–åçš„`v1.(*userService).List*`*å‡½æ•°ä»£ç è§[internal/apiserver/service/v1/user.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user.go#L43-L110)ã€‚ç”¨åŒæ ·çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œæµ‹è¯•ä¼˜åŒ–åçš„å‡½æ•°ï¼Œç»“æœå¦‚ä¸‹ï¼š*

```bash
$ go test -benchtime=30s -benchmem -bench="." -cpuprofile cpu.profile -memprofile mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	    8330	   4271131 ns/op	   26390 B/op	     484 allocs/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	36.179s
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œns/opä¸º`4271131 ns/op`ï¼Œå¯ä»¥çœ‹åˆ°å’Œç¬¬ä¸€æ¬¡çš„æµ‹è¯•ç»“æœ`204523677 ns/op`ç›¸æ¯”ï¼Œæ€§èƒ½æå‡äº†`97.91%`ã€‚

è¿™é‡Œæ³¨æ„ä¸‹ï¼Œä¸ºäº†æ–¹ä¾¿ä½ å¯¹ç…§ï¼Œæˆ‘å°†ä¼˜åŒ–å‰çš„`v1.(*userService).List`å‡½æ•°é‡å‘½åä¸º`v1.(*userService).ListWithBadPerformance`ã€‚

### å†…å­˜æ€§èƒ½åˆ†æ

Goè¯­è¨€è¿è¡Œæ—¶ï¼Œç³»ç»Ÿä¼šå¯¹ç¨‹åºè¿è¡ŒæœŸé—´çš„æ‰€æœ‰å †å†…å­˜åˆ†é…è¿›è¡Œè®°å½•ã€‚ä¸ç®¡åœ¨é‡‡æ ·çš„å“ªä¸€æ—¶åˆ»ï¼Œä¹Ÿä¸ç®¡å †å†…å­˜å·²ç”¨å­—èŠ‚æ•°æ˜¯å¦æœ‰å¢é•¿ï¼Œåªè¦æœ‰å­—èŠ‚è¢«åˆ†é…ä¸”æ•°é‡è¶³å¤Ÿï¼Œåˆ†æå™¨å°±ä¼šå¯¹å®ƒè¿›è¡Œé‡‡æ ·ã€‚

å†…å­˜æ€§èƒ½åˆ†ææ–¹æ³•å’ŒCPUæ€§èƒ½åˆ†ææ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ä»‹ç»äº†ã€‚ä½ å¯ä»¥å€ŸåŠ©å‰é¢ç”Ÿæˆçš„å†…å­˜æ€§èƒ½æ•°æ®æ–‡ä»¶`mem.profile`è‡ªè¡Œåˆ†æã€‚

æ¥ä¸‹æ¥ï¼Œç»™ä½ å±•ç¤ºä¸‹å†…å­˜ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„æ•ˆæœã€‚åœ¨`v1.(*userService).List`å‡½æ•°ï¼ˆä½äº[internal/apiserver/service/v1/user.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user.go#L43-L110)æ–‡ä»¶ä¸­ï¼‰ä¸­ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼š

```go
infos := make([]*v1.User, 0)for _, user := range users.Items {    info, _ := m.Load(user.ID)    infos = append(infos, info.(v1.User))}
```

*æ­¤æ—¶ï¼Œæˆ‘ä»¬è¿è¡Œ`go test`å‘½ä»¤ï¼Œæµ‹è¯•ä¸‹å†…å­˜æ€§èƒ½ï¼Œä½œä¸ºä¼˜åŒ–åçš„æ€§èƒ½æ•°æ®ï¼Œè¿›è¡Œå¯¹æ¯”ï¼š*

```bash
$ go test -benchmem -bench="." -cpuprofile cpu.profile -memprofile mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	     278	   4284660 ns/op	   27101 B/op	     491 allocs/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	1.779s
```

`B/op`å’Œ`allocs/op`åˆ†åˆ«ä¸º`27101 B/op`å’Œ`491 allocs/op`ã€‚

æˆ‘ä»¬é€šè¿‡åˆ†æä»£ç ï¼Œå‘ç°å¯ä»¥å°†`infos := make([]*v1.User, 0)`ä¼˜åŒ–ä¸º`infos := make([]*v1.User, 0, len(users.Items))`ï¼Œæ¥å‡å°‘Goåˆ‡ç‰‡çš„å†…å­˜é‡æ–°åˆ†é…çš„æ¬¡æ•°ã€‚ä¼˜åŒ–åçš„ä»£ç ä¸ºï¼š

```go
//infos := make([]*v1.User, 0)infos := make([]*v1.User, 0, len(users.Items))for _, user := range users.Items {    info, _ := m.Load(user.ID)    infos = append(infos, info.(v1.User))}
```

*å†æ‰§è¡Œ`go test`æµ‹è¯•ä¸‹æ€§èƒ½ï¼š*

```bash
$ go test -benchmem -bench="." -cpuprofile cpu.profile -memprofile mem.profilegoos: linuxgoarch: amd64pkg: github.com/marmotedu/iam/internal/apiserver/service/v1cpu: AMD EPYC ProcessorBenchmarkListUser-8   	     276	   4318472 ns/op	   26457 B/op	     484 allocs/opPASSok  	github.com/marmotedu/iam/internal/apiserver/service/v1	1.856s
```

ä¼˜åŒ–åçš„`B/op`å’Œ`allocs/op`åˆ†åˆ«ä¸º`26457 B/op`å’Œ`484 allocs/op`ã€‚è·Ÿç¬¬ä¸€æ¬¡çš„`27101 B/op`å’Œ`491 allocs/op`ç›¸æ¯”ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°æ›´å°‘ï¼Œæ¯æ¬¡åˆ†é…çš„å†…å­˜ä¹Ÿæ›´å°‘ã€‚

æˆ‘ä»¬å¯ä»¥æ‰§è¡Œ`go tool pprof`å‘½ä»¤ï¼Œæ¥æŸ¥çœ‹CPUçš„æ€§èƒ½æ•°æ®æ–‡ä»¶ï¼š

```bash
$ go tool pprof v1.test mem.profileFile: v1.testType: alloc_spaceTime: Aug 17, 2021 at 8:33pm (CST)Entering interactive mode (type "help" for commands, "o" for options)(pprof)
```

è¯¥å‘½ä»¤ä¼šè¿›å…¥ä¸€ä¸ªäº¤äº’ç•Œé¢ï¼Œåœ¨äº¤äº’ç•Œé¢ä¸­æ‰§è¡Œtopå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹æ€§èƒ½æ ·æœ¬æ•°æ®ï¼Œä¾‹å¦‚ï¼š

```bash
(pprof) topShowing nodes accounting for 10347.32kB, 95.28% of 10859.34kB totalShowing top 10 nodes out of 52      flat  flat%   sum%        cum   cum% 3072.56kB 28.29% 28.29%  4096.64kB 37.72%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List.func1 1762.94kB 16.23% 44.53%  1762.94kB 16.23%  runtime/pprof.StartCPUProfile 1024.52kB  9.43% 53.96%  1024.52kB  9.43%  go.uber.org/zap/buffer.NewPool.func1 1024.08kB  9.43% 63.39%  1024.08kB  9.43%  time.Sleep  902.59kB  8.31% 71.70%   902.59kB  8.31%  compress/flate.NewWriter  512.20kB  4.72% 76.42%  1536.72kB 14.15%  github.com/marmotedu/iam/internal/apiserver/service/v1.(*userService).List  512.19kB  4.72% 81.14%   512.19kB  4.72%  runtime.malg  512.12kB  4.72% 85.85%   512.12kB  4.72%  regexp.makeOnePass  512.09kB  4.72% 90.57%   512.09kB  4.72%  github.com/marmotedu/iam/internal/apiserver/store/fake.FakeUsers  512.04kB  4.72% 95.28%   512.04kB  4.72%  runtime/pprof.allFrames
```

ä¸Šé¢çš„å†…å­˜æ€§èƒ½æ•°æ®ï¼Œå„å­—æ®µçš„å«ä¹‰ä¾æ¬¡æ˜¯ï¼š

+ flatï¼Œé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„æ€»å†…å­˜æ¶ˆè€—ã€‚
+ flat% ï¼Œé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ä¸­çš„ç™¾åˆ†æ¯”ã€‚
+ sum% ï¼Œä¸Šä¸€é¡¹çš„ç´¯ç§¯ç™¾åˆ†æ¯”ã€‚
+ cum ï¼Œé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ï¼Œä»¥åŠè¢«å®ƒè°ƒç”¨çš„å‡½æ•°ä¸­çš„æ€»å†…å­˜æ¶ˆè€—ã€‚
+ cum%ï¼Œé‡‡æ ·ç‚¹è½åœ¨è¯¥å‡½æ•°ï¼Œä»¥åŠè¢«å®ƒè°ƒç”¨çš„å‡½æ•°ä¸­çš„æ€»æ¬¡æ•°ç™¾åˆ†æ¯”ã€‚
+ å‡½æ•°åã€‚

## æ€»ç»“

åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œç¨‹åºæ€§èƒ½ä½ä¸‹æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ†æå‡ºé—®é¢˜æ‰€åœ¨çš„ä»£ç ã€‚Goè¯­è¨€æä¾›çš„ `go tool pprof` å·¥å…·å¯ä»¥æ”¯æŒæˆ‘ä»¬åˆ†æä»£ç çš„æ€§èƒ½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤æ­¥æ¥åˆ†æä»£ç çš„æ€§èƒ½ï¼Œåˆ†åˆ«æ˜¯ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶å’Œåˆ†ææ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚

Goä¸­å¯ä»¥ç”¨æ¥ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶çš„æ–¹å¼æœ‰ä¸‰ç§ï¼šé€šè¿‡å‘½ä»¤è¡Œç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€é€šè¿‡ä»£ç ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€é€šè¿‡ `net/http/pprof` ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ã€‚

ç”Ÿæˆæ€§èƒ½æ•°æ®æ–‡ä»¶ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ `go tool pprof` å·¥å…·æ¥åˆ†ææ€§èƒ½æ•°æ®æ–‡ä»¶äº†ã€‚æˆ‘ä»¬å¯ä»¥åˆ†åˆ«è·å–åˆ°CPUå’Œå†…å­˜çš„æ€§èƒ½æ•°æ®ï¼Œé€šè¿‡åˆ†æå°±å¯ä»¥æ‰¾åˆ°æ€§èƒ½ç“¶é¢ˆã€‚æœ‰3ç§åˆ†ææ€§èƒ½æ•°æ®æ–‡ä»¶çš„æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯åˆ†æé‡‡æ ·å›¾ã€åˆ†æç«ç„°å›¾å’Œç”¨ `go tool pprof` äº¤äº’æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ•°æ®ã€‚å› ä¸ºç«ç„°å›¾ç›´è§‚é«˜æ•ˆï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ å¤šä½¿ç”¨ç«ç„°å›¾æ¥åˆ†ææ€§èƒ½ã€‚

## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸‹ï¼Œä¸ºä»€ä¹ˆâ€œå‡½æ•°`runtime.goschedImpl`å¯¹å‡½æ•°`runtime.schedule`çš„è°ƒç”¨æ—¶é—´å¿…å®šå°äºç­‰äºå‡½æ•°`runtime.schedule`çš„ç´¯ç§¯é‡‡æ ·æ—¶é—´â€ï¼Ÿ
2. ä½ åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œè¿˜æœ‰å“ªäº›æ¯”è¾ƒå¥½çš„æ€§èƒ½åˆ†ææ€è·¯å’Œæ–¹æ³•ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚



## END é“¾æ¥
<ul><li><div><a href = '29.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '31.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

