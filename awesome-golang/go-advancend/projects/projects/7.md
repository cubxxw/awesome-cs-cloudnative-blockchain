+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬7èŠ‚ é«˜è´¨é‡çš„Makefile

<br>

<div><a href = '6.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '8.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]

[TOC]

## ä½è´¨é‡çš„makefile

ä½è´¨é‡çš„ Makefile æ–‡ä»¶æ˜¯ä»€ä¹ˆæ ·çš„;

```makefile

build: clean vet
  @mkdir -p ./Role
  @export GOOS=linux && go build -v .

vet:
  go vet ./...

fmt:
  go fmt ./...

clean:
  rm -rf dashboard
```

ä¸Šé¢è¿™ä¸ª Makefile å­˜åœ¨ä¸å°‘é—®é¢˜ã€‚ä¾‹å¦‚ï¼šåŠŸèƒ½ç®€å•ï¼Œåªèƒ½å®Œæˆæœ€åŸºæœ¬çš„ç¼–è¯‘ã€æ ¼å¼åŒ–ç­‰æ“ä½œï¼Œåƒæ„å»ºé•œåƒã€è‡ªåŠ¨ç”Ÿæˆä»£ç ç­‰ä¸€äº›é«˜é˜¶çš„åŠŸèƒ½éƒ½æ²¡æœ‰ï¼›æ‰©å±•æ€§å·®ï¼Œæ²¡æ³•ç¼–è¯‘å‡ºå¯åœ¨ Mac ä¸‹è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼›æ²¡æœ‰ Help åŠŸèƒ½ï¼Œä½¿ç”¨éš¾åº¦é«˜ï¼›å• Makefile æ–‡ä»¶ï¼Œç»“æ„å•ä¸€ï¼Œä¸é€‚åˆæ·»åŠ ä¸€äº›å¤æ‚çš„ç®¡ç†åŠŸèƒ½ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸å…‰è¦ç¼–å†™ Makefileï¼Œè¿˜è¦ç¼–å†™é«˜è´¨é‡çš„ Makefileã€‚é‚£ä¹ˆå¦‚ä½•ç¼–å†™ä¸€ä¸ªé«˜è´¨é‡çš„ Makefile å‘¢ï¼Ÿæˆ‘è§‰å¾—ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ 4 ä¸ªæ–¹æ³•æ¥å®ç°ï¼š

+ æ‰“å¥½åŸºç¡€ï¼Œä¹Ÿå°±æ˜¯ç†Ÿç»ƒæŒæ¡ `Makefile` çš„è¯­æ³•ã€‚
+ åšå¥½å‡†å¤‡å·¥ä½œï¼Œä¹Ÿå°±æ˜¯æå‰è§„åˆ’ `Makefile` è¦å®ç°çš„åŠŸèƒ½ã€‚
+ è¿›è¡Œè§„åˆ’ï¼Œè®¾è®¡ä¸€ä¸ªåˆç†çš„ `Makefile` ç»“æ„ã€‚
+ æŒæ¡æ–¹æ³•ï¼Œç”¨å¥½ `Makefile` çš„ç¼–å†™æŠ€å·§ã€‚



## makefile å¦‚ä½•å·¥ä½œ

![image-20230219222355491](http://sm.nsddd.top/sm202302192223604.png)



**makefileè§„åˆ™ï¼š**

```bash
target ... : prerequisites ...
    command
    ...
    ...
```

+ **target**
  + å¯ä»¥æ˜¯ä¸€ä¸ªobject fileï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ˆlabelï¼‰ã€‚å¯¹äºæ ‡ç­¾è¿™ç§ç‰¹æ€§ï¼Œåœ¨åç»­çš„â€œä¼ªç›®æ ‡â€ç« èŠ‚ä¸­ä¼šæœ‰å™è¿°ã€‚
+ **prereqisites**
  + ç”Ÿæˆè¯¥targetæ‰€ä¾èµ–çš„æ–‡ä»¶å’Œ/æˆ–target
+ **command**
  + è¯¥targetè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆä»»æ„çš„shellå‘½ä»¤ï¼‰

> prerequisitesä¸­å¦‚æœæœ‰ä¸€ä¸ªä»¥ä¸Šçš„æ–‡ä»¶æ¯”targetæ–‡ä»¶è¦æ–°çš„è¯ï¼Œcommandæ‰€å®šä¹‰çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œã€‚



### Build and Run

**é¦–å…ˆä¸¤ä¸ªç‰¹åˆ«é¢‘ç¹çš„æŒ‡ä»¤åŠ è¿›å»ï¼š**

```bash
build: 
    go build -o stringifier main.go

run:
    go run -race main.gobuild: 
```

æˆ‘åœ¨è¿è¡Œå‘½ä»¤ä¸­æ·»åŠ äº†`-race`æ ‡å¿—ï¼Œæ–¹ä¾¿å®ƒåœ¨è¿è¡Œæ—¶åœ¨Goä»£ç ä¸­æ£€æµ‹åˆ°`race`æƒ…å†µã€‚



### Cleaning and DRYing

æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶å¹¶è¿è¡Œåº”ç”¨ç¨‹åºåï¼Œä¸€åˆ‡æ­£å¸¸, ç¡®ä¿æˆ‘ä»¬åœ¨æ‰§è¡Œå…¶ä»–ä»»ä½•æ“ä½œä¹‹å‰å…ˆæ¸…ç†äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æˆ‘ä»¬æ›´æ–°`Makefile`åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```go
clean:
	go clean:
```

**æˆ‘ä»¬æœ‰ä¸¤ç‚¹å¯ä»¥æ”¹è¿›**:

1. æˆ‘ä»¬æ˜ç¡®åœ°é‡ç”¨äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå, å¾ˆè‡ªç„¶æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåç§°å°†åœ¨æ•´ä¸ª`Makefile`ä¸­çš„è®¸å¤šåœ°æ–¹ä½¿ç”¨ã€‚
2. æ¯æ¬¡æ„å»ºåº”ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ‰§è¡Œ`clean`çš„è§„åˆ™ã€‚

**æ”¹è¿›åçš„`Makefile`**

```makefile
APP=stringifier

build: clean
	go build -o ${APP} main.go

run:
	go run -race main.go

clean:
	go clean
```

**æ›´æ–°**: è¿™ä¸ªä¾‹å­ä¹‹å‰ä½¿ç”¨çš„`rm -r ${APP}`ï¼Œç°åœ¨ä½¿ç”¨`go clean`ã€‚

åœ¨é¡¶éƒ¨å®šä¹‰`Makefile`å˜é‡ï¼Œå½“æ‚¨è°ƒç”¨`make`å‘½ä»¤æ—¶makeå°†è‡ªåŠ¨å¼•ç”¨å®ƒä»¬ï¼Œè¿™æ ·`Makefile`çœ‹èµ·æ¥å°±æ›´æ•´æ´ã€è§„èŒƒäº†ã€‚



### PHONY targets

åœ¨ Makefile ä¸­ï¼Œ`.PHONY` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç›®æ ‡ï¼ˆtargetï¼‰ï¼Œå®ƒç”¨äºå®šä¹‰é‚£äº›ä¸è¡¨ç¤ºå®é™…æ–‡ä»¶çš„ä¼ªç›®æ ‡ï¼ˆphony targetï¼‰ã€‚

å½“ Makefile æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å®šä¹‰çš„ç›®æ ‡æ˜¯å¦å·²ç»å­˜åœ¨æˆ–æ˜¯å¦éœ€è¦æ›´æ–°ã€‚å¯¹äºä¼ªç›®æ ‡ï¼Œç”±äºå®ƒä»¬ä¸è¡¨ç¤ºä»»ä½•å®é™…æ–‡ä»¶ï¼Œå› æ­¤ Makefile æ— æ³•æ£€æŸ¥å®ƒä»¬æ˜¯å¦å·²ç»å­˜åœ¨æˆ–æ˜¯å¦éœ€è¦æ›´æ–°ã€‚ä¸ºäº†é¿å…è¯¯åˆ¤ï¼Œ**å¯ä»¥ä½¿ç”¨ `.PHONY` æ¥æ˜ç¡®å‘Šè¯‰ Makefile å“ªäº›ç›®æ ‡æ˜¯ä¼ªç›®æ ‡ï¼Œä»¥ä¾¿åœ¨æ‰§è¡Œæ—¶è·³è¿‡å¯¹è¿™äº›ç›®æ ‡çš„æ£€æŸ¥ã€‚**

ä¾‹å¦‚ï¼Œå‡è®¾ Makefile ä¸­å®šä¹‰äº†ä¸€ä¸ª clean ç›®æ ‡ç”¨äºåˆ é™¤ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä½†æ˜¯ clean å¹¶ä¸è¡¨ç¤ºä»»ä½•å®é™…çš„æ–‡ä»¶ï¼Œåªæ˜¯ä¸€ä¸ªä¼ªç›®æ ‡ã€‚é‚£ä¹ˆï¼Œä¸ºäº†ç¡®ä¿ Makefile åœ¨æ‰§è¡Œæ—¶ä¸ä¼šå°† clean å½“æˆä¸€ä¸ªæ–‡ä»¶æ¥æ£€æŸ¥ï¼Œå¯ä»¥åœ¨ Makefile ä¸­æ·»åŠ å¦‚ä¸‹å£°æ˜ï¼š

```makefile
.PHONY: clean

clean:
    rm -f *.o myprogram
```

> è¿™æ ·ï¼Œå½“æ‰§è¡Œ "make clean" å‘½ä»¤æ—¶ï¼ŒMakefile ä¼šè·³è¿‡å¯¹ clean ç›®æ ‡çš„æ–‡ä»¶æ£€æŸ¥ï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†å‘½ä»¤ã€‚åŒæ—¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ Makefile ä¸­å®šä¹‰äº†ä¸€ä¸ªä¸ clean ç›¸åŒåå­—çš„æ–‡ä»¶ï¼ŒMakefile ä¹Ÿä¸ä¼šå°†å…¶ä¸ clean ç›®æ ‡æ··æ·†ã€‚å› æ­¤ï¼Œä½¿ç”¨ `.PHONY` å£°æ˜ä¼ªç›®æ ‡å¯ä»¥æé«˜ Makefile çš„å¯è¯»æ€§å’Œå¯é æ€§ã€‚

**é»˜è®¤æƒ…å†µä¸‹**ï¼Œå¦‚æœä¸€ä¸ªå‰ç½®æ¡ä»¶æˆ–æ˜¯ç›®å½•æ–‡ä»¶å·²æ›´æ”¹ï¼Œ`make`å°†æ‰§è¡Œè§„åˆ™ã€‚ä½†æ˜¯ç”±äºæˆ‘ä»¬ä¸ä¾èµ–äº`make`æ¥æ£€æµ‹æ–‡ä»¶æ›´æ”¹çš„èƒ½åŠ›ï¼Œå› æ­¤æˆ‘ä»¬ä¼šé‡åˆ°æ½œåœ¨çš„éº»çƒ¦ã€‚

å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®ç›®å½•ä¸­æœ‰ä¸€ä¸ªåä¸º `build` çš„æ–‡ä»¶, åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå½“ä½ æ‰§è¡Œ`make build`, makeä¸€å®šä¼šæ£€æŸ¥æ–‡ä»¶buildçš„æ›´æ”¹ï¼Œç”±äºæ²¡æœ‰å‰ç½®æ¡ä»¶ï¼Œå› æ­¤å°†å§‹ç»ˆå°†`build`æ–‡ä»¶è§†ä¸ºæœ€æ–°çš„ï¼Œå¹¶ä¸”ä¸ä¼šæ‰§è¡Œå…¶è§„åˆ™å®šä¹‰çš„æ“ä½œã€‚

ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½ éœ€è¦å…ˆçŸ¥é“`.PHONY` ç‰¹æ®Šç›®å½•(target)æ˜¯ä»€ä¹ˆæ„æ€ï¼š**ç‰¹æ®Šç›®æ ‡`.PHONY`çš„å…ˆå†³æ¡ä»¶è¢«è§†ä¸ºphonyç›®æ ‡ï¼ˆtargets)ã€‚ å½“éœ€è¦è¿è¡Œæ—¶ï¼Œmakeä¼šæ— æ¡ä»¶è¿è¡Œå…¶è§„åˆ™ï¼Œè€Œä¸ç®¡è¯¥åç§°çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–å…¶æœ€åä¿®æ”¹æ—¶é—´æ˜¯å¤šå°‘ã€‚**

æ‰€ä»¥ï¼Œä½ å¯ä»¥é€šè¿‡å°†ç›®æ ‡ï¼ˆtargetï¼‰æŒ‡å®šä¸ºç‰¹æ®Šç›®æ ‡`.PHONY`çš„å…ˆå†³æ¡ä»¶ï¼Œå°†ç›®æ ‡æŒ‡å®šä¸º`.PHONY`ã€‚

```makefile
APP=stringifier

.PHONY: build
build: clean
	go build -o ${APP} main.go

.PHONY: run
run:
	go run -race main.go

.PHONY: clean
clean:
	go clean
```

ç°åœ¨ä½ å·²å°†ä¸Šè¿°æ‰€æœ‰çš„`targets`æŒ‡å®šä¸º`phony`, æ¯æ¬¡ä½ è°ƒç”¨ä»»ä½•`phony`ç›®æ ‡ï¼ˆtarget) æ—¶ï¼Œmakeå°†ä¼šæ‰§è¡Œç›¸åº”çš„è§„åˆ™ã€‚ä½ è¿˜å¯ä»¥ä¸€æ¬¡å°†æ‰€æœ‰è¦æŒ‡å®šä¸º`phony`çš„ç›®æ ‡æŒ‡å®šä¸º:

```makefile
.PHONY: build clean run
```

ä½†æ˜¯å¯¹äºéå¸¸å¤§çš„Makefileï¼Œä¸å»ºè®®è¿™æ ·åšå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ­§ä¹‰å’Œæ— æ³•è¯»å–ã€‚å› æ­¤ï¼Œé¦–é€‰æ–¹æ³•æ˜¯åœ¨è§„åˆ™å®šä¹‰ä¹‹å‰æ˜¾å¼è®¾ç½®`phony`ç›®æ ‡ï¼ˆtargetï¼‰ã€‚



### Recursive Make targets

å½“ Makefile åŒ…å«å¤šä¸ªç›®æ ‡æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Makefile ä¸­ä½¿ç”¨é€’å½’ Make æ¥æ„å»ºè¿™äº›ç›®æ ‡ã€‚é€’å½’ Make æŒ‡çš„æ˜¯åœ¨ Makefile ä¸­è°ƒç”¨å¦ä¸€ä¸ª Makefile æ¥æ„å»ºå…¶ä¸­çš„ç›®æ ‡ã€‚

åœ¨é€’å½’ Make ä¸­ï¼Œé€šå¸¸æœ‰ä¸€ä¸ªé¡¶å±‚ Makefileï¼Œè¯¥ Makefile è°ƒç”¨å…¶ä»– Makefile æ¥æ„å»ºå­ç›®å½•ä¸­çš„ç›®æ ‡ã€‚è¿™æ ·çš„ Makefile è¢«ç§°ä¸º "é€’å½’ Makefile"ï¼Œè€Œç”±è¿™ä¸ª Makefile è°ƒç”¨çš„ Makefile è¢«ç§°ä¸º "å­ Makefile"ã€‚

åœ¨é€’å½’ Make ä¸­ï¼Œæ¯ä¸ªå­ Makefile è´Ÿè´£æ„å»ºå®ƒæ‰€åœ¨çš„ç›®å½•ä¸­çš„ç›®æ ‡ï¼Œç„¶åå°†æ„å»ºçš„ç»“æœè¿”å›ç»™çˆ¶ Makefileã€‚é€’å½’ Make çš„ä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯ï¼Œå½“åœ¨å­ç›®å½•ä¸­è°ƒç”¨ Make å‘½ä»¤æ—¶ï¼Œå¯èƒ½ä¼šç ´åçˆ¶ç›®å½•ä¸­çš„å˜é‡è®¾ç½®å’Œè§„åˆ™ï¼Œå› æ­¤éœ€è¦å°å¿ƒåœ°è®¾ç½®å˜é‡å’Œè§„åˆ™ï¼Œä»¥é¿å…ä¸å¿…è¦çš„å†²çªã€‚

é€’å½’ Make çš„ä¸€ç§å¸¸è§ç”¨æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªç§°ä¸ºâ€œé€’å½’å˜é‡â€çš„ç‰¹æ®Šå˜é‡ã€‚é€’å½’å˜é‡çš„å€¼å¯ä»¥åŒ…å«è°ƒç”¨å¦ä¸€ä¸ª Makefile çš„å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šè¿”å›ä¸€ä¸ªå€¼ï¼Œå¯ä»¥è¢«é€’å½’å˜é‡ä½¿ç”¨ã€‚é€’å½’å˜é‡åœ¨é€’å½’ Make ä¸­éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥å¸®åŠ©å­ Makefile è·å¾—çˆ¶ Makefile ä¸­çš„å˜é‡å€¼ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º "Makefile" çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š

```makefile
codeSUBDIRS = foo bar baz

.PHONY: all $(SUBDIRS)

all: $(SUBDIRS)

$(SUBDIRS):
    $(MAKE) -C $@
```

åœ¨ä¸Šé¢çš„ Makefile ä¸­ï¼Œ"SUBDIRS" å˜é‡å®šä¹‰äº†é¡¹ç›®çš„å­ç›®å½•åç§°ã€‚"all" æ˜¯ä¸€ä¸ªä¼ªç›®æ ‡ï¼Œå®ƒå°†è°ƒç”¨æ¯ä¸ªå­ç›®å½•ä¸­çš„ Makefile æ¥æ„å»ºæ‰€æœ‰ç›®æ ‡ã€‚

$(SUBDIRS) æ˜¯ä¸€ä¸ªè‡ªåŠ¨å˜é‡ï¼Œå®ƒä¼šå±•å¼€ä¸º "foo bar baz"ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è¿è¡Œ "make all" å‘½ä»¤æ—¶ï¼Œå®ƒå°†é¦–å…ˆè°ƒç”¨ "make foo"ï¼Œç„¶ååœ¨ "foo" ç›®å½•ä¸­è¿è¡Œ "make" å‘½ä»¤æ¥æ„å»º "foo" ç›®å½•ä¸­çš„ç›®æ ‡ã€‚æ¥ç€å®ƒä¼šä¾æ¬¡è°ƒç”¨ "make bar" å’Œ "make baz" å‘½ä»¤ï¼Œä»¥æ­¤ç±»æ¨ã€‚

åœ¨å­ç›®å½•çš„ Makefile ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å’Œæ™®é€š Makefile ä¸­ä¸€æ ·çš„è§„åˆ™å’Œå˜é‡å®šä¹‰æ¥æ„å»ºå­ç›®å½•ä¸­çš„ç›®æ ‡ã€‚è¿™ç§æ–¹å¼å¯ä»¥å¸®åŠ©æˆ‘ä»¬è½»æ¾åœ°ç®¡ç†å¤æ‚çš„é¡¹ç›®ï¼Œé¿å…ä»£ç é‡å¤ï¼Œå¹¶æé«˜ Makefile çš„å¯é‡ç”¨æ€§ã€‚

ç°åœ¨è®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„æ ¹ç›®å½•ä¸­è¿˜æœ‰å¦ä¸€ä¸ªæ¨¡å—`tokenizer`ã€‚ç°åœ¨æˆ‘ä»¬çš„ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

```bash
~/programming/stringifier
.
â”œâ”€â”€ main.go
â”œâ”€â”€ Makefile
â””â”€â”€ tokenizer/
      â”œâ”€â”€ main.go
      â””â”€â”€ Makefile~/programming/stringifier
```

å¾ˆè‡ªç„¶ï¼ŒæŸäº›æ—¶å€™æˆ‘ä»¬ä¹Ÿæƒ³`build`å’Œ`test`æˆ‘ä»¬çš„`tokenizer`æ¨¡å—ã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ¨¡å—ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®ï¼Œåœ¨å®ƒçš„ç›®å½•æœ‰å¦‚ä¸‹å†…å®¹çš„ä¸€ä¸ª`Makefile`æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼š

```makefile
# ~/programming/stringifier/tokenizer/Makefile

APP=tokenizer

build:
	go build -o ${APP} main.go
```

ç°åœ¨åªè¦æ‚¨åœ¨`stringifier`é¡¹ç›®çš„æ ¹ç›®å½•ä¸­å¹¶ä¸”æƒ³è¦æ„å»º`tokenizer`åº”ç”¨ç¨‹åºï¼Œä½ ä¸ä¼šæƒ³ä½¿ç”¨è¯¸å¦‚`cd tokenizer && make build && cd - `è¿™æ ·çš„æ˜“å—æ”»å‡»çš„å‘½ä»¤è¡ŒæŠ€å·§ï¼Œè€Œå…·ä½“çš„`Makefiles`çš„è§„åˆ™å†™åœ¨å­ç›®å½•ä¸­çš„æ–¹å¼ã€‚å¹¸è¿çš„æ˜¯ï¼Œ`make`å¯ä»¥å¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä½ å¯ä»¥ä½¿ç”¨`-C`æ ‡å¿—å’Œç‰¹æ®Šçš„`${NAME}`å˜é‡åœ¨å…¶ä»–ç›®å½•ä¸­è°ƒç”¨`make targets`ã€‚ä¸‹é¢æ˜¯`stringifies`é¡¹ç›®æœ€åˆçš„Makefile:

```makefile
# ~/programming/stringifier/Makefile

APP=stringifier


.PHONY: build
build: clean
	go build -o ${APP} main.go

.PHONY: run
run:
	go run -race main.go

.PHONY: clean
clean:
	go clean

.PHONY: build-tokenizer
build-tokenizer:
	${MAKE} -C tokenizer build
```

ç°åœ¨åªè¦ä½ è¿è¡Œ`make build-tokenizer`ï¼Œ`make`éƒ½å°†ä¸ºæ‚¨å¤„ç†ç›®å½•åˆ‡æ¢ï¼Œå¹¶ä»¥æ›´åŠ å¯è¯»å’Œå¥å£®çš„æ–¹å¼ä¸ºæ‚¨è°ƒç”¨æ­£ç¡®ç›®å½•ä¸­çš„æ­£ç¡®ç›®æ ‡

**`-c` æ ‡å¿—å’Œç‰¹æ®Šçš„ `${NAME}`:**

1. `-C` æ ‡å¿—ï¼šæŒ‡å®š Makefile æ–‡ä»¶çš„ç›®å½•ï¼Œè®© make å‘½ä»¤åœ¨æŒ‡å®šçš„ç›®å½•ä¸‹æ‰§è¡Œ Makefile æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š

   ```makefile
   all:
        cd subdir && $(MAKE)
   ```

   ä¸Šè¿° Makefile ä¸­çš„ `$(MAKE)` å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹çš„ `subdir` ç›®å½•ä¸­æ‰§è¡Œ Makefile æ–‡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ `-C` æ ‡å¿—æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼š

   ```makefile
   all:
        $(MAKE) -C subdir
   ```

2. `${NAME}` å˜é‡ï¼šåœ¨ Makefile ä¸­ä½¿ç”¨ `${NAME}` å˜é‡å¯ä»¥å¼•ç”¨ç¯å¢ƒå˜é‡ä¸­çš„å€¼ï¼Œä¾‹å¦‚ï¼š

   ```makefile
   all:
        echo "PATH is ${PATH}"
   ```

   ä¸Šè¿° Makefile ä¸­çš„ `${PATH}` å˜é‡ä¼šå±•å¼€ä¸ºå½“å‰ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­çš„ `PATH` å€¼ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„ Makefile ç¤ºä¾‹ï¼Œå…¶ä¸­ä½¿ç”¨äº† `-C` æ ‡å¿—å’Œ `${NAME}` å˜é‡ï¼š

```makefile
# Makefile

APP_NAME := my-app

.PHONY: build
build:
    cd cmd/my-app && go build -o ../../bin/$(APP_NAME)

.PHONY: test
test:
    go test ./...

.PHONY: clean
clean:
    rm -rf bin/*

.PHONY: build-docker
build-docker: build
    docker build -t $(APP_NAME) .

.PHONY: run-docker
run-docker: build-docker
    docker run -p 8080:8080 $(APP_NAME)

.PHONY: deploy
deploy: build-docker
    ssh ${SSH_USER}@${SSH_HOST} "docker pull $(APP_NAME); docker stop $(APP_NAME) || true; docker rm $(APP_NAME) || true; docker run -p 8080:8080 -d --name $(APP_NAME) $(APP_NAME)"
```

ä¸Šè¿° Makefile ä¸­ï¼Œ`build-docker`ã€`run-docker` å’Œ `deploy` ç­‰ç›®æ ‡ä¸­ä½¿ç”¨äº† `${APP_NAME}` å˜é‡æ¥æŒ‡å®š Docker é•œåƒçš„åç§°ï¼ŒåŒæ—¶ä½¿ç”¨äº† `-C` æ ‡å¿—æ¥åœ¨å­ç›®å½•ä¸­æ‰§è¡Œå‘½ä»¤ï¼Œä¾‹å¦‚ `build` ç›®æ ‡ä¸­çš„ `cd cmd/my-app && go build` å‘½ä»¤ã€‚



### Targets for Docker commands

ç°åœ¨æ‚¨å¸Œæœ›å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œå®¹å™¨åŒ–ï¼Œç„¶åä¸ºæ–¹ä¾¿èµ·è§ç¼–å†™makeç›®æ ‡ï¼Œè¿™æ˜¯å®Œå…¨å¯ä»¥ç†è§£çš„ã€‚

ä½ ä¸ºdockerå‘½ä»¤å®šä¹‰äº†å¦‚ä¸‹è§„åˆ™ï¼š

```makefile
.PHONY: docker-build
docker-build: build
	docker build -t stringifier .
	docker tag stringifier stringifier:tag

.PHONY: docker-push
docker-push: docker-build
	docker push gcr.io/stringifier/stringifier-staging/stringifier:tag
```

dockerå‘½ä»¤åŸºæœ¬æ»¡è¶³éœ€è¦ï¼Œä½†æ˜¯è¿˜æœ‰æ”¹å–„çš„ç©ºé—´ï¼Œ

+ å¯¹äºæ–°æ‰‹ï¼Œä½ å¯ä»¥å†æ¬¡é‡ç”¨ä½ çš„`${APP}`å˜é‡ã€‚
+ æ¥ä¸‹æ¥ï¼Œæ‚¨æƒ³è¦æ›´çµæ´»å¹¶ç¡®ä¿å¯ä»¥è½»æ¾æ§åˆ¶å°†æ˜ åƒæ¨é€åˆ°å“ªé‡Œï¼Œæ— è®ºæ˜¯æ‚¨çš„ç§äººé•œåƒä»“åº“è¿˜æ˜¯å…¶ä»–åœ°æ–¹ã€‚
+ ç„¶åï¼Œæ‚¨å¸Œæœ›èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸Šçš„æŸäº›è¾“å…¥å°†é•œåƒï¼ˆimageï¼‰åˆ†åˆ«æ¨é€åˆ°ä¸é¢„ç”Ÿäº§å’Œç”Ÿäº§ç¯å¢ƒæœ‰å…³çš„ä¸¤ä¸ªå•ç‹¬çš„é•œåƒä»“åº“ä¸­ã€‚
+ æœ€åï¼Œåƒä¸€ä¸ªç†æ™ºçš„å¼€å‘äººå‘˜ä¸€æ ·ï¼Œæ‚¨æƒ³ä½¿ç”¨å½“å‰çš„git commit shaæ ‡è®°æ‚¨çš„é•œåƒï¼ˆimageï¼‰ã€‚ è®©æˆ‘ä»¬åŸºäºè¿™äº›é—®é¢˜é‡æ–°ä¿®æ”¹ä¸‹`Makefile`ï¼š

```makefile
APP?=application
REGISTRY?=gcr.io/images
COMMIT_SHA=$(shell git rev-parse --short HEAD)

.PHONY: docker-build
docker-build: build
	docker build -t ${APP} .
	docker tag ${APP} ${APP}:${COMMIT_SHA}

.PHONY: docker-push
docker-push: check-environment docker-build
	docker push ${REGISTRY}/${ENV}/${APP}:${COMMIT_SHA}

check-environment:
ifndef ENV
    $(error ENV not set, allowed values - `staging` or `production`)
endif
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸‹ä¸Šé¢çš„æ›´æ”¹ï¼š

+ ä½ å¼€å§‹ä¸ºåº”ç”¨ç¨‹åºåç§°ï¼Œé•œåƒåç§°,æäº¤shaä½¿ç”¨å˜é‡ã€‚
+ æ‚¨ä½¿ç”¨ç‰¹æ®Šçš„shellå‡½æ•°ç”Ÿæˆäº†commit shaã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨è¿è¡Œäº†gitå‘½ä»¤ï¼Œè¯¥å‘½ä»¤è¿”å›äº†ç®€çŸ­çš„æäº¤shaï¼Œå¹¶å°†å…¶åˆ†é…ç»™å˜é‡`${COMMIT_SHA}`ï¼Œä»¥ä¾¿ç¨ååœ¨Makefileä¸­ä½¿ç”¨ã€‚
+ æ‚¨æ·»åŠ äº†ä¸€ä¸ªæ–°çš„è§„åˆ™`check-environment`ï¼Œè¯¥ç¯å¢ƒä½¿ç”¨makeæ¡ä»¶æ£€æŸ¥åœ¨è°ƒç”¨makeæ—¶æ˜¯å¦æŒ‡å®šäº†`ENV`å˜é‡ï¼Œè¿™æœ‰åŠ©äºåŒºåˆ†é¢„ç”Ÿäº§åŠç”Ÿäº§ç¯å¢ƒã€‚

`check-environment`çš„è§„åˆ™å¦‚ä¸‹ï¼š

```makefile
check-environment:
ifndef ENV
    $(error ENV not set, allowed values - `staging` or `production`)
endif
```

ä½¿ç”¨`ifndef`æŒ‡ä»¤æ£€æŸ¥å˜é‡ENVæ˜¯å¦ä¸ºç©ºå€¼ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨å¦ä¸€ä¸ªmakeçš„æä¾›å†…ç½®å‡½æ•°ï¼Œå¦‚æœå‡ºé”™äº†ï¼Œå°†ä¼šåœ¨å…³é”®å­—ä¹‹åæŠ›å‡ºå…·ä½“çš„é”™è¯¯æ¶ˆæ¯ã€‚

```sh
$ make docker-push
Makefile:33: *** ENV not set, allowed values - `staging` or `production`.  Stop.

$ ENV=staging make docker-push
Success
```

æœ¬è´¨ä¸Šï¼Œæ‚¨è¦ç¡®ä¿docker-pushç›®æ ‡å…·æœ‰å®‰å…¨ä¿éšœï¼Œè¯¥ä¿éšœå¯æ£€æŸ¥è°ƒç”¨ç›®æ ‡çš„ç”¨æˆ·æ˜¯å¦å·²ä¸ºENVå˜é‡æŒ‡å®šå€¼ã€‚



### @ ç¬¦å·

é¡¹ç›®çš„ `makefile` ä¸­å¾ˆå®¹æ˜“çœ‹åˆ° @ ç¬¦å·çš„å­˜åœ¨ï¼Œå®ƒçš„æ„ä¹‰ä¸åŒå¯»å¸¸ï¼š

```makefile
## build: Build source code for host platform.
.PHONY: build
build:
	@$(MAKE) go.build
```

åœ¨Makefileä¸­ï¼Œ@ç¬¦å·ç”¨äº **æŠ‘åˆ¶Makeå‘½ä»¤çš„è¾“å‡º**ã€‚å½“åœ¨Makefileä¸­ä½¿ç”¨@ç¬¦å·æ—¶ï¼Œ**Makeå°†ä¸ä¼šæ‰“å°å‡ºè¯¥è¡Œå‘½ä»¤çš„è¾“å‡ºç»“æœï¼Œè€Œæ˜¯ä»…ä»…æ‰§è¡Œè¯¥å‘½ä»¤ã€‚**

åœ¨Goè¯­è¨€é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨Makefileæ¥æ„å»ºå’Œç®¡ç†é¡¹ç›®ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Goè¯­è¨€é¡¹ç›®Makefileç¤ºä¾‹ï¼š

```makefile
# ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶
build:
    @go build -o myapp main.go

# è¿è¡Œç¨‹åº
run:
    @./myapp

# æ¸…ç†
clean:
    @rm -f myapp
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªMakefileå‘½ä»¤ï¼š`build`ï¼Œ`run`å’Œ`clean`ã€‚åœ¨æ¯ä¸ªå‘½ä»¤çš„å‰é¢ï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨äº†`@`ç¬¦å·æ¥æŠ‘åˆ¶å‘½ä»¤çš„è¾“å‡ºã€‚è¿™æ„å‘³ç€ï¼Œå½“æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ`make build`æ—¶ï¼ŒMakeå‘½ä»¤å°†ä¼šç¼–è¯‘Goç¨‹åºï¼Œä½†ä¸ä¼šå°†ç¼–è¯‘å™¨çš„è¾“å‡ºæ‰“å°åˆ°ç»ˆç«¯ã€‚

å¦‚æœæˆ‘ä»¬å»æ‰`@`ç¬¦å·ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è¿è¡Œ`make build`æ—¶ï¼ŒMakeå°†ä¼šè¾“å‡ºç¼–è¯‘å™¨çš„è¾“å‡ºï¼Œç±»ä¼¼äºä¸‹é¢çš„ç»“æœï¼š

```bash
go build -o myapp main.go
# è¾“å‡ºç¼–è¯‘å™¨çš„è¾“å‡º
```

å› æ­¤ï¼Œä½¿ç”¨`@`ç¬¦å·å¯ä»¥ä½¿Makefileè¾“å‡ºæ›´åŠ å¹²å‡€ï¼Œä»…ä»…æ‰“å°å‡ºæˆ‘ä»¬å…³å¿ƒçš„å†…å®¹ï¼Œè€Œä¸ä¼šè¾“å‡ºä¸€å †ä¸å¿…è¦çš„ä¿¡æ¯ã€‚



### æ–‡ä»¶æœç´¢ VPATH

åœ¨ä¸€äº›å¤§çš„å·¥ç¨‹ä¸­ï¼Œæœ‰å¤§é‡çš„æºæ–‡ä»¶ï¼Œæˆ‘ä»¬é€šå¸¸çš„åšæ³•æ˜¯æŠŠè¿™è®¸å¤šçš„æºæ–‡ä»¶åˆ†ç±»ï¼Œå¹¶å­˜æ”¾åœ¨ä¸åŒçš„ç›®å½•ä¸­ã€‚æ‰€ä»¥ï¼Œå½“makeéœ€è¦å»æ‰¾å¯»æ–‡ä»¶çš„ä¾èµ–å…³ç³»æ—¶ï¼Œä½ å¯ä»¥åœ¨æ–‡ä»¶å‰åŠ ä¸Šè·¯å¾„ï¼Œä½†æœ€å¥½çš„æ–¹æ³•æ˜¯æŠŠä¸€ä¸ªè·¯å¾„å‘Šè¯‰makeï¼Œè®©makeåœ¨è‡ªåŠ¨å»æ‰¾ã€‚

Makefileæ–‡ä»¶ä¸­çš„ç‰¹æ®Šå˜é‡ `VPATH` å°±æ˜¯å®Œæˆè¿™ä¸ªåŠŸèƒ½çš„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡æ˜è¿™ä¸ªå˜é‡ï¼Œmakeåªä¼šåœ¨å½“å‰çš„ç›®å½•ä¸­å»æ‰¾å¯»ä¾èµ–æ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶ã€‚å¦‚æœå®šä¹‰äº†è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆï¼Œmakeå°±ä¼šåœ¨å½“å‰ç›®å½•æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹ï¼Œåˆ°æ‰€æŒ‡å®šçš„ç›®å½•ä¸­å»æ‰¾å¯»æ–‡ä»¶äº†ã€‚

```bash
VPATH = src:../headers
```

ä¸Šé¢çš„å®šä¹‰æŒ‡å®šä¸¤ä¸ªç›®å½•ï¼Œâ€œsrcâ€å’Œâ€œ`../headers`â€ï¼Œ`make`ä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæœç´¢ã€‚ç›®å½•ç”±â€œå†’å·â€åˆ†éš”ã€‚ï¼ˆå½“ç„¶ï¼Œå½“å‰ç›®å½•æ°¸è¿œæ˜¯æœ€é«˜ä¼˜å…ˆæœç´¢çš„åœ°æ–¹ï¼‰

å¦ä¸€ä¸ªè®¾ç½®æ–‡ä»¶æœç´¢è·¯å¾„çš„æ–¹æ³•æ˜¯ä½¿ç”¨makeçš„â€œvpathâ€å…³é”®å­—ï¼ˆæ³¨æ„ï¼Œå®ƒæ˜¯å…¨å°å†™çš„ï¼‰ï¼Œè¿™ä¸æ˜¯å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ªmakeçš„å…³é”®å­—ï¼Œè¿™å’Œä¸Šé¢æåˆ°çš„é‚£ä¸ªVPATHå˜é‡å¾ˆç±»ä¼¼ï¼Œä½†æ˜¯å®ƒæ›´ä¸ºçµæ´»ã€‚å®ƒå¯ä»¥æŒ‡å®šä¸åŒçš„æ–‡ä»¶åœ¨ä¸åŒçš„æœç´¢ç›®å½•ä¸­ã€‚è¿™æ˜¯ä¸€ä¸ªå¾ˆçµæ´»çš„åŠŸèƒ½ã€‚å®ƒçš„ä½¿ç”¨æ–¹æ³•æœ‰ä¸‰ç§ï¼š

```
vpath <pattern> <directories>
```

ä¸ºç¬¦åˆæ¨¡å¼`<pattern>`çš„æ–‡ä»¶æŒ‡å®šæœç´¢ç›®å½•`<directories>`ã€‚

```
vpath <pattern>
```

æ¸…é™¤ç¬¦åˆæ¨¡å¼`<pattern>`çš„æ–‡ä»¶çš„æœç´¢ç›®å½•ã€‚

```
vpath
```

æ¸…é™¤æ‰€æœ‰å·²è¢«è®¾ç½®å¥½äº†çš„æ–‡ä»¶æœç´¢ç›®å½•ã€‚



### Help target

ä¸€ä¸ªæ–°æˆå‘˜åŠ å…¥äº†è¯¥é¡¹ç›®å¹¶æƒ³çŸ¥é“Makefileä¸­æ‰€æœ‰è§„åˆ™çš„ä½œç”¨ï¼Œä¸ºå¸®åŠ©å®ƒä»¬æ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªæ–°ç›®æ ‡(target)ï¼Œè¯¥ç›®æ ‡å°†æ‰“å°æ‰€æœ‰ç›®æ ‡åç§°ä»¥åŠå®ƒä»¬ä½œç”¨çš„ç®€çŸ­æè¿°:

```makefile
.PHONY: build
## build: build the application
build: clean
    @echo "Building..."
    @go build -o ${APP} main.go

.PHONY: run
## run: runs go run main.go
run:
	go run -race main.go

.PHONY: clean
## clean: cleans the binary
clean:
    @echo "Cleaning"
    @go clean

.PHONY: setup
## setup: setup go modules
setup:
	@go mod init \
		&& go mod tidy \
		&& go mod vendor
	
.PHONY: help
## help: prints this help message
help:
	@echo "Usage: \n"
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' |  sed -e 's/^/ /'
```

ä½ å…ˆæ³¨æ„ä¸‹æœ€åä¸€æ¡è§„åˆ™ï¼Œ`help` åœ¨è¿™é‡Œï¼Œæ‚¨åªæ˜¯ä½¿ç”¨ä¸€äº›sedé­”æœ¯æ¥è§£æå’Œåœ¨å‘½ä»¤è¡Œä¸Šæ‰“å°ã€‚ ä½†æ˜¯è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ‚¨å¿…è¦åœ¨æ¯æ¡è§„åˆ™ä¹‹å‰å†™äº†ç›®æ ‡åç§°å’Œç®€çŸ­æè¿°ä½œä¸ºæ³¨é‡Šã€‚ æ³¨æ„å¦ä¸€ä¸ªç‰¹æ®Šå˜é‡`$ {MAKEFILE_LIST}`ï¼Œå®ƒæ˜¯æ‚¨æ‰€å¼•ç”¨çš„æ‰€æœ‰Makefileçš„åˆ—è¡¨ï¼Œåœ¨æœ¬ä¾‹ä¸­ä»…æ˜¯Makefileã€‚

æ‚¨ä¼šå°†æ–‡ä»¶Makefileä½œä¸ºè¾“å…¥ä¼ é€’ç»™sedå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†è§£ææ‰€æœ‰å¸®åŠ©æ³¨é‡Šå¹¶ä»¥è¡¨æ ¼æ ¼å¼å°†å…¶æ‰“å°åˆ°stdoutï¼Œä»¥ä¾¿äºé˜…è¯»ã€‚ ä¸Šä¸€ä¸ªä»£ç æ®µçš„`help`ç›®æ ‡çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š

```sh
$ make help
Usage:
	build             Build the application
	clean             cleans the binary
	run               runs go run main.go
	docker-build      builds docker image
	docker-push       pushes the docker image
	setup             set up modules
	help              prints this help message
```

è¿™äº›æ¶ˆæ¯å¾ˆæœ‰å¸®åŠ©ï¼Œå¯¹äºå…¶ä»–äººç”šè‡³æœ‰æ—¶å¯¹è‡ªå·±éƒ½æ˜¯ä¸€ä¸ªä¸é”™çš„æç¤ºã€‚

### Conclusion ç»“è®º

Makeæ˜¯ä¸€ä¸ªç®€å•ä½†å¯é«˜åº¦é…ç½®çš„å·¥å…·ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨éå†äº†makeæä¾›çš„è®¸å¤šé…ç½®å’ŒåŠŸèƒ½ï¼Œä»è€Œä¸ºGoåº”ç”¨ç¨‹åºç¼–å†™äº†æœ‰æ•ˆè€Œé«˜æ•ˆçš„Makefileã€‚

ä¸‹é¢æ˜¯å®Œæ•´çš„Makefileï¼Œå…¶ä¸­æ·»åŠ äº†ä¸€äº›çç¢çš„è§„åˆ™å’Œå˜é‡ï¼š

```makefile
GO111MODULES=on
APP?=stringifier
REGISTRY?=gcr.io/images
COMMIT_SHA=$(shell git rev-parse --short HEAD)



.PHONY: build
## build: build the application
build: clean
    @echo "Building..."
    @go build -o ${APP} main.go

.PHONY: run
## run: runs go run main.go
run:
	go run -race main.go

.PHONY: clean
## clean: cleans the binary
clean:
    @echo "Cleaning"
    @go clean

.PHONY: test
## test: runs go test with default values
test:
	go test -v -count=1 -race ./...


.PHONY: build-tokenizer
## build-tokenizer: build the tokenizer application
build-tokenizer:
	${MAKE} -c tokenizer build

.PHONY: setup
## setup: setup go modules
setup:
	@go mod init \
		&& go mod tidy \
		&& go mod vendor
	
# helper rule for deployment
check-environment:
ifndef ENV
    $(error ENV not set, allowed values - `staging` or `production`)
endif

.PHONY: docker-build
## docker-build: builds the stringifier docker image to registry
docker-build: build
	docker build -t ${APP}:${COMMIT_SHA} .

.PHONY: docker-push
## docker-push: pushes the stringifier docker image to registry
docker-push: check-environment docker-build
	docker push ${REGISTRY}/${ENV}/${APP}:${COMMIT_SHA}

.PHONY: help
## help: Prints this help message
help:
	@echo "Usage: \n"
	@sed -n 's/^##//p' ${MAKEFILE_LIST} | column -t -s ':' |  sed -e 's/^/ /'
```



## ç†Ÿç»ƒmakefileè¯­æ³•

**IAM é¡¹ç›®çš„ Makefile æ–‡ä»¶ï¼š**

```bash
$ make help

Usage: make <TARGETS> <OPTIONS> ...

Targets:
  # ä»£ç ç”Ÿæˆç±»å‘½ä»¤
  gen                Generate all necessary files, such as error code files.

  # æ ¼å¼åŒ–ç±»å‘½ä»¤
  format             Gofmt (reformat) package sources (exclude vendor dir if existed).

  # é™æ€ä»£ç æ£€æŸ¥
  lint               Check syntax and styling of go sources.

  # æµ‹è¯•ç±»å‘½ä»¤
  test               Run unit test.
  cover              Run unit test and get test coverage.

  # æ„å»ºç±»å‘½ä»¤
  build              Build source code for host platform.
  build.multiarch    Build source code for multiple platforms. See option PLATFORMS.

  # Dockeré•œåƒæ‰“åŒ…ç±»å‘½ä»¤
  image              Build docker images for host arch.
  image.multiarch    Build docker images for multiple platforms. See option PLATFORMS.
  push               Build docker images for host arch and push images to registry.
  push.multiarch     Build docker images for multiple platforms and push images to registry.

  # éƒ¨ç½²ç±»å‘½ä»¤
  deploy             Deploy updated components to development env.

  # æ¸…ç†ç±»å‘½ä»¤
  clean              Remove all files that are created by building.

  # å…¶ä»–å‘½ä»¤ï¼Œä¸åŒé¡¹ç›®ä¼šæœ‰åŒºåˆ«
  release            Release iam
  verify-copyright   Verify the boilerplate headers for all files.
  ca                 Generate CA files for all iam components.
  install            Install iam system with all its components.
  swagger            Generate swagger document.
  tools              install dependent tools.

  # å¸®åŠ©å‘½ä»¤
  help               Show this help info.

# é€‰é¡¹
Options:
  DEBUG        Whether to generate debug symbols. Default is 0.
  BINS         The binaries to build. Default is all of cmd.
               This option is available when using: make build/build.multiarch
               Example: make build BINS="iam-apiserver iam-authz-server"
  ...
```

é€šå¸¸è€Œè¨€ï¼ŒGo é¡¹ç›®çš„ Makefile åº”è¯¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼šæ ¼å¼åŒ–ä»£ç ã€é™æ€ä»£ç æ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€ä»£ç æ„å»ºã€æ–‡ä»¶æ¸…ç†ã€å¸®åŠ©ç­‰ç­‰ã€‚å¦‚æœé€šè¿‡ docker éƒ¨ç½²ï¼Œè¿˜éœ€è¦æœ‰ docker é•œåƒæ‰“åŒ…åŠŸèƒ½ã€‚å› ä¸º Go æ˜¯è·¨å¹³å°çš„è¯­è¨€ï¼Œæ‰€ä»¥æ„å»ºå’Œ docker æ‰“åŒ…å‘½ä»¤ï¼Œè¿˜è¦èƒ½å¤Ÿæ”¯æŒä¸åŒçš„ CPU æ¶æ„å’Œå¹³å°ã€‚ä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°æ§åˆ¶ Makefile å‘½ä»¤çš„è¡Œä¸ºï¼Œè¿˜éœ€è¦æ”¯æŒ Optionsã€‚

**ä¸ºäº†æ–¹ä¾¿æŸ¥çœ‹ Makefile é›†æˆäº†å“ªäº›åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦æ”¯æŒ help å‘½ä»¤ã€‚help å‘½ä»¤æœ€å¥½é€šè¿‡è§£æ Makefile æ–‡ä»¶æ¥è¾“å‡ºé›†æˆçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š**

```bash
## help: Show this help info.
.PHONY: help
help: Makefile
  @echo -e "\nUsage: make <TARGETS> <OPTIONS> ...\n\nTargets:"
  @sed -n 's/^##//p' $< | column -t -s ':' | sed -e 's/^/ /'
  @echo "$$USAGE_OPTIONS"
```

ä¸Šé¢çš„ help å‘½ä»¤ï¼Œé€šè¿‡è§£æ Makefile æ–‡ä»¶ä¸­çš„ `##` æ³¨é‡Šï¼Œè·å–æ”¯æŒçš„å‘½ä»¤ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥åæ–°åŠ å‘½ä»¤æ—¶ï¼Œå°±ä¸ç”¨å†å¯¹ help å‘½ä»¤è¿›è¡Œä¿®æ”¹äº†ã€‚



### å¸¸ç”¨çš„ Makefile æ ¸å¿ƒè¯­æ³•

å¤§å¤šæ•°çš„ make éƒ½æ”¯æŒâ€œmakefileâ€å’Œâ€œMakefileâ€è¿™ä¸¤ç§æ–‡ä»¶åï¼Œä½†æˆ‘å»ºè®®ä½¿ç”¨â€œMakefileâ€ã€‚å› ä¸ºè¿™ä¸ªæ–‡ä»¶åç¬¬ä¸€ä¸ªå­—ç¬¦å¤§å†™ï¼Œä¼šå¾ˆæ˜æ˜¾ï¼Œå®¹æ˜“è¾¨åˆ«ã€‚make ä¹Ÿæ”¯æŒ `-f` å’Œ `--file` å‚æ•°æ¥æŒ‡å®šå…¶ä»–æ–‡ä»¶åï¼Œæ¯”å¦‚ `make -f golang.mk` æˆ–è€… `make --file golang.mk` ã€‚



### makefile æ”¯æŒçš„é€šé…ç¬¦

Makefile æ”¯æŒä¸‰ç§ç±»å‹çš„é€šé…ç¬¦ï¼Œä»–ä»¬æ˜¯ï¼š`*ï¼Œ? å’Œ~`

1. **`*`é€šé…ç¬¦ï¼š**

*é€šé…ç¬¦ä»£è¡¨ä»»æ„é•¿åº¦çš„å­—ç¬¦åºåˆ—ï¼Œå¯ä»¥åŒ¹é…ä»»æ„é•¿åº¦çš„æ–‡ä»¶åæˆ–è·¯å¾„åä¸­çš„ä»»æ„å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥åŒ¹é…æ‰€æœ‰.cæ–‡ä»¶ï¼š

```makefile
SRCS := $(wildcard *.c)
```

è¿™æ¡è§„åˆ™å°†ä¼šå°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ä»¥.cä¸ºåç¼€çš„æ–‡ä»¶åèµ‹å€¼ç»™å˜é‡SRCSï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å¼•ç”¨è¿™äº›æ–‡ä»¶ã€‚

2. **`?`é€šé…ç¬¦ï¼š**

?é€šé…ç¬¦ä»£è¡¨ä»»æ„å•ä¸ªå­—ç¬¦ï¼Œå¯ä»¥åŒ¹é…ä»»æ„é•¿åº¦çš„æ–‡ä»¶åæˆ–è·¯å¾„åä¸­çš„ä¸€ä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥åŒ¹é…æ‰€æœ‰ä¸‰ä¸ªå­—ç¬¦é•¿çš„`.txt`æ–‡ä»¶ï¼š

```makefile
SRCS := $(wildcard ???.txt)
```

è¿™æ¡è§„åˆ™å°†ä¼šå°†å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶åé•¿åº¦ä¸º3ï¼Œå¹¶ä»¥.txtä¸ºåç¼€çš„æ–‡ä»¶åèµ‹å€¼ç»™å˜é‡SRCSã€‚

3. **`~`é€šé…ç¬¦ï¼š**

~é€šé…ç¬¦ä»£è¡¨å½“å‰ç”¨æˆ·çš„`home`ç›®å½•ï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®šæ–‡ä»¶è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥æŒ‡å®šå½“å‰ç”¨æˆ·çš„`home`ç›®å½•ï¼š

```shell
$(HOME)/myprogram
```

è¿™æ¡è§„åˆ™å°†ä¼šå°†å½“å‰ç”¨æˆ·çš„homeç›®å½•è·¯å¾„å’Œmyprogramå­—ç¬¦ä¸²æ‹¼æ¥èµ·æ¥ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„è·¯å¾„åï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°å¼•ç”¨homeç›®å½•ä¸‹çš„æ–‡ä»¶æˆ–è·¯å¾„ã€‚



### å˜é‡

å˜é‡ï¼Œå¯èƒ½æ˜¯ Makefile ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„è¯­æ³•äº†ï¼ŒMakefile æ”¯æŒå˜é‡èµ‹å€¼ã€å¤šè¡Œå˜é‡å’Œç¯å¢ƒå˜é‡ã€‚å¦å¤–ï¼ŒMakefile è¿˜å†…ç½®äº†ä¸€äº›ç‰¹æ®Šå˜é‡å’Œè‡ªåŠ¨åŒ–å˜é‡ã€‚

**å˜é‡èµ‹å€¼ ï¼š**

Makefile ä¹Ÿå¯ä»¥åƒå…¶ä»–è¯­è¨€ä¸€æ ·æ”¯æŒå˜é‡ã€‚åœ¨ä½¿ç”¨å˜é‡æ—¶ï¼Œä¼šåƒ shell å˜é‡ä¸€æ ·åŸåœ°å±•å¼€ï¼Œç„¶åå†æ‰§è¡Œæ›¿æ¢åçš„å†…å®¹ã€‚

Makefile å¯ä»¥é€šè¿‡å˜é‡å£°æ˜æ¥å£°æ˜ä¸€ä¸ªå˜é‡ï¼Œå˜é‡åœ¨å£°æ˜æ—¶éœ€è¦èµ‹äºˆä¸€ä¸ªåˆå€¼ï¼Œæ¯”å¦‚`ROOT_PACKAGE=github.com/marmotedu/iam`ã€‚

å¼•ç”¨å˜é‡æ—¶å¯ä»¥é€šè¿‡`$()`æˆ–è€…`${}`æ–¹å¼å¼•ç”¨ã€‚æˆ‘çš„å»ºè®®æ˜¯ï¼Œç”¨`$()`æ–¹å¼å¼•ç”¨å˜é‡ï¼Œä¾‹å¦‚`$(ROOT_PACKAGE)`ï¼Œä¹Ÿå»ºè®®æ•´ä¸ª makefile çš„å˜é‡å¼•ç”¨æ–¹å¼ä¿æŒä¸€è‡´ã€‚

å˜é‡ä¼šåƒ bash å˜é‡ä¸€æ ·ï¼Œåœ¨ä½¿ç”¨å®ƒçš„åœ°æ–¹å±•å¼€ã€‚æ¯”å¦‚ï¼š

```bash
GO=go
build:
    $(GO) build -v .
```

å±•å¼€åä¸ºï¼š

```bash
GO=go
build:
    go build -v .
```



**Makefile æœ‰å››ç§çš„èµ‹å€¼æ–¹å¼ï¼š**

**`=` æœ€åŸºæœ¬çš„èµ‹å€¼æ–¹æ³•ã€‚**

```bash
BASE_IMAGE = alpine:3.10
```

> ğŸ’¡ æ³¨æ„ï¼šä½¿ç”¨ `=` èµ‹å€¼çš„æ—¶å€™ï¼Œå–å€¼åˆ°çš„å¹¶éæ˜¯ç¨‹åºä¾æ¬¡æ‰§è¡Œçš„å€¼ï¼Œè€Œæ˜¯æœ€ç»ˆçš„å€¼
>
> ```bash
> A = a
> B = $(A) b
> A = c
> ```
>
> B æœ€åçš„å€¼ä¸º c bï¼Œè€Œä¸æ˜¯ a bã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç”¨å˜é‡ç»™å˜é‡èµ‹å€¼æ—¶ï¼Œå³è¾¹å˜é‡çš„å–å€¼ï¼Œå–çš„æ˜¯æœ€ç»ˆçš„å˜é‡å€¼ã€‚



**å’Œgoä¸€æ ·ï¼Œ`:=`ç›´æ¥èµ‹å€¼ï¼Œèµ‹äºˆå½“å‰ä½ç½®çš„å€¼ã€‚**

```bash
A = a
B := $(A) b
A = c
```

B æœ€åçš„å€¼ä¸º a bã€‚é€šè¿‡ `:=` çš„èµ‹å€¼æ–¹å¼ï¼Œå¯ä»¥é¿å… `=` èµ‹å€¼å¸¦æ¥çš„æ½œåœ¨çš„ä¸ä¸€è‡´ã€‚



**`?=` è¡¨ç¤ºå¦‚æœè¯¥å˜é‡æ²¡æœ‰è¢«èµ‹å€¼ï¼Œåˆ™èµ‹äºˆç­‰å·åçš„å€¼ã€‚**

**ä¾‹å¦‚ï¼š**

```bash
PLATFORMS ?= linux_amd64 linux_arm64
```



**`+=`è¡¨ç¤ºå°†ç­‰å·åé¢çš„å€¼æ·»åŠ åˆ°å‰é¢çš„å˜é‡ä¸Šã€‚**

```
MAKEFLAGS += --no-print-directory
```



**Makefile è¿˜æ”¯æŒå¤šè¡Œå˜é‡ã€‚å¯ä»¥é€šè¿‡ define å…³é”®å­—è®¾ç½®å¤šè¡Œå˜é‡ï¼Œå˜é‡ä¸­å…è®¸æ¢è¡Œã€‚å®šä¹‰æ–¹å¼ä¸ºï¼š**

```makefile
define å˜é‡å
å˜é‡å†…å®¹
...
endef
```

å˜é‡çš„å†…å®¹å¯ä»¥åŒ…å«å‡½æ•°ã€å‘½ä»¤ã€æ–‡å­—æˆ–æ˜¯å…¶ä»–å˜é‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª `USAGE_OPTIONS` å˜é‡ï¼š

```makefile
define USAGE_OPTIONS

Options:
  DEBUG        Whether to generate debug symbols. Default is 0.
  BINS         The binaries to build. Default is all of cmd.
  ...
  V            Set to 1 enable verbose build. Default is 0.
endef
```

Makefile è¿˜æ”¯æŒç¯å¢ƒå˜é‡ã€‚åœ¨ Makefile ä¸­ï¼Œæœ‰ä¸¤ç§ç¯å¢ƒå˜é‡ï¼Œåˆ†åˆ«æ˜¯ Makefile é¢„å®šä¹‰çš„ç¯å¢ƒå˜é‡å’Œè‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡ã€‚

å…¶ä¸­ï¼Œè‡ªå®šä¹‰çš„ç¯å¢ƒå˜é‡å¯ä»¥è¦†ç›– Makefile é¢„å®šä¹‰çš„ç¯å¢ƒå˜é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒMakefile ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡åªåœ¨å½“å‰ Makefile æœ‰æ•ˆï¼Œå¦‚æœæƒ³å‘ä¸‹å±‚ä¼ é€’ï¼ˆMakefile ä¸­è°ƒç”¨å¦ä¸€ä¸ª Makefileï¼‰ï¼Œéœ€è¦ä½¿ç”¨ export å…³é”®å­—æ¥å£°æ˜ã€‚

```makefile
...
export USAGE_OPTIONS
...
```

æ­¤å¤–ï¼ŒMakefile è¿˜æ”¯æŒä¸¤ç§å†…ç½®çš„å˜é‡ï¼šç‰¹æ®Šå˜é‡å’Œè‡ªåŠ¨åŒ–å˜é‡ã€‚

ç‰¹æ®Šå˜é‡æ˜¯ make æå‰å®šä¹‰å¥½çš„ï¼Œå¯ä»¥åœ¨ makefile ä¸­ç›´æ¥å¼•ç”¨ã€‚ç‰¹æ®Šå˜é‡åˆ—è¡¨å¦‚ä¸‹ï¼š

![image-20230220163605753](http://sm.nsddd.top/sm202302201636940.png)

Makefile è¿˜æ”¯æŒè‡ªåŠ¨åŒ–å˜é‡ã€‚è‡ªåŠ¨åŒ–å˜é‡å¯ä»¥æé«˜æˆ‘ä»¬ç¼–å†™ Makefile çš„æ•ˆç‡å’Œè´¨é‡ã€‚



**è‡ªåŠ¨åŒ–å˜é‡ï¼š**

è¿™æ—¶å°±å¯ä»¥ç”¨åˆ°è‡ªåŠ¨åŒ–å˜é‡ã€‚æ‰€è°“è‡ªåŠ¨åŒ–å˜é‡ï¼Œå°±æ˜¯è¿™ç§å˜é‡ä¼šæŠŠæ¨¡å¼ä¸­æ‰€å®šä¹‰çš„ä¸€ç³»åˆ—çš„æ–‡ä»¶è‡ªåŠ¨åœ°æŒ¨ä¸ªå–å‡ºï¼Œä¸€ç›´åˆ°æ‰€æœ‰ç¬¦åˆæ¨¡å¼çš„æ–‡ä»¶éƒ½å–å®Œä¸ºæ­¢ã€‚è¿™ç§è‡ªåŠ¨åŒ–å˜é‡åªåº”å‡ºç°åœ¨è§„åˆ™çš„å‘½ä»¤ä¸­ã€‚Makefile ä¸­æ”¯æŒçš„è‡ªåŠ¨åŒ–å˜é‡è§ä¸‹è¡¨ã€‚

![image-20230220163723550](C:/Users/smile/AppData/Roaming/Typora/typora-user-images/image-20230220163723550.png)

ä¸Šé¢è¿™äº›è‡ªåŠ¨åŒ–å˜é‡ä¸­ï¼Œ`$*`æ˜¯ç”¨å¾—æœ€å¤šçš„ã€‚`$*` å¯¹äºæ„é€ æœ‰å…³è”çš„æ–‡ä»¶åæ˜¯æ¯”è¾ƒæœ‰æ•ˆçš„ã€‚å¦‚æœç›®æ ‡ä¸­æ²¡æœ‰æ¨¡å¼çš„å®šä¹‰ï¼Œé‚£ä¹ˆ `$*` ä¹Ÿå°±ä¸èƒ½è¢«æ¨å¯¼å‡ºã€‚ä½†æ˜¯ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶çš„åç¼€æ˜¯ make æ‰€è¯†åˆ«çš„ï¼Œé‚£ä¹ˆ `$*` å°±æ˜¯é™¤äº†åç¼€çš„é‚£ä¸€éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼šå¦‚æœç›®æ ‡æ˜¯ `foo.c` ï¼Œå› ä¸º.c æ˜¯ make æ‰€èƒ½è¯†åˆ«çš„åç¼€åï¼Œæ‰€ä»¥ `$*` çš„å€¼å°±æ˜¯ fooã€‚



**æ¡ä»¶è¯­å¥ï¼š**

Makefile ä¹Ÿæ”¯æŒæ¡ä»¶è¯­å¥ã€‚è¿™é‡Œå…ˆçœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚

ä¸‹é¢çš„ä¾‹å­åˆ¤æ–­å˜é‡ROOT_PACKAGEæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œä¸ä¸ºç©ºåˆ™æ‰“å°å˜é‡å€¼ï¼š

```makefile
ifeq ($(ROOT_PACKAGE),)
$(error the variable ROOT_PACKAGE must be set prior to including golang.mk)
else
$(info the value of ROOT_PACKAGE is $(ROOT_PACKAGE))
endif
```

æ¡ä»¶è¯­å¥çš„è¯­æ³•ä¸ºï¼š

```makefile

# if ...
<conditional-directive>
<text-if-true>
endif
# if ... else ...
<conditional-directive>
<text-if-true>
else
<text-if-false>
endif
```

ä¾‹å¦‚ï¼Œåˆ¤æ–­ä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰ï¼š

```makefile

ifeq æ¡ä»¶è¡¨è¾¾å¼
...
else
...
endif
```

+ ifeq è¡¨ç¤ºæ¡ä»¶è¯­å¥çš„å¼€å§‹ï¼Œå¹¶æŒ‡å®šä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼ã€‚è¡¨è¾¾å¼åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼Œå‚æ•°ä¹‹é—´ç”¨é€—å·åˆ†éš”ï¼Œå¹¶ä¸”è¡¨è¾¾å¼ç”¨åœ†æ‹¬å·æ‹¬èµ·æ¥ã€‚
+ else è¡¨ç¤ºæ¡ä»¶è¡¨è¾¾å¼ä¸ºå‡çš„æƒ…å†µã€‚
+ endif è¡¨ç¤ºä¸€ä¸ªæ¡ä»¶è¯­å¥çš„ç»“æŸï¼Œä»»ä½•ä¸€ä¸ªæ¡ä»¶è¡¨è¾¾å¼éƒ½åº”è¯¥ä»¥ endif ç»“æŸã€‚
+ è¡¨ç¤ºæ¡ä»¶å…³é”®å­—ï¼Œæœ‰ 4 ä¸ªå…³é”®å­—ï¼šifeqã€ifneqã€ifdefã€ifndefã€‚



**ä¸ºäº†åŠ æ·±ä½ çš„ç†è§£ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹è¿™ 4 ä¸ªå…³é”®å­—çš„ä¾‹å­ã€‚**

ifeqï¼šæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦ç›¸ç­‰ã€‚

```makefile
ifeq (<arg1>, <arg2>)
ifeq '<arg1>' '<arg2>'
ifeq "<arg1>" "<arg2>"
ifeq "<arg1>" '<arg2>'
ifeq '<arg1>' "<arg2>"
```

æ¯”è¾ƒ arg1 å’Œ arg2 çš„å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒåˆ™ä¸ºçœŸã€‚ä¹Ÿå¯ä»¥ç”¨ make å‡½æ•° / å˜é‡æ›¿ä»£ arg1 æˆ– arg2ï¼Œä¾‹å¦‚ `ifeq ($(origin ROOT_DIR),undefined) `æˆ– `ifeq ($(ROOT_PACKAGE),)` ã€‚origin å‡½æ•°ä¼šåœ¨ä¹‹åä¸“é—¨è®²å‡½æ•°çš„ä¸€è®²ä¸­ä»‹ç»åˆ°ã€‚



ifneqï¼šæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ç›¸ç­‰ã€‚

```makefile
ifneq (<arg1>, <arg2>)
ifneq '<arg1>' '<arg2>'
ifneq "<arg1>" "<arg2>"
ifneq "<arg1>" '<arg2>'
ifneq '<arg1>' "<arg2>"
```

æ¯”è¾ƒ arg1 å’Œ arg2 çš„å€¼æ˜¯å¦ä¸åŒï¼Œå¦‚æœä¸åŒåˆ™ä¸ºçœŸã€‚



ifdefï¼šæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­å˜é‡æ˜¯å¦å·²å®šä¹‰ã€‚

```makefile
ifdef <variable-name>
```

å¦‚æœå€¼éç©ºï¼Œåˆ™è¡¨è¾¾å¼ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡ã€‚ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚



ifndefï¼šæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­å˜é‡æ˜¯å¦æœªå®šä¹‰ã€‚

```
ifndef <variable-name>
```

å¦‚æœå€¼ä¸ºç©ºï¼Œåˆ™è¡¨è¾¾å¼ä¸ºçœŸï¼Œå¦åˆ™ä¸ºå‡ã€‚ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚



### å‡½æ•°

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è‡ªå®šä¹‰å‡½æ•°ã€‚ make è§£é‡Šå™¨æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°ä¾› Makefile è°ƒç”¨ï¼Œè¿™äº›å‡½æ•°æ˜¯ Makefile çš„é¢„å®šä¹‰å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ define å…³é”®å­—æ¥è‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ã€‚è‡ªå®šä¹‰å‡½æ•°çš„è¯­æ³•ä¸ºï¼š

```makefile
define å‡½æ•°å
å‡½æ•°ä½“
endef
```



**ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š**

```makefile

define Foo
    @echo "my name is $(0)"
    @echo "param is $(1)"
endef
```

define æœ¬è´¨ä¸Šæ˜¯å®šä¹‰ä¸€ä¸ªå¤šè¡Œå˜é‡ï¼Œå¯ä»¥åœ¨ call çš„ä½œç”¨ä¸‹å½“ä½œå‡½æ•°æ¥ä½¿ç”¨ï¼Œåœ¨å…¶ä»–ä½ç½®ä½¿ç”¨åªèƒ½ä½œä¸ºå¤šè¡Œå˜é‡æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š

```
var := $(call Foo)
new := $(Foo)
```



**é¢„å®šä¹‰å‡½æ•°ï¼š**

å†æ¥çœ‹ä¸‹é¢„å®šä¹‰å‡½æ•°ã€‚ åˆšæ‰æåˆ°ï¼Œmake ç¼–è¯‘å™¨ä¹Ÿå®šä¹‰äº†å¾ˆå¤šå‡½æ•°ï¼Œè¿™äº›å‡½æ•°å«ä½œé¢„å®šä¹‰å‡½æ•°ï¼Œè°ƒç”¨è¯­æ³•å’Œå˜é‡ç±»ä¼¼ï¼Œè¯­æ³•ä¸ºï¼š

```
$(<function> <arguments>)
OR
${<function> <arguments>}
```

`<function> ` æ˜¯å‡½æ•°åï¼Œ`<arguments>` æ˜¯å‡½æ•°å‚æ•°ï¼Œå‚æ•°é—´ç”¨é€—å·åˆ†å‰²ã€‚å‡½æ•°çš„å‚æ•°ä¹Ÿå¯ä»¥æ˜¯å˜é‡ã€‚

ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š

```makefile
PLATFORM = linux_amd64
GOOS := $(word 1, $(subst _, ,$(PLATFORM)))
```

ä¸Šé¢çš„ä¾‹å­ç”¨åˆ°äº†ä¸¤ä¸ªå‡½æ•°ï¼šword å’Œ substã€‚word å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œ1 å’Œ subst å‡½æ•°çš„è¾“å‡ºã€‚subst å‡½æ•°å°† PLATFORM å˜é‡å€¼ä¸­çš„ `_` æ›¿æ¢æˆç©ºæ ¼ï¼ˆæ›¿æ¢åçš„ PLATFORM å€¼ä¸º linux amd64ï¼‰ã€‚word å‡½æ•°å– linux amd64 å­—ç¬¦ä¸²ä¸­çš„ç¬¬ä¸€ä¸ªå•è¯ã€‚æ‰€ä»¥æœ€å GOOS çš„å€¼ä¸º linuxã€‚

Makefile é¢„å®šä¹‰å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°å¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ï¼Œåœ¨ç¼–å†™ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰åŠŸèƒ½éœ€æ±‚ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨è¿™äº›å‡½æ•°ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨è¿™äº›å‡½æ•°ï¼Œé‚£å°±éœ€è¦çŸ¥é“æœ‰å“ªäº›å‡½æ•°ï¼Œä»¥åŠå®ƒä»¬å®ç°çš„åŠŸèƒ½ã€‚

![img](http://sm.nsddd.top/sm202302201721492.jpeg)



### å¼•å…¥å…¶ä»– Makefile

åœ¨ Makefile ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å…³é”®å­— includeï¼ŒæŠŠåˆ«çš„ makefile åŒ…å«è¿›æ¥ï¼Œç±»ä¼¼äº C è¯­è¨€çš„#includeï¼Œè¢«åŒ…å«çš„æ–‡ä»¶ä¼šæ’å…¥åœ¨å½“å‰çš„ä½ç½®ã€‚include ç”¨æ³•ä¸ºinclude ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```makefile
include scripts/make-rules/common.mk
include scripts/make-rules/golang.mk
```

include ä¹Ÿå¯ä»¥åŒ…å«é€šé…ç¬¦include scripts/make-rules/*ã€‚make å‘½ä»¤ä¼šæŒ‰ä¸‹é¢çš„é¡ºåºæŸ¥æ‰¾ makefile æ–‡ä»¶ï¼š

+ å¦‚æœæ˜¯ç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„ï¼Œå°±ç›´æ¥æ ¹æ®è·¯å¾„ include è¿›æ¥ã€‚
+ å¦‚æœ make æ‰§è¡Œæ—¶ï¼Œæœ‰`-I`æˆ–`--include-dir`å‚æ•°ï¼Œé‚£ä¹ˆ make å°±ä¼šåœ¨è¿™ä¸ªå‚æ•°æ‰€æŒ‡å®šçš„ç›®å½•ä¸‹å»æ‰¾ã€‚
+ å¦‚æœç›®å½•`<prefix>/include`ï¼ˆä¸€èˆ¬æ˜¯/usr/local/binæˆ–/usr/includeï¼‰å­˜åœ¨çš„è¯ï¼Œmake ä¹Ÿä¼šå»æ‰¾ã€‚

å¦‚æœæœ‰æ–‡ä»¶æ²¡æœ‰æ‰¾åˆ°ï¼Œmake ä¼šç”Ÿæˆä¸€æ¡è­¦å‘Šä¿¡æ¯ï¼Œä½†ä¸ä¼šé©¬ä¸Šå‡ºç°è‡´å‘½é”™è¯¯ï¼Œè€Œæ˜¯ç»§ç»­è½½å…¥å…¶ä»–çš„æ–‡ä»¶ã€‚ä¸€æ—¦å®Œæˆ makefile çš„è¯»å–ï¼Œmake ä¼šå†é‡è¯•è¿™äº›æ²¡æœ‰æ‰¾åˆ°æˆ–æ˜¯ä¸èƒ½è¯»å–çš„æ–‡ä»¶ã€‚å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œmake æ‰ä¼šå‡ºç°ä¸€æ¡è‡´å‘½é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœä½ æƒ³è®© `make` å¿½ç•¥é‚£äº›æ— æ³•è¯»å–çš„æ–‡ä»¶ç»§ç»­æ‰§è¡Œï¼Œå¯ä»¥åœ¨ i`n`clude å‰åŠ ä¸€ä¸ªå‡å·`-`ï¼Œå¦‚`-include` ã€‚



## è®¾è®¡Makefileç»“æ„

å¯¹äºå¤§å‹é¡¹ç›®æ¥è¯´ï¼Œéœ€è¦ç®¡ç†çš„å†…å®¹å¾ˆå¤šï¼Œæ‰€æœ‰ç®¡ç†åŠŸèƒ½éƒ½é›†æˆåœ¨ä¸€ä¸ª Makefile ä¸­ï¼Œå¯èƒ½ä¼šå¯¼è‡´ Makefile å¾ˆå¤§ï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ï¼Œæ‰€ä»¥å»ºè®®é‡‡ç”¨åˆ†å±‚çš„è®¾è®¡æ–¹æ³•ï¼Œ**æ ¹ç›®å½•ä¸‹çš„ Makefile èšåˆæ‰€æœ‰çš„ Makefile å‘½ä»¤ï¼Œå…·ä½“å®ç°åˆ™æŒ‰åŠŸèƒ½åˆ†ç±»ï¼Œæ”¾åœ¨å¦å¤–çš„ Makefile ä¸­ã€‚**

æˆ‘ä»¬ç»å¸¸ä¼šåœ¨ Makefile å‘½ä»¤ä¸­é›†æˆ shell è„šæœ¬ï¼Œä½†å¦‚æœ shell è„šæœ¬è¿‡äºå¤æ‚ï¼Œä¹Ÿä¼šå¯¼è‡´ Makefile å†…å®¹è¿‡å¤šï¼Œéš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ã€‚å¹¶ä¸”åœ¨ Makefile ä¸­é›†æˆå¤æ‚çš„ shell è„šæœ¬ï¼Œç¼–å†™ä½“éªŒä¹Ÿå¾ˆå·®ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œ**å¯ä»¥å°†å¤æ‚çš„ shell å‘½ä»¤å°è£…åœ¨ shell è„šæœ¬ä¸­ï¼Œä¾› Makefile ç›´æ¥è°ƒç”¨ï¼Œè€Œä¸€äº›ç®€å•çš„å‘½ä»¤åˆ™å¯ä»¥ç›´æ¥é›†æˆåœ¨ Makefile ä¸­ã€‚**

**æ¨èçš„ Makefile ç»“æ„ï¼š**

![image-20230219153332640](https://sm.nsddd.top/sm202302191533699.png)



åœ¨ä¸Šé¢çš„ Makefile ç»„ç»‡æ–¹å¼ä¸­ï¼Œæ ¹ç›®å½•ä¸‹çš„ Makefile èšåˆäº†é¡¹ç›®æ‰€æœ‰çš„ç®¡ç†åŠŸèƒ½ï¼Œè¿™äº›ç®¡ç†åŠŸèƒ½é€šè¿‡ Makefile ä¼ªç›®æ ‡çš„æ–¹å¼å®ç°ã€‚åŒæ—¶ï¼Œè¿˜å°†è¿™äº›ä¼ªç›®æ ‡è¿›è¡Œåˆ†ç±»ï¼ŒæŠŠç›¸åŒç±»åˆ«çš„ä¼ªç›®æ ‡æ”¾åœ¨åŒä¸€ä¸ª Makefile ä¸­ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾— Makefile æ›´å®¹æ˜“ç»´æŠ¤ã€‚å¯¹äºå¤æ‚çš„å‘½ä»¤ï¼Œåˆ™ç¼–å†™æˆç‹¬ç«‹çš„ shell è„šæœ¬ï¼Œå¹¶åœ¨ Makefile å‘½ä»¤ä¸­è°ƒç”¨è¿™äº› shell è„šæœ¬ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹é¢æ˜¯ IAM é¡¹ç›®çš„ Makefile ç»„ç»‡ç»“æ„ï¼š

```bash

â”œâ”€â”€ Makefile
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ gendoc.sh
â”‚   â”œâ”€â”€ make-rules
â”‚   â”‚   â”œâ”€â”€ gen.mk
â”‚   â”‚   â”œâ”€â”€ golang.mk
â”‚   â”‚   â”œâ”€â”€ image.mk
â”‚   â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
â”œâ”€â”€ Makefile
â”œâ”€â”€ scripts
â”‚   â”œâ”€â”€ gendoc.sh
â”‚   â”œâ”€â”€ make-rules
â”‚   â”‚   â”œâ”€â”€ gen.mk
â”‚   â”‚   â”œâ”€â”€ golang.mk
â”‚   â”‚   â”œâ”€â”€ image.mk
â”‚   â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
```

æˆ‘ä»¬å°†ç›¸åŒç±»åˆ«çš„æ“ä½œç»Ÿä¸€æ”¾åœ¨ `scripts/make-rules` ç›®å½•ä¸‹çš„ Makefile æ–‡ä»¶ä¸­ã€‚**Makefile çš„æ–‡ä»¶åå‚è€ƒåˆ†ç±»å‘½å**ï¼Œä¾‹å¦‚ `golang.mk`ã€‚æœ€åï¼Œåœ¨ `/Makefile` ä¸­ include è¿™äº› Makefileã€‚

> éœ€è¦ä½¿ç”¨ `include` æ¥è·å–å¤´æ–‡ä»¶ï¼š
>
> `include`æ˜¯ä¸€ç§æŒ‡ä»¤ï¼Œç”¨äºå°†å¦ä¸€ä¸ªæ–‡ä»¶ä¸­çš„è§„åˆ™å’Œå˜é‡å¯¼å…¥åˆ°å½“å‰çš„makefileä¸­ã€‚è¿™æ ·åšå¯ä»¥è®©ä½ çš„makefileæ›´åŠ æ¨¡å—åŒ–ï¼Œæ˜“äºç»´æŠ¤å’Œé‡ç”¨ã€‚
>
> **æ³¨æ„å’Œæˆ‘ä»¬ä¸Šé¢è®²çš„æ¨¡å—åŒ–åˆ†é… Makefile å±‚çº§è°ƒç”¨æœ‰äº›ä¸ä¸€æ ·ã€‚**
>
> ä¸‹é¢æ˜¯ä¸€ä¸ªincludeçš„æ¡ˆä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º`main.c`çš„æºæ–‡ä»¶ï¼Œå®ƒéœ€è¦é“¾æ¥ä¸€ä¸ªåä¸º`libfoo.a`çš„é™æ€åº“æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™äº›è§„åˆ™å’Œå˜é‡å®šä¹‰åœ¨ä¸€ä¸ªåä¸º`Makefile.inc`çš„æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨æˆ‘ä»¬çš„ä¸»makefileä¸­ä½¿ç”¨includeæŒ‡ä»¤å°†å…¶å¯¼å…¥ã€‚
>
> ```makefile
> CC = gcc
> CFLAGS = -Wall -Werror -g
> 
> all: libfoo.a
> 
> libfoo.a: foo.o
> 	ar rcs $@ $^
> 
> foo.o: foo.c foo.h
> 	$(CC) $(CFLAGS) -c $<
> 
> clean:
> 	rm -f *.o libfoo.a
> 
> ```
>
> ä¸»makefileæ–‡ä»¶ï¼š
>
> ```makefile
> include Makefile.inc
> 
> main: main.c libfoo.a
> 	$(CC) $(CFLAGS) -o $@ $< -L. -lfoo
> 
> .PHONY: clean
> clean:
> 	$(MAKE) -C . -f Makefile.inc clean
> 	rm -f main
> ```
>
> **go è¯­è¨€Makefile ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š**
>
> ```makefile
> # å®šä¹‰å˜é‡
> GOCMD=go
> GOBUILD=$(GOCMD) build
> GOCLEAN=$(GOCMD) clean
> BINARY_NAME=myapp
> BINARY_UNIX=$(BINARY_NAME)_unix
> 
> all: deps build
> build:
>     $(GOBUILD) -o $(BINARY_NAME) -v
>     $(GOBUILD) -o $(BINARY_UNIX) -v
> deps:
>     $(GOCMD) get -u github.com/golang/dep/cmd/dep
>     dep ensure
> clean:
>     $(GOCLEAN)
>     rm -f $(BINARY_NAME)
>     rm -f $(BINARY_UNIX)
> run:
>     $(GOBUILD) -o $(BINARY_NAME) -v ./...
>     ./$(BINARY_NAME)
> include docker.mk
> 
> ```
>
> åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæœ€åä¸€è¡Œ `include docker.mk` å¼•ç”¨äº†åä¸º `docker.mk` çš„ Makefile æ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­å¯èƒ½åŒ…å«äº†ä¸€äº› Docker ç›¸å…³çš„å‘½ä»¤ï¼Œæ¯”å¦‚æ„å»ºé•œåƒã€æ¨é€é•œåƒç­‰ç­‰ã€‚é€šè¿‡ include æŒ‡ä»¤ï¼Œè¿™äº›å‘½ä»¤å¯ä»¥è¢«è‡ªåŠ¨å¼•å…¥åˆ°ä¸» Makefile æ–‡ä»¶ä¸­ï¼Œä»è€Œå®ç°æ›´åŠ é«˜æ•ˆå’Œä¾¿æ·çš„ç¼–è¯‘å’Œæ„å»ºã€‚
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œinclude æŒ‡ä»¤çš„ä½œç”¨æ˜¯å°†è¢«å¼•å…¥çš„ Makefile æ–‡ä»¶çš„å†…å®¹ç›´æ¥å¤åˆ¶åˆ°ä¸» Makefile æ–‡ä»¶ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœå¼•å…¥çš„æ–‡ä»¶ä¸­å®šä¹‰äº†å’Œä¸» Makefile æ–‡ä»¶ä¸­ç›¸åŒçš„å˜é‡æˆ–è€…è§„åˆ™ï¼Œä¼šå‘ç”Ÿå‘½åå†²çªã€‚å› æ­¤ï¼Œåœ¨ç¼–å†™è¢«å¼•å…¥çš„ Makefile æ–‡ä»¶æ—¶ï¼Œåº”è¯¥é¿å…ä½¿ç”¨å’Œä¸» Makefile æ–‡ä»¶ç›¸åŒçš„å˜é‡å’Œè§„åˆ™åã€‚

ä¸ºäº†è·Ÿ Makefile çš„å±‚çº§ç›¸åŒ¹é…ï¼Œ`golang.mk` ä¸­çš„æ‰€æœ‰ç›®æ ‡éƒ½æŒ‰`go.xxx`è¿™ç§æ–¹å¼å‘½åã€‚é€šè¿‡è¿™ç§å‘½åæ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºæŸä¸ªç›®æ ‡å®Œæˆä»€ä¹ˆåŠŸèƒ½ï¼Œæ”¾åœ¨ä»€ä¹ˆæ–‡ä»¶é‡Œï¼Œè¿™åœ¨å¤æ‚çš„ Makefile ä¸­å°¤å…¶æœ‰ç”¨ã€‚ä»¥ä¸‹æ˜¯ IAM é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼ŒMakefile çš„å†…å®¹æ‘˜å½•ï¼Œä½ å¯ä»¥çœ‹ä¸€çœ‹ï¼Œä½œä¸ºå‚è€ƒï¼š

```makefile
include scripts/make-rules/golang.mk
include scripts/make-rules/image.mk
include scripts/make-rules/gen.mk
include scripts/make-rules/...

## build: Build source code for host platform.
.PHONY: build
build:
  @$(MAKE) go.build

## build.multiarch: Build source code for multiple platforms. See option PLATFORMS.
.PHONY: build.multiarch
build.multiarch:
  @$(MAKE) go.build.multiarch

## image: Build docker images for host arch.
.PHONY: image
image:
  @$(MAKE) image.build

## push: Build docker images for host arch and push images to registry.
.PHONY: push
push:
  @$(MAKE) image.push

## ca: Generate CA files for all iam components.
.PHONY: ca
ca:
  @$(MAKE) gen.ca
```

å¦å¤–ï¼Œä¸€ä¸ªåˆç†çš„ Makefile ç»“æ„åº”è¯¥å…·æœ‰å‰ç»æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦åœ¨ä¸æ”¹å˜ç°æœ‰ç»“æ„çš„æƒ…å†µä¸‹ï¼Œæ¥çº³åé¢çš„æ–°åŠŸèƒ½ã€‚è¿™å°±éœ€è¦ä½ æ•´ç†å¥½ Makefile å½“å‰è¦å®ç°çš„åŠŸèƒ½ã€å³å°†è¦å®ç°çš„åŠŸèƒ½å’Œæœªæ¥å¯èƒ½ä¼šå®ç°çš„åŠŸèƒ½ï¼Œç„¶ååŸºäºè¿™äº›åŠŸèƒ½ï¼Œåˆ©ç”¨ Makefile ç¼–ç¨‹æŠ€å·§ï¼Œç¼–å†™å¯æ‰©å±•çš„ Makefileã€‚

è¿™é‡Œéœ€è¦ä½ æ³¨æ„ï¼šä¸Šé¢çš„ Makefile é€šè¿‡ `.PHONY` æ ‡è¯†å®šä¹‰äº†å¤§é‡çš„ä¼ªç›®æ ‡ï¼Œå®šä¹‰ä¼ªç›®æ ‡ä¸€å®šè¦åŠ  `.PHONY` æ ‡è¯†ï¼Œå¦åˆ™å½“æœ‰åŒåçš„æ–‡ä»¶æ—¶ï¼Œä¼ªç›®æ ‡å¯èƒ½ä¸ä¼šè¢«æ‰§è¡Œã€‚



## æŒæ¡ Makefile ç¼–å†™æŠ€å·§

### æŠ€å·§ 1ï¼šå–„ç”¨é€šé…ç¬¦å’Œè‡ªåŠ¨å˜é‡

Makefile å…è®¸å¯¹ç›®æ ‡è¿›è¡Œç±»ä¼¼æ­£åˆ™è¿ç®—çš„åŒ¹é…ï¼Œä¸»è¦ç”¨åˆ°çš„é€šé…ç¬¦æ˜¯%ã€‚é€šè¿‡ä½¿ç”¨é€šé…ç¬¦ï¼Œå¯ä»¥ä½¿ä¸åŒçš„ç›®æ ‡ä½¿ç”¨ç›¸åŒçš„è§„åˆ™ï¼Œä»è€Œä½¿ Makefile æ‰©å±•æ€§æ›´å¼ºï¼Œä¹Ÿæ›´ç®€æ´ã€‚

æˆ‘ä»¬çš„ IAM å®æˆ˜é¡¹ç›®ä¸­ï¼Œå°±å¤§é‡ä½¿ç”¨äº†é€šé…ç¬¦`%`ï¼Œä¾‹å¦‚ï¼š`go.build.%`ã€`ca.gen.%`ã€`deploy.run.%`ã€`tools.verify.%`ã€`tools.install.%`ç­‰ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œ`tools.verify.%`ï¼ˆä½äº`scripts/make-rules/tools.mk`æ–‡ä»¶ä¸­ï¼‰å®šä¹‰å¦‚ä¸‹ï¼š

```makefile
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```

`make tools.verify.swagger`, `make tools.verify.mockgen`ç­‰å‡å¯ä»¥ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„è§„åˆ™ï¼Œ%åˆ†åˆ«ä»£è¡¨äº†`swagger`å’Œ`mockgen`ã€‚

å¦‚æœä¸ä½¿ç”¨`%`ï¼Œåˆ™æˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸º`tools.verify.swagger`å’Œ`tools.verify.mockgen`å®šä¹‰è§„åˆ™ï¼Œå¾ˆéº»çƒ¦ï¼Œåé¢ä¿®æ”¹ä¹Ÿå›°éš¾ã€‚

å¦å¤–ï¼Œè¿™é‡Œä¹Ÿèƒ½çœ‹å‡º`tools.verify.%`è¿™ç§å‘½åæ–¹å¼çš„å¥½å¤„ï¼štools è¯´æ˜ä¾èµ–çš„å®šä¹‰ä½äº`scripts/make-rules/tools.mk` Makefile ä¸­ï¼›verifyè¯´æ˜`tools.verify.%`ä¼ªç›®æ ‡å±äº verify åˆ†ç±»ï¼Œä¸»è¦ç”¨æ¥éªŒè¯å·¥å…·æ˜¯å¦å®‰è£…ã€‚é€šè¿‡è¿™ç§å‘½åæ–¹å¼ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°çŸ¥é“ç›®æ ‡ä½äºå“ªä¸ª Makefile æ–‡ä»¶ä¸­ï¼Œä»¥åŠæƒ³è¦å®Œæˆçš„åŠŸèƒ½ã€‚

å¦å¤–ï¼Œä¸Šé¢çš„å®šä¹‰ä¸­è¿˜ç”¨åˆ°äº†è‡ªåŠ¨å˜é‡`$*`ï¼Œç”¨æ¥æŒ‡ä»£è¢«åŒ¹é…çš„å€¼`swagger`ã€`mockgen`ã€‚



### æŠ€å·§ 2ï¼šå–„ç”¨å‡½æ•°

Makefile è‡ªå¸¦çš„å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°å¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬ç¼–å†™ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰åŠŸèƒ½éœ€æ±‚ï¼Œå¯ä»¥ä¼˜å…ˆä½¿ç”¨è¿™äº›å‡½æ•°ã€‚æˆ‘æŠŠå¸¸ç”¨çš„å‡½æ•°ä»¥åŠå®ƒä»¬å®ç°çš„åŠŸèƒ½æ•´ç†åœ¨äº† [Makefile](https://github.com/marmotedu/geekbang-go/blob/master/makefile/Makefile%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E5%88%97%E8%A1%A8.md) å¸¸ç”¨å‡½æ•°åˆ—è¡¨ ä¸­ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹ã€‚

IAM çš„ Makefile æ–‡ä»¶ä¸­å¤§é‡ä½¿ç”¨äº†ä¸Šè¿°å‡½æ•°ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹è¿™äº›å‡½æ•°çš„å…·ä½“ä½¿ç”¨æ–¹æ³•å’Œåœºæ™¯ï¼Œå¯ä»¥å‚è€ƒ IAM é¡¹ç›®çš„ Makefile æ–‡ä»¶ `make-rules`ã€‚





### æŠ€å·§ 3ï¼šä¾èµ–éœ€è¦ç”¨åˆ°çš„å·¥å…·

å¦‚æœ Makefile æŸä¸ªç›®æ ‡çš„å‘½ä»¤ä¸­ç”¨åˆ°äº†æŸä¸ªå·¥å…·ï¼Œå¯ä»¥å°†è¯¥å·¥å…·æ”¾åœ¨ç›®æ ‡çš„ä¾èµ–ä¸­ã€‚è¿™æ ·ï¼Œå½“æ‰§è¡Œè¯¥ç›®æ ‡æ—¶ï¼Œå°±å¯ä»¥æŒ‡å®šæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦å®‰è£…è¯¥å·¥å…·ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…åˆ™è‡ªåŠ¨å®‰è£…ï¼Œä»è€Œå®ç°æ›´é«˜ç¨‹åº¦çš„è‡ªåŠ¨åŒ–ã€‚ä¾‹å¦‚ï¼Œ`/Makefile` æ–‡ä»¶ä¸­ï¼Œ`format` ä¼ªç›®æ ‡ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```bash
.PHONY: format
format: tools.verify.golines tools.verify.goimports
  @echo "===========> Formating codes"
  @$(FIND) -type f -name '*.go' | $(XARGS) gofmt -s -w
  @$(FIND) -type f -name '*.go' | $(XARGS) goimports -w -local $(ROOT_PACKAGE)
  @$(FIND) -type f -name '*.go' | $(XARGS) golines -w --max-len=120 --reformat-tags --shorten-comments --ignore-generated .
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œformat ä¾èµ–`tools.verify.golines tools.verify.goimports`ã€‚æˆ‘ä»¬å†æ¥çœ‹ä¸‹`tools.verify.golines`çš„å®šä¹‰ï¼š

```bash
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```



å†æ¥çœ‹ä¸‹`tools.install.$*`è§„åˆ™ï¼š

```bash
.PHONY: install.golines
install.golines:
  @$(GO) get -u github.com/segmentio/golines
```

é€šè¿‡`tools.verify.%`è§„åˆ™å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ`tools.verify.%`ä¼šå…ˆæ£€æŸ¥å·¥å…·æ˜¯å¦å®‰è£…ï¼Œå¦‚æœæ²¡æœ‰å®‰è£…ï¼Œå°±ä¼šæ‰§è¡Œ`tools.install.$*`æ¥å®‰è£…ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ`tools.verify.%`ç›®æ ‡æ—¶ï¼Œå¦‚æœç³»ç»Ÿæ²¡æœ‰å®‰è£… golines å‘½ä»¤ï¼Œå°±ä¼šè‡ªåŠ¨è°ƒç”¨go getå®‰è£…ï¼Œæé«˜äº† Makefile çš„è‡ªåŠ¨åŒ–ç¨‹åº¦ã€‚



### æŠ€å·§ 4ï¼šæŠŠå¸¸ç”¨åŠŸèƒ½æ”¾åœ¨ /Makefile ä¸­ï¼Œä¸å¸¸ç”¨çš„æ”¾åœ¨åˆ†ç±» Makefile ä¸­

ä¸€ä¸ªé¡¹ç›®ï¼Œå°¤å…¶æ˜¯å¤§å‹é¡¹ç›®ï¼Œæœ‰å¾ˆå¤šéœ€è¦ç®¡ç†çš„åœ°æ–¹ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½å¯ä»¥é€šè¿‡ Makefile å®ç°è‡ªåŠ¨åŒ–æ“ä½œã€‚ä¸è¿‡ï¼Œä¸ºäº†ä¿æŒ `/Makefile` æ–‡ä»¶çš„æ•´æ´æ€§ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„å‘½ä»¤éƒ½æ·»åŠ åœ¨ `/Makefile` æ–‡ä»¶ä¸­ã€‚

ä¸€ä¸ªæ¯”è¾ƒå¥½çš„å»ºè®®æ˜¯ï¼Œå°†å¸¸ç”¨åŠŸèƒ½æ”¾åœ¨ /Makefile ä¸­ï¼Œä¸å¸¸ç”¨çš„æ”¾åœ¨åˆ†ç±» Makefile ä¸­ï¼Œå¹¶åœ¨ /Makefile ä¸­ include è¿™äº›åˆ†ç±» Makefileã€‚

ä¾‹å¦‚ï¼ŒIAM é¡¹ç›®çš„ /Makefile é›†æˆäº†formatã€lintã€testã€buildç­‰å¸¸ç”¨å‘½ä»¤ï¼Œè€Œå°†`gen.errcode.codeã€gen.errcode.doc`è¿™ç±»ä¸å¸¸ç”¨çš„åŠŸèƒ½æ”¾åœ¨ `scripts/make-rules/gen.mk` æ–‡ä»¶ä¸­ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ‰§è¡Œ make gen.errcode.codeæ¥æ‰§è¡Œgen.errcode.codeä¼ªç›®æ ‡ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ—¢å¯ä»¥ä¿è¯ /Makefile çš„ç®€æ´ã€æ˜“ç»´æŠ¤ï¼Œåˆå¯ä»¥é€šè¿‡makeå‘½ä»¤æ¥è¿è¡Œä¼ªç›®æ ‡ï¼Œæ›´åŠ çµæ´»ã€‚



### æŠ€å·§ 5ï¼šç¼–å†™å¯æ‰©å±•çš„ Makefile

ä»€ä¹ˆå«å¯æ‰©å±•çš„ Makefile å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥ï¼Œå¯æ‰©å±•çš„ Makefile åŒ…å«ä¸¤å±‚å«ä¹‰ï¼š

+ å¯ä»¥åœ¨ä¸æ”¹å˜ Makefile ç»“æ„çš„æƒ…å†µä¸‹æ·»åŠ æ–°åŠŸèƒ½ã€‚
+ æ‰©å±•é¡¹ç›®æ—¶ï¼Œæ–°åŠŸèƒ½å¯ä»¥è‡ªåŠ¨çº³å…¥åˆ° Makefile ç°æœ‰é€»è¾‘ä¸­ã€‚

å…¶ä¸­çš„ç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾è®¡åˆç†çš„ Makefile ç»“æ„æ¥å®ç°ã€‚è¦å®ç°ç¬¬äºŒç‚¹ï¼Œå°±éœ€è¦æˆ‘ä»¬åœ¨ç¼–å†™ Makefile æ—¶é‡‡ç”¨ä¸€å®šçš„æŠ€å·§ï¼Œä¾‹å¦‚å¤šç”¨é€šé…ç¬¦ã€è‡ªåŠ¨å˜é‡ã€å‡½æ•°ç­‰ã€‚è¿™é‡Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥è®©ä½ æ›´å¥½åœ°ç†è§£ã€‚

åœ¨æˆ‘ä»¬ IAM å®æˆ˜é¡¹ç›®çš„golang.mkä¸­ï¼Œæ‰§è¡Œ `make go.build` æ—¶èƒ½å¤Ÿæ„å»º `cmd/` ç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æœ‰æ–°ç»„ä»¶æ·»åŠ æ—¶ï¼Œ `make go.build` ä»ç„¶èƒ½å¤Ÿæ„å»ºæ–°å¢çš„ç»„ä»¶ï¼Œè¿™å°±å®ç°äº†ä¸Šé¢è¯´çš„ç¬¬äºŒç‚¹ã€‚

å…·ä½“å®ç°æ–¹æ³•å¦‚ä¸‹ï¼š

```makefile

COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))

.PHONY: go.build
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
.PHONY: go.build.%               

go.build.%:             
  $(eval COMMAND := $(word 2,$(subst ., ,$*)))
  $(eval PLATFORM := $(word 1,$(subst ., ,$*)))
  $(eval OS := $(word 1,$(subst _, ,$(PLATFORM))))           
  $(eval ARCH := $(word 2,$(subst _, ,$(PLATFORM))))                         
  @echo "===========> Building binary $(COMMAND) $(VERSION) for $(OS) $(ARCH)"
  @mkdir -p $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)
  @CGO_ENABLED=0 GOOS=$(OS) GOARCH=$(ARCH) $(GO) build $(GO_BUILD_FLAGS) -o $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)/$(COMMAND)$(GO_OUT_EXT) $(ROOT_PACKAGE)/cmd/$(COMMAND)
COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))

.PHONY: go.build
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
.PHONY: go.build.%               

go.build.%:             
  $(eval COMMAND := $(word 2,$(subst ., ,$*)))
  $(eval PLATFORM := $(word 1,$(subst ., ,$*)))
  $(eval OS := $(word 1,$(subst _, ,$(PLATFORM))))           
  $(eval ARCH := $(word 2,$(subst _, ,$(PLATFORM))))                         
  @echo "===========> Building binary $(COMMAND) $(VERSION) for $(OS) $(ARCH)"
  @mkdir -p $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)
  @CGO_ENABLED=0 GOOS=$(OS) GOARCH=$(ARCH) $(GO) build $(GO_BUILD_FLAGS) -o $(OUTPUT_DIR)/platforms/$(OS)/$(ARCH)/$(COMMAND)$(GO_OUT_EXT) $(ROOT_PACKAGE)/cmd/$(COMMAND)
```

å½“æ‰§è¡Œmake go.build æ—¶ï¼Œä¼šæ‰§è¡Œ go.build çš„ä¾èµ– `$(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS))`) ,`addprefix`å‡½æ•°æœ€ç»ˆè¿”å›å­—ç¬¦ä¸² `go.build.linux_amd64.iamctl go.build.linux_amd64.iam-authz-server go.build.linux_amd64.iam-apiserver ...` ï¼Œè¿™æ—¶å€™å°±ä¼šæ‰§è¡Œ `go.build.%` ä¼ªç›®æ ‡ã€‚

åœ¨ `go.build.%` ä¼ªç›®æ ‡ä¸­ï¼Œé€šè¿‡ evalã€wordã€subst å‡½æ•°ç»„åˆï¼Œç®—å‡ºäº† COMMAND çš„å€¼ `iamctl/iam-apiserver/iam-authz-server/...`ï¼Œæœ€ç»ˆé€šè¿‡ `$(ROOT_PACKAGE)/cmd/$(COMMAND)` å®šä½åˆ°éœ€è¦æ„å»ºçš„ç»„ä»¶çš„ main å‡½æ•°æ‰€åœ¨ç›®å½•ã€‚

ä¸Šè¿°å®ç°ä¸­æœ‰ä¸¤ä¸ªæŠ€å·§ï¼Œä½ å¯ä»¥æ³¨æ„ä¸‹ã€‚é¦–å…ˆï¼Œé€šè¿‡

```bash
COMMANDS ?= $(filter-out %.md, $(wildcard ${ROOT_DIR}/cmd/*))
BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))
```

è·å–åˆ°äº† cmd/ ç›®å½•ä¸‹çš„æ‰€æœ‰ç»„ä»¶åã€‚

æ¥ç€ï¼Œé€šè¿‡ä½¿ç”¨é€šé…ç¬¦å’Œè‡ªåŠ¨å˜é‡ï¼Œè‡ªåŠ¨åŒ¹é…åˆ°`go.build.linux_amd64.iam-authz-server` è¿™ç±»ä¼ªç›®æ ‡å¹¶æ„å»ºã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæƒ³è¦ç¼–å†™ä¸€ä¸ªå¯æ‰©å±•çš„ Makefileï¼Œç†Ÿç»ƒæŒæ¡ Makefile çš„ç”¨æ³•æ˜¯åŸºç¡€ï¼Œæ›´å¤šçš„æ˜¯éœ€è¦æˆ‘ä»¬åŠ¨è„‘æ€è€ƒå¦‚ä½•å»ç¼–å†™ Makefileã€‚



### æŠ€å·§ 6ï¼šå°†æ‰€æœ‰è¾“å‡ºå­˜æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ–¹ä¾¿æ¸…ç†å’ŒæŸ¥æ‰¾

åœ¨æ‰§è¡Œ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¾“å‡ºå„ç§å„æ ·çš„æ–‡ä»¶ï¼Œä¾‹å¦‚ Go ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€æµ‹è¯•è¦†ç›–ç‡æ•°æ®ç­‰ï¼Œæˆ‘å»ºè®®ä½ æŠŠè¿™äº›æ–‡ä»¶ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸‹ï¼Œæ–¹ä¾¿åæœŸçš„æ¸…ç†å’ŒæŸ¥æ‰¾ã€‚é€šå¸¸æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬æ”¾åœ¨`_output`è¿™ç±»ç›®å½•ä¸‹ï¼Œè¿™æ ·æ¸…ç†æ—¶å°±å¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦æ¸…ç†`_output`æ–‡ä»¶å¤¹å°±å¯ä»¥ï¼Œä¾‹å¦‚ï¼š

```bash
.PHONY: go.clean
go.clean:
  @echo "===========> Cleaning all build output"
  @-rm -vrf $(OUTPUT_DIR)
```

è¿™é‡Œè¦æ³¨æ„ï¼Œè¦ç”¨`-rm`ï¼Œè€Œä¸æ˜¯rmï¼Œé˜²æ­¢åœ¨æ²¡æœ‰`_output`ç›®å½•æ—¶ï¼Œæ‰§è¡Œ`make go.clean`æŠ¥é”™ã€‚



### æŠ€å·§ 7ï¼šä½¿ç”¨å¸¦å±‚çº§çš„å‘½åæ–¹å¼

é€šè¿‡ä½¿ç”¨å¸¦å±‚çº§çš„å‘½åæ–¹å¼ï¼Œä¾‹å¦‚`tools.verify.swagger` ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ç›®æ ‡åˆ†ç»„ç®¡ç†ã€‚è¿™æ ·åšçš„å¥½å¤„æœ‰å¾ˆå¤šã€‚é¦–å…ˆï¼Œå½“ Makefile æœ‰å¤§é‡ç›®æ ‡æ—¶ï¼Œé€šè¿‡åˆ†ç»„ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°ç®¡ç†è¿™äº›ç›®æ ‡ã€‚å…¶æ¬¡ï¼Œåˆ†ç»„ä¹Ÿèƒ½æ–¹ä¾¿ç†è§£ï¼Œå¯ä»¥é€šè¿‡ç»„åä¸€çœ¼è¯†åˆ«å‡ºè¯¥ç›®æ ‡çš„åŠŸèƒ½ç±»åˆ«ã€‚æœ€åï¼Œè¿™æ ·åšè¿˜å¯ä»¥å¤§å¤§å‡å°ç›®æ ‡é‡åçš„æ¦‚ç‡ã€‚

ä¾‹å¦‚ï¼ŒIAM é¡¹ç›®çš„ Makefile å°±å¤§é‡é‡‡ç”¨äº†ä¸‹é¢è¿™ç§å‘½åæ–¹å¼ã€‚

```makefile

.PHONY: gen.run
gen.run: gen.clean gen.errcode gen.docgo

.PHONY: gen.errcode
gen.errcode: gen.errcode.code gen.errcode.doc

.PHONY: gen.errcode.code
gen.errcode.code: tools.verify.codegen
    ...
.PHONY: gen.errcode.doc
gen.errcode.doc: tools.verify.codegen
    ...
```



### æŠ€å·§ 8ï¼šåšå¥½ç›®æ ‡æ‹†åˆ†

è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå®ç”¨çš„æŠ€å·§ï¼šæˆ‘ä»¬è¦åˆç†åœ°æ‹†åˆ†ç›®æ ‡ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®‰è£…å·¥å…·æ‹†åˆ†æˆä¸¤ä¸ªç›®æ ‡ï¼šéªŒè¯å·¥å…·æ˜¯å¦å·²å®‰è£…å’Œå®‰è£…å·¥å…·ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ç»™æˆ‘ä»¬çš„ Makefile å¸¦æ¥æ›´å¤§çš„çµæ´»æ€§ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©æ€§åœ°æ‰§è¡Œå…¶ä¸­ä¸€ä¸ªæ“ä½œï¼Œä¹Ÿå¯ä»¥ä¸¤ä¸ªæ“ä½œä¸€èµ·æ‰§è¡Œã€‚

è¿™é‡Œæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```makefile
gen.errcode.code: tools.verify.codegen

tools.verify.%:    
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi  

.PHONY: install.codegen
install.codegen:              
  @$(GO) install ${ROOT_DIR}/tools/codegen/codegen.go
```

ä¸Šé¢çš„ Makefile ä¸­ï¼Œ`gen.errcode.code` ä¾èµ–äº† `tools.verify.codegen`ï¼Œ`tools.verify.codegen` ä¼šå…ˆæ£€æŸ¥ codegen å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå†è°ƒç”¨ install.codegen æ¥å®‰è£… codegen å·¥å…·ã€‚

å¦‚æœæˆ‘ä»¬çš„ Makefile è®¾è®¡æ˜¯ï¼š

```bash
gen.errcode.code: install.codegen
```

é‚£æ¯æ¬¡æ‰§è¡Œ gen.errcode.code éƒ½è¦é‡æ–°å®‰è£… codegen å‘½ä»¤ï¼Œè¿™ç§æ“ä½œæ˜¯ä¸å¿…è¦çš„ï¼Œè¿˜ä¼šå¯¼è‡´ make gen.errcode.code æ‰§è¡Œå¾ˆæ…¢ã€‚



### æŠ€å·§ 9ï¼šè®¾ç½® OPTIONS

ç¼–å†™ Makefile æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠä¸€äº›å¯å˜çš„åŠŸèƒ½é€šè¿‡ OPTIONS æ¥æ§åˆ¶ã€‚ä¸ºäº†å¸®åŠ©ä½ ç†è§£ï¼Œè¿™é‡Œè¿˜æ˜¯æ‹¿ IAM é¡¹ç›®çš„ Makefile æ¥ä¸¾ä¾‹ã€‚

å‡è®¾æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªé€‰é¡¹ V ï¼Œæ¥æ§åˆ¶æ˜¯å¦éœ€è¦åœ¨æ‰§è¡Œ Makefile æ—¶æ‰“å°è¯¦ç»†çš„ä¿¡æ¯ã€‚è¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤æ¥å®ç°ã€‚

é¦–å…ˆï¼Œåœ¨ `/Makefile` ä¸­å®šä¹‰ `USAGE_OPTIONS` ã€‚å®šä¹‰ `USAGE_OPTIONS` å¯ä»¥ä½¿å¼€å‘è€…åœ¨æ‰§è¡Œ make help åæ„ŸçŸ¥åˆ°æ­¤ OPTIONï¼Œå¹¶æ ¹æ®éœ€è¦è¿›è¡Œè®¾ç½®ã€‚

```bash
define USAGE_OPTIONS    
                         
Options:
  ...
  BINS         The binaries to build. Default is all of cmd.
               ...
  ...
  V            Set to 1 enable verbose build. Default is 0.    
endef    
export USAGE_OPTIONS    
```

æ¥ç€ï¼Œåœ¨`scripts/make-rules/common.mk`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åˆ¤æ–­æœ‰æ²¡æœ‰è®¾ç½® V é€‰é¡¹ï¼Œæ¥é€‰æ‹©ä¸åŒçš„è¡Œä¸ºï¼š

```makefile
ifndef V    
MAKEFLAGS += --no-print-directory    
endif
```

å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•æ¥ä½¿ç”¨ V ï¼š

```bash
ifeq ($(origin V), undefined)                                
MAKEFLAGS += --no-print-directory              
endif
```

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº† V OPTIONï¼Œæˆ‘ä»¬åœ¨ Makefile ä¸­é€šè¿‡åˆ¤æ–­æœ‰æ²¡æœ‰å®šä¹‰ V ï¼Œæ¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚å…¶å®è¿˜æœ‰ä¸€ç§ OPTIONï¼Œè¿™ç§ OPTION çš„å€¼æˆ‘ä»¬åœ¨ Makefile ä¸­æ˜¯ç›´æ¥ä½¿ç”¨çš„ï¼Œä¾‹å¦‚BINSã€‚é’ˆå¯¹è¿™ç§ OPTIONï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥ä½¿ç”¨ï¼š

```bash

BINS ?= $(foreach cmd,${COMMANDS},$(notdir ${cmd}))
...
go.build: go.build.verify $(addprefix go.build., $(addprefix $(PLATFORM)., $(BINS)))
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡ ?= æ¥åˆ¤æ–­ BINS å˜é‡æœ‰æ²¡æœ‰è¢«èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™èµ‹äºˆç­‰å·åçš„å€¼ã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åœ¨ Makefile è§„åˆ™ä¸­ä½¿ç”¨å®ƒã€‚



### æŠ€å·§ 10ï¼šå®šä¹‰ç¯å¢ƒå˜é‡

æˆ‘ä»¬å¯ä»¥åœ¨ Makefile ä¸­å®šä¹‰ä¸€äº›ç¯å¢ƒå˜é‡ï¼Œä¾‹å¦‚ï¼š

```makefile
GO := go                                          
GO_SUPPORTED_VERSIONS ?= 1.13|1.14|1.15|1.16|1.17    
GO_LDFLAGS += -X $(VERSION_PACKAGE).GitVersion=$(VERSION) \    
  -X $(VERSION_PACKAGE).GitCommit=$(GIT_COMMIT) \       
  -X $(VERSION_PACKAGE).GitTreeState=$(GIT_TREE_STATE) \                          
  -X $(VERSION_PACKAGE).BuildDate=$(shell date -u +'%Y-%m-%dT%H:%M:%SZ')    
ifneq ($(DLV),)                                                                                                                              
  GO_BUILD_FLAGS += -gcflags "all=-N -l"    
  LDFLAGS = ""      
endif                                                                                   
GO_BUILD_FLAGS += -tags=jsoniter -ldflags "$(GO_LDFLAGS)" 
...
FIND := find . ! -path './third_party/*' ! -path './vendor/*'    
XARGS := xargs --no-run-if-empty 
```

è¿™äº›ç¯å¢ƒå˜é‡å’Œç¼–ç¨‹ä¸­ä½¿ç”¨å®å®šä¹‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼šåªè¦ä¿®æ”¹ä¸€å¤„ï¼Œå°±å¯ä»¥ä½¿å¾ˆå¤šåœ°æ–¹åŒæ—¶ç”Ÿæ•ˆï¼Œé¿å…äº†é‡å¤çš„å·¥ä½œã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥å°† GOã€GO_BUILD_FLAGSã€FIND è¿™ç±»å˜é‡å®šä¹‰ä¸ºç¯å¢ƒå˜é‡ã€‚



### æŠ€å·§ 11ï¼šè‡ªå·±è°ƒç”¨è‡ªå·±

åœ¨ç¼–å†™ Makefile çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°è¿™æ ·ä¸€ç§æƒ…å†µï¼šA-Target ç›®æ ‡å‘½ä»¤ä¸­ï¼Œéœ€è¦å®Œæˆæ“ä½œ B-Actionï¼Œè€Œæ“ä½œ B-Action æˆ‘ä»¬å·²ç»é€šè¿‡ä¼ªç›®æ ‡ B-Target å®ç°è¿‡ã€‚ä¸ºäº†è¾¾åˆ°æœ€å¤§çš„ä»£ç å¤ç”¨åº¦ï¼Œè¿™æ—¶å€™æœ€å¥½çš„æ–¹å¼æ˜¯åœ¨ A-Target çš„å‘½ä»¤ä¸­æ‰§è¡Œ B-Targetã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
tools.verify.%:
  @if ! which $* &>/dev/null; then $(MAKE) tools.install.$*; fi
```



è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ `$(MAKE)` è°ƒç”¨äº†ä¼ªç›®æ ‡ `tools.install.$*` ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒMakefile åœ¨åˆ‡æ¢ç›®å½•æ—¶ä¼šè¾“å‡ºä»¥ä¸‹ä¿¡æ¯ï¼š

```makefile
$ make tools.install.codegen
===========> Installing codegen
make[1]: Entering directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam'
make[1]: Leaving directory `/home/colin/workspace/golang/src/github.com/marmotedu/iam'
```

å¦‚æœè§‰å¾— Entering directory è¿™ç±»ä¿¡æ¯å¾ˆçƒ¦äººï¼Œå¯ä»¥é€šè¿‡è®¾ç½® `MAKEFLAGS += --no-print-directory` æ¥ç¦æ­¢ Makefile æ‰“å°è¿™äº›ä¿¡æ¯ã€‚



## æ€»ç»“

**è§„èŒƒçš„ Makefile  æ–‡ä»¶éœ€è¦çš„æ­¥éª¤ï¼š**

1. vé¦–å…ˆï¼Œä½ éœ€è¦ç†Ÿç»ƒæŒæ¡ Makefile çš„è¯­æ³•ã€‚æˆ‘å»ºè®®ä½ é‡ç‚¹æŒæ¡ä»¥ä¸‹è¯­æ³•ï¼šMakefile è§„åˆ™è¯­æ³•ã€ä¼ªç›®æ ‡ã€å˜é‡èµ‹å€¼ã€ç‰¹æ®Šå˜é‡ã€è‡ªåŠ¨åŒ–å˜é‡ã€‚
2. æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦æå‰è§„åˆ’ Makefile è¦å®ç°çš„åŠŸèƒ½ã€‚ä¸€ä¸ªå¤§å‹ Go é¡¹ç›®é€šå¸¸éœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼šä»£ç ç”Ÿæˆç±»å‘½ä»¤ã€æ ¼å¼åŒ–ç±»å‘½ä»¤ã€é™æ€ä»£ç æ£€æŸ¥ã€ æµ‹è¯•ç±»å‘½ä»¤ã€æ„å»ºç±»å‘½ä»¤ã€Docker é•œåƒæ‰“åŒ…ç±»å‘½ä»¤ã€éƒ¨ç½²ç±»å‘½ä»¤ã€æ¸…ç†ç±»å‘½ä»¤ï¼Œç­‰ç­‰ã€‚
3. ç„¶åï¼Œæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡ Makefile åŠŸèƒ½åˆ†ç±»ã€æ–‡ä»¶åˆ†å±‚ã€å¤æ‚å‘½ä»¤è„šæœ¬åŒ–ç­‰æ–¹å¼ï¼Œæ¥è®¾è®¡ä¸€ä¸ªåˆç†çš„ Makefile ç»“æ„ã€‚
4. æœ€åï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŒæ¡ä¸€äº› Makefile ç¼–å†™æŠ€å·§ï¼Œä¾‹å¦‚ï¼šå–„ç”¨é€šé…ç¬¦ã€è‡ªåŠ¨å˜é‡å’Œå‡½æ•°ï¼›ç¼–å†™å¯æ‰©å±•çš„ Makefileï¼›ä½¿ç”¨å¸¦å±‚çº§çš„å‘½åæ–¹å¼ï¼Œç­‰ç­‰ã€‚é€šè¿‡è¿™äº›æŠ€å·§ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¿è¯æˆ‘ä»¬ç¼–å†™å‡ºä¸€ä¸ªé«˜è´¨é‡çš„ Makefileã€‚





## END é“¾æ¥

<ul><li><div><a href = '6.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '8.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 



### LInks

+ https://time.geekbang.org/column/article/389115
+ https://github.com/cubxxw/iam/blob/master/Makefile
+ https://seisman.github.io/how-to-write-makefile/rules.html
+ https://colynn.github.io/2020-03-03-using_makefile/
