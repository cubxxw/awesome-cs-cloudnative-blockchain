+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬13èŠ‚  ä» 0 ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…

<br>
<div><a href = '12.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '14.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…

åœ¨åšé¡¹ç›®å¼€å‘æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»0ç¼–å†™è‡ªå·±çš„æ—¥å¿—åŒ…ã€ä¹Ÿå¯ä»¥ä½¿ç”¨Goè¯­è¨€æ ‡å‡†åº“çš„logåŒ…ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¼€æºçš„æ—¥å¿—åŒ…ï¼Œä½†æ›´å¤šçš„æ˜¯åŸºäºä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ¥å®ç°å®šåˆ¶åŒ–çš„æ—¥å¿—åŠŸèƒ½ã€‚Goç”Ÿæ€ä¸­ä¹Ÿæœ‰ä¸€äº›éå¸¸ä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…ï¼Œä¾‹å¦‚æ ‡å‡†åº“logåŒ…ã€glogã€logrusã€zapã€seelogã€zerologç­‰ã€‚ç”¨çš„æ¯”è¾ƒå¤šçš„æ˜¯`glog`ã€`logrus`å’Œ`zap`ã€‚



## æ ‡å‡†åº“logåŒ…ä½¿ç”¨

æ ‡å‡†åº“logåŒ…åŠŸèƒ½éå¸¸ç®€å•ï¼Œæä¾›äº†å¼€ç®±ï¼Œä»…æä¾›äº†Printã€Panicå’ŒFatalä¸‰ç±»å‡½æ•°ç”¨äºæ—¥å¿—è¾“å‡ºã€‚å› ä¸ºæ˜¯æ ‡å‡†åº“è‡ªå¸¦çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æˆ‘ä»¬ä¸‹è½½å®‰è£…ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æ ‡å‡†åº“logåŒ…åªæœ‰ä¸åˆ°400è¡Œçš„ä»£ç é‡ï¼Œå¦‚æœè¯»è€…æƒ³ç ”ç©¶å¦‚ä½•å®ç°ä¸€ä¸ªæ—¥å¿—åŒ…ï¼Œé˜…è¯»æ ‡å‡†åº“logåŒ…æ˜¯ä¸€ä¸ªä¸é”™çš„å¼€å§‹ã€‚Goçš„æ ‡å‡†åº“å¤§é‡ä½¿ç”¨äº†logåŒ…ï¼Œä¾‹å¦‚ï¼š`net/httpã€net/rpc`ç­‰ã€‚

**logåŒ…ä½¿ç”¨**

åœ¨ä½¿ç”¨logåŒ…æ—¶ï¼Œéœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ª`*log. Logger`ç±»å‹çš„logå®ä¾‹ï¼Œæ‰€æœ‰çš„æ—¥å¿—è¾“å‡ºéƒ½æ˜¯é€šè¿‡è¯¥å®ä¾‹æä¾›çš„æ–¹æ³•æ¥å®Œæˆçš„ã€‚

å¯ä»¥ä½¿ç”¨logåŒ…æä¾›çš„å…¨å±€å…¨å±€å˜é‡`std`ï¼Œ`std`å®šä¹‰å¦‚ä¸‹ï¼ˆä½äºGoæ ‡å‡†åŒ…logç›®å½•ä¸‹çš„log.goæ–‡ä»¶ä¸­ï¼‰ï¼š

```go
var std = New(os.Stderr, "", LstdFlags)
```

ä¹Ÿä¹Ÿå¯ä»¥ä½¿ç”¨`log.Newå‡½`æ•°åˆ›å»ºè‡ªå·±çš„loggerï¼Œåœ¨åˆ›å»ºæ—¶ï¼Œå¯ä»¥æŒ‡å®šè¾“å‡ºçš„ä½ç½®ã€æ¯è¡Œæ—¥å¿—çš„å‰ç¼€å’Œæ—¥å¿—å±æ€§ï¼Œä¾‹å¦‚ï¼š

```
logger := log.New(logFile, "[Debug]", log.Lshortfile)
```

æœ‰å¦‚ä¸‹å‡ ç§æ—¥å¿—å±æ€§å¯ä¾›é€‰æ‹©ï¼š

+ Ldateï¼šå½“å‰æ—¶åŒºçš„æ—¥æœŸï¼Œæ ¼å¼æ˜¯ï¼š2009/01/23ã€‚
+ Ltimeï¼šå½“å‰æ—¶åŒºçš„æ—¶é—´ï¼Œæ ¼å¼æ˜¯ï¼š01:23:23ï¼Œç²¾ç¡®åˆ°ç§’ã€‚
+ Lmicrosecondsï¼šå½“å‰æ—¶åŒºçš„æ—¶é—´ï¼Œæ ¼å¼æ˜¯ï¼š01:23:23.862600ï¼Œç²¾ç¡®åˆ°å¾®å¦™ã€‚
+ Llongfileï¼šå…¨æ–‡ä»¶åå’Œè¡Œå·ã€‚
+ Lshortfileï¼šå½“å‰æ–‡ä»¶åå’Œè¡Œå·ï¼Œä¼šè¦†ç›–Llongfileã€‚
+ LUTCï¼šä½¿ç”¨UTCè€Œéæœ¬åœ°æ—¶åŒºã€‚
+ Lmsgprefixï¼šå°†â€œå‰ç¼€â€ä»è¡Œçš„å¼€å¤´ç§»è‡³æ¶ˆæ¯ä¹‹å‰ã€‚
+ LstdFlagsï¼šæ ‡å‡†Loggerçš„é»˜è®¤å€¼ï¼ˆLdateã€Ltimeï¼‰ã€‚

é™¤äº†åœ¨æ‰§è¡Œlog.Newæ—¶é…ç½®log.Loggerä¹‹å¤–ï¼Œåˆ›å»ºä¹‹åè¿˜å¯ä»¥é€šè¿‡log.Loggeræä¾›çš„3ç§æ–¹æ³•æ¥æ”¹å˜log.Loggerçš„é…ç½®ï¼š

+ SetOutputï¼šæŒ‡å®šè¾“å‡ºçš„ä½ç½®ã€‚
+ SetPrefixï¼šè®¾ç½®æ¯è¡Œæ—¥å¿—çš„å‰ç¼€ã€‚
+ SetFlagsï¼šè®¾ç½®æ—¥å¿—å±æ€§ã€‚

log.Loggeræä¾›äº†Printã€Panicã€Fatalå‡½æ•°æ¥è®°å½•æ—¥å¿—ï¼š

+ Printï¼šæ‰“å°æ—¥å¿—ï¼Œä¾‹å¦‚ï¼šlog.Print("call Print: line1")
+ Panicï¼šæ‰“å°æ—¥å¿—åæ‰§è¡Œpanic(s)ï¼Œsä¸ºæ—¥å¿—å†…å®¹ã€‚
+ Fatalï¼šæ‰“å°æ—¥å¿—åæ‰§è¡Œos.Exit(1)ã€‚

Printã€Panicã€Fatalå‡½æ•°è¿˜æä¾›Printlnã€Printfã€Paniclnã€Panicfã€Fatallnã€Fatalfæ¥æ ¼å¼åŒ–æ‰“å°æ—¥å¿—ã€‚Printåº•å±‚è°ƒç”¨`fmt.Sprint(v...)`ï¼ŒPrintlnåº•å±‚è°ƒç”¨`fmt.Sprintln(v...)`ï¼ŒPrintfåº•å±‚è°ƒç”¨äº†`fmt.Sprintf(format, v...)`ã€‚

æ ‡å‡†åº“logçš„ä½¿ç”¨ç¤ºä¾‹ï¼ˆmain.goæ–‡ä»¶ï¼‰ï¼š

```
package main

import (
    "log"
    "os"
)

func main() {
    // è¾“å‡ºåˆ°æ–‡ä»¶
    logFile, err := os.Create("./log.log")
    defer logFile.Close()
    if err != nil {
        log.Fatalln("create file log.log failed")
    }
    logger := log.New(logFile, "[Debug] ", log.Lshortfile)
    logger.SetOutput(os.Stdout)
    logger.Print("call Print: line1")
    logger.Println("call Println: line2")

    // ä¿®æ”¹æ—¥å¿—é…ç½®
    logger.SetPrefix("[Info] ")
    logger.SetFlags(log.Ldate)
    logger.SetOutput(os.Stdout)
    logger.Print("Info check stdout")
}
```

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ‰§è¡Œä¸Šè¿°ç¨‹åºï¼š

```
$ go run main.go
[Debug] main.go:17: call Print: line1
[Debug] main.go:18: call Println: line2
[Info] 2020/11/28 Info check stdout
```



## glog

[glog](https://github.com/golang/glog)æ˜¯Googleæ¨å‡ºçš„æ—¥å¿—åŒ…ï¼Œè·Ÿæ ‡å‡†åº“logåŒ…ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—åŒ…ï¼Œä½¿ç”¨ç®€å•æ–¹ä¾¿ï¼Œä½†è¦æ¯”æ ‡å‡†åº“logåŒ…æä¾›æ›´å¤šçš„åŠŸèƒ½ï¼Œglogå…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

+ æ”¯æŒ4ç§æ—¥å¿—çº§åˆ«ï¼šINFOã€WARNINGã€ERRORã€FATALã€‚
+ æ”¯æŒå‘½ä»¤è¡Œé€‰é¡¹ï¼Œä¾‹å¦‚ï¼š`-alsologtostderr`ã€`-log_backtrace_at`ã€`-log_dir`ã€`-logtostderr`ã€`-v`ç­‰ï¼Œæ¯ä¸ªå‚æ•°å®ç°æŸç§åŠŸèƒ½ã€‚
+ æ”¯æŒæ ¹æ®æ–‡ä»¶å¤§å°åˆ‡å‰²æ—¥å¿—æ–‡ä»¶ã€‚
+ æ”¯æŒæ—¥å¿—æŒ‰çº§åˆ«åˆ†ç±»è¾“å‡ºã€‚
+ æ”¯æŒV levelï¼ŒV levelç‰¹æ€§å¯ä»¥ä½¿å¼€å‘è€…è‡ªå®šä¹‰æ—¥å¿—çº§åˆ«ã€‚
+ æ”¯æŒvmoduleï¼Œvmoduleå¯ä»¥ä½¿å¼€å‘è€…å¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ã€‚
+ æ”¯æŒtraceLocationï¼ŒtraceLocationå¯ä»¥æ‰“å°å‡ºæŒ‡å®šä½ç½®çš„æ ˆä¿¡æ¯ã€‚

kubernetesé¡¹ç›®å°±ä½¿ç”¨äº†åŸºäºglogå°è£…çš„klogä½œä¸ºå…¶æ—¥å¿—åº“ã€‚

**glogä½¿ç”¨æ–¹æ³•**

glogä½¿ç”¨éå¸¸ç®€å•ï¼Œå¸¸è§çš„ç”¨æ³•å¦‚ä¸‹ã€‚

1. åŸºæœ¬ç”¨æ³•

glogçš„æœ€å¸¸ç”¨çš„ä½¿ç”¨æ–¹æ³•ï¼š

```
package main

import (
    "flag"

    "github.com/golang/glog"
)

func main() {
    glog.MaxSize = 1024 * 1024 * 1024 // 1Gè‡ªåŠ¨åˆ†å‰²
    flag.Parse()
    defer glog.Flush()

    glog.Info("This is info message")
    glog.Infof("This is info message: %v", 123)

    glog.Warning("This is warning message")
    glog.Warningf("This is warning message: %v", 123)

    glog.Error("This is error message")
    glog.Errorf("This is error message: %v", 123)

    //glog.Fatal("This is fatal message")
    //glog.Fatalf("This is fatal message: %v", 123)
}
```

glogæ”¯æŒ4ç§æ—¥å¿—çº§åˆ«ï¼Œä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šINFOã€WARNINGã€ERRORã€FATALã€‚glogæ”¯æŒå‘½ä»¤è¡Œå‚æ•°ï¼Œåœ¨ç¨‹åºä¸­ï¼Œåªéœ€è¦åœ¨ä½¿ç”¨glogä¹‹å‰è°ƒç”¨flag.Parse()å³å¯ï¼Œæ”¯æŒå¦‚ä¸‹7ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼š

+ `-alsologtostderr`ï¼šåŒæ—¶å°†æ—¥å¿—æ‰“å°åˆ°æ–‡ä»¶å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚
+ `-log_backtrace_at value`ï¼šæŒ‡å®šä»£ç è¿è¡Œåˆ°æŒ‡å®šè¡Œæ—¶ï¼ŒæŠŠè¯¥ä»£ç çš„æ ˆä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚
+ `-log_dir`ï¼šæŒ‡å®šæ—¥å¿—å­˜å‚¨çš„æ–‡ä»¶å¤¹ã€‚
+ `-logtostderr`ï¼šæ—¥å¿—æ‰“å°åˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œè€Œä¸æ˜¯æ–‡ä»¶ä¸­ã€‚
+ `-stderrthreshold value`ï¼šæŒ‡å®šå¤§äºæˆ–è€…ç­‰äºè¯¥çº§åˆ«çš„æ—¥å¿—æ‰ä¼šè¢«è¾“å‡ºåˆ°æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œé»˜è®¤ä¸ºERRORã€‚
+ `-v value`ï¼šæŒ‡å®šæ—¥å¿—çº§åˆ«ã€‚
+ `-vmodule value`ï¼šå¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ã€‚

æ‰§è¡Œä¸Šè¿°ä»£ç ï¼ˆå‡è®¾ä¿å­˜åœ¨example1.goæ–‡ä»¶ä¸­ï¼‰ï¼š

```
$ mkdir -p log && go run example1.go -log_dir=log -alsologtostderr
I1202 09:43:49.618480   26223 example1.go:14] This is info message
I1202 09:43:49.618781   26223 example1.go:15] This is info message: 123
W1202 09:43:49.618792   26223 example1.go:17] This is warning message
W1202 09:43:49.618830   26223 example1.go:18] This is warning message: 123
E1202 09:43:49.618840   26223 example1.go:20] This is error message
E1202 09:43:49.618877   26223 example1.go:21] This is error message: 123
```

ä»¥ä¸Šå‘½ä»¤ä¼šåŒæ—¶å°†æ—¥å¿—æ‰“å°åœ¨logç›®å½•å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºä¸­ï¼ˆ`-alsologtostderr`ï¼‰ï¼Œlogç›®å½•ä¸‹æ–‡ä»¶åˆ—è¡¨ä¸ºï¼š

```
main.colin.colin.log.ERROR.20201202-081133.24123
main.colin.colin.log.INFO.20201202-081133.24123
main.colin.colin.log.WARNING.20201202-081133.24123
main.ERROR -> main.colin.colin.log.ERROR.20201202-081133.24123
main.INFO -> main.colin.colin.log.INFO.20201202-081133.24123
main.WARNING -> main.colin.colin.log.WARNING.20201202-081133.24123
```

main.INFOæ–‡ä»¶æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼Œé“¾æ¥åˆ°æœ€æ–°çš„INFOçº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ï¼Œä½ä¼˜å…ˆçº§çš„æ—¥å¿—æ–‡ä»¶åŒ…å«é«˜ä¼˜å…ˆçº§çš„æ—¥å¿—ï¼Œä¾‹å¦‚INFOçº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ä¸­åŒ…å«WARNINGã€ERRORã€FATALçº§åˆ«çš„æ—¥å¿—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾¾åˆ°1.8Gæ—¶,ï¼Œglogä¼šå¯¹æ—¥å¿—æ–‡ä»¶è¿›è¡Œè½¬å­˜ï¼šå…³é—­å½“å‰çš„æ–‡ä»¶ï¼Œæ–°å»ºæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡glog.MaxSizeè®¾ç½®è½¬å­˜é˜ˆå€¼ã€‚

ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥å‘ç°ï¼Œglogçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ä¸ºï¼š`<header>] <message>`ï¼Œå…¶ä¸­headerçš„æ ¼å¼ä¸ºï¼š`Lmmdd hh:mm:ss.uuuuuu threadid file:line`ï¼š

+ Lmmddï¼šLä»£è¡¨äº†glogçš„æ—¥å¿—çº§åˆ«ï¼šI -> INFOã€W -> WARNINGã€E -> ERRORã€F -> FATALã€‚
+ hh:mm:ss.uuuuuuï¼šä»£è¡¨äº†æ—¶é—´ä¿¡æ¯ï¼Œä¾‹å¦‚10:12:32.995956ã€‚
+ threadidï¼Œæ˜¯è¿›ç¨‹PIDï¼Œå³os.Getpid()çš„è¿”å›å€¼ã€‚
+ file:lineï¼šæŒ‡æ˜äº†æ‰“å°æ—¥å¿—çš„ä½ç½®ï¼šæ–‡ä»¶åå’Œè¡Œå·ã€‚

ä½¿ç”¨glog.Infoã€glog.Warningç­‰å‡½æ•°è®°å½•æ—¥å¿—åï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œè¿™äº›æ—¥å¿—ä¼šæš‚å­˜åœ¨å†…å­˜çš„bufferä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥æ–‡ä»¶ä¸­ï¼Œåªæœ‰æ˜¾å¼çš„è°ƒç”¨glog.Flush()ï¼Œæ•°æ®æ‰ä¼šè¢«å†™å…¥æ–‡ä»¶ã€‚glogçš„initå‡½æ•°ä¸­å¯åŠ¨äº†ä¸€ä¸ªgoroutineæ¥å‘¨æœŸæ€§çš„è°ƒç”¨glog.Flush()ï¼Œé»˜è®¤çš„flushé—´éš”ä¸º30ç§’ã€‚å¦‚æœç¨‹åºé€€å‡ºï¼Œè‡ªä¸Šæ¬¡glog.Flush()å‡½æ•°æ‰§è¡Œä¹‹åäº§ç”Ÿçš„æ—¥å¿—ï¼Œå°±ä¼šè¢«ä¸¢å¤±ï¼Œæ‰€ä»¥åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œéœ€è¦è°ƒç”¨glog.Flush()å°†æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œè°ƒç”¨glog.Fatalå‡½æ•°åï¼Œglogä¼šæ‰“å°æ—¥å¿—å¹¶é€€å‡ºç¨‹åºï¼Œåœ¨ç¨‹åºé€€å‡ºå‰ï¼Œä¼šå°†ç¼“å­˜ä¸­çš„æ‰€æœ‰æ—¥å¿—éƒ½å†™å…¥æ—¥å¿—ï¼Œä½†æ˜¯å¯¹äºglog.Infoã€glog.Warningã€glog.Errorå‡½æ•°åˆ™ä¸ä¼šã€‚

1. vmoduleåŠŸèƒ½

glog æœ€å¸¸ç”¨çš„å°±æ˜¯ V level çš„åŠŸèƒ½ï¼ŒVè¶Šå°ï¼Œè¯´æ˜æ—¥å¿—çº§åˆ«è¶Šé«˜ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼šï¼ˆä¿å­˜åœ¨example2.goæ–‡ä»¶ä¸­ï¼‰ï¼š

```
package main

import (
    "flag"

    "github.com/golang/glog"
)

func main() {
    flag.Parse()
    defer glog.Flush()

    glog.V(3).Info("LEVEL 3 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 3
    glog.V(5).Info("LEVEL 5 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 5
    glog.V(7).Info("LEVEL 7 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 7
    glog.V(8).Info("LEVEL 8 message") // ä½¿ç”¨æ—¥å¿—çº§åˆ« 8
}
```

æ‰§è¡Œä¸Šè¿°ä»£ç ï¼š

```
$ go run example2.go -log_dir=log -alsologtostderr
```

ä¸Šé¢çš„å‘½ä»¤ä¸ä¼šæœ‰ä»»ä½•è¾“å‡ºï¼Œå› ä¸ºæ—¥å¿—çº§åˆ«ä¸å¤Ÿï¼Œå¯ä»¥é€šè¿‡`-v`è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š

```
$ go run example2.go -log_dir=log -alsologtostderr -v=5
I1202 09:52:44.163989   29042 example2.go:13] LEVEL 3 message
I1202 09:52:44.164335   29042 example2.go:14] LEVEL 5 message
```

æ­¤æ—¶ï¼Œæ—¥å¿—çº§åˆ«é«˜äºæˆ–è€…ç­‰äº5ï¼ˆVå€¼å°äºæˆ–è€…ç­‰äº5ï¼‰çš„æ—¥å¿—å°†è¢«æ‰“å°å‡ºæ¥ã€‚

glogè¿˜æ”¯æŒå¯¹ä¸åŒçš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„æ—¥å¿—çº§åˆ«ï¼ˆ`-vmodule`ï¼‰ï¼Œä¾‹å¦‚ï¼š

```
$ go run main.go foo.go -v=3 -log_dir=log -alsologtostderr -vmodule=foo=5
```

é€šè¿‡æŒ‡å®š`-vmodule=foo=5`å‚æ•°ï¼Œå¯ä»¥è®¾ç½®å¯¹foo.goæ–‡ä»¶ä½¿ç”¨5çº§åˆ«ï¼Œå¯¹å…¶å®ƒæ–‡ä»¶ä½¿ç”¨3çº§åˆ«ã€‚`-vmodule`çš„è¾“å…¥å‚æ•°çœå»äº†.goåç¼€ï¼Œè¯­æ³•æ ¼å¼ä¸ºï¼š`-vmodule=file1=2,file2=1,fs*=3`ã€‚

1. traceLocationåŠŸèƒ½

traceLocationå¯ä»¥æ‰“å°å‡ºæŒ‡å®šä½ç½®çš„æ ˆä¿¡æ¯ï¼ˆ`-log_backtrace_at=filename:line_number`ï¼‰ï¼Œä¾‹å¦‚æœ‰å¦‚ä¸‹ä»£ç ï¼š

```go
package main

import (
    "flag"

    "github.com/golang/glog"
)

func main() {
    glog.MaxSize = 1024 * 1024 * 1024 // 1Gè‡ªåŠ¨åˆ†å‰²
    flag.Parse()
    defer glog.Flush()

    glog.Info("This is info message")
}
```

æ‰§è¡Œä»¥ä¸Šä»£ç ï¼ˆä¿å­˜åœ¨example3.goæ–‡ä»¶ä¸­ï¼‰ï¼š

```
$ go run example3.go -log_dir=log -alsologtostderr -log_backtrace_at=example3.go:13
I1202 10:12:41.304582    1340 example3.go:13] This is info message
goroutine 1 [running]:
... æ‰“å°backtraceï¼Œæ­¤å¤„çœç•¥ ...
I1202 10:12:41.304779    1340 example3.go:14] This is info message: 123
```



## logrusä»‹ç»

[logrus](https://github.com/sirupsen/logrus)æ˜¯ç›®å‰Githubä¸Šstaræ•°é‡æœ€å¤šçš„æ—¥å¿—åŒ…ï¼ŒåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½é«˜æ•ˆã€é«˜åº¦çµæ´»ï¼Œè¿˜æä¾›äº†è‡ªå®šä¹‰æ’ä»¶çš„åŠŸèƒ½ã€‚å¾ˆå¤šä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œä¾‹å¦‚ï¼š`docker`ã€`prometheus`ç­‰éƒ½ä½¿ç”¨äº†logrusã€‚logrusé™¤äº†å…·æœ‰æ—¥å¿—çš„åŸºæœ¬åŠŸèƒ½å¤–ï¼Œè¿˜å…·æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š

+ æ”¯æŒå¸¸ç”¨çš„æ—¥å¿—çº§åˆ«ï¼Œlogrusæ”¯æŒå¦‚ä¸‹æ—¥å¿—çº§åˆ«ï¼šDebugã€Infoã€Warnã€Errorã€Fatalå’ŒPanicã€‚
+ å¯æ‰©å±•ï¼Œlogrusçš„hookæœºåˆ¶å…è®¸ä½¿ç”¨è€…é€šè¿‡hookçš„æ–¹å¼å°†æ—¥å¿—åˆ†å‘åˆ°ä»»æ„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šæœ¬åœ°æ–‡ä»¶ã€æ ‡å‡†è¾“å‡ºã€elasticsearchã€logstashã€kafkaç­‰ã€‚
+ æ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ï¼Œlogruså†…ç½®äº†2ç§æ ¼å¼ï¼šJSONFormatterå’ŒTextFormatterã€‚é™¤æ­¤ä¹‹å¤–ï¼Œlogruså…è®¸ä½¿ç”¨è€…é€šè¿‡å®ç°Formatteræ¥å£ï¼Œæ¥è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ã€‚
+ ç»“æ„åŒ–æ—¥å¿—è®°å½•ï¼Œlogrusçš„Fieldæœºåˆ¶å¯ä»¥å…è®¸ä½¿ç”¨è€…è‡ªå®šä¹‰æ—¥å¿—å­—æ®µï¼Œè€Œä¸æ˜¯é€šè¿‡å†—é•¿çš„æ¶ˆæ¯æ¥è®°å½•æ—¥å¿—ã€‚
+ é¢„è®¾æ—¥å¿—å­—æ®µï¼Œlogrusçš„Default Fieldsæœºåˆ¶å¯ä»¥ç»™ä¸€éƒ¨åˆ†æˆ–è€…å…¨éƒ¨æ—¥å¿—ç»Ÿä¸€æ·»åŠ å…±åŒçš„æ—¥å¿—å­—æ®µï¼Œä¾‹å¦‚ç»™æŸæ¬¡HTTPè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—æ·»åŠ X-Request-IDå­—æ®µã€‚
+ Fatal handlersï¼šlogruså…è®¸æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªhandlerï¼Œå½“å‘ç”Ÿfatalçº§åˆ«çš„æ—¥å¿—æ—¶è°ƒç”¨ã€‚å½“æˆ‘ä»¬çš„ç¨‹åºéœ€è¦ä¼˜é›…å…³é—­æ—¶ï¼Œè¯¥ç‰¹æ€§ä¼šéå¸¸æœ‰ç”¨ã€‚

logrusä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

1. åŸºæœ¬ç”¨æ³•

logruså¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®ï¼Œæ¥å®šä¹‰è¾“å‡ºã€æ ¼å¼æˆ–è€…æ—¥å¿—çº§åˆ«ç­‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
package main

import (
    "os"

    "github.com/sirupsen/logrus"
)

func main() {
    // logrusè®¾ç½®
    logrus.SetFormatter(&logrus.JSONFormatter{})
    logrus.SetOutput(os.Stdout)
    logrus.SetLevel(logrus.WarnLevel)

    // logrusä½¿ç”¨
    logrus.Debug("Useful debugging information.")
    logrus.Info("Something noteworthy happened!")
    logrus.Warn("You should probably take a look at this.")
    logrus.Error("Something failed but I'm not quitting.")

    logrus.WithFields(logrus.Fields{
        "animal": "walrus",
        "size":   10,
    }).Info("A group of walrus emerges from the ocean")

    logrus.WithFields(logrus.Fields{
        "omg":    true,
        "number": 122,
    }).Warn("The group's number increased tremendously!")
}
```

å¯ä»¥é€šè¿‡logrus.SetFormatterè®¾ç½®è¾“å‡ºçš„æ—¥å¿—æ ¼å¼ï¼Œlogrusè‡ªå¸¦æœ‰JSONFormatterå’ŒTextFormatterã€‚é€šè¿‡logrus.SetLevelæ¥è®¾ç½®æ—¥å¿—çº§åˆ«ï¼Œé€šè¿‡logrus.SetOutputè®¾ç½®æ—¥å¿—è¾“å‡ºç­‰ã€‚

å‡è®¾ä¸Šè¿°ä»£ç ä¿å­˜åœ¨example1.goæ–‡ä»¶ä¸­ï¼Œè¿è¡Œä»£ç ï¼š

```
$ go run example1.go
{"level":"warning","msg":"You should probably take a look at this.","time":"2020-12-03T22:35:35+08:00"}
{"level":"error","msg":"Something failed but I'm not quitting.","time":"2020-12-03T22:35:35+08:00"}
{"level":"warning","msg":"The group's number increased tremendously!","number":122,"omg":true,"time":"2020-12-03T22:35:35+08:00"}
```

1. Default Fields

é€šå¸¸ï¼Œåœ¨ä¸€ä¸ªåº”ç”¨ä¸­ã€æˆ–è€…åº”ç”¨çš„ä¸€éƒ¨åˆ†ä¸­ï¼Œå§‹ç»ˆé™„å¸¦ä¸€äº›å›ºå®šçš„è®°å½•å­—æ®µä¼šå¾ˆæœ‰å¸®åŠ©ã€‚æ¯”å¦‚åœ¨å¤„ç†ç”¨æˆ·HTTPè¯·æ±‚æ—¶ï¼Œä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ—¥å¿—éƒ½ä¼šæœ‰request_idã€‚ä¸ºäº†é¿å…æ¯æ¬¡è®°å½•æ—¥å¿—éƒ½è¦ä½¿ç”¨ï¼š

```
logrus.WithFields(logrus.Fields{"request_idâ€", request_id})
```

æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªlogrus.Entryå®ä¾‹ï¼Œä¸ºè¿™ä¸ªå®ä¾‹è®¾ç½®é»˜è®¤Fieldsï¼ŒæŠŠlogrus.Entryå®ä¾‹è®¾ç½®åˆ°è®°å½•å™¨Loggerï¼Œå†è®°å½•æ—¥å¿—æ—¶æ¯æ¬¡éƒ½ä¼šé™„å¸¦ä¸Šè¿™äº›é»˜è®¤çš„å­—æ®µã€‚

```
logger := log.WithFields(log.Fields{"request_id": request_id})
logger.Info("something happened on that request") // ä¹Ÿä¼šè®°å½•request_id
logger.Warn("something not great happened")
```

1. Hookæ¥å£

logruså…·æœ‰hookèƒ½åŠ›ï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ä¸€äº›æ—¥å¿—å¤„ç†é€»è¾‘ï¼Œå®ç°ä¸€ä¸ªhookåªéœ€è¦å®ç°å¦‚ä¸‹æ¥å£ï¼š

```
// logrusåœ¨è®°å½•Levels()è¿”å›çš„æ—¥å¿—çº§åˆ«çš„æ¶ˆæ¯æ—¶ä¼šè§¦å‘HOOK,
// æŒ‰ç…§Fireæ–¹æ³•å®šä¹‰çš„å†…å®¹ä¿®æ”¹logrus.Entry.
type Hook interface {
    Levels() []Level
    Fire(*Entry) error
}
```

ä¸€ä¸ªç®€å•è‡ªå®šä¹‰hookå¦‚ä¸‹ï¼ŒDefaultFieldHookå®šä¹‰ä¼šåœ¨æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—æ¶ˆæ¯ä¸­åŠ å…¥é»˜è®¤å­—æ®µ`myHook="MyHookTest"`:

```
type DefaultFieldHook struct {
}

func (hook *DefaultFieldHook) Fire(entry *log.Entry) error {
    entry.Data["myHook"] = " MyHookTest "
    return nil
}

func (hook *DefaultFieldHook) Levels() []log.Level {
    return log.AllLevels
}
```

å®ç°äº†hookä¹‹åï¼Œåªéœ€è¦è°ƒç”¨log.AddHook(hook)å³å¯å°†è‡ªå®šä¹‰çš„hookæ³¨å†Œåˆ°logrusä¸­ã€‚é€šè¿‡hookå¯ä»¥å®ç°å¾ˆå¤šå¼ºå¤§çš„æ—¥å¿—å¤„ç†åŠŸèƒ½ï¼Œæ¯”è¾ƒå¸¸è§çš„ç”¨æ³•æ˜¯ï¼Œå½“æœ‰æŒ‡å®šçº§åˆ«çš„æ—¥å¿—äº§ç”Ÿæ—¶ï¼Œé‚®ä»¶é€šçŸ¥æˆ–è€…å‘Šè­¦ç»™ç›¸å…³è´Ÿè´£äººã€‚



## zapåŒ…ä»‹ç»

[zap](https://github.com/uber-go/zap)æ˜¯uberå¼€æºçš„æ—¥å¿—åŒ…ï¼Œä»¥é«˜æ€§èƒ½è‘—ç§°ï¼Œå¾ˆå¤šå…¬å¸çš„æ—¥å¿—åŒ…éƒ½æ˜¯åŸºäºzapæ”¹é€ è€Œæ¥ã€‚zapé™¤äº†å…·æœ‰æ—¥å¿—åŸºæœ¬çš„åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å…·æœ‰å¾ˆå¤šå¼ºå¤§çš„ç‰¹æ€§ï¼š

+ æ”¯æŒå¸¸ç”¨çš„æ—¥å¿—çº§åˆ«ï¼Œä¾‹å¦‚ï¼šDebugã€Infoã€Warnã€Errorã€DPanicã€Panicã€Fatalã€‚
+ æ€§èƒ½éå¸¸é«˜ï¼Œzapå…·æœ‰éå¸¸é«˜çš„æ€§èƒ½ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ã€‚
+ åƒlogrusä¸€æ ·ï¼Œæ”¯æŒç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ã€‚
+ æ”¯æŒé¢„è®¾æ—¥å¿—å­—æ®µã€‚
+ æ”¯æŒé’ˆå¯¹ç‰¹å®šçš„æ—¥å¿—çº§åˆ«ï¼Œè¾“å‡ºè°ƒç”¨å †æ ˆã€‚
+ æ”¯æŒhookã€‚

### zapä½¿ç”¨æ–¹æ³•

**åŸºæœ¬ç”¨æ³•ï¼š**

zapä½¿ç”¨æ–¹æ³•è·Ÿå…¶ä»–æ—¥å¿—åŒ…ä½¿ç”¨æ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªå¸¸è§çš„ç”¨æ³•ï¼š

```go
package main

import (
    "time"

    "go.uber.org/zap"
)

func main() {
    logger, _ := zap.NewProduction()
    defer logger.Sync() // flushes buffer, if any
    url := "http://marmotedu.com"
    logger.Info("failed to fetch URL",
        zap.String("url", url),
        zap.Int("attempt", 3),
        zap.Duration("backoff", time.Second),
    )

    sugar := logger.Sugar()
    sugar.Infow("failed to fetch URL",
        "url", url,
        "attempt", 3,
        "backoff", time.Second,
    )
    sugar.Infof("Failed to fetch URL: %s", url)
}
```

å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨ `example1.go`æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š

```json
{"level":"info","ts":1607006503.3008754,"caller":"zap/example1.go:13","msg":"failed to fetch URL","url":"http://marmotedu.com","attempt":3,"backoff":1}
{"level":"info","ts":1607006503.3009226,"caller":"zap/example1.go:20","msg":"failed to fetch URL","url":"http://marmotedu.com","attempt":3,"backoff":1}
{"level":"info","ts":1607006503.300958,"caller":"zap/example1.go:25","msg":"Failed to fetch URL: http://marmotedu.com"}
```

é»˜è®¤çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ä¸ºJSONæ ¼å¼ï¼Œå¹¶è®°å½•äº†æ–‡ä»¶åå’Œè¡Œå·ã€‚

ä¸Šè¿°ä»£ç é€šè¿‡`zap.NewProduction()`åˆ›å»ºäº†ä¸€ä¸ªloggerï¼Œzapè¿˜æä¾›äº†`zap.NewExample()`ã€`zap.NewDevelopment()`æ¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªloggerï¼Œä¸åŒæ–¹æ³•åˆ›å»ºçš„loggerå…·æœ‰ä¸åŒçš„è®¾ç½®ï¼ŒExampleé€‚åˆç”¨åœ¨æµ‹è¯•ä»£ç ä¸­ï¼ŒDevelopmentåœ¨å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨ï¼ŒProductionç”¨åœ¨ç”Ÿäº§ç¯å¢ƒã€‚å¦‚æœæƒ³è‡ªå®šä¹‰loggerï¼Œå¯ä»¥è°ƒç”¨`zap.New()`æ–¹æ³•æ¥åˆ›å»ºã€‚loggeræä¾›äº†Debugã€Infoã€Warnã€Errorã€Panicã€Fatalç­‰æ–¹æ³•ï¼Œç”¨æ¥è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—ã€‚åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œæ³¨æ„è¦è°ƒç”¨`defer logger.Sync()`å°†ç¼“å­˜ä¸­çš„æ—¥å¿—åˆ·æ–°åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚

**å½“æˆ‘ä»¬å¯¹æ—¥å¿—çš„æ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Loggerè€ŒéSugaredLoggerï¼ŒLoggeræ€§èƒ½æ›´å¥½ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°æ›´å°‘ã€‚** ä¸ºäº†æé«˜æ€§èƒ½ï¼ŒLoggeræ²¡æœ‰ä½¿ç”¨`interface`å’Œåå°„ï¼Œå¹¶ä¸”Loggeråªæ”¯æŒç»“æ„åŒ–çš„æ—¥å¿—ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨Loggeræ—¶ï¼Œéœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹å’Œkey-valueæ ¼å¼çš„æ—¥å¿—å­—æ®µï¼Œä¾‹å¦‚ï¼š

```go
logger.Info("failed to fetch URL",
    zap.String("url", url),
    zap.Int("attempt", 3),
    zap.Duration("backoff", time.Second),
)
```

å¦‚æœè§‰å¾—Loggerçš„æ—¥å¿—æ ¼å¼æ¯”è¾ƒç¹çï¼Œå¯ä»¥ä½¿ç”¨æ›´åŠ ä¾¿æ·çš„`SugaredLogger`ï¼Œè°ƒç”¨`logger.Sugar()`å³å¯åˆ›å»º`SugaredLogger`ã€‚`SugaredLogger`çš„ä½¿ç”¨æ¯”`Logger`ç®€å•ï¼Œä½†æ€§èƒ½æ¯”Loggerä½ 50% å·¦å³ï¼Œå¯ä»¥ç”¨åœ¨è°ƒç”¨æ¬¡æ•°ä¸é«˜çš„å‡½æ•°ä¸­ï¼Œè°ƒç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```go
sugar := logger.Sugar()
    sugar.Infow("failed to fetch URL",
    "url", url,
    "attempt", 3,
    "backoff", time.Second,
)
sugar.Infof("Failed to fetch URL: %s", url)
```

**å®šåˆ¶Logger**

å¯ä»¥ä½¿ç”¨`NexExample()/NewDevelopment()/NewProduction()`å‡½æ•°åˆ›å»ºé»˜è®¤çš„Loggerï¼Œæ¯ç§æ–¹æ³•åˆ›å»ºçš„Loggeré…ç½®ä¸ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå®šåˆ¶åŒ–çš„Loggerï¼Œåˆ›å»ºæ–¹å¼å¦‚ä¸‹ï¼š

```go
package main

import (
    "encoding/json"

    "go.uber.org/zap"
)

func main() {
    rawJSON := []byte(`{
    "level":"debug",
    "encoding":"json",
    "outputPaths": ["stdout", "test.log"],
    "errorOutputPaths": ["stderr"],
    "initialFields":{"name":"dj"},
    "encoderConfig": {
      "messageKey": "message",
      "levelKey": "level",
      "levelEncoder": "lowercase"
    }
  }`)

    var cfg zap.Config
    if err := json.Unmarshal(rawJSON, &cfg); err != nil {
        panic(err)
    }
    logger, err := cfg.Build()
    if err != nil {
        panic(err)
    }
    defer logger.Sync()

    logger.Info("server start work successfully!")
}
```

ä»¥ä¸Šç¤ºä¾‹è°ƒç”¨zap.Configçš„Buildæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œæ–‡ä»¶test.logçš„Loggerï¼Œå°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨`example2.go`æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š

```bash
$ go run example2.go
{"level":"info","message":"server start work successfully!","name":"dj"}
```

zap.Configå®šä¹‰å¦‚ä¸‹ï¼š

```go
type Config struct {
    Level AtomicLevel
    Development bool
    DisableCaller bool
    DisableStacktrace bool
    Sampling *SamplingConfig
    Encoding string
    EncoderConfig zapcore.EncoderConfig
    OutputPaths []string
    ErrorOutputPaths []string
    InitialFields map[string]interface{}
}
```

Configç»“æ„ä½“ï¼Œå„å­—æ®µè¯´æ˜å¦‚ä¸‹ï¼š

+ Levelï¼šæ—¥å¿—çº§åˆ«ã€‚
+ Developmentï¼šè®¾ç½®Loggerçš„æ¨¡å¼ä¸ºdevelopmentæ¨¡å¼ã€‚
+ DisableCallerï¼šç¦ç”¨è°ƒç”¨ä¿¡æ¯. è¯¥å­—æ®µå€¼ä¸º true æ—¶, æ—¥å¿—ä¸­å°†ä¸å†æ˜¾ç¤ºè¯¥æ—¥å¿—æ‰€åœ¨çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚
+ DisableStacktraceï¼šç¦ç”¨è‡ªåŠ¨å †æ ˆè·Ÿè¸ªæ•è·ã€‚
+ Samplingï¼šæµæ§é…ç½®, ä¹Ÿå«é‡‡æ ·. å•ä½æ˜¯æ¯ç§’é’Ÿ, ä½œç”¨æ˜¯é™åˆ¶æ—¥å¿—åœ¨æ¯ç§’é’Ÿå†…çš„è¾“å‡ºæ•°é‡, ä»¥é˜²æ­¢CPUå’ŒIOè¢«è¿‡åº¦å ç”¨ã€‚
+ Encodingï¼šæŒ‡å®šæ—¥å¿—ç¼–ç å™¨, ç›®å‰ä»…æ”¯æŒä¸¤ç§ç¼–ç å™¨ï¼šconsoleå’Œjsonï¼Œé»˜è®¤ä¸ºjsonã€‚
+ EncoderConfigï¼šç¼–ç é…ç½®ã€‚
+ OutputPathsï¼šé…ç½®æ—¥å¿—æ ‡å‡†è¾“å‡ºï¼Œå¯ä»¥é…ç½®å¤šä¸ªæ—¥å¿—è¾“å‡ºè·¯å¾„, ä¸€èˆ¬æƒ…å†µå¯ä»¥ä»…é…ç½®æ ‡å‡†è¾“å‡ºæˆ–è¾“å‡ºåˆ°æ–‡ä»¶, å¦‚æœ‰éœ€æ±‚çš„è¯, ä¹Ÿå¯ä»¥ä¸¤è€…åŒæ—¶é…ç½®ã€‚
+ ErrorOutputPathsï¼šé”™è¯¯è¾“å‡ºè·¯å¾„ï¼Œå¯ä»¥æ˜¯å¤šä¸ªã€‚
+ InitialFieldsï¼šåˆå§‹åŒ–å­—æ®µé…ç½®, è¯¥é…ç½®çš„å­—æ®µä¼šä»¥ç»“æ„åŒ–çš„å½¢å¼æ‰“å°åœ¨æ¯æ¡æ—¥å¿—è¾“å‡ºä¸­ã€‚

è°ƒç”¨zap.Configçš„Build()æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨zap.Configé…ç½®åˆ›å»ºä¸€ä¸ªLoggerã€‚

å…¶ä¸­EncoderConfigä¸ºç¼–ç é…ç½®ï¼š

```go
type EncoderConfig struct {
    MessageKey    string `json:"messageKey" yaml:"messageKey"`
    LevelKey      string `json:"levelKey" yaml:"levelKey"`
    TimeKey       string `json:"timeKey" yaml:"timeKey"`
    NameKey       string `json:"nameKey" yaml:"nameKey"`
    CallerKey     string `json:"callerKey" yaml:"callerKey"`
    FunctionKey   string `json:"functionKey" yaml:"functionKey"`
    StacktraceKey string `json:"stacktraceKey" yaml:"stacktraceKey"`
    LineEnding    string `json:"lineEnding" yaml:"lineEnding"`
    EncodeLevel    LevelEncoder    `json:"levelEncoder" yaml:"levelEncoder"`
    EncodeTime     TimeEncoder     `json:"timeEncoder" yaml:"timeEncoder"`
    EncodeDuration DurationEncoder `json:"durationEncoder" yaml:"durationEncoder"`
    EncodeCaller   CallerEncoder   `json:"callerEncoder" yaml:"callerEncoder"`
    EncodeName NameEncoder `json:"nameEncoder" yaml:"nameEncoder"`
    ConsoleSeparator string `json:"consoleSeparator" yaml:"consoleSeparator"`
}
```

å¸¸ç”¨çš„è®¾ç½®å¦‚ä¸‹ï¼š

+ MessageKeyï¼šæ—¥å¿—ä¸­ä¿¡æ¯çš„é”®åï¼Œé»˜è®¤ä¸ºmsgã€‚
+ LevelKeyï¼šæ—¥å¿—ä¸­çº§åˆ«çš„é”®åï¼Œé»˜è®¤ä¸ºlevelã€‚
+ EncodeLevelï¼šæ—¥å¿—ä¸­çº§åˆ«çš„æ ¼å¼ï¼Œé»˜è®¤ä¸ºå°å†™ï¼Œå¦‚debug/infoã€‚

1. é€‰é¡¹

zapæ”¯æŒå¤šç§é€‰é¡¹ï¼Œé€‰é¡¹çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```go
package main

import "go.uber.org/zap"

func main() {
    logger, _ := zap.NewProduction(zap.AddCaller())
    defer logger.Sync()

    logger.Info("hello world")
}
```

å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨example3.goä¸­ï¼Œæ‰§è¡Œï¼š

```
$ go run example3.go
{"level":"info","ts":1607010625.6718638,"caller":"zap/example3.go:9","msg":"hello world"}
```

ä¸Šè¿°æ—¥å¿—è¾“å‡ºäº†æ—¥å¿—çš„è°ƒç”¨ä¿¡æ¯ï¼ˆæ–‡ä»¶å:è¡Œå·ï¼‰`"caller":"zap/example3.go:9"`ã€‚zapæä¾›äº†å¤šä¸ªé€‰é¡¹å¯ä¾›é€‰æ‹©ï¼š

+ `AddStacktrace(lvl zapcore.LevelEnabler)`ï¼šç”¨æ¥åœ¨æŒ‡å®šçº§åˆ«åŠä»¥ä¸Šçº§åˆ«è¾“å‡ºè°ƒç”¨å †æ ˆã€‚
+ `zap.WithCaller(enabled bool)`ï¼šæŒ‡å®šæ˜¯å¦åœ¨æ—¥å¿—è¾“å‡ºå†…å®¹ä¸­å¢åŠ æ–‡ä»¶åå’Œè¡Œå·ã€‚
+ `zap.AddCaller()`ï¼šä¸zap.WithCaller(true)ç­‰ä»·ï¼ŒæŒ‡å®šåœ¨æ—¥å¿—è¾“å‡ºå†…å®¹ä¸­å¢åŠ è¡Œå·å’Œæ–‡ä»¶åã€‚
+ `zap. AddCallerSkip(skip int)`ï¼šæŒ‡å®šåœ¨è°ƒç”¨æ ˆä¸­è·³è¿‡çš„è°ƒç”¨æ·±åº¦ï¼Œå¦åˆ™é€šè¿‡è°ƒç”¨æ ˆè·å¾—çš„è¡Œå·å¯èƒ½æ€»æ˜¯æ—¥å¿—ç»„ä»¶ä¸­çš„è¡Œå·ã€‚
+ `zap. IncreaseLevel(lvl zapcore.LevelEnabler)`ï¼šæé«˜æ—¥å¿—çº§åˆ«ï¼Œå¦‚æœä¼ å…¥çš„lvlæ¯”å½“å‰loggerçš„çº§åˆ«ä½ï¼Œåˆ™ä¸ä¼šæ”¹å˜æ—¥å¿—çº§åˆ«ã€‚
+ `ErrorOutput(w zapcore.WriteSyncer)`ï¼šæŒ‡å®šæ—¥å¿—ç»„ä»¶ä¸­å‡ºç°å¼‚å¸¸æ—¶çš„è¾“å‡ºä½ç½®ã€‚
+ `Fields(fs ...Field)`ï¼šæ·»åŠ å…¬å…±å­—æ®µã€‚
+ `Hooks(hooks ...func(zapcore.Entry) error)`ï¼šæ³¨å†Œé’©å­å‡½æ•°ï¼Œç”¨æ¥åœ¨æ—¥å¿—æ‰“å°æ—¶åŒæ—¶è°ƒç”¨hookæ–¹æ³•ã€‚
+ `WrapCore(f func(zapcore.Core) zapcore.Core)`ï¼šæ›¿æ¢Loggerçš„zapcore.Coreã€‚ -` Development()`ï¼šå°†Loggerä¿®æ”¹ä¸ºDevelopmentæ¨¡å¼ã€‚



**é¢„è®¾æ—¥å¿—å­—æ®µ**

å¦‚æœæ¯æ¡æ—¥å¿—éƒ½æœŸæœ›åŠ ä¸€äº›å…¬å…±å­—æ®µï¼Œä¾‹å¦‚requestIDï¼Œå¯ä»¥åœ¨åˆ›å»ºLoggeræ—¶ä½¿ç”¨`Fields(fs ...Field)`é€‰é¡¹ï¼Œå¦‚ä¸‹ä»£ç ä¸­ï¼Œæ·»åŠ äº†requestIDã€userIDå…¬å…±å­—æ®µåˆ°æ¯æ¡æ—¥å¿—ä¸­ï¼š

```go
package main

import "go.uber.org/zap"

func main() {
    logger := zap.NewExample(zap.Fields(
        zap.Int("userID", 10),
        zap.String("requestID", "fbf54504"),
    ))

    logger.Debug("This is a debug message")
    logger.Info("This is a info message")
}
```

å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°`preset_field.go`æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š

```bash
$ go run preset_field.go
{"level":"debug","msg":"This is a debug message","userID":10,"requestID":"fbf54504"}
{"level":"info","msg":"This is a info message","userID":10,"requestID":"fbf54504"}
```

**å…¨å±€Loggerï¼š**

zapæä¾›äº†2ä¸ªå…¨å±€Loggerï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬è°ƒç”¨ï¼š

+ `*zap.Logger`ï¼šå¯é€šè¿‡zap.L()è·å¾—ï¼Œæä¾›äº†Debug()ã€Info()ã€Warn()ã€Error()ã€Panic()ã€DPanic()ã€Fatal()æ–¹æ³•æ¥è®°å½•æ—¥å¿—ã€‚
+ `*zap.SugaredLogger`ï¼šå¯é€šè¿‡zap.S()è·å¾—ï¼Œæä¾›äº†Debugf()ã€Debugw()ã€Infof()ã€Infow()ã€Warnf()ã€Warnw()ã€Errorf()ã€Errorw()ã€Panicf()ã€Panicw()ã€DPanicf()ã€DPanicw()ã€Fatalf()ã€Fatalw()æ–¹æ³•æ¥è®°å½•æ—¥å¿—ã€‚

é»˜è®¤çš„å…¨å±€Loggerä¸ä¼šè®°å½•ä»»ä½•æ—¥å¿—ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— ç”¨çš„Loggerï¼Œä¾‹å¦‚zap.L()è¿”å›äº†åä¸º`_globalL`çš„Loggerï¼Œ`_globalL`å®šä¹‰ä¸ºï¼š

```go
_globalL  = NewNop()
func NewNop() *Logger {
    return &Logger{
        core:        zapcore.NewNopCore(),
        errorOutput: zapcore.AddSync(ioutil.Discard),
        addStack:    zapcore.FatalLevel + 1,
    }
}
```

`zapcore.NewNopCore()`å‡½æ•°å®šä¹‰ä¸ºï¼š

```go
type nopCore struct{}

// NewNopCore returns a no-op Core.
func NewNopCore() Core                                        { return nopCore{} }
func (nopCore) Enabled(Level) bool                            { return false }
func (n nopCore) With([]Field) Core                           { return n }
func (nopCore) Check(_ Entry, ce *CheckedEntry) *CheckedEntry { return ce }
func (nopCore) Write(Entry, []Field) error                    { return nil }
func (nopCore) Sync() error                                   { return nil }

// NewCore creates a Core that writes logs to a WriteSyncer.
func NewCore(enc Encoder, ws WriteSyncer, enab LevelEnabler) Core {
    return &ioCore{
        LevelEnabler: enab,
        enc:          enc,
        out:          ws,
    }
}
```

å¯ä»¥çœ‹åˆ°NewNop()åˆ›å»ºä¸€ä¸ªä¸è®°å½•ä»»ä½•æ—¥å¿—ã€ä»»ä½•å†…éƒ¨é”™è¯¯ã€ä¸æ‰§è¡Œä»»ä½•é’©å­çš„Loggerã€‚å¯ä»¥ä½¿ç”¨ReplaceGlobalså‡½æ•°å°†å…¨å±€Loggeræ›¿æ¢ä¸ºæˆ‘ä»¬åˆ›å»ºçš„Loggerï¼Œä¾‹å¦‚ï¼š

```
package main

import "go.uber.org/zap"

func main() {
    zap.L().Info("default global Logger")
    zap.S().Info("default global SugaredLogger")

    logger := zap.NewExample()
    defer logger.Sync()

    zap.ReplaceGlobals(logger)
    zap.L().Info("replaced global Logger")
    zap.S().Info("replaced global SugaredLogger")
}
```

å‡è®¾ä¸Šè¿°ä»£ç ä¿å­˜åœ¨`global_logger.go`æ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š

```
$ go run global_logger.go
{"level":"info","msg":"replaced global Logger"}
{"level":"info","msg":"replaced global SugaredLogger"}
```

å¯ä»¥çœ‹åˆ°åœ¨`zap.ReplaceGlobals(logger)`ä¹‹å‰çš„æ—¥å¿—ï¼Œå¹¶æ²¡æœ‰è¢«æ‰“å°å‡ºæ¥ã€‚



## å…¶å®ƒå¼€æºåŒ…

è¿˜æœ‰å¾ˆå¤šå…¶å®ƒä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…ä¾›æˆ‘ä»¬é€‰æ‹©ï¼Œä¾‹å¦‚ï¼šlog15ã€zerologã€seelogã€apex/logã€go-loggingç­‰ã€‚ä½ å¯ä»¥åœ¨å¼€å‘ä¸­ï¼Œéƒ½è¯¦åŠ è°ƒç ”ï¼Œé€‰æ‹©ä¸€ä¸ªé€‚åˆè‡ªå·±çš„æ—¥å¿—åŒ…ã€‚



## å¼€æºæ—¥å¿—åŒ…é€‰æ‹©

æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šæ—¥å¿—åŒ…ï¼Œæ¯ç§æ—¥å¿—åŒ…ä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç»“åˆæ—¥å¿—åŒ…çš„ç‰¹æ€§è¿›è¡Œé€‰æ‹©ï¼š

+ **æ ‡å‡†åº“logåŒ…ï¼š** æ ‡å‡†åº“logåŒ…ä¸æ”¯æŒæ—¥å¿—çº§åˆ«ã€æ—¥å¿—åˆ†å‰²ã€æ—¥å¿—æ ¼å¼ç­‰åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨å¤§å‹é¡¹ç›®ä¸­å¾ˆå°‘ç›´æ¥ä½¿ç”¨ï¼Œé€šå¸¸ç”¨äºä¸€äº›çŸ­å°çš„ç¨‹åºï¼Œæ¯”å¦‚ï¼šç”¨äºç”ŸæˆJWT Tokençš„main.goæ–‡ä»¶ä¸­ã€‚æ ‡å‡†åº“æ—¥å¿—åŒ…ä¹Ÿå¾ˆé€‚åˆä¸€äº›ç®€çŸ­çš„ä»£ç ï¼Œç”¨äºå¿«é€Ÿè°ƒè¯•å’ŒéªŒè¯ã€‚
+ **glogï¼š** glogå®ç°äº†æ—¥å¿—åŒ…çš„åŸºæœ¬åŠŸèƒ½ï¼Œå¯¹äºä¸€äº›å¯¹æ—¥å¿—åŠŸèƒ½è¦æ±‚ä¸å¤šçš„å°å‹é¡¹ç›®éå¸¸é€‚åˆã€‚
+ **logrusï¼š** logrusåŠŸèƒ½å¼ºå¤§ï¼Œä¸ä»…å®ç°äº†æ—¥å¿—åŒ…çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜æœ‰å¾ˆå¤šé«˜çº§ç‰¹æ€§ï¼Œé€‚åˆä¸€äº›å¤§å‹é¡¹ç›®ï¼Œå°¤å…¶æ˜¯éœ€è¦ç»“æ„åŒ–æ—¥å¿—è®°å½•çš„é¡¹ç›®ã€‚
+ **zapï¼š** zapæä¾›äº†å¾ˆå¼ºå¤§çš„æ—¥å¿—åŠŸèƒ½ï¼Œæ€§èƒ½é«˜ï¼Œå†…å­˜åˆ†é…æ¬¡æ•°å°‘ï¼Œé€‚åˆå¯¹æ—¥å¿—æ€§èƒ½è¦æ±‚å¾ˆé«˜çš„é¡¹ç›®ã€‚å¦å¤–ï¼ŒzapåŒ…ä¸­çš„å­åŒ…zapcoreï¼Œæä¾›äº†å¾ˆå¤šåº•å±‚çš„æ—¥å¿—æ¥å£ï¼Œé€‚åˆç”¨æ¥åšäºŒæ¬¡å°è£…ã€‚ä¾‹å¦‚ iam é¡¹ç›®ä½œè€… å°±åŸºäºzapå’Œzapcoreå°è£…äº†[marmotedu/log](https://github.com/marmotedu/log)æ—¥å¿—åŒ…ï¼Œè¯¥æ—¥å¿—åŒ…å¯ä»¥å¾ˆå¥½çš„å…¼å®¹glogï¼Œå°è£…èƒŒæ™¯æ˜¯å› ä¸ºåœ¨åšå®¹å™¨äº‘å¹³å°å¼€å‘æ—¶ï¼Œå‘ç°kubernetesæºç ä¸­å¤§é‡ä½¿ç”¨äº†glogï¼Œéœ€è¦æ—¥å¿—åŒ…èƒ½å¤Ÿå…¼å®¹glogã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ å¦‚ä½•ä»é›¶å¼€å§‹å¼€å‘å‡ºä¸€ä¸ªæ—¥å¿—åŒ…ï¼š



## ä»0ç¼–å†™ä¸€ä¸ªæ—¥å¿—åŒ…

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå‘ä½ å±•ç¤ºå¦‚ä½•å¿«é€Ÿç¼–å†™ä¸€ä¸ªå…·å¤‡åŸºæœ¬åŠŸèƒ½çš„æ—¥å¿—åŒ…ï¼Œè®©ä½ é€šè¿‡è¿™ä¸ªç®€çŸ­çš„æ—¥å¿—åŒ…å®ç°æŒæ¡æ—¥å¿—åŒ…çš„æ ¸å¿ƒè®¾è®¡æ€è·¯ã€‚è¯¥æ—¥å¿—åŒ…ä¸»è¦å®ç°ä»¥ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š

+ æ”¯æŒè‡ªå®šä¹‰é…ç½®ã€‚
+ æ”¯æŒæ–‡ä»¶åå’Œè¡Œå·ã€‚
+ æ”¯æŒæ—¥å¿—çº§åˆ« Debugã€Infoã€Warnã€Errorã€Panicã€Fatalã€‚
+ æ”¯æŒè¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶å’Œæ ‡å‡†è¾“å‡ºã€‚
+ æ”¯æŒJSONå’ŒTEXTæ ¼å¼çš„æ—¥å¿—è¾“å‡ºï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼ã€‚
+ æ”¯æŒé€‰é¡¹æ¨¡å¼ã€‚

æ—¥å¿—åŒ…åç§°ä¸º`cuslog`ï¼Œç¤ºä¾‹é¡¹ç›®å®Œæ•´ä»£ç å­˜æ”¾åœ¨ [cuslog](https://github.com/marmotedu/gopractise-demo/tree/main/log/cuslog)ã€‚

**å…·ä½“å®ç°åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š**

1. å®šä¹‰ï¼šå®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚
2. åˆ›å»ºï¼šåˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚
3. å†™å…¥ï¼šå°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ã€‚
4. è‡ªå®šä¹‰ï¼šè‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚



### å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹

ä¸€ä¸ªåŸºæœ¬çš„æ—¥å¿—åŒ…ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰å¥½æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚æœ¬ç¤ºä¾‹å°†å®šä¹‰ä»£ç ä¿å­˜åœ¨[options.go](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/options.go)æ–‡ä»¶ä¸­ã€‚

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®šä¹‰æ—¥å¿—çº§åˆ«ï¼š

```go
type Level uint8

const (
    DebugLevel Level = iota
    InfoLevel
    WarnLevel
    ErrorLevel
    PanicLevel
    FatalLevel
)

var LevelNameMapping = map[Level]string{
    DebugLevel: "DEBUG",
    InfoLevel:  "INFO",
    WarnLevel:  "WARN",
    ErrorLevel: "ERROR",
    PanicLevel: "PANIC",
    FatalLevel: "FATAL",
}
```

åœ¨æ—¥å¿—è¾“å‡ºæ—¶ï¼Œè¦é€šè¿‡å¯¹æ¯”å¼€å…³çº§åˆ«å’Œè¾“å‡ºçº§åˆ«çš„å¤§å°ï¼Œæ¥å†³å®šæ˜¯å¦è¾“å‡ºï¼Œæ‰€ä»¥æ—¥å¿—çº§åˆ«Levelè¦å®šä¹‰æˆæ–¹ä¾¿æ¯”è¾ƒçš„æ•°å€¼ç±»å‹ã€‚å‡ ä¹æ‰€æœ‰çš„æ—¥å¿—åŒ…éƒ½æ˜¯ç”¨å¸¸é‡è®¡æ•°å™¨`iota`æ¥å®šä¹‰æ—¥å¿—çº§åˆ«ã€‚

å¦å¤–ï¼Œå› ä¸ºè¦åœ¨æ—¥å¿—è¾“å‡ºä¸­ï¼Œè¾“å‡ºå¯è¯»çš„æ—¥å¿—çº§åˆ«ï¼ˆä¾‹å¦‚è¾“å‡ºINFOè€Œä¸æ˜¯1ï¼‰ï¼Œæ‰€ä»¥éœ€è¦æœ‰Levelåˆ°Level Nameçš„æ˜ å°„LevelNameMappingï¼ŒLevelNameMappingä¼šåœ¨æ ¼å¼åŒ–æ—¶ç”¨åˆ°ã€‚

æ¥ä¸‹æ¥çœ‹å®šä¹‰æ—¥å¿—é€‰é¡¹ã€‚æ—¥å¿—éœ€è¦æ˜¯å¯é…ç½®çš„ï¼Œæ–¹ä¾¿å¼€å‘è€…æ ¹æ®ä¸åŒçš„ç¯å¢ƒè®¾ç½®ä¸åŒçš„æ—¥å¿—è¡Œä¸ºï¼Œæ¯”è¾ƒå¸¸è§çš„é…ç½®é€‰é¡¹ä¸ºï¼š

+ æ—¥å¿—çº§åˆ«ã€‚
+ è¾“å‡ºä½ç½®ï¼Œä¾‹å¦‚æ ‡å‡†è¾“å‡ºæˆ–è€…æ–‡ä»¶ã€‚
+ è¾“å‡ºæ ¼å¼ï¼Œä¾‹å¦‚JSONæˆ–è€…Textã€‚
+ æ˜¯å¦å¼€å¯æ–‡ä»¶åå’Œè¡Œå·ã€‚

æœ¬ç¤ºä¾‹çš„æ—¥å¿—é€‰é¡¹å®šä¹‰å¦‚ä¸‹ï¼š

```go
type options struct {
    output        io.Writer
    level         Level
    stdLevel      Level
    formatter     Formatter
    disableCaller bool
}
```

ä¸ºäº†çµæ´»åœ°è®¾ç½®æ—¥å¿—çš„é€‰é¡¹ï¼Œä½ å¯ä»¥é€šè¿‡é€‰é¡¹æ¨¡å¼ï¼Œæ¥å¯¹æ—¥å¿—é€‰é¡¹è¿›è¡Œè®¾ç½®ï¼š

```go
type Option func(*options)

func initOptions(opts ...Option) (o *options) {
    o = &options{}
    for _, opt := range opts {
        opt(o)
    }

    if o.output == nil {
        o.output = os.Stderr
    }

    if o.formatter == nil {
        o.formatter = &TextFormatter{}
    }

    return
}

func WithLevel(level Level) Option {
    return func(o *options) {
        o.level = level
    }
}
...
func SetOptions(opts ...Option) {
    std.SetOptions(opts...)
}

func (l *logger) SetOptions(opts ...Option) {
    l.mu.Lock()
    defer l.mu.Unlock()

    for _, opt := range opts {
        opt(l.opt)
    }
}
```

å…·æœ‰é€‰é¡¹æ¨¡å¼çš„æ—¥å¿—åŒ…ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼Œæ¥åŠ¨æ€åœ°ä¿®æ”¹æ—¥å¿—çš„é€‰é¡¹ï¼š

```
cuslog.SetOptions(cuslog.WithLevel(cuslog.DebugLevel))
```

ä½ å¯ä»¥æ ¹æ®éœ€è¦ï¼Œå¯¹æ¯ä¸€ä¸ªæ—¥å¿—é€‰é¡¹åˆ›å»ºè®¾ç½®å‡½æ•° `WithXXXX` ã€‚è¿™ä¸ªç¤ºä¾‹æ—¥å¿—åŒ…æ”¯æŒå¦‚ä¸‹é€‰é¡¹è®¾ç½®å‡½æ•°ï¼š

+ WithOutputï¼ˆoutput io.Writerï¼‰ï¼šè®¾ç½®è¾“å‡ºä½ç½®ã€‚
+ WithLevelï¼ˆlevel Levelï¼‰ï¼šè®¾ç½®è¾“å‡ºçº§åˆ«ã€‚
+ WithFormatterï¼ˆformatter Formatterï¼‰ï¼šè®¾ç½®è¾“å‡ºæ ¼å¼ã€‚
+ WithDisableCallerï¼ˆcaller boolï¼‰ï¼šè®¾ç½®æ˜¯å¦æ‰“å°æ–‡ä»¶åå’Œè¡Œå·ã€‚



### åˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•

ä¸ºäº†æ‰“å°æ—¥å¿—ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ—¥å¿—é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªLoggerï¼Œç„¶åé€šè¿‡è°ƒç”¨Loggerçš„æ—¥å¿—æ‰“å°æ–¹æ³•ï¼Œå®Œæˆå„çº§åˆ«æ—¥å¿—çš„è¾“å‡ºã€‚æœ¬ç¤ºä¾‹å°†åˆ›å»ºä»£ç ä¿å­˜åœ¨[logger.go](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/logger.go)æ–‡ä»¶ä¸­ã€‚

å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ›å»º`Logger`ï¼š

```go

var std = New()

type logger struct {
    opt       *options
    mu        sync.Mutex
    entryPool *sync.Pool
}

func New(opts ...Option) *logger {
    logger := &logger{opt: initOptions(opts...)}
    logger.entryPool = &sync.Pool{New: func() interface{} { return entry(logger) }}
    return logger
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªLoggerï¼Œå¹¶å®ç°äº†åˆ›å»ºLoggerçš„Newå‡½æ•°ã€‚æ—¥å¿—åŒ…éƒ½ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å…¨å±€Loggerï¼Œæœ¬ç¤ºä¾‹é€šè¿‡ `var std = New()` åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„é»˜è®¤Loggerã€‚`cuslog.Debug`ã€`cuslog.Info`å’Œ`cuslog.Warnf`ç­‰å‡½æ•°ï¼Œåˆ™æ˜¯é€šè¿‡è°ƒç”¨`std Logger`æ‰€æä¾›çš„æ–¹æ³•æ¥æ‰“å°æ—¥å¿—çš„ã€‚

å®šä¹‰äº†ä¸€ä¸ªLoggerä¹‹åï¼Œè¿˜éœ€è¦ç»™è¯¥Loggeræ·»åŠ æœ€æ ¸å¿ƒçš„æ—¥å¿—æ‰“å°æ–¹æ³•ï¼Œè¦æä¾›æ‰€æœ‰æ”¯æŒçº§åˆ«çš„æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚

å¦‚æœæ—¥å¿—çº§åˆ«æ˜¯Xyzï¼Œåˆ™é€šå¸¸éœ€è¦æä¾›ä¸¤ç±»æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯éæ ¼å¼åŒ–æ–¹æ³•`Xyz(args ...interface{})`å’Œæ ¼å¼åŒ–æ–¹æ³•`Xyzf(format string, args ...interface{})`ï¼Œä¾‹å¦‚ï¼š

```go
func (l *logger) Debug(args ...interface{}) {
    l.entry().write(DebugLevel, FmtEmptySeparate, args...)
}
func (l *logger) Debugf(format string, args ...interface{}) {
    l.entry().write(DebugLevel, format, args...)
}
```

æœ¬ç¤ºä¾‹å®ç°äº†å¦‚ä¸‹æ–¹æ³•ï¼šDebugã€Debugfã€Infoã€Infofã€Warnã€Warnfã€Errorã€Errorfã€Panicã€Panicfã€Fatalã€Fatalfã€‚æ›´è¯¦ç»†çš„å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒ [cuslog/logger.go](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/logger.go)ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼ŒPanicã€Panicfè¦è°ƒç”¨panic()å‡½æ•°ï¼ŒFatalã€Fatalfå‡½æ•°è¦è°ƒç”¨ `os.Exit(1)` å‡½æ•°ã€‚



### å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­

è°ƒç”¨æ—¥å¿—æ‰“å°å‡½æ•°ä¹‹åï¼Œè¿˜éœ€è¦å°†è¿™äº›æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ï¼Œæ‰€ä»¥éœ€è¦å®ç°`write`å‡½æ•°ï¼Œå®ƒçš„å†™å…¥é€»è¾‘ä¿å­˜åœ¨[entry.go](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/entry.go)æ–‡ä»¶ä¸­ã€‚å®ç°æ–¹å¼å¦‚ä¸‹ï¼š

```go
type Entry struct {
    logger *logger
    Buffer *bytes.Buffer
    Map    map[string]interface{}
    Level  Level
    Time   time.Time
    File   string
    Line   int
    Func   string
    Format string
    Args   []interface{}
}

func (e *Entry) write(level Level, format string, args ...interface{}) {
    if e.logger.opt.level > level {
        return
    }
    e.Time = time.Now()
    e.Level = level
    e.Format = format
    e.Args = args
    if !e.logger.opt.disableCaller {
        if pc, file, line, ok := runtime.Caller(2); !ok {
            e.File = "???"
            e.Func = "???"
        } else {
            e.File, e.Line, e.Func = file, line, runtime.FuncForPC(pc).Name()
            e.Func = e.Func[strings.LastIndex(e.Func, "/")+1:]
        }
    }
    e.format()
    e.writer()
    e.release()
}

func (e *Entry) format() {
    _ = e.logger.opt.formatter.Format(e)
}

func (e *Entry) writer() {
    e.logger.mu.Lock()
    _, _ = e.logger.opt.output.Write(e.Buffer.Bytes())
    e.logger.mu.Unlock()
}

func (e *Entry) release() {
    e.Args, e.Line, e.File, e.Format, e.Func = nil, 0, "", "", ""
    e.Buffer.Reset()
    e.logger.entryPool.Put(e)
}
```

ä¸Šè¿°ä»£ç ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªEntryç»“æ„ä½“ç±»å‹ï¼Œè¯¥ç±»å‹ç”¨æ¥ä¿å­˜æ‰€æœ‰çš„æ—¥å¿—ä¿¡æ¯ï¼Œå³æ—¥å¿—é…ç½®å’Œæ—¥å¿—å†…å®¹ã€‚å†™å…¥é€»è¾‘éƒ½æ˜¯å›´ç»•Entryç±»å‹çš„å®ä¾‹æ¥å®Œæˆçš„ã€‚

ç”¨Entryçš„writeæ–¹æ³•æ¥å®Œæˆæ—¥å¿—çš„å†™å…¥ï¼Œåœ¨writeæ–¹æ³•ä¸­ï¼Œä¼šé¦–å…ˆåˆ¤æ–­æ—¥å¿—çš„è¾“å‡ºçº§åˆ«å’Œå¼€å…³çº§åˆ«ï¼Œå¦‚æœè¾“å‡ºçº§åˆ«å°äºå¼€å…³çº§åˆ«ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¸åšä»»ä½•è®°å½•ã€‚

åœ¨writeä¸­ï¼Œè¿˜ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦è®°å½•æ–‡ä»¶åå’Œè¡Œå·ï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨ `runtime.Caller()` æ¥è·å–æ–‡ä»¶åå’Œè¡Œå·ï¼Œè°ƒç”¨ `runtime.Caller()` æ—¶ï¼Œè¦æ³¨æ„ä¼ å…¥æ­£ç¡®çš„æ ˆæ·±åº¦ã€‚

writeå‡½æ•°ä¸­è°ƒç”¨ `e.format` æ¥æ ¼å¼åŒ–æ—¥å¿—ï¼Œè°ƒç”¨ `e.writer` æ¥å†™å…¥æ—¥å¿—ï¼Œåœ¨åˆ›å»ºLoggerä¼ å…¥çš„æ—¥å¿—é…ç½®ä¸­ï¼ŒæŒ‡å®šäº†è¾“å‡ºä½ç½® `output io.Writer` ï¼Œoutputç±»å‹ä¸º `io.Writer` ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```go
type Writer interface {    
    Write(p []byte) (n int, err error)
}
```

io.Writerå®ç°äº†Writeæ–¹æ³•å¯ä¾›å†™å…¥ï¼Œæ‰€ä»¥åªéœ€è¦è°ƒç”¨`e.logger.opt.output.Write(e.Buffer.Bytes())`å³å¯å°†æ—¥å¿—å†™å…¥åˆ°æŒ‡å®šçš„ä½ç½®ä¸­ã€‚æœ€åï¼Œä¼šè°ƒç”¨release()æ–¹æ³•æ¥æ¸…ç©ºç¼“å­˜å’Œå¯¹è±¡æ± ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æ—¥å¿—çš„è®°å½•å’Œå†™å…¥ã€‚



### è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼

cuslogåŒ…æ”¯æŒè‡ªå®šä¹‰è¾“å‡ºæ ¼å¼ï¼Œå¹¶ä¸”å†…ç½®äº†JSONå’Œ Text æ ¼å¼çš„ `Formatter`ã€‚`Formatter` æ¥å£å®šä¹‰ä¸ºï¼š

```go
type Formatter interface {    
    Format(entry *Entry) error
}
```

cuslogå†…ç½®çš„Formatteræœ‰ä¸¤ä¸ªï¼š[JSON](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/formatter_json.go)å’Œ[TEXT](https://github.com/marmotedu/gopractise-demo/blob/main/log/cuslog/formatter_text.go)ã€‚



### æµ‹è¯•æ—¥å¿—åŒ…

cuslogæ—¥å¿—åŒ…å¼€å‘å®Œæˆä¹‹åï¼Œå¯ä»¥ç¼–å†™æµ‹è¯•ä»£ç ï¼Œè°ƒç”¨`cuslog`åŒ…æ¥æµ‹è¯•`cuslog`åŒ…ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
package main

import (
    "log"
    "os"

    "github.com/marmotedu/gopractise-demo/log/cuslog"
)

func main() {
    cuslog.Info("std log")
    cuslog.SetOptions(cuslog.WithLevel(cuslog.DebugLevel))
    cuslog.Debug("change std log to debug level")
    cuslog.SetOptions(cuslog.WithFormatter(&cuslog.JsonFormatter{IgnoreBasicFields: false}))
    cuslog.Debug("log in json format")
    cuslog.Info("another log in json format")

    // è¾“å‡ºåˆ°æ–‡ä»¶
    fd, err := os.OpenFile("test.log", os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644)
    if err != nil {
        log.Fatalln("create file test.log failed")
    }
    defer fd.Close()

    l := cuslog.New(cuslog.WithLevel(cuslog.InfoLevel),
        cuslog.WithOutput(fd),
        cuslog.WithFormatter(&cuslog.JsonFormatter{IgnoreBasicFields: false}),
    )
    l.Info("custom log with json formatter")
}
```

å°†ä¸Šè¿°ä»£ç ä¿å­˜åœ¨main.goæ–‡ä»¶ä¸­ï¼Œè¿è¡Œï¼š

```bash
$ go run example.go
2020-12-04T10:32:12+08:00 INFO example.go:11 std log
2020-12-04T10:32:12+08:00 DEBUG example.go:13 change std log to debug level
{"file":"/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/log/cuslog/example/example.go:15","func":"main.main","message":"log in json format","level":"DEBUG","time":"2020-12-04T10:32:12+08:00"}
{"level":"INFO","time":"2020-12-04T10:32:12+08:00","file":"/home/colin/workspace/golang/src/github.com/marmotedu/gopractise-demo/log/cuslog/example/example.go:16","func":"main.main","message":"another log in json format"}
```

åˆ°è¿™é‡Œæ—¥å¿—åŒ…å°±å¼€å‘å®Œæˆäº†ï¼Œå®Œæ•´åŒ…è§ [log/cuslog](https://github.com/marmotedu/gopractise-demo/tree/main/log/cuslog)ã€‚



### IAMé¡¹ç›®æ—¥å¿—åŒ…è®¾è®¡

è¿™ä¸€è®²çš„æœ€åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹æˆ‘ä»¬çš„IAMé¡¹ç›®ä¸­ï¼Œæ—¥å¿—åŒ…æ˜¯æ€ä¹ˆè®¾è®¡çš„ã€‚

å…ˆæ¥çœ‹ä¸€ä¸‹IAMé¡¹ç›®logåŒ…çš„å­˜æ”¾ä½ç½®ï¼š[pkg/log](https://github.com/marmotedu/iam/tree/v1.0.0/pkg/log)ã€‚æ”¾åœ¨è¿™ä¸ªä½ç½®ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå› ï¼š

+ ç¬¬ä¸€ä¸ªï¼Œ`log` åŒ…å±äºIAMé¡¹ç›®ï¼Œæœ‰å®šåˆ¶å¼€å‘çš„å†…å®¹ï¼›
+ ç¬¬äºŒä¸ªï¼Œ`log` åŒ…åŠŸèƒ½å®Œå¤‡ã€æˆç†Ÿï¼Œå¤–éƒ¨é¡¹ç›®ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚

è¯¥logåŒ…æ˜¯åŸºäº `go.uber.org/zap` åŒ…å°è£…è€Œæ¥çš„ï¼Œæ ¹æ®éœ€è¦æ·»åŠ äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡logåŒ…çš„[Options](https://github.com/marmotedu/iam/blob/master/pkg/log/options.go#L47)ï¼Œæ¥çœ‹ä¸‹logåŒ…æ‰€å®ç°çš„åŠŸèƒ½ï¼š

```go
// Options contains configuration items related to log.
type Options struct {
	OutputPaths       []string `json:"output-paths"       mapstructure:"output-paths"`
	ErrorOutputPaths  []string `json:"error-output-paths" mapstructure:"error-output-paths"`
	Level             string   `json:"level"              mapstructure:"level"`
	Format            string   `json:"format"             mapstructure:"format"`
	DisableCaller     bool     `json:"disable-caller"     mapstructure:"disable-caller"`
	DisableStacktrace bool     `json:"disable-stacktrace" mapstructure:"disable-stacktrace"`
	EnableColor       bool     `json:"enable-color"       mapstructure:"enable-color"`
	Development       bool     `json:"development"        mapstructure:"development"`
	Name              string   `json:"name"               mapstructure:"name"`
}
```



**Optionså„é…ç½®é¡¹å«ä¹‰å¦‚ä¸‹ï¼š**

+ developmentï¼šæ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€‚
+ nameï¼šLoggerçš„åå­—ã€‚
+ disable-callerï¼šæ˜¯å¦å¼€å¯ callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·ã€‚
+ disable-stacktraceï¼šæ˜¯å¦åœ¨PanicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ¯ã€‚
+ enable-colorï¼šæ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrueï¼Œæ˜¯ï¼›falseï¼Œå¦ã€‚
+ levelï¼šæ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šDebug, Info, Warn, Error, Dpanic, Panic, Fatalã€‚
+ formatï¼šæ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒConsoleå’ŒJSONä¸¤ç§ã€‚Consoleå…¶å®å°±æ˜¯Textæ ¼å¼ã€‚
+ output-pathsï¼šæ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªè¾“å‡ºï¼Œç”¨é€—å·åˆ†å¼€ã€‚æ”¯æŒè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ–‡ä»¶ã€‚
+ error-output-pathsï¼šzapå†…éƒ¨(éä¸šåŠ¡)é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œç”¨é€—å·åˆ†å¼€ã€‚



**logåŒ…çš„Optionsç»“æ„ä½“æ”¯æŒä»¥ä¸‹3ä¸ªæ–¹æ³•ï¼š**

+ Buildæ–¹æ³•ã€‚Buildæ–¹æ³•å¯ä»¥æ ¹æ®Optionsæ„å»ºä¸€ä¸ªå…¨å±€çš„Loggerã€‚
+ AddFlagsæ–¹æ³•ã€‚AddFlagsæ–¹æ³•å¯ä»¥å°†Optionsçš„å„ä¸ªå­—æ®µè¿½åŠ åˆ°ä¼ å…¥çš„pflag.FlagSetå˜é‡ä¸­ã€‚
+ Stringæ–¹æ³•ã€‚Stringæ–¹æ³•å¯ä»¥å°†Optionsçš„å€¼ä»¥JSONæ ¼å¼å­—ç¬¦ä¸²è¿”å›ã€‚



**logåŒ…å®ç°äº†ä»¥ä¸‹3ç§æ—¥å¿—è®°å½•æ–¹æ³•ï¼š**

```go
log.Info("This is a info message", log.Int32("int_key", 10))
log.Infof("This is a formatted %s message", "info")
log.Infow("Message printed with Infow", "X-Request-ID", "fbf54504-64da-4088-9b86-67824a7fb508")
```

`Info` ä½¿ç”¨æŒ‡å®šçš„ `key/value` è®°å½•æ—¥å¿—ã€‚`Infof` æ ¼å¼åŒ–è®°å½•æ—¥å¿—ã€‚ `Infow` ä¹Ÿæ˜¯ä½¿ç”¨æŒ‡å®šçš„ `key/value`è®°å½•æ—¥å¿—ï¼Œè·Ÿ `Info` çš„åŒºåˆ«æ˜¯ï¼šä½¿ç”¨ `Info` éœ€è¦æŒ‡å®šå€¼çš„ç±»å‹ï¼Œé€šè¿‡æŒ‡å®šå€¼çš„æ—¥å¿—ç±»å‹ï¼Œæ—¥å¿—åº“åº•å±‚ä¸éœ€è¦è¿›è¡Œåå°„æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨ `Info` è®°å½•æ—¥å¿—æ€§èƒ½æœ€é«˜ã€‚

logåŒ…æ”¯æŒéå¸¸ä¸°å¯Œçš„ç±»å‹ï¼Œå…·ä½“ä½ å¯ä»¥å‚è€ƒ [types.go](https://github.com/marmotedu/iam/blob/master/pkg/log/types.go#L56)ã€‚



**ä¸Šè¿°æ—¥å¿—è¾“å‡ºä¸ºï¼š**

```bash
2021-07-06 14:02:07.070 INFO This is a info message {"int_key": 10}
2021-07-06 14:02:07.071 INFO This is a formatted info message
2021-07-06 14:02:07.071 INFO Message printed with Infow {"X-Request-ID": "fbf54504-64da-4088-9b86-67824a7fb508"}
```

logåŒ…ä¸ºæ¯ç§çº§åˆ«çš„æ—¥å¿—éƒ½æä¾›äº†3ç§æ—¥å¿—è®°å½•æ–¹å¼ï¼Œä¸¾ä¸ªä¾‹å­ï¼šå‡è®¾æ—¥å¿—æ ¼å¼ä¸º `Xyz` ï¼Œåˆ™åˆ†åˆ«æä¾›äº† `Xyz(msg string, fields ...Field)` ï¼Œ`Xyzf(format string, v ...interface{})` ï¼Œ`Xyzw(msg string, keysAndValues ...interface{})` 3ç§æ—¥å¿—è®°å½•æ–¹æ³•ã€‚

å¦å¤–ï¼ŒlogåŒ…ç›¸è¾ƒäºä¸€èˆ¬çš„æ—¥å¿—åŒ…ï¼Œè¿˜æä¾›äº†ä¼—å¤šè®°å½•æ—¥å¿—çš„æ–¹æ³•ã€‚

**ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œ** logåŒ…æ”¯æŒV Levelï¼Œå¯ä»¥é€šè¿‡æ•´å‹æ•°å€¼æ¥çµæ´»æŒ‡å®šæ—¥å¿—çº§åˆ«ï¼Œæ•°å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šä½ã€‚ä¾‹å¦‚ï¼š

> âš ï¸ `V Level`æ˜¯æŒ‡åœ¨`glog`æ—¥å¿—åº“ä¸­ç”¨äºæ§åˆ¶æ—¥å¿—çº§åˆ«çš„ä¸€ç§æœºåˆ¶ã€‚`glog`æ˜¯ä¸€ä¸ª Go è¯­è¨€çš„æ—¥å¿—åº“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°è¿›è¡Œæ—¥å¿—è®°å½•å’Œè¾“å‡ºã€‚
>
> `V Level`è¡¨ç¤º verbose levelï¼Œå³å†—é•¿ç¨‹åº¦ã€‚åœ¨`glog`ä¸­ï¼Œé€šè¿‡è®¾ç½®`V Level`çš„å€¼ï¼Œå¯ä»¥æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºçº§åˆ«ã€‚`V Level`çš„å–å€¼èŒƒå›´æ˜¯`0~~4`ï¼Œå…¶ä¸­0è¡¨ç¤ºåªè¾“å‡ºæ™®é€šæ—¥å¿—ï¼Œ`1~~4`è¡¨ç¤ºè¾“å‡ºå¯¹åº”çº§åˆ«çš„è°ƒè¯•ä¿¡æ¯ã€‚
>
> `glog`ä¸­é€šè¿‡`V()`æ–¹æ³•æ¥è®¾ç½®`V Level`çš„å€¼ï¼Œä¾‹å¦‚ï¼š
>
> ```go
> glog.V(1).Info("This is a verbose level 1 log message.")
> ```
>
> åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡`glog.V(1)`è®¾ç½®`V Level`çš„å€¼ä¸º1ï¼Œç„¶åè°ƒç”¨`Info()`æ–¹æ³•è¾“å‡ºä¸€æ¡æ—¥å¿—ã€‚ç”±äº`V Level`çš„å€¼ä¸º1ï¼Œå› æ­¤è¿™æ¡æ—¥å¿—ä¼šè¢«è¾“å‡ºã€‚
>
> åœ¨`glog`ä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`vmodule`é€‰é¡¹æ¥æ§åˆ¶ä¸åŒåŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ã€‚é€šè¿‡è®¾ç½®`vmodule`é€‰é¡¹ï¼Œå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„æ—¥å¿—æ§åˆ¶ã€‚ä¾‹å¦‚ï¼š
>
> ```bash
> $ go run main.go -vmodule=module1=2,module2=3
> ```
>
> åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡è®¾ç½®`vmodule`é€‰é¡¹æ¥æ§åˆ¶`module1`åŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸º2ï¼Œ`module2`åŒ…ä¸­çš„æ—¥å¿—è¾“å‡ºçº§åˆ«ä¸º3ã€‚è¿™æ ·ï¼Œå°±å¯ä»¥æ›´åŠ çµæ´»åœ°æ§åˆ¶æ—¥å¿—çš„è¾“å‡ºçº§åˆ«ï¼Œä»¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚

```go
// V levelä½¿ç”¨
log.V(1).Info("This is a V level message")
log.V(1).Infof("This is a %s V level message", "formatted")
log.V(1).Infow("This is a V level message with fields", "X-Request-ID", "7a7b9f24-4cae-4b2a-9464-69088b45b904")
```

è¿™é‡Œè¦æ³¨æ„ï¼ŒLog.Våªæ”¯æŒ `Info` ã€`Infof` ã€`Infow`ä¸‰ç§æ—¥å¿—è®°å½•æ–¹æ³•ã€‚



**ç¬¬äºŒä¸ªæ–¹æ³•ï¼Œ** logåŒ…æ”¯æŒWithValueså‡½æ•°ï¼Œä¾‹å¦‚ï¼š

```go
// WithValuesä½¿ç”¨
lv := log.WithValues("X-Request-ID", "7a7b9f24-4cae-4b2a-9464-69088b45b904")
lv.Infow("Info message printed with [WithValues] logger")
lv.Infow("Debug message printed with [WithValues] logger")
```

**ä¸Šè¿°æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š**

```bash
2021-07-06 14:15:28.555 INFO Info message printed with [WithValues] logger {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
2021-07-06 14:15:28.556 INFO Debug message printed with [WithValues] logger {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
```

`WithValues` å¯ä»¥è¿”å›ä¸€ä¸ªæºå¸¦æŒ‡å®škey-valueçš„Loggerï¼Œä¾›åé¢ä½¿ç”¨ã€‚



**ç¬¬ä¸‰ä¸ªæ–¹æ³•ï¼Œ** logåŒ…æä¾› `WithContext` å’Œ `FromContext` ç”¨æ¥å°†æŒ‡å®šçš„Loggeræ·»åŠ åˆ°æŸä¸ªContextä¸­ï¼Œä»¥åŠä»æŸä¸ªContextä¸­è·å–Loggerï¼Œä¾‹å¦‚ï¼š

```go
// Contextä½¿ç”¨
ctx := lv.WithContext(context.Background())
lc := log.FromContext(ctx)
lc.Info("Message printed with [WithContext] logger")
```

`WithContext`å’Œ`FromContext`éå¸¸é€‚åˆç”¨åœ¨ä»¥`context.Context`ä¼ é€’çš„å‡½æ•°ä¸­ï¼Œä¾‹å¦‚ï¼š

```go
func main() {
 
    ...
 
    // WithValuesä½¿ç”¨
    lv := log.WithValues("X-Request-ID", "7a7b9f24-4cae-4b2a-9464-69088b45b904")
     
    // Contextä½¿ç”¨
    lv.Infof("Start to call pirntString")
    ctx := lv.WithContext(context.Background())
    pirntString(ctx, "World")  
}
 
func pirntString(ctx context.Context, str string) {
    lc := log.FromContext(ctx)
    lc.Infof("Hello %s", str)
}
```

ä¸Šè¿°ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š

```
2021-07-06 14:38:02.050 INFO Start to call pirntString {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
2021-07-06 14:38:02.050 INFO Hello World {"X-Request-ID": "7a7b9f24-4cae-4b2a-9464-69088b45b904"}
```

å°†Loggeræ·»åŠ åˆ°Contextä¸­ï¼Œå¹¶é€šè¿‡Contextåœ¨ä¸åŒå‡½æ•°é—´ä¼ é€’ï¼Œå¯ä»¥ä½¿key-valueåœ¨ä¸åŒå‡½æ•°é—´ä¼ é€’ã€‚ä¾‹å¦‚ä¸Šè¿°ä»£ç ä¸­ï¼Œ `X-Request-ID` åœ¨mainå‡½æ•°ã€printStringå‡½æ•°ä¸­çš„æ—¥å¿—è¾“å‡ºä¸­å‡æœ‰è®°å½•ï¼Œä»è€Œå®ç°äº†ä¸€ç§è°ƒç”¨é“¾çš„æ•ˆæœã€‚



**ç¬¬å››ä¸ªæ–¹æ³•ï¼Œ** å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä»Contextä¸­æå–å‡ºæŒ‡å®šçš„key-valueï¼Œä½œä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ°æ—¥å¿—è¾“å‡ºä¸­ï¼Œä¾‹å¦‚ [internal/apiserver/api/v1/user/create.go](https://github.com/marmotedu/iam/blob/v1.0.0/internal/apiserver/api/v1/user/create.go#L20)æ–‡ä»¶ä¸­çš„æ—¥å¿—è°ƒç”¨ï¼š

```go
// Info logs a message at level Info on the compatibleLogger.
log.L(c).Info("user create function called.")
```

é€šè¿‡è°ƒç”¨ `Log.L()` å‡½æ•°ï¼Œå®ç°å¦‚ä¸‹ï¼š

```go

// L method output with specified context value.
func L(ctx context.Context) *zapLogger {
    return std.L(ctx)
}
 
func (l *zapLogger) L(ctx context.Context) *zapLogger {
    lg := l.clone()
 
    requestID, _ := ctx.Value(KeyRequestID).(string)
    username, _ := ctx.Value(KeyUsername).(string)
    lg.zapLogger = lg.zapLogger.With(zap.String(KeyRequestID, requestID), zap.String(KeyUsername, username))
 
    return lg
}
```

`L()` æ–¹æ³•ä¼šä»ä¼ å…¥çš„Contextä¸­æå–å‡º `requestID` å’Œ `username` ï¼Œè¿½åŠ åˆ°Loggerä¸­ï¼Œå¹¶è¿”å›Loggerã€‚è¿™æ—¶å€™è°ƒç”¨è¯¥Loggerçš„Infoã€Infofã€Infowç­‰æ–¹æ³•è®°å½•æ—¥å¿—ï¼Œè¾“å‡ºçš„æ—¥å¿—ä¸­å‡åŒ…å« `requestID` å’Œ `username` å­—æ®µï¼Œä¾‹å¦‚ï¼š

```bash
2021-07-06 14:46:00.743 INFO    apiserver       secret/create.go:23     create secret function called.  {"requestID": "73144bed-534d-4f68-8e8d-dc8a8ed48507", "username": "admin"}
```

é€šè¿‡å°†Contextåœ¨å‡½æ•°é—´ä¼ é€’ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å®ç°è°ƒç”¨é“¾æ•ˆæœï¼Œä¾‹å¦‚ï¼š

```go
// Create add new secret key pairs to the storage.
func (s *SecretHandler) Create(c *gin.Context) {
    log.L(c).Info("create secret function called.")
     
    ...
     
    secrets, err := s.srv.Secrets().List(c, username, metav1.ListOptions{    
        Offset: pointer.ToInt64(0),
        Limit:  pointer.ToInt64(-1),
    })
     
    ...
     
     if err := s.srv.Secrets().Create(c, &r, metav1.CreateOptions{}); err != nil {
        core.WriteResponse(c, err, nil)

        return
    }
 
    core.WriteResponse(c, nil, r)
}
```

ä¸Šè¿°ä»£ç è¾“å‡ºä¸ºï¼š

```go
2021-07-06 14:46:00.743 INFO    apiserver       secret/create.go:23     create secret function called.  {"requestID": "73144bed-534d-4f68-8e8d-dc8a8ed48507", "username": "admin"}
2021-07-06 14:46:00.744 INFO    apiserver       secret/create.go:23     list secret from storage.  {"requestID": "73144bed-534d-4f68-8e8d-dc8a8ed48507", "username": "admin"}
2021-07-06 14:46:00.745 INFO    apiserver       secret/create.go:23     insert secret to storage.  {"requestID": "73144bed-534d-4f68-8e8d-dc8a8ed48507", "username": "admin"}
```

è¿™é‡Œè¦æ³¨æ„ï¼Œ `log.L` å‡½æ•°é»˜è®¤ä¼šä»Contextä¸­å– `requestID` å’Œ `username` é”®ï¼Œè¿™è·ŸIAMé¡¹ç›®æœ‰è€¦åˆåº¦ï¼Œä½†è¿™ä¸å½±å“`log`åŒ…ä¾›ç¬¬ä¸‰æ–¹é¡¹ç›®ä½¿ç”¨ã€‚è¿™ä¹Ÿæ˜¯æˆ‘å»ºè®®ä½ è‡ªå·±å°è£…æ—¥å¿—åŒ…çš„åŸå› ã€‚



### æ€»ç»“

å¼€å‘ä¸€ä¸ªæ—¥å¿—åŒ…ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™éœ€è¦åŸºäºä¸€äº›ä¸šç•Œä¼˜ç§€çš„å¼€æºæ—¥å¿—åŒ…è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚å½“å‰å¾ˆå¤šé¡¹ç›®çš„æ—¥å¿—åŒ…éƒ½æ˜¯åŸºäº`zap`æ—¥å¿—åŒ…æ¥å°è£…çš„ï¼Œå¦‚æœä½ æœ‰å°è£…çš„éœ€è¦ï¼Œæˆ‘å»ºè®®ä½ ä¼˜å…ˆé€‰æ‹©zapæ—¥å¿—åŒ…ã€‚

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘å…ˆç»™ä½ ä»‹ç»äº†æ ‡å‡†åº“logåŒ…ã€glogã€logruså’Œzapè¿™å››ç§å¸¸ç”¨çš„æ—¥å¿—åŒ…ï¼Œç„¶åå‘ä½ å±•ç°äº†å¼€å‘ä¸€ä¸ªæ—¥å¿—åŒ…çš„å››ä¸ªæ­¥éª¤ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1. å®šä¹‰æ—¥å¿—çº§åˆ«å’Œæ—¥å¿—é€‰é¡¹ã€‚
2. åˆ›å»ºLoggeråŠå„çº§åˆ«æ—¥å¿—æ‰“å°æ–¹æ³•ã€‚
3. å°†æ—¥å¿—è¾“å‡ºåˆ°æ”¯æŒçš„è¾“å‡ºä¸­ã€‚
4. è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚

æœ€åï¼Œæˆ‘ä»‹ç»äº†IAMé¡¹ç›®å°è£…çš„logåŒ…çš„è®¾è®¡å’Œä½¿ç”¨æ–¹å¼ã€‚logåŒ…åŸºäº `go.uber.org/zap`å°è£…ï¼Œå¹¶æä¾›äº†ä»¥ä¸‹å¼ºå¤§ç‰¹æ€§ï¼š

+ logåŒ…æ”¯æŒV Levelï¼Œå¯ä»¥çµæ´»çš„é€šè¿‡æ•´å‹æ•°å€¼æ¥æŒ‡å®šæ—¥å¿—çº§åˆ«ã€‚
+ logåŒ…æ”¯æŒ `WithValues` å‡½æ•°ï¼Œ `WithValues` å¯ä»¥è¿”å›ä¸€ä¸ªæºå¸¦æŒ‡å®škey-valueå¯¹çš„Loggerï¼Œä¾›åé¢ä½¿ç”¨ã€‚
+ logåŒ…æä¾› `WithContext` å’Œ `FromContext` ç”¨æ¥å°†æŒ‡å®šçš„Loggeræ·»åŠ åˆ°æŸä¸ªContextä¸­å’Œä»æŸä¸ªContextä¸­è·å–Loggerã€‚
+ logåŒ…æä¾›äº† `Log.L()` å‡½æ•°ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä»Contextä¸­æå–å‡ºæŒ‡å®šçš„key-valueå¯¹ï¼Œä½œä¸ºä¸Šä¸‹æ–‡æ·»åŠ åˆ°æ—¥å¿—è¾“å‡ºä¸­ã€‚



### è¯¾åç»ƒä¹ 

1. å°è¯•å®ç°ä¸€ä¸ªæ–°çš„Formatterï¼Œå¯ä»¥ä½¿ä¸åŒæ—¥å¿—çº§åˆ«ä»¥ä¸åŒé¢œè‰²è¾“å‡ºï¼ˆä¾‹å¦‚ï¼šErrorçº§åˆ«çš„æ—¥å¿—è¾“å‡ºä¸­ `Error` å­—ç¬¦ä¸²ç”¨çº¢è‰²å­—ä½“è¾“å‡ºï¼Œ `Info` å­—ç¬¦ä¸²ç”¨ç™½è‰²å­—ä½“è¾“å‡ºï¼‰ã€‚
2. å°è¯•å°†[runtime.Caller(2)](https://github.com/marmotedu/gopractise-demo/blob/master/log/cuslog/entry.go#L36)å‡½æ•°è°ƒç”¨ä¸­çš„ `2` æ”¹æˆ `1` ï¼Œçœ‹çœ‹æ—¥å¿—è¾“å‡ºæ˜¯å¦è·Ÿä¿®æ”¹å‰æœ‰å·®å¼‚ï¼Œå¦‚æœæœ‰å·®å¼‚ï¼Œæ€è€ƒå·®å¼‚äº§ç”Ÿçš„åŸå› ã€‚





## END é“¾æ¥
<ul><li><div><a href = '12.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '14.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

