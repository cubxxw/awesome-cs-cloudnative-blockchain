+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬40èŠ‚ IAM å®¹å™¨åŒ–éƒ¨ç½²å®æˆ˜

<br> 

<div><a href = '39.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '41.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

åœ¨ [45è®²](https://time.geekbang.org/column/article/415606)ä¸­ï¼Œæˆ‘ä»‹ç»äº†ä¸€ç§åŸºäºKubernetesçš„äº‘åŸç”Ÿæ¶æ„è®¾è®¡æ–¹æ¡ˆã€‚åœ¨äº‘åŸç”Ÿæ¶æ„ä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡Docker + Kubernetesæ¥éƒ¨ç½²äº‘åŸç”Ÿåº”ç”¨çš„ã€‚é‚£ä¹ˆè¿™ä¸€è®²ï¼Œæˆ‘å°±æ‰‹æŠŠæ‰‹æ•™ä½ å¦‚ä½•åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²å¥½IAMåº”ç”¨ã€‚å› ä¸ºæ­¥éª¤æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥å¸Œæœ›ä½ èƒ½è·Ÿç€æˆ‘å®Œæˆæ¯ä¸€ä¸ªæ“ä½œæ­¥éª¤ã€‚ç›¸ä¿¡åœ¨å®æ“çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¹Ÿä¼šå­¦åˆ°æ›´å¤šçš„çŸ¥è¯†ã€‚

## å‡†å¤‡å·¥ä½œ

åœ¨éƒ¨ç½²IAMåº”ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åšä»¥ä¸‹å‡†å¤‡å·¥ä½œï¼š

1. å¼€é€šè…¾è®¯äº‘å®¹å™¨æœåŠ¡é•œåƒä»“åº“ã€‚
2. å®‰è£…å¹¶é…ç½®Dockerã€‚
3. å‡†å¤‡ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚

### å¼€é€šè…¾è®¯äº‘å®¹å™¨æœåŠ¡é•œåƒä»“åº“

åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²IAMåº”ç”¨ï¼Œéœ€è¦ä»é•œåƒä»“åº“ä¸‹è½½æŒ‡å®šçš„IAMé•œåƒï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªé•œåƒä»“åº“æ¥æ‰˜ç®¡IAMçš„é•œåƒã€‚æˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†IAMé•œåƒæ‰˜ç®¡åˆ°[DockerHub](https://hub.docker.com/)ä¸Šï¼Œè¿™ä¹Ÿæ˜¯dockerè¿è¡Œæ—¶é»˜è®¤è·å–é•œåƒçš„åœ°å€ã€‚

ä½†å› ä¸ºDockerHubæœåŠ¡éƒ¨ç½²åœ¨å›½å¤–ï¼Œå›½å†…è®¿é—®é€Ÿåº¦å¾ˆæ…¢ã€‚æ‰€ä»¥ï¼Œæˆ‘å»ºè®®å°†IAMé•œåƒæ‰˜ç®¡åœ¨å›½å†…çš„é•œåƒä»“åº“ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©è…¾è®¯äº‘æä¾›çš„é•œåƒä»“åº“æœåŠ¡ï¼Œè®¿é—®åœ°å€ä¸º[å®¹å™¨é•œåƒæœåŠ¡ä¸ªäººç‰ˆ](https://console.cloud.tencent.com/tke2/registry)ã€‚

å¦‚æœä½ å·²ç»æœ‰è…¾è®¯äº‘çš„é•œåƒä»“åº“ï¼Œå¯ä»¥å¿½ç•¥è…¾è®¯äº‘é•œåƒä»“åº“å¼€é€šæ­¥éª¤ã€‚

åœ¨å¼€é€šè…¾è®¯äº‘é•œåƒä»“åº“ä¹‹å‰ï¼Œä½ éœ€è¦[æ³¨å†Œè…¾è®¯äº‘è´¦å·](https://cloud.tencent.com/document/product/378/17985)ï¼Œå¹¶å®Œæˆ[å®åè®¤è¯](https://cloud.tencent.com/document/product/378/3629)ã€‚

å¼€é€šè…¾è®¯äº‘é•œåƒä»“åº“çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

**ç¬¬ä¸€æ­¥ï¼Œå¼€é€šä¸ªäººç‰ˆé•œåƒä»“åº“ã€‚**

1. ç™»å½•[å®¹å™¨æœåŠ¡æ§åˆ¶å°](https://console.cloud.tencent.com/tke2)ï¼Œé€‰æ‹©å·¦ä¾§å¯¼èˆªæ ä¸­çš„ã€é•œåƒä»“åº“ã€‘>ã€[ä¸ªäººç‰ˆ](https://console.cloud.tencent.com/tke2/registry/user/self)ã€‘ã€‚
2. æ ¹æ®ä»¥ä¸‹æç¤ºï¼Œå¡«å†™ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å•å‡»**ã€å¼€é€šã€‘**è¿›è¡Œåˆå§‹åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1d/8c/1d4bdfe89bc049d224e7002c23a0ea8c.png?wh=1920x569)](https://static001.geekbang.org/resource/image/1d/8c/1d4bdfe89bc049d224e7002c23a0ea8c.png?wh=1920x569)

+ **ç”¨æˆ·åï¼š**é»˜è®¤æ˜¯å½“å‰ç”¨æˆ·çš„è´¦å·IDï¼Œæ˜¯ä½ ç™»å½•åˆ°è…¾è®¯äº‘Dockeré•œåƒä»“åº“çš„èº«ä»½ï¼Œå¯åœ¨ [è´¦å·ä¿¡æ¯](https://console.cloud.tencent.com/developer) é¡µé¢è·å–ã€‚
+ **å¯†ç ï¼š**æ˜¯ä½ ç™»å½•åˆ°è…¾è®¯äº‘ Docker é•œåƒä»“åº“çš„å‡­è¯ã€‚

è¿™é‡Œéœ€è¦ä½ è®°å½•ç”¨æˆ·ååŠå¯†ç ï¼Œç”¨äºæ¨é€åŠæ‹‰å–é•œåƒã€‚å‡å¦‚æˆ‘ä»¬å¼€é€šçš„é•œåƒä»“åº“ï¼Œç”¨æˆ·åä¸º`10000099xxxx`ï¼Œå¯†ç ä¸º`iam59!z$`ã€‚

è¿™é‡Œè¦æ³¨æ„ï¼Œ`10000099xxxx`**è¦æ›¿æ¢æˆä½ é•œåƒä»“åº“çš„ç”¨æˆ·åã€‚**

**ç¬¬äºŒæ­¥ï¼Œç™»å½•åˆ°è…¾è®¯äº‘Registry****ï¼ˆé•œåƒä»“åº“ï¼‰ã€‚**

åœ¨æˆ‘ä»¬å¼€é€šå®ŒRegistryï¼Œå°±å¯ä»¥ç™»å½•Registryäº†ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ç™»å½•è…¾è®¯äº‘Registryï¼š

```bash
$ docker login --username=[username] ccr.ccs.tencentyun.com
```

è¿™é‡Œçš„usernameæ˜¯è…¾è®¯äº‘è´¦å· IDï¼Œå¼€é€šæ—¶å·²æ³¨å†Œï¼Œå¯åœ¨ [è´¦å·ä¿¡æ¯](https://console.cloud.tencent.com/developer) é¡µé¢è·å–ã€‚dockerå‘½ä»¤ä¼šåœ¨åé¢å®‰è£…ã€‚
**ç¬¬ä¸‰æ­¥ï¼Œæ–°å»ºé•œåƒä»“åº“å‘½åç©ºé—´****ã€‚**

å¦‚æœæƒ³ä½¿ç”¨é•œåƒä»“åº“ï¼Œé‚£ä¹ˆä½ é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªç”¨æ¥åˆ›å»ºé•œåƒçš„å‘½åç©ºé—´ã€‚ä¸Šä¸€æ­¥ï¼Œæˆ‘ä»¬å¼€é€šäº†é•œåƒä»“åº“ï¼Œå°±å¯ä»¥åœ¨â€œå‘½åç©ºé—´â€é¡µç­¾æ–°å»ºå‘½åç©ºé—´äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1e/5a/1e79852fdc5ee1a094bd42efdf21015a.png?wh=1920x522)](https://static001.geekbang.org/resource/image/1e/5a/1e79852fdc5ee1a094bd42efdf21015a.png?wh=1920x522)

ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå«`marmotedu`çš„å‘½åç©ºé—´ã€‚

è¿™é‡Œï¼Œé•œåƒä»“åº“æœåŠ¡ã€å‘½åç©ºé—´ã€é•œåƒä»“åº“ã€æ ‡ç­¾è¿™å‡ ä¸ªæ¦‚å¿µä½ å¯èƒ½å¼„ä¸æ¸…æ¥šã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘è¯¦ç»†ä»‹ç»ä¸‹å››è€…çš„å…³ç³»ï¼Œå…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![img](https://static001.geekbang.org/resource/image/ab/3b/abe8358d3ea2851bc32c80fd9519c63b.jpg?wh=2248x1581)](https://static001.geekbang.org/resource/image/ab/3b/abe8358d3ea2851bc32c80fd9519c63b.jpg?wh=2248x1581)

å…ˆæ¥çœ‹ä¸‹æˆ‘ä»¬ä½¿ç”¨é•œåƒä»“åº“çš„æ ¼å¼ï¼š`<é•œåƒä»“åº“æœåŠ¡åœ°å€>/<å‘½åç©ºé—´>/<é•œåƒä»“åº“>:<æ ‡ç­¾>`ï¼Œä¾‹å¦‚`ccr.ccs.tencentyun.com/marmotedu/iam-apiserver-amd64:v1.1.0`ã€‚

å¦‚æœæƒ³ä½¿ç”¨ä¸€ä¸ªDockeré•œåƒï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¼€é€šä¸€ä¸ªé•œåƒä»“åº“æœåŠ¡ï¼ˆRegistryï¼‰ï¼Œé•œåƒä»“åº“æœåŠ¡éƒ½ä¼šå¯¹å¤–æä¾›ä¸€ä¸ªå›ºå®šçš„åœ°å€ä¾›ä½ è®¿é—®ã€‚åœ¨Registryä¸­ï¼Œæˆ‘ä»¬ï¼ˆUserï¼‰å¯ä»¥åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå‘½åç©ºé—´ï¼ˆNamespaceï¼‰ï¼Œå‘½åç©ºé—´ä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºé•œåƒä»“åº“é€»è¾‘ä¸Šçš„ä¸€ä¸ªåˆ†ç»„ã€‚

æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥åœ¨Namespaceä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒä»“åº“ï¼Œä¾‹å¦‚`iam-apiserver-amd64`ã€`iam-authz-server-amd64`ã€`iam-pump-amd64`ç­‰ã€‚é’ˆå¯¹æ¯ä¸€ä¸ªé•œåƒä»“åº“ï¼Œåˆå¯ä»¥åˆ›å»ºå¤šä¸ªæ ‡ç­¾ï¼ˆTagï¼‰ï¼Œä¾‹å¦‚`v1.0.1`ã€`v1.0.2`ç­‰ã€‚

`<é•œåƒä»“åº“>:<æ ‡ç­¾>`åˆç§°ä¸ºé•œåƒã€‚é•œåƒåˆåˆ†ä¸ºç§æœ‰é•œåƒå’Œå…¬æœ‰é•œåƒï¼Œå…¬æœ‰é•œåƒå¯ä¾›æ‰€æœ‰èƒ½è®¿é—®Registryçš„ç”¨æˆ·ä¸‹è½½ä½¿ç”¨ï¼Œç§æœ‰é•œåƒåªæä¾›ç»™é€šè¿‡æˆæƒçš„ç”¨æˆ·ä½¿ç”¨ã€‚

### å®‰è£…Docker

å¼€é€šå®Œé•œåƒä»“åº“ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…Dockerï¼Œç”¨æ¥æ„å»ºå’Œæµ‹è¯•Dockeré•œåƒã€‚ä¸‹é¢æˆ‘æ¥è®²è§£ä¸‹å…·ä½“çš„å®‰è£…æ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼Œå®‰è£…Dockerå‰ç½®æ¡ä»¶æ£€æŸ¥ã€‚**

éœ€è¦ç¡®ä¿CentOSç³»ç»Ÿå¯ç”¨äº†`centos-extras` yumæºï¼Œé»˜è®¤æƒ…å†µä¸‹å·²ç»å¯ç”¨ï¼Œæ£€æŸ¥æ–¹å¼å¦‚ä¸‹ï¼š

```bash
$ cat /etc/yum.repos.d/CentOS-Extras.repo# Qcloud-Extras.repo[extras]name=Qcloud-$releasever - Extrasbaseurl=http://mirrors.tencentyun.com/centos/$releasever/extras/$basearch/os/gpgcheck=1enabled=1gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-Qcloud-8
```

å¦‚æœ`/etc/yum.repos.d/CentOS-Extras.repo`æ–‡ä»¶å­˜åœ¨ï¼Œä¸”æ–‡ä»¶ä¸­`extras`éƒ¨åˆ†çš„`enabled`é…ç½®é¡¹å€¼ä¸º`1`ï¼Œè¯´æ˜å·²ç»å¯ç”¨äº†`centos-extras` yumæºã€‚å¦‚æœ`/etc/yum.repos.d/CentOS-Extras.repo` æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…`enabled` ä¸ä¸º1ï¼Œåˆ™éœ€è¦åˆ›å»º`/etc/yum.repos.d/CentOS-Extras.repo` æ–‡ä»¶ï¼Œå¹¶å°†ä¸Šè¿°å†…å®¹å¤åˆ¶è¿›å»ã€‚

**ç¬¬äºŒæ­¥ï¼Œå®‰è£…dockerã€‚**

Dockerå®˜æ–¹æ–‡æ¡£ [Install Docker Engine on CentOS](https://docs.docker.com/engine/install/centos/)æä¾›äº†3ç§å®‰è£…æ–¹æ³•:

+ é€šè¿‡Yumæºå®‰è£…ã€‚
+ é€šè¿‡RPMåŒ…å®‰è£…
+ é€šè¿‡è„šæœ¬å®‰è£…ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬é€‰æ‹©æœ€ç®€å•çš„å®‰è£…æ–¹å¼ï¼š**é€šè¿‡Yumæºå®‰è£…**ã€‚å®ƒå…·ä½“åˆåˆ†ä¸ºä¸‹é¢3ä¸ªæ­¥éª¤ã€‚

1. å®‰è£…dockerã€‚

```bash
$ sudo yum install -y yum-utils # 1. å®‰è£… yum-utils åŒ…ï¼Œè¯¥åŒ…æä¾›äº† yum-config-manager å·¥å…·$ sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo # 2. å®‰è£… docker-ce.repo yum æº$ sudo yum-config-manager --enable docker-ce-nightly docker-ce-test # 3. å¯ç”¨ nightly å’Œ test yum æº$ sudo yum install -y docker-ce docker-ce-cli containerd.io # 4. å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ docker å¼•æ“å’Œ containerd
```

1. å¯åŠ¨dockerã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å¯åŠ¨ dockerï¼š

```bash
$ sudo systemctl start docker
```

dockerçš„é…ç½®æ–‡ä»¶æ˜¯ `/etc/docker/daemon.json` ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶é»˜è®¤æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºï¼š

```bash
$ sudo tee /etc/docker/daemon.json << EOF{  "bip": "172.16.0.1/24",  "registry-mirrors": [],  "graph": "/data/lib/docker"}EOF
```

è¿™é‡Œï¼Œæˆ‘æ¥è§£é‡Šä¸‹å¸¸ç”¨çš„é…ç½®å‚æ•°ã€‚

+ registry-mirrorsï¼šä»“åº“åœ°å€ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ä¸ºæŒ‡å®šçš„åœ°å€ã€‚
+ graphï¼šé•œåƒã€å®¹å™¨çš„å­˜å‚¨è·¯å¾„ï¼Œé»˜è®¤æ˜¯/var/lib/dockerã€‚å¦‚æœä½ çš„ `/` ç›®å½•å­˜å‚¨ç©ºé—´æ»¡è¶³ä¸äº†éœ€æ±‚ï¼Œéœ€è¦è®¾ç½®graphä¸ºæ›´å¤§çš„ç›®å½•ã€‚
+ bipï¼šæŒ‡å®šå®¹å™¨çš„IPç½‘æ®µã€‚

é…ç½®å®Œæˆåï¼Œéœ€è¦é‡å¯Dockerï¼š

```bash
$ sudo systemctl restart docker
```

1. æµ‹è¯•Dockeræ˜¯å¦å®‰è£…æˆåŠŸã€‚

```bash
$ sudo docker run hello-worldUnable to find image 'hello-world:latest' locallylatest: Pulling from library/hello-worldb8dfde127a29: Pull completeDigest: sha256:0fe98d7debd9049c50b597ef1f85b7c1e8cc81f59c8d623fcb2250e8bec85b38Status: Downloaded newer image for hello-world:latest...Hello from Docker!This message shows that your installation appears to be working correctly.....
```

`docker run hello-world`å‘½ä»¤ä¼šä¸‹è½½`hello-world`é•œåƒï¼Œå¹¶å¯åŠ¨å®¹å™¨ï¼Œæ‰“å°å®‰è£…æˆåŠŸæç¤ºä¿¡æ¯åé€€å‡ºã€‚

è¿™é‡Œæ³¨æ„ï¼Œå¦‚æœä½ é€šè¿‡Yumæºå®‰è£…å¤±è´¥ï¼Œå¯ä»¥å°è¯•Dockerå®˜æ–¹æ–‡æ¡£ [Install Docker Engine on CentOS](https://docs.docker.com/engine/install/centos/)æä¾›çš„å…¶ä»–æ–¹å¼å®‰è£…ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œå®‰è£…åé…ç½®ã€‚**

å®‰è£…æˆåŠŸåï¼Œæˆ‘ä»¬è¿˜éœ€è¦åšä¸€äº›å…¶ä»–é…ç½®ã€‚ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯é…ç½®dockerï¼Œä½¿å…¶å¯é€šè¿‡`non-root`ç”¨æˆ·ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªæ˜¯é…ç½®dockerå¼€æœºå¯åŠ¨ã€‚

1. ä½¿ç”¨`non-root`ç”¨æˆ·æ“ä½œDocker

æˆ‘ä»¬åœ¨Linuxç³»ç»Ÿä¸Šæ“ä½œï¼Œä¸ºäº†å®‰å…¨ï¼Œéœ€è¦ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½ç™»å½•ç³»ç»Ÿå¹¶æ‰§è¡Œæ“ä½œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®dockerï¼Œä½¿å®ƒå¯ä»¥è¢«`non-root`ç”¨æˆ·ä½¿ç”¨ã€‚å…·ä½“é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
$ sudo groupadd docker # 1. åˆ›å»ºdockerç”¨æˆ·ç»„$ sudo usermod -aG docker $USER # 2. å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç”¨æˆ·ç»„ä¸‹$ newgrp docker # 3. é‡æ–°åŠ è½½ç»„æˆå‘˜èº«ä»½$ docker run hello-world # 4. ç¡®è®¤èƒ½å¤Ÿä»¥æ™®é€šç”¨æˆ·ä½¿ç”¨docker
```

å¦‚æœåœ¨æ‰§è¡Œ `sudo groupadd docker` æ—¶æŠ¥ `groupadd: group 'docker' already exists` é”™è¯¯ï¼Œè¯´æ˜ `docker` ç»„å·²ç»å­˜åœ¨äº†ï¼Œå¯ä»¥å¿½ç•¥è¿™ä¸ªæŠ¥é”™ã€‚

å¦‚æœä½ åœ¨å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ä¹‹å‰ï¼Œä½¿ç”¨sudoè¿è¡Œè¿‡dockerå‘½ä»¤ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```plain
WARNING: Error loading config file: /home/user/.docker/config.json -stat /home/user/.docker/config.json: permission denied
```

è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ é™¤`~/.docker/`ç›®å½•æ¥è§£å†³ï¼Œæˆ–è€…é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ›´æ”¹`~/.docker/`ç›®å½•çš„æ‰€æœ‰è€…å’Œæƒé™ï¼š

```bash
$ sudo chown "$USER":"$USER" /home/"$USER"/.docker -R$ sudo chmod g+rwx "$HOME/.docker" -R
```

1. é…ç½®dockerå¼€æœºå¯åŠ¨

å¤§éƒ¨åˆ†Linuxå‘è¡Œç‰ˆï¼ˆRHELã€CentOSã€Fedoraã€Debianã€Ubuntu 16.04åŠæ›´é«˜ç‰ˆæœ¬ï¼‰ä½¿ç”¨systemdæ¥ç®¡ç†æœåŠ¡ï¼ŒåŒ…æ‹¬æŒ‡å®šå¼€å¯æ—¶å¯åŠ¨çš„æœåŠ¡ã€‚åœ¨Debianå’ŒUbuntuä¸Šï¼ŒDockeré»˜è®¤é…ç½®ä¸ºå¼€æœºå¯åŠ¨ã€‚

åœ¨å…¶ä»–ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨é…ç½®Dockerå¼€æœºå¯åŠ¨ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼ˆåˆ†åˆ«éœ€è¦é…ç½®dockerå’ŒcontainerdæœåŠ¡ï¼‰ï¼š

è¦åœ¨å¼•å¯¼æ—¶ä¸ºå…¶ä»–å‘è¡Œç‰ˆè‡ªåŠ¨å¯åŠ¨ Docker å’Œ Containerdï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ sudo systemctl enable docker.service # è®¾ç½® docker å¼€æœºå¯åŠ¨$ sudo systemctl enable containerd.service # è®¾ç½® containerd å¼€æœºå¯åŠ¨
```

å¦‚æœè¦ç¦æ­¢`docker`ã€`containerd`å¼€å¯å¯åŠ¨ï¼Œå¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤ï¼š

```bash
$ sudo systemctl disable docker.service # ç¦æ­¢ docker å¼€æœºå¯åŠ¨$ sudo systemctl disable containerd.service # ç¦æ­¢ containerd å¼€æœºå¯åŠ¨
```

### å‡†å¤‡ä¸€ä¸ªKubernetesé›†ç¾¤

å®‰è£…å®ŒDockerä¹‹åï¼Œè¿˜éœ€è¦ä¸€ä¸ªKubernetesé›†ç¾¤ï¼Œæ¥è°ƒåº¦Dockerå®¹å™¨ã€‚å®‰è£…Kubernetesé›†ç¾¤æå…¶å¤æ‚ï¼Œè¿™é‡Œé€‰æ‹©ä¸€ç§æœ€ç®€å•çš„æ–¹å¼æ¥å‡†å¤‡ä¸€ä¸ªKubernetesé›†ç¾¤ï¼šè´­ä¹°ä¸€ä¸ªè…¾è®¯äº‘Serverless é›†ç¾¤ã€‚

è…¾è®¯äº‘Serverless é›†ç¾¤æ˜¯è…¾è®¯äº‘å®¹å™¨æœåŠ¡æ¨å‡ºçš„æ— é¡»ç”¨æˆ·è´­ä¹°èŠ‚ç‚¹å³å¯éƒ¨ç½²å·¥ä½œè´Ÿè½½çš„é›†ç¾¤ç±»å‹ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ ‡å‡†çš„Kubernetesé›†ç¾¤ï¼Œä¸åŒçš„æ˜¯Serverlessé›†ç¾¤æ˜¯ç”±è…¾è®¯äº‘å®¹å™¨æœåŠ¡å›¢é˜Ÿåˆ›å»ºå’Œç»´æŠ¤ï¼Œä½ åªéœ€è¦è®¿é—®é›†ç¾¤ï¼Œéƒ¨ç½²ä½ çš„èµ„æºï¼Œå¹¶æŒ‰ç…§å®¹å™¨çœŸå®çš„èµ„æºä½¿ç”¨é‡æ”¯ä»˜è´¹ç”¨å³å¯ã€‚ä½ å¯ä»¥ç™»å½•è…¾è®¯äº‘å®¹å™¨æœåŠ¡æ§åˆ¶å°ï¼ˆhttps://console.cloud.tencent.com/tke2ï¼‰è´­ä¹°Serverlessé›†ç¾¤ã€‚

å¦‚æœä½ æƒ³è‡ªå·±æ­å»ºKubernetesé›†ç¾¤ï¼Œè¿™é‡Œå»ºè®®ä½ è´­ä¹°3å°è…¾è®¯äº‘CVMæœºå™¨ï¼Œå¹¶å‚ç…§[follow-me-install-kubernetes-cluster](https://github.com/opsnull/follow-me-install-kubernetes-cluster)æ•™ç¨‹æ¥ä¸€æ­¥æ­¥æ­å»ºKubernetesé›†ç¾¤ï¼ŒCVMæœºå™¨å»ºè®®çš„æœ€å°é…ç½®å¦‚ä¸‹ï¼š
[![img](https://static001.geekbang.org/resource/image/88/0b/885d2431e7f2d9bcd02b32d33yye930b.jpg?wh=1920x876)](https://static001.geekbang.org/resource/image/88/0b/885d2431e7f2d9bcd02b32d33yye930b.jpg?wh=1920x876)

#### EKSç®€ä»‹

æˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹EKSæ˜¯ä»€ä¹ˆã€‚EKSï¼ˆElastic Kubernetes Serviceï¼‰å³è…¾è®¯äº‘å¼¹æ€§å®¹å™¨æœåŠ¡ï¼Œæ˜¯è…¾è®¯äº‘å®¹å™¨æœåŠ¡æ¨å‡ºçš„æ— é¡»ç”¨æˆ·è´­ä¹°èŠ‚ç‚¹å³å¯éƒ¨ç½²å·¥ä½œè´Ÿè½½çš„æœåŠ¡æ¨¡å¼ã€‚å®ƒå®Œå…¨å…¼å®¹åŸç”Ÿçš„ Kubernetesï¼Œæ”¯æŒä½¿ç”¨åŸç”Ÿæ–¹å¼åˆ›å»ºåŠç®¡ç†èµ„æºï¼ŒæŒ‰ç…§å®¹å™¨çœŸå®çš„èµ„æºä½¿ç”¨é‡è®¡è´¹ã€‚å¼¹æ€§å®¹å™¨æœåŠ¡ EKS è¿˜æ‰©å±•æ”¯æŒè…¾è®¯äº‘çš„å­˜å‚¨åŠç½‘ç»œç­‰äº§å“ï¼ŒåŒæ—¶ç¡®ä¿ç”¨æˆ·å®¹å™¨çš„å®‰å…¨éš”ç¦»ï¼Œå¼€ç®±å³ç”¨ã€‚

#### EKSè´¹ç”¨

é‚£å®ƒæ˜¯å¦‚ä½•æ”¶è´¹å‘¢ï¼ŸEKS æ˜¯å…¨æ‰˜ç®¡çš„Serverless Kubernetes æœåŠ¡ï¼Œä¸ä¼šæ”¶å–æ‰˜ç®¡çš„ Masterã€etcd ç­‰èµ„æºçš„è´¹ç”¨ã€‚å¼¹æ€§é›†ç¾¤å†…è¿è¡Œçš„å·¥ä½œè´Ÿè½½é‡‡ç”¨åä»˜è´¹çš„æŒ‰é‡è®¡è´¹æ¨¡å¼ï¼Œè´¹ç”¨æ ¹æ®å®é™…é…ç½®çš„èµ„æºé‡æŒ‰ä½¿ç”¨æ—¶é—´è®¡ç®—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š**Kubernetesé›†ç¾¤æœ¬èº«æ˜¯å…è´¹çš„ï¼Œåªæœ‰è¿è¡Œå·¥ä½œè´Ÿè½½ï¼Œæ¶ˆè€—èŠ‚ç‚¹èµ„æºæ—¶æ”¶è´¹ã€‚**

EKSæœ‰3ç§è®¡è´¹æ¨¡å¼ï¼šé¢„ç•™åˆ¸ã€æŒ‰é‡è®¡è´¹ã€ç«ä»·æ¨¡å¼ï¼Œè¿™é‡Œæˆ‘å»ºè®®é€‰æ‹©**æŒ‰é‡è®¡è´¹**ã€‚æŒ‰é‡è®¡è´¹ï¼Œæ”¯æŒæŒ‰ç§’è®¡è´¹ï¼ŒæŒ‰å°æ—¶ç»“ç®—ï¼Œéšæ—¶è´­ä¹°éšæ—¶é‡Šæ”¾ï¼Œä»ä¸“æ å­¦ä¹ çš„è§’åº¦æ¥è¯´ï¼Œè´¹ç”¨æ˜¯æœ€ä½çš„ã€‚EKS ä¼šæ ¹æ®å·¥ä½œè´Ÿè½½ç”³è¯·çš„ CPUã€å†…å­˜æ•°å€¼ä»¥åŠå·¥ä½œè´Ÿè½½çš„è¿è¡Œæ—¶é—´æ¥æ ¸ç®—è´¹ç”¨ï¼Œå…·ä½“å®šä»·ï¼Œä½ å¯ä»¥å‚è€ƒï¼š[å®šä»·|å¼¹æ€§å®¹å™¨æœåŠ¡](https://buy.cloud.tencent.com/price/eks)ã€‚

è¿™é‡Œæˆ‘é€šè¿‡ä¾‹å­æ¥è¯´æ˜ä¸€ä¸‹è´¹ç”¨é—®é¢˜ï¼ŒIAMåº”ç”¨ä¼šéƒ¨ç½²4ä¸ªDeploymentï¼Œæ¯ä¸ªDeploymentä¸€ä¸ªå‰¯æœ¬ï¼š

+ iam-apiserverï¼šIAM REST APIæœåŠ¡ï¼Œæä¾›ç”¨æˆ·ã€å¯†é’¥ã€ç­–ç•¥èµ„æºçš„CURDåŠŸèƒ½çš„APIæ¥å£ã€‚
+ iam-authz-serverï¼šIAMèµ„æºæˆæƒæœåŠ¡ï¼Œå¯¹å¤–æä¾›èµ„æºæˆæƒæ¥å£ã€‚
+ iam-pumpï¼šIAMæ•°æ®æ¸…æ´—æœåŠ¡ï¼Œä»Redisä¸­è·å–æˆæƒæ—¥å¿—ï¼Œå¤„ç†åä¿å­˜åœ¨MongoDBä¸­ã€‚
+ iamctlï¼šIAMåº”ç”¨çš„æµ‹è¯•æœåŠ¡ï¼Œç™»é™†iamctl Podå¯ä»¥æ‰§è¡Œiamctlå‘½ä»¤å’Œsmokeæµ‹è¯•è„šæœ¬ï¼Œå®Œæˆå¯¹IAMåº”ç”¨çš„è¿ç»´å’Œæµ‹è¯•ã€‚

ä¸Šè¿°4ä¸ªDeploymentä¸­çš„**Podé…ç½®å‡ä¸º0.25æ ¸ã€512Miå†…å­˜**ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬æ ¹æ®EKSçš„è´¹ç”¨è®¡ç®—å…¬å¼ `è´¹ç”¨ = ç›¸å…³è®¡è´¹é¡¹é…ç½® Ã— èµ„æºå•ä½æ—¶é—´ä»·æ ¼ Ã— è¿è¡Œæ—¶é—´` è®¡ç®—IAMéƒ¨ç½²ä¸€å¤©çš„è´¹ç”¨ï¼š

```
æ€»è´¹ç”¨ = (4 x 1) x (0.25 x 0.12 + 0.5 x 0.05) x 24 = 4.8 å…ƒ
```

ä¹Ÿå°±æ˜¯æŒ‰æœ€ä½é…ç½®éƒ¨ç½²IAMåº”ç”¨ï¼Œè¿è¡Œä¸€å¤©çš„è´¹ç”¨æ˜¯4.8å…ƒï¼ˆä¸€ç“¶æ°´çš„é’±ï¼Œå°±èƒ½å­¦åˆ°å¦‚ä½•å°†IAMåº”ç”¨éƒ¨ç½²åœ¨Kuberneteså¹³å°ä¸Šï¼Œå¾ˆå€¼ï¼ï¼‰ã€‚ä½ å¯èƒ½æƒ³è¿™ä¸ªè®¡ç®—å…¬å¼é‡Œæ¯ä¸ªæ•°å€¼éƒ½ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼Œå…¶ä¸­ï¼š

+ (4 x 1)ï¼šKubernetes Podæ€»ä¸ªæ•°ï¼ˆä¸€å…±æ˜¯4ä¸ªDeploymentï¼Œæ¯ä¸ªPod 1ä¸ªå‰¯æœ¬ï¼‰ã€‚
+ 0.25 x 0.12ï¼šè¿ç»­è¿è¡Œ1å°æ—¶çš„CPUé…ç½®è´¹ç”¨ã€‚
+ 0.5 x 0.05ï¼šè¿ç»­è¿è¡Œ1å°æ—¶çš„å†…å­˜é…ç½®è´¹ç”¨ã€‚
+ 24ï¼š24å°æ—¶ï¼Œä¹Ÿå³ä¸€å¤©ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä¸ºäº†å¸®åŠ©ä½ èŠ‚çœè´¹ç”¨ï¼Œä¸Šè¿°é…ç½®éƒ½æ˜¯æœ€ä½é…ç½®ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®çš„é…ç½®å¦‚ä¸‹ï¼š
[![img](https://static001.geekbang.org/resource/image/1d/35/1d20c7eeb9dba8f53194969b0da5e835.jpg?wh=1920x718)](https://static001.geekbang.org/resource/image/1d/35/1d20c7eeb9dba8f53194969b0da5e835.jpg?wh=1920x718)
å› ä¸ºiam-pumpç»„ä»¶æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå¹¶ä¸”ç›®å‰æ²¡æœ‰å®ç°æŠ¢å æœºåˆ¶ï¼Œæ‰€ä»¥å‰¯æœ¬æ•°éœ€è¦è®¾ç½®ä¸º1ã€‚

å¦å¤–ï¼ŒIntelæŒ‰é‡è®¡è´¹çš„é…ç½®è´¹ç”¨è§ä¸‹å›¾ï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/64/59/64a5f89f4cbea95e50691455a06b1e59.png?wh=1372x226)](https://static001.geekbang.org/resource/image/64/59/64a5f89f4cbea95e50691455a06b1e59.png?wh=1372x226)

åœ¨è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„äº‹æƒ…æé†’ä½ ï¼š**å­¦å®Œæœ¬èŠ‚è¯¾ï¼Œé”€æ¯è¿™äº›Deploymentï¼Œé¿å…è¢«ç»§ç»­æ‰£è´¹ã€‚å»ºè®®è…¾è®¯äº‘è´¦æˆ·ä½™é¢ä¸è¦è¶…è¿‡50å…ƒã€‚**

#### ç”³è¯·EKSé›†ç¾¤

äº†è§£äº†EKSä»¥åŠè´¹ç”¨ç›¸å…³çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ç”³è¯·EKSé›†ç¾¤ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹5æ­¥æ¥ç”³è¯·EKSé›†ç¾¤ã€‚åœ¨æ­£å¼ç”³è¯·å‰ï¼Œè¯·å…ˆç¡®ä¿è…¾è®¯äº‘è´¦æˆ·æœ‰å¤§äº **10 å…ƒ**çš„è´¦æˆ·ä½™é¢ï¼Œå¦åˆ™åœ¨åˆ›å»ºå’Œä½¿ç”¨EKSé›†ç¾¤çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºè´¹ç”¨ä¸è¶³è€ŒæŠ¥é”™ã€‚

1. åˆ›å»ºè…¾è®¯äº‘å¼¹æ€§é›†ç¾¤

å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

é¦–å…ˆï¼Œç™»å½•å®¹å™¨æœåŠ¡æ§åˆ¶å°ï¼Œé€‰æ‹©å·¦ä¾§å¯¼èˆªæ ä¸­çš„ã€[å¼¹æ€§é›†ç¾¤](https://console.cloud.tencent.com/tke2/ecluster)ã€‘ã€‚
ç„¶åï¼Œåœ¨é¡µé¢ä¸Šæ–¹é€‰æ‹©éœ€åˆ›å»ºå¼¹æ€§é›†ç¾¤çš„åœ°åŸŸï¼Œå¹¶å•å‡»ã€æ–°å»ºã€‘ã€‚åœ¨â€œåˆ›å»ºå¼¹æ€§é›†ç¾¤â€é¡µé¢ï¼Œæ ¹æ®ä»¥ä¸‹æç¤ºè®¾ç½®é›†ç¾¤ä¿¡æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/37/8c/3740a98a6140b9c85517bdd27f30268c.png?wh=1920x950)](https://static001.geekbang.org/resource/image/37/8c/3740a98a6140b9c85517bdd27f30268c.png?wh=1920x950)

é¡µé¢ä¸­å„é€‰æ‹©é¡¹çš„æ„æ€ï¼Œæˆ‘æ¥ç»™ä½ è§£é‡Šä¸€ä¸‹ï¼š

+ **é›†ç¾¤åç§°ï¼š**åˆ›å»ºçš„å¼¹æ€§é›†ç¾¤åç§°ï¼Œä¸è¶…è¿‡60ä¸ªå­—ç¬¦ã€‚
+ **Kubernetesç‰ˆæœ¬ï¼š**å¼¹æ€§é›†ç¾¤æ”¯æŒ1.12ä»¥ä¸Šçš„å¤šä¸ª Kubernetes ç‰ˆæœ¬é€‰æ‹©ï¼Œå»ºè®®é€‰æ‹©æœ€æ–°çš„ç‰ˆæœ¬ã€‚
+ **æ‰€åœ¨åœ°åŸŸï¼š**å»ºè®®ä½ æ ¹æ®æ‰€åœ¨åœ°ç†ä½ç½®é€‰æ‹©é è¿‘çš„åœ°åŸŸï¼Œå¯é™ä½è®¿é—®å»¶è¿Ÿï¼Œæé«˜ä¸‹è½½é€Ÿåº¦ã€‚
+ **é›†ç¾¤ç½‘ç»œï¼š**å·²åˆ›å»ºçš„å¼¹æ€§é›†ç¾¤ VPC ç½‘ç»œï¼Œä½ å¯ä»¥é€‰æ‹©ç§æœ‰ç½‘ç»œä¸­çš„å­ç½‘ç”¨äºå¼¹æ€§é›†ç¾¤çš„å®¹å™¨ç½‘ç»œï¼Œè¯¦æƒ…è¯·è§ [ç§æœ‰ç½‘ç»œï¼ˆVPCï¼‰](https://cloud.tencent.com/document/product/215/20046) ã€‚
+ **å®¹å™¨ç½‘ç»œï¼š**ä¸ºé›†ç¾¤å†…å®¹å™¨åˆ†é…åœ¨å®¹å™¨ç½‘ç»œåœ°å€èŒƒå›´å†…çš„ IP åœ°å€ã€‚å¼¹æ€§é›†ç¾¤çš„ Pod ä¼šç›´æ¥å ç”¨ VPC å­ç½‘ IPï¼Œè¯·å°½é‡é€‰æ‹© IP æ•°é‡å……è¶³ä¸”ä¸å…¶ä»–äº§å“ä½¿ç”¨æ— å†²çªçš„å­ç½‘ã€‚
+ **Service CIDRï¼š**é›†ç¾¤çš„ ClusterIP Service é»˜è®¤åˆ†é…åœ¨æ‰€é€‰ VPC å­ç½‘ä¸­ï¼Œè¯·å°½é‡é€‰æ‹© IP æ•°é‡å……è¶³ä¸”ä¸å…¶ä»–äº§å“ä½¿ç”¨æ— å†²çªçš„å­ç½‘ã€‚
+ **é›†ç¾¤æè¿°ï¼š**åˆ›å»ºé›†ç¾¤çš„ç›¸å…³ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨â€œé›†ç¾¤ä¿¡æ¯â€é¡µé¢ã€‚

è®¾ç½®å®Œæˆåï¼Œå•å‡»ã€å®Œæˆã€‘å³å¯å¼€å§‹åˆ›å»ºï¼Œå¯åœ¨â€œå¼¹æ€§é›†ç¾¤â€åˆ—è¡¨é¡µé¢æŸ¥çœ‹é›†ç¾¤çš„åˆ›å»ºè¿›åº¦ã€‚

ç­‰å¾…å¼¹æ€§é›†ç¾¤åˆ›å»ºå®Œæˆï¼Œåˆ›å»ºå®Œæˆåçš„å¼¹æ€§é›†ç¾¤é¡µé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1c/3e/1c533956986531f0245b27864f17dc3e.png?wh=1920x376)](https://static001.geekbang.org/resource/image/1c/3e/1c533956986531f0245b27864f17dc3e.png?wh=1920x376)

æˆ‘ä»¬åˆ›å»ºçš„å¼¹æ€§é›†ç¾¤IDä¸º**cls-dc6sdos4**ã€‚

1. å¼€å¯å¤–ç½‘è®¿é—®

å¦‚æœæƒ³è®¿é—®EKSé›†ç¾¤ï¼Œéœ€è¦å…ˆå¼€å¯EKSçš„å¤–ç½‘è®¿é—®èƒ½åŠ›ï¼Œå¼€å¯æ–¹æ³•å¦‚ä¸‹ï¼š

ç™»å½•å®¹å™¨æœåŠ¡æ§åˆ¶å° -> é€‰æ‹©å·¦ä¾§å¯¼èˆªæ ä¸­çš„ã€[å¼¹æ€§é›†ç¾¤](https://console.cloud.tencent.com/tke2/ecluster)ã€‘ -> è¿›å…¥**cls-dc6sdos4** é›†ç¾¤çš„è¯¦æƒ…é¡µä¸­ -> é€‰æ‹©ã€åŸºæœ¬ä¿¡æ¯ã€‘ -> ç‚¹å‡»ã€å¤–ç½‘è®¿é—®ã€‘æŒ‰é’®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/23/c6/235679797980de87432a0d4b05dd83c6.png?wh=1920x764)](https://static001.geekbang.org/resource/image/23/c6/235679797980de87432a0d4b05dd83c6.png?wh=1920x764)

è¿™é‡Œè¦æ³¨æ„ï¼Œå¼€å¯å¤–ç½‘è®¿é—®æ—¶ï¼Œä¸ºäº†å®‰å…¨ï¼Œéœ€è¦è®¾ç½®å…è®¸è®¿é—®kube-apiserverçš„IPæ®µã€‚ä¸ºäº†é¿å…ä¸å¿…è¦çš„é”™è¯¯ï¼Œå¤–ç½‘è®¿é—®åœ°å€æˆ‘ä»¬è®¾ç½®ä¸º`0.0.0.0/0` ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/ea/21/ea627942e5a432401e5959ee90c06221.png?wh=920x441)](https://static001.geekbang.org/resource/image/ea/21/ea627942e5a432401e5959ee90c06221.png?wh=920x441)

æ³¨æ„ï¼Œåªæœ‰æµ‹è¯•æ—¶æ‰å¯è¿™ä¹ˆè®¾ç½®ä¸º `0.0.0.0/0` ï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®ä¸¥æ ¼é™åˆ¶å¯ä»¥è®¿é—®kube-apiserverçš„æ¥æºIPã€‚

1. å®‰è£…kubectlå‘½ä»¤è¡Œå·¥å…·

å¦‚æœè¦è®¿é—®EKSï¼ˆæ ‡å‡†çš„Kubernetesé›†ç¾¤ï¼‰ï¼Œæ¯”è¾ƒé«˜æ•ˆçš„æ–¹å¼æ˜¯é€šè¿‡Kubernetesæä¾›çš„å‘½ä»¤è¡Œå·¥å…·kubectlæ¥è®¿é—®ã€‚æ‰€ä»¥ï¼Œè¿˜éœ€è¦å®‰è£…kubectlå·¥å…·ã€‚

å®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š

```bash
$ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"$ mkdir -p $HOME/bin$ mv kubectl $HOME/bin$ chmod +x $HOME/bin/kubectl
```

å…·ä½“å¯å‚è€ƒ[å®‰è£…å’Œè®¾ç½® kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/)ã€‚
ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥é…ç½®kubectlçš„bashè‡ªåŠ¨è¡¥å…¨ï¼š

```bash
$ kubectl completion bash > $HOME/.kube-completion.bash$ echo 'source $HOME/.kube-completion.bash' >> ~/.bashrc$ bash
```

1. ä¸‹è½½å¹¶å®‰è£…kubeconfig

å®‰è£…å®Œkubectlå·¥å…·ä¹‹åï¼Œéœ€è¦é…ç½®kubectlæ‰€è¯»å–çš„é…ç½®æ–‡ä»¶ã€‚

è¿™é‡Œæ³¨æ„ï¼Œåœ¨ä¸Šä¸€æ­¥ï¼Œæˆ‘ä»¬å¼€å¯äº†å¤–ç½‘è®¿é—®ï¼Œå¼€å¯åEKSä¼šç”Ÿæˆä¸€ä¸ªkubeconfigé…ç½®ï¼ˆ `kubeconfig` å³ä¸ºkubectlçš„é…ç½®æ–‡ä»¶ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥ä»é¡µé¢ä¸‹è½½å¹¶å®‰è£…ã€‚

åœ¨å¼¹æ€§é›†ç¾¤çš„åŸºæœ¬ä¿¡æ¯é¡µé¢ï¼Œç‚¹å‡»ã€å¤åˆ¶ã€‘æŒ‰é’®ï¼Œå¤åˆ¶kubeconfigæ–‡ä»¶å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/bc/bf/bc314604334dd56b7337a905c9b6bfbf.png?wh=1775x731)](https://static001.geekbang.org/resource/image/bc/bf/bc314604334dd56b7337a905c9b6bfbf.png?wh=1775x731)

å¤åˆ¶åï¼Œå°†ç²˜è´´æ¿çš„å†…å®¹ä¿å­˜åœ¨`$HOME/.kube/config`æ–‡ä»¶ä¸­ã€‚éœ€è¦å…ˆæ‰§è¡Œ`mkdir -p $HOME/.kube`åˆ›å»º`.kube`ç›®å½•ï¼Œå†å°†ç²˜è´´ç‰ˆä¸­çš„å†…å®¹å†™åˆ° `config` æ–‡ä»¶ä¸­ã€‚

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ¥æµ‹è¯•kubectlå·¥å…·æ˜¯å¦æˆåŠŸå®‰è£…å’Œé…ç½®ï¼š

```bash
$ kubectl get nodesNAME                    STATUS   ROLES    AGE    VERSIONeklet-subnet-lowt256k   Ready    <none>   2d1h   v2.5.21
```

å¦‚æœè¾“å‡ºäº†Kubernetesçš„ekletèŠ‚ç‚¹ï¼Œå¹¶ä¸”èŠ‚ç‚¹çŠ¶æ€ä¸º**Ready**ï¼Œè¯´æ˜Kubernetesé›†ç¾¤è¿è¡Œæ­£å¸¸ï¼Œå¹¶ä¸”kubectlå®‰è£…å’Œé…ç½®æ­£ç¡®ã€‚

1. EKSé›†ç¾¤å¼€é€šé›†ç¾¤å†…æœåŠ¡è®¿é—®å¤–ç½‘èƒ½åŠ›

å› ä¸ºIAMåº”ç”¨ä¸­çš„æ•°æ®åº“ï¼šMariaDBã€Redisã€MongoDBå¯èƒ½éœ€è¦é€šè¿‡å¤–ç½‘è®¿é—®ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¼€é€šEKSä¸­Podè®¿é—®å¤–ç½‘çš„èƒ½åŠ›ã€‚

EKSæ”¯æŒé€šè¿‡é…ç½® [NAT ç½‘å…³](https://cloud.tencent.com/document/product/215/4975) å’Œ [è·¯ç”±è¡¨](https://cloud.tencent.com/document/product/215/4954) æ¥å®ç°é›†ç¾¤å†…æœåŠ¡è®¿é—®å¤–ç½‘ã€‚å…·ä½“å¼€å¯æ­¥éª¤ï¼Œéœ€è¦ä½ æŸ¥çœ‹è…¾è®¯äº‘å®˜æ–¹æ–‡æ¡£ï¼š[é€šè¿‡ NAT ç½‘å…³è®¿é—®å¤–ç½‘](https://cloud.tencent.com/document/product/457/48710)ã€‚

åœ¨å¼€é€šè¿‡ç¨‹ä¸­æœ‰ä»¥ä¸‹ä¸¤ç‚¹éœ€è¦ä½ æ³¨æ„ï¼š

+ åœ¨**åˆ›å»ºæŒ‡å‘ NAT ç½‘å…³çš„è·¯ç”±è¡¨**æ­¥éª¤ä¸­ï¼Œç›®çš„ç«¯è¦é€‰æ‹©ï¼š0.0.0.0/0ã€‚
+ åœ¨**å…³è”å­ç½‘è‡³è·¯ç”±è¡¨**æ­¥éª¤ä¸­ï¼Œåªå…³è”åˆ›å»ºEKSé›†ç¾¤æ—¶é€‰æ‹©çš„å­ç½‘ã€‚

å¦‚æœä½ çš„æ•°æ®åº“éœ€è¦é€šè¿‡å¤–ç½‘è®¿é—®ï¼Œè¿™é‡Œä¸€å®šè¦ç¡®ä¿EKSé›†ç¾¤æˆåŠŸå¼€é€šé›†ç¾¤å†…æœåŠ¡è®¿é—®å¤–ç½‘èƒ½åŠ›ï¼Œå¦åˆ™éƒ¨ç½²IAMåº”ç”¨æ—¶ä¼šå› ä¸ºè®¿é—®ä¸äº†æ•°æ®åº“è€Œå¤±è´¥ã€‚

## å®‰è£…IAMåº”ç”¨

ä¸Šé¢ï¼Œæˆ‘ä»¬å¼€é€šäº†é•œåƒä»“åº“ã€å®‰è£…äº†Dockerå¼•æ“ã€å®‰è£…å’Œé…ç½®äº†Kubernetesé›†ç¾¤ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹å¦‚ä½•å°†IAMåº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚

å‡è®¾IAMé¡¹ç›®ä»“åº“æ ¹ç›®å½•è·¯å¾„ä¸º `$IAM_ROOT`ï¼Œå…·ä½“å®‰è£…æ­¥éª¤å¦‚ä¸‹ï¼š

1. é…ç½®`scripts/install/environment.sh`

`scripts/install/environment.sh`æ–‡ä»¶ä¸­åŒ…å«äº†å„ç±»è‡ªå®šä¹‰é…ç½®ã€‚ä½ å¯èƒ½éœ€è¦é…ç½®è·Ÿæ•°æ®åº“ç›¸å…³çš„é…ç½®ï¼ˆå½“ç„¶ï¼Œä¹Ÿå¯ä»¥éƒ½ä½¿ç”¨é»˜è®¤å€¼ï¼‰ï¼š

+ MariaDBé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`MARIADB_`å¼€å¤´çš„å˜é‡ã€‚
+ Redisé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`REDIS_`å¼€å¤´çš„å˜é‡ã€‚
+ MongoDBé…ç½®ï¼šenvironment.shæ–‡ä»¶ä¸­ä»¥`MONGO_`å¼€å¤´çš„å˜é‡ã€‚

å…¶ä»–é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼ã€‚

1. åˆ›å»ºIAMåº”ç”¨çš„é…ç½®æ–‡ä»¶

```bash
$ cd $$ make gen.defaultconfigs # ç”Ÿæˆiam-apiserverã€iam-authz-serverã€iam-pumpã€iamctlç»„ä»¶çš„é»˜è®¤é…ç½®æ–‡ä»¶$ make gen.ca # ç”Ÿæˆ CA è¯ä¹¦
```

ä¸Šè¿°å‘½ä»¤ä¼šå°†IAMçš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨è¿™ä¸ª`$/_output/configs/`ç›®å½•ä¸‹ã€‚

1. åˆ›å»ºIAMå‘½åç©ºé—´

æˆ‘ä»¬å°†IAMåº”ç”¨æ¶‰åŠåˆ°çš„å„ç±»èµ„æºï¼Œéƒ½åˆ›å»ºåœ¨`iam`å‘½åç©ºé—´ä¸­ã€‚å°†IAMèµ„æºåˆ›å»ºåœ¨ç‹¬ç«‹çš„å‘½åç©ºé—´ä¸­ï¼Œä¸ä»…æ–¹ä¾¿ç»´æŠ¤ï¼Œè¿˜å¯ä»¥æœ‰æ•ˆé¿å…å½±å“å…¶ä»–Kubernetesèµ„æºã€‚

```bash
$ kubectl create namespace iam
```

1. å°†IAMå„æœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ConfigMapèµ„æºçš„å½¢å¼ä¿å­˜åœ¨Kubernetesé›†ç¾¤ä¸­

```bash
$ kubectl -n iam create configmap iam --from-file=$/_output/configs/$ kubectl -n iam get configmap iamNAME   DATA   AGEiam    4      13s
```

æ‰§è¡Œ`kubectl -n iam get configmap iam`å‘½ä»¤ï¼Œå¯ä»¥æˆåŠŸè·å–åˆ›å»ºçš„`iam` configmapã€‚

å¦‚æœä½ è§‰å¾—æ¯æ¬¡æ‰§è¡Œ`kubectl`å‘½ä»¤éƒ½è¦æŒ‡å®š`-n iam`é€‰é¡¹å¾ˆç¹çï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œå°†`kubectl`ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­çš„å‘½åç©ºé—´æŒ‡å®šä¸º`iam`ã€‚è®¾ç½®åï¼Œæ‰§è¡Œ`kubectl`å‘½ä»¤ï¼Œé»˜è®¤åœ¨`iam`å‘½åç©ºé—´ä¸‹æ‰§è¡Œï¼š

```bash
$ kubectl config set-context kubectl config current-context --namespace=iam
```

1. å°†IAMå„æœåŠ¡ä½¿ç”¨çš„è¯ä¹¦æ–‡ä»¶ï¼Œä»¥ConfigMapèµ„æºçš„å½¢å¼åˆ›å»ºåœ¨Kubernetesé›†ç¾¤ä¸­

```bash
$ kubectl -n iam create configmap iam-cert --from-file=$/_output/cert$ kubectl -n iam get configmap iam-certNAME       DATA   AGEiam-cert   14     12s
```

æ‰§è¡Œ`kubectl -n iam get configmap iam-cert`å‘½ä»¤ï¼Œå¯ä»¥æˆåŠŸè·å–åˆ›å»ºçš„`iam-cert` configmapã€‚

1. åˆ›å»ºé•œåƒä»“åº“è®¿é—®å¯†é’¥

åœ¨å‡†å¤‡é˜¶æ®µï¼Œæˆ‘ä»¬å¼€é€šäº†è…¾è®¯äº‘é•œåƒä»“åº“æœåŠ¡ï¼ˆè®¿é—®åœ°å€ä¸ºccr.ccs.tencentyun.comï¼‰ï¼Œå¹¶åˆ›å»ºäº†ç”¨æˆ·`10000099xxxx`ï¼Œå…¶å¯†ç ä¸º`iam59!z$`ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºdocker-registry secretã€‚Kubernetesåœ¨ä¸‹è½½Dockeré•œåƒæ—¶ï¼Œéœ€è¦docker-registry secretæ¥è¿›è¡Œè®¤è¯ã€‚åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ kubectl -n iam create secret docker-registry ccr-registry --docker-server=ccr.ccs.tencentyun.com --docker-username=10000099xxxx --docker-password='iam59!z$'
```

1. åˆ›å»ºDockeré•œåƒï¼Œå¹¶Pushåˆ°é•œåƒä»“åº“

å°†é•œåƒPushåˆ°CCRé•œåƒä»“åº“ï¼Œéœ€è¦ç¡®ä¿ä½ å·²ç»ç™»å½•åˆ°è…¾è®¯äº‘CCRé•œåƒä»“åº“ï¼Œå¦‚æœæ²¡ç™»å½•ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç™»å½•ï¼š

```bash
$ docker login --username=[username] ccr.ccs.tencentyun.com
```

æ‰§è¡Œ `make push` å‘½ä»¤æ„å»ºé•œåƒï¼Œå¹¶å°†é•œåƒPushåˆ°CCRé•œåƒä»“åº“ï¼š

```bash
$ make push REGISTRY_PREFIX=ccr.ccs.tencentyun.com/marmotedu VERSION=v1.1.0
```

ä¸Šè¿°å‘½ä»¤ï¼Œä¼šæ„å»ºiam-apiserver-amd64ã€iam-authz-server-amd64ã€iam-pump-amd64ã€iamctl-amd64 å››ä¸ªé•œåƒï¼Œå¹¶å°†è¿™äº›é•œåƒPushåˆ°è…¾è®¯äº‘é•œåƒä»“åº“çš„`marmotedu`å‘½åç©ºé—´ä¸‹ã€‚

æ„å»ºçš„é•œåƒå¦‚ä¸‹ï¼š

```bash
$ docker images|grep marmoteduccr.ccs.tencentyun.com/marmotedu/iam-pump-amd64           v1.1.0   e078d340e3fb        10 seconds ago      244MBccr.ccs.tencentyun.com/marmotedu/iam-apiserver-amd64      v1.1.0   5e90b67cc949        2 minutes ago       239MBccr.ccs.tencentyun.com/marmotedu/iam-authz-server-amd64   v1.1.0   6796b02be68c        2 minutes ago       238MBccr.ccs.tencentyun.com/marmotedu/iamctl-amd64             v1.1.0   320a77d525e3        2 minutes ago       235MB
```

1. ä¿®æ”¹ `$/deployments/iam.yaml` é…ç½®

è¿™é‡Œè¯·ä½ æ³¨æ„ï¼Œå¦‚æœåœ¨ä¸Šä¸€ä¸ªæ­¥éª¤ä¸­ï¼Œä½ æ„å»ºçš„é•œåƒtagä¸æ˜¯ `v1.1.0` ï¼Œé‚£ä¹ˆä½ éœ€è¦ä¿®æ”¹ `$/deployments/iam.yaml` æ–‡ä»¶ï¼Œå¹¶å°†iam-apiserver-amd64ã€ iam-authz-server-amd64ã€ iam-pump-amd64ã€iamctl-amd64 é•œåƒçš„tagä¿®æ”¹æˆä½ æ„å»ºé•œåƒæ—¶æŒ‡å®šçš„tagã€‚

1. éƒ¨ç½²IAMåº”ç”¨

```bash
$ kubectl -n iam apply -f $/deployments/iam.yaml
```

æ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œä¼šåœ¨`iam`å‘½ä»¤ç©ºé—´ä¸‹ï¼Œåˆ›å»ºä¸€ç³»åˆ—Kubernetesèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œæ¥è·å–è¿™äº›èµ„æºçš„çŠ¶æ€ï¼š

```bash
$ kubectl -n iam get allNAME                                    READY   STATUS    RESTARTS   AGEpod/iam-apiserver-d8dc48596-wkhpl       1/1     Running   0          94mpod/iam-authz-server-6bc899c747-fbpbk   1/1     Running   0          94mpod/iam-pump-7dcbfd4f59-2w9vk           1/1     Running   0          94mpod/iamctl-6fc46b8ccb-gs62l             1/1     Running   1          98mNAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGEservice/iam-apiserver      ClusterIP   192.168.0.174   <none>        8443/TCP,8080/TCP,8081/TCP   101mservice/iam-authz-server   ClusterIP   192.168.0.76    <none>        9443/TCP,9090/TCP            101mservice/iam-pump           ClusterIP   192.168.0.155   <none>        7070/TCP                     101mNAME                               READY   UP-TO-DATE   AVAILABLE   AGEdeployment.apps/iam-apiserver      1/1     1            1           101mdeployment.apps/iam-authz-server   1/1     1            1           101mdeployment.apps/iam-pump           1/1     1            1           101mdeployment.apps/iamctl             1/1     1            1           101mNAME                                          DESIRED   CURRENT   READY   AGEreplicaset.apps/iam-apiserver-d8dc48596       1         1         1       101mreplicaset.apps/iam-authz-server-6bc899c747   1         1         1       101mreplicaset.apps/iam-pump-7dcbfd4f59           1         1         1       101mreplicaset.apps/iamctl-6fc46b8ccb             1         1         1       101m
```

æˆ‘ä»¬çœ‹åˆ°`pod/iam-apiserver-d8dc48596-wkhpl`ã€`pod/iam-authz-server-6bc899c747-fbpbk`ã€`pod/iam-pump-7dcbfd4f59-2w9vk`ã€`pod/iamctl-6fc46b8ccb-gs62l` 4ä¸ªPodéƒ½å¤„åœ¨`Running`çŠ¶æ€ï¼Œè¯´æ˜æœåŠ¡éƒ½æˆåŠŸå¯åŠ¨ã€‚

## æµ‹è¯•IAMåº”ç”¨

æˆ‘ä»¬åœ¨`iam`å‘½ä»¤ç©ºé—´ä¸‹åˆ›å»ºäº†ä¸€ä¸ªæµ‹è¯•Deployment `iamctl`ã€‚ä½ å¯ä»¥ç™»é™†`iamctl` Deploymentæ‰€åˆ›å»ºå‡ºæ¥çš„Podï¼Œæ‰§è¡Œä¸€äº›è¿ç»´æ“ä½œå’Œå†’çƒŸæµ‹è¯•ã€‚ç™»é™†å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ kubectl -n iam exec -it kubectl -n iam get pods -l app=iamctl | awk '/iamctl/{print $1}' -- bash
```

ç™»é™†åˆ°`iamctl-xxxxxxxxxx-xxxxx` Podä¸­åï¼Œå°±å¯ä»¥æ‰§è¡Œè¿ç»´æ“ä½œå’Œå†’çƒŸæµ‹è¯•äº†ã€‚

1. è¿ç»´æ“ä½œ

åœ¨iamctlå®¹å™¨ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨iamctlå·¥å…·æä¾›çš„å„ç±»åŠŸèƒ½ï¼Œiamctlä»¥å­å‘½ä»¤çš„æ–¹å¼å¯¹å¤–æä¾›åŠŸèƒ½ã€‚å‘½ä»¤æ‰§è¡Œæ•ˆæœè§ä¸‹å›¾ï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/44/7e/4460dfd5cd7f7fae5cbb0c64e605367e.png?wh=1920x433)](https://static001.geekbang.org/resource/image/44/7e/4460dfd5cd7f7fae5cbb0c64e605367e.png?wh=1920x433)

1. å†’çƒŸæµ‹è¯•

```bash
# cd /opt/iam/scripts/install# ./test.sh iam::test::smoke
```

å¦‚æœ`./test.sh iam::test::smoke`å‘½ä»¤ï¼Œæ‰“å°çš„è¾“å‡ºä¸­ï¼Œæœ€åä¸€è¡Œä¸º`congratulations, smoke test passed!`å­—ç¬¦ä¸²ï¼Œè¯´æ˜IAMåº”ç”¨å®‰è£…æˆåŠŸã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b9/2e/b9688e6b0609571a06401da412b63d2e.png?wh=1920x603)](https://static001.geekbang.org/resource/image/b9/2e/b9688e6b0609571a06401da412b63d2e.png?wh=1920x603)

## é”€æ¯Serverlessé›†ç¾¤åŠå…¶èµ„æº

å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œä½ å·²ç»æˆåŠŸåœ¨Serverlessé›†ç¾¤ä¸­éƒ¨ç½²äº†IAMåº”ç”¨ï¼ŒServerlessçš„ä½¿å‘½ä¹Ÿå°±å®Œæˆäº†ã€‚æ¥ä¸‹æ¥ï¼Œä¸ºé¿å…è´¦æˆ·è¢«æŒç»­æ‰£è´¹ï¼Œéœ€è¦åˆ é™¤Serverlesså†…çš„èµ„æºå’Œé›†ç¾¤ã€‚

1. åˆ é™¤Serverlesså†…åˆ›å»ºçš„IAMèµ„æº

```bash
$ kubectl delete namespace iam
```

å› ä¸ºåˆ é™¤Namespaceä¼šåˆ é™¤Namespaceä¸‹çš„æ‰€æœ‰èµ„æºï¼Œæ‰€ä»¥ä¸Šè¿°å‘½ä»¤æ‰§è¡Œæ—¶é—´ä¼šä¹…ç‚¹ã€‚

1. åˆ é™¤Serverlessé›†ç¾¤

ç™»å½•è…¾è®¯äº‘å®¹å™¨æœåŠ¡æ§åˆ¶å°ï¼Œé€‰æ‹©æ‰€åˆ›å»ºçš„Serverlessé›†ç¾¤ï¼Œåˆ é™¤å³å¯ã€‚

## æ€»ç»“

äº‘åŸç”Ÿæ¶æ„è®¾è®¡ä¸­ï¼Œéœ€è¦å°†IAMåº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ã€‚æ‰€ä»¥ï¼Œé¦–å…ˆéœ€è¦ä½ å‡†å¤‡ä¸€ä¸ªKubernetesé›†ç¾¤ã€‚ä½ å¯ä»¥è‡ªå·±è´­ä¹°è…¾è®¯äº‘CVMæœºå™¨æ­å»ºKubernetesé›†ç¾¤ï¼Œä½†è¿™ç§æ–¹å¼è´¹ç”¨é«˜ã€æ“ä½œå¤æ‚ã€‚æ‰€ä»¥ï¼Œæˆ‘å»ºè®®ä½ ç›´æ¥ç”³è¯·ä¸€ä¸ªServerlessé›†ç¾¤æ¥éƒ¨ç½²IAMåº”ç”¨ã€‚

Serverlessé›†ç¾¤æ˜¯ä¸€ä¸ªæ ‡å‡†çš„Kubernetesé›†ç¾¤ï¼Œå¯ä»¥å¿«é€Ÿç”³è¯·ï¼Œå¹¶å…è¿ç»´ã€‚Serverlessé›†ç¾¤åªæ”¶å–å®é™…çš„èµ„æºä½¿ç”¨è´¹ç”¨ã€‚åœ¨ä¸“æ å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ¨ç½²IAMåº”ç”¨æœŸé—´äº§ç”Ÿçš„èµ„æºä½¿ç”¨è´¹ç”¨å…¶å®æ˜¯å¾ˆä½çš„ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨è¿™ç§æ–¹å¼æ¥éƒ¨ç½²IAMåº”ç”¨ã€‚

æœ‰äº†Kubernetesé›†ç¾¤ï¼Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½²æ•´ä¸ªIAMåº”ç”¨ï¼š

```bash
$ kubectl -n iam apply -f $/deployments/iam.yaml
```

åº”ç”¨éƒ¨ç½²èµ·æ¥ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç™»é™†åˆ° `iamctl-xxxxxxxxxx-xxxxx`Podï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æµ‹è¯•æ•´ä¸ªIAMåº”ç”¨æ˜¯å¦è¢«æˆåŠŸéƒ¨ç½²ï¼š

```bash
# cd /opt/iam/scripts/install# ./test.sh iam::test::smoke
```

## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸‹ï¼Œå¦‚ä½•å°†MariaDBã€MongoDBã€Rediså®ç°å®¹å™¨åŒ–ï¼Ÿ
2. æ€è€ƒä¸‹ï¼Œå¦‚ä½•æ›´ç›¸ä¿¡IAMåº”ç”¨ä¸­çš„iam-apiserveræœåŠ¡ï¼Œè¯•ç€æ›´æ–°è¿™ä¸ªæœåŠ¡ã€‚



## END é“¾æ¥
<ul><li><div><a href = '39.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '41.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

