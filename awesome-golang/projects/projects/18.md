+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬18èŠ‚ IAM é¡¹ç›®è®¤è¯

<br>
<div><a href = '17.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '19.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]



## å¦‚ä½•è®¾è®¡IAMé¡¹ç›®çš„è®¤è¯åŠŸèƒ½ï¼Ÿ

åœ¨è®¤è¯åŠŸèƒ½å¼€å‘ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æ ¹æ®éœ€æ±‚ï¼Œè®¤çœŸè€ƒè™‘ä¸‹å¦‚ä½•è®¾è®¡è®¤è¯åŠŸèƒ½ï¼Œå¹¶åœ¨è®¾è®¡é˜¶æ®µé€šè¿‡æŠ€æœ¯è¯„å®¡ã€‚é‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œå¦‚ä½•è®¾è®¡IAMé¡¹ç›®çš„è®¤è¯åŠŸèƒ½ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬è¦**æ¢³ç†æ¸…æ¥šè®¤è¯åŠŸèƒ½çš„ä½¿ç”¨åœºæ™¯å’Œéœ€æ±‚**ã€‚

+ IAMé¡¹ç›®çš„`iam-apiserver`æœåŠ¡ï¼Œæä¾›äº†IAMç³»ç»Ÿçš„ç®¡ç†æµåŠŸèƒ½æ¥å£ï¼Œå®ƒçš„å®¢æˆ·ç«¯å¯ä»¥æ˜¯å‰ç«¯ï¼ˆè¿™é‡Œä¹Ÿå«æ§åˆ¶å°ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯Appç«¯ã€‚
+ ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·åœ¨Linuxç³»ç»Ÿä¸‹è°ƒç”¨ï¼ŒIAMé¡¹ç›®è¿˜æä¾›äº†iamctlå‘½ä»¤è¡Œå·¥å…·ã€‚
+ ä¸ºäº†æ”¯æŒåœ¨ç¬¬ä¸‰æ–¹ä»£ç ä¸­è°ƒç”¨`iam-apiserver`æä¾›çš„APIæ¥å£ï¼Œè¿˜æ”¯æŒäº†APIè°ƒç”¨ã€‚
+ **ä¸ºäº†æé«˜ç”¨æˆ·åœ¨ä»£ç ä¸­è°ƒç”¨APIæ¥å£çš„æ•ˆç‡ï¼ŒIAMé¡¹ç›®æä¾›äº†Go SDKã€‚**

å¯ä»¥çœ‹åˆ°ï¼Œ`iam-apiserver`æœ‰å¾ˆå¤šå®¢æˆ·ç«¯ï¼Œæ¯ç§å®¢æˆ·ç«¯é€‚ç”¨çš„è®¤è¯æ–¹å¼æ˜¯æœ‰åŒºåˆ«çš„ã€‚

æ§åˆ¶å°ã€Appç«¯éœ€è¦ç™»å½•ç³»ç»Ÿï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨`ç”¨æˆ·åï¼šå¯†ç `è¿™ç§è®¤è¯æ–¹å¼ï¼Œä¹Ÿå³Basicè®¤è¯ã€‚iamctlã€APIè°ƒç”¨ã€Go SDKå› ä¸ºå¯ä»¥ä¸ç”¨ç™»å½•ç³»ç»Ÿï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨æ›´å®‰å…¨çš„è®¤è¯æ–¹å¼ï¼šBearerè®¤è¯ã€‚åŒæ—¶ï¼ŒBasicè®¤è¯ä½œä¸ºiam-apiserverå·²ç»é›†æˆçš„è®¤è¯æ–¹å¼ï¼Œä»ç„¶å¯ä»¥ä¾›iamctlã€APIè°ƒç”¨ã€Go SDKä½¿ç”¨ã€‚

> **è¿™é‡Œè§£é‡Šä¸€ä¸‹ SDKï¼š**
>
> SDK å¯ååŠ©è½¯ä»¶å¼€å‘äººå‘˜é¢å‘ç‰¹å®šçš„å¹³å°ã€ç³»ç»Ÿæˆ–ç¼–ç¨‹è¯­è¨€åˆ›å»ºåº”ç”¨ã€‚å®ƒå°±åƒæ˜¯æ‚¨è´­ä¹°æ¢³å¦†å°æ—¶éšæ¿æä¸€åŒæä¾›çš„å·¥å…·åŒ…ï¼Œè®©æ‚¨èƒ½å¤Ÿè‡ªè¡Œç»„è£…ï¼Œåªæ˜¯å¯¹è±¡æ˜¯åº”ç”¨å¼€å‘è€Œå·²ã€‚æ‚¨æ‰€éœ€çš„æ„å»ºå—æˆ–å¼€å‘å·¥å…·å®ƒéƒ½æœ‰ï¼Œè€Œå…·ä½“æ‰€å«çš„å†…å®¹åˆ™å› åˆ¶é€ å•†è€Œå¼‚ã€‚ 
>
> ä¸€ä¸ªåŸºæœ¬çš„ SDK é€šå¸¸ç”±ç¼–è¯‘å™¨ã€è°ƒè¯•å™¨å’Œ[åº”ç”¨ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰](https://www.redhat.com/zh/topics/api/what-are-application-programming-interfaces)ç»„æˆï¼Œä½†ä¹Ÿå¯èƒ½åŒ…å«ä»¥ä¸‹ä»»æ„å†…å®¹ï¼š
>
> + æ–‡æ¡£
> + åº“
> + ç¼–è¾‘å™¨
> + è¿è¡Œæ—¶/[å¼€å‘ç¯å¢ƒ](https://www.redhat.com/zh/topics/middleware/what-is-ide)
> + æµ‹è¯•/åˆ†æå·¥å…·
> + é©±åŠ¨ç¨‹åº
> + ç½‘ç»œåè®®

è¿™é‡Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼šå¦‚æœ`iam-apiserver`é‡‡ç”¨`Bearer Token`çš„è®¤è¯æ–¹å¼ï¼Œç›®å‰æœ€å—æ¬¢è¿çš„Tokenæ ¼å¼æ˜¯ `JWT Token`ã€‚è€ŒJWT Tokenéœ€è¦å¯†é’¥ï¼ˆåé¢ç»Ÿä¸€ç”¨`secretKey`æ¥æŒ‡ä»£ï¼‰ï¼Œå› æ­¤éœ€è¦åœ¨iam-apiserveræœåŠ¡ä¸­ä¸ºæ¯ä¸ªç”¨æˆ·ç»´æŠ¤ä¸€ä¸ªå¯†é’¥ï¼Œè¿™æ ·ä¼šå¢åŠ å¼€å‘å’Œç»´æŠ¤æˆæœ¬ã€‚

ä¸šç•Œæœ‰ä¸€ä¸ªæ›´å¥½çš„å®ç°æ–¹å¼ï¼šå°†iam-apiserveræä¾›çš„APIæ¥å£æ³¨å†Œåˆ°APIç½‘å…³ä¸­ï¼Œé€šè¿‡APIç½‘å…³ä¸­çš„Tokenè®¤è¯åŠŸèƒ½ï¼Œæ¥å®ç°å¯¹iam-apiserver APIæ¥å£çš„è®¤è¯ã€‚æœ‰å¾ˆå¤šAPIç½‘å…³å¯ä¾›é€‰æ‹©ï¼Œä¾‹å¦‚è…¾è®¯äº‘APIç½‘å…³ã€Tykã€Kongç­‰ã€‚

è¿™é‡Œéœ€è¦ä½ æ³¨æ„ï¼šé€šè¿‡iam-apiserveråˆ›å»ºçš„å¯†é’¥å¯¹æ˜¯æä¾›ç»™`iam-authz-server`ä½¿ç”¨çš„ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒç”¨`iam-authz-server`æä¾›çš„RESTful APIæ¥å£ï¼š`/v1/authz`ï¼Œæ¥è¿›è¡Œèµ„æºæˆæƒã€‚APIè°ƒç”¨æ¯”è¾ƒé€‚åˆé‡‡ç”¨çš„è®¤è¯æ–¹å¼æ˜¯`Bearer`è®¤è¯ã€‚

å½“ç„¶ï¼Œ`/v1/authz`ä¹Ÿå¯ä»¥ç›´æ¥æ³¨å†Œåˆ°APIç½‘å…³ä¸­ã€‚åœ¨å®é™…çš„Goé¡¹ç›®å¼€å‘ä¸­ï¼Œä¹Ÿæ˜¯æˆ‘æ¨èçš„ä¸€ç§æ–¹å¼ã€‚ä½†åœ¨è¿™é‡Œï¼Œä¸ºäº†å±•ç¤ºå®ç°Bearerè®¤è¯çš„è¿‡ç¨‹ï¼Œ`iam-authz-server`è‡ªå·±å®ç°äº†Bearerè®¤è¯ã€‚è®²åˆ°iam-authz-server Bearerè®¤è¯å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ã€‚

**Basicè®¤è¯éœ€è¦ç”¨æˆ·åå’Œå¯†ç ï¼ŒBearerè®¤è¯åˆ™éœ€è¦å¯†é’¥**ï¼Œæ‰€ä»¥iam-apiserveréœ€è¦å°†ç”¨æˆ·å/å¯†ç ã€å¯†é’¥ç­‰ä¿¡æ¯ä¿å­˜åœ¨åç«¯çš„MySQLä¸­ï¼ŒæŒä¹…å­˜å‚¨èµ·æ¥ã€‚

åœ¨è¿›è¡Œè®¤è¯çš„æ—¶å€™ï¼Œéœ€è¦è·å–å¯†ç æˆ–å¯†é’¥è¿›è¡ŒååŠ å¯†ï¼Œè¿™å°±éœ€è¦æŸ¥è¯¢å¯†ç æˆ–å¯†é’¥ã€‚æŸ¥è¯¢å¯†ç æˆ–å¯†é’¥æœ‰ä¸¤ç§æ–¹å¼ã€‚

+ ä¸€ç§æ˜¯åœ¨è¯·æ±‚åˆ°è¾¾æ—¶æŸ¥è¯¢æ•°æ®åº“ã€‚å› ä¸ºæ•°æ®åº“çš„æŸ¥è¯¢æ“ä½œå»¶æ—¶é«˜ï¼Œä¼šå¯¼è‡´APIæ¥å£å»¶æ—¶è¾ƒé«˜ï¼Œæ‰€ä»¥ä¸å¤ªé€‚åˆç”¨åœ¨æ•°æ®æµç»„ä»¶ä¸­ã€‚
+ å¦å¤–ä¸€ç§æ˜¯å°†å¯†ç æˆ–å¯†é’¥ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œè¿™æ ·è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­æŸ¥è¯¢ï¼Œä»è€Œæå‡æŸ¥è¯¢é€Ÿåº¦ï¼Œæé«˜æ¥å£æ€§èƒ½ã€‚

ä½†æ˜¯ï¼Œå°†å¯†ç æˆ–å¯†é’¥ç¼“å­˜åœ¨å†…å­˜ä¸­æ—¶ï¼Œå°±è¦è€ƒè™‘å†…å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™ä¼šå¢åŠ ä»£ç å®ç°çš„å¤æ‚åº¦ã€‚å› ä¸ºç®¡æ§æµç»„ä»¶å¯¹æ€§èƒ½å»¶æ—¶è¦æ±‚ä¸é‚£ä¹ˆæ•æ„Ÿï¼Œè€Œæ•°æ®æµç»„ä»¶åˆ™ä¸€å®šè¦å®ç°éå¸¸é«˜çš„æ¥å£æ€§èƒ½ï¼Œæ‰€ä»¥`iam-apiserver`åœ¨è¯·æ±‚åˆ°æ¥æ—¶æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œ`iam-authz-server`åˆ™å°†å¯†é’¥ä¿¡æ¯ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚

é‚£åœ¨è¿™é‡Œï¼Œå¯ä»¥æ€»ç»“å‡ºä¸€å¼ IAMé¡¹ç›®çš„è®¤è¯è®¾è®¡å›¾ï¼š

![img](http://sm.nsddd.top/sm202302231537306.jpeg)

å¦å¤–ï¼Œä¸ºäº†å°†æ§åˆ¶æµå’Œæ•°æ®æµåŒºåˆ†å¼€æ¥ï¼Œå¯†é’¥çš„CURDæ“ä½œä¹Ÿæ”¾åœ¨äº†iam-apiserverä¸­ï¼Œä½†æ˜¯iam-authz-serveréœ€è¦ç”¨åˆ°è¿™äº›å¯†é’¥ä¿¡æ¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç›®å‰çš„åšæ³•æ˜¯ï¼š

+ iam-authz-serveré€šè¿‡gRPC APIè¯·æ±‚iam-apiserverï¼Œè·å–æ‰€æœ‰çš„å¯†é’¥ä¿¡æ¯ï¼›
+ å½“iam-apiserveræœ‰å¯†é’¥æ›´æ–°æ—¶ï¼Œä¼šPubä¸€æ¡æ¶ˆæ¯åˆ°Redis Channelä¸­ã€‚å› ä¸ºiam-authz-serverè®¢é˜…äº†åŒä¸€ä¸ªRedis Channelï¼Œiam-authz-searverç›‘å¬åˆ°channelæœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œä¼šè·å–ã€è§£ææ¶ˆæ¯ï¼Œå¹¶æ›´æ–°å®ƒç¼“å­˜çš„å¯†é’¥ä¿¡æ¯ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®ä¿iam-authz-serverå†…å­˜ä¸­ç¼“å­˜çš„å¯†é’¥å’Œiam-apiserverä¸­çš„å¯†é’¥ä¿æŒä¸€è‡´ã€‚

å­¦åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šé—®ï¼šå°†æ‰€æœ‰å¯†é’¥éƒ½ç¼“å­˜åœ¨iam-authz-serverä¸­ï¼Œé‚£å²‚ä¸æ˜¯è¦å ç”¨å¾ˆå¤§çš„å†…å­˜ï¼Ÿåˆ«æ‹…å¿ƒï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä¹Ÿæƒ³è¿‡ï¼Œå¹¶ä¸”æ›¿ä½ è®¡ç®—å¥½äº†ï¼š8Gçš„å†…å­˜å¤§æ¦‚èƒ½ä¿å­˜çº¦8åƒä¸‡ä¸ªå¯†é’¥ä¿¡æ¯ï¼Œå®Œå…¨å¤Ÿç”¨ã€‚åæœŸä¸å¤Ÿç”¨çš„è¯ï¼Œå¯ä»¥åŠ å¤§å†…å­˜ã€‚

ä¸è¿‡è¿™é‡Œè¿˜æ˜¯æœ‰ä¸ªå°ç¼ºé™·ï¼šå¦‚æœRedis downæ‰ï¼Œæˆ–è€…å‡ºç°ç½‘ç»œæŠ–åŠ¨ï¼Œå¯èƒ½ä¼šé€ æˆiam-apiserverä¸­å’Œiam-authz-serverå†…å­˜ä¸­ä¿å­˜çš„å¯†é’¥æ•°æ®ä¸ä¸€è‡´ï¼Œä½†è¿™ä¸å¦¨ç¢æˆ‘ä»¬å­¦ä¹ è®¤è¯åŠŸèƒ½çš„è®¾è®¡å’Œå®ç°ã€‚è‡³äºå¦‚ä½•ä¿è¯ç¼“å­˜ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ï¼Œæˆ‘ä¼šåœ¨æ–°ä¸€æœŸçš„ç‰¹åˆ«æ”¾é€é‡Œä¸“é—¨ä»‹ç»ä¸‹ã€‚

æœ€åæ³¨æ„ä¸€ç‚¹ï¼šBasic è®¤è¯è¯·æ±‚å’Œ Bearer è®¤è¯è¯·æ±‚éƒ½å¯èƒ½è¢«æˆªè·å¹¶é‡æ”¾ã€‚æ‰€ä»¥ï¼Œä¸ºäº†ç¡®ä¿Basicè®¤è¯å’ŒBearerè®¤è¯çš„å®‰å…¨æ€§ï¼Œ**å’ŒæœåŠ¡ç«¯é€šä¿¡æ—¶éƒ½éœ€è¦é…åˆä½¿ç”¨HTTPSåè®®**ã€‚



## IAMé¡¹ç›®æ˜¯å¦‚ä½•å®ç°Basicè®¤è¯çš„ï¼Ÿ

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒIAMé¡¹ç›®ä¸­ä¸»è¦ç”¨äº†Basic å’Œ Bearer è¿™ä¸¤ç§è®¤è¯æ–¹å¼ã€‚æˆ‘ä»¬è¦æ”¯æŒBasicè®¤è¯å’ŒBearerè®¤è¯ï¼Œå¹¶æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œè¿™å¾ˆå®¹æ˜“è®©æˆ‘ä»¬æƒ³åˆ°ä½¿ç”¨è®¾è®¡æ¨¡å¼ä¸­çš„ç­–ç•¥æ¨¡å¼æ¥å®ç°ã€‚æ‰€ä»¥ï¼Œåœ¨IAMé¡¹ç›®ä¸­ï¼Œæˆ‘å°†æ¯ä¸€ç§è®¤è¯æ–¹å¼éƒ½è§†ä½œä¸€ä¸ªç­–ç•¥ï¼Œé€šè¿‡é€‰æ‹©ä¸åŒçš„ç­–ç•¥ï¼Œæ¥ä½¿ç”¨ä¸åŒçš„è®¤è¯æ–¹æ³•ã€‚

**IAMé¡¹ç›®å®ç°äº†å¦‚ä¸‹ç­–ç•¥ï¼š**

+ [autoç­–ç•¥](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/auto.go)ï¼šè¯¥ç­–ç•¥ä¼šæ ¹æ®HTTPå¤´`Authorization: Basic XX.YY.ZZ`å’Œ`Authorization: Bearer XX.YY.ZZ`è‡ªåŠ¨é€‰æ‹©ä½¿ç”¨Basicè®¤è¯è¿˜æ˜¯Bearerè®¤è¯ã€‚
+ [basicç­–ç•¥](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/basic.go)ï¼šè¯¥ç­–ç•¥å®ç°äº†Basicè®¤è¯ã€‚
+ [jwtç­–ç•¥](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/jwt.go)ï¼šè¯¥ç­–ç•¥å®ç°äº†Bearerè®¤è¯ï¼ŒJWTæ˜¯Bearerè®¤è¯çš„å…·ä½“å®ç°ã€‚
+ [cacheç­–ç•¥](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/cache.go)ï¼šè¯¥ç­–ç•¥å…¶å®æ˜¯ä¸€ä¸ªBearerè®¤è¯çš„å®ç°ï¼ŒTokené‡‡ç”¨äº†JWTæ ¼å¼ï¼Œå› ä¸ºTokenä¸­çš„å¯†é’¥IDæ˜¯ä»å†…å­˜ä¸­è·å–çš„ï¼Œæ‰€ä»¥å«Cacheè®¤è¯ã€‚è¿™ä¸€ç‚¹åé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚

iam-apiserveré€šè¿‡åˆ›å»ºéœ€è¦çš„è®¤è¯ç­–ç•¥ï¼Œå¹¶åŠ è½½åˆ°éœ€è¦è®¤è¯çš„APIè·¯ç”±ä¸Šï¼Œæ¥å®ç°APIè®¤è¯ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```go
jwtStrategy, _ := newJWTAuth().(auth.JWTStrategy)
g.POST("/login", jwtStrategy.LoginHandler)
g.POST("/logout", jwtStrategy.LogoutHandler)
// Refresh time can be longer than token timeout
g.POST("/refresh", jwtStrategy.RefreshHandler)
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡[newJWTAuth](https://github.com/marmotedu/iam/blob/75b978b722f0af3d6aefece3f9668269be3f5b2e/internal/apiserver/auth.go#L59)å‡½æ•°åˆ›å»ºäº†`auth.JWTStrategy`ç±»å‹çš„å˜é‡ï¼Œè¯¥å˜é‡åŒ…å«äº†ä¸€äº›è®¤è¯ç›¸å…³å‡½æ•°ã€‚

+ LoginHandlerï¼šå®ç°äº†Basicè®¤è¯ï¼Œå®Œæˆç™»é™†è®¤è¯ã€‚
+ RefreshHandlerï¼šé‡æ–°åˆ·æ–°Tokençš„è¿‡æœŸæ—¶é—´ã€‚
+ LogoutHandlerï¼šç”¨æˆ·æ³¨é”€æ—¶è°ƒç”¨ã€‚ç™»é™†æˆåŠŸåï¼Œå¦‚æœåœ¨Cookieä¸­è®¾ç½®äº†è®¤è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œæ‰§è¡ŒLogoutHandleråˆ™ä¼šæ¸…ç©ºè¿™äº›ä¿¡æ¯ã€‚

ä¸‹é¢ï¼Œæˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹LoginHandlerã€RefreshHandlerå’ŒLogoutHandlerã€‚



### LoginHandler

è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹LoginHandler Ginä¸­é—´ä»¶ï¼Œè¯¥å‡½æ•°å®šä¹‰ä½äº`github.com/appleboy/gin-jwt`åŒ…çš„[auth_jwt.go](https://github.com/appleboy/gin-jwt/blob/v2.6.4/auth_jwt.go#L431)æ–‡ä»¶ä¸­ã€‚

```go
func (mw *GinJWTMiddleware) LoginHandler(c *gin.Context) {
  if mw.Authenticator == nil {
    mw.unauthorized(c, http.StatusInternalServerError, mw.HTTPStatusMessageFunc(ErrMissingAuthenticatorFunc, c))
    return
  }

  data, err := mw.Authenticator(c)

  if err != nil {
    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(err, c))
    return
  }

  // Create the token
  token := jwt.New(jwt.GetSigningMethod(mw.SigningAlgorithm))
  claims := token.Claims.(jwt.MapClaims)

  if mw.PayloadFunc != nil {
    for key, value := range mw.PayloadFunc(data) {
      claims[key] = value
    }
  }

  expire := mw.TimeFunc().Add(mw.Timeout)
  claims["exp"] = expire.Unix()
  claims["orig_iat"] = mw.TimeFunc().Unix()
  tokenString, err := mw.signedString(token)

  if err != nil {
    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(ErrFailedTokenCreation, c))
    return
  }

  // set cookie
  if mw.SendCookie {
    expireCookie := mw.TimeFunc().Add(mw.CookieMaxAge)
    maxage := int(expireCookie.Unix() - mw.TimeFunc().Unix())

    if mw.CookieSameSite != 0 {
      c.SetSameSite(mw.CookieSameSite)
    }

    c.SetCookie(
      mw.CookieName,
      tokenString,
      maxage,
      "/",
      mw.CookieDomain,
      mw.SecureCookie,
      mw.CookieHTTPOnly,
    )
  }

  mw.LoginResponse(c, http.StatusOK, tokenString, expire)
}
```

ä»LoginHandlerå‡½æ•°çš„ä»£ç å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒLoginHandlerå‡½æ•°ä¼šæ‰§è¡Œ`Authenticator`å‡½æ•°ï¼Œæ¥å®ŒæˆBasicè®¤è¯ã€‚å¦‚æœè®¤è¯é€šè¿‡ï¼Œåˆ™ä¼šç­¾å‘JWT Tokenï¼Œå¹¶æ‰§è¡Œ `PayloadFunc`å‡½æ•°è®¾ç½®Token Payloadã€‚å¦‚æœæˆ‘ä»¬è®¾ç½®äº† `SendCookie=true` ï¼Œè¿˜ä¼šåœ¨Cookieä¸­æ·»åŠ è®¤è¯ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ Tokenã€Tokençš„ç”Ÿå‘½å‘¨æœŸç­‰ï¼Œæœ€åæ‰§è¡Œ `LoginResponse` æ–¹æ³•è¿”å›Tokenå’ŒTokençš„è¿‡æœŸæ—¶é—´ã€‚

`Authenticator`ã€`PayloadFunc`ã€`LoginResponse`è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œæ˜¯æˆ‘ä»¬åœ¨åˆ›å»ºJWTè®¤è¯ç­–ç•¥æ—¶æŒ‡å®šçš„ã€‚ä¸‹é¢æˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹ã€‚



#### Authenticator å‡½æ•°

å…ˆæ¥çœ‹ä¸‹[Authenticator](https://github.com/marmotedu/iam/blob/v1.0.0/internal/apiserver/auth.go#L97)å‡½æ•°ã€‚Authenticatorå‡½æ•°ä»HTTP Authorization Headerä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå¹¶æ ¡éªŒå¯†ç æ˜¯å¦åˆæ³•ã€‚

```go
func authenticator() func(c *gin.Context) (interface{}, error) {
  return func(c *gin.Context) (interface{}, error) {
    var login loginInfo
    var err error

    // support header and body both
    if c.Request.Header.Get("Authorization") != "" {
      login, err = parseWithHeader(c)
    } else {
      login, err = parseWithBody(c)
    }
    if err != nil {
      return "", jwt.ErrFailedAuthentication
    }

    // Get the user information by the login username.
    user, err := store.Client().Users().Get(c, login.Username, metav1.GetOptions{})
    if err != nil {
      log.Errorf("get user information failed: %s", err.Error())

      return "", jwt.ErrFailedAuthentication
    }

    // Compare the login password with the user password.
    if err := user.Compare(login.Password); err != nil {
      return "", jwt.ErrFailedAuthentication
    }

    return user, nil
  }
}
```

`Authenticator`å‡½æ•°éœ€è¦è·å–ç”¨æˆ·åå’Œå¯†ç ã€‚å®ƒé¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦æœ‰`Authorization`è¯·æ±‚å¤´ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è°ƒç”¨`parseWithHeader`å‡½æ•°è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦åˆ™è°ƒç”¨`parseWithBody`ä»Bodyä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ã€‚å¦‚æœéƒ½è·å–å¤±è´¥ï¼Œåˆ™è¿”å›è®¤è¯å¤±è´¥é”™è¯¯ã€‚

æ‰€ä»¥ï¼ŒIAMé¡¹ç›®çš„Basicæ”¯æŒä»¥ä¸‹ä¸¤ç§è¯·æ±‚æ–¹å¼ï¼š

```bash
$ curl -XPOST -H"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ==" http://127.0.0.1:8080/login # ç”¨æˆ·å:å¯†ç é€šè¿‡base64åŠ ç åï¼Œé€šè¿‡HTTP Authorization Headerè¿›è¡Œä¼ é€’ï¼Œå› ä¸ºå¯†ç éæ˜æ–‡ï¼Œå»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚
$ curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login # ç”¨æˆ·åå’Œå¯†ç åœ¨HTTP Bodyä¸­ä¼ é€’ï¼Œå› ä¸ºå¯†ç æ˜¯æ˜æ–‡ï¼Œæ‰€ä»¥è¿™é‡Œä¸å»ºè®®å®é™…å¼€å‘ä¸­ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼ã€‚
```

è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ `parseWithHeader` æ˜¯å¦‚ä½•è·å–ç”¨æˆ·åå’Œå¯†ç çš„ã€‚å‡è®¾æˆ‘ä»¬çš„è¯·æ±‚ä¸ºï¼š

```bash
$ curl -XPOST -H"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ==" http://127.0.0.1:8080/login
```

å…¶ä¸­ï¼Œ`YWRtaW46QWRtaW5AMjAyMQ==`å€¼ç”±ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆï¼š

```bash
$ echo -n 'admin:Admin@2021'|base64YWRtaW46QWRtaW5AMjAyMQ==
```

`parseWithHeader`å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ä¸Šè¿°å‘½ä»¤çš„é€†å‘æ­¥éª¤ï¼š

1. è·å–`Authorization`å¤´çš„å€¼ï¼Œå¹¶è°ƒç”¨`strings.SplitN`å‡½æ•°ï¼Œè·å–ä¸€ä¸ªåˆ‡ç‰‡å˜é‡authï¼Œå…¶å€¼ä¸º `["Basic","YWRtaW46QWRtaW5AMjAyMQ=="]` ã€‚
2. å°†`YWRtaW46QWRtaW5AMjAyMQ==`è¿›è¡Œbase64è§£ç ï¼Œå¾—åˆ°`admin:Admin@2021`ã€‚
3. è°ƒç”¨`strings.SplitN`å‡½æ•°è·å– `admin:Admin@2021` ï¼Œå¾—åˆ°ç”¨æˆ·åä¸º`admin`ï¼Œå¯†ç ä¸º`Admin@2021`ã€‚

`parseWithBody`åˆ™æ˜¯è°ƒç”¨äº†Ginçš„`ShouldBindJSON`å‡½æ•°ï¼Œæ¥ä»Bodyä¸­è§£æå‡ºç”¨æˆ·åå’Œå¯†ç ã€‚

è·å–åˆ°ç”¨æˆ·åå’Œå¯†ç ä¹‹åï¼Œç¨‹åºä¼šä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºè¯¥ç”¨æˆ·å¯¹åº”çš„åŠ å¯†åçš„å¯†ç ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾æ˜¯`xxxx`ã€‚æœ€å`authenticator`å‡½æ•°è°ƒç”¨`user.Compare`æ¥åˆ¤æ–­ `xxxx` æ˜¯å¦å’Œé€šè¿‡`user.Compare`åŠ å¯†åçš„å­—ç¬¦ä¸²ç›¸åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è®¤è¯æˆåŠŸï¼Œå¦åˆ™è¿”å›è®¤è¯å¤±è´¥ã€‚



#### å†æ¥çœ‹ä¸‹`PayloadFunc`å‡½æ•°

```go
func payloadFunc() func(data interface{}) jwt.MapClaims {
    return func(data interface{}) jwt.MapClaims {
        claims := jwt.MapClaims{
            "iss": APIServerIssuer,
            "aud": APIServerAudience,
        }
        if u, ok := data.(*v1.User); ok {
            claims[jwt.IdentityKey] = u.Name
            claims["sub"] = u.Name
        }

        return claims
    }
}
```

PayloadFuncå‡½æ•°ä¼šè®¾ç½®JWT Tokenä¸­Payloadéƒ¨åˆ†çš„ issã€audã€subã€identityå­—æ®µï¼Œä¾›åé¢ä½¿ç”¨ã€‚



#### LoginResponseå‡½æ•°

```go

func loginResponse() func(c *gin.Context, code int, token string, expire time.Time) {
    return func(c *gin.Context, code int, token string, expire time.Time) {
        c.JSON(http.StatusOK, gin.H{
            "token":  token,
            "expire": expire.Format(time.RFC3339),
        })
    }
}
```

è¯¥å‡½æ•°ç”¨æ¥åœ¨Basicè®¤è¯æˆåŠŸä¹‹åï¼Œè¿”å›Tokenå’ŒTokençš„è¿‡æœŸæ—¶é—´ç»™è°ƒç”¨è€…ï¼š

```bash
$ curl -XPOST -H"Authorization: Basic YWRtaW46QWRtaW5AMjAyMQ==" http://127.0.0.1:8080/login
{"expire":"2021-09-29T01:38:49+08:00","token":"XX.YY.ZZ"}
```

ç™»é™†æˆåŠŸåï¼Œiam-apiserverä¼šè¿”å›Tokenå’ŒTokençš„è¿‡æœŸæ—¶é—´ï¼Œå‰ç«¯å¯ä»¥å°†è¿™äº›ä¿¡æ¯ç¼“å­˜åœ¨Cookieä¸­æˆ–LocalStorageä¸­ï¼Œä¹‹åçš„è¯·æ±‚éƒ½å¯ä»¥ä½¿ç”¨Tokenæ¥è¿›è¡Œè®¤è¯ã€‚ä½¿ç”¨Tokenè¿›è¡Œè®¤è¯ï¼Œä¸ä»…èƒ½å¤Ÿæé«˜è®¤è¯çš„å®‰å…¨æ€§ï¼Œè¿˜èƒ½å¤Ÿé¿å…æŸ¥è¯¢æ•°æ®åº“ï¼Œä»è€Œæé«˜è®¤è¯æ•ˆç‡ã€‚



### RefreshHandler

`RefreshHandler`å‡½æ•°ä¼šå…ˆæ‰§è¡ŒBearerè®¤è¯ï¼Œå¦‚æœè®¤è¯é€šè¿‡ï¼Œåˆ™ä¼šé‡æ–°ç­¾å‘Tokenã€‚



### LogoutHandler

æœ€åï¼Œæ¥çœ‹ä¸‹`LogoutHandler`å‡½æ•°ï¼š

```go

func (mw *GinJWTMiddleware) LogoutHandler(c *gin.Context) {
    // delete auth cookie
    if mw.SendCookie {
        if mw.CookieSameSite != 0 {
            c.SetSameSite(mw.CookieSameSite)
        }

        c.SetCookie(
            mw.CookieName,
            "",
            -1,
            "/",
            mw.CookieDomain,
            mw.SecureCookie,
            mw.CookieHTTPOnly,
        )
    }

    mw.LogoutResponse(c, http.StatusOK)
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒLogoutHandlerå…¶å®æ˜¯ç”¨æ¥æ¸…ç©ºCookieä¸­Bearerè®¤è¯ç›¸å…³ä¿¡æ¯çš„ã€‚

æœ€åï¼Œæˆ‘ä»¬æ¥åšä¸ªæ€»ç»“ï¼šBasicè®¤è¯é€šè¿‡ç”¨æˆ·åå’Œå¯†ç æ¥è¿›è¡Œè®¤è¯ï¼Œé€šå¸¸ç”¨åœ¨ç™»é™†æ¥å£/loginä¸­ã€‚ç”¨æˆ·ç™»é™†æˆåŠŸåï¼Œä¼šè¿”å›JWT Tokenï¼Œå‰ç«¯ä¼šä¿å­˜è¯¥JWT Tokenåœ¨æµè§ˆå™¨çš„Cookieæˆ–LocalStorageä¸­ï¼Œä¾›åç»­è¯·æ±‚ä½¿ç”¨ã€‚

åç»­è¯·æ±‚æ—¶ï¼Œå‡ä¼šæºå¸¦è¯¥Tokenï¼Œä»¥å®ŒæˆBearerè®¤è¯ã€‚å¦å¤–ï¼Œæœ‰äº†ç™»é™†æ¥å£ï¼Œä¸€èˆ¬è¿˜ä¼šé…å¥—/logoutæ¥å£å’Œ/refreshæ¥å£ï¼Œåˆ†åˆ«ç”¨æ¥è¿›è¡Œæ³¨é”€å’Œåˆ·æ–°Tokenã€‚

è¿™é‡Œä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦åˆ·æ–°Tokenï¼Ÿå› ä¸ºé€šè¿‡ç™»é™†æ¥å£ç­¾å‘çš„Tokenæœ‰è¿‡æœŸæ—¶é—´ï¼Œæœ‰äº†åˆ·æ–°æ¥å£ï¼Œå‰ç«¯å°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªè¡Œåˆ·æ–°Tokençš„è¿‡æœŸæ—¶é—´ã€‚è¿‡æœŸæ—¶é—´å¯ä»¥é€šè¿‡iam-apiserveré…ç½®æ–‡ä»¶çš„[jwt.timeout](https://github.com/marmotedu/iam/blob/master/configs/iam-apiserver.yaml#L66)é…ç½®é¡¹æ¥æŒ‡å®šã€‚ç™»é™†åç­¾å‘Tokenæ—¶ï¼Œä½¿ç”¨çš„å¯†é’¥ï¼ˆsecretKeyï¼‰ç”±[jwt.key](https://github.com/marmotedu/iam/blob/master/configs/iam-apiserver.yaml#L65)é…ç½®é¡¹æ¥æŒ‡å®šã€‚



## IAMé¡¹ç›®æ˜¯å¦‚ä½•å®ç°Bearerè®¤è¯çš„ï¼Ÿ

ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†Basicè®¤è¯ã€‚è¿™é‡Œï¼Œæˆ‘å†æ¥ä»‹ç»ä¸‹IAMé¡¹ç›®ä¸­Bearerè®¤è¯çš„å®ç°æ–¹å¼ã€‚

IAMé¡¹ç›®ä¸­æœ‰ä¸¤ä¸ªåœ°æ–¹å®ç°äº†Bearerè®¤è¯ï¼Œåˆ†åˆ«æ˜¯ iam-apiserver å’Œ iam-authz-serverã€‚ä¸‹é¢æˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹å®ƒä»¬æ˜¯å¦‚ä½•å®ç°Bearerè®¤è¯çš„ã€‚



### iam-authz-server Bearerè®¤è¯å®ç°

å…ˆæ¥çœ‹ä¸‹iam-authz-serveræ˜¯å¦‚ä½•å®ç°Bearerè®¤è¯çš„ã€‚

iam-authz-serveré€šè¿‡åœ¨ `/v1` è·¯ç”±åˆ†ç»„ä¸­åŠ è½½cacheè®¤è¯ä¸­é—´ä»¶æ¥ä½¿ç”¨cacheè®¤è¯ç­–ç•¥ï¼š

```bash
auth := newCacheAuth()
apiv1 := g.Group("/v1", auth.AuthFunc())
```

æ¥çœ‹ä¸‹[newCacheAuth](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/jwt.go#L15)å‡½æ•°ï¼š

```go

func newCacheAuth() middleware.AuthStrategy {
    return auth.NewCacheStrategy(getSecretFunc())
}

func getSecretFunc() func(string) (auth.Secret, error) {
    return func(kid string) (auth.Secret, error) {
        cli, err := store.GetStoreInsOr(nil)
        if err != nil {
            return auth.Secret{}, errors.Wrap(err, "get store instance failed")
        }

        secret, err := cli.GetSecret(kid)
        if err != nil {
            return auth.Secret{}, err
        }

        return auth.Secret{
            Username: secret.Username,
            ID:       secret.SecretId,
            Key:      secret.SecretKey,
            Expires:  secret.Expires,
        }, nil
    }
}
```

newCacheAuthå‡½æ•°è°ƒç”¨`auth.NewCacheStrategy`åˆ›å»ºäº†ä¸€ä¸ªcacheè®¤è¯ç­–ç•¥ï¼Œåˆ›å»ºæ—¶ä¼ å…¥äº†`getSecretFunc`å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¿”å›å¯†é’¥çš„ä¿¡æ¯ã€‚å¯†é’¥ä¿¡æ¯åŒ…å«äº†ä»¥ä¸‹å­—æ®µï¼š

```go
type Secret struct {
    Username string
    ID       string
    Key      string
    Expires  int64
}
```

å†æ¥çœ‹ä¸‹cacheè®¤è¯ç­–ç•¥å®ç°çš„[AuthFunc](https://github.com/marmotedu/iam/blob/master/internal/pkg/middleware/auth/cache.go#L48)æ–¹æ³•ï¼š

```go

func (cache CacheStrategy) AuthFunc() gin.HandlerFunc {
  return func(c *gin.Context) {
    header := c.Request.Header.Get("Authorization")
    if len(header) == 0 {
      core.WriteResponse(c, errors.WithCode(code.ErrMissingHeader, "Authorization header cannot be empty."), nil)
      c.Abort()

      return
    }

    var rawJWT string
    // Parse the header to get the token part.
    fmt.Sscanf(header, "Bearer %s", &rawJWT)

    // Use own validation logic, see below
    var secret Secret

    claims := &jwt.MapClaims{}
    // Verify the token
    parsedT, err := jwt.ParseWithClaims(rawJWT, claims, func(token *jwt.Token) (interface{}, error) {
      // Validate the alg is HMAC signature
      if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
        return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"])
      }

      kid, ok := token.Header["kid"].(string)
      if !ok {
        return nil, ErrMissingKID
      }

      var err error
      secret, err = cache.get(kid)
      if err != nil {
        return nil, ErrMissingSecret
      }

      return []byte(secret.Key), nil
    }, jwt.WithAudience(AuthzAudience))
    if err != nil || !parsedT.Valid {
      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, err.Error()), nil)
      c.Abort()

      return
    }

    if KeyExpired(secret.Expires) {
      tm := time.Unix(secret.Expires, 0).Format("2006-01-02 15:04:05")
      core.WriteResponse(c, errors.WithCode(code.ErrExpired, "expired at: %s", tm), nil)
      c.Abort()

      return
    }

    c.Set(CtxUsername, secret.Username)
    c.Next()
  }
}

// KeyExpired checks if a key has expired, if the value of user.SessionState.Expires is 0, it will be ignored.
func KeyExpired(expires int64) bool {
  if expires >= 1 {
    return time.Now().After(time.Unix(expires, 0))
  }

  return false
}
```

AuthFuncå‡½æ•°ä¾æ¬¡æ‰§è¡Œäº†ä»¥ä¸‹å››å¤§æ­¥æ¥å®ŒæˆJWTè®¤è¯ï¼Œæ¯ä¸€æ­¥ä¸­åˆæœ‰ä¸€äº›å°æ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·çœ‹çœ‹ã€‚

ç¬¬ä¸€æ­¥ï¼Œä»Authorization: Bearer XX.YY.ZZè¯·æ±‚å¤´ä¸­è·å–XX.YY.ZZï¼ŒXX.YY.ZZå³ä¸ºJWT Tokenã€‚

ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨github.com/dgrijalva/jwt-goåŒ…æä¾›çš„ParseWithClaimså‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šä¾æ¬¡æ‰§è¡Œä¸‹é¢å››æ­¥æ“ä½œã€‚

è°ƒç”¨ParseUnverifiedå‡½æ•°ï¼Œä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. ä»Tokenä¸­è·å–ç¬¬ä¸€æ®µXXï¼Œbase64è§£ç åå¾—åˆ°JWT Tokençš„`Header{â€œalgâ€:â€œHS256â€,â€œkidâ€:â€œa45yPqUnQ8gljH43jAGQdRo0bXzNLjlU0hxaâ€,â€œtypâ€:â€œJWTâ€}`ã€‚
2. ä»Tokenä¸­è·å–ç¬¬äºŒæ®µYYï¼Œbase64è§£ç åå¾—åˆ°JWT Tokençš„`Payload{â€œaudâ€:â€œiam.authz.marmotedu.comâ€,â€œexpâ€:1625104314,â€œiatâ€:1625097114,â€œissâ€:â€œiamctlâ€,â€œnbfâ€:1625097114}`ã€‚
3. æ ¹æ®Token Headerä¸­çš„algå­—æ®µï¼Œè·å–TokenåŠ å¯†å‡½æ•°ã€‚
4. æœ€ç»ˆParseUnverifiedå‡½æ•°ä¼šè¿”å›Tokenç±»å‹çš„å˜é‡ï¼ŒTokenç±»å‹åŒ…å« Methodã€Headerã€Claimsã€Validè¿™äº›é‡è¦å­—æ®µï¼Œè¿™äº›å­—æ®µä¼šç”¨äºåç»­çš„è®¤è¯æ­¥éª¤ä¸­ã€‚

è°ƒç”¨ä¼ å…¥çš„keyFuncè·å–å¯†é’¥ï¼Œè¿™é‡Œæ¥çœ‹ä¸‹keyFuncçš„å®ç°ï¼š

```go

func(token *jwt.Token) (interface{}, error) {
  // Validate the alg is HMAC signature
  if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
    return nil, fmt.Errorf("unexpected signing method: %v", token.Header["alg"])
  }

  kid, ok := token.Header["kid"].(string)
  if !ok {
    return nil, ErrMissingKID
  }

  var err error
  secret, err = cache.get(kid)
  if err != nil {
    return nil, ErrMissingSecret
  }

  return []byte(secret.Key), nil
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒkeyFuncæ¥å— `*Token` ç±»å‹çš„å˜é‡ï¼Œå¹¶è·å–Token Headerä¸­çš„kidï¼Œkidå³ä¸ºå¯†é’¥IDï¼šsecretIDã€‚æ¥ç€ï¼Œè°ƒç”¨cache.get(kid)è·å–å¯†é’¥secretKeyã€‚cache.getå‡½æ•°å³ä¸ºgetSecretFuncï¼ŒgetSecretFuncå‡½æ•°ä¼šæ ¹æ®kidï¼Œä»å†…å­˜ä¸­æŸ¥æ‰¾å¯†é’¥ä¿¡æ¯ï¼Œå¯†é’¥ä¿¡æ¯ä¸­åŒ…å«äº†secretKeyã€‚

1. ä»Tokenä¸­è·å–Signatureç­¾åå­—ç¬¦ä¸²ZZï¼Œä¹Ÿå³Tokençš„ç¬¬ä¸‰æ®µã€‚
2. è·å–åˆ°secretKeyä¹‹åï¼Œtoken.Method.VerifyéªŒè¯Signatureç­¾åå­—ç¬¦ä¸²ZZï¼Œä¹Ÿå³Tokençš„ç¬¬ä¸‰æ®µæ˜¯å¦åˆæ³•ã€‚token.Method.Verifyå®é™…ä¸Šæ˜¯ä½¿ç”¨äº†ç›¸åŒçš„åŠ å¯†ç®—æ³•å’Œç›¸åŒçš„secretKeyåŠ å¯†XX.YYå­—ç¬¦ä¸²ã€‚å‡è®¾åŠ å¯†ä¹‹åçš„å­—ç¬¦ä¸²ä¸ºWWï¼Œæ¥ä¸‹æ¥ä¼šç”¨WWå’ŒZZ base64è§£ç åçš„å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰åˆ™è®¤è¯é€šè¿‡ï¼Œå¦‚æœä¸ç›¸ç­‰åˆ™è®¤è¯å¤±è´¥ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œ**è°ƒç”¨KeyExpiredï¼ŒéªŒè¯secretæ˜¯å¦è¿‡æœŸã€‚secretä¿¡æ¯ä¸­åŒ…å«è¿‡æœŸæ—¶é—´ï¼Œä½ åªéœ€è¦æ‹¿è¯¥è¿‡æœŸæ—¶é—´å’Œå½“å‰æ—¶é—´å¯¹æ¯”å°±è¡Œã€‚

**ç¬¬å››æ­¥ï¼Œ**è®¾ç½®HTTP Header`username: colin`ã€‚

åˆ°è¿™é‡Œï¼Œiam-authz-serverçš„Bearerè®¤è¯åˆ†æå°±å®Œæˆäº†ã€‚

æˆ‘ä»¬æ¥åšä¸ªæ€»ç»“ï¼šiam-authz-serveré€šè¿‡åŠ è½½Ginä¸­é—´ä»¶çš„æ–¹å¼ï¼Œåœ¨è¯·æ±‚`/v1/authz`æ¥å£æ—¶è¿›è¡Œè®¿é—®è®¤è¯ã€‚å› ä¸ºBearerè®¤è¯å…·æœ‰è¿‡æœŸæ—¶é—´ï¼Œè€Œä¸”å¯ä»¥åœ¨è®¤è¯å­—ç¬¦ä¸²ä¸­æºå¸¦æ›´å¤šæœ‰ç”¨ä¿¡æ¯ï¼Œè¿˜å…·æœ‰ä¸å¯é€†åŠ å¯†ç­‰ä¼˜ç‚¹ï¼Œæ‰€ä»¥**/v1/authzé‡‡ç”¨äº†Bearerè®¤è¯ï¼ŒTokenæ ¼å¼é‡‡ç”¨äº†JWTæ ¼å¼**ï¼Œè¿™ä¹Ÿæ˜¯ä¸šç•Œåœ¨APIè®¤è¯ä¸­æœ€å—æ¬¢è¿çš„è®¤è¯æ–¹å¼ã€‚

Bearerè®¤è¯éœ€è¦secretIDå’ŒsecretKeyï¼Œè¿™äº›ä¿¡æ¯ä¼šé€šè¿‡gRPCæ¥å£è°ƒç”¨ï¼Œä»iam-apisaerverä¸­è·å–ï¼Œå¹¶ç¼“å­˜åœ¨iam-authz-serverçš„å†…å­˜ä¸­ä¾›è®¤è¯æ—¶æŸ¥è¯¢ä½¿ç”¨ã€‚

å½“è¯·æ±‚æ¥ä¸´æ—¶ï¼Œiam-authz-server Bearerè®¤è¯ä¸­é—´ä»¶ä»JWT Tokenä¸­è§£æå‡ºHeaderï¼Œå¹¶ä»Headerçš„kidå­—æ®µä¸­è·å–åˆ°secretIDï¼Œæ ¹æ®secretIDæŸ¥æ‰¾åˆ°secretKeyï¼Œæœ€åä½¿ç”¨secretKeyåŠ å¯†JWT Tokençš„Headerå’ŒPayloadï¼Œå¹¶ä¸Signatureéƒ¨åˆ†è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™è®¤è¯é€šè¿‡ï¼›å¦‚æœä¸ç­‰ï¼Œåˆ™è®¤è¯å¤±è´¥ã€‚



### iam-apiserver Bearerè®¤è¯å®ç°

å†æ¥çœ‹ä¸‹ iam-apiserverçš„Bearerè®¤è¯ã€‚

iam-apiserverçš„Bearerè®¤è¯é€šè¿‡ä»¥ä¸‹ä»£ç ï¼ˆä½äº[router.go](https://github.com/marmotedu/iam/blob/v1.1.0/internal/apiserver/router.go#L65)æ–‡ä»¶ä¸­ï¼‰æŒ‡å®šä½¿ç”¨äº†autoè®¤è¯ç­–ç•¥ï¼š

```go
v1.Use(auto.AuthFunc())
```

æˆ‘ä»¬æ¥çœ‹ä¸‹[auto.AuthFunc()](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/auto.go#L38)çš„å®ç°ï¼š

```go

func (a AutoStrategy) AuthFunc() gin.HandlerFunc {
  return func(c *gin.Context) {
    operator := middleware.AuthOperator{}
    authHeader := strings.SplitN(c.Request.Header.Get("Authorization"), " ", 2)

    if len(authHeader) != authHeaderCount {
      core.WriteResponse(
        c,
        errors.WithCode(code.ErrInvalidAuthHeader, "Authorization header format is wrong."),
        nil,
      )
      c.Abort()

      return
    }

    switch authHeader[0] {
    case "Basic":
      operator.SetStrategy(a.basic)
    case "Bearer":
      operator.SetStrategy(a.jwt)
      // a.JWT.MiddlewareFunc()(c)
    default:
      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, "unrecognized Authorization header."), nil)
      c.Abort()

      return
    }

    operator.AuthFunc()(c)

    c.Next()
  }
}
```

ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒAuthFuncå‡½æ•°ä¼šä»Authorization Headerä¸­è§£æå‡ºè®¤è¯æ–¹å¼æ˜¯Basicè¿˜æ˜¯Bearerã€‚å¦‚æœæ˜¯Bearerï¼Œå°±ä¼šä½¿ç”¨JWTè®¤è¯ç­–ç•¥ï¼›å¦‚æœæ˜¯Basicï¼Œå°±ä¼šä½¿ç”¨Basicè®¤è¯ç­–ç•¥ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸‹JWTè®¤è¯ç­–ç•¥çš„[AuthFunc](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/jwt.go#L30)å‡½æ•°å®ç°ï¼š

```go

func (j JWTStrategy) AuthFunc() gin.HandlerFunc {
  return j.MiddlewareFunc()
}
```

æˆ‘ä»¬è·Ÿéšä»£ç ï¼Œå¯ä»¥å®šä½åˆ°`MiddlewareFunc`å‡½æ•°æœ€ç»ˆè°ƒç”¨äº†`github.com/appleboy/gin-jwt`åŒ…`GinJWTMiddleware`ç»“æ„ä½“çš„[middlewareImpl](https://github.com/appleboy/gin-jwt/blob/v2.6.4/auth_jwt.go#L369)æ–¹æ³•ï¼š

```go

func (mw *GinJWTMiddleware) middlewareImpl(c *gin.Context) {
  claims, err := mw.GetClaimsFromJWT(c)
  if err != nil {
    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(err, c))
    return
  }

  if claims["exp"] == nil {
    mw.unauthorized(c, http.StatusBadRequest, mw.HTTPStatusMessageFunc(ErrMissingExpField, c))
    return
  }

  if _, ok := claims["exp"].(float64); !ok {
    mw.unauthorized(c, http.StatusBadRequest, mw.HTTPStatusMessageFunc(ErrWrongFormatOfExp, c))
    return
  }

  if int64(claims["exp"].(float64)) < mw.TimeFunc().Unix() {
    mw.unauthorized(c, http.StatusUnauthorized, mw.HTTPStatusMessageFunc(ErrExpiredToken, c))
    return
  }

  c.Set("JWT_PAYLOAD", claims)
  identity := mw.IdentityHandler(c)

  if identity != nil {
    c.Set(mw.IdentityKey, identity)
  }

  if !mw.Authorizator(identity, c) {
    mw.unauthorized(c, http.StatusForbidden, mw.HTTPStatusMessageFunc(ErrForbidden, c))
    return
  }

  c.Next()
}
```

åˆ†æä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒmiddlewareImplçš„Bearerè®¤è¯æµç¨‹ä¸ºï¼š

**ç¬¬ä¸€æ­¥**ï¼šè°ƒç”¨`GetClaimsFromJWT`å‡½æ•°ï¼Œä»HTTPè¯·æ±‚ä¸­è·å–Authorization Headerï¼Œå¹¶è§£æå‡ºTokenå­—ç¬¦ä¸²ï¼Œè¿›è¡Œè®¤è¯ï¼Œæœ€åè¿”å›Token Payloadã€‚

**ç¬¬äºŒæ­¥**ï¼šæ ¡éªŒPayloadä¸­çš„`exp`æ˜¯å¦è¶…è¿‡å½“å‰æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡å°±è¯´æ˜Tokenè¿‡æœŸï¼Œæ ¡éªŒä¸é€šè¿‡ã€‚

**ç¬¬ä¸‰æ­¥**ï¼šç»™gin.Contextä¸­æ·»åŠ `JWT_PAYLOAD`é”®ï¼Œä¾›åç»­ç¨‹åºä½¿ç”¨ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½ç”¨ä¸åˆ°ï¼‰ã€‚

**ç¬¬å››æ­¥**ï¼šé€šè¿‡ä»¥ä¸‹ä»£ç ï¼Œåœ¨gin.Contextä¸­æ·»åŠ IdentityKeyé”®ï¼ŒIdentityKeyé”®å¯ä»¥åœ¨åˆ›å»º`GinJWTMiddleware`ç»“æ„ä½“æ—¶æŒ‡å®šï¼Œè¿™é‡Œæˆ‘ä»¬è®¾ç½®ä¸º`middleware.UsernameKey`ï¼Œä¹Ÿå°±æ˜¯usernameã€‚

```go

identity := mw.IdentityHandler(c)

if identity != nil {
    c.Set(mw.IdentityKey, identity)
}
```

IdentityKeyé”®çš„å€¼ç”±IdentityHandlerå‡½æ•°è¿”å›ï¼ŒIdentityHandlerå‡½æ•°ä¸ºï¼š

```go

func(c *gin.Context) interface{} {
    claims := jwt.ExtractClaims(c)

    return claims[jwt.IdentityKey]
}
```

ä¸Šè¿°å‡½æ•°ä¼šä»Tokençš„Payloadä¸­è·å–identityåŸŸçš„å€¼ï¼ŒidentityåŸŸçš„å€¼æ˜¯åœ¨ç­¾å‘Tokenæ—¶æŒ‡å®šçš„ï¼Œå®ƒçš„å€¼å…¶å®æ˜¯ç”¨æˆ·åï¼Œä½ å¯ä»¥æŸ¥çœ‹[payloadFunc](https://github.com/marmotedu/iam/blob/v1.0.0/internal/apiserver/auth.go#L177)å‡½æ•°äº†è§£ã€‚

**ç¬¬äº”æ­¥**ï¼šæ¥ä¸‹æ¥ï¼Œä¼šè°ƒç”¨`Authorizator`æ–¹æ³•ï¼Œ`Authorizator`æ˜¯ä¸€ä¸ªcallbackå‡½æ•°ï¼ŒæˆåŠŸæ—¶å¿…é¡»è¿”å›çœŸï¼Œå¤±è´¥æ—¶å¿…é¡»è¿”å›å‡ã€‚`Authorizator`ä¹Ÿæ˜¯åœ¨åˆ›å»ºGinJWTMiddlewareæ—¶æŒ‡å®šçš„ï¼Œä¾‹å¦‚ï¼š

```go

func authorizator() func(data interface{}, c *gin.Context) bool {    
    return func(data interface{}, c *gin.Context) bool {    
        if v, ok := data.(string); ok {    
            log.L(c).Infof("user `%s` is authenticated.", v)         
            return true                            
        }                                                   
        return false                     
    }    
}    
```

`authorizator`å‡½æ•°è¿”å›äº†ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼ŒåŒ¿åå‡½æ•°åœ¨è®¤è¯æˆåŠŸåï¼Œä¼šæ‰“å°ä¸€æ¡è®¤è¯æˆåŠŸæ—¥å¿—ã€‚



## IAMé¡¹ç›®è®¤è¯åŠŸèƒ½è®¾è®¡æŠ€å·§

æˆ‘åœ¨è®¾è®¡IAMé¡¹ç›®çš„è®¤è¯åŠŸèƒ½æ—¶ï¼Œä¹Ÿè¿ç”¨äº†ä¸€äº›æŠ€å·§ï¼Œè¿™é‡Œåˆ†äº«ç»™ä½ ã€‚

### æŠ€å·§1ï¼šé¢å‘æ¥å£ç¼–ç¨‹

åœ¨ä½¿ç”¨[NewAutoStrategy](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/auto.go#L30)å‡½æ•°åˆ›å»ºautoè®¤è¯ç­–ç•¥æ—¶ï¼Œä¼ å…¥äº†[middleware.AuthStrategy](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth.go#L12)æ¥å£ç±»å‹çš„å‚æ•°ï¼Œè¿™æ„å‘³ç€Basicè®¤è¯å’ŒBearerè®¤è¯éƒ½å¯ä»¥æœ‰ä¸åŒçš„å®ç°ï¼Œè¿™æ ·åæœŸå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•æ–°çš„è®¤è¯æ–¹å¼ã€‚

### æŠ€å·§2ï¼šä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼

[auth.go](https://github.com/marmotedu/iam/blob/v1.0.0/internal/apiserver/auth.go)æ–‡ä»¶ä¸­ï¼Œé€šè¿‡newBasicAuthã€newJWTAuthã€newAutoAuthåˆ›å»ºè®¤è¯ç­–ç•¥æ—¶ï¼Œè¿”å›çš„éƒ½æ˜¯æ¥å£ã€‚é€šè¿‡è¿”å›æ¥å£ï¼Œå¯ä»¥åœ¨ä¸å…¬å¼€å†…éƒ¨å®ç°çš„æƒ…å†µä¸‹ï¼Œè®©è°ƒç”¨è€…ä½¿ç”¨ä½ æä¾›çš„å„ç§è®¤è¯åŠŸèƒ½ã€‚

### æŠ€å·§3ï¼šä½¿ç”¨ç­–ç•¥æ¨¡å¼

åœ¨autoè®¤è¯ç­–ç•¥ä¸­ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®HTTP è¯·æ±‚å¤´`Authorization: XXX X.Y.X`ä¸­çš„XXXæ¥é€‰æ‹©å¹¶è®¾ç½®è®¤è¯ç­–ç•¥ï¼ˆBasic æˆ– Bearerï¼‰ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹`AutoStrategy`çš„[AuthFunc](https://github.com/marmotedu/iam/blob/v1.0.0/internal/pkg/middleware/auth/auto.go#L38)å‡½æ•°ï¼š

```go
func (a AutoStrategy) AuthFunc() gin.HandlerFunc {
  return func(c *gin.Context) {
    operator := middleware.AuthOperator{}
    authHeader := strings.SplitN(c.Request.Header.Get("Authorization"), " ", 2)
        ...
    switch authHeader[0] {
    case "Basic":
      operator.SetStrategy(a.basic)
    case "Bearer":
      operator.SetStrategy(a.jwt)
      // a.JWT.MiddlewareFunc()(c)
    default:
      core.WriteResponse(c, errors.WithCode(code.ErrSignatureInvalid, "unrecognized Authorization header."), nil)
      c.Abort()

      return
    }

    operator.AuthFunc()(c)

    c.Next()
  }
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œå¦‚æœæ˜¯Basicï¼Œåˆ™è®¾ç½®ä¸ºBasicè®¤è¯æ–¹æ³•`operator.SetStrategy(a.basic)`ï¼›å¦‚æœæ˜¯Bearerï¼Œåˆ™è®¾ç½®ä¸ºBearerè®¤è¯æ–¹æ³•`operator.SetStrategy(a.jwt)`ã€‚ `SetStrategy`æ–¹æ³•çš„å…¥å‚æ˜¯AuthStrategyç±»å‹çš„æ¥å£ï¼Œéƒ½å®ç°äº†`AuthFunc() gin.HandlerFunc`å‡½æ•°ï¼Œç”¨æ¥è¿›è¡Œè®¤è¯ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬è°ƒç”¨`operator.AuthFunc()(c)`å³å¯å®Œæˆè®¤è¯ã€‚



## æ€»ç»“

åœ¨IAMé¡¹ç›®ä¸­ï¼Œiam-apiserverå®ç°äº†Basicè®¤è¯å’ŒBearerè®¤è¯ï¼Œiam-authz-serverå®ç°äº†Bearerè®¤è¯ã€‚è¿™ä¸€è®²é‡ç‚¹ä»‹ç»äº†iam-apiserverçš„è®¤è¯å®ç°ã€‚

ç”¨æˆ·è¦è®¿é—®iam-apiserverï¼Œé¦–å…ˆéœ€è¦é€šè¿‡Basicè®¤è¯ï¼Œè®¤è¯é€šè¿‡ä¹‹åï¼Œä¼šè¿”å›JWT Tokenå’ŒJWT Tokençš„è¿‡æœŸæ—¶é—´ã€‚å‰ç«¯å°†Tokenç¼“å­˜åœ¨LocalStorageæˆ–Cookieä¸­ï¼Œåç»­çš„è¯·æ±‚éƒ½é€šè¿‡Tokenæ¥è®¤è¯ã€‚

æ‰§è¡ŒBasicè®¤è¯æ—¶ï¼Œiam-apiserverä¼šä»HTTP Authorization Headerä¸­è§£æå‡ºç”¨æˆ·åå’Œå¯†ç ï¼Œå°†å¯†ç å†åŠ å¯†ï¼Œå¹¶å’Œæ•°æ®åº“ä¸­ä¿å­˜çš„å€¼è¿›è¡Œå¯¹æ¯”ã€‚å¦‚æœä¸åŒ¹é…ï¼Œåˆ™è®¤è¯å¤±è´¥ï¼Œå¦åˆ™è®¤è¯æˆåŠŸã€‚è®¤è¯æˆåŠŸä¹‹åï¼Œä¼šè¿”å›Tokenï¼Œå¹¶åœ¨Tokençš„Payloadéƒ¨åˆ†è®¾ç½®ç”¨æˆ·åï¼ŒKeyä¸º username ã€‚

æ‰§è¡ŒBearerè®¤è¯æ—¶ï¼Œiam-apiserverä¼šä»JWT Tokenä¸­è§£æå‡ºHeaderå’ŒPayloadï¼Œå¹¶ä»Headerä¸­è·å–åŠ å¯†ç®—æ³•ã€‚æ¥ç€ï¼Œç”¨è·å–åˆ°çš„åŠ å¯†ç®—æ³•å’Œä»é…ç½®æ–‡ä»¶ä¸­è·å–åˆ°çš„å¯†é’¥å¯¹Header.Payloadè¿›è¡Œå†åŠ å¯†ï¼Œå¾—åˆ°Signatureï¼Œå¹¶å¯¹æ¯”ä¸¤æ¬¡çš„Signatureæ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¿”å› HTTP 401 Unauthorized é”™è¯¯ï¼›å¦‚æœç›¸ç­‰ï¼Œæ¥ä¸‹æ¥ä¼šåˆ¤æ–­Tokenæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™è¿”å›è®¤è¯ä¸é€šè¿‡ï¼Œå¦åˆ™è®¤è¯é€šè¿‡ã€‚è®¤è¯é€šè¿‡ä¹‹åï¼Œä¼šå°†Payloadä¸­çš„usernameæ·»åŠ åˆ°gin.Contextç±»å‹çš„å˜é‡ä¸­ï¼Œä¾›åé¢çš„ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ã€‚

æˆ‘ç»˜åˆ¶äº†æ•´ä¸ªæµç¨‹çš„ç¤ºæ„å›¾ï¼Œä½ å¯ä»¥å¯¹ç…§ç€å†å›é¡¾ä¸€éã€‚

![img](http://sm.nsddd.top/sm202302231608596.jpeg)



## END é“¾æ¥

<ul><li><div><a href = '17.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '19.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

