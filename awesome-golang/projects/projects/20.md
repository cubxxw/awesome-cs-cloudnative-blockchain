+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬20èŠ‚ æ§åˆ¶æµï¼ˆä¸Šï¼‰ï¼šé€šè¿‡iam-apiserverè®¾è®¡ï¼Œçœ‹WebæœåŠ¡çš„æ„å»º

<br>
<div><a href = '19.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '21.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å¼€å§‹

å‰é¢æˆ‘ä»¬è®²äº†å¾ˆå¤šå…³äºåº”ç”¨æ„å»ºçš„å†…å®¹ï¼Œä½ ä¸€å®šè¿«ä¸åŠå¾…åœ°æƒ³çœ‹ä¸‹IAMé¡¹ç›®çš„åº”ç”¨æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘å°±è®²è§£ä¸‹IAMåº”ç”¨çš„æºç ã€‚

åœ¨è®²è§£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸ä¼šå»è®²è§£å…·ä½“å¦‚ä½•Codeï¼Œä½†ä¼šè®²è§£ä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„é‡ç‚¹ã€éš¾ç‚¹ï¼Œä»¥åŠCodeèƒŒåçš„è®¾è®¡æ€è·¯ã€æƒ³æ³•ã€‚æˆ‘ç›¸ä¿¡è¿™æ˜¯å¯¹ä½ æ›´æœ‰å¸®åŠ©çš„ã€‚

IAMé¡¹ç›®æœ‰å¾ˆå¤šç»„ä»¶ï¼Œè¿™ä¸€è®²ï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸‹IAMé¡¹ç›®çš„é—¨é¢æœåŠ¡ï¼šiam-apiserverï¼ˆç®¡ç†æµæœåŠ¡ï¼‰ã€‚æˆ‘ä¼šå…ˆç»™ä½ ä»‹ç»ä¸‹`iam-apiserver`çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œå†ä»‹ç»ä¸‹iam-apiserverçš„ä»£ç å®ç°ã€‚



## iam-apiserveræœåŠ¡ä»‹ç»

iam-apiserveræ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œé€šè¿‡ä¸€ä¸ªåä¸ºiam-apiserverçš„è¿›ç¨‹ï¼Œå¯¹å¤–æä¾›RESTful APIæ¥å£ï¼Œå®Œæˆç”¨æˆ·ã€å¯†é’¥ã€ç­–ç•¥ä¸‰ç§RESTèµ„æºçš„å¢åˆ æ”¹æŸ¥ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ä¸¤ä¸ªæ–¹é¢æ¥å…·ä½“ä»‹ç»ä¸‹ã€‚



### iam-apiserveråŠŸèƒ½ä»‹ç»

è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iam-apiserveræä¾›çš„RESTful APIæ¥å£ï¼Œæ¥çœ‹ä¸‹iam-apiserverå…·ä½“æä¾›çš„åŠŸèƒ½ã€‚iam-apiserveræä¾›çš„RESTful APIæ¥å£å¯ä»¥åˆ†ä¸ºå››ç±»ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

**è®¤è¯ç›¸å…³æ¥å£**

![å›¾ç‰‡](http://sm.nsddd.top/sm202302271737291.jpeg)

**ç”¨æˆ·ç›¸å…³æ¥å£**

[![å›¾ç‰‡](http://sm.nsddd.top/sm202302271738769.jpeg)](https://static001.geekbang.org/resource/image/60/24/60f8a05f4cb43cbac84c0fb12c40c824.jpg?wh=1920x1314)

**å¯†é’¥ç›¸å…³æ¥å£**

![[å›¾ç‰‡](http://sm.nsddd.top/sm202302271738769.jpeg)](http://sm.nsddd.top/sm202302271737321.jpeg)

**ç­–ç•¥ç›¸å…³æ¥å£**

![å›¾ç‰‡](http://sm.nsddd.top/sm202302271738302.jpeg)

### iam-apiserverä½¿ç”¨æ–¹æ³•ä»‹ç»

ä¸Šé¢æˆ‘ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥å°±ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸åŒçš„å®¢æˆ·ç«¯æ¥è®¿é—® `iam-apiserver`ï¼Œä¾‹å¦‚å‰ç«¯ã€APIè°ƒç”¨ã€SDKã€iamctlç­‰ã€‚è¿™äº›å®¢æˆ·ç«¯æœ€ç»ˆéƒ½ä¼šæ‰§è¡ŒHTTPè¯·æ±‚ï¼Œè°ƒç”¨ `iam-apiserver` æä¾›çš„RESTful APIæ¥å£ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªé¡ºæ‰‹çš„REST APIå®¢æˆ·ç«¯å·¥å…·æ¥æ‰§è¡ŒHTTPè¯·æ±‚ï¼Œå®Œæˆå¼€å‘æµ‹è¯•ã€‚

å› ä¸ºä¸åŒçš„å¼€å‘è€…æ‰§è¡ŒHTTPè¯·æ±‚çš„æ–¹å¼ã€ä¹ æƒ¯ä¸åŒï¼Œä¸ºäº†æ–¹ä¾¿è®²è§£ï¼Œè¿™é‡Œæˆ‘ç»Ÿä¸€é€šè¿‡cURLå·¥å…·æ¥æ‰§è¡ŒHTTPè¯·æ±‚ã€‚æ¥ä¸‹æ¥å…ˆä»‹ç»ä¸‹cURLå·¥å…·ã€‚

æ ‡å‡†çš„Linuxå‘è¡Œç‰ˆéƒ½å®‰è£…äº†cURLå·¥å…·ã€‚cURLå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ŒæˆRESTful APIçš„è°ƒç”¨åœºæ™¯ï¼Œæ¯”å¦‚è®¾ç½®Headerã€æŒ‡å®šHTTPè¯·æ±‚æ–¹æ³•ã€æŒ‡å®šHTTPæ¶ˆæ¯ä½“ã€æŒ‡å®šæƒé™è®¤è¯ä¿¡æ¯ç­‰ã€‚é€šè¿‡`-v`é€‰é¡¹ï¼Œä¹Ÿèƒ½è¾“å‡ºRESTè¯·æ±‚çš„æ‰€æœ‰è¿”å›ä¿¡æ¯ã€‚cURLåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œè¿™é‡Œåˆ—å‡ºcURLå·¥å…·å¸¸ç”¨çš„å‚æ•°ï¼š

```bash
-X/--request [GET|POST|PUT|DELETE|â€¦]  æŒ‡å®šè¯·æ±‚çš„ HTTP æ–¹æ³•
-H/--header                           æŒ‡å®šè¯·æ±‚çš„ HTTP Header
-d/--data                             æŒ‡å®šè¯·æ±‚çš„ HTTP æ¶ˆæ¯ä½“ï¼ˆBodyï¼‰
-v/--verbose                          è¾“å‡ºè¯¦ç»†çš„è¿”å›ä¿¡æ¯
-u/--user                             æŒ‡å®šè´¦å·ã€å¯†ç 
-b/--cookie                           è¯»å– cookie
```

æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨å¸¦UIç•Œé¢çš„å·¥å…·ï¼Œè¿™é‡Œæˆ‘æ¨èä½ ä½¿ç”¨ `Insomnia` ã€‚

`Insomnia`æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„REST APIå®¢æˆ·ç«¯ï¼Œä¸ `Postman`ã€`Apifox`æ˜¯ä¸€ç±»å·¥å…·ï¼Œç”¨äºæ¥å£ç®¡ç†ã€æµ‹è¯•ã€‚`Insomnia`åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

+ å‘é€HTTPè¯·æ±‚ï¼›
+ åˆ›å»ºå·¥ä½œåŒºæˆ–æ–‡ä»¶å¤¹ï¼›
+ å¯¼å…¥å’Œå¯¼å‡ºæ•°æ®ï¼›
+ å¯¼å‡ºcURLæ ¼å¼çš„HTTPè¯·æ±‚å‘½ä»¤ï¼›
+ æ”¯æŒç¼–å†™swaggeræ–‡æ¡£ï¼›
+ å¿«é€Ÿåˆ‡æ¢è¯·æ±‚ï¼›
+ URLç¼–ç å’Œè§£ç ã€‚
+ â€¦



`Insomnia`ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](http://sm.nsddd.top/sm202302271744432.png)

å½“ç„¶äº†ï¼Œä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–ä¼˜ç§€çš„å¸¦UIç•Œé¢çš„REST APIå®¢æˆ·ç«¯ï¼Œä¾‹å¦‚ Postmanã€Apifoxç­‰ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œé€‰æ‹©ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ç”¨å¯¹secretèµ„æºçš„CURDæ“ä½œï¼Œæ¥ç»™ä½ æ¼”ç¤ºä¸‹ **å¦‚ä½•ä½¿ç”¨iam-apiserverçš„åŠŸèƒ½**ã€‚ä½ éœ€è¦æ‰§è¡Œ6æ­¥æ“ä½œã€‚

1. ç™»å½•`iam-apiserver`ï¼Œè·å–tokenã€‚
2. åˆ›å»ºä¸€ä¸ªåä¸º`secret0`çš„secretã€‚
3. è·å–`secret0`çš„è¯¦ç»†ä¿¡æ¯ã€‚
4. æ›´æ–°`secret0`çš„æè¿°ã€‚
5. è·å–`secret`åˆ—è¡¨ã€‚
6. åˆ é™¤`secret0`ã€‚

**ç™»å½•iam-apiserverï¼Œè·å–tokenï¼š**

```bash
$ curl -s -XPOST -H"Authorization: Basic `echo -n 'admin:Admin@2021'|base64`" http://127.0.0.1:8080/login | jq -r .token
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
```

è¿™é‡Œï¼Œä¸ºäº†ä¾¿äºä½¿ç”¨ï¼Œæˆ‘ä»¬å°†tokenè®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼š

```bash
TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
```



**åˆ›å»ºä¸€ä¸ªåä¸ºsecret0çš„secretï¼š**

```bash
$ curl -v -XPOST -H "Content-Type: application/json" -H"Authorization: Bearer ${TOKEN}" -d'{"metadata":{"name":"secret0"},"expires":0,"description":"admin secret"}' http://iam.api.marmotedu.com:8080/v1/secrets
* About to connect() to iam.api.marmotedu.com port 8080 (#0)
*   Trying 127.0.0.1...
* Connected to iam.api.marmotedu.com (127.0.0.1) port 8080 (#0)
> POST /v1/secrets HTTP/1.1
> User-Agent: curl/7.29.0
> Host: iam.api.marmotedu.com:8080
> Accept: */*
> Content-Type: application/json
> Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2MzUwNTk4NDIsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2MjcyODM4NDIsInN1YiI6ImFkbWluIn0.gTS0n-7njLtpCJ7mvSnct2p3TxNTUQaduNXxqqLwGfI
> Content-Length: 72
> 
* upload completely sent off: 72 out of 72 bytes
< HTTP/1.1 200 OK
< Content-Type: application/json; charset=utf-8
< X-Request-Id: ff825bea-53de-4020-8e68-4e87574bd1ba
< Date: Mon, 26 Jul 2021 07:20:26 GMT
< Content-Length: 313
< 
* Connection #0 to host iam.api.marmotedu.com left intact
{"metadata":{"id":60,"instanceID":"secret-jedr3e","name":"secret0","createdAt":"2021-07-26T15:20:26.885+08:00","updatedAt":"2021-07-26T15:20:26.907+08:00"},"username":"admin","secretID":"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD","secretKey":"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf","expires":0,"description":"admin secret"}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¯·æ±‚è¿”å›å¤´ä¸­è¿”å›äº†`X-Request-Id` Headerï¼Œ`X-Request-Id`å”¯ä¸€æ ‡è¯†è¿™æ¬¡è¯·æ±‚ã€‚å¦‚æœè¿™æ¬¡è¯·æ±‚å¤±è´¥ï¼Œå°±å¯ä»¥å°†`X-Request-Id`æä¾›ç»™è¿ç»´æˆ–è€…å¼€å‘ï¼Œé€šè¿‡`X-Request-Id`å®šä½å‡ºå¤±è´¥çš„è¯·æ±‚ï¼Œè¿›è¡Œæ’éšœã€‚å¦å¤–`X-Request-Id`åœ¨å¾®æœåŠ¡åœºæ™¯ä¸­ï¼Œä¹Ÿå¯ä»¥é€ä¼ ç»™å…¶ä»–æœåŠ¡ï¼Œä»è€Œå®ç°è¯·æ±‚è°ƒç”¨é“¾ã€‚



**è·å–secret0çš„è¯¦ç»†ä¿¡æ¯ï¼š**

```bash
$ curl -XGET -H"Authorization: Bearer ${TOKEN}" http://iam.api.marmotedu.com:8080/v1/secrets/secret0
{"metadata":{"id":60,"instanceID":"secret-jedr3e","name":"secret0","createdAt":"2021-07-26T15:20:26+08:00","updatedAt":"2021-07-26T15:20:26+08:00"},"username":"admin","secretID":"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD","secretKey":"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf","expires":0,"description":"admin secret"}
```



**æ›´æ–°secret0çš„æè¿°ï¼š**

```bash
$ curl -XPUT -H"Authorization: Bearer $" -d'{"metadata":{"name":"secret"},"expires":0,"description":"admin secret(modify)"}' http://iam.api.marmotedu.com:8080/v1/secrets/secret0{"metadata":{"id":60,"instanceID":"secret-jedr3e","name":"secret0","createdAt":"2021-07-26T15:20:26+08:00","updatedAt":"2021-07-26T15:23:35.878+08:00"},"username":"admin","secretID":"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD","secretKey":"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf","expires":0,"description":"admin secret(modify)"}
```



**è·å–secretåˆ—è¡¨ï¼š**

```bash
$ curl -XGET -H"Authorization: Bearer ${TOKEN}" http://iam.api.marmotedu.com:8080/v1/secrets
{"totalCount":1,"items":[{"metadata":{"id":60,"instanceID":"secret-jedr3e","name":"secret0","createdAt":"2021-07-26T15:20:26+08:00","updatedAt":"2021-07-26T15:23:35+08:00"},"username":"admin","secretID":"U6CxKs0YVWyOp5GrluychYIRxDmMDFd1mOOD","secretKey":"fubNIn8jLA55ktuuTpXM8Iw5ogdR2mlf","expires":0,"description":"admin secret(modify)"}]}
```



**åˆ é™¤secret0ï¼š**

```
$ curl -XDELETE -H"Authorization: Bearer $" http://iam.api.marmotedu.com:8080/v1/secrets/secret0null
```

ä¸Šé¢ï¼Œæˆ‘ç»™ä½ æ¼”ç¤ºäº†å¯†é’¥çš„ä½¿ç”¨æ–¹æ³•ã€‚ç”¨æˆ·å’Œç­–ç•¥èµ„æºç±»å‹çš„ä½¿ç”¨æ–¹æ³•è·Ÿå¯†é’¥ç±»ä¼¼ã€‚è¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ä½ å¯ä»¥å‚è€ƒ [test.sh](https://github.com/marmotedu/iam/blob/v1.0.6/scripts/install/test.sh) è„šæœ¬ï¼Œè¯¥è„šæœ¬æ˜¯ç”¨æ¥æµ‹è¯•IAMåº”ç”¨çš„ï¼Œé‡Œé¢åŒ…å«äº†å„ä¸ªæ¥å£çš„è¯·æ±‚æ–¹æ³•ã€‚

è¿™é‡Œï¼Œæˆ‘è¿˜æƒ³é¡ºä¾¿ä»‹ç»ä¸‹**å¦‚ä½•æµ‹è¯•IAMåº”ç”¨ä¸­çš„å„ä¸ªéƒ¨åˆ†**ã€‚ç¡®ä¿iam-apiserverã€iam-authz-serverã€iam-pumpç­‰æœåŠ¡æ­£å¸¸è¿è¡Œåï¼Œè¿›å…¥åˆ°IAMé¡¹ç›®çš„æ ¹ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ ./scripts/install/test.sh iam::test::test # æµ‹è¯•æ•´ä¸ªIAMåº”ç”¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
$ ./scripts/install/test.sh iam::test::login # æµ‹è¯•ç™»é™†æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®
$ ./scripts/install/test.sh iam::test::user # æµ‹è¯•ç”¨æˆ·æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®
$ ./scripts/install/test.sh iam::test::secret # æµ‹è¯•å¯†é’¥æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®
$ ./scripts/install/test.sh iam::test::policy # æµ‹è¯•ç­–ç•¥æ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®
$ ./scripts/install/test.sh iam::test::apiserver # æµ‹è¯•iam-apiserveræœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
$ ./scripts/install/test.sh iam::test::authz # æµ‹è¯•authzæ¥å£æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®
$ ./scripts/install/test.sh iam::test::authzserver # æµ‹è¯•iam-authz-serveræœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
$ ./scripts/install/test.sh iam::test::pump # æµ‹è¯•iam-pumpæ˜¯å¦æ­£å¸¸è¿è¡Œ
$ ./scripts/install/test.sh iam::test::iamctl # æµ‹è¯•iamctlå·¥å…·æ˜¯å¦å¯ä»¥æ­£å¸¸ä½¿ç”¨
$ ./scripts/install/test.sh iam::test::man # æµ‹è¯•manæ–‡ä»¶æ˜¯å¦æ­£ç¡®å®‰è£…
```

æ‰€ä»¥ï¼Œæ¯æ¬¡å‘å¸ƒå®Œiam-apiserveråï¼Œä½ å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®Œæˆiam-apiserverçš„å†’çƒŸæµ‹è¯•ï¼š

```bash
$ export IAM_APISERVER_HOST=127.0.0.1 # iam-apiserveréƒ¨ç½²æœåŠ¡å™¨çš„IPåœ°å€
$ export IAM_APISERVER_INSECURE_BIND_PORT=8080 # iam-apiserver HTTPæœåŠ¡çš„ç›‘å¬ç«¯å£
$ ./scripts/install/test.sh iam::test::apiserver
```



## iam-apiserverä»£ç å®ç°

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iam-apiserverå…·ä½“çš„ä»£ç å®ç°ã€‚æˆ‘ä¼šä»é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹ã€è¯·æ±‚å¤„ç†æµç¨‹ã€ä»£ç æ¶æ„4ä¸ªæ–¹é¢æ¥è®²è§£ã€‚

### iam-apiserveré…ç½®å¤„ç†

iam-apiserveræœåŠ¡çš„mainå‡½æ•°ä½äº[apiserver.go](https://github.com/marmotedu/iam/blob/v1.0.4/cmd/iam-apiserver/apiserver.go#L18)æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥è·Ÿè¯»ä»£ç ï¼Œäº†è§£iam-apiserverçš„ä»£ç å®ç°ã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸‹iam-apiserveræœåŠ¡çš„ä¸€äº›è®¾è®¡æ€æƒ³ã€‚

é¦–å…ˆï¼Œæ¥çœ‹ä¸‹iam-apiserverä¸­çš„3ç§é…ç½®ï¼šOptionsé…ç½®ã€åº”ç”¨é…ç½®å’Œ HTTP/GRPCæœåŠ¡é…ç½®ã€‚

+ **Optionsé…ç½®ï¼š**ç”¨æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå®ƒçš„å€¼æ¥è‡ªäºå‘½ä»¤è¡Œé€‰é¡¹æˆ–è€…é…ç½®æ–‡ä»¶ï¼ˆä¹Ÿå¯èƒ½æ˜¯äºŒè€…Mergeåçš„é…ç½®ï¼‰ã€‚Optionså¯ä»¥ç”¨æ¥æ„å»ºåº”ç”¨æ¡†æ¶ï¼ŒOptionsé…ç½®ä¹Ÿæ˜¯åº”ç”¨é…ç½®çš„è¾“å…¥ã€‚
+ **åº”ç”¨****é…ç½®ï¼š**iam-apiserverç»„ä»¶ä¸­éœ€è¦çš„ä¸€åˆ‡é…ç½®ã€‚æœ‰å¾ˆå¤šåœ°æ–¹éœ€è¦é…ç½®ï¼Œä¾‹å¦‚ï¼Œå¯åŠ¨HTTP/GRPCéœ€è¦é…ç½®ç›‘å¬åœ°å€å’Œç«¯å£ï¼Œåˆå§‹åŒ–æ•°æ®åº“éœ€è¦é…ç½®æ•°æ®åº“åœ°å€ã€ç”¨æˆ·åã€å¯†ç ç­‰ã€‚
+ **HTTP/GRPCæœåŠ¡é…ç½®ï¼š**å¯åŠ¨HTTPæœåŠ¡æˆ–è€…GRPCæœåŠ¡éœ€è¦çš„é…ç½®ã€‚

è¿™ä¸‰ç§é…ç½®çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š

![img](http://sm.nsddd.top/sm202302282136791.jpeg)

Optionsé…ç½®æ¥ç®¡å‘½ä»¤è¡Œé€‰é¡¹ï¼Œåº”ç”¨é…ç½®æ¥ç®¡æ•´ä¸ªåº”ç”¨çš„é…ç½®ï¼ŒHTTP/GRPCæœåŠ¡é…ç½®æ¥ç®¡è·ŸHTTP/GRPCæœåŠ¡ç›¸å…³çš„é…ç½®ã€‚è¿™3ç§é…ç½®ç‹¬ç«‹å¼€æ¥ï¼Œå¯ä»¥è§£è€¦å‘½ä»¤è¡Œé€‰é¡¹ã€åº”ç”¨å’Œåº”ç”¨å†…çš„æœåŠ¡ï¼Œä½¿å¾—è¿™3ä¸ªéƒ¨åˆ†å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œåˆä¸ç›¸äº’å½±å“ã€‚

iam-apiserveræ ¹æ®Optionsé…ç½®æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°å’Œåº”ç”¨é…ç½®ã€‚

æˆ‘ä»¬é€šè¿‡`github.com/marmotedu/iam/pkg/app`åŒ…çš„[buildCommand](https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L199)æ–¹æ³•æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ã€‚è¿™é‡Œçš„æ ¸å¿ƒæ˜¯ï¼Œé€šè¿‡[NewApp](https://github.com/marmotedu/iam/blob/v1.0.4/pkg/app/app.go#L157)å‡½æ•°æ„å»ºApplicationå®ä¾‹æ—¶ï¼Œä¼ å…¥çš„[Options](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/options/options.go#L19)å®ç°äº†`Flags() (fss cliflag.NamedFlagSets)`æ–¹æ³•ï¼Œé€šè¿‡buildCommandæ–¹æ³•ä¸­çš„ä»¥ä¸‹ä»£ç ï¼Œå°†optionçš„Flagæ·»åŠ åˆ°cobraå®ä¾‹çš„FlagSetä¸­ï¼š

```go
if a.options != nil {
    namedFlagSets = a.options.Flags()
    fs := cmd.Flags()
    for _, f := range namedFlagSets.FlagSets {
      fs.AddFlagSet(f)
    }

          ...
  }
```

é€šè¿‡[CreateConfigFromOptions](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/config/config.go#L16)å‡½æ•°æ¥æ„å»ºåº”ç”¨é…ç½®ï¼š

```go
cfg, err := config.CreateConfigFromOptions(opts)                      
if err != nil {                                               
    return err                                                
}  
```

æ ¹æ®åº”ç”¨é…ç½®æ¥æ„å»ºHTTP/GRPCæœåŠ¡é…ç½®ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç æ ¹æ®åº”ç”¨é…ç½®ï¼Œæ„å»ºäº†HTTPæœåŠ¡å™¨çš„Addresså‚æ•°ï¼š

```go
func (s *InsecureServingOptions) ApplyTo(c *server.Config) error {
    c.InsecureServing = &server.InsecureServingInfo{
        Address: net.JoinHostPort(s.BindAddress, strconv.Itoa(s.BindPort)),
    }

    return nil
}
```

å…¶ä¸­ï¼Œ`c *server.Config`æ˜¯HTTPæœåŠ¡å™¨çš„é…ç½®ï¼Œ`s *InsecureServingOptions`æ˜¯åº”ç”¨é…ç½®ã€‚



### iam-apiserverå¯åŠ¨æµç¨‹è®¾è®¡

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹iam-apiserverçš„å¯åŠ¨æµç¨‹è®¾è®¡ã€‚å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![img](https://static001.geekbang.org/resource/image/8a/c7/8a94938bc087ed96d0ec87261db292c7.jpg?wh=4770x1487)](https://static001.geekbang.org/resource/image/8a/c7/8a94938bc087ed96d0ec87261db292c7.jpg?wh=4770x1487)

**é¦–å…ˆï¼Œ**é€šè¿‡`opts := options.NewOptions()`åˆ›å»ºå¸¦æœ‰é»˜è®¤å€¼çš„Optionsç±»å‹å˜é‡optsã€‚optså˜é‡ä½œä¸º`github.com/marmotedu/iam/pkg/app`åŒ…çš„`NewApp`å‡½æ•°çš„è¾“å…¥å‚æ•°ï¼Œæœ€ç»ˆåœ¨Appæ¡†æ¶ä¸­ï¼Œè¢«æ¥è‡ªäºå‘½ä»¤è¡Œå‚æ•°æˆ–é…ç½®æ–‡ä»¶çš„é…ç½®ï¼ˆä¹Ÿå¯èƒ½æ˜¯äºŒè€…Mergeåçš„é…ç½®ï¼‰æ‰€å¡«å……ï¼Œoptså˜é‡ä¸­å„ä¸ªå­—æ®µçš„å€¼ä¼šç”¨æ¥åˆ›å»ºåº”ç”¨é…ç½®ã€‚

**æ¥ç€ï¼Œ**ä¼šæ³¨å†Œ[run](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/apiserver.go#L36)å‡½æ•°åˆ°Appæ¡†æ¶ä¸­ã€‚runå‡½æ•°æ˜¯iam-apiserverçš„å¯åŠ¨å‡½æ•°ï¼Œé‡Œé¢å°è£…äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„å¯åŠ¨é€»è¾‘ã€‚runå‡½æ•°ä¸­ï¼Œé¦–å…ˆä¼šåˆå§‹åŒ–æ—¥å¿—åŒ…ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦ï¼Œåœ¨åé¢çš„ä»£ç ä¸­éšæ—¶è®°å½•æ—¥å¿—äº†ã€‚

**ç„¶åï¼Œ**ä¼šåˆ›å»ºåº”ç”¨é…ç½®ã€‚åº”ç”¨é…ç½®å’ŒOptionsé…ç½®å…¶å®æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼ŒäºŒè€…å¯èƒ½å®Œå…¨ä¸åŒï¼Œä½†åœ¨iam-apiserverä¸­ï¼ŒäºŒè€…é…ç½®é¡¹æ˜¯ç›¸åŒçš„ã€‚

**ä¹‹åï¼Œ**æ ¹æ®åº”ç”¨é…ç½®ï¼Œåˆ›å»ºHTTP/GRPCæœåŠ¡å™¨æ‰€ä½¿ç”¨çš„é…ç½®ã€‚åœ¨åˆ›å»ºé…ç½®åï¼Œä¼šå…ˆåˆ†åˆ«è¿›è¡Œé…ç½®è¡¥å…¨ï¼Œå†ä½¿ç”¨è¡¥å…¨åçš„é…ç½®åˆ›å»ºWebæœåŠ¡å®ä¾‹ï¼Œä¾‹å¦‚ï¼š

```go
genericServer, err := genericConfig.Complete().New()
if err != nil {
    return nil, err
}
extraServer, err := extraConfig.complete().New()
if err != nil {
    return nil, err
}
...
func (c *ExtraConfig) complete() *completedExtraConfig {
    if c.Addr == "" {
        c.Addr = "127.0.0.1:8081"
    }

    return &completedExtraConfig{c}
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆè°ƒç”¨`Complete`/`complete`å‡½æ•°è¡¥å…¨é…ç½®ï¼Œå†åŸºäºè¡¥å…¨åçš„é…ç½®ï¼ŒNewä¸€ä¸ªHTTP/GRPCæœåŠ¡å®ä¾‹ã€‚

è¿™é‡Œæœ‰ä¸ªè®¾è®¡æŠ€å·§ï¼š`complete`å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª`*completedExtraConfig`ç±»å‹çš„å®ä¾‹ï¼Œåœ¨åˆ›å»ºGRPCå®ä¾‹æ—¶ï¼Œæ˜¯è°ƒç”¨`completedExtraConfig`ç»“æ„ä½“æä¾›çš„`New`æ–¹æ³•ï¼Œè¿™ç§è®¾è®¡æ–¹æ³•å¯ä»¥ç¡®ä¿æˆ‘ä»¬åˆ›å»ºçš„GRPCå®ä¾‹ä¸€å®šæ˜¯åŸºäºcompleteä¹‹åçš„é…ç½®ï¼ˆcompletedï¼‰ã€‚

åœ¨å®é™…çš„Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ç§æœºåˆ¶æ¥å¤„ç†æˆ–è¡¥å…¨é…ç½®ï¼Œè¿™åœ¨Goé¡¹ç›®å¼€å‘ä¸­æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ­¥éª¤ã€‚

**æœ€åï¼Œ**è°ƒç”¨`PrepareRun`æ–¹æ³•ï¼Œè¿›è¡ŒHTTP/GRPCæœåŠ¡å™¨å¯åŠ¨å‰çš„å‡†å¤‡ã€‚åœ¨å‡†å¤‡å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åšå„ç§åˆå§‹åŒ–æ“ä½œï¼Œä¾‹å¦‚åˆå§‹åŒ–æ•°æ®åº“ï¼Œå®‰è£…ä¸šåŠ¡ç›¸å…³çš„Ginä¸­é—´ä»¶ã€RESTful APIè·¯ç”±ç­‰ã€‚

å®ŒæˆHTTP/GRPCæœåŠ¡å™¨å¯åŠ¨å‰çš„å‡†å¤‡ä¹‹åï¼Œè°ƒç”¨`Run`æ–¹æ³•å¯åŠ¨HTTP/GRPCæœåŠ¡ã€‚åœ¨`Run`æ–¹æ³•ä¸­ï¼Œåˆ†åˆ«å¯åŠ¨äº†GRPCå’ŒHTTPæœåŠ¡ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªiam-apiserverçš„è½¯ä»¶æ¡†æ¶æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚

æœåŠ¡å¯åŠ¨åï¼Œå°±å¯ä»¥å¤„ç†è¯·æ±‚äº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iam-apiserverçš„RESTAPIè¯·æ±‚å¤„ç†æµç¨‹ã€‚



### iam-apiserver çš„REST APIè¯·æ±‚å¤„ç†æµç¨‹

iam-apiserverçš„è¯·æ±‚å¤„ç†æµç¨‹ä¹Ÿæ˜¯æ¸…æ™°ã€è§„èŒƒçš„ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202302282203119.jpeg)

ç»“åˆä¸Šé¢è¿™å¼ å›¾ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹iam-apiserver çš„REST APIè¯·æ±‚å¤„ç†æµç¨‹ï¼Œæ¥å¸®ä½ æ›´å¥½åœ°ç†è§£iam-apiserveræ˜¯å¦‚ä½•å¤„ç†HTTPè¯·æ±‚çš„ã€‚

**é¦–å…ˆï¼Œ**æˆ‘ä»¬é€šè¿‡APIè°ƒç”¨ï¼ˆ`<HTTP Method> + <HTTP Request Path>`ï¼‰è¯·æ±‚iam-apiserveræä¾›çš„RESTful APIæ¥å£ã€‚

**æ¥ç€ï¼Œ**Gin Webæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡è®¤è¯ä¸­é—´ä»¶å®Œæˆè¯·æ±‚çš„è®¤è¯ï¼Œiam-apiserveræä¾›äº†Basicè®¤è¯å’ŒBearerè®¤è¯ä¸¤ç§è®¤è¯æ–¹å¼ã€‚

**è®¤è¯****é€šè¿‡åï¼Œ**è¯·æ±‚ä¼šè¢«æˆ‘ä»¬åŠ è½½çš„ä¸€ç³»åˆ—ä¸­é—´ä»¶æ‰€å¤„ç†ï¼Œä¾‹å¦‚è·¨åŸŸã€RequestIDã€Dumpç­‰ä¸­é—´ä»¶ã€‚

**æœ€åï¼Œ**æ ¹æ®`<HTTP Method> + <HTTP Request Path>`è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¯·æ±‚çš„RESTful APIæ˜¯`POST + /v1/secrets`ï¼ŒGin Webæ¡†æ¶ä¼šæ ¹æ®HTTP Methodå’ŒHTTP Request Pathï¼ŒæŸ¥æ‰¾æ³¨å†Œçš„Controllersï¼Œæœ€ç»ˆåŒ¹é…åˆ°[secretController.Create](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/controller/v1/secret/create.go)Controllerã€‚åœ¨Create Controllerä¸­ï¼Œæˆ‘ä»¬ä¼šä¾æ¬¡æ‰§è¡Œè¯·æ±‚å‚æ•°è§£æã€è¯·æ±‚å‚æ•°æ ¡éªŒã€è°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•åˆ›å»ºSecretã€å¤„ç†ä¸šåŠ¡å±‚çš„è¿”å›ç»“æœï¼Œæœ€åè¿”å›æœ€ç»ˆçš„HTTPè¯·æ±‚ç»“æœã€‚



### iam-apiserverä»£ç æ¶æ„

iam-apiserverä»£ç è®¾è®¡éµå¾ªç®€æ´æ¶æ„è®¾è®¡ï¼Œä¸€ä¸ªç®€æ´æ¶æ„å…·æœ‰ä»¥ä¸‹5ä¸ªç‰¹æ€§ï¼š

+ **ç‹¬ç«‹äºæ¡†æ¶ï¼š**è¯¥æ¶æ„ä¸ä¼šä¾èµ–äºæŸäº›åŠŸèƒ½å¼ºå¤§çš„è½¯ä»¶åº“å­˜åœ¨ã€‚è¿™å¯ä»¥è®©ä½ ä½¿ç”¨è¿™æ ·çš„æ¡†æ¶ä½œä¸ºå·¥å…·ï¼Œè€Œä¸æ˜¯è®©ä½ çš„ç³»ç»Ÿé™·å…¥åˆ°æ¡†æ¶çš„çº¦æŸä¸­ã€‚
+ **å¯æµ‹è¯•æ€§ï¼š**ä¸šåŠ¡è§„åˆ™å¯ä»¥åœ¨æ²¡æœ‰UIã€æ•°æ®åº“ã€WebæœåŠ¡æˆ–å…¶ä»–å¤–éƒ¨å…ƒç´ çš„æƒ…å†µä¸‹è¿›è¡Œæµ‹è¯•ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡Mockæ¥è§£è€¦è¿™äº›ä¾èµ–ã€‚
+ **ç‹¬ç«‹äºUI ï¼š**åœ¨æ— éœ€æ”¹å˜ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼ŒUIå¯ä»¥è½»æ¾åœ°æ”¹å˜ã€‚ä¾‹å¦‚ï¼Œåœ¨æ²¡æœ‰æ”¹å˜ä¸šåŠ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼ŒWeb UIå¯ä»¥æ›¿æ¢ä¸ºæ§åˆ¶å°UIã€‚
+ **ç‹¬ç«‹äºæ•°æ®åº“ï¼š**ä½ å¯ä»¥ç”¨Mongoã€Oracleã€Etcdæˆ–è€…å…¶ä»–æ•°æ®åº“æ¥æ›¿æ¢MariaDBï¼Œä½ çš„ä¸šåŠ¡è§„åˆ™ä¸è¦ç»‘å®šåˆ°æ•°æ®åº“ã€‚
+ **ç‹¬ç«‹äºå¤–éƒ¨åª’ä»‹ï¼š**å®é™…ä¸Šï¼Œä½ çš„ä¸šåŠ¡è§„åˆ™å¯ä»¥ç®€å•åˆ°æ ¹æœ¬ä¸å»äº†è§£å¤–éƒ¨ä¸–ç•Œã€‚

æ‰€ä»¥ï¼ŒåŸºäºè¿™äº›çº¦æŸï¼Œæ¯ä¸€å±‚éƒ½å¿…é¡»æ˜¯ç‹¬ç«‹çš„å’Œå¯æµ‹è¯•çš„ã€‚iam-apiserverä»£ç æ¶æ„åˆ†ä¸º4å±‚ï¼šæ¨¡å‹å±‚ï¼ˆModelsï¼‰ã€æ§åˆ¶å±‚ï¼ˆControllerï¼‰ã€ä¸šåŠ¡å±‚ ï¼ˆServiceï¼‰ã€ä»“åº“å±‚ï¼ˆRepositoryï¼‰ã€‚ä»æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚åˆ°ä»“åº“å±‚ï¼Œä»å·¦åˆ°å³å±‚çº§ä¾æ¬¡åŠ æ·±ã€‚æ¨¡å‹å±‚ç‹¬ç«‹äºå…¶ä»–å±‚ï¼Œå¯ä¾›å…¶ä»–å±‚å¼•ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202302282203289.jpeg)

å±‚ä¸å±‚ä¹‹é—´å¯¼å…¥åŒ…æ—¶ï¼Œéƒ½æœ‰ä¸¥æ ¼çš„å¯¼å…¥å…³ç³»ï¼Œè¿™å¯ä»¥é˜²æ­¢åŒ…çš„å¾ªç¯å¯¼å…¥é—®é¢˜ã€‚å¯¼å…¥å…³ç³»å¦‚ä¸‹ï¼š

+ æ¨¡å‹å±‚çš„åŒ…å¯ä»¥è¢«ä»“åº“å±‚ã€ä¸šåŠ¡å±‚å’Œæ§åˆ¶å±‚å¯¼å…¥ï¼›
+ æ§åˆ¶å±‚èƒ½å¤Ÿå¯¼å…¥ä¸šåŠ¡å±‚å’Œä»“åº“å±‚çš„åŒ…ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œæ§åˆ¶å±‚è¦é¿å…å¯¼å…¥ä»“åº“å±‚çš„åŒ…ï¼Œæ§åˆ¶å±‚éœ€è¦å®Œæˆçš„ä¸šåŠ¡åŠŸèƒ½éƒ½é€šè¿‡ä¸šåŠ¡å±‚æ¥å®Œæˆã€‚è¿™æ ·å¯ä»¥ä½¿ä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ã€è§„èŒƒã€‚
+ ä¸šåŠ¡å±‚èƒ½å¤Ÿå¯¼å…¥ä»“åº“å±‚çš„åŒ…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹ä¸‹æ¯ä¸€å±‚æ‰€å®Œæˆçš„åŠŸèƒ½ï¼Œä»¥åŠå…¶ä¸­çš„ä¸€äº›æ³¨æ„ç‚¹ã€‚


**æ¨¡å‹å±‚ï¼ˆModelsï¼‰**

æ¨¡å‹å±‚åœ¨æœ‰äº›è½¯ä»¶æ¶æ„ä¸­ä¹Ÿå«åšå®ä½“å±‚ï¼ˆEntitiesï¼‰ï¼Œæ¨¡å‹ä¼šåœ¨æ¯ä¸€å±‚ä¸­ä½¿ç”¨ï¼Œåœ¨è¿™ä¸€å±‚ä¸­å­˜å‚¨å¯¹è±¡çš„ç»“æ„å’Œå®ƒçš„æ–¹æ³•ã€‚IAMé¡¹ç›®æ¨¡å‹å±‚ä¸­çš„æ¨¡å‹å­˜æ”¾åœ¨[github.com/marmotedu/api/apiserver/v1](https://github.com/marmotedu/api/tree/master/apiserver/v1)ç›®å½•ä¸‹ï¼Œå®šä¹‰äº†`User`ã€`UserList`ã€`Secret`ã€`SecretList`ã€`Policy`ã€`PolicyList`ã€`AuthzPolicy`æ¨¡å‹åŠå…¶æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```go
type Secret struct {
  // May add TypeMeta in the future.
  // metav1.TypeMeta `json:",inline"`

  // Standard object's metadata.
  metav1.ObjectMeta `       json:"metadata,omitempty"`
  Username          string `json:"username"           gorm:"column:username"  validate:"omitempty"`
  SecretID          string `json:"secretID"           gorm:"column:secretID"  validate:"omitempty"`
  SecretKey         string `json:"secretKey"          gorm:"column:secretKey" validate:"omitempty"`

  // Required: true
  Expires     int64  `json:"expires"     gorm:"column:expires"     validate:"omitempty"`
  Description string `json:"description" gorm:"column:description" validate:"description"`
}
```

ä¹‹æ‰€ä»¥å°†æ¨¡å‹å±‚çš„æ¨¡å‹å­˜æ”¾åœ¨`github.com/marmotedu/api`é¡¹ç›®ä¸­ï¼Œè€Œä¸æ˜¯`github.com/marmotedu/iam`é¡¹ç›®ä¸­ï¼Œæ˜¯ä¸ºäº†è®©è¿™äº›æ¨¡å‹èƒ½å¤Ÿè¢«å…¶ä»–é¡¹ç›®ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œiamçš„æ¨¡å‹å¯ä»¥è¢«`github.com/marmotedu/shippy`åº”ç”¨å¯¼å…¥ã€‚åŒæ ·ï¼Œshippyåº”ç”¨çš„æ¨¡å‹ä¹Ÿå¯ä»¥è¢«iamé¡¹ç›®å¯¼å…¥ï¼Œå¯¼å…¥å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202302282204303.jpeg)

ä¸Šé¢çš„ä¾èµ–å…³ç³»éƒ½æ˜¯å•å‘çš„ï¼Œä¾èµ–å…³ç³»æ¸…æ™°ï¼Œä¸å­˜åœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µã€‚

è¦å¢åŠ shippyçš„æ¨¡å‹å®šä¹‰ï¼Œåªéœ€è¦åœ¨apiç›®å½•ä¸‹åˆ›å»ºæ–°çš„ç›®å½•å³å¯ã€‚ä¾‹å¦‚ï¼Œshippyåº”ç”¨ä¸­æœ‰ä¸€ä¸ªvesselæœåŠ¡ï¼Œå…¶æ¨¡å‹æ‰€åœ¨çš„åŒ…å¯ä»¥ä¸º`github.com/marmotedu/api/vessel`ã€‚

å¦å¤–ï¼Œè¿™é‡Œçš„æ¨¡å‹æ—¢å¯ä»¥ä½œä¸ºæ•°æ®åº“æ¨¡å‹ï¼Œåˆå¯ä»¥ä½œä¸ºAPIæ¥å£çš„è¯·æ±‚æ¨¡å‹ï¼ˆå…¥å‚ã€å‡ºå‚ï¼‰ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿç¡®ä¿**åˆ›å»ºèµ„æºæ—¶çš„å±æ€§**ã€**èµ„æºä¿å­˜åœ¨æ•°æ®åº“ä¸­çš„å±æ€§**ã€**è¿”å›èµ„æºçš„å±æ€§**ä¸‰è€…ä¸€è‡´ï¼Œå°±å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ã€‚é€šè¿‡ä½¿ç”¨åŒä¸€ä¸ªæ¨¡å‹ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ã€æ˜“ç»´æŠ¤ï¼Œå¹¶èƒ½æé«˜å¼€å‘æ•ˆç‡ã€‚å¦‚æœè¿™ä¸‰ä¸ªå±æ€§æœ‰å·®å¼‚ï¼Œä½ å¯ä»¥å¦å¤–æ–°å»ºæ¨¡å‹æ¥é€‚é…ã€‚



**ä»“åº“å±‚ï¼ˆRepository)**

ä»“åº“å±‚ç”¨æ¥è·Ÿæ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡ŒCURDäº¤äº’ï¼Œä½œä¸ºåº”ç”¨ç¨‹åºçš„æ•°æ®å¼•æ“è¿›è¡Œåº”ç”¨æ•°æ®çš„è¾“å…¥å’Œè¾“å‡ºã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä»“åº“å±‚ä»…å¯¹æ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡æ‰§è¡ŒCRUDæ“ä½œï¼Œä¸å°è£…ä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚

ä»“åº“å±‚ä¹Ÿè´Ÿè´£é€‰æ‹©åº”ç”¨ä¸­å°†è¦ä½¿ç”¨ä»€ä¹ˆæ ·çš„æ•°æ®åº“ï¼Œå¯ä»¥æ˜¯MySQLã€MongoDBã€MariaDBã€Etcdç­‰ã€‚æ— è®ºä½¿ç”¨å“ªç§æ•°æ®åº“ï¼Œéƒ½è¦åœ¨è¿™å±‚å†³å®šã€‚ä»“åº“å±‚ä¾èµ–äºè¿æ¥æ•°æ®åº“æˆ–å…¶ä»–ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ã€‚

è¿™ä¸€å±‚ä¹Ÿä¼šèµ·åˆ°æ•°æ®è½¬æ¢çš„ä½œç”¨ï¼šå°†ä»æ•°æ®åº“/å¾®æœåŠ¡ä¸­è·å–çš„æ•°æ®è½¬æ¢ä¸ºæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚èƒ½è¯†åˆ«çš„æ•°æ®ç»“æ„ï¼Œå°†æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚çš„æ•°æ®æ ¼å¼è½¬æ¢ä¸ºæ•°æ®åº“æˆ–å¾®æœåŠ¡èƒ½è¯†åˆ«çš„æ•°æ®æ ¼å¼ã€‚

iam-apiserverçš„ä»“åº“å±‚ä½äº[internal/apiserver/store/mysql](https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/store/mysql)ç›®å½•ä¸‹ï¼Œé‡Œé¢çš„æ–¹æ³•ç”¨æ¥è·ŸMariaDBè¿›è¡Œäº¤äº’ï¼Œå®ŒæˆCURDæ“ä½œï¼Œä¾‹å¦‚ï¼Œä»æ•°æ®åº“ä¸­è·å–å¯†é’¥ï¼š

```go

func (s *secrets) Get(ctx context.Context, username, name string, opts metav1.GetOptions) (*v1.Secret, error) {
    secret := &v1.Secret{}
    err := s.db.Where("username = ? and name= ?", username, name).First(&secret).Error
    if err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            return nil, errors.WithCode(code.ErrSecretNotFound, err.Error())
        }

        return nil, errors.WithCode(code.ErrDatabase, err.Error())
    }

    return secret, nil
}
```



**ä¸šåŠ¡å±‚ (Service)**

ä¸šåŠ¡å±‚ä¸»è¦ç”¨æ¥å®Œæˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç æ”¾åœ¨ä¸šåŠ¡å±‚ã€‚ä¸šåŠ¡å±‚ä¼šå¤„ç†æ¥è‡ªæ§åˆ¶å±‚çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®éœ€è¦è¯·æ±‚ä»“åº“å±‚å®Œæˆæ•°æ®çš„CURDæ“ä½œã€‚ä¸šåŠ¡å±‚åŠŸèƒ½å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![img](http://sm.nsddd.top/sm202302282204294.jpeg)](https://static001.geekbang.org/resource/image/61/b6/6103c58d837fd81769977bc3c947ffb6.jpg?wh=1796x1236)

iam-apiserverçš„ä¸šåŠ¡å±‚ä½äº[internal/apiserver/service](https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/service)ç›®å½•ä¸‹ã€‚ä¸‹é¢æ˜¯iam-apiserverä¸šåŠ¡å±‚ä¸­ï¼Œç”¨æ¥åˆ›å»ºå¯†é’¥çš„å‡½æ•°ï¼š

```go
func (s *secretService) Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error {
    if err := s.store.Secrets().Create(ctx, secret, opts); err != nil {
        return errors.WithCode(code.ErrDatabase, err.Error())
    }

    return nil
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸šåŠ¡å±‚æœ€ç»ˆè¯·æ±‚ä»“åº“å±‚çš„`s.store`çš„`Create`æ–¹æ³•ï¼Œå°†å¯†é’¥ä¿¡æ¯ä¿å­˜åœ¨MariaDBæ•°æ®åº“ä¸­ã€‚



**æ§åˆ¶å±‚ï¼ˆControllerï¼‰**

æ§åˆ¶å±‚æ¥æ”¶HTTPè¯·æ±‚ï¼Œå¹¶è¿›è¡Œå‚æ•°è§£æã€å‚æ•°æ ¡éªŒã€é€»è¾‘åˆ†å‘å¤„ç†ã€è¯·æ±‚è¿”å›è¿™äº›æ“ä½œã€‚æ§åˆ¶å±‚ä¼šå°†é€»è¾‘åˆ†å‘ç»™ä¸šåŠ¡å±‚ï¼Œä¸šåŠ¡å±‚å¤„ç†åè¿”å›ï¼Œè¿”å›æ•°æ®åœ¨æ§åˆ¶å±‚ä¸­è¢«æ•´åˆå†åŠ å·¥ï¼Œæœ€ç»ˆè¿”å›ç»™è¯·æ±‚æ–¹ã€‚æ§åˆ¶å±‚ç›¸å½“äºå®ç°äº†ä¸šåŠ¡è·¯ç”±çš„åŠŸèƒ½ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202302282206659.jpeg)

è¿™é‡Œæˆ‘æœ‰ä¸ªå»ºè®®ï¼Œä¸è¦åœ¨æ§åˆ¶å±‚å†™å¤æ‚çš„ä»£ç ï¼Œå¦‚æœéœ€è¦ï¼Œè¯·å°†è¿™äº›ä»£ç åˆ†å‘åˆ°ä¸šåŠ¡å±‚æˆ–å…¶ä»–åŒ…ä¸­ã€‚

iam-apiserverçš„æ§åˆ¶å±‚ä½äº[internal/apiserver/controller](https://github.com/marmotedu/iam/tree/v1.0.3/internal/apiserver/controller)ç›®å½•ä¸‹ã€‚ä¸‹é¢æ˜¯iam-apiserveræ§åˆ¶å±‚ä¸­åˆ›å»ºå¯†é’¥çš„ä»£ç ï¼š

```go
func (s *SecretHandler) Create(c *gin.Context) {
  log.L(c).Info("create secret function called.")

  var r v1.Secret

  if err := c.ShouldBindJSON(&r); err != nil {
    core.WriteResponse(c, errors.WithCode(code.ErrBind, err.Error()), nil)

    return
  }

  if errs := r.Validate(); len(errs) != 0 {
    core.WriteResponse(c, errors.WithCode(code.ErrValidation, errs.ToAggregate().Error()), nil)

    return
  }

  username := c.GetString(middleware.UsernameKey)

  secrets, err := s.srv.Secrets().List(c, username, metav1.ListOptions{
    Offset: pointer.ToInt64(0),
    Limit:  pointer.ToInt64(-1),
  })
  if err != nil {
    core.WriteResponse(c, errors.WithCode(code.ErrDatabase, err.Error()), nil)

    return
  }

  if secrets.TotalCount >= maxSecretCount {
    core.WriteResponse(c, errors.WithCode(code.ErrReachMaxCount, "secret count: %d", secrets.TotalCount), nil)

    return
  }

  // must reassign username
  r.Username = username

  if err := s.srv.Secrets().Create(c, &r, metav1.CreateOptions{}); err != nil {
    core.WriteResponse(c, err, nil)

    return
  }

  core.WriteResponse(c, nil, r)
}
```

**ä¸Šé¢çš„ä»£ç å®Œæˆäº†ä»¥ä¸‹æ“ä½œï¼š**

1. è§£æHTTPè¯·æ±‚å‚æ•°ã€‚
2. è¿›è¡Œå‚æ•°éªŒè¯ï¼Œè¿™é‡Œå¯ä»¥æ·»åŠ ä¸€äº›ä¸šåŠ¡æ€§è´¨çš„å‚æ•°æ ¡éªŒï¼Œä¾‹å¦‚ï¼š`secrets.TotalCount >= maxSecretCount`ã€‚
3. è°ƒç”¨ä¸šåŠ¡å±‚`s.srv`çš„`Create`æ–¹æ³•ï¼Œå®Œæˆå¯†é’¥çš„åˆ›å»ºã€‚
4. è¿”å›HTTPè¯·æ±‚å‚æ•°ã€‚

ä¸Šé¢ï¼Œæˆ‘ä»¬ä»‹ç»äº†iam-apiserveré‡‡ç”¨çš„4å±‚ç»“æ„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹çœ‹**æ¯ä¸€å±‚ä¹‹é—´æ˜¯å¦‚ä½•é€šä¿¡çš„**ã€‚

é™¤äº†æ¨¡å‹å±‚ï¼Œæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚ã€ä»“åº“å±‚ä¹‹é—´éƒ½æ˜¯é€šè¿‡æ¥å£è¿›è¡Œé€šä¿¡çš„ã€‚é€šè¿‡æ¥å£é€šä¿¡ï¼Œä¸€æ–¹é¢å¯ä»¥ä½¿ç›¸åŒçš„åŠŸèƒ½æ”¯æŒä¸åŒçš„å®ç°ï¼ˆä¹Ÿå°±æ˜¯è¯´å…·æœ‰æ’ä»¶åŒ–èƒ½åŠ›ï¼‰ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä½¿å¾—æ¯ä¸€å±‚çš„ä»£ç å˜å¾—å¯æµ‹è¯•ã€‚

è¿™é‡Œï¼Œæˆ‘ç”¨åˆ›å»ºå¯†é’¥APIè¯·æ±‚çš„ä¾‹å­ï¼Œæ¥ç»™ä½ è®²è§£ä¸‹å±‚ä¸å±‚ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œé€šä¿¡çš„ã€‚

**é¦–å…ˆï¼Œæ¥çœ‹ä¸‹æ§åˆ¶å±‚å¦‚ä½•è·Ÿä¸šåŠ¡å±‚è¿›è¡Œé€šä¿¡ã€‚**

å¯¹å¯†é’¥çš„è¯·æ±‚å¤„ç†éƒ½æ˜¯é€šè¿‡SecretControlleræä¾›çš„æ–¹æ³•æ¥å¤„ç†çš„ï¼Œåˆ›å»ºå¯†é’¥è°ƒç”¨çš„æ˜¯å®ƒçš„`Create`æ–¹æ³•ï¼š

```go
func (s *SecretController) Create(c *gin.Context) {
    ...
  if err := s.srv.Secrets().Create(c, &r, metav1.CreateOptions{}); err != nil {
    core.WriteResponse(c, err, nil)

    return
  }
  ...
}
```

åœ¨`Create`æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†`s.srv.Secrets().Create()`æ¥åˆ›å»ºå¯†é’¥ï¼Œ`s.srv`æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go

type Service interface {
    Users() UserSrv
    Secrets() SecretSrv
    Policies() PolicySrv
}

type SecretSrv interface {                                                             
    Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error    
    Update(ctx context.Context, secret *v1.Secret, opts metav1.UpdateOptions) error            
    Delete(ctx context.Context, username, secretID string, opts metav1.DeleteOptions) error                        
    DeleteCollection(ctx context.Context, username string, secretIDs []string, opts metav1.DeleteOptions) error    
    Get(ctx context.Context, username, secretID string, opts metav1.GetOptions) (*v1.Secret, error)    
    List(ctx context.Context, username string, opts metav1.ListOptions) (*v1.SecretList, error)    
} 
```

å¯ä»¥çœ‹åˆ°ï¼Œæ§åˆ¶å±‚é€šè¿‡ä¸šåŠ¡å±‚æä¾›çš„`Service`æ¥å£ç±»å‹ï¼Œå‰¥ç¦»äº†ä¸šåŠ¡å±‚çš„å…·ä½“å®ç°ã€‚ä¸šåŠ¡å±‚çš„Serviceæ¥å£ç±»å‹æä¾›äº†`Secrets()`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ªå®ç°äº†`SecretSrv`æ¥å£çš„å®ä¾‹ã€‚åœ¨æ§åˆ¶å±‚ä¸­ï¼Œé€šè¿‡è°ƒç”¨è¯¥å®ä¾‹çš„`Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error`æ–¹æ³•æ¥å®Œæˆå¯†é’¥çš„åˆ›å»ºã€‚è‡³äºä¸šåŠ¡å±‚æ˜¯å¦‚ä½•åˆ›å»ºå¯†é’¥çš„ï¼Œæ§åˆ¶å±‚ä¸éœ€è¦çŸ¥é“ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ›å»ºå¯†é’¥å¯ä»¥æœ‰å¤šç§å®ç°ã€‚

è¿™é‡Œä½¿ç”¨åˆ°äº†è®¾è®¡æ¨¡å¼ä¸­çš„**å·¥å‚æ–¹æ³•æ¨¡å¼**ã€‚`Service`æ˜¯å·¥å‚æ¥å£ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ç³»åˆ—åˆ›å»ºå…·ä½“ä¸šåŠ¡å±‚å¯¹è±¡çš„å·¥å‚å‡½æ•°ï¼š`Users()`ã€`Secrets()`ã€`Policies()`ã€‚é€šè¿‡å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œä¸ä»…éšè—äº†ä¸šåŠ¡å±‚å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œè€Œä¸”è¿˜å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨`Service`å·¥å‚æ¥å£å®ç°æ–¹æ³•ä¸­æ·»åŠ æ–°çš„ä¸šåŠ¡å±‚å¯¹è±¡ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³æ–°å¢ä¸€ä¸ª`Template`ä¸šåŠ¡å±‚å¯¹è±¡ï¼Œç”¨æ¥åœ¨iam-apiserverä¸­é¢„ç½®ä¸€äº›ç­–ç•¥æ¨¡æ¿ï¼Œå¯ä»¥è¿™ä¹ˆæ¥åŠ ï¼š

```go

type Service interface {
    Users() UserSrv
    Secrets() SecretSrv
    Policies() PolicySrv
    Templates() TemplateSrv
}

func (s *service) Templates() TemplateSrv {
    return newTemplates(s)
}
```

æ¥ä¸‹æ¥ï¼Œæ–°å»ºä¸€ä¸ª`template.go`æ–‡ä»¶ï¼š

```go
type TemplateSrv interface {
    Create(ctx context.Context, template *v1.Template, opts metav1.CreateOptions) error
    // Other methods
}

type templateService struct {
    store store.Factory
}

var _ TemplateSrv = (*templateService)(nil)

func newTemplates(srv *service) *TemplateService {
    // more create logic
    return &templateService{store: srv.store}
}

func (u *templateService) Create(ctx context.Context, template *v1.Template, opts metav1.CreateOptions) error {
    // normal code

    return nil
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä¸‰æ­¥æ–°å¢äº†ä¸€ä¸ªä¸šåŠ¡å±‚å¯¹è±¡ï¼š

1. åœ¨`Service`æ¥å£å®šä¹‰ä¸­ï¼Œæ–°å¢äº†ä¸€ä¸ªå…¥å£ï¼š`Templates() TemplateSrv`ã€‚
2. åœ¨`service.go`æ–‡ä»¶ä¸­ï¼Œæ–°å¢äº†ä¸€ä¸ªå‡½æ•°ï¼š`Templates()`ã€‚
3. æ–°å»ºäº†`template.go`æ–‡ä»¶ï¼Œåœ¨`template.go`ä¸­å®šä¹‰äº†templateServiceç»“æ„ä½“ï¼Œå¹¶ä¸ºå®ƒå®ç°äº†`TemplateSrv`æ¥å£ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ–°å¢çš„Templateä¸šåŠ¡å¯¹è±¡çš„ä»£ç å‡ ä¹éƒ½é—­ç¯åœ¨`template.go`æ–‡ä»¶ä¸­ã€‚å¯¹å·²æœ‰çš„`Service`å·¥å‚æ¥å£çš„åˆ›å»ºæ–¹æ³•ï¼Œé™¤äº†æ–°å¢ä¸€ä¸ªå·¥å‚æ–¹æ³•`Templates() TemplateSrv`å¤–ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•å…¥ä¾µã€‚è¿™æ ·åšå¯ä»¥é¿å…å½±å“å·²æœ‰ä¸šåŠ¡ã€‚

åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œä½ ä¹Ÿæœ‰å¯èƒ½ä¼šæƒ³åˆ°ä¸‹é¢è¿™ç§é”™è¯¯çš„åˆ›å»ºæ–¹å¼ï¼š

```go
// é”™è¯¯æ–¹æ³•ä¸€
type Service interface {
    UserSrv
    SecretSrv
    PolicySrv
    TemplateSrv
}
```

ä¸Šé¢çš„åˆ›å»ºæ–¹å¼ä¸­ï¼Œæˆ‘ä»¬å¦‚æœæƒ³åˆ›å»ºUserå’ŒSecretï¼Œé‚£åªèƒ½å®šä¹‰ä¸¤ä¸ªä¸åŒçš„æ–¹æ³•ï¼šCreateUserå’Œ CreateSecretï¼Œè¿œæ²¡æœ‰åœ¨Userå’ŒSecretå„è‡ªçš„åŸŸä¸­æä¾›åŒåçš„Createæ–¹æ³•æ¥å¾—ä¼˜é›…ã€‚

IAMé¡¹ç›®ä¸­è¿˜æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿä½¿ç”¨äº†å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œä¾‹å¦‚[Factory](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/store/store.go#L12)å·¥å‚æ¥å£ã€‚

**å†æ¥çœ‹ä¸‹ä¸šåŠ¡å±‚å’Œä»“åº“å±‚æ˜¯å¦‚ä½•é€šä¿¡çš„ã€‚**

ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ä¹Ÿæ˜¯é€šè¿‡æ¥å£æ¥é€šä¿¡çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸šåŠ¡å±‚ä¸­åˆ›å»ºå¯†é’¥çš„ä»£ç å¦‚ä¸‹ï¼š

```go
func (s *secretService) Create(ctx context.Context, secret *v1.Secret, opts metav1.CreateOptions) error {
    if err := s.store.Secrets().Create(ctx, secret, opts); err != nil {
        return errors.WithCode(code.ErrDatabase, err.Error())
    }

    return nil
}
```

`Create`æ–¹æ³•ä¸­è°ƒç”¨äº†`s.store.Secrets().Create()`æ–¹æ³•æ¥å°†å¯†é’¥ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚`s.store`æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```gp
type Factory interface {
    Users() UserStore
    Secrets() SecretStore
    Policies() PolicyStore
    Close() error
}
```

ä¸šåŠ¡å±‚ä¸ä»“åº“å±‚çš„é€šä¿¡å®ç°ï¼Œå’Œæ§åˆ¶å±‚ä¸ä¸šåŠ¡å±‚çš„é€šä¿¡å®ç°ç±»ä¼¼ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œæ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ä¹‹é—´æ˜¯é€šè¿‡æ¥å£æ¥é€šä¿¡çš„ã€‚é€šè¿‡æ¥å£é€šä¿¡æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯ä»¥è®©å„å±‚å˜å¾—å¯æµ‹ã€‚é‚£æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹**å¦‚ä½•æµ‹è¯•å„å±‚çš„ä»£ç **ã€‚å› ä¸º**ç¬¬38è®²**å’Œ**ç¬¬39è®²**ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•æµ‹è¯•Goä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»ä¸‹æµ‹è¯•æ€è·¯ã€‚

1. æ¨¡å‹å±‚

å› ä¸ºæ¨¡å‹å±‚ä¸ä¾èµ–å…¶ä»–ä»»ä½•å±‚ï¼Œæˆ‘ä»¬åªéœ€è¦æµ‹è¯•å…¶ä¸­å®šä¹‰çš„ç»“æ„åŠå…¶å‡½æ•°å’Œæ–¹æ³•å³å¯ã€‚

1. æ§åˆ¶å±‚

æ§åˆ¶å±‚ä¾èµ–äºä¸šåŠ¡å±‚ï¼Œæ„å‘³ç€è¯¥å±‚éœ€è¦ä¸šåŠ¡å±‚æ¥æ”¯æŒæµ‹è¯•ã€‚ä½ å¯ä»¥é€šè¿‡[golang/mock](https://github.com/golang/mock)æ¥mockä¸šåŠ¡å±‚ï¼Œæµ‹è¯•ç”¨ä¾‹å¯å‚è€ƒ[TestUserController_Create](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/controller/v1/user/create_test.go#L19)ã€‚

1. ä¸šåŠ¡å±‚

å› ä¸ºè¯¥å±‚ä¾èµ–äºä»“åº“å±‚ï¼Œæ„å‘³ç€è¯¥å±‚éœ€è¦ä»“åº“å±‚æ¥æ”¯æŒæµ‹è¯•ã€‚æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹æ³•æ¥æ¨¡æ‹Ÿä»“åº“å±‚ï¼š

+ é€šè¿‡`golang/mock`æ¥mockä»“åº“å±‚ã€‚
+ è‡ªå·±å¼€å‘ä¸€ä¸ªfakeä»“åº“å±‚ã€‚

ä½¿ç”¨`golang/mock`çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä½ å¯ä»¥å‚è€ƒ[Test_secretService_Create](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/secret_test.go#L19)ã€‚

fakeçš„ä»“åº“å±‚å¯ä»¥å‚è€ƒ[fake](https://github.com/marmotedu/iam/tree/v1.0.4/internal/apiserver/store/fake)ï¼Œä½¿ç”¨è¯¥fakeä»“åº“å±‚è¿›è¡Œæµ‹è¯•çš„æµ‹è¯•ç”¨ä¾‹ä¸º[ Test_userService_List](https://github.com/marmotedu/iam/blob/v1.0.4/internal/apiserver/service/v1/user_test.go#L76)ã€‚

1. ä»“åº“å±‚

ä»“åº“å±‚ä¾èµ–äºæ•°æ®åº“ï¼Œå¦‚æœè°ƒç”¨äº†å…¶ä»–å¾®æœåŠ¡ï¼Œé‚£è¿˜ä¼šä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡[sqlmock](https://github.com/DATA-DOG/go-sqlmock)æ¥æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ï¼Œé€šè¿‡[httpmock](https://github.com/jarcoal/httpmock)æ¥æ¨¡æ‹ŸHTTPè¯·æ±‚ã€‚



## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†iam-apiserverçš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå®ƒçš„ä»£ç å®ç°ã€‚iam-apiserveræ˜¯ä¸€ä¸ªWebæœåŠ¡ï¼Œæä¾›äº†REST APIæ¥å®Œæˆç”¨æˆ·ã€å¯†é’¥ã€ç­–ç•¥ä¸‰ç§RESTèµ„æºçš„å¢åˆ æ”¹æŸ¥ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡cURLã€Insomniaç­‰å·¥å…·ï¼Œæ¥å®ŒæˆREST APIè¯·æ±‚ã€‚

iam-apiserveråŒ…å«äº†3ç§é…ç½®ï¼šOptionsé…ç½®ã€åº”ç”¨é…ç½®ã€HTTP/GRPCæœåŠ¡é…ç½®ã€‚è¿™ä¸‰ç§é…ç½®åˆ†åˆ«ç”¨æ¥æ„å»ºå‘½ä»¤è¡Œå‚æ•°ã€åº”ç”¨å’ŒHTTP/GRPCæœåŠ¡ã€‚

iam-apiserveråœ¨å¯åŠ¨æ—¶ï¼Œä¼šå…ˆæ„å»ºåº”ç”¨æ¡†æ¶ï¼Œæ¥ç€ä¼šè®¾ç½®åº”ç”¨é€‰é¡¹ï¼Œç„¶åå¯¹åº”ç”¨è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€ååˆ›å»ºHTTP/GRPCæœåŠ¡çš„é…ç½®å’Œå®ä¾‹ï¼Œæœ€ç»ˆå¯åŠ¨HTTP/GRPCæœåŠ¡ã€‚

æœåŠ¡å¯åŠ¨ä¹‹åï¼Œå°±å¯ä»¥æ¥æ”¶HTTPè¯·æ±‚äº†ã€‚ä¸€ä¸ªHTTPè¯·æ±‚ä¼šå…ˆè¿›è¡Œè®¤è¯ï¼Œæ¥ç€ä¼šè¢«æ³¨å†Œçš„ä¸­é—´ä»¶å¤„ç†ï¼Œç„¶åï¼Œä¼šæ ¹æ®`(HTTP Method, HTTP Request Path)`åŒ¹é…åˆ°å¤„ç†å‡½æ•°ã€‚åœ¨å¤„ç†å‡½æ•°ä¸­ï¼Œä¼šè§£æè¯·æ±‚å‚æ•°ã€æ ¡éªŒå‚æ•°ã€è°ƒç”¨ä¸šåŠ¡é€»è¾‘å¤„ç†å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›è¯·æ±‚ç»“æœã€‚

iam-apiserveré‡‡ç”¨äº†ç®€æ´æ¶æ„ï¼Œæ•´ä¸ªåº”ç”¨åˆ†ä¸º4å±‚ï¼šæ¨¡å‹å±‚ã€æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚å’Œä»“åº“å±‚ã€‚æ¨¡å‹å±‚å­˜å‚¨å¯¹è±¡çš„ç»“æ„å’Œå®ƒçš„æ–¹æ³•ï¼›ä»“åº“å±‚ç”¨æ¥è·Ÿæ•°æ®åº“/ç¬¬ä¸‰æ–¹æœåŠ¡è¿›è¡ŒCURDäº¤äº’ï¼›ä¸šåŠ¡å±‚ä¸»è¦ç”¨æ¥å®Œæˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼›æ§åˆ¶å±‚æ¥æ”¶HTTPè¯·æ±‚ï¼Œå¹¶è¿›è¡Œå‚æ•°è§£æã€å‚æ•°æ ¡éªŒã€é€»è¾‘åˆ†å‘å¤„ç†ã€è¯·æ±‚è¿”å›æ“ä½œã€‚æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚ã€ä»“åº“å±‚ä¹‹é—´é€šè¿‡æ¥å£é€šä¿¡ï¼Œé€šè¿‡æ¥å£é€šä¿¡å¯ä»¥ä½¿ç›¸åŒçš„åŠŸèƒ½æ”¯æŒä¸åŒçš„å®ç°ï¼Œå¹¶ä½¿æ¯ä¸€å±‚çš„ä»£ç å˜å¾—å¯æµ‹è¯•ã€‚



## END é“¾æ¥
<ul><li><div><a href = '19.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '21.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

