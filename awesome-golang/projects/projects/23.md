+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬23èŠ‚ æ•°æ®æµï¼šé€šè¿‡iam-authz-serverè®¾è®¡ï¼Œçœ‹æ•°æ®æµæœåŠ¡çš„è®¾è®¡

<br>
<div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]



## å‰è¨€

åœ¨ [28è®²](https://time.geekbang.org/column/article/401190) å’Œ [29è®²](https://time.geekbang.org/column/article/402206) ï¼Œæˆ‘ä»‹ç»äº†IAMçš„æ§åˆ¶æµæœåŠ¡iam-apiserverçš„è®¾è®¡å’Œå®ç°ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹IAMæ•°æ®æµæœåŠ¡iam-authz-serverçš„è®¾è®¡å’Œå®ç°ã€‚

å› ä¸ºiam-authz-serveræ˜¯æ•°æ®æµæœåŠ¡ï¼Œå¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œæ‰€ä»¥é‡‡ç”¨äº†ä¸€äº›æœºåˆ¶æ¥æœ€å¤§åŒ–APIæ¥å£çš„æ€§èƒ½ã€‚å¦å¤–ï¼Œä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œé¿å…é‡å¤é€ è½®å­ï¼Œiam-authz-serverå’Œiam-apiserverå…±äº«äº†å¤§éƒ¨åˆ†çš„åŠŸèƒ½ä»£ç ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•è·Ÿiam-apiserverå…±äº«ä»£ç çš„ï¼Œä»¥åŠiam-authz-serveræ˜¯å¦‚ä½•ä¿è¯APIæ¥å£æ€§èƒ½çš„ã€‚



## iam-authz-serverçš„åŠŸèƒ½ä»‹ç»

iam-authz-serverç›®å‰çš„å”¯ä¸€åŠŸèƒ½ï¼Œæ˜¯é€šè¿‡æä¾› `/v1/authz` RESTful APIæ¥å£å®Œæˆèµ„æºæˆæƒã€‚ `/v1/authz` æ¥å£æ˜¯é€šè¿‡[github.com/ory/ladon](https://github.com/ory/ladon)æ¥å®Œæˆèµ„æºæˆæƒçš„ã€‚

å› ä¸ºiam-authz-serveræ‰¿è½½äº†æ•°æ®æµçš„è¯·æ±‚ï¼Œéœ€è¦ç¡®ä¿APIæ¥å£å…·æœ‰è¾ƒé«˜çš„æ€§èƒ½ã€‚ä¸ºäº†ä¿è¯APIæ¥å£çš„æ€§èƒ½ï¼Œiam-authz-serveråœ¨è®¾è®¡ä¸Šä½¿ç”¨äº†å¤§é‡çš„ç¼“å­˜æŠ€æœ¯ã€‚



### github.com/ory/ladonåŒ…ä»‹ç»

å› ä¸ºiam-authz-serverèµ„æºæˆæƒæ˜¯é€šè¿‡ `github.com/ory/ladon` æ¥å®Œæˆçš„ï¼Œä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£iam-authz-serverçš„æˆæƒç­–ç•¥ï¼Œåœ¨è¿™é‡Œæˆ‘å…ˆä»‹ç»ä¸‹ `github.com/ory/ladon` åŒ…ã€‚

**[Ladon](https://github.com/ory/ladon)æ˜¯ç”¨Goè¯­è¨€ç¼–å†™çš„ç”¨äºå®ç°è®¿é—®æ§åˆ¶ç­–ç•¥çš„åº“ï¼Œç±»ä¼¼äºRBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿï¼ŒRole Based Access Controlï¼‰å’ŒACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ŒAccess Control Listsï¼‰ã€‚ä½†æ˜¯ä¸RBACå’ŒACLç›¸æ¯”ï¼ŒLadonå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨æ›´ä¸ºå¤æ‚çš„ç¯å¢ƒä¸­ï¼ˆä¾‹å¦‚å¤šç§Ÿæˆ·ã€åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå’Œå¤§å‹ç»„ç»‡ï¼‰å·¥ä½œã€‚**

Ladonè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šåœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹ï¼Œè°èƒ½å¤Ÿ/ä¸èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLadonå¼•å…¥äº†æˆæƒç­–ç•¥ã€‚æˆæƒç­–ç•¥æ˜¯ä¸€ä¸ªæœ‰è¯­æ³•è§„èŒƒçš„æ–‡æ¡£ï¼Œè¿™ä¸ªæ–‡æ¡£æè¿°äº†è°åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œã€‚Ladonå¯ä»¥ç”¨è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼Œå»åŒ¹é…è®¾ç½®çš„æˆæƒç­–ç•¥ï¼Œæœ€ç»ˆåˆ¤æ–­å‡ºå½“å‰æˆæƒè¯·æ±‚æ˜¯å¦é€šè¿‡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªLadonçš„æˆæƒç­–ç•¥æ ·ä¾‹ï¼š

```json
{
  "description": "One policy to rule them all.",
  "subjects": ["users:<peter|ken>", "users:maria", "groups:admins"],
  "actions" : ["delete", "<create|update>"],
  "effect": "allow",
  "resources": [
    "resources:articles:<.*>",
    "resources:printer"
  ],
  "conditions": {
    "remoteIP": {
        "type": "CIDRCondition",
        "options": {
            "cidr": "192.168.0.1/16"
        }
    }
  }
}
```

ç­–ç•¥ï¼ˆPolicyï¼‰ç”±è‹¥å¹²å…ƒç´ æ„æˆï¼Œç”¨æ¥æè¿°æˆæƒçš„å…·ä½“ä¿¡æ¯ï¼Œä½ å¯ä»¥æŠŠå®ƒä»¬çœ‹æˆä¸€ç»„è§„åˆ™ã€‚æ ¸å¿ƒå…ƒç´ åŒ…æ‹¬ä¸»é¢˜ï¼ˆSubjectï¼‰ã€æ“ä½œï¼ˆActionï¼‰ã€æ•ˆåŠ›ï¼ˆEffectï¼‰ã€èµ„æºï¼ˆResourceï¼‰ä»¥åŠç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ã€‚å…ƒç´ ä¿ç•™å­—ä»…æ”¯æŒå°å†™ï¼Œå®ƒä»¬åœ¨æè¿°ä¸Šæ²¡æœ‰é¡ºåºè¦æ±‚ã€‚å¯¹äºæ²¡æœ‰ç‰¹å®šçº¦æŸæ¡ä»¶çš„ç­–ç•¥ï¼ŒConditionå…ƒç´ æ˜¯å¯é€‰é¡¹ã€‚ä¸€æ¡ç­–ç•¥åŒ…å«ä¸‹é¢6ä¸ªå…ƒç´ ï¼š

+ ä¸»é¢˜ï¼ˆSubjectï¼‰ï¼Œä¸»é¢˜åæ˜¯å”¯ä¸€çš„ï¼Œä»£è¡¨ä¸€ä¸ªæˆæƒä¸»é¢˜ã€‚ä¾‹å¦‚ï¼Œâ€œkenâ€ or â€œprinter-service.mydomain.comâ€ã€‚
+ æ“ä½œï¼ˆActionï¼‰ï¼Œæè¿°å…è®¸æˆ–æ‹’ç»çš„æ“ä½œã€‚
+ æ•ˆåŠ›ï¼ˆEffectï¼‰ï¼Œæè¿°ç­–ç•¥äº§ç”Ÿçš„ç»“æœæ˜¯â€œå…è®¸â€è¿˜æ˜¯â€œæ‹’ç»â€ï¼ŒåŒ…æ‹¬ allowï¼ˆå…è®¸ï¼‰å’Œ denyï¼ˆæ‹’ç»ï¼‰ã€‚
+ èµ„æºï¼ˆResourceï¼‰ï¼Œæè¿°æˆæƒçš„å…·ä½“æ•°æ®ã€‚
+ ç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ï¼Œæè¿°ç­–ç•¥ç”Ÿæ•ˆçš„çº¦æŸæ¡ä»¶ã€‚
+ æè¿°ï¼ˆDescriptionï¼‰ï¼Œç­–ç•¥çš„æè¿°ã€‚

æœ‰äº†æˆæƒç­–ç•¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼ å…¥è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œç”±Ladonæ¥å†³å®šè¯·æ±‚æ˜¯å¦èƒ½é€šè¿‡æˆæƒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¯·æ±‚ç¤ºä¾‹ï¼š

```json
{
  "subject": "users:peter",
  "action" : "delete",
  "resource": "resources:articles:ladon-introduction",
  "context": {
    "remoteIP": "192.168.0.5"
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ `remoteIP="192.168.0.5"` ç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ä¸‹ï¼Œé’ˆå¯¹ä¸»é¢˜ï¼ˆSubjectï¼‰ `users:peter` å¯¹èµ„æºï¼ˆResourceï¼‰ `resources:articles:ladon-introduction` çš„ `delete` æ“ä½œï¼ˆActionï¼‰ï¼Œæˆæƒç­–ç•¥çš„æ•ˆåŠ›ï¼ˆEffectï¼‰æ˜¯ `allow` çš„ã€‚æ‰€ä»¥Ladonä¼šè¿”å›å¦‚ä¸‹ç»“æœï¼š

```json
{
    "allowed": true
}
```

Ladonæ”¯æŒå¾ˆå¤šConditionï¼Œå…·ä½“è§ä¸‹è¡¨ï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b8/dd/b84d2a1dc0e9ac07605a867594d734dd.jpg?wh=1920x1521)

è‡³äºå¦‚ä½•ä½¿ç”¨è¿™äº›Conditionï¼Œä½ å¯ä»¥å‚è€ƒ [Ladon Conditionä½¿ç”¨ç¤ºä¾‹](https://github.com/marmotedu/geekbang-go/blob/master/LadonConditionä½¿ç”¨ç¤ºä¾‹.md)ã€‚æ­¤å¤–ï¼ŒLadonè¿˜æ”¯æŒè‡ªå®šä¹‰Conditionã€‚

å¦å¤–ï¼ŒLadonè¿˜æ”¯æŒæˆæƒå®¡è®¡ï¼Œç”¨æ¥è®°å½•æˆæƒå†å²ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ladon.Ladonä¸­é™„åŠ ä¸€ä¸ªladon.AuditLoggeræ¥å®ç°ï¼š

```go
import "github.com/ory/ladon"
import manager "github.com/ory/ladon/manager/memory"

func main() {

    warden := ladon.Ladon{
        Manager: manager.NewMemoryManager(),
        AuditLogger: &ladon.AuditLoggerInfo{}
    }

    // ...
}
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†`ladon.AuditLoggerInfo`ï¼Œè¯¥AuditLoggerä¼šåœ¨æˆæƒæ—¶æ‰“å°è°ƒç”¨çš„ç­–ç•¥åˆ°æ ‡å‡†é”™è¯¯ã€‚AuditLoggeræ˜¯ä¸€ä¸ªinterfaceï¼š

```go
// AuditLogger tracks denied and granted authorizations.
type AuditLogger interface {
    LogRejectedAccessRequest(request *Request, pool Policies, deciders Policies)
    LogGrantedAccessRequest(request *Request, pool Policies, deciders Policies)
}
```

è¦å®ç°ä¸€ä¸ªæ–°çš„AuditLoggerï¼Œä½ åªéœ€è¦å®ç°AuditLoggeræ¥å£å°±å¯ä»¥äº†ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªAuditLoggerï¼Œå°†æˆæƒæ—¥å¿—ä¿å­˜åˆ°Redisæˆ–è€…MySQLä¸­ã€‚

Ladonæ”¯æŒè·Ÿè¸ªä¸€äº›æˆæƒæŒ‡æ ‡ï¼Œæ¯”å¦‚ denyã€allowã€not matchã€errorã€‚ä½ å¯ä»¥é€šè¿‡å®ç°`ladon.Metric`æ¥å£ï¼Œæ¥å¯¹è¿™äº›æŒ‡æ ‡è¿›è¡Œå¤„ç†ã€‚`ladon.Metric`æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```go
// Metric is used to expose metrics about authz
type Metric interface {
    // RequestDeniedBy is called when we get explicit deny by policy
    RequestDeniedBy(Request, Policy)
    // RequestAllowedBy is called when a matching policy has been found.
    RequestAllowedBy(Request, Policies)
    // RequestNoMatch is called when no policy has matched our request
    RequestNoMatch(Request)
    // RequestProcessingError is called when unexpected error occured
    RequestProcessingError(Request, Policy, error)
}
```

ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹ï¼Œå°†è¿™äº›æŒ‡æ ‡æš´éœ²ç»™`prometheus`ï¼š

```go
type prometheusMetrics struct{}

func (mtr *prometheusMetrics) RequestDeniedBy(r ladon.Request, p ladon.Policy) {}
func (mtr *prometheusMetrics) RequestAllowedBy(r ladon.Request, policies ladon.Policies) {}
func (mtr *prometheusMetrics) RequestNoMatch(r ladon.Request) {}
func (mtr *prometheusMetrics) RequestProcessingError(r ladon.Request, err error) {}

func main() {

    warden := ladon.Ladon{
        Manager: manager.NewMemoryManager(),
        Metric:  &prometheusMetrics{},
    }

    // ...
}
```

åœ¨ä½¿ç”¨Ladonçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦ä½ æ³¨æ„ï¼š

+ æ‰€æœ‰æ£€æŸ¥éƒ½åŒºåˆ†å¤§å°å†™ï¼Œå› ä¸ºä¸»é¢˜å€¼å¯èƒ½æ˜¯åŒºåˆ†å¤§å°å†™çš„IDã€‚
+ å¦‚æœladon.Ladonæ— æ³•å°†ç­–ç•¥ä¸è¯·æ±‚åŒ¹é…ï¼Œä¼šé»˜è®¤æˆæƒç»“æœä¸ºæ‹’ç»ï¼Œå¹¶è¿”å›é”™è¯¯ã€‚



### iam-authz-serverä½¿ç”¨æ–¹æ³•ä»‹ç»

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†iam-authz-serverçš„èµ„æºæˆæƒåŠŸèƒ½ï¼Œè¿™é‡Œä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨iam-authz-serverï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•è°ƒç”¨ `/v1/authz` æ¥å£å®Œæˆèµ„æºæˆæƒã€‚ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„3å¤§æ­¥éª¤ï¼Œæ¥å®Œæˆèµ„æºæˆæƒè¯·æ±‚ã€‚

**ç¬¬ä¸€æ­¥ï¼Œç™»é™† iam-apiserverï¼Œåˆ›å»ºæˆæƒç­–ç•¥å’Œå¯†é’¥ã€‚**

è¿™ä¸€æ­¥åˆåˆ†ä¸º3ä¸ªå°æ­¥éª¤ã€‚

1. ç™»é™†iam-apiserverç³»ç»Ÿï¼Œè·å–è®¿é—®ä»¤ç‰Œï¼š

```bash
$ token=`curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login | jq -r .token`
```

2. åˆ›å»ºæˆæƒç­–ç•¥ï¼š

```shell
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.*>","resources:printer"],"conditions":{"remoteIP":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies
```

3. åˆ›å»ºå¯†é’¥ï¼Œå¹¶ä»è¯·æ±‚ç»“æœä¸­æå–secretID å’Œ secretKeyï¼š

```shell
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}' http://127.0.0.1:8080/v1/secrets
{"metadata":{"id":23,"name":"authztest","createdAt":"2021-04-08T07:24:50.071671422+08:00","updatedAt":"2021-04-08T07:24:50.071671422+08:00"},"username":"admin","secretID":"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox","secretKey":"7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8","expires":0,"description":"admin secret"}
```



**ç¬¬äºŒæ­¥ï¼Œç”Ÿæˆè®¿é—® iam-authz-serverçš„ tokenã€‚**

iamctl æä¾›äº† `jwt sigin` å­å‘½ä»¤ï¼Œå¯ä»¥æ ¹æ® secretID å’Œ secretKey ç­¾å‘ Tokenï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚

```shell
$ iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 # iamctl jwt sign $secretID $secretKey
eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
```

ä½ å¯ä»¥é€šè¿‡ `iamctl jwt show <token>` æ¥æŸ¥çœ‹Tokençš„å†…å®¹ï¼š

```shell
$ iamctl jwt show eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
Header:
{
    "alg": "HS256",
    "kid": "ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox",
    "typ": "JWT"
}
Claims:
{
    "aud": "iam.authz.marmotedu.com",
    "exp": 1617845195,
    "iat": 1617837995,
    "iss": "iamctl",
    "nbf": 1617837995
}
```



**æˆ‘ä»¬ç”Ÿæˆçš„TokenåŒ…å«äº†ä¸‹é¢è¿™äº›ä¿¡æ¯ï¼š**

**Header**

+ `alg`ï¼šç”Ÿæˆç­¾åçš„ç®—æ³•ã€‚
+ `kid`ï¼šå¯†é’¥IDã€‚
+ `typ`ï¼šTokençš„ç±»å‹ï¼Œè¿™é‡Œæ˜¯JWTã€‚

**Claims**

+ `aud`ï¼šJWT Tokençš„æ¥å—è€…ã€‚
+ `exp`ï¼šJWT Tokençš„è¿‡æœŸæ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ã€‚
+ `iat`ï¼šJWT Tokençš„ç­¾å‘æ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ã€‚
+ `iss`ï¼šç­¾å‘è€…ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ç”¨ iamctl å·¥å…·ç­¾å‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç­¾å‘è€…æ˜¯ iamctlã€‚
+ `nbf`ï¼šJWT Tokençš„ç”Ÿæ•ˆæ—¶é—´ï¼ˆUNIXæ—¶é—´æ ¼å¼ï¼‰ï¼Œé»˜è®¤æ˜¯ç­¾å‘æ—¶é—´ã€‚



**ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨ `/v1/authz`æ¥å£ï¼Œå®Œæˆèµ„æºæˆæƒè¯·æ±‚ã€‚**

è¯·æ±‚æ–¹æ³•å¦‚ä¸‹ï¼š

```shell
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ' -d'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIP":"192.168.0.5"}}' http://127.0.0.1:9090/v1/authz
{"allowed":true}
```

å¦‚æœæˆæƒé€šè¿‡ï¼Œä¼šè¿”å›ï¼š`{"allowed":true}` ã€‚ å¦‚æœæˆæƒå¤±è´¥ï¼Œåˆ™è¿”å›ï¼š

```shell
{"allowed":false,"denied":true,"reason":"Request was denied by default"}
```



## iam-authz-serverçš„ä»£ç å®ç°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹iam-authz-serverçš„å…·ä½“å®ç°ï¼Œæˆ‘ä¼šä»é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹ã€è¯·æ±‚å¤„ç†æµç¨‹å’Œä»£ç æ¶æ„4ä¸ªæ–¹é¢æ¥è®²è§£ã€‚



### iam-authz-serverçš„é…ç½®å¤„ç†

iam-authz-serveræœåŠ¡çš„mainå‡½æ•°ä½äº[authzserver.go](https://github.com/marmotedu/iam/blob/v1.0.4/cmd/iam-authz-server/authzserver.go)æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥è·Ÿè¯»ä»£ç ï¼Œäº†è§£iam-authz-serverçš„ä»£ç å®ç°ã€‚iam-authz-serverçš„æœåŠ¡æ¡†æ¶è®¾è®¡è·Ÿiam-apiserverçš„æœåŠ¡æ¡†æ¶è®¾è®¡ä¿æŒä¸€è‡´ï¼Œä¹Ÿæ˜¯æœ‰3ç§é…ç½®ï¼šOptionsé…ç½®ã€ç»„ä»¶é…ç½®å’ŒHTTPæœåŠ¡é…ç½®ã€‚

**Optionsé…ç½®è§[options.go](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/options/options.go)æ–‡ä»¶ï¼š**

```go

type Options struct {
    RPCServer               string
    ClientCA                string
    GenericServerRunOptions *genericoptions.ServerRunOptions
    InsecureServing         *genericoptions.InsecureServingOptions
    SecureServing           *genericoptions.SecureServingOptions
    RedisOptions            *genericoptions.RedisOptions
    FeatureOptions          *genericoptions.FeatureOptions
    Log                     *log.Options
    AnalyticsOptions        *analytics.AnalyticsOptions
}
```

å’Œiam-apiserverç›¸æ¯”ï¼Œiam-authz-serverå¤šäº† `AnalyticsOptions`ï¼Œç”¨æ¥é…ç½®iam-authz-serverå†…çš„AnalyticsæœåŠ¡ï¼ŒAnalyticsæœåŠ¡ä¼šå°†æˆæƒæ—¥å¿—å¼‚æ­¥å†™å…¥åˆ°Redisä¸­ã€‚

iam-apiserverå’Œiam-authz-serverå…±ç”¨äº†GenericServerRunOptionsã€InsecureServingã€SecureServingã€FeatureOptionsã€RedisOptionsã€Logè¿™äº›é…ç½®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥å°†å¾ˆå¤šé…ç½®é¡¹éƒ½å¼•å…¥åˆ°iam-authz-serverçš„å‘½ä»¤è¡Œå‚æ•°ä¸­ï¼Œè¿™ä¹Ÿæ˜¯å‘½ä»¤è¡Œå‚æ•°åˆ†ç»„å¸¦æ¥çš„å¥½å¤„ï¼šæ‰¹é‡å…±äº«ã€‚



### iam-authz-serverå¯åŠ¨æµç¨‹è®¾è®¡

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹iam-authz-serverçš„å¯åŠ¨æµç¨‹ã€‚

iam-authz-serverçš„å¯åŠ¨æµç¨‹ä¹Ÿå’Œiam-apiserveråŸºæœ¬ä¿æŒä¸€è‡´ã€‚äºŒè€…æ¯”è¾ƒå¤§çš„ä¸åŒåœ¨äºOptionså‚æ•°é…ç½®å’Œåº”ç”¨åˆå§‹åŒ–å†…å®¹ã€‚å¦å¤–ï¼Œå’Œiam-apiserverç›¸æ¯”ï¼Œiam-authz-serveråªæä¾›äº†REST APIæœåŠ¡ã€‚å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042314376.jpeg)



### iam-authz-server çš„ RESTful APIè¯·æ±‚å¤„ç†æµç¨‹

iam-authz-serverçš„è¯·æ±‚å¤„ç†æµç¨‹ä¹Ÿæ˜¯æ¸…æ™°ã€è§„èŒƒçš„ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042314667.jpeg)

**é¦–å…ˆï¼Œ**æˆ‘ä»¬é€šè¿‡APIè°ƒç”¨ï¼ˆ`<HTTP Method> + <HTTP Request Path>`ï¼‰è¯·æ±‚iam-authz-serveræä¾›çš„RESTful APIæ¥å£ `POST /v1/authz` ã€‚

**æ¥ç€ï¼Œ**Gin Webæ¡†æ¶æ¥æ”¶åˆ°HTTPè¯·æ±‚ä¹‹åï¼Œä¼šé€šè¿‡è®¤è¯ä¸­é—´ä»¶å®Œæˆè¯·æ±‚çš„è®¤è¯ï¼Œiam-authz-serveré‡‡ç”¨äº†Bearerè®¤è¯æ–¹å¼ã€‚

**ç„¶åï¼Œ**è¯·æ±‚ä¼šè¢«æˆ‘ä»¬åŠ è½½çš„ä¸€ç³»åˆ—ä¸­é—´ä»¶æ‰€å¤„ç†ï¼Œä¾‹å¦‚è·¨åŸŸã€RequestIDã€Dumpç­‰ä¸­é—´ä»¶ã€‚

**æœ€åï¼Œ**æ ¹æ®`<HTTP Method> + <HTTP Request Path>`è¿›è¡Œè·¯ç”±åŒ¹é…ã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬è¯·æ±‚çš„RESTful APIæ˜¯`POST /v1/authz`ï¼ŒGin Webæ¡†æ¶ä¼šæ ¹æ® HTTP Method å’Œ HTTP Request Pathï¼ŒæŸ¥æ‰¾æ³¨å†Œçš„Controllersï¼Œæœ€ç»ˆåŒ¹é…åˆ° [authzController.Authorize](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/controller/v1/authorize/authorize.go#L33) Controllerã€‚åœ¨ Authorize Controllerä¸­ï¼Œä¼šå…ˆè§£æè¯·æ±‚å‚æ•°ï¼Œæ¥ç€æ ¡éªŒè¯·æ±‚å‚æ•°ã€è°ƒç”¨ä¸šåŠ¡å±‚çš„æ–¹æ³•è¿›è¡Œèµ„æºæˆæƒï¼Œæœ€åå¤„ç†ä¸šåŠ¡å±‚çš„è¿”å›ç»“æœï¼Œè¿”å›æœ€ç»ˆçš„ HTTP è¯·æ±‚ç»“æœã€‚



### iam-authz-serverçš„ä»£ç æ¶æ„

iam-authz-serverçš„ä»£ç è®¾è®¡å’Œiam-apiserverä¸€æ ·ï¼Œéµå¾ªç®€æ´æ¶æ„è®¾è®¡ã€‚

iam-authz-serverçš„ä»£ç æ¶æ„ä¹Ÿåˆ†ä¸º4å±‚ï¼Œåˆ†åˆ«æ˜¯

+ æ¨¡å‹å±‚ï¼ˆModelsï¼‰
+ æ§åˆ¶å±‚ï¼ˆControllerï¼‰
+ ä¸šåŠ¡å±‚ ï¼ˆServiceï¼‰
+ ä»“åº“å±‚ï¼ˆRepositoryï¼‰

ä»æ§åˆ¶å±‚ã€ä¸šåŠ¡å±‚åˆ°ä»“åº“å±‚ï¼Œä»å·¦åˆ°å³å±‚çº§ä¾æ¬¡åŠ æ·±ã€‚æ¨¡å‹å±‚ç‹¬ç«‹äºå…¶ä»–å±‚ï¼Œå¯ä¾›å…¶ä»–å±‚å¼•ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042315040.jpeg)

iam-authz-server å’Œ iam-apiserver çš„ä»£ç æ¶æ„æœ‰è¿™ä¸‰ç‚¹ä¸åŒï¼š

+ iam-authz-server å®¢æˆ·ç«¯ä¸æ”¯æŒå‰ç«¯å’Œå‘½ä»¤è¡Œã€‚
+ iam-authz-server ä»“åº“å±‚å¯¹æ¥çš„æ˜¯iam-apiserverå¾®æœåŠ¡ï¼Œè€Œéæ•°æ®åº“ã€‚
+ iam-authz-server ä¸šåŠ¡å±‚çš„ä»£ç å­˜æ”¾åœ¨ç›®å½•[authorization](https://github.com/marmotedu/iam/tree/v1.0.4/internal/authzserver/authorization)ä¸­ã€‚



## iam-authz-serverå…³é”®ä»£ç åˆ†æ

å’Œ iam-apiserver ä¸€æ ·ï¼Œ`iam-authz-server` ä¹ŸåŒ…å«äº†ä¸€äº›ä¼˜ç§€çš„è®¾è®¡æ€è·¯å’Œå…³é”®ä»£ç ï¼Œè¿™é‡Œæˆ‘æ¥ä¸€ä¸€ä»‹ç»ä¸‹ã€‚



### èµ„æºæˆæƒ

å…ˆæ¥çœ‹ä¸‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•å®ç°èµ„æºæˆæƒçš„ã€‚

æˆ‘ä»¬å¯ä»¥è°ƒç”¨iam-authz-serverçš„ `/v1/authz` APIæ¥å£ï¼Œå®ç°èµ„æºçš„è®¿é—®æˆæƒã€‚ `/v1/authz` å¯¹åº”çš„controlleræ–¹æ³•æ˜¯[Authorize](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/controller/v1/authorize/authorize.go#L33)ï¼š

```go
func (a *AuthzController) Authorize(c *gin.Context) {
  var r ladon.Request
  if err := c.ShouldBind(&r); err != nil {
    core.WriteResponse(c, errors.WithCode(code.ErrBind, err.Error()), nil)

    return
  }

  auth := authorization.NewAuthorizer(authorizer.NewAuthorization(a.store))
  if r.Context == nil {
    r.Context = ladon.Context{}
  }

  r.Context["username"] = c.GetString("username")
  rsp := auth.Authorize(&r)

  core.WriteResponse(c, nil, rsp)
}
```

è¯¥å‡½æ•°ä½¿ç”¨ `github.com/ory/ladon` åŒ…è¿›è¡Œèµ„æºè®¿é—®æˆæƒï¼Œæˆæƒæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042316433.jpeg)

**å…·ä½“åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š**

ç¬¬ä¸€æ­¥ï¼Œåœ¨Authorizeæ–¹æ³•ä¸­è°ƒç”¨ `c.ShouldBind(&r)` ï¼Œå°†APIè¯·æ±‚å‚æ•°è§£æåˆ° `ladon.Request` ç±»å‹çš„ç»“æ„ä½“å˜é‡ä¸­ã€‚

ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨[authorization.NewAuthorizer](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L21)å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåˆ›å»ºå¹¶è¿”å›åŒ…å«Managerå’ŒAuditLoggerå­—æ®µçš„[Authorizer](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L16)ç±»å‹çš„å˜é‡ã€‚

ManageråŒ…å«ä¸€äº›å‡½æ•°ï¼Œæ¯”å¦‚ Createã€Updateå’ŒFindRequestCandidatesç­‰ï¼Œç”¨æ¥å¯¹æˆæƒç­–ç•¥è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚AuditLoggeråŒ…å« LogRejectedAccessRequest å’Œ LogGrantedAccessRequest å‡½æ•°ï¼Œåˆ†åˆ«ç”¨æ¥è®°å½•è¢«æ‹’ç»çš„æˆæƒè¯·æ±‚å’Œè¢«å…è®¸çš„æˆæƒè¯·æ±‚ï¼Œå°†å…¶ä½œä¸ºå®¡è®¡æ•°æ®ä½¿ç”¨ã€‚

ç¬¬ä¸‰æ­¥ï¼Œè°ƒç”¨[auth.Authorize](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/authorizer.go#L31)å‡½æ•°ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè®¿é—®æˆæƒã€‚auth.Authorizeå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š

```go
func (a *Authorizer) Authorize(request *ladon.Request) *authzv1.Response {
  log.Debug("authorize request", log.Any("request", request))

  if err := a.warden.IsAllowed(request); err != nil {
    return &authzv1.Response{
      Denied: true,
      Reason: err.Error(),
    }
  }

  return &authzv1.Response{
    Allowed: true,
  }
}
```

è¯¥å‡½æ•°ä¼šè°ƒç”¨ `a.warden.IsAllowed(request)` å®Œæˆèµ„æºè®¿é—®æˆæƒã€‚IsAllowedå‡½æ•°ä¼šè°ƒç”¨ `FindRequestCandidates(r)` æŸ¥è¯¢æ‰€æœ‰çš„ç­–ç•¥åˆ—è¡¨ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œæˆ‘ä»¬åªéœ€è¦æŸ¥è¯¢è¯·æ±‚ç”¨æˆ·çš„policyåˆ—è¡¨ã€‚åœ¨Authorizeå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°†usernameå­˜å…¥ladon Requestçš„contextä¸­ï¼š

```go
r.Context["username"] = c.GetHeader("username")
```

åœ¨[FindRequestCandidates](https://github.com/marmotedu/iam/blob/v1.0.4/internal/authzserver/authorization/manager.go#L54)å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»Requestä¸­å–å‡ºusernameï¼Œå¹¶æ ¹æ®usernameæŸ¥è¯¢ç¼“å­˜ä¸­çš„policyåˆ—è¡¨ï¼ŒFindRequestCandidateså®ç°å¦‚ä¸‹ï¼š

```go

func (m *PolicyManager) FindRequestCandidates(r *ladon.Request) (ladon.Policies, error) {
    username := ""
  
    if user, ok := r.Context["username"].(string); ok {
      username = user
    }
  
    policies, err := m.client.List(username)
    if err != nil {
      return nil, errors.Wrap(err, "list policies failed")
    }
  
    ret := make([]ladon.Policy, 0, len(policies))
    for _, policy := range policies {
      ret = append(ret, policy)
    }
  
    return ret, nil
  }
```

IsAllowedå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š

```go
func (l *Ladon) IsAllowed(r *Request) (err error) {
    policies, err := l.Manager.FindRequestCandidates(r)
    if err != nil {
        go l.metric().RequestProcessingError(*r, nil, err)
        return err
    }

    return l.DoPoliciesAllow(r, policies)
}
```

IsAllowedä¼šè°ƒç”¨ `DoPoliciesAllow(r, policies)` å‡½æ•°è¿›è¡Œæƒé™æ ¡éªŒã€‚å¦‚æœæƒé™æ ¡éªŒä¸é€šè¿‡ï¼ˆè¯·æ±‚åœ¨æŒ‡å®šæ¡ä»¶ä¸‹ä¸èƒ½å¤Ÿå¯¹èµ„æºåšæŒ‡å®šæ“ä½œï¼‰ï¼Œå°±è°ƒç”¨ `LogRejectedAccessRequest` å‡½æ•°è®°å½•æ‹’ç»çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å€¼ä¸ºénilçš„errorï¼Œerrorä¸­è®°å½•äº†æˆæƒå¤±è´¥çš„é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæƒé™æ ¡éªŒé€šè¿‡ï¼Œåˆ™è°ƒç”¨ `LogGrantedAccessRequest` å‡½æ•°è®°å½•å…è®¸çš„è¯·æ±‚ï¼Œå¹¶è¿”å›å€¼ä¸ºnilçš„errorã€‚

ä¸ºäº†é™ä½è¯·æ±‚å»¶æ—¶ï¼ŒLogRejectedAccessRequestå’ŒLogGrantedAccessRequestä¼šå°†æˆæƒè®°å½•å­˜å‚¨åœ¨Redisä¸­ï¼Œä¹‹åç”±iam-pumpè¿›ç¨‹è¯»å–Redisï¼Œå¹¶å°†æˆæƒè®°å½•æŒä¹…åŒ–å­˜å‚¨åœ¨MongoDBä¸­ã€‚



### ç¼“å­˜è®¾è®¡

iam-authz-serverä¸»è¦ç”¨æ¥åšèµ„æºè®¿é—®æˆæƒï¼Œå±äºæ•°æ®æµçš„ç»„ä»¶ï¼Œå¯¹æ¥å£è®¿é—®æ€§èƒ½æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œæ‰€ä»¥è¯¥ç»„ä»¶é‡‡ç”¨äº†ç¼“å­˜çš„æœºåˆ¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042320793.jpeg)

iam-authz-serverç»„ä»¶é€šè¿‡**ç¼“å­˜å¯†é’¥å’Œæˆæƒç­–ç•¥ä¿¡æ¯**åˆ°å†…å­˜ä¸­ï¼ŒåŠ å¿«å¯†é’¥å’Œæˆæƒç­–ç•¥çš„æŸ¥è¯¢é€Ÿåº¦ã€‚é€šè¿‡**ç¼“å­˜æˆæƒè®°å½•**åˆ°å†…å­˜ä¸­ï¼Œæé«˜äº†æˆæƒæ•°æ®çš„å†™å…¥é€Ÿåº¦ï¼Œä»è€Œå¤§å¤§é™ä½äº†æˆæƒè¯·æ±‚æ¥å£çš„å»¶æ—¶ã€‚

ä¸Šé¢çš„ç¼“å­˜æœºåˆ¶ç”¨åˆ°äº†Redis key-valueå­˜å‚¨ï¼Œæ‰€ä»¥åœ¨iam-authz-serveråˆå§‹åŒ–é˜¶æ®µï¼Œéœ€è¦å…ˆå»ºç«‹Redisè¿æ¥ï¼ˆä½äº[initialize](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/server.go#L132)å‡½æ•°ä¸­ï¼‰ï¼š

```go
go storage.ConnectToRedis(ctx, s.buildStorageConfig())
```

è¿™ä¸ªä»£ç ä¼šç»´æŠ¤ä¸€ä¸ªRedisè¿æ¥ï¼Œå¦‚æœRedisè¿æ¥æ–­æ‰ï¼Œä¼šå°è¯•é‡è¿ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä½¿æˆ‘ä»¬åœ¨è°ƒç”¨Redisæ¥å£è¿›è¡Œæ•°æ®è¯»å†™æ—¶ï¼Œä¸ç”¨è€ƒè™‘è¿æ¥æ–­å¼€çš„é—®é¢˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥è¯¦ç»†çœ‹çœ‹ï¼Œiam-authz-serveræ˜¯å¦‚ä½•å®ç°ç¼“å­˜æœºåˆ¶çš„ã€‚

**å…ˆæ¥çœ‹ä¸‹å¯†é’¥å’Œç­–ç•¥ç¼“å­˜ã€‚**

iam-authz-serveré€šè¿‡[load](https://github.com/marmotedu/iam/tree/v1.0.5/internal/authzserver/load)åŒ…æ¥å®Œæˆå¯†é’¥å’Œç­–ç•¥çš„ç¼“å­˜ã€‚

åœ¨iam-authz-serverè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªLoadæœåŠ¡ï¼ˆä½äº[initialize](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/server.go#L144)å‡½æ•°ä¸­ï¼‰ï¼š

```go
load.NewLoader(ctx, cacheIns).Start() 
```

**å…ˆæ¥çœ‹åˆ›å»ºLoadæœåŠ¡ã€‚**åˆ›å»ºLoadæœåŠ¡æ—¶ï¼Œä¼ å…¥äº†cacheInså‚æ•°ï¼ŒcacheInsæ˜¯ä¸€ä¸ªå®ç°äº†[Loader](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L16)æ¥å£çš„å®ä¾‹ï¼š

```go
type Loader interface {
    Reload() error
}
```

**ç„¶åçœ‹å¯åŠ¨LoadæœåŠ¡ã€‚**é€šè¿‡Loadå®ä¾‹çš„ [Start](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L37) æ–¹æ³•æ¥å¯åŠ¨LoadæœåŠ¡ï¼š

```go
func (l *Load) Start() {
    go startPubSubLoop()
    go l.reloadQueueLoop()
    go l.reloadLoop()

    l.DoReload()
}
```

Startå‡½æ•°å…ˆå¯åŠ¨äº†3ä¸ªåç¨‹ï¼Œå†è°ƒç”¨ `l.DoReload()` å®Œæˆä¸€æ¬¡å¯†é’¥å’Œç­–ç•¥çš„åŒæ­¥ï¼š

```go
func (l *Load) DoReload() {
    l.lock.Lock()
    defer l.lock.Unlock()

    if err := l.loader.Reload(); err != nil {
        log.Errorf("faild to refresh target storage: %s", err.Error())
    }

    log.Debug("refresh target storage succ")
}
```

ä¸Šé¢æˆ‘ä»¬è¯´äº†ï¼Œåˆ›å»ºLoadæœåŠ¡æ—¶ï¼Œä¼ å…¥çš„cacheInså®ä¾‹æ˜¯ä¸€ä¸ªå®ç°äº†Loaderæ¥å£çš„å®ä¾‹ï¼Œæ‰€ä»¥åœ¨[DoReload](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L119)æ–¹æ³•ä¸­ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨Reloadæ–¹æ³•ã€‚cacheInsçš„Reloadæ–¹æ³•ä¼šä»iam-apiserverä¸­åŒæ­¥å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯åˆ°iam-authz-serverç¼“å­˜ä¸­ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸‹ï¼ŒstartPubSubLoopã€reloadQueueLoopã€reloadLoop è¿™3ä¸ªGoåç¨‹åˆ†åˆ«å®Œæˆäº†ä»€ä¹ˆåŠŸèƒ½ã€‚



#### startPubSubLoopåç¨‹

[startPubSubLoop](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L46)å‡½æ•°é€šè¿‡[StartPubSubHandler](https://github.com/marmotedu/iam/blob/v1.0.5/pkg/storage/redis_cluster.go#L897)å‡½æ•°ï¼Œè®¢é˜…Redisçš„ `iam.cluster.notifications` channelï¼Œå¹¶æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼š

```go
func(v interface{}) {
    handleRedisEvent(v, nil, nil)
}
```

[handleRedisEvent](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L65)å‡½æ•°ä¸­ï¼Œä¼šå°†æ¶ˆæ¯è§£æä¸º[Notification](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/redis_signals.go#L32)ç±»å‹çš„æ¶ˆæ¯ï¼Œå¹¶åˆ¤æ–­Commandçš„å€¼ã€‚å¦‚æœæ˜¯NoticePolicyChangedæˆ–NoticeSecretChangedï¼Œå°±ä¼šå‘ `reloadQueue` channelä¸­å†™å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦ç”¨å›è°ƒå‡½æ•°åšä»»ä½•äº‹æƒ…ï¼Œæ‰€ä»¥è¿™é‡Œå›è°ƒå‡½æ•°æ˜¯nilã€‚ `reloadQueue` ä¸»è¦ç”¨æ¥å‘Šè¯‰ç¨‹åºï¼Œéœ€è¦å®Œæˆä¸€æ¬¡å¯†é’¥å’Œç­–ç•¥çš„åŒæ­¥ã€‚



#### reloadQueueLoopåç¨‹

reloadQueueLoopå‡½æ•°ä¼šç›‘å¬ `reloadQueue` ï¼Œå½“å‘ç°æœ‰æ–°çš„æ¶ˆæ¯ï¼ˆè¿™é‡Œæ˜¯å›è°ƒå‡½æ•°ï¼‰å†™å…¥æ—¶ï¼Œä¼šå®æ—¶å°†æ¶ˆæ¯ç¼“å­˜åˆ° `requeue` åˆ‡ç‰‡ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go

func (l *Load) reloadQueueLoop(cb ...func()) {
    for {
      select {
      case <-l.ctx.Done():
        return
      case fn := <-reloadQueue:
        requeueLock.Lock()
        requeue = append(requeue, fn)
        requeueLock.Unlock()
        log.Info("Reload queued")
        if len(cb) != 0 {
          cb[0]()
        }
      }
    }
  }
```



#### reloadLoopåç¨‹

é€šè¿‡[reloadLoop](https://github.com/marmotedu/iam/blob/v1.0.5/internal/authzserver/load/load.go#L81)å‡½æ•°å¯åŠ¨ä¸€ä¸ªtimerå®šæ—¶å™¨ï¼Œæ¯éš”1ç§’ä¼šæ£€æŸ¥ `requeue` åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ `l.DoReload` æ–¹æ³•ï¼Œä»`iam-apiserver`ä¸­æ‹‰å–å¯†é’¥å’Œç­–ç•¥ï¼Œå¹¶ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚

å¯†é’¥å’Œç­–ç•¥çš„ç¼“å­˜æ¨¡å‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042324045.jpeg)

**å¯†é’¥å’Œç­–ç•¥ç¼“å­˜çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š**

æ¥æ”¶ä¸Šæ¸¸æ¶ˆæ¯ï¼ˆè¿™é‡Œæ˜¯ä»Redisä¸­æ¥æ”¶ï¼‰ï¼Œå°†æ¶ˆæ¯ç¼“å­˜åˆ°åˆ‡ç‰‡æˆ–è€…å¸¦ç¼“å†²çš„channelä¸­ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹åç¨‹å»æ¶ˆè´¹è¿™äº›æ¶ˆæ¯ã€‚è¿™é‡Œçš„æ¶ˆè´¹åç¨‹æ˜¯reloadLoopï¼ŒreloadLoopä¼šæ¯éš”1såˆ¤æ–­ `requeue` åˆ‡ç‰‡æ˜¯å¦é•¿åº¦ä¸º0ï¼Œå¦‚æœä¸ä¸º0ï¼Œåˆ™æ‰§è¡Œ `l.DoReload()` ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ã€‚



**è®²å®Œäº†å¯†é’¥å’Œç­–ç•¥ç¼“å­˜ï¼Œå†æ¥çœ‹ä¸‹æˆæƒæ—¥å¿—ç¼“å­˜ã€‚**

åœ¨å¯åŠ¨iam-authz-serveræ—¶ï¼Œè¿˜ä¼šå¯åŠ¨ä¸€ä¸ªAnalyticsæœåŠ¡ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº[internal/authzserver/server.go](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/server.go#L147-L156)æ–‡ä»¶ä¸­ï¼‰ï¼š

```go
if s.analyticsOptions.Enable {    
    analyticsStore := storage.RedisCluster{KeyPrefix: RedisKeyPrefix}    
    analyticsIns := analytics.NewAnalytics(s.analyticsOptions, &analyticsStore)    
    analyticsIns.Start()    
    s.gs.AddShutdownCallback(shutdown.ShutdownFunc(func(string) error {    
        analyticsIns.Stop()    

        return nil    
    }))    
}
```

[NewAnalytics](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L64-L79)å‡½æ•°ä¼šæ ¹æ®é…ç½®ï¼Œåˆ›å»ºä¸€ä¸ªAnalyticså®ä¾‹ï¼š

```go
func NewAnalytics(options *AnalyticsOptions, store storage.AnalyticsHandler) *Analytics {
    ps := options.PoolSize
    recordsBufferSize := options.RecordsBufferSize
    workerBufferSize := recordsBufferSize / uint64(ps)
    log.Debug("Analytics pool worker buffer size", log.Uint64("workerBufferSize", workerBufferSize))
  
    recordsChan := make(chan *AnalyticsRecord, recordsBufferSize)
  
    return &Analytics{
      store:                      store,
      poolSize:                   ps,
      recordsChan:                recordsChan,
      workerBufferSize:           workerBufferSize,
      recordsBufferFlushInterval: options.FlushInterval,
    }
  } 
```

ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå¸¦ç¼“å†²çš„ `recordsChan` ï¼š

```go
recordsChan := make(chan *AnalyticsRecord, recordsBufferSize)
```

`recordsChan` å­˜æ”¾çš„æ•°æ®ç±»å‹ä¸º[AnalyticsRecord](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L26-L35)ï¼Œç¼“å†²åŒºçš„å¤§å°ä¸º `recordsBufferSize` ï¼ˆé€šè¿‡ `--analytics.records-buffer-size` é€‰é¡¹æŒ‡å®šï¼‰ã€‚å¯ä»¥é€šè¿‡[RecordHit](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L115-L126)å‡½æ•°ï¼Œå‘`recordsChan` ä¸­å†™å…¥ AnalyticsRecord ç±»å‹çš„æ•°æ®ï¼š

```go
func (r *Analytics) RecordHit(record *AnalyticsRecord) error {                                                     
    // check if we should stop sending records 1st                                                                     
    if atomic.LoadUint32(&r.shouldStop) > 0 {                                                                          
        return nil                                                                                                     
    }                                                                                                                  
                                                                                                                       
    // just send record to channel consumed by pool of workers                                                         
    // leave all data crunching and Redis I/O work for pool workers                                                    
    r.recordsChan <- record                                                                                            
                                                                                                                       
    return nil                                                                                                         
}   
```

iam-authz-serveræ˜¯é€šè¿‡è°ƒç”¨ LogGrantedAccessRequest å’Œ LogRejectedAccessRequest å‡½æ•°æ¥è®°å½•æˆæƒæ—¥å¿—çš„ã€‚åœ¨è®°å½•æˆæƒæ—¥å¿—æ—¶ï¼Œä¼šå°†æˆæƒæ—¥å¿—å†™å…¥ `recordsChan` channelä¸­ã€‚[LogGrantedAccessRequest](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/authorization/authorizer/authorizer.go#L100-L115)å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š

```go

func (auth *Authorization) LogGrantedAccessRequest(r *ladon.Request, p ladon.Policies, d ladon.Policies) {
    conclusion := fmt.Sprintf("policies %s allow access", joinPoliciesNames(d))                               
    rstring, pstring, dstring := convertToString(r, p, d)                          
    record := analytics.AnalyticsRecord{                     
        TimeStamp:  time.Now().Unix(),                              
        Username:   r.Context["username"].(string),                 
        Effect:     ladon.AllowAccess,                       
        Conclusion: conclusion,                              
        Request:    rstring,       
        Policies:   pstring,                                                   
        Deciders:   dstring,                                                   
    }                           
                           
    record.SetExpiry(0)
    _ = analytics.GetAnalytics().RecordHit(&record)         
} 
```

ä¸Šé¢çš„ä»£ç ï¼Œä¼šåˆ›å»ºAnalyticsRecordç±»å‹çš„ç»“æ„ä½“å˜é‡ï¼Œå¹¶è°ƒç”¨RecordHitå°†å˜é‡çš„å€¼å†™å…¥ `recordsChan` channelä¸­ã€‚å°†æˆæƒæ—¥å¿—å†™å…¥ `recordsChan`  channelä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥Redisä¸­ï¼Œè¿™å¯ä»¥å¤§å¤§å‡å°‘å†™å…¥å»¶æ—¶ï¼Œå‡å°‘æ¥å£çš„å“åº”å»¶æ—¶ã€‚

è¿˜æœ‰ä¸€ä¸ªworkerè¿›ç¨‹ä»recordsChanä¸­è¯»å–æ•°æ®ï¼Œå¹¶åœ¨æ•°æ®è¾¾åˆ°ä¸€å®šé˜ˆå€¼ä¹‹åï¼Œæ‰¹é‡å†™å…¥Redisä¸­ã€‚åœ¨[Start](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L87-L100)å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€æ‰¹workerï¼Œworkerä¸ªæ•°å¯ä»¥é€šè¿‡ `--analytics.pool-size` æ¥æŒ‡å®š ã€‚Startå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š

```go
func (r *Analytics) Start() {
    analytics = r
    r.store.Connect()
  
    // start worker pool
    atomic.SwapUint32(&r.shouldStop, 0)
    for i := 0; i < r.poolSize; i++ {
      r.poolWg.Add(1)
      go r.recordWorker()
    }
  
    // stop analytics workers
    go r.Stop()
  }
```

ä¸Šé¢çš„ä»£ç é€šè¿‡ `go r.recordWorker()` åˆ›å»ºäº† ç”±`poolSize` æŒ‡å®šä¸ªæ•°çš„[recordWorker](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/analytics/analytics.go#L128-L173)ï¼ˆworkerï¼‰ï¼ŒrecordWorkerå‡½æ•°ä¼šä» `recordsChan` ä¸­è¯»å–æˆæƒæ—¥å¿—å¹¶å­˜å…¥recordsBufferä¸­ï¼ŒrecordsBufferçš„å¤§å°ä¸ºworkerBufferSizeï¼ŒworkerBufferSizeè®¡ç®—å…¬å¼ä¸ºï¼š

```go
ps := options.PoolSize
recordsBufferSize := options.RecordsBufferSize
workerBufferSize := recordsBufferSize / uint64(ps)
```

å…¶ä¸­ï¼Œoptions.PoolSizeç”±å‘½ä»¤è¡Œå‚æ•° `--analytics.pool-size` æŒ‡å®šï¼Œä»£è¡¨worker çš„ä¸ªæ•°ï¼Œé»˜è®¤ 50ï¼›options.RecordsBufferSizeç”±å‘½ä»¤è¡Œå‚æ•° `--analytics.records-buffer-size` æŒ‡å®šï¼Œä»£è¡¨ç¼“å­˜çš„æˆæƒæ—¥å¿—æ¶ˆæ¯æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠç¼“å­˜çš„è®°å½•å¹³å‡åˆ†é…ç»™æ‰€æœ‰çš„workerã€‚

å½“recordsBufferå­˜æ»¡æˆ–è€…è¾¾åˆ°æŠ•é€’æœ€å¤§æ—¶é—´åï¼Œè°ƒç”¨ `r.Store.AppendToSetPipelined(analyticsKeyName, recordsBuffer)` å°†è®°å½•æ‰¹é‡å‘é€ç»™Redisï¼Œä¸ºäº†æé«˜ä¼ è¾“é€Ÿç‡ï¼Œè¿™é‡Œå°†æ—¥å¿—å†…å®¹ç¼–ç ä¸ºmsgpackæ ¼å¼åå†ä¼ è¾“ã€‚

ä¸Šé¢çš„ç¼“å­˜æ–¹æ³•å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªç¼“å­˜æ¨¡å‹ï¼Œæ»¡è¶³å®é™…å¼€å‘ä¸­çš„å¤§éƒ¨åˆ†éœ€è¦å¼‚æ­¥è½¬å­˜çš„åœºæ™¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042326755.jpeg)

Producerå°†æ•°æ®æŠ•é€’åˆ°å¸¦ç¼“å†²çš„channelä¸­ï¼Œåç«¯æœ‰å¤šä¸ªworkeræ¶ˆè´¹channelä¸­çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œæ‰¹é‡æŠ•é€’ã€‚ä½ å¯ä»¥è®¾ç½®æ‰¹é‡æŠ•é€’çš„æ¡ä»¶ï¼Œä¸€èˆ¬è‡³å°‘åŒ…å«**æœ€å¤§æŠ•é€’æ—¥å¿—æ•°**å’Œ**æœ€å¤§æŠ•é€’æ—¶é—´é—´éš”**è¿™ä¸¤ä¸ªã€‚

é€šè¿‡ä»¥ä¸Šç¼“å†²æ¨¡å‹ï¼Œä½ å¯ä»¥å°†æ—¥å¿—è½¬å­˜çš„æ—¶å»¶é™åˆ°æœ€ä½ã€‚



### æ•°æ®ä¸€è‡´æ€§

ä¸Šé¢ä»‹ç»äº† iam-authz-serverçš„ `/v1/authz` æ¥å£ï¼Œä¸ºäº†æœ€å¤§åŒ–åœ°æé«˜æ€§èƒ½ï¼Œé‡‡ç”¨äº†å¤§é‡çš„ç¼“å­˜è®¾è®¡ã€‚å› ä¸ºæ•°æ®ä¼šåˆ†åˆ«åœ¨æŒä¹…åŒ–å­˜å‚¨å’Œå†…å­˜ä¸­éƒ½å­˜å‚¨ä¸€ä»½ï¼Œå°±å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿè¦ç¡®ä¿ç¼“å­˜ä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚æ•°æ®ä¸€è‡´æ€§æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](http://sm.nsddd.top/sm202303042326342.jpeg)

**å¯†é’¥å’Œç­–ç•¥åŒæ­¥æµç¨‹å¦‚ä¸‹ï¼š**

1. é€šè¿‡iam-webconsoleè¯·æ±‚iam-apiserveråˆ›å»ºï¼ˆæˆ–æ›´æ–°ã€åˆ é™¤ï¼‰å¯†é’¥ï¼ˆæˆ–ç­–ç•¥ï¼‰ã€‚
2. iam-apiserveræ”¶åˆ°â€œå†™â€è¯·æ±‚åï¼Œä¼šå‘Redis `iam.cluster.notifications` channelå‘é€PolicyChangedæˆ–SecretChangedæ¶ˆæ¯ã€‚
3. Loaderæ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šè§¦å‘cache loaderå®ä¾‹æ‰§è¡Œ `Reload` æ–¹æ³•ï¼Œé‡æ–°ä»iam-apiserverä¸­åŒæ­¥å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ã€‚

Loaderä¸ä¼šå…³å¿ƒ `Reload` æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œåªä¼šåœ¨æ”¶åˆ°æŒ‡å®šæ¶ˆæ¯æ—¶ï¼Œæ‰§è¡Œ `Reload` æ–¹æ³•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸åŒçš„ç¼“å­˜ç­–ç•¥ã€‚

åœ¨cacheå®ä¾‹çš„ `Reload` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å…¶å®æ˜¯è°ƒç”¨ä»“åº“å±‚Secretå’ŒPolicyçš„Listæ–¹æ³•æ¥è·å–å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ã€‚ä»“åº“å±‚åˆæ˜¯é€šè¿‡æ‰§è¡ŒgRPCè¯·æ±‚ï¼Œä»iam-apiserverä¸­è·å–å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ã€‚

cacheçš„[Reload](https://github.com/marmotedu/iam/blob/v1.0.6/internal/authzserver/load/cache/cache.go#L105-L132)æ–¹æ³•ï¼Œä¼šå°†è·å–åˆ°çš„å¯†é’¥å’Œç­–ç•¥åˆ—è¡¨ç¼“å­˜åœ¨[ristretto](https://github.com/dgraph-io/ristretto)ç±»å‹çš„Cacheä¸­ï¼Œä¾›ä¸šåŠ¡å±‚è°ƒç”¨ã€‚ä¸šåŠ¡å±‚ä»£ç ä½äº[internal/authzserver/authorization](https://github.com/marmotedu/iam/tree/v1.0.6/internal/authzserver/authorization)ç›®å½•ä¸‹ã€‚



## æ€»ç»“

è¿™ä¸€è®²ä¸­ï¼Œæˆ‘ä»‹ç»äº†IAMæ•°æ®æµæœåŠ¡iam-authz-serverçš„è®¾è®¡å’Œå®ç°ã€‚iam-authz-serveræä¾›äº† `/v1/authz` RESTful APIæ¥å£ï¼Œä¾›ç¬¬ä¸‰æ–¹ç”¨æˆ·å®Œæˆèµ„æºæˆæƒåŠŸèƒ½ï¼Œå…·ä½“æ˜¯ä½¿ç”¨LadonåŒ…æ¥å®Œæˆèµ„æºæˆæƒçš„ã€‚LadonåŒ…è§£å†³äº†â€œåœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹ï¼Œè°èƒ½å¤Ÿ/ä¸èƒ½å¤Ÿå¯¹å“ªäº›èµ„æºåšå“ªäº›æ“ä½œâ€çš„é—®é¢˜ã€‚

iam-authz-serverçš„é…ç½®å¤„ç†ã€å¯åŠ¨æµç¨‹å’Œè¯·æ±‚å¤„ç†æµç¨‹è·Ÿiam-apiserverä¿æŒä¸€è‡´ã€‚æ­¤å¤–ï¼Œiam-authz-serverä¹Ÿå®ç°äº†ç®€æ´æ¶æ„ã€‚

iam-authz-serveré€šè¿‡ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ã€ç¼“å­˜æˆæƒæ—¥å¿—æ¥æé«˜ `/v1/authz` æ¥å£çš„æ€§èƒ½ã€‚

åœ¨ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯æ—¶ï¼Œä¸ºäº†å’Œiam-apiserverä¸­çš„å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ä¿æŒä¸€è‡´ï¼Œä½¿ç”¨äº†Redis Pub/Subæœºåˆ¶ã€‚å½“iam-apiserveræœ‰å¯†é’¥/ç­–ç•¥å˜æ›´æ—¶ï¼Œä¼šå¾€æŒ‡å®šçš„Redis channel Pubä¸€æ¡æ¶ˆæ¯ã€‚iam-authz-serverè®¢é˜…ç›¸åŒçš„channelï¼Œåœ¨æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶ï¼Œä¼šè§£ææ¶ˆæ¯ï¼Œå¹¶é‡æ–°ä»iam-apiserverä¸­è·å–å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ï¼Œç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚

iam-authz-serveræ‰§è¡Œå®Œèµ„æºæˆæƒä¹‹åï¼Œä¼šå°†æˆæƒæ—¥å¿—å­˜æ”¾åœ¨ä¸€ä¸ªå¸¦ç¼“å†²çš„channelä¸­ã€‚åç«¯æœ‰å¤šä¸ªworkeræ¶ˆè´¹channelä¸­çš„æ•°æ®ï¼Œå¹¶è¿›è¡Œæ‰¹é‡æŠ•é€’ã€‚å¯ä»¥è®¾ç½®æ‰¹é‡æŠ•é€’çš„æ¡ä»¶ï¼Œä¾‹å¦‚æœ€å¤§æŠ•é€’æ—¥å¿—æ•°å’Œæœ€å¤§æŠ•é€’æ—¶é—´é—´éš”ã€‚



## END é“¾æ¥

1. iam-authz-serverå’Œiam-apiserverå…±ç”¨äº†åº”ç”¨æ¡†æ¶ï¼ˆåŒ…æ‹¬ä¸€äº›é…ç½®é¡¹ï¼‰å’ŒHTTPæœåŠ¡æ¡†æ¶å±‚çš„ä»£ç ï¼Œè¯·é˜…è¯»iam-authz-serverä»£ç ï¼Œçœ‹ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•å®ç°ä»£ç å¤ç”¨çš„ã€‚
2. iam-authz-serverä½¿ç”¨äº†[ristretto](https://github.com/dgraph-io/ristretto)æ¥ç¼“å­˜å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ï¼Œè¯·è°ƒç ”ä¸‹ä¸šç•Œè¿˜æœ‰å“ªäº›ä¼˜ç§€çš„ç¼“å­˜åŒ…å¯ä¾›ä½¿ç”¨ï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚

<ul><li><div><a href = '22.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '24.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

