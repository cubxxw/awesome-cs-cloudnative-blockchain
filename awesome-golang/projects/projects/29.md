+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬29èŠ‚ ä»£ç æµ‹è¯•ï¼ˆä¸‹ï¼‰ï¼šGo è¯­è¨€å…¶ä»–æµ‹è¯•ç±»å‹åŠ IAM æµ‹è¯•ä»‹ç»

<br>
<div><a href = '28.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '30.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

[ä¸Šä¸€è®²](https://time.geekbang.org/column/article/408529)ï¼Œæˆ‘ä»‹ç»äº†Goä¸­çš„ä¸¤ç±»æµ‹è¯•ï¼šå•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ã€‚åœ¨Goä¸­ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æµ‹è¯•ç±»å‹å’Œæµ‹è¯•æ–¹æ³•ï¼Œå€¼å¾—æˆ‘ä»¬å»äº†è§£å’ŒæŒæ¡ã€‚æ­¤å¤–ï¼ŒIAMé¡¹ç›®ä¹Ÿç¼–å†™äº†å¤§é‡æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™äº›æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨äº†ä¸åŒçš„ç¼–å†™æ–¹æ³•ï¼Œä½ å¯ä»¥é€šè¿‡å­¦ä¹ IAMçš„æµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä½ å­¦åˆ°çš„æµ‹è¯•çŸ¥è¯†ã€‚

ä»Šå¤©ï¼Œæˆ‘å°±æ¥ä»‹ç»ä¸‹Go è¯­è¨€ä¸­çš„å…¶ä»–æµ‹è¯•ç±»å‹ï¼šç¤ºä¾‹æµ‹è¯•ã€TestMainå‡½æ•°ã€Mockæµ‹è¯•ã€Fakeæµ‹è¯•ç­‰ï¼Œå¹¶ä¸”ä»‹ç»ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•ç¼–å†™å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ã€‚

## ç¤ºä¾‹æµ‹è¯•

ç¤ºä¾‹æµ‹è¯•ä»¥`Example`å¼€å¤´ï¼Œæ²¡æœ‰è¾“å…¥å’Œè¿”å›å‚æ•°ï¼Œé€šå¸¸ä¿å­˜åœ¨`example_test.go`æ–‡ä»¶ä¸­ã€‚ç¤ºä¾‹æµ‹è¯•å¯èƒ½åŒ…å«ä»¥`Output:`æˆ–è€…`Unordered output:`å¼€å¤´çš„æ³¨é‡Šï¼Œè¿™äº›æ³¨é‡Šæ”¾åœ¨å‡½æ•°çš„ç»“å°¾éƒ¨åˆ†ã€‚`Unordered output:`å¼€å¤´çš„æ³¨é‡Šä¼šå¿½ç•¥è¾“å‡ºè¡Œçš„é¡ºåºã€‚

æ‰§è¡Œ`go test`å‘½ä»¤æ—¶ï¼Œä¼šæ‰§è¡Œè¿™äº›ç¤ºä¾‹æµ‹è¯•ï¼Œå¹¶ä¸”go testä¼šå°†ç¤ºä¾‹æµ‹è¯•è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºçš„å†…å®¹ï¼Œè·Ÿæ³¨é‡Šä½œå¯¹æ¯”ï¼ˆæ¯”è¾ƒæ—¶å°†å¿½ç•¥è¡Œå‰åçš„ç©ºæ ¼ï¼‰ã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™ç¤ºä¾‹æµ‹è¯•é€šè¿‡æµ‹è¯•ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ç¤ºä¾‹æµ‹è¯•ä¸é€šè¿‡æµ‹è¯•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ï¼ˆä½äºexample_test.goæ–‡ä»¶ä¸­ï¼‰ï¼š

```go
func ExampleMax() {    fmt.Println(Max(1, 2))    // Output:    // 2}
```

æ‰§è¡Œgo testå‘½ä»¤ï¼Œæµ‹è¯•`ExampleMax`ç¤ºä¾‹æµ‹è¯•ï¼š

```bash
$ go test -v -run='Example.'=== RUN   ExampleMax--- PASS: ExampleMax (0.00s)PASSok      github.com/marmotedu/gopractise-demo/31/test    0.004s
```

*å¯ä»¥çœ‹åˆ°`ExampleMax`æµ‹è¯•é€šè¿‡ã€‚è¿™é‡Œæµ‹è¯•é€šè¿‡æ˜¯å› ä¸º`fmt.Println(Max(1, 2))`å‘æ ‡å‡†è¾“å‡ºè¾“å‡ºäº†`2`ï¼Œè·Ÿ`// Output:`åé¢çš„`2`ä¸€è‡´ã€‚*

*å½“ç¤ºä¾‹æµ‹è¯•ä¸åŒ…å«`Output:`æˆ–è€…`Unordered output:`æ³¨é‡Šæ—¶ï¼Œæ‰§è¡Œ`go test`åªä¼šç¼–è¯‘è¿™äº›å‡½æ•°ï¼Œä½†ä¸ä¼šæ‰§è¡Œè¿™äº›å‡½æ•°ã€‚*

### *ç¤ºä¾‹æµ‹è¯•å‘½åè§„èŒƒ*

*ç¤ºä¾‹æµ‹è¯•éœ€è¦éµå¾ªä¸€äº›å‘½åè§„èŒƒï¼Œå› ä¸ºåªæœ‰è¿™æ ·ï¼ŒGodocæ‰èƒ½å°†ç¤ºä¾‹æµ‹è¯•å’ŒåŒ…çº§åˆ«çš„æ ‡è¯†ç¬¦è¿›è¡Œå…³è”ã€‚ä¾‹å¦‚ï¼Œæœ‰ä»¥ä¸‹ç¤ºä¾‹æµ‹è¯•ï¼ˆä½äºexample_test.goæ–‡ä»¶ä¸­ï¼‰ï¼š*

```
package stringutil_testimport (    "fmt"    "github.com/golang/example/stringutil")func ExampleReverse() {    fmt.Println(stringutil.Reverse("hello"))    // Output: olleh}
```

*Godocå°†åœ¨`Reverse`å‡½æ•°çš„æ–‡æ¡£æ—è¾¹æä¾›æ­¤ç¤ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š*

*[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/d8/93/d8ae5e99fe1d159e9b3ba1f815b24693.png?wh=540x374)](https://static001.geekbang.org/resource/image/d8/93/d8ae5e99fe1d159e9b3ba1f815b24693.png?wh=540x374)*

*ç¤ºä¾‹æµ‹è¯•åä»¥`Example`å¼€å¤´ï¼Œåé¢å¯ä»¥ä¸è·Ÿä»»ä½•å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥è·Ÿå‡½æ•°åã€ç±»å‹åæˆ–è€…`ç±»å‹_æ–¹æ³•å`ï¼Œä¸­é—´ç”¨ä¸‹åˆ’çº¿`_`è¿æ¥ï¼Œä¾‹å¦‚ï¼š*

```
func Example()  // ä»£è¡¨äº†æ•´ä¸ªåŒ…çš„ç¤ºä¾‹func ExampleF()  // å‡½æ•°Fçš„ç¤ºä¾‹func ExampleT()  // ç±»å‹Tçš„ç¤ºä¾‹func ExampleT_M()  // æ–¹æ³•T_Mçš„ç¤ºä¾‹
```

*å½“æŸä¸ªå‡½æ•°/ç±»å‹/æ–¹æ³•æœ‰å¤šä¸ªç¤ºä¾‹æµ‹è¯•æ—¶ï¼Œå¯ä»¥é€šè¿‡åç¼€æ¥åŒºåˆ†ï¼Œåç¼€å¿…é¡»ä»¥å°å†™å­—æ¯å¼€å¤´ï¼Œä¾‹å¦‚ï¼š*

```
func ExampleReverse()func ExampleReverse_second()func ExampleReverse_third()
```

### *å¤§å‹ç¤ºä¾‹*

*æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªå¤§å‹çš„ç¤ºä¾‹æµ‹è¯•ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæ•´æ–‡ä»¶çš„ç¤ºä¾‹ï¼ˆwhole file exampleï¼‰ï¼Œå®ƒæœ‰è¿™å‡ ä¸ªç‰¹ç‚¹ï¼šæ–‡ä»¶åä»¥`_test.go`ç»“å°¾ï¼›åªåŒ…å«ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ï¼Œæ–‡ä»¶ä¸­æ²¡æœ‰å•å…ƒæµ‹è¯•å‡½æ•°å’Œæ€§èƒ½æµ‹è¯•å‡½æ•°ï¼›è‡³å°‘åŒ…å«ä¸€ä¸ªåŒ…çº§åˆ«çš„å£°æ˜ï¼›å½“å±•ç¤ºè¿™ç±»ç¤ºä¾‹æµ‹è¯•æ—¶ï¼Œgodocä¼šç›´æ¥å±•ç¤ºæ•´ä¸ªæ–‡ä»¶ã€‚ä¾‹å¦‚ï¼š*

```
package sort_testimport (    "fmt"    "sort")type Person struct func (p Person) String() string {    return fmt.Sprintf("%s: %d", p.Name, p.Age)}// ByAge implements sort.Interface for []Person based on// the Age field.type ByAge []Personfunc (a ByAge) Len() int           { return len(a) }func (a ByAge) Swap(i, j int)      { a[i], a[j] = a[j], a[i] }func (a ByAge) Less(i, j int) bool { return a[i].Age < a[j].Age }func Example() {    people := []Person{        {"Bob", 31},        {"John", 42},        {"Michael", 17},        {"Jenny", 26},    }    fmt.Println(people)    sort.Sort(ByAge(people))    fmt.Println(people)    // Output:    // [Bob: 31 John: 42 Michael: 17 Jenny: 26]    // [Michael: 17 Jenny: 26 Bob: 31 John: 42]}
```

*ä¸€ä¸ªåŒ…å¯ä»¥åŒ…å«å¤šä¸ªwhole file exampleï¼Œä¸€ä¸ªç¤ºä¾‹ä¸€ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚`example_interface_test.go`ã€`example_keys_test.go`ã€`example_search_test.go`ç­‰ã€‚*

## *TestMainå‡½æ•°*

*æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨åšæµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šåœ¨æµ‹è¯•ä¹‹å‰åšäº›å‡†å¤‡å·¥ä½œï¼Œä¾‹å¦‚åˆ›å»ºæ•°æ®åº“è¿æ¥ç­‰ï¼›åœ¨æµ‹è¯•ä¹‹ååšäº›æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚å…³é—­æ•°æ®åº“è¿æ¥ã€æ¸…ç†æµ‹è¯•æ–‡ä»¶ç­‰ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨`\*test.go\*`*æ–‡ä»¶ä¸­æ·»åŠ `TestMain`å‡½æ•°ï¼Œå…¶å…¥å‚ä¸º`\*testing.M`ã€‚**

**`TestMain`æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°ï¼ˆç›¸å½“äºmainå‡½æ•°ï¼‰ï¼Œæµ‹è¯•ç”¨ä¾‹åœ¨æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆæ‰§è¡Œ`TestMain`å‡½æ•°ï¼Œç„¶åå¯ä»¥åœ¨`TestMain`ä¸­è°ƒç”¨`m.Run()`å‡½æ•°æ‰§è¡Œæ™®é€šçš„æµ‹è¯•å‡½æ•°ã€‚åœ¨`m.Run()`å‡½æ•°å‰é¢æˆ‘ä»¬å¯ä»¥ç¼–å†™å‡†å¤‡é€»è¾‘ï¼Œåœ¨`m.Run()`åé¢æˆ‘ä»¬å¯ä»¥ç¼–å†™æ¸…ç†é€»è¾‘ã€‚**

**æˆ‘ä»¬åœ¨ç¤ºä¾‹æµ‹è¯•æ–‡ä»¶[math_test.go](https://github.com/marmotedu/gopractise-demo/blob/master/test/math_test.go)ä¸­æ·»åŠ å¦‚ä¸‹TestMainå‡½æ•°ï¼š**

```
func TestMain(m *testing.M) {    fmt.Println("do some setup")    m.Run()    fmt.Println("do some cleanup")}
```

**æ‰§è¡Œgo testï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š**

```
$ go test -vdo some setup=== RUN   TestAbs--- PASS: TestAbs (0.00s)...=== RUN   ExampleMax--- PASS: ExampleMax (0.00s)PASSdo some cleanupok  	github.com/marmotedu/gopractise-demo/31/test	0.006s
```

**åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ä¹‹å‰ï¼Œæ‰“å°äº†`do some setup`ï¼Œåœ¨æµ‹è¯•ç”¨ä¾‹è¿è¡Œå®Œæˆä¹‹åï¼Œæ‰“å°äº†`do some cleanup`ã€‚**

**IAMé¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œä½¿ç”¨TestMainå‡½æ•°åœ¨æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å‰è¿æ¥äº†ä¸€ä¸ªfakeæ•°æ®åº“ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº[internal/apiserver/service/v1/user_test.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go)æ–‡ä»¶ä¸­ï¼‰ï¼š**

```
func TestMain(m *testing.M) {    fakeStore, _ := fake.NewFakeStore()    store.SetClient(fakeStore)    os.Exit(m.Run())}
```

**å•å…ƒæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€ç¤ºä¾‹æµ‹è¯•ã€TestMainå‡½æ•°æ˜¯go testæ”¯æŒçš„æµ‹è¯•ç±»å‹ã€‚æ­¤å¤–ï¼Œä¸ºäº†æµ‹è¯•åœ¨å‡½æ•°å†…ä½¿ç”¨äº†Go Interfaceçš„å‡½æ•°ï¼Œæˆ‘ä»¬è¿˜å»¶ä¼¸å‡ºäº†Mockæµ‹è¯•å’ŒFakeæµ‹è¯•ä¸¤ç§æµ‹è¯•ç±»å‹ã€‚**

## **Mockæµ‹è¯•**

**ä¸€èˆ¬æ¥è¯´ï¼Œå•å…ƒæµ‹è¯•ä¸­æ˜¯ä¸å…è®¸æœ‰å¤–éƒ¨ä¾èµ–çš„ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›å¤–éƒ¨ä¾èµ–éƒ½éœ€è¦è¢«æ¨¡æ‹Ÿã€‚åœ¨Goä¸­ï¼Œä¸€èˆ¬ä¼šå€ŸåŠ©å„ç±»Mockå·¥å…·æ¥æ¨¡æ‹Ÿä¸€äº›ä¾èµ–ã€‚**

**GoMockæ˜¯ç”±Golangå®˜æ–¹å¼€å‘ç»´æŠ¤çš„æµ‹è¯•æ¡†æ¶ï¼Œå®ç°äº†è¾ƒä¸ºå®Œæ•´çš„åŸºäºinterfaceçš„MockåŠŸèƒ½ï¼Œèƒ½å¤Ÿä¸Golangå†…ç½®çš„testingåŒ…è‰¯å¥½é›†æˆï¼Œä¹Ÿèƒ½ç”¨äºå…¶ä»–çš„æµ‹è¯•ç¯å¢ƒä¸­ã€‚GoMockæµ‹è¯•æ¡†æ¶åŒ…å«äº†GoMockåŒ…å’Œmockgenå·¥å…·ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­GoMockåŒ…ç”¨æ¥å®Œæˆå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œmockgenå·¥å…·ç”¨æ¥ç”Ÿæˆinterfaceå¯¹åº”çš„Mockç±»æºæ–‡ä»¶ã€‚ä¸‹é¢ï¼Œæˆ‘æ¥åˆ†åˆ«è¯¦ç»†ä»‹ç»ä¸‹GoMockåŒ…å’Œmockgenå·¥å…·ï¼Œä»¥åŠå®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ã€‚**

### **å®‰è£…GoMock**

**è¦ä½¿ç”¨GoMockï¼Œé¦–å…ˆéœ€è¦å®‰è£…GoMockåŒ…å’Œmockgenå·¥å…·ï¼Œå®‰è£…æ–¹æ³•å¦‚ä¸‹:**

```
$ go get github.com/golang/mock/gomock$ go install github.com/golang/mock/mockgen
```

**ä¸‹é¢ï¼Œæˆ‘é€šè¿‡ä¸€ä¸ª**è·å–å½“å‰Golangæœ€æ–°ç‰ˆæœ¬çš„ä¾‹å­**ï¼Œæ¥ç»™ä½ æ¼”ç¤ºä¸‹å¦‚ä½•ä½¿ç”¨GoMockã€‚ç¤ºä¾‹ä»£ç ç›®å½•ç»“æ„å¦‚ä¸‹ï¼ˆç›®å½•ä¸‹çš„ä»£ç è§[gomock](https://github.com/marmotedu/gopractise-demo/tree/master/gomock)ï¼‰ï¼š**

```
tree ..â”œâ”€â”€ go_version.goâ”œâ”€â”€ main.goâ””â”€â”€ spider    â””â”€â”€ spider.go
```

**`spider.go`æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª`Spider`æ¥å£ï¼Œ`spider.go`ä»£ç å¦‚ä¸‹ï¼š**

```
package spidertype Spider interface {    GetBody() string}
```

**`Spider`æ¥å£ä¸­çš„GetBodyæ–¹æ³•å¯ä»¥æŠ“å–`https://golang.org`é¦–é¡µçš„`Build version`å­—æ®µï¼Œæ¥è·å–Golangçš„æœ€æ–°ç‰ˆæœ¬ã€‚**

**æˆ‘ä»¬åœ¨`go_version.go`æ–‡ä»¶ä¸­ï¼Œè°ƒç”¨`Spider`æ¥å£çš„`GetBody`æ–¹æ³•ï¼Œ`go_version.go`ä»£ç å¦‚ä¸‹ï¼š**

```
package gomockimport (    "github.com/marmotedu/gopractise-demo/gomock/spider")func GetGoVersion(s spider.Spider) string 
```

**`GetGoVersion`å‡½æ•°ç›´æ¥è¿”å›è¡¨ç¤ºç‰ˆæœ¬çš„å­—ç¬¦ä¸²ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå†™å‡ºå¦‚ä¸‹çš„å•å…ƒæµ‹è¯•ä»£ç ï¼š**

```
func TestGetGoVersion(t *testing.T) {    v := GetGoVersion(spider.CreateGoVersionSpider())    if v != "go1.8.3" {        t.Error("Get wrong version %s", v)    }}
```

**ä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼Œä¾èµ–`spider.CreateGoVersionSpider()`è¿”å›ä¸€ä¸ªå®ç°äº†`Spider`æ¥å£çš„å®ä¾‹ï¼ˆçˆ¬è™«ï¼‰ã€‚ä½†å¾ˆå¤šæ—¶å€™ï¼Œ`spider.CreateGoVersionSpider()`çˆ¬è™«å¯èƒ½è¿˜æ²¡æœ‰å®ç°ï¼Œæˆ–è€…åœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ä¸èƒ½è¿è¡Œï¼ˆæ¯”å¦‚ï¼Œåœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸­è¿æ¥æ•°æ®åº“ï¼‰ï¼Œè¿™æ—¶å€™`TestGetGoVersion`æµ‹è¯•ç”¨ä¾‹å°±æ— æ³•æ‰§è¡Œã€‚**

**é‚£ä¹ˆï¼Œå¦‚ä½•æ‰èƒ½åœ¨è¿™ç§æƒ…å†µä¸‹è¿è¡Œ`TestGetGoVersion`æµ‹è¯•ç”¨ä¾‹å‘¢ï¼Ÿè¿™æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Mockå·¥å…·ï¼ŒMockä¸€ä¸ªçˆ¬è™«å®ä¾‹ã€‚æ¥ä¸‹æ¥æˆ‘è®²è®²å…·ä½“æ“ä½œã€‚**

**é¦–å…ˆï¼Œç”¨ GoMock æä¾›çš„mockgenå·¥å…·ï¼Œç”Ÿæˆè¦ Mock çš„æ¥å£çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨gomockç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š**

```
$ mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider
```

**ä¸Šé¢çš„å‘½ä»¤ä¼šåœ¨`spider/mock`ç›®å½•ä¸‹ç”Ÿæˆ`mock_spider.go`æ–‡ä»¶ï¼š**

```
$ tree ..â”œâ”€â”€ go_version.goâ”œâ”€â”€ go_version_test.goâ”œâ”€â”€ go_version_test_traditional_method.go~â””â”€â”€ spider    â”œâ”€â”€ mock    â”‚   â””â”€â”€ mock_spider.go    â””â”€â”€ spider.go
```

**`mock_spider.go`æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº†ä¸€äº›å‡½æ•°/æ–¹æ³•ï¼Œå¯ä»¥æ”¯æŒæˆ‘ä»¬ç¼–å†™`TestGetGoVersion`æµ‹è¯•å‡½æ•°ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼ˆè§[go_version_test.go](https://github.com/marmotedu/gopractise-demo/blob/master/gomock/go_version_test.go)æ–‡ä»¶ï¼‰ï¼š**

```
package gomockimport (	"testing"	"github.com/golang/mock/gomock"	spider "github.com/marmotedu/gopractise-demo/gomock/spider/mock")func TestGetGoVersion(t *testing.T) {	ctrl := gomock.NewController(t)	defer ctrl.Finish()	mockSpider := spider.NewMockSpider(ctrl)	mockSpider.EXPECT().GetBody().Return("go1.8.3")	goVer := GetGoVersion(mockSpider)	if goVer != "go1.8.3" {		t.Errorf("Get wrong version %s", goVer)	}}
```

**è¿™ä¸€ç‰ˆæœ¬çš„`TestGetGoVersion`é€šè¿‡GoMockï¼Œ Mockäº†ä¸€ä¸ª`Spider`æ¥å£ï¼Œè€Œä¸ç”¨å»å®ç°ä¸€ä¸ª`Spider`æ¥å£ã€‚è¿™å°±å¤§å¤§é™ä½äº†å•å…ƒæµ‹è¯•ç”¨ä¾‹ç¼–å†™çš„å¤æ‚åº¦ã€‚é€šè¿‡Mockï¼Œå¾ˆå¤šä¸èƒ½æµ‹è¯•çš„å‡½æ•°ä¹Ÿå˜å¾—å¯æµ‹è¯•äº†ã€‚**

**é€šè¿‡ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒGoMock å’Œ[ä¸Šä¸€è®²](https://time.geekbang.org/column/article/408529)ä»‹ç»çš„testingå•å…ƒæµ‹è¯•æ¡†æ¶å¯ä»¥ç´§å¯†åœ°ç»“åˆèµ·æ¥å·¥ä½œã€‚**

### **mockgenå·¥å…·ä»‹ç»**

**ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ GoMock ç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº†`mockgen`å·¥å…·æ¥ç”Ÿæˆ Mockä»£ç ï¼Œ`mockgen`å·¥å…·æä¾›äº†å¾ˆå¤šæœ‰ç”¨çš„åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘æ¥è¯¦ç»†ä»‹ç»ä¸‹ã€‚**

**`mockgen`å·¥å…·æ˜¯ GoMock æä¾›çš„ï¼Œç”¨æ¥Mockä¸€ä¸ªGoæ¥å£ã€‚å®ƒå¯ä»¥æ ¹æ®ç»™å®šçš„æ¥å£ï¼Œæ¥è‡ªåŠ¨ç”ŸæˆMockä»£ç ã€‚è¿™é‡Œï¼Œæœ‰ä¸¤ç§æ¨¡å¼å¯ä»¥ç”ŸæˆMockä»£ç ï¼Œåˆ†åˆ«æ˜¯æºç æ¨¡å¼å’Œåå°„æ¨¡å¼ã€‚**

1. **æºç æ¨¡å¼**

**å¦‚æœæœ‰æ¥å£æ–‡ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥ç”ŸæˆMockä»£ç ï¼š**

```
$ mockgen -destination spider/mock/mock_spider.go -package spider -source spider/spider.go
```

**ä¸Šé¢çš„å‘½ä»¤ï¼ŒMockäº†`spider/spider.go`æ–‡ä»¶ä¸­å®šä¹‰çš„`Spider`æ¥å£ï¼Œå¹¶å°†Mockä»£ç ä¿å­˜åœ¨`spider/mock/mock_spider.go`æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶çš„åŒ…åä¸º`spider`ã€‚**

**mockgenå·¥å…·çš„å‚æ•°è¯´æ˜è§ä¸‹è¡¨ï¼š**

**[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e7/9c/e72102362e2ae3225e868f125654689c.jpg?wh=1920x1210)](https://static001.geekbang.org/resource/image/e7/9c/e72102362e2ae3225e868f125654689c.jpg?wh=1920x1210)**

1. **åå°„æ¨¡å¼**

**æ­¤å¤–ï¼Œmockgenå·¥å…·è¿˜æ”¯æŒé€šè¿‡ä½¿ç”¨åå°„ç¨‹åºæ¥ç”Ÿæˆ Mock ä»£ç ã€‚å®ƒé€šè¿‡ä¼ é€’ä¸¤ä¸ªéæ ‡å¿—å‚æ•°ï¼Œå³å¯¼å…¥è·¯å¾„å’Œé€—å·åˆ†éš”çš„æ¥å£åˆ—è¡¨æ¥å¯ç”¨ï¼Œå…¶ä»–å‚æ•°å’Œæºç æ¨¡å¼å…±ç”¨ï¼Œä¾‹å¦‚ï¼š**

```
$ mockgen -destination spider/mock/mock_spider.go -package spider github.com/marmotedu/gopractise-demo/gomock/spider Spider
```

### **é€šè¿‡æ³¨é‡Šä½¿ç”¨mockgen**

**å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”åˆ†æ•£åœ¨ä¸åŒçš„ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ç”ŸæˆMockæ–‡ä»¶çš„æ—¶å€™ï¼Œéœ€è¦å¯¹æ¯ä¸ªæ–‡ä»¶æ‰§è¡Œå¤šæ¬¡mockgenå‘½ä»¤ï¼ˆè¿™é‡Œå‡è®¾åŒ…åä¸ç›¸åŒï¼‰ã€‚è¿™ç§æ“ä½œè¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œmockgenè¿˜æä¾›äº†ä¸€ç§é€šè¿‡æ³¨é‡Šç”ŸæˆMockæ–‡ä»¶çš„æ–¹å¼ï¼Œæ­¤æ—¶éœ€è¦å€ŸåŠ©`go generate`å·¥å…·ã€‚**

**åœ¨æ¥å£æ–‡ä»¶çš„ä»£ç ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹æ³¨é‡Šï¼ˆå…·ä½“ä»£ç è§[spider.go](https://github.com/marmotedu/gopractise-demo/blob/master/gomock/spider/spider.go#L3)æ–‡ä»¶ï¼‰ï¼š**

```
//go:generate mockgen -destination mock_spider.go -package spider github.com/cz-it/blog/blog/Go/testing/gomock/example/spider Spider
```

**è¿™æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨`gomock`ç›®å½•ä¸‹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥è‡ªåŠ¨ç”ŸæˆMockä»£ç ï¼š**

```
$ go generate ./...
```

### **ä½¿ç”¨Mockä»£ç ç¼–å†™å•å…ƒæµ‹è¯•ç”¨ä¾‹**

**ç”Ÿæˆäº†Mockä»£ç ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒä»¬äº†ã€‚è¿™é‡Œæˆ‘ä»¬ç»“åˆ`testing`æ¥ç¼–å†™ä¸€ä¸ªä½¿ç”¨äº†Mockä»£ç çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚**

****é¦–å…ˆï¼Œ**éœ€è¦åœ¨å•å…ƒæµ‹è¯•ä»£ç é‡Œåˆ›å»ºä¸€ä¸ªMockæ§åˆ¶å™¨ï¼š**

```
ctrl := gomock.NewController(t)
```

**å°†`\*testing.T`ä¼ é€’ç»™GoMock ï¼Œç”Ÿæˆä¸€ä¸ª`Controller`å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ§åˆ¶äº†æ•´ä¸ªMockçš„è¿‡ç¨‹ã€‚åœ¨æ“ä½œå®Œåï¼Œè¿˜éœ€è¦è¿›è¡Œå›æ”¶ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šåœ¨`NewController`åé¢deferä¸€ä¸ªFinishï¼Œä»£ç å¦‚ä¸‹ï¼š**

```
defer ctrl.Finish()
```

****ç„¶åï¼Œ**å°±å¯ä»¥è°ƒç”¨Mockçš„å¯¹è±¡äº†ï¼š**

```
mockSpider := spider.NewMockSpider(ctrl)
```

**è¿™é‡Œçš„`spider`æ˜¯mockgenå‘½ä»¤é‡Œé¢ä¼ é€’çš„åŒ…åï¼Œåé¢æ˜¯`NewMockXxxx`æ ¼å¼çš„å¯¹è±¡åˆ›å»ºå‡½æ•°ï¼Œ`Xxx`æ˜¯æ¥å£åã€‚è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’æ§åˆ¶å™¨å¯¹è±¡è¿›å»ï¼Œè¿”å›ä¸€ä¸ªMockå®ä¾‹ã€‚**

****æ¥ç€ï¼Œ**æœ‰äº†Mockå®ä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨å…¶æ–­è¨€æ–¹æ³•`EXPECT()`äº†ã€‚**

**gomocké‡‡ç”¨äº†é“¾å¼è°ƒç”¨æ³•ï¼Œé€šè¿‡`.`è¿æ¥å‡½æ•°è°ƒç”¨ï¼Œå¯ä»¥åƒé“¾æ¡ä¸€æ ·è¿æ¥ä¸‹å»ã€‚ä¾‹å¦‚ï¼š**

```
mockSpider.EXPECT().GetBody().Return("go1.8.3")
```

**Mockä¸€ä¸ªæ¥å£çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦Mockè¯¥æ–¹æ³•çš„å…¥å‚å’Œè¿”å›å€¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°åŒ¹é…æ¥Mockå…¥å‚ï¼Œé€šè¿‡Mockå®ä¾‹çš„ `Return` æ–¹æ³•æ¥Mockè¿”å›å€¼ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ†åˆ«çœ‹ä¸‹å¦‚ä½•æŒ‡å®šå…¥å‚å’Œè¿”å›å€¼ã€‚**

**å…ˆæ¥çœ‹å¦‚ä½•æŒ‡å®šå…¥å‚ã€‚å¦‚æœå‡½æ•°æœ‰å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°åŒ¹é…æ¥æŒ‡ä»£å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š**

```
mockSpider.EXPECT().GetBody(gomock.Any(), gomock.Eq("admin")).Return("go1.8.3")
```

**gomockæ”¯æŒä»¥ä¸‹å‚æ•°åŒ¹é…ï¼š**

+ **gomock.Any()ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºä»»æ„çš„å…¥å‚ã€‚**
+ **gomock.Eq(value)ï¼Œç”¨æ¥è¡¨ç¤ºä¸ value ç­‰ä»·çš„å€¼ã€‚**
+ **gomock.Not(value)ï¼Œç”¨æ¥è¡¨ç¤ºé value ä»¥å¤–çš„å€¼ã€‚**
+ **gomock.Nil()ï¼Œç”¨æ¥è¡¨ç¤º None å€¼ã€‚**

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•æŒ‡å®šè¿”å›å€¼ã€‚**

**`EXPECT()`å¾—åˆ°Mockçš„å®ä¾‹ï¼Œç„¶åè°ƒç”¨Mockå®ä¾‹çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ç¬¬ä¸€ä¸ª`Call`å¯¹è±¡ï¼Œç„¶åå¯ä»¥å¯¹å…¶è¿›è¡Œæ¡ä»¶çº¦æŸï¼Œæ¯”å¦‚ä½¿ç”¨Mockå®ä¾‹çš„ `Return` æ–¹æ³•çº¦æŸå…¶è¿”å›å€¼ã€‚`Call`å¯¹è±¡è¿˜æä¾›äº†ä»¥ä¸‹æ–¹æ³•æ¥çº¦æŸMockå®ä¾‹ï¼š**

```
func (c *Call) After(preReq *Call) *Call // Afterå£°æ˜è°ƒç”¨åœ¨preReqå®Œæˆåæ‰§è¡Œfunc (c *Call) AnyTimes() *Call // å…è®¸è°ƒç”¨æ¬¡æ•°ä¸º 0 æ¬¡æˆ–æ›´å¤šæ¬¡func (c *Call) Do(f interface{}) *Call // å£°æ˜åœ¨åŒ¹é…æ—¶è¦è¿è¡Œçš„æ“ä½œfunc (c *Call) MaxTimes(n int) *Call // è®¾ç½®æœ€å¤§çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡func (c *Call) MinTimes(n int) *Call // è®¾ç½®æœ€å°çš„è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡func (c *Call) Return(rets ...interface{}) *Call //  // å£°æ˜æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨è¿”å›çš„å€¼func (c *Call) SetArg(n int, value interface{}) *Call // å£°æ˜ä½¿ç”¨æŒ‡é’ˆè®¾ç½®ç¬¬ n ä¸ªå‚æ•°çš„å€¼func (c *Call) Times(n int) *Call // è®¾ç½®è°ƒç”¨æ¬¡æ•°ä¸º n æ¬¡
```

**ä¸Šé¢åˆ—å‡ºäº†å¤šä¸ª `Call` å¯¹è±¡æä¾›çš„çº¦æŸæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»3ä¸ªå¸¸ç”¨çš„çº¦æŸæ–¹æ³•ï¼šæŒ‡å®šè¿”å›å€¼ã€æŒ‡å®šæ‰§è¡Œæ¬¡æ•°å’ŒæŒ‡å®šæ‰§è¡Œé¡ºåºã€‚**

1. **æŒ‡å®šè¿”å›å€¼**

**æˆ‘ä»¬å¯ä»¥æä¾›è°ƒç”¨`Call`çš„`Return`å‡½æ•°ï¼Œæ¥æŒ‡å®šæ¥å£çš„è¿”å›å€¼ï¼Œä¾‹å¦‚ï¼š**

```
mockSpider.EXPECT().GetBody().Return("go1.8.3")
```

1. **æŒ‡å®šæ‰§è¡Œæ¬¡æ•°**

**æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šå‡½æ•°æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œä¾‹å¦‚ï¼šå¯¹äºæ¥å—ç½‘ç»œè¯·æ±‚çš„å‡½æ•°ï¼Œè®¡ç®—å…¶æ‰§è¡Œäº†å¤šå°‘æ¬¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`Call`çš„`Times`å‡½æ•°æ¥æŒ‡å®šæ‰§è¡Œæ¬¡æ•°ï¼š**

```
mockSpider.EXPECT().Recv().Return(nil).Times(3)
```

**ä¸Šè¿°ä»£ç ï¼Œæ‰§è¡Œäº†ä¸‰æ¬¡Recvå‡½æ•°ï¼Œè¿™é‡Œgomockè¿˜æ”¯æŒå…¶ä»–çš„æ‰§è¡Œæ¬¡æ•°é™åˆ¶ï¼š**

+ **AnyTimes()ï¼Œè¡¨ç¤ºæ‰§è¡Œ0åˆ°å¤šæ¬¡ã€‚**
+ **MaxTimes(n int)ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæœ€å¤šæ‰§è¡Œnæ¬¡ã€‚**
+ **MinTimes(n int)ï¼Œè¡¨ç¤ºå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæœ€å°‘æ‰§è¡Œnæ¬¡ã€‚**

1. **æŒ‡å®šæ‰§è¡Œé¡ºåº**

**æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜è¦æŒ‡å®šæ‰§è¡Œé¡ºåºï¼Œæ¯”å¦‚è¦å…ˆæ‰§è¡Œ Init æ“ä½œï¼Œç„¶åæ‰èƒ½æ‰§è¡ŒRecvæ“ä½œï¼š**

```
initCall := mockSpider.EXPECT().Init()mockSpider.EXPECT().Recv().After(initCall)
```

**æœ€åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`go test`æ¥æµ‹è¯•ä½¿ç”¨äº†Mockä»£ç çš„å•å…ƒæµ‹è¯•ä»£ç ï¼š**

```
$ go test -v=== RUN   TestGetGoVersion--- PASS: TestGetGoVersion (0.00s)PASSok  	github.com/marmotedu/gopractise-demo/gomock	0.002s
```

## **Fakeæµ‹è¯•**

**åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œå¯¹äºæ¯”è¾ƒå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥Fakeä¸€ä¸ªæ¥å£å®ç°ï¼Œæ¥è¿›è¡Œæµ‹è¯•ã€‚æ‰€è°“Fakeæµ‹è¯•ï¼Œå…¶å®å°±æ˜¯é’ˆå¯¹æ¥å£å®ç°ä¸€ä¸ªå‡ï¼ˆfakeï¼‰çš„å®ä¾‹ã€‚è‡³äºå¦‚ä½•å®ç°Fakeå®ä¾‹ï¼Œéœ€è¦ä½ æ ¹æ®ä¸šåŠ¡è‡ªè¡Œå®ç°ã€‚ä¾‹å¦‚ï¼šIAMé¡¹ç›®ä¸­iam-apiserverç»„ä»¶å°±å®ç°äº†ä¸€ä¸ªfake storeï¼Œä»£ç è§[fake](https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/store/fake)ç›®å½•ã€‚å› ä¸ºè¿™ä¸€è®²åé¢çš„IAMé¡¹ç›®æµ‹è¯•å®æˆ˜éƒ¨åˆ†æœ‰ä»‹ç»ï¼Œæ‰€ä»¥è¿™é‡Œä¸å†å±•å¼€è®²è§£ã€‚**

## **ä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Ÿ**

**ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†Goä»£ç æµ‹è¯•çš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™é‡Œæˆ‘å†æ¥åˆ†äº«ä¸‹åœ¨åšæµ‹è¯•æ—¶ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ï¼šä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ã€‚**

### **ç¼–ç å‰ï¼šTDD**

**[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/48/b2/4830b21b55d194eccf1ec74637ee3eb2.png?wh=538x516)](https://static001.geekbang.org/resource/image/48/b2/4830b21b55d194eccf1ec74637ee3eb2.png?wh=538x516)**

**Test-Driven Developmentï¼Œä¹Ÿå°±æ˜¯æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œæ˜¯æ•æ·å¼€å‘çš„â¼€é¡¹æ ¸å¿ƒå®è·µå’ŒæŠ€æœ¯ï¼Œä¹Ÿæ˜¯â¼€ç§è®¾è®¡æ–¹æ³•è®ºã€‚ç®€å•æ¥è¯´ï¼ŒTDDåŸç†å°±æ˜¯ï¼šå¼€å‘åŠŸèƒ½ä»£ç ä¹‹å‰ï¼Œå…ˆç¼–å†™æµ‹è¯•ç”¨ä¾‹ä»£ç ï¼Œç„¶åé’ˆå¯¹æµ‹è¯•ç”¨ä¾‹ç¼–å†™åŠŸèƒ½ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿé€šè¿‡ã€‚è¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œé€šè¿‡æµ‹è¯•çš„æ‰§è¡Œä»£ç è‚¯å®šæ»¡è¶³éœ€æ±‚ï¼Œè€Œä¸”æœ‰åŠ©äºé¢å‘æ¥å£ç¼–ç¨‹ï¼Œé™ä½ä»£ç è€¦åˆï¼Œä¹Ÿæå¤§é™ä½äº†bugçš„å‡ºç°å‡ ç‡ã€‚**

**ç„¶è€Œï¼ŒTDDçš„åå¤„ä¹Ÿæ˜¾è€Œæ˜“è§ï¼šç”±äºæµ‹è¯•ç”¨ä¾‹æ˜¯åœ¨è¿›è¡Œä»£ç è®¾è®¡ä¹‹å‰å†™çš„ï¼Œå¾ˆæœ‰å¯èƒ½é™åˆ¶å¼€å‘è€…å¯¹ä»£ç çš„æ•´ä½“è®¾è®¡ï¼›å¹¶ä¸”ï¼Œç”±äºTDDå¯¹å¼€å‘â¼ˆå‘˜è¦æ±‚éå¸¸é«˜ï¼Œä½“ç°çš„æ€æƒ³è·Ÿä¼ ç»Ÿå¼€å‘æ€ç»´ä¹Ÿä¸â¼€æ ·ï¼Œå› æ­¤å®æ–½èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼›æ­¤å¤–ï¼Œå› ä¸ºè¦å…ˆç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ŒTDDä¹Ÿå¯èƒ½ä¼šå½±å“é¡¹ç›®çš„ç ”å‘è¿›åº¦ã€‚æ‰€ä»¥ï¼Œåœ¨å®¢è§‚æƒ…å†µä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¸åº”è¯¥ç›²ç›®è¿½æ±‚å¯¹ä¸šåŠ¡ä»£ç ä½¿ç”¨TDDçš„å¼€å‘æ¨¡å¼ã€‚**

### **ä¸ç¼–ç åŒæ­¥è¿›è¡Œï¼šå¢é‡**

**åŠæ—¶ä¸ºå¢é‡ä»£ç å†™å•æµ‹æ˜¯ä¸€ç§è‰¯å¥½çš„ä¹ æƒ¯ã€‚ä¸€æ–¹é¢æ˜¯å› ä¸ºï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹éœ€æ±‚æœ‰ä¸€å®šçš„ç†è§£ï¼Œèƒ½å¤Ÿæ›´å¥½åœ°å†™å‡ºå•å…ƒæµ‹è¯•æ¥éªŒè¯æ­£ç¡®æ€§ã€‚å¹¶ä¸”ï¼Œåœ¨å•æµ‹é˜¶æ®µå°±å‘ç°é—®é¢˜ï¼Œè€Œä¸æ˜¯ç­‰åˆ°è”è°ƒæµ‹è¯•ä¸­æ‰å‘ç°ï¼Œä¿®å¤çš„æˆæœ¬ä¹Ÿæ˜¯æœ€å°çš„ã€‚**

**å¦ä¸€æ–¹é¢ï¼Œåœ¨å†™å•æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿåæ€ä¸šåŠ¡ä»£ç çš„æ­£ç¡®æ€§ã€åˆç†æ€§ï¼Œæ¨åŠ¨æˆ‘ä»¬åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æ›´å¥½åœ°åæ€ä»£ç çš„è®¾è®¡ï¼Œå¹¶åŠæ—¶è°ƒæ•´ã€‚**

### **ç¼–ç åï¼šå­˜é‡**

**åœ¨å®Œæˆä¸šåŠ¡éœ€æ±‚åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼šå› ä¸ºä¸Šçº¿æ—¶é—´æ¯”è¾ƒç´§å¼ ã€æ²¡æœ‰å•æµ‹ç›¸å…³è§„åˆ’ï¼Œå¼€å‘é˜¶æ®µåªæ‰‹åŠ¨æµ‹è¯•äº†ä»£ç æ˜¯å¦ç¬¦åˆåŠŸèƒ½ã€‚**

**å¦‚æœè¿™éƒ¨åˆ†å­˜é‡ä»£ç å‡ºç°è¾ƒå¤§çš„æ–°éœ€æ±‚ï¼Œæˆ–è€…ç»´æŠ¤å·²ç»æˆä¸ºé—®é¢˜ï¼Œéœ€è¦å¤§è§„æ¨¡é‡æ„ï¼Œè¿™æ­£æ˜¯æ¨åŠ¨è¡¥å…¨å•æµ‹çš„å¥½æ—¶æœºã€‚ä¸ºå­˜é‡ä»£ç è¡¥å……ä¸Šå•æµ‹ï¼Œä¸€æ–¹é¢èƒ½å¤Ÿæ¨è¿›é‡æ„è€…è¿›ä¸€æ­¥ç†è§£åŸå…ˆçš„é€»è¾‘ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿèƒ½å¤Ÿå¢å¼ºé‡æ„è€…é‡æ„ä»£ç åçš„ä¿¡å¿ƒï¼Œé™ä½é£é™©ã€‚**

**ä½†æ˜¯ï¼Œè¡¥å……å­˜é‡å•æµ‹å¯èƒ½éœ€è¦å†æ¬¡å›å¿†ç†è§£éœ€æ±‚å’Œé€»è¾‘è®¾è®¡ç­‰ç»†èŠ‚ï¼Œè€Œæœ‰æ—¶å†™å•æµ‹çš„äººå¹¶ä¸æ˜¯åŸç¼–ç çš„è®¾è®¡è€…ï¼Œæ‰€ä»¥ç¼–ç åç¼–å†™å’Œæ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ä¹Ÿæœ‰ä¸€å®šçš„ä¸è¶³ã€‚**

## **æµ‹è¯•è¦†ç›–ç‡**

**æˆ‘ä»¬å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™åº”è¯¥æƒ³å¾—å¾ˆå…¨é¢ï¼Œèƒ½å¤Ÿè¦†ç›–åˆ°æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œä½†æœ‰æ—¶ä¹Ÿä¼šæ¼è¿‡ä¸€äº› caseï¼ŒGoæä¾›äº†coverå·¥å…·æ¥ç»Ÿè®¡æµ‹è¯•è¦†ç›–ç‡ã€‚å…·ä½“å¯ä»¥åˆ†ä¸ºä¸¤å¤§æ­¥éª¤ã€‚**

**ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ•°æ®ï¼š**

```
$ go test -coverprofile=coverage.outdo some setupPASScoverage: 40.0% of statementsdo some cleanupok  	github.com/marmotedu/gopractise-demo/test	0.003s
```

**ä¸Šé¢çš„å‘½ä»¤åœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆäº†`coverage.out`è¦†ç›–ç‡æ•°æ®æ–‡ä»¶ã€‚**

**[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/3c/01/3c11a0d41d6ed736f364c1693a2eff01.png?wh=1920x366)](https://static001.geekbang.org/resource/image/3c/01/3c11a0d41d6ed736f364c1693a2eff01.png?wh=1920x366)**

**ç¬¬äºŒæ­¥ï¼Œåˆ†æè¦†ç›–ç‡æ–‡ä»¶ï¼š**

```
$ go tool cover -func=coverage.outdo some setupPASScoverage: 40.0% of statementsdo some cleanupok  	github.com/marmotedu/gopractise-demo/test	0.003s[colin@dev test]$ go tool cover -func=coverage.outgithub.com/marmotedu/gopractise-demo/test/math.go:9:	Abs		100.0%github.com/marmotedu/gopractise-demo/test/math.go:14:	Max		100.0%github.com/marmotedu/gopractise-demo/test/math.go:19:	Min		0.0%github.com/marmotedu/gopractise-demo/test/math.go:24:	RandInt		0.0%github.com/marmotedu/gopractise-demo/test/math.go:29:	Floor		0.0%total:							(statements)	40.0%
```

**åœ¨ä¸Šè¿°å‘½ä»¤çš„è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ°å“ªäº›å‡½æ•°æ²¡æœ‰æµ‹è¯•ï¼Œå“ªäº›å‡½æ•°å†…éƒ¨çš„åˆ†æ”¯æ²¡æœ‰æµ‹è¯•å®Œå…¨ã€‚coverå·¥å…·ä¼šæ ¹æ®è¢«æ‰§è¡Œä»£ç çš„è¡Œæ•°ä¸æ€»è¡Œæ•°çš„æ¯”ä¾‹è®¡ç®—å‡ºè¦†ç›–ç‡ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒAbså’ŒMaxå‡½æ•°çš„æµ‹è¯•è¦†ç›–ç‡ä¸º100%ï¼ŒMinå’ŒRandIntçš„æµ‹è¯•è¦†ç›–ç‡ä¸º0ã€‚**

**æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨`go tool cover -html`ç”Ÿæˆ`HTML`æ ¼å¼çš„åˆ†ææ–‡ä»¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ™°åœ°å±•ç¤ºä»£ç çš„æµ‹è¯•æƒ…å†µï¼š**

```
$ go tool cover -html=coverage.out -o coverage.html
```

**ä¸Šè¿°å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª`coverage.html`æ–‡ä»¶ï¼Œç”¨æµè§ˆå™¨æ‰“å¼€`coverage.html`æ–‡ä»¶ï¼Œå¯ä»¥æ›´åŠ æ¸…æ™°åœ°çœ‹åˆ°ä»£ç çš„æµ‹è¯•æƒ…å†µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**

**[![img](https://static001.geekbang.org/resource/image/f0/5e/f089f5d44ba06f052c1c46c858c2b75e.png?wh=1524x1075)](https://static001.geekbang.org/resource/image/f0/5e/f089f5d44ba06f052c1c46c858c2b75e.png?wh=1524x1075)**

**é€šè¿‡ä¸Šå›¾ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“çº¢è‰²éƒ¨åˆ†çš„ä»£ç æ²¡æœ‰è¢«æµ‹è¯•åˆ°ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ¥ä¸‹æ¥æœ‰é’ˆå¯¹æ€§åœ°æ·»åŠ æµ‹è¯•ç”¨ä¾‹ï¼Œè€Œä¸æ˜¯ä¸€å¤´é›¾æ°´ï¼Œä¸çŸ¥é“éœ€è¦ä¸ºå“ªäº›ä»£ç ç¼–å†™æµ‹è¯•ç”¨ä¾‹ã€‚**

**åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæŠŠæµ‹è¯•è¦†ç›–ç‡ä½œä¸ºä»£ç åˆå¹¶çš„ä¸€ä¸ªå¼ºåˆ¶è¦æ±‚ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¿›è¡Œä»£ç æµ‹è¯•æ—¶ï¼ŒåŒæ—¶ç”Ÿæˆä»£ç è¦†ç›–ç‡æ•°æ®æ–‡ä»¶ã€‚åœ¨è¿›è¡Œä»£ç æµ‹è¯•æ—¶ï¼Œå¯ä»¥é€šè¿‡åˆ†æè¯¥æ–‡ä»¶ï¼Œæ¥åˆ¤æ–­æˆ‘ä»¬çš„ä»£ç æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œå¦‚æœä¸æ»¡è¶³åˆ™ä»£ç æµ‹è¯•å¤±è´¥ã€‚**

## **IAMé¡¹ç›®æµ‹è¯•å®æˆ˜**

**æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ä»‹ç»ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•ç¼–å†™å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ï¼Œä½ å¯ä»¥é€šè¿‡IAMé¡¹ç›®çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŠ æ·±å¯¹ä¸Šé¢å†…å®¹çš„ç†è§£ã€‚**

### **IAMé¡¹ç›®æ˜¯å¦‚ä½•è¿è¡Œæµ‹è¯•ç”¨ä¾‹çš„ï¼Ÿ**

**é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹IAMé¡¹ç›®æ˜¯å¦‚ä½•æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹çš„ã€‚**

**åœ¨IAMé¡¹ç›®çš„æºç æ ¹ç›®å½•ä¸‹ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œ`make test`æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œ`make test`ä¼šæ‰§è¡Œ`iam/scripts/make-rules/golang.mk`æ–‡ä»¶ä¸­çš„`go.test`ä¼ªç›®æ ‡ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š**

```makefile
.PHONY: go.testgo.test: tools.verify.go-junit-report  @echo "===========> Run unit test"  @set -o pipefail;$(GO) test -race -cover -coverprofile=$(OUTPUT_DIR)/coverage.out     -timeout=10m -short -v go list ./...| egrep -v $(subst $(SPACE),'|',$(sort $(EXCLUDE_TESTS))) 2>&1 |     tee >(go-junit-report --set-exit-code >$(OUTPUT_DIR)/report.xml)  @sed -i '/mock..go/d' $(OUTPUT_DIR)/coverage.out # remove mock_..go files from test coverage  @$(GO) tool cover -html=$(OUTPUT_DIR)/coverage.out -o $(OUTPUT_DIR)/coverage.html
```

*åœ¨ä¸Šè¿°è§„åˆ™ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ`go test`æ—¶è®¾ç½®äº†è¶…æ—¶æ—¶é—´ã€ç«æ€æ£€æŸ¥ï¼Œå¼€å¯äº†ä»£ç è¦†ç›–ç‡æ£€æŸ¥ï¼Œè¦†ç›–ç‡æµ‹è¯•æ•°æ®ä¿å­˜åœ¨äº†`coverage.out`æ–‡ä»¶ä¸­ã€‚åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„åŒ…éƒ½éœ€è¦å•å…ƒæµ‹è¯•ï¼Œæ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤è¿˜è¿‡æ»¤æ‰äº†ä¸€äº›ä¸éœ€è¦æµ‹è¯•çš„åŒ…ï¼Œè¿™äº›åŒ…é…ç½®åœ¨`EXCLUDE_TESTS`å˜é‡ä¸­ï¼š*

```
EXCLUDE_TESTS=github.com/marmotedu/iam/test github.com/marmotedu/iam/pkg/log github.com/marmotedu/iam/third_party github.com/marmotedu/iam/internal/pump/storage github.com/marmotedu/iam/internal/pump github.com/marmotedu/iam/internal/pkg/logger
```

*åŒæ—¶ï¼Œä¹Ÿè°ƒç”¨äº†`go-junit-report`å°†go testçš„ç»“æœè½¬åŒ–æˆäº†xmlæ ¼å¼çš„æŠ¥å‘Šæ–‡ä»¶ï¼Œè¯¥æŠ¥å‘Šæ–‡ä»¶ä¼šè¢«ä¸€äº›CIç³»ç»Ÿï¼Œä¾‹å¦‚Jenkinsæ‹¿æ¥è§£æå¹¶å±•ç¤ºç»“æœã€‚ä¸Šè¿°ä»£ç ä¹ŸåŒæ—¶ç”Ÿæˆäº†coverage.htmlæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å­˜æ”¾åœ¨åˆ¶å“åº“ä¸­ï¼Œä¾›æˆ‘ä»¬åæœŸåˆ†ææŸ¥çœ‹ã€‚*

*è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒMockçš„ä»£ç æ˜¯ä¸éœ€è¦ç¼–å†™æµ‹è¯•ç”¨ä¾‹çš„ï¼Œä¸ºäº†é¿å…å½±å“é¡¹ç›®çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œéœ€è¦å°†Mockä»£ç çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ•°æ®ä»`coverage.out`æ–‡ä»¶ä¸­åˆ é™¤æ‰ï¼Œ`go.test`è§„åˆ™é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ é™¤è¿™äº›æ— ç”¨çš„æ•°æ®ï¼š*

```bash
sed -i '/mock_..go/d' $(OUTPUT_DIR)/coverage.out # remove mock_.*.go files from test coverage
```

å¦å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡`make cover`æ¥è¿›è¡Œå•å…ƒæµ‹è¯•è¦†ç›–ç‡æµ‹è¯•ï¼Œ`make cover`ä¼šæ‰§è¡Œ`iam/scripts/make-rules/golang.mk`æ–‡ä»¶ä¸­çš„`go.test.cover`ä¼ªç›®æ ‡ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š

```makefile
.PHONY: go.test.covergo.test.cover: go.test  @$(GO) tool cover -func=$(OUTPUT_DIR)/coverage.out |     awk -v target=$(COVERAGE) -f $(ROOT_DIR)/scripts/coverage.awk
```

ä¸Šè¿°ç›®æ ‡ä¾èµ–`go.test`ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œå•å…ƒæµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ä¹‹å‰ï¼Œä¼šå…ˆè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œç„¶åä½¿ç”¨å•å…ƒæµ‹è¯•äº§ç”Ÿçš„è¦†ç›–ç‡æ•°æ®`coverage.out`è®¡ç®—å‡ºæ€»çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œè¿™é‡Œæ˜¯é€šè¿‡[coverage.awk](https://github.com/marmotedu/iam/blob/v1.0.8/scripts/coverage.awk)è„šæœ¬æ¥è®¡ç®—çš„ã€‚

å¦‚æœå•å…ƒæµ‹è¯•è¦†ç›–ç‡ä¸è¾¾æ ‡ï¼ŒMakefileä¼šæŠ¥é”™å¹¶é€€å‡ºã€‚å¯ä»¥é€šè¿‡Makefileçš„[COVERAGE](https://github.com/marmotedu/iam/blob/master/scripts/make-rules/common.mk#L39-L41)å˜é‡æ¥è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡é˜ˆå€¼ã€‚

COVERAGEçš„é»˜è®¤å€¼ä¸º60ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰‹åŠ¨æŒ‡å®šï¼Œä¾‹å¦‚ï¼š

```bash
$ make cover COVERAGE=80
```

ä¸ºäº†ç¡®ä¿é¡¹ç›®çš„å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡ï¼Œéœ€è¦è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡è´¨é‡çº¢çº¿ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›çº¢çº¿å¾ˆéš¾é å¼€å‘è€…çš„è‡ªè§‰æ€§å»ä¿éšœï¼Œæ‰€ä»¥å¥½çš„æ–¹æ³•æ˜¯å°†è´¨é‡çº¢çº¿åŠ å…¥åˆ°CICDæµç¨‹ä¸­ã€‚

æ‰€ä»¥ï¼Œåœ¨`Makefile`æ–‡ä»¶ä¸­ï¼Œæˆ‘å°†`cover`æ”¾åœ¨`all`ç›®æ ‡çš„ä¾èµ–ä¸­ï¼Œå¹¶ä¸”ä½äºbuildä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯`all: gen add-copyright format lint cover build`ã€‚è¿™æ ·æ¯æ¬¡å½“æˆ‘ä»¬æ‰§è¡Œmakeæ—¶ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œä»£ç æµ‹è¯•ï¼Œå¹¶è®¡ç®—å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œå¦‚æœè¦†ç›–ç‡ä¸è¾¾æ ‡ï¼Œåˆ™åœæ­¢æ„å»ºï¼›å¦‚æœè¾¾æ ‡ï¼Œç»§ç»­è¿›å…¥ä¸‹ä¸€æ­¥çš„æ„å»ºæµç¨‹ã€‚

### IAMé¡¹ç›®æµ‹è¯•æ¡ˆä¾‹åˆ†äº«

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šç»™ä½ å±•ç¤ºä¸€äº›IAMé¡¹ç›®çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œå› ä¸ºè¿™äº›æµ‹è¯•æ¡ˆä¾‹çš„å®ç°æ–¹æ³•ï¼Œæˆ‘åœ¨[36è®²](https://time.geekbang.org/column/article/408529) å’Œè¿™ä¸€è®²çš„å‰åŠéƒ¨åˆ†å·²æœ‰è¯¦ç»†ä»‹ç»ï¼Œæ‰€ä»¥è¿™é‡Œï¼Œæˆ‘åªåˆ—å‡ºå…·ä½“çš„å®ç°ä»£ç ï¼Œä¸ä¼šå†ä»‹ç»è¿™äº›ä»£ç çš„å®ç°æ–¹æ³•ã€‚

1. å•å…ƒæµ‹è¯•æ¡ˆä¾‹

æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ç¼–å†™å•å…ƒæµ‹è¯•ä»£ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ä»£ç ã€‚

å…ˆæ¥çœ‹æ‰‹åŠ¨ç¼–å†™æµ‹è¯•ä»£ç çš„æ¡ˆä¾‹ã€‚è¿™é‡Œå•å…ƒæµ‹è¯•ä»£ç è§[Test_Option](https://github.com/marmotedu/iam/blob/v1.0.8/pkg/log/log_test.go#L52-L62)ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func Test_Option(t *testing.T) {    fs := pflag.NewFlagSet("test", pflag.ExitOnError)    opt := log.NewOptions()    opt.AddFlags(fs)    args := []string{"--log.level=debug"}    err := fs.Parse(args)    assert.Nil(t, err)    assert.Equal(t, "debug", opt.Level)}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œä½¿ç”¨äº†`github.com/stretchr/testify/assert`åŒ…æ¥å¯¹æ¯”ç»“æœã€‚

å†æ¥çœ‹ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆå•å…ƒæµ‹è¯•ä»£ç çš„æ¡ˆä¾‹ï¼ˆTable-Driven çš„æµ‹è¯•æ¨¡å¼ï¼‰ã€‚å‡ºäºæ•ˆç‡ä¸Šçš„è€ƒè™‘ï¼ŒIAMé¡¹ç›®çš„å•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼ŒåŸºæœ¬éƒ½æ˜¯ä½¿ç”¨gotestså·¥å…·ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ¨¡æ¿ä»£ç ï¼Œå¹¶åŸºäºè¿™äº›æ¨¡æ¿ä»£ç å¡«å……æµ‹è¯•Caseçš„ã€‚ä»£ç è§[service_test.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/service_test.go)æ–‡ä»¶ã€‚

1. æ€§èƒ½æµ‹è¯•æ¡ˆä¾‹

IAMé¡¹ç›®çš„æ€§èƒ½æµ‹è¯•ç”¨ä¾‹ï¼Œè§[BenchmarkListUser](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go#L27-L41)æµ‹è¯•å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```go
func BenchmarkListUser(b *testing.B) {	opts := metav1.ListOptions{		Offset: pointer.ToInt64(0),		Limit:  pointer.ToInt64(50),	}	storeIns, _ := fake.GetFakeFactoryOr()	u := &userService{		store: storeIns,	}	for i := 0; i < b.N; i++ {		_, _ = u.List(context.TODO(), opts)	}}
```

1. ç¤ºä¾‹æµ‹è¯•æ¡ˆä¾‹

IAMé¡¹ç›®çš„ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹è§[example_test.go](https://github.com/marmotedu/errors/blob/v1.0.2/example_test.go)æ–‡ä»¶ã€‚`example_test.go`ä¸­çš„ä¸€ä¸ªç¤ºä¾‹æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```go
func ExampleNew() {	err := New("whoops")	fmt.Println(err)	// Output: whoops}
```

1. TestMainæµ‹è¯•æ¡ˆä¾‹

IAMé¡¹ç›®çš„TestMainæµ‹è¯•æ¡ˆä¾‹ï¼Œè§[user_test.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go)æ–‡ä»¶ä¸­çš„`TestMain`å‡½æ•°ï¼š

```go
func TestMain(m *testing.M) {    _, _ = fake.GetFakeFactoryOr()    os.Exit(m.Run())}
```

`TestMain`å‡½æ•°åˆå§‹åŒ–äº†fake Factoryï¼Œç„¶åè°ƒç”¨`m.Run`æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚

1. Mockæµ‹è¯•æ¡ˆä¾‹

Mockä»£ç è§[internal/apiserver/service/v1/mock_service.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/mock_service.go)ï¼Œä½¿ç”¨Mockçš„æµ‹è¯•ç”¨ä¾‹è§[internal/apiserver/controller/v1/user/create_test.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/controller/v1/user/create_test.go)æ–‡ä»¶ã€‚å› ä¸ºä»£ç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå»ºè®®ä½ æ‰“å¼€é“¾æ¥ï¼ŒæŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹çš„å…·ä½“å®ç°ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨IAMé¡¹ç›®çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰çš„Mockæ–‡ä»¶ï¼š

```bash
$ go generate ./...
```

1. Fakeæµ‹è¯•æ¡ˆä¾‹

fake storeä»£ç å®ç°ä½äº[internal/apiserver/store/fake](https://github.com/marmotedu/iam/tree/v1.0.8/internal/apiserver/store/fake)ç›®å½•ä¸‹ã€‚fake storeçš„ä½¿ç”¨æ–¹å¼ï¼Œè§[user_test.go](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/service/v1/user_test.go)æ–‡ä»¶ï¼š

```go
func TestMain(m *testing.M) {    _, _ = fake.GetFakeFactoryOr()    os.Exit(m.Run())}func BenchmarkListUser(b *testing.B) {    opts := metav1.ListOptions{        Offset: pointer.ToInt64(0),        Limit:  pointer.ToInt64(50),    }    storeIns, _ := fake.GetFakeFactoryOr()    u := &userService{        store: storeIns,    }    for i := 0; i < b.N; i++ {        _, _ = u.List(context.TODO(), opts)    }}
```

ä¸Šè¿°ä»£ç é€šè¿‡`TestMain`åˆå§‹åŒ–fakeå®ä¾‹ï¼ˆ[store.Factory](https://github.com/marmotedu/iam/blob/v1.0.8/internal/apiserver/store/store.go#L12-L17)æ¥å£ç±»å‹ï¼‰ï¼š

```go
func GetFakeFactoryOr() (store.Factory, error) {    once.Do(func() {        fakeFactory = &datastore{            users:    FakeUsers(ResourceCount),            secrets:  FakeSecrets(ResourceCount),            policies: FakePolicies(ResourceCount),        }    })    if fakeFactory == nil {        return nil, fmt.Errorf("failed to get mysql store fatory, mysqlFactory: %+v", fakeFactory)    }    return fakeFactory, nil}
```

`GetFakeFactoryOr`å‡½æ•°ï¼Œåˆ›å»ºäº†ä¸€äº›fake usersã€secretsã€policiesï¼Œå¹¶ä¿å­˜åœ¨äº†`fakeFactory`å˜é‡ä¸­ï¼Œä¾›åé¢çš„æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ï¼Œä¾‹å¦‚BenchmarkListUserã€Test_newUsersç­‰ã€‚

## å…¶ä»–æµ‹è¯•å·¥å…·/åŒ…

æœ€åï¼Œæˆ‘å†æ¥åˆ†äº«ä¸‹Goé¡¹ç›®æµ‹è¯•ä¸­å¸¸ç”¨çš„å·¥å…·/åŒ…ï¼Œå› ä¸ºå†…å®¹è¾ƒå¤šï¼Œæˆ‘å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚æœæ„Ÿå…´è¶£ä½ å¯ä»¥ç‚¹è¿›é“¾æ¥è‡ªè¡Œå­¦ä¹ ã€‚æˆ‘å°†è¿™äº›æµ‹è¯•å·¥å…·/åŒ…åˆ†ä¸ºäº†ä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯æµ‹è¯•æ¡†æ¶å’ŒMockå·¥å…·ã€‚

### æµ‹è¯•æ¡†æ¶

+ [Testifyæ¡†æ¶](https://github.com/stretchr/testify)ï¼šTestifyæ˜¯Go testçš„é¢„åˆ¤å·¥å…·ï¼Œå®ƒèƒ½è®©ä½ çš„æµ‹è¯•ä»£ç å˜å¾—æ›´ä¼˜é›…å’Œé«˜æ•ˆï¼Œæµ‹è¯•ç»“æœä¹Ÿå˜å¾—æ›´è¯¦ç»†ã€‚
+ [GoConveyæ¡†æ¶](https://github.com/smartystreets/goconvey)ï¼šGoConveyæ˜¯ä¸€æ¬¾é’ˆå¯¹Golangçš„æµ‹è¯•æ¡†æ¶ï¼Œå¯ä»¥ç®¡ç†å’Œè¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ŒåŒæ—¶æä¾›äº†ä¸°å¯Œçš„æ–­è¨€å‡½æ•°ï¼Œå¹¶æ”¯æŒå¾ˆå¤š Web ç•Œé¢ç‰¹æ€§ã€‚

### Mockå·¥å…·

è¿™ä¸€è®²é‡Œï¼Œæˆ‘ä»‹ç»äº†Goå®˜æ–¹æä¾›çš„Mockæ¡†æ¶GoMockï¼Œä¸è¿‡è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä¼˜ç§€Mockå·¥å…·å¯ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚è¿™äº›Mockå·¥å…·åˆ†åˆ«ç”¨åœ¨ä¸åŒçš„Mockåœºæ™¯ä¸­ï¼Œæˆ‘åœ¨ [10è®²](https://time.geekbang.org/column/article/384648)ä¸­å·²ç»ä»‹ç»è¿‡ã€‚ä¸è¿‡ï¼Œä¸ºäº†ä½¿æˆ‘ä»¬è¿™ä¸€è®²çš„æµ‹è¯•çŸ¥è¯†ä½“ç³»æ›´åŠ å®Œæ•´ï¼Œè¿™é‡Œæˆ‘è¿˜æ˜¯å†æä¸€æ¬¡ï¼Œä½ å¯ä»¥å¤ä¹ ä¸€éã€‚

+ [sqlmock](https://github.com/DATA-DOG/go-sqlmock)ï¼šå¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥ã€‚æ•°æ®åº“æ˜¯é¡¹ç›®ä¸­æ¯”è¾ƒå¸¸è§çš„ä¾èµ–ï¼Œåœ¨é‡åˆ°æ•°æ®åº“ä¾èµ–æ—¶éƒ½å¯ä»¥ç”¨å®ƒã€‚
+ [httpmock](https://github.com/jarcoal/httpmock)ï¼šå¯ä»¥ç”¨æ¥Mock HTTPè¯·æ±‚ã€‚
+ [bouk/monkey](https://github.com/bouk/monkey)ï¼šçŒ´å­è¡¥ä¸ï¼Œèƒ½å¤Ÿé€šè¿‡æ›¿æ¢å‡½æ•°æŒ‡é’ˆçš„æ–¹å¼æ¥ä¿®æ”¹ä»»æ„å‡½æ•°çš„å®ç°ã€‚å¦‚æœgolang/mockã€sqlmockå’Œhttpmockè¿™å‡ ç§æ–¹æ³•éƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç”¨çŒ´å­è¡¥ä¸çš„æ–¹å¼æ¥Mockä¾èµ–ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼ŒçŒ´å­è¡¥ä¸æä¾›äº†å•å…ƒæµ‹è¯• Mock ä¾èµ–çš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‚

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†é™¤å•å…ƒæµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ä¹‹å¤–çš„å¦ä¸€äº›æµ‹è¯•æ–¹æ³•ã€‚

é™¤äº†ç¤ºä¾‹æµ‹è¯•å’ŒTestMainå‡½æ•°ï¼Œæˆ‘è¿˜è¯¦ç»†ä»‹ç»äº†Mockæµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ä½¿ç”¨GoMockæ¥æµ‹è¯•ä¸€äº›åœ¨å•å…ƒæµ‹è¯•ç¯å¢ƒä¸‹ä¸å¥½å®ç°çš„æ¥å£ã€‚ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨GoMockæ¥Mockæ¥å£ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒå¤æ‚çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Fakeä¸€ä¸ªæ¥å£å®ç°ï¼Œæ¥å¯¹ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¹Ÿç§°ä¸ºFakeæµ‹è¯•ã€‚

æ­¤å¤–ï¼Œæˆ‘è¿˜ä»‹ç»äº†ä½•æ—¶ç¼–å†™å’Œæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€‰æ‹©åœ¨ç¼–å†™ä»£ç å‰ã€ç¼–å†™ä»£ç ä¸­ã€ç¼–å†™ä»£ç åç¼–å†™æµ‹è¯•ç”¨ä¾‹ã€‚

ä¸ºäº†ä¿è¯å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥ä¸ºæ•´ä¸ªé¡¹ç›®è®¾ç½®å•å…ƒæµ‹è¯•è¦†ç›–ç‡è´¨é‡çº¢çº¿ï¼Œå¹¶å°†è¯¥è´¨é‡çº¢çº¿åŠ å…¥åˆ°CICDæµç¨‹ä¸­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ `go test -coverprofile=coverage.out` å‘½ä»¤æ¥ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æ•°æ®ï¼Œé€šè¿‡`go tool cover -func=coverage.out` å‘½ä»¤æ¥åˆ†æè¦†ç›–ç‡æ–‡ä»¶ã€‚

IAMé¡¹ç›®ä¸­ä½¿ç”¨äº†å¤§é‡çš„æµ‹è¯•æ–¹æ³•å’ŒæŠ€å·§æ¥æµ‹è¯•ä»£ç ï¼Œä¸ºäº†åŠ æ·±ä½ å¯¹æµ‹è¯•çŸ¥è¯†çš„ç†è§£ï¼Œæˆ‘ä¹Ÿåˆ—ä¸¾äº†ä¸€äº›æµ‹è¯•æ¡ˆä¾‹ï¼Œä¾›ä½ å‚è€ƒã€å­¦ä¹ å’ŒéªŒè¯ã€‚å…·ä½“çš„æµ‹è¯•æ¡ˆä¾‹ï¼Œä½ å¯ä»¥è¿”å›å‰é¢æŸ¥çœ‹ä¸‹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–ä¸€äº›æµ‹è¯•æ¡†æ¶ï¼Œä¾‹å¦‚Testifyæ¡†æ¶å’ŒGoConveyæ¡†æ¶ã€‚åœ¨Goä»£ç æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„æ˜¯Goå®˜æ–¹æä¾›çš„Mockæ¡†æ¶GoMockï¼Œä½†ä»ç„¶æœ‰å…¶ä»–ä¼˜ç§€çš„Mockå·¥å…·ï¼Œå¯ä¾›æˆ‘ä»¬åœ¨ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚sqlmockã€httpmockã€bouk/monkeyç­‰ã€‚

## è¯¾åä¹ é¢˜

1. è¯·ä½¿ç”¨ [sqlmock](https://github.com/DATA-DOG/go-sqlmock) æ¥Mockä¸€ä¸ªGORMæ•°æ®åº“å®ä¾‹ï¼Œå¹¶å®ŒæˆGORMçš„CURDå•å…ƒæµ‹è¯•ç”¨ä¾‹ç¼–å†™ã€‚
2. æ€è€ƒä¸‹ï¼Œåœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œè¿˜æœ‰å“ªäº›ä¼˜ç§€çš„æµ‹è¯•æ¡†æ¶ã€æµ‹è¯•å·¥å…·ã€Mockå·¥å…·ä»¥åŠæµ‹è¯•æŠ€å·§ï¼Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚



## END é“¾æ¥

<ul><li><div><a href = '28.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '30.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

