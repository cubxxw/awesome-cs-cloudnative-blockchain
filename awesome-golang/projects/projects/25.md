+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬25èŠ‚  SDK è®¾è®¡ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•è®¾è®¡å‡ºä¸€ä¸ªä¼˜ç§€çš„ Go SDKï¼Ÿ

<br>
<div><a href = '24.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '26.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å¼€å§‹

ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚æ¥ä¸‹æ¥çš„ä¸¤è®²ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•è®¾è®¡å’Œå®ç°ä¸€ä¸ªä¼˜ç§€çš„Go SDKã€‚

åç«¯æœåŠ¡é€šè¿‡APIæ¥å£å¯¹å¤–æä¾›åº”ç”¨çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”¨æˆ·ç›´æ¥è°ƒç”¨APIæ¥å£ï¼Œéœ€è¦ç¼–å†™APIæ¥å£è°ƒç”¨çš„é€»è¾‘ï¼Œå¹¶ä¸”éœ€è¦æ„é€ å…¥å‚å’Œè§£æè¿”å›çš„æ•°æ®åŒ…ï¼Œä½¿ç”¨èµ·æ¥æ•ˆç‡ä½ï¼Œè€Œä¸”æœ‰ä¸€å®šçš„å¼€å‘å·¥ä½œé‡ã€‚

åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œé€šå¸¸ä¼šæä¾›å¯¹å¼€å‘è€…æ›´å‹å¥½çš„SDKåŒ…ï¼Œä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚å¾ˆå¤šå¤§å‹æœåŠ¡åœ¨å‘å¸ƒæ—¶éƒ½ä¼šä¼´éšç€SDKçš„å‘å¸ƒï¼Œä¾‹å¦‚è…¾è®¯äº‘å¾ˆå¤šäº§å“éƒ½æä¾›äº†SDKï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e1/fa/e1bb8eb03c2f26f546710e95751c17fa.png?wh=1920x747)](https://static001.geekbang.org/resource/image/e1/fa/e1bb8eb03c2f26f546710e95751c17fa.png?wh=1920x747)

æ—¢ç„¶SDKå¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆå¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„Go SDKå‘¢ï¼Ÿè¿™ä¸€è®²æˆ‘å°±æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹ã€‚

## ä»€ä¹ˆæ˜¯SDKï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯SDKã€‚

å¯¹äºSDKï¼ˆSoftware Development Kitï¼Œè½¯ä»¶å¼€å‘å·¥å…·åŒ…ï¼‰ï¼Œä¸åŒåœºæ™¯ä¸‹æœ‰ä¸åŒçš„è§£é‡Šã€‚ä½†æ˜¯å¯¹äºä¸€ä¸ªGoåç«¯æœåŠ¡æ¥è¯´ï¼ŒSDKé€šå¸¸æ˜¯æŒ‡**å°è£…äº†Goåç«¯æœåŠ¡APIæ¥å£çš„è½¯ä»¶åŒ…**ï¼Œé‡Œé¢é€šå¸¸åŒ…å«äº†è·Ÿè½¯ä»¶ç›¸å…³çš„åº“ã€æ–‡æ¡£ã€ä½¿ç”¨ç¤ºä¾‹ã€å°è£…å¥½çš„APIæ¥å£å’Œå·¥å…·ã€‚

è°ƒç”¨SDKè·Ÿè°ƒç”¨æœ¬åœ°å‡½æ•°æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œæ‰€ä»¥å¯ä»¥æå¤§åœ°æå‡å¼€å‘è€…çš„å¼€å‘æ•ˆç‡å’Œä½“éªŒã€‚SDKå¯ä»¥ç”±æœåŠ¡æä¾›è€…æä¾›ï¼Œä¹Ÿå¯ä»¥ç”±å…¶ä»–ç»„ç»‡æˆ–ä¸ªäººæä¾›ã€‚ä¸ºäº†é¼“åŠ±å¼€å‘è€…ä½¿ç”¨å…¶ç³»ç»Ÿæˆ–è¯­è¨€ï¼ŒSDKé€šå¸¸éƒ½æ˜¯å…è´¹æä¾›çš„ã€‚

é€šå¸¸ï¼ŒæœåŠ¡æä¾›è€…ä¼šæä¾›ä¸åŒè¯­è¨€çš„SDKï¼Œæ¯”å¦‚é’ˆå¯¹Pythonå¼€å‘è€…ä¼šæä¾›Pythonç‰ˆçš„SDKï¼Œé’ˆå¯¹Goå¼€å‘è€…ä¼šæä¾›Goç‰ˆçš„SDKã€‚ä¸€äº›æ¯”è¾ƒä¸“ä¸šçš„å›¢é˜Ÿè¿˜ä¼šæœ‰SDKè‡ªåŠ¨ç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥æ ¹æ®APIæ¥å£å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸åŒè¯­è¨€çš„SDKã€‚ä¾‹å¦‚ï¼ŒProtocol Buffersçš„ç¼–è¯‘å·¥å…·protocï¼Œå°±å¯ä»¥åŸºäºProtobufæ–‡ä»¶ç”ŸæˆC++ã€Pythonã€Javaã€JavaScriptã€PHPç­‰è¯­è¨€ç‰ˆæœ¬çš„SDKã€‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘è¿™äº›ä¸€çº¿å¤§å‚ï¼Œä¹Ÿå¯ä»¥åŸºäºAPIå®šä¹‰ï¼Œç”Ÿæˆä¸åŒç¼–ç¨‹è¯­è¨€çš„SDKã€‚

## SDKè®¾è®¡æ–¹æ³•

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®¾è®¡ä¸€ä¸ªå¥½çš„SDKå‘¢ï¼Ÿå¯¹äºSDKï¼Œä¸åŒå›¢é˜Ÿä¼šæœ‰ä¸åŒçš„è®¾è®¡æ–¹å¼ï¼Œæˆ‘è°ƒç ”äº†ä¸€äº›ä¼˜ç§€SDKçš„å®ç°ï¼Œå‘ç°è¿™äº›SDKæœ‰ä¸€äº›å…±åŒç‚¹ã€‚æ ¹æ®æˆ‘çš„è°ƒç ”ç»“æœï¼Œç»“åˆæˆ‘åœ¨å®é™…å¼€å‘ä¸­çš„ç»éªŒï¼Œæˆ‘æ€»ç»“å‡ºäº†ä¸€å¥—SDKè®¾è®¡æ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±åˆ†äº«ç»™ä½ ã€‚

### å¦‚ä½•ç»™SDKå‘½åï¼Ÿ

åœ¨è®²è®¾è®¡æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸¤ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹ï¼šSDKçš„å‘½åæ–¹å¼å’ŒSDKçš„ç›®å½•ç»“æ„ã€‚

SDKçš„åå­—ç›®å‰æ²¡æœ‰ç»Ÿä¸€çš„è§„èŒƒï¼Œä½†æ¯”è¾ƒå¸¸è§çš„å‘½åæ–¹å¼æ˜¯ `xxx-sdk-go` / `xxx-sdk-python` / `xxx-sdk-java` ã€‚å…¶ä¸­ï¼Œ `xxx` å¯ä»¥æ˜¯é¡¹ç›®åæˆ–è€…ç»„ç»‡åï¼Œä¾‹å¦‚è…¾è®¯äº‘åœ¨GitHubä¸Šçš„ç»„ç»‡åä¸ºtencentcloudï¼Œé‚£å®ƒçš„SDKå‘½åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e2/1e/e269d5d0e19a73d45ccdf5f5561c611e.png?wh=1210x863)](https://static001.geekbang.org/resource/image/e2/1e/e269d5d0e19a73d45ccdf5f5561c611e.png?wh=1210x863)

### SDKçš„ç›®å½•ç»“æ„

ä¸åŒé¡¹ç›®SDKçš„ç›®å½•ç»“æ„ä¹Ÿä¸ç›¸åŒï¼Œä½†ä¸€èˆ¬éœ€è¦åŒ…å«ä¸‹é¢è¿™äº›æ–‡ä»¶æˆ–ç›®å½•ã€‚ç›®å½•åå¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†ç›®å½•åŠŸèƒ½æ˜¯ç±»ä¼¼çš„ã€‚

+ **README.md**ï¼šSDKçš„å¸®åŠ©æ–‡æ¡£ï¼Œé‡Œé¢åŒ…å«äº†å®‰è£…ã€é…ç½®å’Œä½¿ç”¨SDKçš„æ–¹æ³•ã€‚
+ **examples/sample/**ï¼šSDKçš„ä½¿ç”¨ç¤ºä¾‹ã€‚
+ **sdk/**ï¼šSDKå…±äº«çš„åŒ…ï¼Œé‡Œé¢å°è£…äº†æœ€åŸºç¡€çš„é€šä¿¡åŠŸèƒ½ã€‚å¦‚æœæ˜¯HTTPæœåŠ¡ï¼ŒåŸºæœ¬éƒ½æ˜¯åŸºäº `net/http` åŒ…è¿›è¡Œå°è£…ã€‚
+ **api**ï¼šå¦‚æœ `xxx-sdk-go` åªæ˜¯ä¸ºæŸä¸€ä¸ªæœåŠ¡æä¾›SDKï¼Œå°±å¯ä»¥æŠŠè¯¥æœåŠ¡çš„æ‰€æœ‰APIæ¥å£å°è£…ä»£ç å­˜æ”¾åœ¨apiç›®å½•ä¸‹ã€‚
+ **services/{iam, tms}** ï¼šå¦‚æœ `xxx-sdk-go` ä¸­ï¼Œ `xxx` æ˜¯ä¸€ä¸ªç»„ç»‡ï¼Œé‚£ä¹ˆè¿™ä¸ªSDKå¾ˆå¯èƒ½ä¼šé›†æˆè¯¥ç»„ç»‡ä¸­å¾ˆå¤šæœåŠ¡çš„APIï¼Œå°±å¯ä»¥æŠŠæŸç±»æœåŠ¡çš„APIæ¥å£å°è£…ä»£ç å­˜æ”¾åœ¨ `services/<æœåŠ¡å>`ä¸‹ï¼Œä¾‹å¦‚AWSçš„[Go SDK](https://github.com/aws/aws-sdk-go/tree/main/service)ã€‚

ä¸€ä¸ªå…¸å‹çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```bash
â”œâ”€â”€ examples            # ç¤ºä¾‹ä»£ç å­˜æ”¾ç›®å½•â”‚   â””â”€â”€ authz.goâ”œâ”€â”€ README.md           # SDKä½¿ç”¨æ–‡æ¡£â”œâ”€â”€ sdk                 # å…¬å…±åŒ…ï¼Œå°è£…äº†SDKé…ç½®ã€APIè¯·æ±‚ã€è®¤è¯ç­‰ä»£ç â”‚   â”œâ”€â”€ client.goâ”‚   â”œâ”€â”€ config.goâ”‚   â”œâ”€â”€ credential.goâ”‚   â””â”€â”€ ...â””â”€â”€ services            # APIå°è£…    â”œâ”€â”€ common    â”‚   â””â”€â”€ model    â”œâ”€â”€ iam             # iamæœåŠ¡çš„APIæ¥å£    â”‚   â”œâ”€â”€ authz.go    â”‚   â”œâ”€â”€ client.go    â”‚   â””â”€â”€ ...    â””â”€â”€ tms             # tmsæœåŠ¡çš„APIæ¥å£
```

### SDKè®¾è®¡æ–¹æ³•

SDKçš„è®¾è®¡æ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/9f/ca/9fb7aa8d3da4210223e9b0c87943e8ca.jpg?wh=1920x841)](https://static001.geekbang.org/resource/image/9f/ca/9fb7aa8d3da4210223e9b0c87943e8ca.jpg?wh=1920x841)

æˆ‘ä»¬å¯ä»¥é€šè¿‡Configé…ç½®åˆ›å»ºå®¢æˆ·ç«¯Clientï¼Œä¾‹å¦‚ `func NewClient(config sdk.Config) (Client, error)`ï¼Œé…ç½®ä¸­å¯ä»¥æŒ‡å®šä¸‹é¢çš„ä¿¡æ¯ã€‚

+ æœåŠ¡çš„åç«¯åœ°å€ï¼šæœåŠ¡çš„åç«¯åœ°å€å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥é…ç½®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å›ºåŒ–åœ¨SDKä¸­ï¼Œæ¨èåç«¯æœåŠ¡åœ°å€å¯é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®ã€‚
+ è®¤è¯ä¿¡æ¯ï¼šæœ€å¸¸ç”¨çš„è®¤è¯æ–¹å¼æ˜¯é€šè¿‡å¯†é’¥è®¤è¯ï¼Œä¹Ÿæœ‰ä¸€äº›æ˜¯é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è®¤è¯ã€‚
+ å…¶ä»–é…ç½®ï¼šä¾‹å¦‚è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ã€ç¼“å­˜æ—¶é—´ç­‰ã€‚

åˆ›å»ºçš„Clientæ˜¯ä¸€ä¸ªç»“æ„ä½“æˆ–è€…Go interfaceã€‚è¿™é‡Œæˆ‘å»ºè®®ä½ ä½¿ç”¨interfaceç±»å‹ï¼Œè¿™æ ·å¯ä»¥å°†å®šä¹‰å’Œå…·ä½“å®ç°è§£è€¦ã€‚Clientå…·æœ‰ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ CreateUserã€DeleteUserç­‰ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ªAPIæ¥å£ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªClientå®šä¹‰ï¼š

```go
type Client struct {    client *sdk.Request}func (c *Client) CreateUser(req *CreateUserRequest) (*CreateUserResponse, error) {    // normal code    resp := &CreateUserResponse{}    err := c.client.Send(req, resp)    return resp, err}
```

è°ƒç”¨ `client.CreateUser(req)` ä¼šæ‰§è¡ŒHTTPè¯·æ±‚ï¼Œåœ¨ `req` ä¸­å¯ä»¥æŒ‡å®šHTTPè¯·æ±‚çš„æ–¹æ³•Methodã€è·¯å¾„Pathå’Œè¯·æ±‚Bodyã€‚ `CreateUser` å‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ `c.client.Send(req)` æ‰§è¡Œå…·ä½“çš„HTTPè¯·æ±‚ã€‚

`c.client` æ˜¯ `*Request` ç±»å‹çš„å˜é‡ï¼Œ `*Request` ç±»å‹çš„å˜é‡å…·æœ‰ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®ä¼ å…¥çš„è¯·æ±‚å‚æ•° `req` å’Œ `config` é…ç½®æ„é€ å‡ºè¯·æ±‚è·¯å¾„ã€è®¤è¯å¤´å’Œè¯·æ±‚Bodyï¼Œå¹¶è°ƒç”¨ `net/http` åŒ…å®Œæˆæœ€ç»ˆçš„HTTPè¯·æ±‚ï¼Œæœ€åå°†è¿”å›ç»“æœUnmarshalåˆ°ä¼ å…¥çš„ `resp` ç»“æ„ä½“ä¸­ã€‚

æ ¹æ®æˆ‘çš„è°ƒç ”ï¼Œç›®å‰æœ‰ä¸¤ç§SDKè®¾è®¡æ–¹å¼å¯ä¾›å‚è€ƒï¼Œä¸€ç§æ˜¯å„å¤§å…¬æœ‰äº‘å‚å•†é‡‡ç”¨çš„SDKè®¾è®¡æ–¹å¼ï¼Œä¸€ç§æ˜¯Kubernetes client-goçš„è®¾è®¡æ–¹å¼ã€‚IAMé¡¹ç›®åˆ†åˆ«å®ç°äº†è¿™ä¸¤ç§SDKè®¾è®¡æ–¹å¼ï¼Œä½†æˆ‘è¿˜æ˜¯æ›´å€¾å‘äºå¯¹å¤–æä¾›client-goæ–¹å¼çš„SDKï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€è®²è¯¦ç»†ä»‹ç»å®ƒã€‚è¿™ä¸¤ç§è®¾è®¡æ–¹å¼çš„è®¾è®¡æ€è·¯è·Ÿä¸Šé¢ä»‹ç»çš„æ˜¯ä¸€è‡´çš„ã€‚

## å…¬æœ‰äº‘å‚å•†é‡‡ç”¨çš„SDKè®¾è®¡æ–¹å¼

è¿™é‡Œï¼Œæˆ‘å…ˆæ¥ç®€å•ä»‹ç»ä¸‹å…¬æœ‰äº‘å‚å•†é‡‡ç”¨çš„SDKè®¾è®¡æ¨¡å¼ã€‚SDKæ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/82/ce/82ebe90b0490b9a2a76e2f302dd896ce.jpg?wh=1920x866)](https://static001.geekbang.org/resource/image/82/ce/82ebe90b0490b9a2a76e2f302dd896ce.jpg?wh=1920x866)

SDKæ¡†æ¶åˆ†ä¸ºä¸¤å±‚ï¼Œåˆ†åˆ«æ˜¯APIå±‚å’ŒåŸºç¡€å±‚ã€‚APIå±‚ä¸»è¦ç”¨æ¥æ„å»ºå®¢æˆ·ç«¯å®ä¾‹ï¼Œå¹¶è°ƒç”¨å®¢æˆ·ç«¯å®ä¾‹æä¾›çš„æ–¹æ³•æ¥å®ŒæˆAPIè¯·æ±‚ï¼Œæ¯ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ªAPIæ¥å£ã€‚APIå±‚æœ€ç»ˆä¼šè°ƒç”¨åŸºç¡€å±‚æä¾›çš„èƒ½åŠ›ï¼Œæ¥å®ŒæˆREST APIè¯·æ±‚ã€‚åŸºç¡€å±‚é€šè¿‡ä¾æ¬¡æ‰§è¡Œæ„å»ºè¯·æ±‚å‚æ•°ï¼ˆBuilderï¼‰ã€ç­¾å‘å¹¶æ·»åŠ è®¤è¯å¤´ï¼ˆSignerï¼‰ã€æ‰§è¡ŒHTTPè¯·æ±‚ï¼ˆRequestï¼‰ä¸‰å¤§æ­¥éª¤ï¼Œæ¥å®Œæˆå…·ä½“çš„REST APIè¯·æ±‚ã€‚

ä¸ºäº†è®©ä½ æ›´å¥½åœ°ç†è§£å…¬æœ‰äº‘SDKçš„è®¾è®¡æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šç»“åˆä¸€äº›çœŸå®çš„ä»£ç ï¼Œç»™ä½ è®²è§£APIå±‚å’ŒåŸºç¡€å±‚çš„å…·ä½“è®¾è®¡ï¼ŒSDKä»£ç è§[medu-sdk-go](https://github.com/marmotedu/medu-sdk-go)ã€‚

### APIå±‚ï¼šåˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹

å®¢æˆ·ç«¯åœ¨ä½¿ç”¨æœåŠ¡Açš„SDKæ—¶ï¼Œé¦–å…ˆéœ€è¦æ ¹æ®Configé…ç½®åˆ›å»ºä¸€ä¸ªæœåŠ¡Açš„å®¢æˆ·ç«¯Clientï¼ŒClientå®é™…ä¸Šæ˜¯ä¸€ä¸ªstructï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```go
type Client struct 
```

åœ¨åˆ›å»ºå®¢æˆ·ç«¯æ—¶ï¼Œéœ€è¦ä¼ å…¥è®¤è¯ï¼ˆä¾‹å¦‚å¯†é’¥ã€ç”¨æˆ·å/å¯†ç ï¼‰ã€åç«¯æœåŠ¡åœ°å€ç­‰é…ç½®ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é€šè¿‡[NewClientWithSecret](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/services/iam/authz/client.go#L24-L29)æ–¹æ³•æ¥æ„å»ºä¸€ä¸ªå¸¦å¯†é’¥å¯¹çš„å®¢æˆ·ç«¯ï¼š

```go
func NewClientWithSecret(secretID, secretKey string) (client *Client, err error) {    client = &Client{}    config := sdk.NewConfig().WithEndpoint(defaultEndpoint)    client.Init(serviceName).WithSecret(secretID, secretKey).WithConfig(config)    return}
```

è¿™é‡Œè¦æ³¨æ„ï¼Œä¸Šé¢åˆ›å»ºå®¢æˆ·ç«¯æ—¶ï¼Œä¼ å…¥çš„å¯†é’¥å¯¹æœ€ç»ˆä¼šåœ¨åŸºç¡€å±‚ä¸­è¢«ä½¿ç”¨ï¼Œç”¨æ¥ç­¾å‘JWT Tokenã€‚

Clientæœ‰å¤šä¸ªæ–¹æ³•ï¼ˆSenderï¼‰ï¼Œä¾‹å¦‚ Authzç­‰ï¼Œæ¯ä¸ªæ–¹æ³•ä»£è¡¨ä¸€ä¸ªAPIæ¥å£ã€‚Senderæ–¹æ³•ä¼šæ¥æ”¶AuthzRequestç­‰ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆä½œä¸ºè¾“å…¥å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥è°ƒç”¨ `client.Authz(req)` æ¥æ‰§è¡ŒREST APIè°ƒç”¨ã€‚å¯ä»¥åœ¨ `client.Authz` æ–¹æ³•ä¸­æ·»åŠ ä¸€äº›ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚`client.Authz` ä»£ç å¦‚ä¸‹ï¼š

```go
type AuthzRequest struct {    *request.BaseRequest    Resource *string json:"resource"    Action *string json:"action"    Subject *string json:"subject"    Context *ladon.Context}func (c *Client) Authz(req *AuthzRequest) (resp *AuthzResponse, err error) {    if req == nil {        req = NewAuthzRequest()    }    resp = NewAuthzResponse()    err = c.Send(req, resp)    return}
```

è¯·æ±‚ç»“æ„ä½“ä¸­çš„å­—æ®µéƒ½æ˜¯æŒ‡é’ˆç±»å‹çš„ï¼Œä½¿ç”¨æŒ‡é’ˆçš„å¥½å¤„æ˜¯å¯ä»¥åˆ¤æ–­å…¥å‚æ˜¯å¦æœ‰è¢«æŒ‡å®šï¼Œå¦‚æœ`req.Subject == nil` å°±è¯´æ˜ä¼ å‚ä¸­æ²¡æœ‰Subjectå‚æ•°ï¼Œå¦‚æœ`req.Subject != nil`å°±è¯´æ˜å‚æ•°ä¸­æœ‰ä¼ Subjectå‚æ•°ã€‚æ ¹æ®æŸä¸ªå‚æ•°æ˜¯å¦è¢«ä¼ å…¥ï¼Œæ‰§è¡Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™åœ¨Go APIæ¥å£å¼€å‘ä¸­éå¸¸å¸¸è§ã€‚

å¦å¤–ï¼Œå› ä¸ºClienté€šè¿‡åŒ¿åçš„æ–¹å¼ç»§æ‰¿äº†åŸºç¡€å±‚ä¸­çš„[Client](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/client.go#L18-L24)ï¼š

```go
type Client struct 
```

æ‰€ä»¥ï¼ŒAPIå±‚åˆ›å»ºçš„Clientæœ€ç»ˆå¯ä»¥ç›´æ¥è°ƒç”¨åŸºç¡€å±‚ä¸­çš„Clientæä¾›çš„`Send(req, resp)` æ–¹æ³•ï¼Œæ¥æ‰§è¡ŒRESTful APIè°ƒç”¨ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ `resp` ä¸­ã€‚

ä¸ºäº†æ–¹ä¾¿å’ŒAPIå±‚çš„Clientè¿›è¡ŒåŒºåˆ†ï¼Œæˆ‘ä¸‹é¢ç»Ÿä¸€å°†åŸºç¡€å±‚ä¸­çš„Clientç§°ä¸º**sdk.Client**ã€‚

æœ€åï¼Œä¸€ä¸ªå®Œæ•´çš„å®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
package mainimport (	"fmt"	"github.com/ory/ladon"	"github.com/marmotedu/medu-sdk-go/sdk"	iam "github.com/marmotedu/medu-sdk-go/services/iam/authz")func main() {	client, _ := iam.NewClientWithSecret("XhbY3aCrfjdYcP1OFJRu9xcno8JzSbUIvGE2", "bfJRvlFwsoW9L30DlG87BBW0arJamSeK")	req := iam.NewAuthzRequest()	req.Resource = sdk.String("resources:articles:ladon-introduction")	req.Action = sdk.String("delete")	req.Subject = sdk.String("users:peter")	ctx := ladon.Context(map[string]interface{}{"remoteIPAddress": "192.168.0.5"})	req.Context = &ctx	resp, err := client.Authz(req)	if err != nil {		fmt.Println("err1", err)		return	}	fmt.Printf("get response body: %sn", resp.String())	fmt.Printf("allowed: %vn", resp.Allowed)}
```

### åŸºç¡€å±‚ï¼šæ„å»ºå¹¶æ‰§è¡ŒHTTPè¯·æ±‚

ä¸Šé¢æˆ‘ä»¬åˆ›å»ºäº†å®¢æˆ·ç«¯å®ä¾‹ï¼Œå¹¶è°ƒç”¨äº†å®ƒçš„ [Send](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/client.go#L61-L93) æ–¹æ³•æ¥å®Œæˆæœ€ç»ˆçš„HTTPè¯·æ±‚ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹Sendæ–¹æ³•å…·ä½“æ˜¯å¦‚ä½•æ„å»ºHTTPè¯·æ±‚çš„ã€‚

sdk.Clienté€šè¿‡Sendæ–¹æ³•ï¼Œå®Œæˆæœ€ç»ˆçš„APIè°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (c *Client) Send(req request.Request, resp response.Response) error {	method := req.GetMethod()	builder := GetParameterBuilder(method, c.Logger)	jsonReq, _ := json.Marshal(req)	encodedUrl, err := builder.BuildURL(req.GetURL(), jsonReq)	if err != nil 	endPoint := c.Config.Endpoint	if endPoint == "" {		endPoint = fmt.Sprintf("%s/%s", defaultEndpoint, c.ServiceName)	}	reqUrl := fmt.Sprintf("%s://%s/%s%s", c.Config.Scheme, endPoint, req.GetVersion(), encodedUrl)	body, err := builder.BuildBody(jsonReq)	if err != nil 	sign := func(r *http.Request) error {		signer := NewSigner(c.signMethod, c.Credential, c.Logger)		_ = signer.Sign(c.ServiceName, r, strings.NewReader(body))		return err	}	rawResponse, err := c.doSend(method, reqUrl, body, req.GetHeaders(), sign)	if err != nil 	return response.ParseFromHttpResponse(rawResponse, resp)}
```

ä¸Šé¢çš„ä»£ç å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºå››ä¸ªæ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼ŒBuilderï¼šæ„å»ºè¯·æ±‚å‚æ•°ã€‚**

æ ¹æ®ä¼ å…¥çš„AuthzRequestå’Œå®¢æˆ·ç«¯é…ç½®Configï¼Œæ„é€ HTTPè¯·æ±‚å‚æ•°ï¼ŒåŒ…æ‹¬è¯·æ±‚è·¯å¾„å’Œè¯·æ±‚Bodyã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•æ„é€ HTTPè¯·æ±‚å‚æ•°ã€‚

1. HTTPè¯·æ±‚è·¯å¾„æ„å»º

åœ¨åˆ›å»ºå®¢æˆ·ç«¯æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡[NewAuthzRequest](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/services/iam/authz/authz.go#L32-L42)å‡½æ•°åˆ›å»ºäº† `/v1/authz` REST APIæ¥å£è¯·æ±‚ç»“æ„ä½“AuthzRequestï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func NewAuthzRequest() (req *AuthzRequest) {        req = &AuthzRequest{            BaseRequest: &request.BaseRequest{                URL:     "/authz",                Method:  "POST",                Header:  nil,                Version: "v1",            },        }        return                                }
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ›å»ºçš„ `req` ä¸­åŒ…å«äº†APIç‰ˆæœ¬ï¼ˆVersionï¼‰ã€APIè·¯å¾„ï¼ˆURLï¼‰å’Œè¯·æ±‚æ–¹æ³•ï¼ˆMethodï¼‰ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨Sendæ–¹æ³•ä¸­ï¼Œæ„å»ºå‡ºè¯·æ±‚è·¯å¾„ï¼š

```go
endPoint := c.Config.Endpoint                                                 if endPoint == "" {                                                              endPoint = fmt.Sprintf("%s/%s", defaultEndpoint, c.ServiceName)           }                                                                  reqUrl := fmt.Sprintf("%s://%s/%s%s", c.Config.Scheme, endPoint, req.GetVersion(), encodedUrl) 
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œc.Config.Scheme=http/httpsã€endPoint=iam.api.marmotedu.com:8080ã€req.GetVersion()=v1å’ŒencodedUrlï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºå®ƒä»¬ç­‰äº/authzã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆæ„å»ºå‡ºçš„è¯·æ±‚è·¯å¾„ä¸º`http://iam.api.marmotedu.com:8080/v1/authz` ã€‚

1. HTTPè¯·æ±‚Bodyæ„å»º

åœ¨[BuildBody](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/parameter_builder.go#L68-L86)æ–¹æ³•ä¸­æ„å»ºè¯·æ±‚Bodyã€‚BuildBodyä¼šå°† `req` MarshalæˆJSONæ ¼å¼çš„stringã€‚HTTPè¯·æ±‚ä¼šä»¥è¯¥å­—ç¬¦ä¸²ä½œä¸ºBodyå‚æ•°ã€‚

**ç¬¬äºŒæ­¥ï¼ŒSignerï¼šç­¾å‘å¹¶æ·»åŠ è®¤è¯å¤´ã€‚**

è®¿é—®IAMçš„APIæ¥å£éœ€è¦è¿›è¡Œè®¤è¯ï¼Œæ‰€ä»¥åœ¨å‘é€HTTPè¯·æ±‚ä¹‹å‰ï¼Œè¿˜éœ€è¦ç»™HTTPè¯·æ±‚æ·»åŠ è®¤è¯Headerã€‚

medu-sdk-go ä»£ç æä¾›äº†JWTå’ŒHMACä¸¤ç§è®¤è¯æ–¹å¼ï¼Œæœ€ç»ˆé‡‡ç”¨äº†JWTè®¤è¯æ–¹å¼ã€‚JWTè®¤è¯ç­¾å‘æ–¹æ³•ä¸º[Sign](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/signer.go#L108-L113)ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (v1 SignatureV1) Sign(serviceName string, r *http.Request, body io.ReadSeeker) http.Header {	tokenString := auth.Sign(v1.Credentials.SecretID, v1.Credentials.SecretKey, "medu-sdk-go", serviceName+".marmotedu.com")	r.Header.Set("Authorization", fmt.Sprintf("Bearer %s", tokenString))	return r.Header}
```

`auth.Sign` æ–¹æ³•æ ¹æ®SecretIDå’ŒSecretKeyç­¾å‘JWT Tokenã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨[doSend](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/client.go#L95-L112)æ–¹æ³•æ¥æ‰§è¡ŒHTTPè¯·æ±‚äº†ã€‚è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š

```go
rawResponse, err := c.doSend(method, reqUrl, body, req.GetHeaders(), sign)if err != nil {                                                                   return err     } 
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼ å…¥äº†HTTPè¯·æ±‚æ–¹æ³• `method` ã€HTTPè¯·æ±‚URL `reqUrl` ã€HTTPè¯·æ±‚Body `body`ï¼Œä»¥åŠç”¨æ¥ç­¾å‘JWT Tokençš„ `sign` æ–¹æ³•ã€‚æˆ‘ä»¬åœ¨è°ƒç”¨ `NewAuthzRequest` åˆ›å»º `req` æ—¶ï¼ŒæŒ‡å®šäº†HTTP Methodï¼Œæ‰€ä»¥è¿™é‡Œçš„ `method := req.GetMethod()` ã€reqUrlå’Œè¯·æ±‚Bodyéƒ½æ˜¯é€šè¿‡Builderæ¥æ„å»ºçš„ã€‚

**ç¬¬ä¸‰æ­¥ï¼ŒRequestï¼šæ‰§è¡ŒH\**\*\*T\*\**\*T\**\*\*P\*\**\*è¯·æ±‚ã€‚**

è°ƒç”¨[doSend](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/client.go#L95-L112)æ–¹æ³•æ‰§è¡ŒHTTPè¯·æ±‚ï¼ŒdoSendé€šè¿‡è°ƒç”¨ `net/http` åŒ…æä¾›çš„ `http.NewRequest` æ–¹æ³•æ¥å‘é€HTTPè¯·æ±‚ï¼Œæ‰§è¡Œå®ŒHTTPè¯·æ±‚åï¼Œä¼šè¿”å› `*http.Response` ç±»å‹çš„Responseã€‚ä»£ç å¦‚ä¸‹ï¼š

```go
func (c *Client) doSend(method, url, data string, header map[string]string, sign SignFunc) (*http.Response, error) {    client := &http.Client    req, err := http.NewRequest(method, url, strings.NewReader(data))    if err != nil {        c.Logger.Errorf("%s", err.Error())        return nil, err    }    c.setHeader(req, header)    err = sign(req)    if err != nil {        return nil, err    }    return client.Do(req)}
```

**ç¬¬å››æ­¥ï¼Œå¤„ç†H\**\*\*TT\*\**\*P\**\*\*è¯·æ±‚\*\**\*è¿”å›ç»“æœã€‚**

è°ƒç”¨doSendæ–¹æ³•è¿”å› `*http.Response` ç±»å‹çš„Responseåï¼ŒSendæ–¹æ³•ä¼šè°ƒç”¨[ParseFromHttpResponse](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/response/response.go#L37-L52)å‡½æ•°æ¥å¤„ç†HTTP Responseï¼ŒParseFromHttpResponseå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š

```go
func ParseFromHttpResponse(rawResponse *http.Response, response Response) error {	defer rawResponse.Body.Close()	body, err := ioutil.ReadAll(rawResponse.Body)	if err != nil 	if rawResponse.StatusCode != 200 {		return fmt.Errorf("request fail with status: %s, with body: %s", rawResponse.Status, body)	}	if err := response.ParseErrorFromHTTPResponse(body); err != nil 	return json.Unmarshal(body, &response)}
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ParseFromHttpResponseå‡½æ•°ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­HTTP Responseä¸­çš„StatusCodeæ˜¯å¦ä¸º200ï¼Œå¦‚æœä¸æ˜¯200ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚å¦‚æœæ˜¯200ï¼Œä¼šè°ƒç”¨ä¼ å…¥çš„respå˜é‡æä¾›çš„[ParseErrorFromHTTPResponse](https://github.com/marmotedu/medu-sdk-go/blob/v1.0.0/sdk/response/response.go#L26-L35)æ–¹æ³•ï¼Œæ¥å°†HTTP Responseçš„Body Unmarshalåˆ°respå˜é‡ä¸­ã€‚
é€šè¿‡ä»¥ä¸Šå››æ­¥ï¼ŒSDKè°ƒç”¨æ–¹è°ƒç”¨äº†APIï¼Œå¹¶è·å¾—äº†APIçš„è¿”å›ç»“æœ `resp` ã€‚

ä¸‹é¢è¿™äº›å…¬æœ‰äº‘å‚å•†çš„SDKé‡‡ç”¨äº†æ­¤è®¾è®¡æ¨¡å¼ï¼š

+ è…¾è®¯äº‘SDKï¼š[tencentcloud-sdk-go](https://github.com/TencentCloud/tencentcloud-sdk-go)ã€‚
+ AWS SDKï¼š[aws-sdk-go](https://github.com/aws/aws-sdk-go)ã€‚
+ é˜¿é‡Œäº‘SDKï¼š[alibaba-cloud-sdk-go](https://github.com/aliyun/alibaba-cloud-sdk-go)ã€‚
+ äº¬ä¸œäº‘SDKï¼š[jdcloud-sdk-go](https://github.com/jdcloud-api/jdcloud-sdk-go)ã€‚
+ Ucloud SDKï¼š[ucloud-sdk-go](https://github.com/ucloud/ucloud-sdk-go)ã€‚

IAMå…¬æœ‰äº‘æ–¹å¼çš„SDKå®ç°ä¸º [medu-sdk-go](https://github.com/marmotedu/medu-sdk-go)ã€‚

æ­¤å¤–ï¼ŒIAMè¿˜è®¾è®¡å¹¶å®ç°äº†Kubernetes client-goæ–¹å¼çš„Go SDKï¼š[marmotedu-sdk-go](https://github.com/marmotedu/marmotedu-sdk-go)ï¼Œmarmotedu-sdk-goä¹Ÿæ˜¯IAM Go SDKæ‰€é‡‡ç”¨çš„SDKã€‚ä¸‹ä¸€è®²ä¸­ï¼Œæˆ‘ä¼šå…·ä½“ä»‹ç»marmotedu-sdk-goçš„è®¾è®¡å’Œå®ç°ã€‚

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦ä»‹ç»äº†å¦‚ä½•è®¾è®¡ä¸€ä¸ªä¼˜ç§€çš„Go SDKã€‚é€šè¿‡æä¾›SDKï¼Œå¯ä»¥æé«˜APIè°ƒç”¨æ•ˆç‡ï¼Œå‡å°‘APIè°ƒç”¨éš¾åº¦ï¼Œæ‰€ä»¥å¤§å‹åº”ç”¨é€šå¸¸éƒ½ä¼šæä¾›SDKã€‚ä¸åŒå›¢é˜Ÿæœ‰ä¸åŒçš„SDKè®¾è®¡æ–¹æ³•ï¼Œä½†ç›®å‰æ¯”è¾ƒå¥½çš„å®ç°æ˜¯å…¬æœ‰äº‘å‚å•†é‡‡ç”¨çš„SDKè®¾è®¡æ–¹å¼ã€‚

å…¬æœ‰äº‘å‚å•†çš„SDKè®¾è®¡æ–¹å¼ä¸­ï¼ŒSDKæŒ‰è°ƒç”¨é¡ºåºä»ä¸Šåˆ°ä¸‹å¯ä»¥åˆ†ä¸º3ä¸ªæ¨¡å—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/b9/a9/b9bd3020ae56f6bb49bc3a38bcaf64a9.jpg?wh=1920x878)](https://static001.geekbang.org/resource/image/b9/a9/b9bd3020ae56f6bb49bc3a38bcaf64a9.jpg?wh=1920x878)

Clientæ„é€ SDKå®¢æˆ·ç«¯ï¼Œåœ¨æ„é€ å®¢æˆ·ç«¯æ—¶ï¼Œä¼šåˆ›å»ºè¯·æ±‚å‚æ•° `req` ï¼Œ `req` ä¸­ä¼šæŒ‡å®šAPIç‰ˆæœ¬ã€HTTPè¯·æ±‚æ–¹æ³•ã€APIè¯·æ±‚è·¯å¾„ç­‰ä¿¡æ¯ã€‚

Clientä¼šè¯·æ±‚Builderå’ŒSigneræ¥æ„å»ºHTTPè¯·æ±‚çš„å„é¡¹å‚æ•°ï¼šHTTPè¯·æ±‚æ–¹æ³•ã€HTTPè¯·æ±‚è·¯å¾„ã€HTTPè®¤è¯å¤´ã€HTTPè¯·æ±‚Bodyã€‚Builderå’ŒSigneræ˜¯æ ¹æ® `req` é…ç½®æ¥æ„é€ è¿™äº›HTTPè¯·æ±‚å‚æ•°çš„ã€‚

æ„é€ å®Œæˆä¹‹åï¼Œä¼šè¯·æ±‚Requestæ¨¡å—ï¼ŒRequestæ¨¡å—é€šè¿‡è°ƒç”¨ `net/http` åŒ…ï¼Œæ¥æ‰§è¡ŒHTTPè¯·æ±‚ï¼Œå¹¶è¿”å›è¯·æ±‚ç»“æœã€‚

## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸‹ï¼Œå¦‚ä½•å®ç°å¯ä»¥æ”¯æŒå¤šä¸ªAPIç‰ˆæœ¬çš„SDKåŒ…ï¼Œä»£ç å¦‚ä½•å®ç°ï¼Ÿ
2. è¿™ä¸€è®²ä»‹ç»äº†ä¸€ç§SDKå®ç°æ–¹å¼ï¼Œåœ¨ä½ çš„Goå¼€å‘ç”Ÿæ¶¯ä¸­ï¼Œè¿˜æœ‰æ²¡æœ‰ä¸€äº›æ›´å¥½çš„SDKå®ç°æ–¹æ³•ï¼Ÿæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚





## END é“¾æ¥
<ul><li><div><a href = '24.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '26.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

