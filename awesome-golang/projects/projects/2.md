+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬2èŠ‚ IAMé¡¹ç›®éƒ¨ç½²

<br>
<div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å‰è¨€

+ [â­• ğŸ“š èœé¸Ÿæˆé•¿æ‰‹å†ŒğŸš€ CSç³»åˆ— ã€äº‘åŸç”Ÿç³»åˆ—ã€åŒºå—é“¾ç³»åˆ—ã€web3ç³»åˆ—ğŸ”¥ã€Golangç³»åˆ—ğŸ’¡](https://github.com/cubxxw/cs-awesome-Block_Chain)

+  [ğŸš¤ Goè¯­è¨€åŸºç¡€-è¿›é˜¶](https://go.nsddd.top/)
  + [ğŸ–±ï¸GO åŸºç¡€éƒ¨åˆ†ğŸ”¥](https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/TOC.md)
  +  [ğŸ–±ï¸Goè¯­è¨€100ç¯‡è¿›é˜¶ğŸ”¥](https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/Gomd_super/README.md)
  +  [ğŸ–±ï¸Go é«˜çº§ç¯‡](https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/go-advancend/README.md)
+  [ğŸš¤ docker & k8s & äº‘åŸç”Ÿ](https://docker.nsddd.top/)

+ [x] [IAM githubåœ°å€](https://github.com/cubxxw/iam)
+ [x] [è¯¾ç¨‹åœ°å€](https://time.geekbang.org/column/article/378082)



## åŸºæœ¬å¼€å‘ç¯å¢ƒ

**æŸ¥çœ‹æˆ‘çš„ç¯å¢ƒï¼š**

```bash
root@cubmaster01:/# uname -va
Linux cubmaster01 5.4.0-135-generic #152-Ubuntu SMP Wed Nov 23 20:19:22 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
root@cubmaster01:/# go version 
go version go1.19.3 linux/amd64
root@cubmaster01:/# git version
git version 2.25.1
```



### ç”¨æˆ·æƒé™

ä½¿ç”¨æ™®é€šç”¨æˆ·ç™»å½•å’Œæ“ä½œå¼€å‘æœºä¹Ÿå¯ä»¥ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¹ æƒ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¹Ÿè¦å°½é‡é¿å…ä½¿ç”¨ Root ç”¨æˆ·ã€‚

```bash
oot@cubmaster01:/# useradd cubiam
root@cubmaster01:/# passwd cubiam
New password: 
Retype new password: 
passwd: password updated successfully
```



### æ·»åŠ  sudoers

æ™®é€šç”¨æˆ·ä¹Ÿè¦ç”¨åˆ° Root çš„ä¸€äº›æƒé™ï¼Œä½† Root ç”¨æˆ·çš„å¯†ç ä¸€èˆ¬æ˜¯ç”±ç³»ç»Ÿç®¡ç†å‘˜ç»´æŠ¤å¹¶å®šæœŸæ›´æ”¹çš„ï¼Œæ¯æ¬¡éƒ½å‘ç®¡ç†å‘˜è¯¢é—®å¯†ç åˆå¾ˆéº»çƒ¦ã€‚å› æ­¤ï¼Œæˆ‘å»ºè®®ä½ å°†æ™®é€šç”¨æˆ·åŠ å…¥åˆ° sudoers ä¸­ï¼Œè¿™æ ·æ™®é€šç”¨æˆ·å°±å¯ä»¥é€šè¿‡ sudo å‘½ä»¤æ¥æš‚æ—¶è·å– Root çš„æƒé™ã€‚å…·ä½“æ¥è¯´ï¼Œä½ å¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ·»åŠ ï¼š

```bash
sed -i '/^root.*ALL=(ALL).*ALL/a\cubaim\tALL=(ALL) \tALL' /etc/sudoers
```



### é…ç½® `$HOME/.bashrc` æ–‡ä»¶

æˆ‘ä»¬ç™»å½•æ–°æœåŠ¡å™¨åçš„ç¬¬ä¸€æ­¥å°±æ˜¯é…ç½® `$HOME/.bashrc` æ–‡ä»¶ï¼Œä»¥ä½¿ Linux ç™»å½• shell æ›´åŠ æ˜“ç”¨ï¼Œä¾‹å¦‚é…ç½® LANG è§£å†³ä¸­æ–‡ä¹±ç ï¼Œé…ç½® PS1 å¯ä»¥é¿å…æ•´è¡Œéƒ½æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œå¹¶å°† `$HOME/bin` åŠ å…¥åˆ° PATH è·¯å¾„ä¸­ã€‚é…ç½®åçš„å†…å®¹å¦‚ä¸‹ï¼š

```bash
# .bashrc
 
# User specific aliases and functions
# -iï¼š æ¯æ¬¡åˆ é™¤å‰æé†’~
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'
 
# Source global definitions
if [ -f /etc/bashrc ]; then
        . /etc/bashrc
fi
 
# User specific environment
# Basic envs
export LANG="en_US.UTF-8" # è®¾ç½®ç³»ç»Ÿè¯­è¨€ä¸º en_US.UTF-8ï¼Œé¿å…ç»ˆç«¯å‡ºç°ä¸­æ–‡ä¹±ç 
export PS1='[\u@dev \W]\$ ' # é»˜è®¤çš„ PS1 è®¾ç½®ä¼šå±•ç¤ºå…¨éƒ¨çš„è·¯å¾„ï¼Œä¸ºäº†é˜²æ­¢è¿‡é•¿ï¼Œè¿™é‡Œåªå±•ç¤ºï¼š"ç”¨æˆ·å@dev æœ€åçš„ç›®å½•å"
export WORKSPACE="$HOME/workspace" # è®¾ç½®å·¥ä½œç›®å½•
export PATH=$HOME/bin:$PATH # å°† $HOME/bin ç›®å½•åŠ å…¥åˆ° PATH å˜é‡ä¸­
 
# Default entry folder
cd $WORKSPACE # ç™»å½•ç³»ç»Ÿï¼Œé»˜è®¤è¿›å…¥ workspace ç›®å½•
```

æœ‰ä¸€ç‚¹éœ€è¦æˆ‘ä»¬æ³¨æ„ï¼Œåœ¨ export PATH æ—¶ï¼Œæœ€å¥½æŠŠ `$PATH` æ”¾åˆ°æœ€åï¼Œå› ä¸ºæˆ‘ä»¬æ·»åŠ åˆ°ç›®å½•ä¸­çš„å‘½ä»¤æ˜¯æœŸæœ›è¢«ä¼˜å…ˆæœç´¢å¹¶ä½¿ç”¨çš„ã€‚é…ç½®å®Œ `$HOME/.bashrc` åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºå·¥ä½œç›®å½• workspaceã€‚å°†å·¥ä½œæ–‡ä»¶ç»Ÿä¸€æ”¾åœ¨ `$HOME/workspace` ç›®å½•ä¸­ï¼Œæœ‰å‡ ç‚¹å¥½å¤„ã€‚

1. å¯ä»¥ä½¿æˆ‘ä»¬çš„ `HOME`ç›®å½•ä¿æŒæ•´æ´ï¼Œä¾¿äºä»¥åçš„æ–‡ä»¶æŸ¥æ‰¾å’Œåˆ†ç±»ã€‚
2. å¦‚æœå“ªä¸€å¤© /åˆ†åŒºç©ºé—´ä¸è¶³ï¼Œå¯ä»¥å°†æ•´ä¸ª workspace ç›®å½• mv åˆ°å¦ä¸€ä¸ªåˆ†åŒºä¸­ï¼Œå¹¶åœ¨ /åˆ†åŒºä¸­ä¿ç•™è½¯è¿æ¥ï¼Œä¾‹å¦‚ï¼š/home/going/workspace -> /data/workspace/ã€‚
3. å¦‚æœå“ªå¤©æƒ³å¤‡ä»½æ‰€æœ‰çš„å·¥ä½œæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥å¤‡ä»½ workspaceã€‚

å…·ä½“çš„æ“ä½œæŒ‡ä»¤æ˜¯ `mkdir -p $HOME/workspace`ã€‚é…ç½®å¥½ `HOME/.bashrc` æ–‡ä»¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œ bash å‘½ä»¤å°†é…ç½®åŠ è½½åˆ°å½“å‰ shell ä¸­äº†ã€‚



### å®‰è£… git

å› ä¸ºå®‰è£… IAM ç³»ç»Ÿã€æ‰§è¡Œ go get å‘½ä»¤ã€å®‰è£… protobuf å·¥å…·ç­‰éƒ½æ˜¯é€šè¿‡ Git æ¥æ“ä½œçš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦å®‰è£… Gitã€‚ç”±äºä½ç‰ˆæœ¬çš„ Git ä¸æ”¯æŒ `--unshallow` å‚æ•°ï¼Œè€Œ go get åœ¨å®‰è£… Go åŒ…æ—¶ä¼šç”¨åˆ° `git fetch --unshallow` å‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬è¦ç¡®ä¿å®‰è£…ä¸€ä¸ªé«˜ç‰ˆæœ¬çš„ Gitï¼Œå…·ä½“çš„å®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
$ cd /tmp
$ wget --no-check-certificate https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.39.0.tar.gz
$ tar -xvzf git-2.39.0.tar.gz
$ cd git-2.39.0/
$ ./configure
$ make
$ sudo make install
$ git --version          # è¾“å‡º git ç‰ˆæœ¬å·ï¼Œè¯´æ˜å®‰è£…æˆåŠŸ
git version 2.39.0
tee -a $HOME/.bashrc <<'EOF'
# Configure for git
export PATH=/usr/local/libexec/git-core:$PATHEOF
```

é…ç½® Gitã€‚æˆ‘ä»¬ç›´æ¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤é…ç½® Git

```bash
git config --global user.name "Xinwei Xiong"    # ç”¨æˆ·åæ”¹æˆè‡ªå·±çš„
git config --global user.email "3293172751nss@gmail.com"    # é‚®ç®±æ”¹æˆè‡ªå·±çš„
git config --global credential.helper store    # è®¾ç½® Gitï¼Œä¿å­˜ç”¨æˆ·åå’Œå¯†ç 
git config --global core.longpaths true # è§£å†³ Git ä¸­ 'Filename too long' çš„é”™è¯¯
```

é™¤äº†æŒ‰ç…§ä¸Šè¿°æ­¥éª¤é…ç½® Git ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ã€‚é¦–å…ˆï¼Œåœ¨ Git ä¸­ï¼Œæˆ‘ä»¬ä¼šæŠŠé ASCII å­—ç¬¦å«åš Unusual å­—ç¬¦ã€‚è¿™ç±»å­—ç¬¦åœ¨ Git è¾“å‡ºåˆ°ç»ˆç«¯çš„æ—¶å€™é»˜è®¤æ˜¯ç”¨ 8 è¿›åˆ¶è½¬ä¹‰å­—ç¬¦è¾“å‡ºçš„ï¼ˆä»¥é˜²ä¹±ç ï¼‰ï¼Œä½†ç°åœ¨çš„ç»ˆç«¯å¤šæ•°éƒ½æ”¯æŒç›´æ¥æ˜¾ç¤ºé ASCII å­—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…³é—­æ‰è¿™ä¸ªç‰¹æ€§ï¼Œå…·ä½“çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
git config --global core.quotepath off
```

å…¶æ¬¡ï¼ŒGitHub é™åˆ¶æœ€å¤§åªèƒ½å…‹éš† 100M çš„å•ä¸ªæ–‡ä»¶ï¼Œä¸ºäº†èƒ½å¤Ÿå…‹éš†å¤§äº 100M çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£… Git Large File Storageï¼Œå®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š

```bash
git lfs install --skip-repo
```



## goè¯­è¨€ç¯å¢ƒå˜é‡è®¾ç½®å’Œå«ä¹‰

**æˆ‘ä»¬åœ¨è®¾ç½®Goè¯­è¨€çš„ç¯å¢ƒå˜é‡ï¼š**

```bash
$ tee -a $HOME/.bashrc <<'EOF'
# Go envs
export GOVERSION=go1.18.3 # Go ç‰ˆæœ¬è®¾ç½®
export GO_INSTALL_DIR=$HOME/go # Go å®‰è£…ç›®å½•
export GOROOT=$GO_INSTALL_DIR/$GOVERSION # GOROOT è®¾ç½®
export GOPATH=$WORKSPACE/golang # GOPATH è®¾ç½®
export PATH=$GOROOT/bin:$GOPATH/bin:$PATH # å°† Go è¯­è¨€è‡ªå¸¦çš„å’Œé€šè¿‡ go install å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶åŠ å…¥åˆ° PATH è·¯å¾„ä¸­
export GO111MODULE="on" # å¼€å¯ Go moudles ç‰¹æ€§
export GOPROXY=https://goproxy.cn,direct # å®‰è£… Go æ¨¡å—æ—¶ï¼Œä»£ç†æœåŠ¡å™¨è®¾ç½®
export GOPRIVATE=
export GOSUMDB=off # å…³é—­æ ¡éªŒ Go ä¾èµ–åŒ…çš„å“ˆå¸Œå€¼
EOF
```

ä¸ºä»€ä¹ˆè¦å¢åŠ è¿™ä¹ˆå¤šç¯å¢ƒå˜é‡å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼ŒGo è¯­è¨€æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ Go ç¼–è¯‘å™¨è¡Œä¸ºçš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸€å®šè¦ç†è§£æ¯ä¸€ä¸ªç¯å¢ƒå˜é‡çš„å«ä¹‰ã€‚

![image-20230115235526661](http://sm.nsddd.top/sm202301152355839.png)

å› ä¸º Go ä»¥åä¼šç”¨ Go modules æ¥ç®¡ç†ä¾èµ–ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ å°† GO111MODULE è®¾ç½®ä¸º onã€‚

åœ¨ä½¿ç”¨æ¨¡å—çš„æ—¶å€™ï¼Œ`$GOPATH` æ˜¯æ— æ„ä¹‰çš„ï¼Œä¸è¿‡å®ƒè¿˜æ˜¯ä¼šæŠŠä¸‹è½½çš„ä¾èµ–å‚¨å­˜åœ¨ `$GOPATH/pkg/mod` ç›®å½•ä¸­ï¼Œä¹Ÿä¼šæŠŠ go install çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ `$GOPATH/bin` ç›®å½•ä¸­ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬è¿˜è¦å°† `$GOPATH/bin`ã€`$GOROOT/bin` åŠ å…¥åˆ° Linux å¯æ‰§è¡Œæ–‡ä»¶æœç´¢è·¯å¾„ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨ bash shell ä¸­æ‰§è¡Œ go è‡ªå¸¦çš„å‘½ä»¤ï¼Œä»¥åŠé€šè¿‡ go install å®‰è£…çš„å‘½ä»¤ã€‚



## vim go-plug

å®‰è£…ï¼š

```go
git clone --depth=1 https://github.com/fatih/vim-go.git ~/.vim/pack/plugins/start/vim-go
```

vim-go ä¼šç”¨åˆ°ä¸€äº› Go å·¥å…·ï¼Œæ¯”å¦‚åœ¨å‡½æ•°è·³è½¬æ—¶ä¼šç”¨åˆ° guruã€godef å·¥å…·ï¼Œåœ¨æ ¼å¼åŒ–æ—¶ä¼šç”¨åˆ° goimportsï¼Œæ‰€ä»¥ä½ ä¹Ÿéœ€è¦å®‰è£…è¿™äº›å·¥å…·ã€‚å®‰è£…æ–¹å¼å¦‚ä¸‹ï¼šæ‰§è¡Œ `vi /tmp/test.go`ï¼Œç„¶åè¾“å…¥ `:GoInstallBinaries` å®‰è£… vim-go éœ€è¦çš„å·¥å…·ã€‚å®‰è£…åçš„ Go IDE å¸¸ç”¨æ“ä½œçš„æŒ‰é”®æ˜ å°„å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

![image-20230116195849590](http://sm.nsddd.top/sm202301161958824.png)

 

## ProtoBuf ç¼–è¯‘ç¯å¢ƒå®‰è£…

æ¥ç€ï¼Œæˆ‘ä»¬å†æ¥å®‰è£… `protobuf` çš„ç¼–è¯‘å™¨ `protoc`ã€‚`protoc` éœ€è¦ `protoc-gen-go` æ¥å®Œæˆ Go è¯­è¨€çš„ä»£ç è½¬æ¢ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®‰è£… `protoc` å’Œ `protoc-gen-go` è¿™ 2 ä¸ªå·¥å…·ã€‚å®ƒä»¬çš„å®‰è£…æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä½ ç›´æ¥çœ‹æˆ‘ä¸‹é¢ç»™å‡ºçš„ä»£ç å’Œæ“ä½œæ³¨é‡Šå°±å¯ä»¥äº†ã€‚

> Protocol Buffersï¼ˆç¼©å†™ä¸º protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§æ•°æ®äº¤æ¢æ ¼å¼ã€‚å®ƒæ˜¯ä¸€ç§ç»“æ„åŒ–æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œå¯ç”¨äºç»“æ„åŒ–æ•°æ®ä¸²è¡ŒåŒ–ï¼Œæˆ–è€…è¯´æŠŠæ•°æ®ä»ç¨‹åºä¸­â€œå˜æˆâ€å­—èŠ‚æµï¼Œåˆå¯ä»¥æŠŠå­—èŠ‚æµé‡æ–°â€œå˜æˆâ€ç¨‹åºä¸­çš„æ•°æ®ã€‚ç”±äº protobuf æ˜¯è·¨è¯­è¨€çš„ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è¢«å¤šç§è¯­è¨€çš„ç¨‹åºä½¿ç”¨ã€‚

```bash
# ç¬¬ä¸€æ­¥ï¼šå®‰è£… protobuf
$ cd /tmp/
$ git clone -b v3.21.1 --depth=1 https://github.com/protocolbuffers/protobuf
$ cd protobuf
$ ./autogen.sh
$ ./configure
$ make
$ sudo make install
$ protoc --version # æŸ¥çœ‹ protoc ç‰ˆæœ¬ï¼ŒæˆåŠŸè¾“å‡ºç‰ˆæœ¬å·ï¼Œè¯´æ˜å®‰è£…æˆåŠŸ
libprotoc 3.21.1

# ç¬¬äºŒæ­¥ï¼šå®‰è£… protoc-gen-go
$ go install github.com/golang/protobuf/protoc-gen-go@v1.5.2
```



##  IAMæ‰‹åŠ¨éƒ¨ç½²

> å’ŒKubernetesä¸€æ ·ï¼Œå¯ä»¥æ”¯æŒæ‰‹åŠ¨éƒ¨ç½²å’Œè‡ªåŠ¨éƒ¨ç½²ã€‚

IAM ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„é¡¹ç›®ï¼Œæœ‰ä¸€å®šçš„å¤æ‚åº¦ï¼Œå®‰è£…çš„è¯éœ€è¦å°å¿ƒ~

**éƒ¨ç½²çš„æ­¥éª¤ï¼š**

1. å®‰è£…å’Œé…ç½®æ•°æ®åº“ï¼šæˆ‘ä»¬éœ€è¦å®‰è£…å’Œé…ç½® MariaDBã€Redis å’Œ MongoDBã€‚
2. å®‰è£…å’Œé…ç½® IAM æœåŠ¡ï¼šæˆ‘ä»¬éœ€è¦å®‰è£…å’Œé…ç½® iam-apiserverã€iam-authz-serverã€iam-pumpã€iamctl å’Œ man æ–‡ä»¶ã€‚

> æœ‰çš„äººç›´æ¥å°†æ•´ä¸ªç¯å¢ƒæ‰“åŒ…äº†ï¼š
>
> æˆ‘è‡ªå·±æ˜¯åœ¨ docker å®¹å™¨ä¸­éƒ¨ç½²çš„ï¼Œæˆ‘æŠŠé¡¹ç›®éƒ¨ç½²å¥½çš„å®¹å™¨æ‰“åŒ…ä¸Šä¼ äº†ï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥ç›´æ¥æ‹‰ä¸‹æ¥ç”¨ï¼ˆ`docker pull mjcjm/centos-go-project`ï¼‰ï¼Œå¯åŠ¨å‚æ•°ä¸€å®šè¦ç”¨ï¼š`docker run -tid --name` å®¹å™¨åç§°  `-v /sys/fs/cgroup:/sys/fs/cgroup  --privileged=true` é•œåƒ `id /usr/sbin/init`ã€‚ 



### ä¸‹è½½é¡¹ç›®ä»£ç 

å› ä¸º IAM çš„å®‰è£…è„šæœ¬å­˜æ”¾åœ¨ iam ä»£ç ä»“åº“ä¸­ï¼Œå®‰è£…éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿéœ€è¦é€šè¿‡ iam ä»£ç æ„å»ºï¼Œæ‰€ä»¥åœ¨å®‰è£…ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä¸‹è½½ iam ä»£ç ï¼š

```bash
$ cd $WORKSPACE
$ git clone https://github.com/cubxxw/iam.git
$ go work use ./iam
```

**è®¾ç½®åˆ«åå’Œç¯å¢ƒå˜é‡ï¼š**

```bash
tee -a $HOME/.bashrc << 'EOF'
# Alias for quick access
export GOSRC="$WORKSPACE/"
export IAM_ROOT="$HOME/workspces/iam"
alias mm="cd $HOME/workspces"
alias i="cd $HOME/workspces/iam"
EOF
```

åœ¨å®‰è£…é…ç½®IAMç³»ç»Ÿä¹‹å‰éœ€è¦ä½ æ‰§è¡Œä»¥ä¸‹å‘½ä»¤export `going` ç”¨æˆ·çš„å¯†ç ï¼Œè¿™é‡Œå‡è®¾å¯†ç æ˜¯ `iam59!z$`ï¼š

```bash
export LINUX_PASSWORD='iam59!z$'
```

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œåƒå¯†ç ã€å¯†é’¥ Key è¿™ç±»æ•æ„Ÿä¿¡æ¯ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ç¡¬ç¼–ç åœ¨ç³»ç»Ÿä¸­ï¼Œè€Œæ˜¯é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼æ¥ä½¿ç”¨ã€‚ç°ç½‘åº”ç”¨çš„é…ç½®æ–‡ä»¶æ˜¯å­˜æ”¾åœ¨ä¸€ä¸ªå®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œå¹¶ä¸”æœ‰è®¿é—®æˆæƒæµç¨‹ï¼Œæ¯”è¾ƒå®‰å…¨ï¼Œè¿™ç§é…ç½®æ–‡ä»¶ä¸­æ˜¯å¯ä»¥é…ç½®å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯çš„ã€‚





## å®‰è£…å’Œé…ç½®æ•°æ®åº“

å› ä¸º IAM ç³»ç»Ÿç”¨åˆ°äº† MariaDBã€Redisã€MongoDB æ•°æ®åº“æ¥å­˜å‚¨æ•°æ®ï¼Œè€Œ IAM æœåŠ¡åœ¨å¯åŠ¨æ—¶ä¼šå…ˆå°è¯•è¿æ¥è¿™äº›æ•°æ®åº“ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…å¯åŠ¨æ—¶è¿æ¥æ•°æ®åº“å¤±è´¥ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ¥å®‰è£…éœ€è¦çš„æ•°æ®åº“ã€‚



### MariaDB 

**mysql:**

> IAM ä¼šæŠŠ REST èµ„æºçš„å®šä¹‰ä¿¡æ¯å­˜å‚¨åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå…³ç³»å‹æ•°æ®åº“æˆ‘é€‰æ‹©äº† MariaDBã€‚ä¸ºå•¥é€‰æ‹© MariaDBï¼Œè€Œä¸æ˜¯ MySQL å‘¢ï¼Ÿã€‚é€‰æ‹© MariaDB ä¸€æ–¹é¢æ˜¯å› ä¸ºå®ƒæ˜¯å‘å±•æœ€å¿«çš„ MySQL åˆ†æ”¯ï¼Œç›¸æ¯” MySQLï¼Œå®ƒåŠ å…¥äº†å¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œå¹¶ä¸”å®ƒèƒ½å¤Ÿå®Œå…¨å…¼å®¹ MySQLï¼ŒåŒ…æ‹¬ API å’Œå‘½ä»¤è¡Œã€‚å¦ä¸€æ–¹é¢æ˜¯å› ä¸º MariaDB æ˜¯å¼€æºçš„ï¼Œè€Œä¸”è¿­ä»£é€Ÿåº¦å¾ˆå¿«ã€‚

```bash
cd $IAM_ROOT
./scripts/install/mariadb.sh iam::mariadb::install
```



### Redis

åœ¨ IAM ç³»ç»Ÿä¸­ï¼Œç”±äº iam-authz-server æ˜¯ä» iam-apiserver æ‹‰å–å¹¶ç¼“å­˜ç”¨æˆ·çš„å¯†é’¥ / ç­–ç•¥ä¿¡æ¯çš„ï¼Œå› æ­¤åŒä¸€ä»½å¯†é’¥ / ç­–ç•¥æ•°æ®ä¼šåˆ†åˆ«å­˜åœ¨ 2 ä¸ªæœåŠ¡ä¸­ï¼Œè¿™å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ•°æ®ä¸ä¸€è‡´ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬é€šè¿‡ iam-apiserver åˆ›å»ºäº†ä¸€å¯¹å¯†é’¥ï¼Œä½†æ˜¯è¿™å¯¹å¯†é’¥è¿˜æ²¡æœ‰è¢« iam-authz-server ç¼“å­˜ï¼Œè¿™æ—¶å€™é€šè¿‡è¿™å¯¹å¯†é’¥è®¿é—® iam-authz-server å°±ä¼šè®¿é—®å¤±è´¥ã€‚

ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis çš„å‘å¸ƒè®¢é˜… (pub/sub) åŠŸèƒ½è¿›è¡Œæ¶ˆæ¯é€šçŸ¥ã€‚åŒæ—¶ï¼Œiam-authz-server ä¹Ÿä¼šå°†æˆæƒå®¡è®¡æ—¥å¿—ç¼“å­˜åˆ° Redis ä¸­ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å®‰è£… Redis key-value æ•°æ®åº“ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å’Œé…ç½® Redisï¼Œå¹¶å°† Redis çš„åˆå§‹å¯†ç è®¾ç½®ä¸º `iam59!z$` ï¼š

```bash
$ cd $IAM_ROOT
$ ./scripts/install/redis.sh iam::redis::install
```

è¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„ï¼Œscripts/install/redis.sh è„šæœ¬ä¸­ iam::redis::install å‡½æ•°å¯¹ Redis åšäº†ä¸€äº›é…ç½®ï¼Œä¾‹å¦‚ä¿®æ”¹ Redis ä½¿å…¶ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œã€ä¿®æ”¹ Redis çš„å¯†ç ä¸º `iam59!z$`ç­‰ï¼Œè¯¦ç»†é…ç½®å¯å‚è€ƒå‡½æ•° `iam::redis::install` å‡½æ•°ã€‚

```bash
 $ redis-cli -h 127.0.0.1 -p 6379 -a 'iam59!z$' # è¿æ¥ Redisï¼Œ-h æŒ‡å®šä¸»æœºï¼Œ-p æŒ‡å®šç›‘å¬ç«¯å£ï¼Œ-a æŒ‡å®šç™»å½•å¯†ç 
```









### å®‰è£…å’Œé…ç½® MariaDB

+ [å¼€æºçš„ GitHub åœ°å€](https://github.com/MariaDB/server)

IAM ä¼šæŠŠ REST èµ„æºçš„å®šä¹‰ä¿¡æ¯å­˜å‚¨åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå…³ç³»å‹æ•°æ®åº“æˆ‘é€‰æ‹©äº† MariaDBã€‚ä¸ºå•¥é€‰æ‹© MariaDBï¼Œè€Œä¸æ˜¯ MySQL å‘¢ï¼Ÿã€‚é€‰æ‹© MariaDB ä¸€æ–¹é¢æ˜¯å› ä¸ºå®ƒæ˜¯å‘å±•æœ€å¿«çš„ MySQL åˆ†æ”¯ï¼Œç›¸æ¯” MySQLï¼Œå®ƒåŠ å…¥äº†å¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œå¹¶ä¸”å®ƒèƒ½å¤Ÿå®Œå…¨å…¼å®¹ MySQLï¼ŒåŒ…æ‹¬ API å’Œå‘½ä»¤è¡Œã€‚å¦ä¸€æ–¹é¢æ˜¯å› ä¸º MariaDB æ˜¯å¼€æºçš„ï¼Œè€Œä¸”è¿­ä»£é€Ÿåº¦å¾ˆå¿«ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…å’Œé…ç½® MariaDBï¼Œå¹¶å°† Root å¯†ç è®¾ç½®ä¸º `1234`ï¼š

> MariaDB vs Mysql:
>
> MariaDBæ˜¯ä¸€ç§å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯MySQLçš„ä¸€ä¸ªåˆ†æ”¯ã€‚ä¸¤è€…åœ¨æŠ€æœ¯ä¸ŠåŸºæœ¬ç›¸åŒï¼Œä½†MariaDBæœ‰ä¸€äº›é¢å¤–çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚
>
> ä¸€ä¸ªæ˜æ˜¾çš„åŒºåˆ«æ˜¯MariaDBæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œè€ŒMySQLæ˜¯Oracleå…¬å¸æ‹¥æœ‰å’Œç»´æŠ¤ã€‚
>
> MariaDBè¿˜æ·»åŠ äº†ä¸€äº›æ–°ç‰¹æ€§ï¼Œå¦‚æ”¯æŒæ›´é«˜ç‰ˆæœ¬çš„SQLæ ‡å‡†å’Œæ›´å¥½çš„æ€§èƒ½ï¼Œè¿˜æœ‰ä¸€äº›å®‰å…¨æ€§å¢å¼ºã€‚
>
> ä½†æ˜¯, ä¸€èˆ¬æ¥è¯´ï¼ŒMariaDBå’ŒMySQLçš„æ€§èƒ½ç›¸å½“æ¥è¿‘ï¼Œå› ä¸ºå®ƒä»¬ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨å¼•æ“ã€‚
>
> åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼ŒMariaDBå¯èƒ½ä¼šæ›´å¿«ï¼Œå› ä¸ºå®ƒæœ‰ä¸€äº›é¢å¤–çš„ä¼˜åŒ–å’Œç‰¹æ€§ï¼Œä¾‹å¦‚æ›´æ–°çš„SQLè§£æå™¨å’Œæ›´å¿«çš„æŸ¥è¯¢ä¼˜åŒ–å™¨ã€‚
>
> å¦å¤–, ä¹Ÿæœ‰ä¸€äº›æµ‹è¯•ç»“æœè¡¨æ˜MariaDBçš„æ€§èƒ½æ¯”MySQLæ›´ä¼˜ç§€ï¼Œä½†æ˜¯è¿™å–å†³äºå…·ä½“çš„åœºæ™¯å’Œä½¿ç”¨æ–¹å¼ã€‚
>
> å¯¹äºå¼€å‘äººå‘˜æ¥è¯´ï¼Œä¸¤è€…çš„è¯­æ³•å’ŒAPIå‡ ä¹ç›¸åŒï¼Œæ‰€ä»¥ä»MySQLè¿ç§»åˆ°MariaDBæ˜¯éå¸¸ç®€å•çš„ã€‚
>
> æ€»çš„æ¥è¯´ï¼ŒMariaDBæ˜¯MySQLçš„ä¸€ä¸ªå¾ˆå¥½çš„æ›¿ä»£å“ï¼Œå®ƒåœ¨ç»§æ‰¿äº†MySQLçš„ä¼˜ç§€ç‰¹æ€§çš„åŒæ—¶ï¼Œè¿˜æ·»åŠ äº†è®¸å¤šæ–°åŠŸèƒ½ã€‚

```bash
cd $IAM_ROOT; ./scripts/install/mariadb.sh iam::mariadb::install
```



### å®‰è£…redis

åœ¨ IAM ç³»ç»Ÿä¸­ï¼Œç”±äº iam-authz-server æ˜¯ä» iam-apiserver æ‹‰å–å¹¶ç¼“å­˜ç”¨æˆ·çš„å¯†é’¥/ç­–ç•¥ä¿¡æ¯çš„ï¼Œå› æ­¤åŒä¸€ä»½å¯†é’¥/ç­–ç•¥æ•°æ®ä¼šåˆ†åˆ«å­˜åœ¨ 2 ä¸ªæœåŠ¡ä¸­ï¼Œè¿™å¯èƒ½ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚æ•°æ®ä¸ä¸€è‡´ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬é€šè¿‡ iam-apiserver åˆ›å»ºäº†ä¸€å¯¹å¯†é’¥ï¼Œä½†æ˜¯è¿™å¯¹å¯†é’¥è¿˜æ²¡æœ‰è¢« iam-authz-server ç¼“å­˜ï¼Œè¿™æ—¶å€™é€šè¿‡è¿™å¯¹å¯†é’¥è®¿é—® iam-authz-server å°±ä¼šè®¿é—®å¤±è´¥ã€‚

ä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis çš„å‘å¸ƒè®¢é˜…(pub/sub)åŠŸèƒ½è¿›è¡Œæ¶ˆæ¯é€šçŸ¥ã€‚åŒæ—¶ï¼Œiam-authz-server ä¹Ÿä¼šå°†æˆæƒå®¡è®¡æ—¥å¿—ç¼“å­˜åˆ° Redis ä¸­ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å®‰è£… Redis key-value æ•°æ®åº“ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å’Œé…ç½® Redisï¼Œå¹¶å°† Redis çš„åˆå§‹å¯†ç è®¾ç½®ä¸º `iam59!z$` ï¼š

```bash
cd $IAM_ROOT$ ./scripts/install/redis.sh iam::redis::install
```

è¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„ï¼Œscripts/install/redis.sh è„šæœ¬ä¸­ iam::redis::install å‡½æ•°å¯¹ Redis åšäº†ä¸€äº›é…ç½®ï¼Œä¾‹å¦‚ä¿®æ”¹ Redis ä½¿å…¶ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œã€ä¿®æ”¹ Redis çš„å¯†ç ä¸º `iam59!z$`ç­‰ï¼Œè¯¦ç»†é…ç½®å¯å‚è€ƒå‡½æ•° [iam::redis::install](https://github.com/marmotedu/iam/blob/v1.0.0/scripts/install/redis.sh#L20) å‡½æ•°ã€‚

å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼Œæ¥æµ‹è¯• Redis æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```bash
redis-cli -h 127.0.0.1 -p 6379 -a 'iam59!z$' 
# è¿æ¥ Redisï¼Œ-h æŒ‡å®šä¸»æœºï¼Œ-p æŒ‡å®šç›‘å¬ç«¯å£ï¼Œ-a æŒ‡å®šç™»å½•å¯†ç 
```



### å®‰è£…å’Œé…ç½® MongoDB

å› ä¸º iam-pump ä¼šå°† iam-authz-server äº§ç”Ÿçš„æ•°æ®å¤„ç†åå­˜å‚¨åœ¨ MongoDB ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿéœ€è¦å®‰è£… MongoDB æ•°æ®åº“ã€‚ä¸»è¦åˆ†ä¸¤æ­¥å®‰è£…ï¼š

1. é¦–å…ˆå®‰è£… MongoDB
2. ç„¶åå†åˆ›å»º MongoDB è´¦å·



#### ç¬¬ 1 æ­¥ï¼Œå®‰è£… MongoDB

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ 4 æ­¥æ¥å®‰è£… MongoDBã€‚

**é…ç½® MongoDB yum æºï¼Œå¹¶å®‰è£… MongoDBã€‚**

CentOS8.x ç³»ç»Ÿé»˜è®¤æ²¡æœ‰é…ç½®å®‰è£… MongoDB éœ€è¦çš„ yum æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆé…ç½®å¥½ yum æºå†å®‰è£…ï¼š

```bash
$ sudo tee /etc/yum.repos.d/mongodb-org-5.0.repo<<'EOF'
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
EOF
 
$ sudo yum install -y mongodb-org
```

**å…³é—­ SELinux**ã€‚

åœ¨å®‰è£…çš„è¿‡ç¨‹ä¸­ï¼ŒSELinux æœ‰å¯èƒ½ä¼šé˜»æ­¢ MongoDB è®¿é—® `/sys/fs/cgroup`ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å…³é—­ SELinuxï¼š

> SELinux(Security-Enhanced Linux æˆ– Security-Enhanced Linux)æ˜¯ä¸€ç§å®‰å…¨æ§åˆ¶æœºåˆ¶ï¼Œç”±NSAå…¬å¸å¼€å‘ï¼Œå¯ä»¥åœ¨Linuxç³»ç»Ÿä¸Šæä¾›æ›´å¼ºå¤§çš„å®‰å…¨æ€§ã€‚å®ƒä½¿ç”¨æ ‡ç­¾æ¥åŒºåˆ†æ“ä½œç³»ç»Ÿä¸Šçš„æ–‡ä»¶å’Œç›®å½•ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç³»ç»Ÿä¸Šå®æ–½ç‰¹å®šçš„å®‰å…¨ç­–ç•¥ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨ã€‚

```bash
$ sudo setenforce 0
$ sudo sed -i 's/^SELINUX=.*$/SELINUX=disabled/' /etc/selinux/config # æ°¸ä¹…å…³é—­ SELINUX
```



**å¼€å¯å¤–ç½‘è®¿é—®æƒé™å’Œç™»å½•éªŒè¯**ã€‚

MongoDB å®‰è£…å®Œä¹‹åï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šå¼€å¯å¤–ç½‘è®¿é—®æƒé™å’Œç™»å½•éªŒè¯ï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘å»ºè®®ä½ å…ˆå¼€å¯è¿™äº›åŠŸèƒ½ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¼€å¯ï¼š

```bash
$ sudo sed -i '/bindIp/{s/127.0.0.1/0.0.0.0/}' /etc/mongod.conf
$ sudo sed -i '/^#security/a\security:\n  authorization: enabled' /etc/mongod.conf
```



**å¯åŠ¨ MongoDBã€‚**

é…ç½®å®Œ MongoDB ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨å®ƒäº†ï¼Œå…·ä½“çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ sudo systemctl start mongod
$ sudo systemctl enable mongod # è®¾ç½®å¼€æœºå¯åŠ¨
$ sudo systemctl status mongod # æŸ¥çœ‹ mongod è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å« active (running)å­—æ ·è¯´æ˜ mongod æˆåŠŸå¯åŠ¨
```

å®‰è£…å®Œ MongoDB åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ `mongo` å‘½ä»¤ç™»å½• MongoDB Shellã€‚å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œå°±è¯´æ˜ MongoDB è¢«æˆåŠŸå®‰è£…äº†ã€‚

```bash
mongosh --quiet "mongodb://127.0.0.1:27017&quot
```



#### ç¬¬ 2 æ­¥ï¼Œåˆ›å»º MongoDB è´¦å·

å®‰è£…å®Œ MongoDB ä¹‹åï¼Œé»˜è®¤æ˜¯æ²¡æœ‰ç”¨æˆ·è´¦å·çš„ï¼Œä¸ºäº†æ–¹ä¾¿ IAM æœåŠ¡ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºå¥½ç®¡ç†å‘˜è´¦å·ï¼Œé€šè¿‡ç®¡ç†å‘˜è´¦æˆ·ç™»å½• MongoDBï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œåˆ›å»ºæ™®é€šç”¨æˆ·ã€æ•°æ®åº“ç­‰æ“ä½œã€‚

**åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·**ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ `use admin` æŒ‡ä»¤åˆ‡æ¢åˆ° admin æ•°æ®åº“ï¼Œå†é€šè¿‡ `db.auth("ç”¨æˆ·å"ï¼Œ"ç”¨æˆ·å¯†ç ")` éªŒè¯ç”¨æˆ·ç™»å½•æƒé™ã€‚å¦‚æœè¿”å› 1 è¡¨ç¤ºéªŒè¯æˆåŠŸï¼›å¦‚æœè¿”å› 0 è¡¨ç¤ºéªŒè¯å¤±è´¥ã€‚å…·ä½“çš„å‘½ä»¤å¦‚ä¸‹ï¼š

```sh
$ mongosh --quiet "mongodb://127.0.0.1:27017"
test> use admin 
switched to db admin
admin> db.createUser({user:"root",pwd:"iam59!z$",roles:["root"]})
{ ok: 1 }
admin> db.auth("root", "iam59!z$")
{ ok: 1 }
```

æ­¤å¤–ï¼Œå¦‚æœæƒ³åˆ é™¤ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ `db.dropUser("ç”¨æˆ·å")` å‘½ä»¤ã€‚

`db.createUser` ç”¨åˆ°äº†ä»¥ä¸‹ 3 ä¸ªå‚æ•°ã€‚

+ user: ç”¨æˆ·åã€‚
+ pwd: ç”¨æˆ·å¯†ç ã€‚
+ roles: ç”¨æ¥è®¾ç½®ç”¨æˆ·çš„æƒé™ï¼Œæ¯”å¦‚è¯»ã€è¯»å†™ã€å†™ç­‰ã€‚

å› ä¸º admin ç”¨æˆ·å…·æœ‰ MongoDB çš„ Root æƒé™ï¼Œæƒé™è¿‡å¤§å®‰å…¨æ€§ä¼šé™ä½ã€‚ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ª iam æ™®é€šç”¨æˆ·æ¥è¿æ¥å’Œæ“ä½œ MongoDBã€‚

1. åˆ›å»º iam ç”¨æˆ·ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ mongosh --quiet mongodb://root:'iam59!z$'@127.0.0.1:27017/iam_analytics?authSource=admin # ç”¨ç®¡ç†å‘˜è´¦æˆ·è¿æ¥ MongoDB
iam_analytics> db.createUser({user:"iam",pwd:"iam59!z$",roles:["dbOwner"]})
{ ok: 1 }
iam_analytics> db.auth("iam", "iam59!z$")
{ ok: 1 }
```

åˆ›å»ºå®Œ iam æ™®é€šç”¨æˆ·åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ iam ç”¨æˆ·ç™»å½• MongoDB äº†ï¼š

```bash
$ mongosh --quiet mongodb://iam:'iam59!z$'@127.0.0.1:27017/iam_analytics?authSource=iam_analytics
```

è‡³æ­¤ï¼Œæˆ‘ä»¬æˆåŠŸå®‰è£…äº† IAM ç³»ç»Ÿéœ€è¦çš„æ•°æ®åº“ MariaDBã€Redis å’Œ MongoDBã€‚



### å®‰è£…å’Œé…ç½® IAM ç³»ç»Ÿ

è¦æƒ³å®Œæˆ IAM ç³»ç»Ÿçš„å®‰è£…ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…å’Œé…ç½® iam-apiserverã€iam-authz-serverã€iam-pump å’Œ iamctlã€‚è¿™äº›ç»„ä»¶çš„åŠŸèƒ½æˆ‘ä»¬åœ¨[ç¬¬1è®²](https://time.geekbang.org/column/article/377998)è¯¦ç»†è®²è¿‡ï¼Œå¦‚æœä¸è®°å¾—ä½ å¯ä»¥ç¿»å›å»çœ‹çœ‹ã€‚

> æç¤ºï¼šIAM é¡¹ç›®æˆ‘ä¼šé•¿æœŸç»´æŠ¤ã€å®šæœŸæ›´æ–°ï¼Œæ¬¢è¿ä½  Star & Contributingã€‚



**å‡†å¤‡å·¥ä½œï¼š**

åœ¨å¼€å§‹å®‰è£…ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œä¸»è¦æœ‰ 5 æ­¥ã€‚

1. åˆå§‹åŒ– MariaDB æ•°æ®åº“ï¼Œåˆ›å»º iam æ•°æ®åº“ã€‚
2. é…ç½® scripts/install/environment.shã€‚
3. åˆ›å»ºéœ€è¦çš„ç›®å½•ã€‚
4. åˆ›å»º CA æ ¹è¯ä¹¦å’Œå¯†é’¥ã€‚
5. é…ç½® hostsã€‚



#### ç¬¬ 1 æ­¥ï¼Œåˆå§‹åŒ– MariaDB æ•°æ®åº“ï¼Œåˆ›å»º iam æ•°æ®åº“ã€‚

å®‰è£…å®Œ MariaDB æ•°æ®åº“ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦åœ¨ MariaDB æ•°æ®åº“ä¸­åˆ›å»º IAM ç³»ç»Ÿéœ€è¦çš„æ•°æ®åº“ã€è¡¨å’Œå­˜å‚¨è¿‡ç¨‹ï¼Œä»¥åŠåˆ›å»º SQL è¯­å¥ä¿å­˜åœ¨ IAM ä»£ç ä»“åº“ä¸­çš„ `configs/iam.sql` æ–‡ä»¶ä¸­ã€‚å…·ä½“çš„åˆ›å»ºæ­¥éª¤å¦‚ä¸‹ã€‚

**ç™»å½•æ•°æ®åº“å¹¶åˆ›å»º iam ç”¨æˆ·ã€‚**

```bash
$ cd $IAM_ROOT
$ mysql -h127.0.0.1 -P3306 -uroot -p'iam59!z$' # è¿æ¥ MariaDBï¼Œ-h æŒ‡å®šä¸»æœºï¼Œ-P æŒ‡å®šç›‘å¬ç«¯å£ï¼Œ-u æŒ‡å®šç™»å½•ç”¨æˆ·ï¼Œ-p æŒ‡å®šç™»å½•å¯†ç 
MariaDB [(none)]> grant all on iam.* TO iam@127.0.0.1 identified by 'iam59!z$';
Query OK, 0 rows affected (0.000 sec)
MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.000 sec)
```



**ç”¨ iam ç”¨æˆ·ç™»å½• MariaDBï¼Œæ‰§è¡Œ iam.sql æ–‡ä»¶ï¼Œåˆ›å»º iam æ•°æ®åº“ã€‚**

```bash
$ mysql -h127.0.0.1 -P3306 -uiam -p'iam59!z$'
MariaDB [(none)]> source configs/iam.sql;
MariaDB [iam]> show databases;
+--------------------+
| Database           |
+--------------------+
| iam                |
| information_schema |
+--------------------+
2 rows in set (0.000 sec)
```

ä¸Šé¢çš„å‘½ä»¤ä¼šåˆ›å»º iam æ•°æ®åº“ï¼Œå¹¶åˆ›å»ºä»¥ä¸‹æ•°æ®åº“èµ„æºã€‚

+ è¡¨ï¼š
  + user æ˜¯ç”¨æˆ·è¡¨ï¼Œç”¨æ¥å­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼›
  + secret æ˜¯å¯†é’¥è¡¨ï¼Œç”¨æ¥å­˜æ”¾å¯†é’¥ä¿¡æ¯ï¼›
  + policy æ˜¯ç­–ç•¥è¡¨ï¼Œç”¨æ¥å­˜æ”¾æˆæƒç­–ç•¥ä¿¡æ¯ï¼›
  + policy_audit æ˜¯ç­–ç•¥å†å²è¡¨ï¼Œè¢«åˆ é™¤çš„ç­–ç•¥ä¼šè¢«è½¬å­˜åˆ°è¯¥è¡¨ã€‚
+ admin ç”¨æˆ·ï¼šåœ¨ user è¡¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼Œç”¨æˆ·åæ˜¯ adminï¼Œå¯†ç æ˜¯ `Admin@2021`ã€‚
+ å­˜å‚¨è¿‡ç¨‹ï¼šåˆ é™¤ç”¨æˆ·æ—¶ä¼šè‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·æ‰€å±çš„å¯†é’¥å’Œç­–ç•¥ä¿¡æ¯ã€‚



#### ç¬¬ 2 æ­¥ï¼Œé…ç½® scripts/install/environment.shã€‚

IAM ç»„ä»¶çš„å®‰è£…é…ç½®éƒ½æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡æ–‡ä»¶ [scripts/install/environment.sh](scripts/install/environment.sh) è¿›è¡Œé…ç½®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆé…ç½®å¥½ scripts/install/environment.sh æ–‡ä»¶ã€‚è¿™é‡Œï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨é»˜è®¤å€¼ï¼Œæé«˜ä½ çš„å®‰è£…æ•ˆç‡ã€‚



#### ç¬¬ 3 æ­¥ï¼Œåˆ›å»ºéœ€è¦çš„ç›®å½•ã€‚

åœ¨å®‰è£…å’Œè¿è¡Œ IAM ç³»ç»Ÿçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†é…ç½®ã€äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶å­˜æ”¾åˆ°æŒ‡å®šçš„ç›®å½•ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆåˆ›å»ºå¥½è¿™äº›ç›®å½•ï¼Œåˆ›å»ºæ­¥éª¤å¦‚ä¸‹ã€‚

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ sudo mkdir -p ${IAM_DATA_DIR}/{iam-apiserver,iam-authz-server,iam-pump} # åˆ›å»º Systemd WorkingDirectory ç›®å½•
$ sudo mkdir -p ${IAM_INSTALL_DIR}/bin #åˆ›å»º IAM ç³»ç»Ÿå®‰è£…ç›®å½•
$ sudo mkdir -p ${IAM_CONFIG_DIR}/cert # åˆ›å»º IAM ç³»ç»Ÿé…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•
$ sudo mkdir -p ${IAM_LOG_DIR} # åˆ›å»º IAM æ—¥å¿—æ–‡ä»¶å­˜æ”¾ç›®å½•
```



#### ç¬¬ 4 æ­¥ï¼Œ åˆ›å»º CA æ ¹è¯ä¹¦å’Œå¯†é’¥ã€‚

ä¸ºäº†ç¡®ä¿å®‰å…¨ï¼ŒIAM ç³»ç»Ÿå„ç»„ä»¶éœ€è¦ä½¿ç”¨ x509 è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†å’Œè®¤è¯ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆåˆ›å»º CA è¯ä¹¦ã€‚CA æ ¹è¯ä¹¦æ˜¯æ‰€æœ‰ç»„ä»¶å…±äº«çš„ï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ª CA è¯ä¹¦ï¼Œåç»­åˆ›å»ºçš„æ‰€æœ‰è¯ä¹¦éƒ½ç”±å®ƒç­¾åã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl æ¥åˆ›å»ºæ‰€æœ‰çš„è¯ä¹¦ã€‚

**å®‰è£… cfssl å·¥å…·é›†ã€‚**

æˆ‘ä»¬å¯ä»¥ç›´æ¥å®‰è£… cfssl å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œcfssl å·¥å…·é›†ä¸­åŒ…å«å¾ˆå¤šå·¥å…·ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å®‰è£… cfsslã€cfssljsonã€cfssl-certinfoï¼ŒåŠŸèƒ½å¦‚ä¸‹ã€‚

1. cfsslï¼šè¯ä¹¦ç­¾å‘å·¥å…·ã€‚
2. cfssljsonï¼šå°† cfssl ç”Ÿæˆçš„è¯ä¹¦ï¼ˆjson æ ¼å¼ï¼‰å˜ä¸ºæ–‡ä»¶æ‰¿è½½å¼è¯ä¹¦ã€‚

è¿™ä¸¤ä¸ªå·¥å…·çš„å®‰è£…æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
$ cd $IAM_ROOT
$ ./scripts/install/install.sh iam::install::install_cfssl
```

**åˆ›å»ºé…ç½®æ–‡ä»¶ã€‚**

CA é…ç½®æ–‡ä»¶æ˜¯ç”¨æ¥é…ç½®æ ¹è¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ (profile) å’Œå…·ä½“å‚æ•° (usageã€è¿‡æœŸæ—¶é—´ã€æœåŠ¡ç«¯è®¤è¯ã€å®¢æˆ·ç«¯è®¤è¯ã€åŠ å¯†ç­‰)ï¼Œå¯ä»¥åœ¨ç­¾åå…¶å®ƒè¯ä¹¦æ—¶ç”¨æ¥æŒ‡å®šç‰¹å®šåœºæ™¯ï¼š

```bash
$ cd $IAM_ROOT
$ tee ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "iam": {
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth"
        ],
        "expiry": "876000h"
      }
    }
  }
}
EOF
```

ä¸Šé¢çš„ JSON é…ç½®ä¸­ï¼Œæœ‰ä¸€äº›å­—æ®µè§£é‡Šå¦‚ä¸‹ã€‚

+ signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼ˆç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼‰ã€‚
+ server authï¼šè¡¨ç¤º client å¯ä»¥ç”¨è¯¥è¯ä¹¦å¯¹ server æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ã€‚
+ client authï¼šè¡¨ç¤º server å¯ä»¥ç”¨è¯¥è¯ä¹¦å¯¹ client æä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ã€‚
+ expiryï¼š876000hï¼Œè¯ä¹¦æœ‰æ•ˆæœŸè®¾ç½®ä¸º 100 å¹´ã€‚



**åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ã€‚**

æˆ‘ä»¬åˆ›å»ºç”¨æ¥ç”Ÿæˆ CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆCSRï¼‰çš„ JSON é…ç½®æ–‡ä»¶ï¼š

```bash

$ cd $IAM_ROOT
$ tee ca-csr.json << EOF
{
  "CN": "iam-ca",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "marmotedu",
      "OU": "iam"
    }
  ],
  "ca": {
    "expiry": "876000h"
  }
}
EOF
```



**ä¸Šé¢çš„ JSON é…ç½®ä¸­ï¼Œæœ‰ä¸€äº›å­—æ®µè§£é‡Šå¦‚ä¸‹ã€‚**

+ Cï¼šCountryï¼Œå›½å®¶ã€‚
+ STï¼šStateï¼Œçœä»½ã€‚
+ Lï¼šLocality (L) or Cityï¼ŒåŸå¸‚ã€‚
+ CNï¼šCommon Nameï¼Œiam-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name) ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ã€‚
+ Oï¼šOrganizationï¼Œiam-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ã€‚
+ OUï¼šCompany division (or Organization Unit â€“ OU)ï¼Œéƒ¨é—¨ / å•ä½ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ç‚¹éœ€è¦æˆ‘ä»¬æ³¨æ„ã€‚

+ ä¸åŒè¯ä¹¦ csr æ–‡ä»¶çš„ CNã€Cã€STã€Lã€Oã€OU ç»„åˆå¿…é¡»ä¸åŒï¼Œå¦åˆ™å¯èƒ½å‡ºç° PEER'S CERTIFICATE HAS AN INVALID SIGNATURE é”™è¯¯ã€‚
+ åç»­åˆ›å»ºè¯ä¹¦çš„ csr æ–‡ä»¶æ—¶ï¼ŒCNã€OU éƒ½ä¸ç›¸åŒï¼ˆCã€STã€Lã€O ç›¸åŒï¼‰ï¼Œä»¥è¾¾åˆ°åŒºåˆ†çš„ç›®çš„ã€‚
+ åˆ›å»º CA è¯ä¹¦å’Œç§é’¥

é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ cfssl gencert å‘½ä»¤æ¥åˆ›å»ºï¼š

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ cfssl gencert -initca ca-csr.json | cfssljson -bare ca
$ ls ca*
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
$ sudo mv ca* ${IAM_CONFIG_DIR}/cert # éœ€è¦å°†è¯ä¹¦æ–‡ä»¶æ‹·è´åˆ°æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹ï¼ˆåˆ†å‘è¯ä¹¦ï¼‰ï¼Œæ–¹ä¾¿å„ç»„ä»¶å¼•ç”¨
```

ä¸Šè¿°å‘½ä»¤ä¼šåˆ›å»ºè¿è¡Œ CA æ‰€å¿…éœ€çš„æ–‡ä»¶ ca-key.pemï¼ˆç§é’¥ï¼‰å’Œ ca.pemï¼ˆè¯ä¹¦ï¼‰ï¼Œè¿˜ä¼šç”Ÿæˆ ca.csrï¼ˆè¯ä¹¦ç­¾åè¯·æ±‚ï¼‰ï¼Œç”¨äºäº¤å‰ç­¾åæˆ–é‡æ–°ç­¾åã€‚

åˆ›å»ºå®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ cfssl certinfo å‘½åæŸ¥çœ‹ cert å’Œ csr ä¿¡æ¯ï¼š

```bash
$ cfssl certinfo -cert ${IAM_CONFIG_DIR}/cert/ca.pem # æŸ¥çœ‹ cert(è¯ä¹¦ä¿¡æ¯)
$ cfssl certinfo -csr ${IAM_CONFIG_DIR}/cert/ca.csr # æŸ¥çœ‹ CSR(è¯ä¹¦ç­¾åè¯·æ±‚)ä¿¡æ¯
```



#### ç¬¬ 5 æ­¥ï¼Œé…ç½® hostsã€‚

iam é€šè¿‡åŸŸåè®¿é—® API æ¥å£ï¼Œå› ä¸ºè¿™äº›åŸŸåæ²¡æœ‰æ³¨å†Œè¿‡ï¼Œè¿˜ä¸èƒ½åœ¨äº’è”ç½‘ä¸Šè§£æï¼Œæ‰€ä»¥éœ€è¦é…ç½® hostsï¼Œå…·ä½“çš„æ“ä½œå¦‚ä¸‹ï¼š

```bash
$ sudo tee -a /etc/hosts <<EOF
127.0.0.1 iam.api.marmotedu.com
127.0.0.1 iam.authz.marmotedu.com
EOF
```



### å®‰è£…å’Œé…ç½® iam-apiserver

å®Œæˆäº†å‡†å¤‡å·¥ä½œä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®‰è£… IAM ç³»ç»Ÿçš„å„ä¸ªç»„ä»¶äº†ã€‚é¦–å…ˆæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ 3 æ­¥æ¥å®‰è£… iam-apiserver æœåŠ¡ã€‚



#### ç¬¬ 1 æ­¥ï¼Œåˆ›å»º iam-apiserver è¯ä¹¦å’Œç§é’¥ã€‚

å…¶å®ƒæœåŠ¡ä¸ºäº†å®‰å…¨éƒ½æ˜¯é€šè¿‡ HTTPS åè®®è®¿é—® iam-apiserverï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆåˆ›å»º iam-apiserver è¯ä¹¦å’Œç§é’¥ã€‚

**åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚**ï¼š

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ tee iam-apiserver-csr.json <<EOF
{
  "CN": "iam-apiserver",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "marmotedu",
      "OU": "iam-apiserver"
    }
  ],
  "hosts": [
    "127.0.0.1",
    "localhost",
    "iam.api.marmotedu.com"
  ]
}
EOF
```

ä»£ç ä¸­çš„ hosts å­—æ®µæ˜¯ç”¨æ¥æŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œä¸Šé¢çš„ hosts åˆ—å‡ºäº† iam-apiserver æœåŠ¡çš„ IP å’ŒåŸŸåã€‚



**ç”Ÿæˆè¯ä¹¦å’Œç§é’¥**ï¼š

```bash
$ cfssl gencert -ca=${IAM_CONFIG_DIR}/cert/ca.pem \
  -ca-key=${IAM_CONFIG_DIR}/cert/ca-key.pem \
  -config=${IAM_CONFIG_DIR}/cert/ca-config.json \
  -profile=iam iam-apiserver-csr.json | cfssljson -bare iam-apiserver
$ sudo mv iam-apiserver*pem ${IAM_CONFIG_DIR}/cert 
# å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶æ‹·è´åˆ°é…ç½®æ–‡ä»¶ç›®å½•
```



#### ç¬¬ 2 æ­¥ï¼Œå®‰è£…å¹¶è¿è¡Œ iam-apiserverã€‚

iam-apiserver ä½œä¸º iam ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œéœ€è¦ç¬¬ä¸€ä¸ªå®‰è£…ã€‚



**å®‰è£… iam-apiserver å¯æ‰§è¡Œç¨‹åºï¼š**

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ make build BINS=iam-apiserver
$ sudo cp _output/platforms/linux/amd64/iam-apiserver ${IAM_INSTALL_DIR}/bin
```



**ç”Ÿæˆå¹¶å®‰è£… iam-apiserver çš„é…ç½®æ–‡ä»¶ï¼ˆiam-apiserver.yamlï¼‰ï¼š**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-apiserver.yaml > iam-apiserver.yaml
$ sudo mv iam-apiserver.yaml ${IAM_CONFIG_DIR}
```



**åˆ›å»ºå¹¶å®‰è£… iam-apiserver systemd unit æ–‡ä»¶ï¼š**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-apiserver.service > iam-apiserver.service
$ sudo mv iam-apiserver.service /etc/systemd/system/
```



**å¯åŠ¨ iam-apiserver æœåŠ¡ï¼š**

```bash
$ sudo systemctl daemon-reload
$ sudo systemctl enable iam-apiserver
$ sudo systemctl restart iam-apiserver
$ systemctl status iam-apiserver # æŸ¥çœ‹ iam-apiserver è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å« active (running)å­—æ ·è¯´æ˜ iam-apiserver æˆåŠŸå¯åŠ¨
```



#### ç¬¬ 3 æ­¥ï¼Œæµ‹è¯• iam-apiserver æ˜¯å¦æˆåŠŸå®‰è£…ã€‚

æµ‹è¯• iam-apiserver ä¸»è¦æ˜¯æµ‹è¯• RESTful èµ„æºçš„ CURDï¼š**ç”¨æˆ· CURDã€å¯†é’¥ CURDã€æˆæƒç­–ç•¥ CURDã€‚**

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è·å–è®¿é—® iam-apiserver çš„ Tokenï¼Œè¯·æ±‚å¦‚ä¸‹ API è®¿é—®ï¼š

```bash
$ curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login | jq -r .token
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE
```

ä»£ç ä¸­ä¸‹é¢çš„ HTTP è¯·æ±‚é€šè¿‡`-H'Authorization: Bearer <Token>'` æŒ‡å®šè®¤è¯å¤´ä¿¡æ¯ï¼Œå°†ä¸Šé¢è¯·æ±‚çš„ Token æ›¿æ¢ `<Token>` ã€‚



**ç”¨æˆ· CURD:**

åˆ›å»ºç”¨æˆ·ã€åˆ—å‡ºç”¨æˆ·ã€è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ã€ä¿®æ”¹ç”¨æˆ·ã€åˆ é™¤å•ä¸ªç”¨æˆ·ã€æ‰¹é‡åˆ é™¤ç”¨æˆ·ï¼Œè¯·æ±‚æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
# åˆ›å»ºç”¨æˆ·
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"password":"User@2021","metadata":{"name":"colin"},"nickname":"colin","email":"colin@foxmail.com","phone":"1812884xxxx"}' http://127.0.0.1:8080/v1/users

# åˆ—å‡ºç”¨æˆ·
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' 'http://127.0.0.1:8080/v1/users?offset=0&limit=10'

# è·å– colin ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/users/colin

# ä¿®æ”¹ colin ç”¨æˆ·
$ curl -s -XPUT -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"nickname":"colin","email":"colin_modified@foxmail.com","phone":"1867274xxxx"}' http://127.0.0.1:8080/v1/users/colin

# åˆ é™¤ colin ç”¨æˆ·
$ curl -s -XDELETE -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/users/colin

# æ‰¹é‡åˆ é™¤ç”¨æˆ·
$ curl -s -XDELETE -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' 'http://127.0.0.1:8080/v1/users?name=colin&name=mark&name=john'
```



**å¯†é’¥ CURD:**

åˆ›å»ºå¯†é’¥ã€åˆ—å‡ºå¯†é’¥ã€è·å–å¯†é’¥è¯¦ç»†ä¿¡æ¯ã€ä¿®æ”¹å¯†é’¥ã€åˆ é™¤å¯†é’¥è¯·æ±‚æ–¹æ³•å¦‚ä¸‹ï¼š

```bash

# åˆ›å»º secret0 å¯†é’¥
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"metadata":{"name":"secret0"},"expires":0,"description":"admin secret"}' http://127.0.0.1:8080/v1/secrets

# åˆ—å‡ºæ‰€æœ‰å¯†é’¥
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/secrets

# è·å– secret0 å¯†é’¥çš„è¯¦ç»†ä¿¡æ¯
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/secrets/secret0

# ä¿®æ”¹ secret0 å¯†é’¥
$ curl -s -XPUT -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"metadata":{"name":"secret0"},"expires":0,"description":"admin secret(modified)"}' http://127.0.0.1:8080/v1/secrets/secret0

# åˆ é™¤ secret0 å¯†é’¥
$ curl -s -XDELETE -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/secrets/secret0
```

è¿™é‡Œæˆ‘ä»¬è¦æ³¨æ„ï¼Œå› ä¸ºå¯†é’¥å±äºé‡è¦èµ„æºï¼Œè¢«åˆ é™¤ä¼šå¯¼è‡´æ‰€æœ‰çš„è®¿é—®è¯·æ±‚å¤±è´¥ï¼Œæ‰€ä»¥å¯†é’¥ä¸æ”¯æŒæ‰¹é‡åˆ é™¤ã€‚



**æˆæƒç­–ç•¥ CURD:**

åˆ›å»ºç­–ç•¥ã€åˆ—å‡ºç­–ç•¥ã€è·å–ç­–ç•¥è¯¦ç»†ä¿¡æ¯ã€ä¿®æ”¹ç­–ç•¥ã€åˆ é™¤ç­–ç•¥è¯·æ±‚æ–¹æ³•å¦‚ä¸‹ï¼š

```bash
# åˆ›å»ºç­–ç•¥
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"metadata":{"name":"policy0"},"policy":{"description":"One policy to rule them all.","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.*>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies

# åˆ—å‡ºæ‰€æœ‰ç­–ç•¥
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/policies

# è·å– policy0 ç­–ç•¥çš„è¯¦ç»†ä¿¡æ¯
$ curl -s -XGET -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/policies/policy0

# ä¿®æ”¹ policy0 ç­–ç•¥
$ curl -s -XPUT -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"metadata":{"name":"policy0"},"policy":{"description":"One policy to rule them all(modified).","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.*>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies/policy0

# åˆ é™¤ policy0 ç­–ç•¥
$ curl -s -XDELETE -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' http://127.0.0.1:8080/v1/policies/policy0

# åˆ›å»ºç­–ç•¥
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE' -d'{"metadata":{"name":"policy0"},"policy":{"description":"One policy to rule them all.","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.*>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies
```



### å®‰è£… iamctl

ä¸Šé¢ï¼Œæˆ‘ä»¬å®‰è£…äº† iam ç³»ç»Ÿçš„ API æœåŠ¡ã€‚ä½†æ˜¯æƒ³è¦è®¿é—® iam æœåŠ¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®‰è£…å®¢æˆ·ç«¯å·¥å…· iamctlã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ 3 æ­¥å®Œæˆ iamctl çš„å®‰è£…å’Œé…ç½®ã€‚



#### ç¬¬ 1 æ­¥ï¼Œåˆ›å»º iamctl è¯ä¹¦å’Œç§é’¥ã€‚

iamctl ä½¿ç”¨ https åè®®ä¸ iam-apiserver è¿›è¡Œå®‰å…¨é€šä¿¡ï¼Œiam-apiserver å¯¹ iamctl è¯·æ±‚åŒ…å«çš„è¯ä¹¦è¿›è¡Œè®¤è¯å’Œæˆæƒã€‚iamctl åç»­ç”¨äº iam ç³»ç»Ÿè®¿é—®å’Œç®¡ç†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ›å»ºå…·æœ‰æœ€é«˜æƒé™çš„ admin è¯ä¹¦ã€‚



**åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚**ã€‚

ä¸‹é¢åˆ›å»ºçš„è¯ä¹¦åªä¼šè¢« iamctl å½“ä½œ client è¯ä¹¦ä½¿ç”¨ï¼Œæ‰€ä»¥ hosts å­—æ®µä¸ºç©ºã€‚ä»£ç å¦‚ä¸‹ï¼š

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ cat > admin-csr.json <<EOF
{
  "CN": "admin",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "marmotedu",
      "OU": "iamctl"
    }
  ],
  "hosts": []
}
EOF
```



**ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ï¼š**

```bash
$ cfssl gencert -ca=${IAM_CONFIG_DIR}/cert/ca.pem \
  -ca-key=${IAM_CONFIG_DIR}/cert/ca-key.pem \
  -config=${IAM_CONFIG_DIR}/cert/ca-config.json \
  -profile=iam admin-csr.json | cfssljson -bare admin
$ mkdir -p $(dirname ${CONFIG_USER_CLIENT_CERTIFICATE}) $(dirname ${CONFIG_USER_CLIENT_KEY}) # åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦å­˜æ”¾çš„ç›®å½•
$ mv admin.pem ${CONFIG_USER_CLIENT_CERTIFICATE} # å®‰è£… TLS çš„å®¢æˆ·ç«¯è¯ä¹¦
$ mv admin-key.pem ${CONFIG_USER_CLIENT_KEY} # å®‰è£… TLS çš„å®¢æˆ·ç«¯ç§é’¥æ–‡ä»¶
```



#### ç¬¬ 2 æ­¥ï¼Œå®‰è£… iamctlã€‚

iamctl æ˜¯ IAM ç³»ç»Ÿçš„å®¢æˆ·ç«¯å·¥å…·ï¼Œå…¶å®‰è£…ä½ç½®å’Œ iam-apiserverã€iam-authz-serverã€iam-pump ä½ç½®ä¸åŒï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ shell ä¸‹ç›´æ¥è¿è¡Œ iamctl å‘½ä»¤ï¼Œæˆ‘ä»¬éœ€è¦å°† iamctl å®‰è£…åˆ°`$HOME/bin` ä¸‹ï¼ŒåŒæ—¶å°† iamctl çš„é…ç½®å­˜æ”¾åœ¨é»˜è®¤åŠ è½½çš„ç›®å½•ä¸‹ï¼š`$HOME/.iam`ã€‚ä¸»è¦åˆ† 2 æ­¥è¿›è¡Œã€‚



**å®‰è£… iamctl å¯æ‰§è¡Œç¨‹åºï¼š**

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ make build BINS=iamctl
$ cp _output/platforms/linux/amd64/iamctl $HOME/bin
```



**ç”Ÿæˆå¹¶å®‰è£… iamctl çš„é…ç½®æ–‡ä»¶ï¼ˆiamctl.yamlï¼‰ï¼š**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iamctl.yaml> iamctl.yaml
$ mkdir -p $HOME/.iam
$ mv iamctl.yaml $HOME/.iam
```

å› ä¸º iamctl æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ï¼Œå¯èƒ½ä¼šåœ¨å¤šå°æœºå™¨ä¸Šè¿è¡Œã€‚ä¸ºäº†ç®€åŒ–éƒ¨ç½² iamctl å·¥å…·çš„å¤æ‚åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ config é…ç½®æ–‡ä»¶ä¸­è·Ÿ CA è®¤è¯ç›¸å…³çš„ CA æ–‡ä»¶å†…å®¹ç”¨ base64 åŠ å¯†åï¼Œæ”¾ç½®åœ¨ config é…ç½®æ–‡ä»¶ä¸­ã€‚å…·ä½“çš„æ€è·¯å°±æ˜¯æŠŠ config æ–‡ä»¶ä¸­çš„é…ç½®é¡¹ client-certificateã€client-keyã€certificate-authority åˆ†åˆ«ç”¨å¦‚ä¸‹é…ç½®é¡¹æ›¿æ¢ client-certificate-dataã€client-key-dataã€certificate-authority-dataã€‚è¿™äº›é…ç½®é¡¹çš„å€¼å¯ä»¥é€šè¿‡å¯¹ CA æ–‡ä»¶ä½¿ç”¨ base64 åŠ å¯†è·å¾—ã€‚

å‡å¦‚ï¼Œcertificate-authority å€¼ä¸º`/etc/iam/cert/ca.pem`ï¼Œåˆ™ certificate-authority-data çš„å€¼ä¸º `cat "/etc/iam/cert/ca.pem" | base64 | tr -d '\r\n'`ï¼Œå…¶å®ƒ-data å˜é‡çš„å€¼ç±»ä¼¼ã€‚è¿™æ ·å½“æˆ‘ä»¬å†éƒ¨ç½² iamctl å·¥å…·æ—¶ï¼Œåªéœ€è¦æ‹·è´ iamctl å’Œé…ç½®æ–‡ä»¶ï¼Œè€Œä¸ç”¨å†æ‹·è´ CA æ–‡ä»¶äº†ã€‚



#### ç¬¬ 3 æ­¥ï¼Œæµ‹è¯• iamctl æ˜¯å¦æˆåŠŸå®‰è£…ã€‚

æ‰§è¡Œ `iamctl user list` å¯ä»¥åˆ—å‡ºé¢„åˆ›å»ºçš„ admin ç”¨æˆ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20230216194553152](http://sm.nsddd.top/sm202302161945373.png)



### å®‰è£…å’Œé…ç½® iam-authz-server

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…å¦å¤–ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼šiam-authz-serverï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ 3 æ­¥æ¥å®‰è£…ã€‚

#### ç¬¬ 1 æ­¥ï¼Œåˆ›å»º iam-authz-server è¯ä¹¦å’Œç§é’¥ã€‚

**åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ï¼š**

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ tee iam-authz-server-csr.json <<EOF
{
  "CN": "iam-authz-server",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "marmotedu",
      "OU": "iam-authz-server"
    }
  ],
  "hosts": [
    "127.0.0.1",
    "localhost",
    "iam.authz.marmotedu.com"
  ]
}
EOF
```

ä»£ç ä¸­çš„ hosts å­—æ®µæŒ‡å®šæˆæƒä½¿ç”¨è¯¥è¯ä¹¦çš„ IP å’ŒåŸŸååˆ—è¡¨ï¼Œä¸Šé¢çš„ hosts åˆ—å‡ºäº† iam-authz-server æœåŠ¡çš„ IP å’ŒåŸŸåã€‚

**ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ï¼š**

```bash
$ cfssl gencert -ca=${IAM_CONFIG_DIR}/cert/ca.pem \
  -ca-key=${IAM_CONFIG_DIR}/cert/ca-key.pem \
  -config=${IAM_CONFIG_DIR}/cert/ca-config.json \
  -profile=iam iam-authz-server-csr.json | cfssljson -bare iam-authz-server
$ sudo mv iam-authz-server*pem ${IAM_CONFIG_DIR}/cert # å°†ç”Ÿæˆçš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶æ‹·è´åˆ°é…ç½®æ–‡ä»¶ç›®å½•
```



#### ç¬¬ 2 æ­¥ï¼Œå®‰è£…å¹¶è¿è¡Œ iam-authz-serverã€‚

å®‰è£… iam-authz-server æ­¥éª¤å’Œå®‰è£… iam-apiserver æ­¥éª¤åŸºæœ¬ä¸€æ ·ï¼Œä¹Ÿéœ€è¦ 4 æ­¥ã€‚

**å®‰è£… iam-authz-server å¯æ‰§è¡Œç¨‹åºï¼š**

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ make build BINS=iam-authz-server
$ sudo cp _output/platforms/linux/amd64/iam-authz-server ${IAM_INSTALL_DIR}/bin
```



**ç”Ÿæˆå¹¶å®‰è£… iam-authz-server çš„é…ç½®æ–‡ä»¶ï¼ˆiam-authz-server.yamlï¼‰ï¼š**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-authz-server.yaml > iam-authz-server.yaml
$ sudo mv iam-authz-server.yaml ${IAM_CONFIG_DIR}
```



**åˆ›å»ºå¹¶å®‰è£… iam-authz-server systemd unit æ–‡ä»¶ï¼š**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-authz-server.service > iam-authz-server.service
$ sudo mv iam-authz-server.service /etc/systemd/system/
```



**å¯åŠ¨ iam-authz-server æœåŠ¡ï¼š**

```bash
$ sudo systemctl daemon-reload
$ sudo systemctl enable iam-authz-server
$ sudo systemctl restart iam-authz-server
$ systemctl status iam-authz-server 
# æŸ¥çœ‹ iam-authz-server è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å« active (running)å­—æ ·è¯´æ˜ iam-authz-server æˆåŠŸå¯åŠ¨ã€‚
```



#### ç¬¬ 3 æ­¥ï¼Œæµ‹è¯• iam-authz-server æ˜¯å¦æˆåŠŸå®‰è£…ã€‚

**é‡æ–°ç™»é™†ç³»ç»Ÿï¼Œå¹¶è·å–è®¿é—®ä»¤ç‰Œ**

```bash
$ token=`curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login | jq -r .token`
```



**åˆ›å»ºæˆæƒç­–ç•¥:**

```bash
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.*>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies
```



**åˆ›å»ºå¯†é’¥ï¼Œå¹¶ä»å‘½ä»¤çš„è¾“å‡ºä¸­æå– secretID å’Œ secretKey**

```bash
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}' http://127.0.0.1:8080/v1/secrets
{"metadata":{"id":23,"instanceID":"secret-yj8m30","name":"authztest","createdAt":"2023-02-16T19:55:29.407+08:00","updatedAt":"2023-02-16T19:55:29.407+08:00"},"username":"admin","secretID":"Ouk0bP2SX36f5FgpGWnFZy6Tpom89VEljtUo","secretKey":"uIhkIKQ7GA7eSCIdjNYQgvRoE3d6n9bo","expires":0,"description":"admin secret"}
```



**ç”Ÿæˆè®¿é—® iam-authz-server çš„ token**

iamctl æä¾›äº† jwt sigin å‘½ä»¤ï¼Œå¯ä»¥æ ¹æ® secretID å’Œ secretKey ç­¾å‘ Tokenï¼Œæ–¹ä¾¿ä½ ä½¿ç”¨ã€‚

```bash
$ iamctl jwt sign Ouk0bP2SX36f5FgpGWnFZy6Tpom89VEljtUo uIhkIKQ7GA7eSCIdjNYQgvRoE3d6n9bo # iamctl jwt sign $secretID $secretKeyï¼Œæ›¿æ¢æˆä¸Šä¸€æ­¥åˆ›å»ºçš„å¯†é’¥å¯¹
eyJhbGciOiJIUzI1NiIsImtpZCI6Ik91azBiUDJTWDM2ZjVGZ3BHV25GWnk2VHBvbTg5VkVsanRVbyIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTY3NjU1NTg3NywiaWF0IjoxNjc2NTQ4Njc3LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2NzY1NDg2Nzd9.CdbBrm9-mErgysb5xwa0EQPboQWnXJpXOBZZk6K6M9E
```

å¦‚æœä½ çš„å¼€å‘è¿‡ç¨‹ä¸­æœ‰äº›é‡å¤æ€§çš„æ“ä½œï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å°†è¿™äº›æ“ä½œä»¥ iamctl å­å‘½ä»¤çš„æ–¹å¼é›†æˆåˆ° iamctl å‘½ä»¤è¡Œä¸­ã€‚



**æµ‹è¯•èµ„æºæˆæƒæ˜¯å¦é€šè¿‡**

æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯·æ±‚ /v1/authz æ¥å®Œæˆèµ„æºæˆæƒï¼š

```bash
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ik91azBiUDJTWDM2ZjVGZ3BHV25GWnk2VHBvbTg5VkVsanRVbyIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTY3NjU1NTg3NywiaWF0IjoxNjc2NTQ4Njc3LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2NzY1NDg2Nzd9.CdbBrm9-mErgysb5xwa0EQPboQWnXJpXOBZZk6K6M9E' -d'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIPAddress":"192.168.0.5"}}' http://127.0.0.1:9090/v1/authz
{"allowed":true}
```

å¦‚æœæˆæƒé€šè¿‡ä¼šè¿”å›ï¼š`{"allowed":true}` ã€‚



### å®‰è£…å’Œé…ç½® iam-pump

å®‰è£… iam-pump æ­¥éª¤å’Œå®‰è£… iam-apiserverã€iam-authz-server æ­¥éª¤åŸºæœ¬ä¸€æ ·ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ã€‚

**ç¬¬ 1 æ­¥ï¼Œå®‰è£… iam-pump å¯æ‰§è¡Œç¨‹åºã€‚**

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ make build BINS=iam-pump
$ sudo cp _output/platforms/linux/amd64/iam-pump ${IAM_INSTALL_DIR}/bin
```



**ç¬¬ 2 æ­¥ï¼Œç”Ÿæˆå¹¶å®‰è£… iam-pump çš„é…ç½®æ–‡ä»¶ï¼ˆiam-pump.yamlï¼‰ã€‚**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-pump.yaml > iam-pump.yaml
$ sudo mv iam-pump.yaml ${IAM_CONFIG_DIR}
```



**ç¬¬ 3 æ­¥ï¼Œåˆ›å»ºå¹¶å®‰è£… iam-pump systemd unit æ–‡ä»¶ã€‚**

```bash
$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-pump.service > iam-pump.service
$ sudo mv iam-pump.service /etc/systemd/system/
```



**ç¬¬ 4 æ­¥ï¼Œå¯åŠ¨ iam-pump æœåŠ¡ã€‚**

```bash
$ sudo systemctl daemon-reload
$ sudo systemctl enable iam-pump
$ sudo systemctl restart iam-pump
$ systemctl status iam-pump # æŸ¥çœ‹ iam-pump è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœè¾“å‡ºä¸­åŒ…å« active (running)å­—æ ·è¯´æ˜ iam-pump æˆåŠŸå¯åŠ¨ã€‚
```



**ç¬¬ 5 æ­¥ï¼Œæµ‹è¯• iam-pump æ˜¯å¦æˆåŠŸå®‰è£…ã€‚**

```bash
$ curl http://127.0.0.1:7070/healthz
{"status": "ok"}
```

ç»è¿‡ä¸Šé¢è¿™ 5 ä¸ªæ­¥éª¤ï¼Œå¦‚æœè¿”å› `{â€œstatusâ€: â€œokâ€}` å°±è¯´æ˜ iam-pump æœåŠ¡å¥åº·



### å®‰è£… man æ–‡ä»¶

IAM ç³»ç»Ÿé€šè¿‡ç»„åˆè°ƒç”¨åŒ…ï¼š[github.com/cpuguy83/go-md2man/v2/md2man]() å’Œ [github.com/spf13/cobra](https://github.com/spf13/cobra) çš„ç›¸å…³å‡½æ•°ç”Ÿæˆäº†å„ä¸ªç»„ä»¶çš„ man1 æ–‡ä»¶ï¼Œä¸»è¦åˆ† 3 æ­¥å®ç°ã€‚

**ç¬¬ 1 æ­¥ï¼Œç”Ÿæˆå„ä¸ªç»„ä»¶çš„ man1 æ–‡ä»¶ã€‚**

```bash
$ cd $IAM_ROOT
$ ./scripts/update-generated-docs.sh
```



**ç¬¬ 2 æ­¥ï¼Œå®‰è£…ç”Ÿæˆçš„ man1 æ–‡ä»¶ã€‚**

```bash
$ sudo cp docs/man/man1/* /usr/share/man/man1/
```



**ç¬¬ 3 æ­¥ï¼Œæ£€æŸ¥æ˜¯å¦æˆåŠŸå®‰è£… man1 æ–‡ä»¶ã€‚**

```bash
$ man iam-apiserver
```

> **æ‰§è¡Œ man iam-apiserver å‘½ä»¤åï¼Œä¼šå¼¹å‡º man æ–‡æ¡£ç•Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š**
>
> ![image-20230216200626281](http://sm.nsddd.top/sm202302162006542.png)



è‡³æ­¤ï¼ŒIAM ç³»ç»Ÿæ‰€æœ‰ç»„ä»¶éƒ½å·²ç»å®‰è£…æˆåŠŸäº†ï¼Œä½ å¯ä»¥é€šè¿‡ iamctl version æŸ¥çœ‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç‰ˆæœ¬ï¼Œä»£ç å¦‚ä¸‹ï¼š

```bash
$ iamctl version -o yaml
clientVersion:
  buildDate: "2023-02-16T11:43:40Z"
  compiler: gc
  gitCommit: f39d4105e563c01fb4869bbaf1b19f5afa944400
  gitTreeState: dirty
  gitVersion: f39d410
  goVersion: go1.18.3
  platform: linux/amd64
serverVersion:
  buildDate: "2023-02-16T11:18:53Z"
  compiler: gc
  gitCommit: f39d4105e563c01fb4869bbaf1b19f5afa944400
  gitTreeState: dirty
  gitVersion: f39d410
  goVersion: go1.18.3
  platform: linux/amd64
```



## ä¸€é”®å®‰è£…

**é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä¸€é”®å®‰è£…ï¼š**

```bash
$ export LINUX_PASSWORD='iam59!z$' # é‡è¦ï¼šè¿™é‡Œè¦ export going ç”¨æˆ·çš„å¯†ç 
$ version=latest && curl https://marmotedu-1254073058.cos.ap-beijing.myqcloud.com/iam-release/${version}/iam.tar.gz | tar -xz -C / tmp/       
$ cd /tmp/iam/ && ./scripts/install/install.sh iam::install::install
```





## æ€»ç»“

âš ï¸ æ‰€æœ‰ç»„ä»¶è®¾ç½®çš„å¯†ç éƒ½æ˜¯ `iam59!z$`

![image-20230216200735600](http://sm.nsddd.top/sm202302162007692.png)





## END é“¾æ¥

<ul><li><div><a href = '1.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '3.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

