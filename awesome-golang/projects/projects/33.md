+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬33èŠ‚ è½¯ä»¶éƒ¨ç½²å®æˆ˜ï¼ˆä¸­ï¼‰ï¼šIAM ç³»ç»Ÿç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®æˆ˜

<br>
<div><a href = '32.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '34.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

ä¸Šä¸€è®²ï¼Œæˆ‘ä»‹ç»äº†IAMéƒ¨ç½²ç”¨åˆ°çš„ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼ŒNginxå’ŒKeepalivedã€‚é‚£ä¹ˆè¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹ï¼Œå¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚ä¸‹ä¸€è®²ï¼Œæˆ‘å†ä»‹ç»ä¸‹IAMåº”ç”¨å®‰å…¨å’Œå¼¹æ€§ä¼¸ç¼©èƒ½åŠ›çš„æ„å»ºæ–¹å¼ã€‚

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ä¸‹é¢å››ä¸ªæ­¥éª¤æ¥éƒ¨ç½²IAMåº”ç”¨ï¼š

1. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ä¸­çš„æœåŠ¡ã€‚
2. é…ç½®Nginxï¼Œå®ç°åå‘ä»£ç†åŠŸèƒ½ã€‚é€šè¿‡åå‘ä»£ç†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Nginxæ¥è®¿é—®éƒ¨ç½²åœ¨å†…ç½‘çš„IAMæœåŠ¡ã€‚
3. é…ç½®Nginxï¼Œå®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚é€šè¿‡è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æœåŠ¡çš„æ°´å¹³æ‰©ç¼©å®¹ï¼Œä½¿IAMåº”ç”¨å…·å¤‡é«˜å¯ç”¨èƒ½åŠ›ã€‚
4. é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚é€šè¿‡Nginx + Keepalivedçš„ç»„åˆï¼Œå¯ä»¥å®ç°æ•´ä¸ªåº”ç”¨æ¶æ„çš„é«˜å¯ç”¨ã€‚



## éƒ¨ç½²IAMåº”ç”¨

éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œéœ€è¦è‡³å°‘ä¸¤ä¸ªèŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æŒ‰ç…§å…ˆåé¡ºåºï¼Œåˆ†åˆ«åœ¨`10.0.4.20`å’Œ`10.0.4.21`æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚

### åœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨

é¦–å…ˆï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•åœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨ã€‚

æˆ‘ä»¬è¦åœ¨è¿™ä¸ªæœåŠ¡å™¨ä¸Šéƒ¨ç½²å¦‚ä¸‹ç»„ä»¶ï¼š

+ iam-apiserver
+ iam-authz-server
+ iam-pump
+ MariaDB
+ Redis
+ MongoDB

è¿™äº›ç»„ä»¶çš„éƒ¨ç½²æ–¹å¼ï¼Œ[03è®²](https://time.geekbang.org/column/article/378082) æœ‰ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è®¾ç½®MariaDBï¼Œç»™æ¥è‡ªäº`10.0.4.21`æœåŠ¡å™¨çš„æ•°æ®åº“è¿æ¥æˆæƒï¼Œæˆæƒå‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ mysql -hlocalhost -P3306 -uroot -proot # å…ˆä»¥rootç”¨æˆ·ç™»é™†æ•°æ®åº“
MariaDB [(none)]> grant all on iam.* TO iam@10.0.4.21 identified by 'iam1234';
Query OK, 0 rows affected (0.000 sec)

MariaDB [(none)]> flush privileges;
Query OK, 0 rows affected (0.000 sec)
```



### åœ¨`10.0.4.21`æœåŠ¡å™¨ä¸Šéƒ¨ç½²IAMåº”ç”¨

ç„¶åï¼Œåœ¨`10.0.4.21`æœåŠ¡å™¨ä¸Šå®‰è£…å¥½iam-apiserverã€iam-authz-server å’Œ iam-pumpã€‚è¿™äº›ç»„ä»¶é€šè¿‡`10.0.4.20` IPåœ°å€ï¼Œè¿æ¥`10.0.4.20`æœåŠ¡å™¨ä¸Šçš„MariaDBã€Rediså’ŒMongoDBã€‚

## é…ç½®Nginxä½œä¸ºåå‘ä»£ç†

å‡å®šè¦è®¿é—®çš„API Serverå’ŒIAM Authorization Serverçš„åŸŸååˆ†åˆ«ä¸º`iam.api.marmotedu.com`å’Œ`iam.authz.marmotedu.com`ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®Nginxåå‘ä»£ç†ã€‚æ•´ä¸ªé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º5æ­¥ï¼ˆåœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šæ“ä½œï¼‰ã€‚

**ç¬¬ä¸€æ­¥ï¼Œé…ç½®iam-apiserverã€‚**

æ–°å»ºNginxé…ç½®æ–‡ä»¶`/etc/nginx/conf.d/iam-apiserver.conf`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```bash
server {
    listen       80;
    server_name  iam.api.marmotedu.com;
    root         /usr/share/nginx/html;
    location / {
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass  http://127.0.0.1:8080/;
      client_max_body_size 5m;
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
```

æœ‰å‡ ç‚¹ä½ åœ¨é…ç½®æ—¶éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œè¯´æ˜ä¸‹ã€‚

+ `server_name`éœ€è¦ä¸º`iam.api.marmotedu.com`ï¼Œæˆ‘ä»¬é€šè¿‡`iam.api.marmotedu.com`è®¿é—®iam-apiserverã€‚
+ iam-apiserveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º`8080`ã€‚
+ ç”±äºNginxé»˜è®¤å…è®¸å®¢æˆ·ç«¯è¯·æ±‚çš„æœ€å¤§å•æ–‡ä»¶å­—èŠ‚æ•°ä¸º`1MB`ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½å¤ªå°ï¼Œæ‰€ä»¥è¿™é‡Œå°†æ­¤é™åˆ¶æ”¹ä¸º5MBï¼ˆ`client_max_body_size 5m`ï¼‰ã€‚å¦‚æœéœ€è¦ä¸Šä¼ å›¾ç‰‡ä¹‹ç±»çš„ï¼Œå¯èƒ½éœ€è¦è®¾ç½®æˆæ›´å¤§çš„å€¼ï¼Œæ¯”å¦‚`50m`ã€‚
+ server_nameç”¨æ¥è¯´æ˜è®¿é—®NginxæœåŠ¡å™¨çš„åŸŸåï¼Œä¾‹å¦‚`curl -H 'Host: iam.api.marmotedu.com' http://x.x.x.x:80/healthz`ï¼Œ`x.x.x.x`ä¸ºNginxæœåŠ¡å™¨çš„IPåœ°å€ã€‚
+ proxy_passè¡¨ç¤ºåå‘ä»£ç†çš„è·¯å¾„ã€‚å› ä¸ºè¿™é‡Œæ˜¯æœ¬æœºçš„iam-apiserveræœåŠ¡ï¼Œæ‰€ä»¥IPä¸º`127.0.0.1`ã€‚ç«¯å£è¦å’ŒAPIæœåŠ¡ç«¯å£ä¸€è‡´ï¼Œä¸º`8080`ã€‚

æœ€åè¿˜è¦æé†’ä¸‹ï¼Œå› ä¸º Nginx é…ç½®é€‰é¡¹æ¯”è¾ƒå¤šï¼Œè·Ÿå®é™…éœ€æ±‚å’Œç¯å¢ƒæœ‰å…³ï¼Œæ‰€ä»¥è¿™é‡Œçš„é…ç½®æ˜¯åŸºç¡€çš„ã€æœªç»ä¼˜åŒ–çš„é…ç½®ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ä½ å†åšè°ƒèŠ‚ã€‚

**ç¬¬äºŒæ­¥ï¼Œé…ç½®iam-authz-serverã€‚**

æ–°å»ºNginxé…ç½®æ–‡ä»¶`/etc/nginx/conf.d/iam-authz-server.conf`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```bash
server {
    listen       80;
    server_name  iam.authz.marmotedu.com;
    root         /usr/share/nginx/html;
    location / {
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass  http://127.0.0.1:9090/;
      client_max_body_size 5m;
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
```

ä¸‹é¢æ˜¯ä¸€äº›é…ç½®è¯´æ˜ã€‚

+ server_nameéœ€è¦ä¸º`iam.authz.marmotedu.com`ï¼Œæˆ‘ä»¬é€šè¿‡`iam.authz.marmotedu.com`è®¿é—®iam-authz-serverã€‚
+ iam-authz-serveré»˜è®¤å¯åŠ¨çš„ç«¯å£ä¸º`9090`ã€‚
+ å…¶ä»–é…ç½®è·Ÿ`/etc/nginx/conf.d/iam-apiserver.conf`ä¸€è‡´ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š**

```bash
$ sudo systemctl restart nginx
```

**ç¬¬å››æ­¥ï¼Œåœ¨/etc/hostsä¸­è¿½åŠ ä¸‹é¢ä¸¤è¡Œï¼š**

```bash
127.0.0.1 iam.api.marmotedu.com
127.0.0.1 iam.authz.marmotedu.com
```

**ç¬¬äº”æ­¥ï¼Œå‘é€HTTPè¯·æ±‚ï¼š**

```bash
$ curl http://iam.api.marmotedu.com/healthz
{"status":"ok"}
$ curl http://iam.authz.marmotedu.com/healthz
{"status":"ok"}
```

æˆ‘ä»¬åˆ†åˆ«è¯·æ±‚iam-apiserverå’Œiam-authz-serverçš„å¥åº·æ£€æŸ¥æ¥å£ï¼Œè¾“å‡ºäº†`{"status":"ok"}`ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡ä»£ç†è®¿é—®åç«¯çš„APIæœåŠ¡ã€‚

åœ¨ç”¨curlè¯·æ±‚`http://iam.api.marmotedu.com/healthz`åï¼Œåç«¯çš„è¯·æ±‚æµç¨‹å®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š

1. å› ä¸ºåœ¨`/etc/hosts`ä¸­é…ç½®äº†`127.0.0.1 iam.api.marmotedu.com`ï¼Œæ‰€ä»¥è¯·æ±‚`http://iam.api.marmotedu.com/healthz`å®é™…ä¸Šæ˜¯è¯·æ±‚æœ¬æœºçš„Nginxç«¯å£ï¼ˆ`127.0.0.1:80`ï¼‰ã€‚
2. Nginxåœ¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šè§£æè¯·æ±‚ï¼Œå¾—åˆ°è¯·æ±‚åŸŸåä¸º`iam.api.marmotedu.com`ã€‚æ ¹æ®è¯·æ±‚åŸŸåå»åŒ¹é… Nginxçš„serveré…ç½®ï¼ŒåŒ¹é…åˆ°`server_name iam.api.marmotedu.com;`é…ç½®ã€‚
3. åŒ¹é…åˆ°serveråï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°è¯¥serverçš„`proxy_pass`è·¯å¾„ã€‚
4. ç­‰å¾…APIæœåŠ¡å™¨è¿”å›ç»“æœï¼Œå¹¶è¿”å›å®¢æˆ·ç«¯ã€‚



## é…ç½®Nginxä½œä¸ºè´Ÿè½½å‡è¡¡

è¿™é—¨è¯¾é‡‡ç”¨Nginxè½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥è½¬å‘è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡éœ€è¦è‡³å°‘ä¸¤å°æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¼šåˆ†åˆ«åœ¨`10.0.4.20`å’Œ`10.0.4.21`æœåŠ¡å™¨ä¸Šæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚ä¸‹é¢æˆ‘åˆ†åˆ«æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®è¿™ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶éªŒè¯é…ç½®æ˜¯å¦æˆåŠŸã€‚

### `10.0.4.20`æœåŠ¡å™¨é…ç½®

ç™»é™†`10.0.4.20`æœåŠ¡å™¨ï¼Œåœ¨`/etc/nginx/nginx.conf`ä¸­æ·»åŠ upstreamé…ç½®ï¼Œé…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸º3æ­¥ã€‚

**ç¬¬ä¸€æ­¥ï¼Œåœ¨**`/etc/nginx/nginx.conf`**ä¸­æ·»åŠ upstreamï¼š**

```bash
http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;
    upstream iam.api.marmotedu.com {
        server 127.0.0.1:8080
        server 10.0.4.21:8080
    }
    upstream iam.authz.marmotedu.com {
        server 127.0.0.1:9090
        server 10.0.4.21:9090
    }
}
```

*é…ç½®è¯´æ˜ï¼š*

+ upstreamæ˜¯é…ç½®åœ¨`/etc/nginx/nginx.conf`æ–‡ä»¶ä¸­çš„`http{ â€¦ }`éƒ¨åˆ†çš„ã€‚
+ å› ä¸ºæˆ‘ä»¬è¦åˆ†åˆ«ä¸ºiam-apiserverå’Œiam-authz-serveré…ç½®è´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªupstreamï¼Œåˆ†åˆ«æ˜¯`iam.api.marmotedu.com`å’Œ`iam.authz.marmotedu.com`ã€‚ä¸ºäº†ä¾¿äºè¯†åˆ«ï¼Œupstreamåç§°å’ŒåŸŸåæœ€å¥½ä¿æŒä¸€è‡´ã€‚
+ åœ¨upstreamä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ†åˆ«æ·»åŠ æ‰€æœ‰çš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼ˆ`ip:port`ï¼‰ï¼Œæœ¬æœºçš„åç«¯ä¸ºäº†è®¿é—®æ›´å¿«ï¼Œå¯ä»¥ä½¿ç”¨`127.0.0.1:<port>`ï¼Œå…¶ä»–æœºå™¨çš„åç«¯ï¼Œéœ€è¦ä½¿ç”¨`<å†…ç½‘>:port`ï¼Œä¾‹å¦‚`10.0.4.21:8080`ã€`10.0.4.21:9090`ã€‚

**ç¬¬äºŒæ­¥ï¼Œä¿®æ”¹proxy_passã€‚**

ä¿®æ”¹`/etc/nginx/conf.d/iam-apiserver.conf`æ–‡ä»¶ï¼Œå°†`proxy_pass`ä¿®æ”¹ä¸ºï¼š

```
proxy_pass http://iam.api.marmotedu.com/;
```

ä¿®æ”¹`/etc/nginx/conf.d/iam-authz-server.conf`æ–‡ä»¶ï¼Œå°†`proxy_pass`ä¿®æ”¹ä¸ºï¼š

```
proxy_pass http://iam.authz.marmotedu.com/;
```

å½“Nginxè½¬å‘åˆ°`http://iam.api.marmotedu.com/`åŸŸåæ—¶ï¼Œä¼šä»`iam.api.marmotedu.com` upstreamé…ç½®çš„åç«¯åˆ—è¡¨ä¸­ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰å–ä¸€ä¸ªåç«¯ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘è¿‡å»ã€‚è½¬å‘`http://iam.authz.marmotedu.com/`åŸŸåçš„é€»è¾‘ä¹Ÿä¸€æ ·ã€‚

**ç¬¬ä¸‰æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š**

```
$ sudo systemctl restart nginx
```

æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨[configs/ha/10.0.4.20](https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.20)ç›®å½•ä¸‹ï¼‰ï¼š

+ nginx.confï¼š[configs/ha/10.0.4.20/nginx.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/nginx.conf)ã€‚
+ iam-apiserver.confï¼š[configs/ha/10.0.4.20/iam-apiserver.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-apiserver.conf)ã€‚
+ iam-authz-server.confï¼š[configs/ha/10.0.4.20/iam-authz-server.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-authz-server.conf)ã€‚



### `10.0.4.21`æœåŠ¡å™¨é…ç½®

ç™»é™†`10.0.4.21`æœåŠ¡å™¨ï¼Œåœ¨`/etc/nginx/nginx.conf`ä¸­æ·»åŠ upstreamé…ç½®ã€‚é…ç½®è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ã€‚

**ç¬¬ä¸€æ­¥ï¼Œåœ¨**`/etc/nginx/nginx.conf`**ä¸­æ·»åŠ upstreamï¼š**

```bash

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include /etc/nginx/conf.d/*.conf;
    upstream iam.api.marmotedu.com {
        server 127.0.0.1:8080
        server 10.0.4.20:8080
    }
    upstream iam.authz.marmotedu.com {
        server 127.0.0.1:9090
        server 10.0.4.20:9090
    }
}
```

upstreamä¸­ï¼Œéœ€è¦é…ç½®`10.0.4.20`æœåŠ¡å™¨ä¸Šçš„iam-apiserverå’Œiam-authz-serverçš„åç«¯ï¼Œä¾‹å¦‚`10.0.4.20:8080`ã€`10.0.4.20:9090`ã€‚

**ç¬¬äºŒæ­¥ï¼Œåˆ›å»º**`/etc/nginx/conf.d/iam-apiserver.conf`**æ–‡ä»¶**ï¼ˆiam-apiserverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```bash
server {
    listen       80;
    server_name  iam.api.marmotedu.com;
    root         /usr/share/nginx/html;
    location / {
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass  http://iam.api.marmotedu.com/;
      client_max_body_size 5m;
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}
```

**ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»º**`/etc/nginx/conf.d/iam-authz-server`**æ–‡ä»¶**ï¼ˆiam-authz-serverçš„åå‘ä»£ç†+è´Ÿè½½å‡è¡¡é…ç½®ï¼‰ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```bash
server {
    listen       80;
    server_name  iam.authz.marmotedu.com;
    root         /usr/share/nginx/html;
    location / {
      proxy_set_header X-Forwarded-Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass  http://iam.authz.marmotedu.com/;
      client_max_body_size 5m;
    }

    error_page 404 /404.html;
        location = /40x.html {
    }

    error_page 500 502 503 504 /50x.html;
        location = /50x.html {
    }
}

```

**ç¬¬å››æ­¥ï¼Œé…ç½®å®ŒNginxåï¼Œé‡å¯Nginxï¼š**

```bash
$ sudo systemctl restart nginx
```

æœ€ç»ˆé…ç½®å¥½çš„é…ç½®æ–‡ä»¶ï¼Œä½ å¯ä»¥å‚è€ƒä¸‹é¢è¿™äº›ï¼ˆä¿å­˜åœ¨[configs/ha/10.0.4.21](https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.21)ç›®å½•ä¸‹ï¼‰ï¼š

+ nginx.confï¼š[configs/ha/10.0.4.21/nginx.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/nginx.conf)ã€‚
+ iam-apiserver.confï¼š[configs/ha/10.0.4.21/iam-apiserver.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-apiserver.conf)ã€‚
+ iam-authz-server.confï¼š[configs/ha/10.0.4.21/iam-authz-server.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-authz-server.conf)ã€‚



### æµ‹è¯•è´Ÿè½½å‡è¡¡

ä¸Šé¢ï¼Œæˆ‘ä»¬é…ç½®äº†Nginxè´Ÿè½½å‡è¡¡å™¨ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ä¸‹æ˜¯å¦é…ç½®æˆåŠŸã€‚

**ç¬¬ä¸€æ­¥ï¼Œæ‰§è¡Œæµ‹è¯•è„šæœ¬ï¼ˆ**[test/nginx/loadbalance.sh](https://github.com/marmotedu/iam/blob/v1.0.8/test/nginx/loadbalance.sh)**ï¼‰ï¼š**

```bash
#!/usr/bin/env bash

for domain in iam.api.marmotedu.com iam.authz.marmotedu.com
do
  for n in $(seq 1 1 10)
  do
    echo $domain
    nohup curl http://${domain}/healthz &>/dev/null &
  done
done
```

**ç¬¬äºŒæ­¥ï¼Œåˆ†åˆ«æŸ¥çœ‹iam-apiserverå’Œiam-authz-serverçš„æ—¥å¿—ã€‚**

è¿™é‡Œæˆ‘å±•ç¤ºä¸‹iam-apiserverçš„æ—¥å¿—ï¼ˆiam-authz-serverçš„æ—¥å¿—ä½ å¯è‡ªè¡ŒæŸ¥çœ‹ï¼‰ã€‚

`10.0.4.20`æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/58/26/58d072c92552fa3068e3ef3acd0ed726.png?wh=1920x498)

`10.0.4.21`æœåŠ¡å™¨çš„iam-apiserveræ—¥å¿—å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](https://static001.geekbang.org/resource/image/19/85/199066c65ff60007f80f3c2dyy11c785.png?wh=1920x482)

é€šè¿‡ä¸Šé¢ä¸¤å¼ å›¾ï¼Œä½ å¯ä»¥çœ‹åˆ°`10.0.4.20`å’Œ`10.0.4.21`å„æ”¶åˆ°`5`ä¸ª`/healthz`è¯·æ±‚ï¼Œè¯´æ˜è´Ÿè½½å‡è¡¡é…ç½®æˆåŠŸã€‚



## é…ç½®Keepalived

åœ¨ [40è®²](https://time.geekbang.org/column/article/411663)ï¼Œæˆ‘ä»¬åˆ†åˆ«åœ¨`10.0.4.20`å’Œ`10.0.4.21`æœåŠ¡å™¨ä¸Šå®‰è£…äº†Keepalivedã€‚è¿™é‡Œï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•é…ç½®Keepalivedï¼Œå®ç°Nginxçš„é«˜å¯ç”¨ã€‚ä¸ºäº†é¿å…æ•…éšœæ¢å¤æ—¶ï¼ŒVIPåˆ‡æ¢é€ æˆçš„æœåŠ¡å»¶æ—¶ï¼Œè¿™ä¸€è®²é‡‡ç”¨Keepalivedçš„éæŠ¢å æ¨¡å¼ã€‚

é…ç½®Keepalivedçš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œåˆ†ä¸ºåˆ›å»ºè…¾è®¯äº‘HAVIPã€ä¸»æœåŠ¡å™¨é…ç½®ã€å¤‡æœåŠ¡å™¨é…ç½®ã€æµ‹è¯•Keepalivedã€VIPç»‘å®šå…¬ç½‘IPå’Œæµ‹è¯•å…¬ç½‘è®¿é—®å…­å¤§æ­¥ï¼Œæ¯ä¸€æ­¥ä¸­éƒ½æœ‰å¾ˆå¤šå°æ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥åœ°çœ‹ä¸‹ã€‚

### **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè…¾è®¯äº‘HAVIP**

å…¬æœ‰äº‘å‚å•†çš„æ™®é€šå†…ç½‘IPï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼ˆå¦‚é¿å…ARPæ¬ºéª—ç­‰ï¼‰ï¼Œä¸æ”¯æŒä¸»æœºé€šè¿‡ARPå®£å‘ŠIP ã€‚å¦‚æœç”¨æˆ·ç›´æ¥åœ¨`keepalived.conf`æ–‡ä»¶ä¸­æŒ‡å®šä¸€ä¸ªæ™®é€šå†…ç½‘IPä¸ºvirtual IPï¼Œå½“Keepalivedå°†virtual IPä»MASTERæœºå™¨åˆ‡æ¢åˆ°BACKUPæœºå™¨æ—¶ï¼Œå°†æ— æ³•æ›´æ–°IPå’ŒMACåœ°å€çš„æ˜ å°„ï¼Œè€Œéœ€è¦è°ƒAPIæ¥è¿›è¡ŒIPåˆ‡æ¢ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„VIPéœ€è¦ç”³è¯·è…¾è®¯äº‘çš„HAVIPã€‚

ç”³è¯·çš„æµç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢4æ­¥ï¼š

1. ç™»å½•ç§æœ‰ç½‘ç»œæ§åˆ¶å°**ã€‚**
2. åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘>ã€é«˜å¯ç”¨è™šæ‹ŸIPã€‘ã€‚
3. åœ¨HAVIPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚
4. åœ¨å¼¹å‡ºçš„ã€ç”³è¯·é«˜å¯ç”¨è™šæ‹ŸIPã€‘å¯¹è¯æ¡†ä¸­è¾“å…¥åç§°ï¼Œé€‰æ‹©HAVIPæ‰€åœ¨çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ç­‰ä¿¡æ¯ï¼Œå•å‡»ã€ç¡®å®šã€‘å³å¯ã€‚

è¿™é‡Œé€‰æ‹©çš„ç§æœ‰ç½‘ç»œå’Œå­ç½‘ï¼Œéœ€è¦å’Œ`10.0.4.20`ã€`10.0.4.21`ç›¸åŒã€‚HAVIP çš„ IP åœ°å€å¯ä»¥è‡ªåŠ¨åˆ†é…ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å¡«å†™ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨å¡«å†™ä¸º10.0.4.99ã€‚ç”³è¯·é¡µé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016)](https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016)

### ç¬¬äºŒæ­¥ï¼šä¸»æœåŠ¡å™¨é…ç½®

è¿›è¡Œä¸»æœåŠ¡å™¨é…ç½®ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤æ­¥ã€‚

**é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚**

ç™»é™†æœåŠ¡å™¨`10.0.4.20`ï¼Œç¼–è¾‘`/etc/keepalived/keepalived.conf`ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š[configs/ha/10.0.4.20/keepalived.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/keepalived.conf)ï¼‰ï¼š

```bash
# å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹
global_defs {
# æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email
# å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶
  notification_email {
    acassen@firewall.loc
  }
  notification_email_from Alexandre.Cassen@firewall.loc # å‘é€emailæ—¶é‚®ä»¶æºåœ°å€
    smtp_server 192.168.200.1 # å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€
    smtp_connect_timeout 30 # è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´
    router_id VM-4-20-centos # æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname
    vrrp_skip_check_adv_addr # å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥
    vrrp_garp_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0
    vrrp_gna_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0
}
# æ£€æµ‹è„šæœ¬é…ç½®
vrrp_script checkhaproxy
{
  script "/etc/keepalived/check_nginx.sh" # æ£€æµ‹è„šæœ¬è·¯å¾„
    interval 5 # æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    weight 0 # æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§
}
# VRRPå®ä¾‹é…ç½®
vrrp_instance VI_1 {
  state BACKUP  # è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'
    interface eth0 # è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0
    virtual_router_id 51  # é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼
    nopreempt               # è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š
    priority 100 # è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster
    advert_int 1 # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’
# éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´
    authentication {
      auth_type PASS # è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼
        auth_pass 1111 # è®¤è¯å¯†ç 
    }
  unicast_src_ip 10.0.4.20  # è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€
    unicast_peer {
      10.0.4.21             # å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€
    }
# VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤
  virtual_ipaddress {
    10.0.4.99 # è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚
  }
  notify_master "/etc/keepalived/keepalived_notify.sh MASTER" # å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_backup "/etc/keepalived/keepalived_notify.sh BACKUP" # å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_fault "/etc/keepalived/keepalived_notify.sh FAULT" # å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_stop "/etc/keepalived/keepalived_notify.sh STOP" # å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    garp_master_delay 1    # è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜
    garp_master_refresh 5   # è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”
    # è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€
    track_interface {
      eth0
    }
  # è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬
  track_script {
    checkhaproxy
  }
}
```

è¿™é‡Œæœ‰å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š

+ ç¡®ä¿å·²ç»é…ç½®äº†garpç›¸å…³å‚æ•°ã€‚å› ä¸ºKeepalivedä¾èµ–ARPæŠ¥æ–‡æ›´æ–°IPä¿¡æ¯ï¼Œå¦‚æœç¼ºå°‘è¿™äº›å‚æ•°ï¼Œä¼šå¯¼è‡´æŸäº›åœºæ™¯ä¸‹ä¸»è®¾å¤‡ä¸å‘é€ARPï¼Œè¿›è€Œå¯¼è‡´é€šä¿¡å¼‚å¸¸ã€‚garpç›¸å…³å‚æ•°é…ç½®å¦‚ä¸‹ï¼š

```bash
garp_master_delay 1
garp_master_refresh 5
```

+ ç¡®å®šæ²¡æœ‰é‡‡ç”¨ strict æ¨¡å¼ï¼Œå³éœ€è¦åˆ é™¤vrrp_stricté…ç½®ã€‚
+ é…ç½®ä¸­çš„`/etc/keepalived/check_nginx.sh`å’Œ`/etc/keepalived/keepalived_notify.sh`è„šæœ¬æ–‡ä»¶ï¼Œå¯åˆ†åˆ«æ‹·è´è‡ª[scripts/check_nginx.sh](https://github.com/marmotedu/iam/blob/v1.0.8/scripts/check_nginx.sh)å’Œ[scripts/keepalived_notify.sh](https://github.com/marmotedu/iam/blob/v1.0.8/scripts/keepalived_notify.sh)ã€‚

**ç„¶åï¼Œé‡å¯Keepalivedï¼š**

```bash
$ sudo systemctl restart keepalived
```



### ç¬¬ä¸‰æ­¥ï¼šå¤‡æœåŠ¡å™¨é…ç½®

è¿›è¡Œå¤‡æœåŠ¡å™¨é…ç½®ä¹Ÿåˆ†ä¸ºä¸¤æ­¥ã€‚

**é¦–å…ˆï¼Œä¿®æ”¹Keepalivedé…ç½®æ–‡ä»¶ã€‚**

ç™»é™†æœåŠ¡å™¨`10.0.4.21`ï¼Œç¼–è¾‘`/etc/keepalived/keepalived.conf`ï¼Œä¿®æ”¹é…ç½®ï¼Œä¿®æ”¹åé…ç½®å†…å®¹å¦‚ä¸‹ï¼ˆå‚è€ƒï¼š[configs/ha/10.0.4.21/keepalived.conf](https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/keepalived.conf)ï¼‰ï¼š

```bash
# å…¨å±€å®šä¹‰ï¼Œå®šä¹‰å…¨å±€çš„é…ç½®é€‰é¡¹
global_defs {
# æŒ‡å®škeepalivedåœ¨å‘ç”Ÿåˆ‡æ¢æ“ä½œæ—¶å‘é€emailï¼Œå‘é€ç»™å“ªäº›email
# å»ºè®®åœ¨keepalived_notify.shä¸­å‘é€é‚®ä»¶
  notification_email {
    acassen@firewall.loc
  }
  notification_email_from Alexandre.Cassen@firewall.loc # å‘é€emailæ—¶é‚®ä»¶æºåœ°å€
    smtp_server 192.168.200.1 # å‘é€emailæ—¶smtpæœåŠ¡å™¨åœ°å€
    smtp_connect_timeout 30 # è¿æ¥smtpçš„è¶…æ—¶æ—¶é—´
    router_id VM-4-21-centos # æœºå™¨æ ‡è¯†ï¼Œé€šå¸¸å¯ä»¥è®¾ç½®ä¸ºhostname
    vrrp_skip_check_adv_addr # å¦‚æœæ¥æ”¶åˆ°çš„æŠ¥æ–‡å’Œä¸Šä¸€ä¸ªæŠ¥æ–‡æ¥è‡ªåŒä¸€ä¸ªè·¯ç”±å™¨ï¼Œåˆ™ä¸æ‰§è¡Œæ£€æŸ¥ã€‚é»˜è®¤æ˜¯è·³è¿‡æ£€æŸ¥
    vrrp_garp_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„gratuitous arpæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0
    vrrp_gna_interval 0 # å•ä½ç§’ï¼Œåœ¨ä¸€ä¸ªç½‘å¡ä¸Šæ¯ç»„naæ¶ˆæ¯ä¹‹é—´çš„å»¶è¿Ÿæ—¶é—´ï¼Œé»˜è®¤ä¸º0
}
# æ£€æµ‹è„šæœ¬é…ç½®
vrrp_script checkhaproxy
{
  script "/etc/keepalived/check_nginx.sh" # æ£€æµ‹è„šæœ¬è·¯å¾„
    interval 5 # æ£€æµ‹æ—¶é—´é—´éš”ï¼ˆç§’ï¼‰
    weight 0 # æ ¹æ®è¯¥æƒé‡æ”¹å˜priorityï¼Œå½“å€¼ä¸º0æ—¶ï¼Œä¸æ”¹å˜å®ä¾‹çš„ä¼˜å…ˆçº§
}
# VRRPå®ä¾‹é…ç½®
vrrp_instance VI_1 {
  state BACKUP  # è®¾ç½®åˆå§‹çŠ¶æ€ä¸º'å¤‡ä»½'
    interface eth0 # è®¾ç½®ç»‘å®šVIPçš„ç½‘å¡ï¼Œä¾‹å¦‚eth0
    virtual_router_id 51  # é…ç½®é›†ç¾¤VRIDï¼Œäº’ä¸ºä¸»å¤‡çš„VRIDéœ€è¦æ˜¯ç›¸åŒçš„å€¼
    nopreempt               # è®¾ç½®éæŠ¢å æ¨¡å¼ï¼Œåªèƒ½è®¾ç½®åœ¨stateä¸ºbackupçš„èŠ‚ç‚¹ä¸Š
    priority 50 # è®¾ç½®ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€é«˜çš„ä¸ºmaster
    advert_int 1 # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’
# éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´
    authentication {
      auth_type PASS # è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ˜¯PASSæˆ–AHä¸¤ç§è®¤è¯æ–¹å¼
        auth_pass 1111 # è®¤è¯å¯†ç 
    }
  unicast_src_ip 10.0.4.21  # è®¾ç½®æœ¬æœºå†…ç½‘IPåœ°å€
    unicast_peer {
      10.0.4.20             # å¯¹ç«¯è®¾å¤‡çš„IPåœ°å€
    }
# VIPï¼Œå½“stateä¸ºmasteræ—¶æ·»åŠ ï¼Œå½“stateä¸ºbackupæ—¶åˆ é™¤
  virtual_ipaddress {
    10.0.4.99 # è®¾ç½®é«˜å¯ç”¨è™šæ‹ŸVIPï¼Œå¦‚æœæ˜¯è…¾è®¯äº‘çš„CVMï¼Œéœ€è¦å¡«å†™æ§åˆ¶å°ç”³è¯·åˆ°çš„HAVIPåœ°å€ã€‚
  }
  notify_master "/etc/keepalived/keepalived_notify.sh MASTER" # å½“åˆ‡æ¢åˆ°masterçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_backup "/etc/keepalived/keepalived_notify.sh BACKUP" # å½“åˆ‡æ¢åˆ°backupçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_fault "/etc/keepalived/keepalived_notify.sh FAULT" # å½“åˆ‡æ¢åˆ°faultçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    notify_stop "/etc/keepalived/keepalived_notify.sh STOP" # å½“åˆ‡æ¢åˆ°stopçŠ¶æ€æ—¶æ‰§è¡Œè„šæœ¬
    garp_master_delay 1    # è®¾ç½®å½“åˆ‡ä¸ºä¸»çŠ¶æ€åå¤šä¹…æ›´æ–°ARPç¼“å­˜
    garp_master_refresh 5   # è®¾ç½®ä¸»èŠ‚ç‚¹å‘é€ARPæŠ¥æ–‡çš„æ—¶é—´é—´éš”
    # è·Ÿè¸ªæ¥å£ï¼Œé‡Œé¢ä»»æ„ä¸€å—ç½‘å¡å‡ºç°é—®é¢˜ï¼Œéƒ½ä¼šè¿›å…¥æ•…éšœ(FAULT)çŠ¶æ€
    track_interface {
      eth0
    }
  # è¦æ‰§è¡Œçš„æ£€æŸ¥è„šæœ¬
  track_script {
    checkhaproxy
  }
}
```

**ç„¶åï¼Œé‡å¯Keepalivedï¼š**

```bash
$ sudo systemctl restart keepalived
```



### ç¬¬å››æ­¥ï¼šæµ‹è¯•Keepalived

ä¸Šé¢çš„é…ç½®ä¸­ï¼Œ`10.0.4.20`çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹`10.0.4.20`å°†è¢«é€‰æ‹©ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500)](https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¨¡æ‹Ÿä¸€äº›æ•…éšœåœºæ™¯ï¼Œæ¥çœ‹ä¸‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚

**åœºæ™¯1ï¼šKeepalivedæ•…éšœ**

åœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šæ‰§è¡Œ`sudo systemctl stop keepalived`æ¨¡æ‹ŸKeepalivedæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)

å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»`10.0.4.20`æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†`10.0.4.21`æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹`/var/log/keepalived.log`ï¼Œå¯ä»¥çœ‹åˆ°`10.0.4.20`æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š

```plain
[2020-10-14 14:01:51] notify_stop
```

`10.0.4.21`æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š

```plain
[2020-10-14 14:01:52] notify_master
```

**åœºæ™¯2ï¼šNginxæ•…éšœ**

åœ¨`10.0.4.20`å’Œ`10.0.4.21`æœåŠ¡å™¨ä¸Šåˆ†åˆ«æ‰§è¡Œ`sudo systemctl restart keepalived`ï¼Œè®©VIPæ¼‚ç§»åˆ°`10.0.4.20`æœåŠ¡å™¨ä¸Šã€‚

åœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šï¼Œæ‰§è¡Œ `sudo systemctl stop nginx` æ¨¡æ‹ŸNginxæ•…éšœï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)

å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»`10.0.4.20`æœåŠ¡å™¨ä¸Šï¼Œæ¼‚ç§»åˆ°äº†`10.0.4.21`æœåŠ¡å™¨ä¸Šã€‚æŸ¥çœ‹`/var/log/keepalived.log`ï¼Œå¯ä»¥çœ‹åˆ°`10.0.4.20`æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š

```plain
[2020-10-14 14:02:34] notify_fault
```

`10.0.4.21` æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹æ—¥å¿—ï¼š

```plain
[2020-10-14 14:02:35] notify_master
```

**åœºæ™¯3ï¼šNginxæ¢å¤**

åŸºäº**åœºæ™¯2**ï¼Œåœ¨`10.0.4.20`æœåŠ¡å™¨ä¸Šæ‰§è¡Œ`sudo systemctl start nginx`æ¢å¤Nginxï¼ŒæŸ¥çœ‹VIPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)](https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544)

å¯ä»¥çœ‹åˆ°ï¼ŒVIPä»ç„¶åœ¨`10.0.4.21`æœåŠ¡å™¨ä¸Šï¼Œæ²¡æœ‰è¢«`10.0.4.20`æŠ¢å ã€‚æŸ¥çœ‹`/var/log/keepalived.log`ï¼Œå¯ä»¥çœ‹åˆ°`10.0.4.20`æœåŠ¡å™¨æ–°å¢å¦‚ä¸‹ä¸€è¡Œæ—¥å¿—ï¼š

```plain
[2020-10-14 14:03:44] notify_backup
```

`10.0.4.21`æœåŠ¡å™¨æ²¡æœ‰æ–°å¢æ—¥å¿—ã€‚

### ç¬¬äº”æ­¥ï¼šVIPç»‘å®šå…¬ç½‘IP

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸé…ç½®äº†Keepalived + Nginxçš„é«˜å¯ç”¨æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çš„VIPæ˜¯å†…ç½‘ï¼Œè¿˜ä¸èƒ½é€šè¿‡å¤–ç½‘è®¿é—®ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†VIPç»‘å®šä¸€ä¸ªå¤–ç½‘IPï¼Œä¾›å¤–ç½‘è®¿é—®ã€‚åœ¨è…¾è®¯äº‘ä¸Šï¼Œå¯é€šè¿‡ç»‘å®šå¼¹æ€§å…¬ç½‘IPæ¥å®ç°å¤–ç½‘è®¿é—®ï¼Œéœ€è¦å…ˆç”³è¯·å…¬ç½‘IPï¼Œç„¶åå°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPã€‚ä¸‹é¢æˆ‘æ¥è®²è®²å…·ä½“æ­¥éª¤ã€‚

ç”³è¯·å…¬ç½‘IPï¼š

1. ç™»å½•**ç§æœ‰ç½‘ç»œæ§åˆ¶å°ã€‚**
2. åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘>ã€å¼¹æ€§å…¬ç½‘IPã€‘ã€‚
3. åœ¨å¼¹æ€§å…¬ç½‘IPç®¡ç†é¡µé¢ï¼Œé€‰æ‹©æ‰€åœ¨åœ°åŸŸï¼Œå•å‡»ã€ç”³è¯·ã€‘ã€‚

å°†VIPç»‘å®šå¼¹æ€§å…¬ç½‘IPï¼š

1. ç™»å½•**ç§æœ‰ç½‘ç»œæ§åˆ¶å°**ã€‚
2. åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œé€‰æ‹©ã€IPä¸ç½‘å¡ã€‘>ã€é«˜å¯ç”¨è™šæ‹Ÿã€‘ã€‚
3. å•å‡»éœ€è¦ç»‘å®šçš„HAVIPæ‰€åœ¨è¡Œçš„ã€ç»‘å®šã€‘ã€‚
4. åœ¨å¼¹å‡ºç•Œé¢ä¸­ï¼Œé€‰æ‹©éœ€è¦ç»‘å®šçš„å…¬ç½‘IPå³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666)](https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666)

ç»‘å®šçš„å¼¹æ€§å…¬ç½‘IPæ˜¯`106.52.252.139`ã€‚

è¿™é‡Œæç¤ºä¸‹ï¼Œè…¾è®¯äº‘å¹³å°ä¸­ï¼Œå¦‚æœHAVIPæ²¡æœ‰ç»‘å®šå®ä¾‹ï¼Œç»‘å®šHAVIPçš„EIPä¼šå¤„äºé—²ç½®çŠ¶æ€ï¼ŒæŒ‰`Â¥0.2/å°æ—¶` æ”¶å–é—²ç½®è´¹ç”¨ã€‚æ‰€ä»¥ï¼Œä½ éœ€è¦æ­£ç¡®é…ç½®é«˜å¯ç”¨åº”ç”¨ï¼Œç¡®ä¿ç»‘å®šæˆåŠŸã€‚

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•å…¬ç½‘è®¿é—®

æœ€åï¼Œä½ å¯ä»¥é€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥æµ‹è¯•ï¼š

```bash
$ curl -H"Host: iam.api.marmotedu.com" http://106.52.252.139/healthz -H"iam.api.marmotedu.com"
{"status":"ok"}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥æˆåŠŸé€šè¿‡å…¬ç½‘è®¿é—®åç«¯çš„é«˜å¯ç”¨æœåŠ¡ã€‚åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æˆåŠŸéƒ¨ç½²äº†ä¸€ä¸ªå¯ç”¨æ€§å¾ˆé«˜çš„IAMåº”ç”¨ã€‚



## æ€»ç»“

ä»Šå¤©ï¼Œæˆ‘ä¸»è¦è®²äº†å¦‚ä½•ä½¿ç”¨Nginxå’ŒKeepalivedï¼Œæ¥éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ã€‚

ä¸ºäº†éƒ¨ç½²ä¸€ä¸ªé«˜å¯ç”¨çš„IAMåº”ç”¨ï¼Œæˆ‘ä»¬è‡³å°‘éœ€è¦ä¸¤å°æœåŠ¡å™¨ï¼Œå¹¶ä¸”éƒ¨ç½²ç›¸åŒçš„æœåŠ¡iam-apiserverã€iam-authz-serverã€iam-pumpã€‚è€Œä¸”ï¼Œé€‰æ‹©å…¶ä¸­ä¸€å°æœåŠ¡å™¨éƒ¨ç½²æ•°æ®åº“æœåŠ¡ï¼šMariaDBã€Redisã€MongoDBã€‚

ä¸ºäº†å®‰å…¨å’Œæ€§èƒ½ï¼Œiam-apiserverã€iam-authz-serverã€iam-pumpæœåŠ¡éƒ½æ˜¯é€šè¿‡å†…ç½‘æ¥è®¿é—®æ•°æ®åº“æœåŠ¡çš„ã€‚è¿™ä¸€è®²ï¼Œæˆ‘è¿˜ä»‹ç»äº†å¦‚ä½•é…ç½®Nginxæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå¦‚ä½•é…ç½®Keepalivedæ¥å®ç°Nginxçš„é«˜å¯ç”¨ã€‚



## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸‹ï¼Œå½“å‰éƒ¨ç½²æ¶æ„ä¸‹å¦‚æœiam-apiserveréœ€è¦æ‰©å®¹ï¼Œå¯ä»¥æ€ä¹ˆæ‰©å®¹ï¼Ÿ
2. æ€è€ƒä¸‹ï¼Œå½“VIPåˆ‡æ¢æ—¶ï¼Œå¦‚ä½•å®ç°å‘Šè­¦åŠŸèƒ½ï¼Œç»™ç³»ç»Ÿè¿ç»´äººå‘˜å‘Šè­¦ï¼Ÿ



## END é“¾æ¥
<ul><li><div><a href = '32.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '34.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

