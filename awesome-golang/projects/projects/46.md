+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬46èŠ‚ IAMæ’éšœæŒ‡å—

<br>

<div><a href = '45.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '47.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

ä»Šå¤©æˆ‘ä»¬æ›´æ–°ä¸€æœŸç‰¹åˆ«æ”¾é€ä½œä¸ºåŠ é¤ã€‚åœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMçš„è¿‡ç¨‹ä¸­ï¼Œéš¾å…ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸(ä¹Ÿç§°ä¸ºæ•…éšœã€é—®é¢˜)ã€‚è¿™æ—¶å€™ï¼Œå°±éœ€è¦æˆ‘ä»¬èƒ½å¤Ÿå®šä½æ•…éšœï¼Œå¹¶ä¿®å¤æ•…éšœã€‚è¿™é‡Œï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›IAMçš„æ’éšœæ–¹æ³•ï¼Œä»¥åŠä¸€äº›å¸¸è§æ•…éšœçš„è§£å†³æ–¹æ³•ï¼Œä¾›ä½ å‚è€ƒã€‚

## å¦‚ä½•æ’éšœï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å‘ç°é—®é¢˜ï¼Œç„¶åå®šä½é—®é¢˜ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦ç»è¿‡å¤šè½®åˆ†ææ’æŸ¥æ‰èƒ½å®šä½åˆ°é—®é¢˜çš„æ ¹å› ï¼Œæœ€åå»è§£å†³é—®é¢˜ã€‚æ’éšœæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20230307174145120](http://sm.nsddd.top/sm202303071741286.png)

å¦‚æœæƒ³æ’æŸ¥é—®é¢˜å¹¶è§£å†³é—®é¢˜ï¼Œä½ è¿˜éœ€è¦å…·å¤‡è¿™ä¸¤ä¸ªåŸºæœ¬èƒ½åŠ›ï¼šèƒ½å¤Ÿç†è§£é”™è¯¯æ—¥å¿—çš„å†…å®¹ï¼›æ ¹æ®é”™è¯¯æ—¥å¿—ï¼Œæ‰¾å‡ºè§£å†³æ–¹æ¡ˆã€‚

æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­æ¥è¯´å§ã€‚æœ‰ä»¥ä¸‹é”™è¯¯ï¼š

```bash
[going@dev iam]$ mysql -h127.0.0.1 -uroot -p'iam59!z$'
bash: /usr/bin/mysql: æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•
[going@dev iam]$
```

å¯¹äºè¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥ç†è§£é”™è¯¯å†…å®¹ï¼šmysqlå‘½ä»¤æ²¡æœ‰æ‰¾åˆ°ï¼Œè¯´æ˜æ²¡æœ‰å®‰è£…mysqlï¼Œæˆ–è€…å®‰è£…mysqlå¤±è´¥ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯é‡æ–°æ‰§è¡Œ [03è®²](https://time.geekbang.org/column/article/378082) ä¸­å®‰è£…MariaDBçš„æ­¥éª¤ï¼š

```bash
$ cd $IAM_ROOT
$ ./scripts/install/mariadb.sh iam::mariadb::install
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šä»¥`iam-apiserver`æœåŠ¡ä¸ºä¾‹ï¼Œç»™ä½ æ¼”ç¤ºä¸‹å…·ä½“å¦‚ä½•æ’éšœå¹¶è§£å†³é—®é¢˜ã€‚



### å‘ç°é—®é¢˜

è¦æ’éšœï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å‘ç°é—®é¢˜ã€‚æˆ‘ä»¬é€šå¸¸ç”¨ä¸‹é¢è¿™å‡ ç§æ–¹å¼æ¥å‘ç°é—®é¢˜ã€‚

+ æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼šå¯åŠ¨iam-apiserveræœåŠ¡åï¼Œæ‰§è¡Œ`systemctl status iam-apiserver` å‘ç°iam-apiserverå¯åŠ¨å¤±è´¥ï¼Œå³`Active`çš„å€¼ä¸ä¸º`active (running)`ã€‚
+ åŠŸèƒ½å¼‚å¸¸ï¼šè®¿é—®iam-apiserveræœåŠ¡ï¼ŒåŠŸèƒ½å¼‚å¸¸æˆ–è€…æŠ¥é”™ï¼Œä¾‹å¦‚æ¥å£è¿”å›å€¼è·Ÿé¢„æœŸä¸ä¸€æ ·ç­‰ã€‚
+ æ—¥å¿—æŠ¥é”™ï¼šåœ¨iam-apiserverçš„æ—¥å¿—ä¸­å‘ç°ä¸€äº›`WARN`ã€`ERROR`ã€`PANIC`ã€`FATAL`ç­‰çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚



### å®šä½é—®é¢˜

å‘ç°é—®é¢˜ä¹‹åï¼Œå°±éœ€è¦æˆ‘ä»¬å®šä½å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸‰ç§æ–¹å¼æ¥å®šä½é—®é¢˜ã€‚

+ æŸ¥çœ‹æ—¥å¿—ï¼Œå®ƒæ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ã€‚
+ ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜ã€‚
+ æ·»åŠ Debugæ—¥å¿—ï¼Œä»ç¨‹åºå…¥å£å¤„è·Ÿè¯»ä»£ç ï¼Œåœ¨å…³é”®ä½ç½®å¤„æ‰“å°Debugæ—¥å¿—ï¼Œæ¥å®šä½é—®é¢˜ã€‚

åœ¨å®šä½é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨â€œé¡ºè—¤æ‘¸ç“œâ€çš„æ€è·¯å»æ’æŸ¥é—®é¢˜ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œæµç¨‹æ˜¯ï¼š`A -> B -> â€¦ -> N`ã€‚å…¶ä¸­Aã€Bã€Néƒ½å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ’æŸ¥ç‚¹ã€‚æ‰€è°“çš„æ’æŸ¥ç‚¹ï¼Œå°±æ˜¯éœ€è¦åœ¨è¯¥å¤„å®šä½é—®é¢˜çš„ç‚¹ï¼Œè¿™äº›ç‚¹å¯èƒ½æ˜¯å¯¼è‡´é—®é¢˜çš„æ ¹å› æ‰€åœ¨ã€‚

åœ¨æ’éšœè¿‡ç¨‹ä¸­ï¼Œä½ å¯ä»¥æ ¹æ®æœ€ä¸Šå±‚çš„æ—¥å¿—æŠ¥é”™ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ’æŸ¥ç‚¹Bã€‚å¦‚æœç»è¿‡å®šä½ï¼Œå‘ç°Bæ²¡æœ‰é—®é¢˜ï¼Œé‚£ç»§ç»­æ ¹æ®ç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œæ‰¾ä¸‹ä¸€ä¸ªæ’æŸ¥ç‚¹æ’æŸ¥é—®é¢˜ã€‚å¦‚æ­¤åå¤ï¼Œç›´åˆ°æ‰¾åˆ°æœ€ç»ˆçš„æ’æŸ¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯å‡ºé—®é¢˜çš„æ ¹å› Nï¼ŒNå³ä¸ºBugç‚¹ã€‚æ‰§è¡Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://static001.geekbang.org/resource/image/cc/6d/cc26b83cb2177106695e1a9f7f09ae6d.jpg?wh=2248x931)

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹çœ‹è¿™ä¸‰ç§å®šä½é—®é¢˜çš„æ–¹æ³•ã€‚



#### æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜

æˆ‘ä»¬é¦–å…ˆåº”è¯¥é€šè¿‡æ—¥å¿—æ¥å®šä½é—®é¢˜ï¼Œè¿™æ˜¯æœ€ç®€å•é«˜æ•ˆçš„æ–¹å¼ã€‚è¦é€šè¿‡æ—¥å¿—æ¥å®šä½é—®é¢˜ï¼Œä½ ä¸ä»…è¦ä¼šçœ‹æ—¥å¿—ï¼Œè¿˜è¦èƒ½è¯»æ‡‚æ—¥å¿—ï¼Œä¹Ÿå°±æ˜¯ç†è§£æ—¥å¿—æŠ¥é”™çš„åŸå› ã€‚

ä¸‹é¢æˆ‘æ¥å…·ä½“è®²è§£ç”¨è¿™ç§æ–¹æ³•å®šä½é—®é¢˜çš„æ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼Œç¡®ä¿æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚**

ä½ å¯ä»¥é€šè¿‡æ‰§è¡Œ `systemctl status` å‘½ä»¤æ¥æŸ¥çœ‹æœåŠ¡çš„è¿è¡ŒçŠ¶å†µï¼š

```bash
$ systemctl status iam-apiserver
â— iam-apiserver.service - IAM APIServer
   Loaded: loaded (/etc/systemd/system/iam-apiserver.service; enabled; vendor preset: disabled)
   Active: activating (auto-restart) (Result: exit-code) since Thu 2021-09-09 13:47:56 CST; 2s ago
     Docs: https://github.com/marmotedu/iam/blob/master/init/README.md
  Process: 119463 ExecStart=/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml (code=exited, status=1/FAILURE)
  Process: 119461 ExecStartPre=/usr/bin/mkdir -p /var/log/iam (code=exited, status=0/SUCCESS)
  Process: 119460 ExecStartPre=/usr/bin/mkdir -p /data/iam/iam-apiserver (code=exited, status=0/SUCCESS)
 Main PID: 119463 (code=exited, status=1/FAILURE)
```

å¯ä»¥çœ‹åˆ°ï¼Œ`Active`ä¸æ˜¯`active (running)`ï¼Œè¯´æ˜iam-apiserveræœåŠ¡æ²¡æœ‰æ­£å¸¸è¿è¡Œã€‚ä»ä¸Šé¢è¾“å‡ºä¸­çš„`Process: 119463 ExecStart=/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml (code=exited, status=1/FAILURE)`ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ä»¥ä¸‹ä¿¡æ¯ï¼š

+ iam-apiserveræœåŠ¡å¯åŠ¨å‘½ä»¤ä¸º`/opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml`ã€‚
+ `/opt/iam/bin/iam-apiserver`åŠ è½½çš„é…ç½®æ–‡ä»¶ä¸º`/etc/iam/iam-apiserver.yaml`ã€‚
+ `/opt/iam/bin/iam-apiserver`å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ä¸º1ï¼Œå…¶è¿›ç¨‹IDä¸º`119463`ã€‚

è¿™é‡Œæ³¨æ„ï¼Œ`systemctl status`ä¼šå°†è¶…è¿‡ä¸€å®šé•¿åº¦çš„è¡Œçš„ååŠéƒ¨åˆ†ç”¨çœç•¥å·æ›¿ä»£ï¼Œå¦‚æœæƒ³æŸ¥çœ‹å®Œæ•´çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿½åŠ `-l`å‚æ•°ï¼Œä¹Ÿå°±æ˜¯`systemctl status -l`æ¥æŸ¥çœ‹ã€‚

æ—¢ç„¶iam-apiserverå‘½ä»¤å¯åŠ¨å¤±è´¥ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦æŸ¥çœ‹iam-apiserverå¯åŠ¨æ—¶çš„æ—¥å¿—ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä¸€äº›æŠ¥é”™æ—¥å¿—ã€‚

æ¥ä¸‹æ¥ï¼Œå°±è¿›å…¥**ç¬¬äºŒæ­¥ï¼ŒæŸ¥çœ‹**`iam-apiserver`**è¿è¡Œæ—¥å¿—ã€‚**

è¿™é‡Œæä¸€å¥ï¼Œå¦‚æœä½ å¯¹systemdä¸äº†è§£ï¼Œä¹Ÿå¯ä»¥è¶æœºæ¶è¡¥ä¸€æ³¢ã€‚ä½ å¯ä»¥å‚è€ƒé˜®ä¸€å³°å¤§ä½¬çš„ä¸¤ç¯‡åšå®¢ï¼š[Systemd å…¥é—¨æ•™ç¨‹ï¼šå‘½ä»¤ç¯‡](https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html)å’Œ[Systemd å…¥é—¨æ•™ç¨‹ï¼šå®æˆ˜ç¯‡](https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html)ã€‚

é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹å‘¢ï¼Ÿæˆ‘ä»¬æœ‰3ç§æŸ¥çœ‹æ–¹å¼ï¼Œæˆ‘åœ¨ä¸‹é¢æŒ‰ä¼˜å…ˆçº§é¡ºåºæ’åˆ—äº†ä¸‹ã€‚ä½ åœ¨å®šä½é—®é¢˜å’ŒæŸ¥çœ‹æ—¥å¿—æ—¶ï¼ŒæŒ‰ä¼˜å…ˆçº§3é€‰1å³å¯ï¼Œ1 > 2 > 3ã€‚

1. é€šè¿‡`journalctl -u iam-apiserver`æŸ¥çœ‹ã€‚
2. é€šè¿‡iam-apiserveræ—¥å¿—æ–‡ä»¶æŸ¥çœ‹ã€‚
3. é€šè¿‡consoleæŸ¥çœ‹ã€‚

ä¸‹é¢æˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹è¿™ä¸‰ç§æŸ¥çœ‹æ–¹å¼ã€‚

å…ˆæ¥çœ‹ä¼˜å…ˆçº§æœ€é«˜çš„æ–¹å¼ï¼Œé€šè¿‡`journalctl -u iam-apiserver`æŸ¥çœ‹ã€‚

systemd æä¾›äº†è‡ªå·±çš„æ—¥å¿—ç³»ç»Ÿï¼Œç§°ä¸º journalã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`journalctl`å‘½ä»¤æ¥è¯»å–journalæ—¥å¿—ã€‚`journalctl`æä¾›äº†`-u`é€‰é¡¹æ¥æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—ï¼Œæä¾›äº†`_PID`æ¥æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹IDçš„æ—¥å¿—ã€‚åœ¨**ç¬¬ä¸€æ­¥**ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æœåŠ¡å¯åŠ¨å¤±è´¥çš„è¿›ç¨‹IDä¸º`119463`ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹è¿™æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼š

```bash
$ sudo journalctl _PID=119463
-- Logs begin at Thu 2021-09-09 09:12:25 CST, end at Thu 2021-09-09 14:40:48 CST. --
...
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: 2021-09-09 13:47:56.727        INFO        apiserver        gorm@v1.21.12/gorm.go:202        mysql/mysql.go:75[error] faile>
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: 2021-09-09 13:47:56.727        FATAL        apiserver        apiserver/server.go:139        Failed to get cache instance: g>
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.createAPIServer
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.Run
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/internal/apiserver.run.func1
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/pkg/app.(*App).runCommand
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).execute
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).ExecuteC
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/spf13/cobra.(*Command).Execute
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: github.com/marmotedu/iam/pkg/app.(*App).Run
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: main.main
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]: runtime.main
Sep 09 13:47:56 VM-200-70-centos iam-apiserver[119463]:         /home/going/go/go1.16.2/src/runtime/proc.go:225
lines 10-54/54 (END)
```

ä»ä¸Šé¢çš„æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æœåŠ¡å¯åŠ¨å¤±è´¥çš„åŸå› ï¼š`iam-apiserver`å¯åŠ¨æ—¶ï¼Œå‘ç”Ÿäº†`FATAL`çº§åˆ«çš„é”™è¯¯ã€‚åˆ°è¿™é‡Œï¼Œä½ å·²ç»åˆæ­¥å®šä½åˆ°é—®é¢˜åŸå› äº†ã€‚

æˆ‘ä»¬å†æ¥çœ‹é€šè¿‡iam-apiserveræ—¥å¿—æ–‡ä»¶æŸ¥çœ‹çš„æ–¹å¼ã€‚

ä½œä¸ºä¸€ä¸ªä¼ä¸šçº§çš„å®æˆ˜é¡¹ç›®ï¼Œiam-apiserverçš„æ—¥å¿—å½“ç„¶æ˜¯ä¼šè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ä¸­çš„ã€‚åœ¨**ç¬¬ä¸€æ­¥**ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡`systemctl status iam-apiserver`è¾“å‡ºçš„ä¿¡æ¯ï¼ŒçŸ¥é“äº†iam-apiserverå¯åŠ¨æ—¶åŠ è½½çš„é…ç½®æ–‡ä»¶ä¸º`/etc/iam/iam-apiserver.yaml`ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iam-apiserverçš„é…ç½®æ–‡ä»¶iam-apiserver.yamlä¸­çš„`log.output-paths`é…ç½®é¡¹ï¼ŒæŸ¥çœ‹è®°å½•æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ï¼š

```bash
log:
    name: apiserver # Loggerçš„åå­—
    development: true # æ˜¯å¦æ˜¯å¼€å‘æ¨¡å¼ã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œä¼šå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ªã€‚
    level: debug # æ—¥å¿—çº§åˆ«ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¾æ¬¡ä¸ºï¼šdebug, info, warn, error, dpanic, panic, fatalã€‚
    format: console # æ”¯æŒçš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œç›®å‰æ”¯æŒconsoleå’Œjsonä¸¤ç§ã€‚consoleå…¶å®å°±æ˜¯textæ ¼å¼ã€‚
    enable-color: true # æ˜¯å¦å¼€å¯é¢œè‰²è¾“å‡ºï¼Œtrue:æ˜¯ï¼Œfalse:å¦
    disable-caller: false # æ˜¯å¦å¼€å¯ callerï¼Œå¦‚æœå¼€å¯ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºè°ƒç”¨æ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶ã€å‡½æ•°å’Œè¡Œå·
    disable-stacktrace: false # æ˜¯å¦åœ¨panicåŠä»¥ä¸Šçº§åˆ«ç¦æ­¢æ‰“å°å †æ ˆä¿¡æ¯
    output-paths: /var/log/iam/iam-apiserver.log,stdout # æ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€ã€‚æ”¯æŒè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ–‡ä»¶ã€‚
    error-output-paths: /var/log/iam/iam-apiserver.error.log # zapå†…éƒ¨(éä¸šåŠ¡)é”™è¯¯æ—¥å¿—è¾“å‡ºè·¯å¾„ï¼Œå¤šä¸ªè¾“å‡ºï¼Œé€—å·åˆ†å¼€
```

å¯ä»¥çœ‹åˆ°ï¼Œiam-apiserverå°†æ—¥å¿—åˆ†åˆ«è®°å½•åˆ°äº†`/var/log/iam/iam-apiserver.log`å’Œ`stdout`ä¸­ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹`/var/log/iam/iam-apiserver.log`æ—¥å¿—æ–‡ä»¶ï¼Œæ¥æŸ¥çœ‹æŠ¥é”™ä¿¡æ¯ï¼š

```bash
$ tail -25 /var/log/iam/iam-apiserver.log
...
2021-09-09 15:42:35.231  INFO  apiserver  server/genericapiserver.go:88  GET    /version --> github.com/marmotedu/iam/internal/pkg/server.(*GenericAPIServer).InstallAPIs.func2 (10 handlers)
2021-09-09 15:42:35.232  INFO  apiserver  gorm@v1.21.12/gorm.go:202  mysql/mysql.go:75[error] failed to initialize database, got error dial tcp 127.0.0.1:3309: connect: connection refused
2021-09-09 15:42:35.232  FATAL  apiserver  apiserver/server.go:139  Failed to get cache instance: got nil cache server
github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
github.com/marmotedu/iam/internal/apiserver.createAPIServer
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
github.com/marmotedu/iam/internal/apiserver.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
github.com/marmotedu/iam/internal/apiserver.run.func1
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
github.com/marmotedu/iam/pkg/app.(*App).runCommand
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
github.com/spf13/cobra.(*Command).execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
github.com/spf13/cobra.(*Command).ExecuteC
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
github.com/spf13/cobra.(*Command).Execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
github.com/marmotedu/iam/pkg/app.(*App).Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
main.main
  /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
runtime.main
  /home/going/go/go1.16.2/src/runtime/proc.go:225
```

æˆ‘ä»¬å†æ¥çœ‹æœ€åä¸€ç§æŸ¥çœ‹æ–¹å¼ï¼Œé€šè¿‡consoleæŸ¥çœ‹ã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡consoleæ¥çœ‹æ—¥å¿—ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬åœ¨Linuxç»ˆç«¯å‰å°è¿è¡Œiam-apiserverï¼ˆåœ¨**ç¬¬ä¸€æ­¥**ä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å¯åŠ¨å‘½ä»¤ï¼‰ï¼š

```bash
$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml
...
2021-09-09 15:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /debug/pprof/mutex --> github.com/gin-contrib/pprof.pprofHandler.func1 (10 handlers)
2021-09-09 15:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /debug/pprof/threadcreate --> github.com/gin-contrib/pprof.pprofHandler.func1 (10 handlers)
2021-09-09 15:47:00.660  INFO  apiserver  server/genericapiserver.go:88  GET    /version --> github.com/marmotedu/iam/internal/pkg/server.(*GenericAPIServer).InstallAPIs.func2 (10 handlers)
2021-09-09 15:47:00.661  INFO  apiserver  gorm@v1.21.12/gorm.go:202  mysql/mysql.go:75[error] failed to initialize database, got error dial tcp 127.0.0.1:3309: connect: connection refused
2021-09-09 15:47:00.661  FATAL  apiserver  apiserver/server.go:139  Failed to get cache instance: got nil cache server
github.com/marmotedu/iam/internal/apiserver.(*completedExtraConfig).New
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:139
github.com/marmotedu/iam/internal/apiserver.createAPIServer
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/server.go:66
github.com/marmotedu/iam/internal/apiserver.Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/run.go:11
github.com/marmotedu/iam/internal/apiserver.run.func1
  /home/going/workspace/golang/src/github.com/marmotedu/iam/internal/apiserver/app.go:46
github.com/marmotedu/iam/pkg/app.(*App).runCommand
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:278
github.com/spf13/cobra.(*Command).execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:856
github.com/spf13/cobra.(*Command).ExecuteC
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:974
github.com/spf13/cobra.(*Command).Execute
  /home/going/workspace/golang/pkg/mod/github.com/spf13/cobra@v1.2.1/command.go:902
github.com/marmotedu/iam/pkg/app.(*App).Run
  /home/going/workspace/golang/src/github.com/marmotedu/iam/pkg/app/app.go:233
main.main
  /home/going/workspace/golang/src/github.com/marmotedu/iam/cmd/iam-apiserver/apiserver.go:24
runtime.main
  /home/going/go/go1.16.2/src/runtime/proc.go:225
```

é€šè¿‡ä¸Šé¢è¿™3ç§æŸ¥çœ‹æ–¹å¼ï¼Œæˆ‘ä»¬å‡èƒ½åˆæ­¥å®šä½åˆ°æœåŠ¡å¼‚å¸¸çš„åŸå› ã€‚



#### ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜

æŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ï¼Œé€šè¿‡æŸ¥çœ‹æ—¥å¿—ï¼Œæˆ‘ä»¬å¯èƒ½å®šä½å‡ºé—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œè¿™ç§æƒ…å†µä¸‹é—®é¢˜å°±èƒ½å¾—åˆ°å¿«é€Ÿçš„è§£å†³ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šè¿‡æ—¥å¿—å¹¶ä¸ä¸€å®šèƒ½å®šä½å‡ºé—®é¢˜ï¼Œä¾‹å¦‚ï¼š

+ ç¨‹åºå¼‚å¸¸ï¼Œä½†æ˜¯æ²¡æœ‰é”™è¯¯æ—¥å¿—ã€‚
+ æ—¥å¿—æœ‰æŠ¥é”™ï¼Œä½†åªèƒ½åˆ¤æ–­é—®é¢˜çš„é¢ï¼Œè¿˜ä¸èƒ½ç²¾å‡†æ‰¾åˆ°é—®é¢˜çš„æ ¹å› ã€‚

é‡åˆ°ä¸Šé¢è¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬éƒ½éœ€è¦å†è¿›ä¸€æ­¥åœ°å®šä½é—®é¢˜ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Delveè°ƒè¯•å·¥å…·æ¥å°è¯•å®šä½é—®é¢˜ã€‚Delveå·¥å…·çš„ç”¨æ³•ä½ å¯ä»¥å‚è€ƒ [Delveä½¿ç”¨è¯¦è§£](https://github.com/marmotedu/geekbang-go/blob/master/Delveä½¿ç”¨è¯¦è§£.md)ã€‚



#### æ·»åŠ Debugæ—¥å¿—å®šä½é—®é¢˜

å¦‚æœä½¿ç”¨ Delve å·¥å…·ä»ç„¶æ²¡æœ‰å®šä½å‡ºé—®é¢˜ï¼Œæ¥ä¸‹æ¥ä½ å¯ä»¥å°è¯•æœ€åŸå§‹çš„æ–¹æ³•ï¼šæ·»åŠ Debugæ—¥å¿—æ¥å®šä½é—®é¢˜ã€‚è¿™ç§æ–¹æ³•å…·ä½“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ã€‚

**ç¬¬ä¸€æ­¥ï¼Œåœ¨å…³é”®ä»£ç æ®µæ·»åŠ Debugæ—¥å¿—ã€‚**

ä½ éœ€è¦æ ¹æ®è‡ªå·±å¯¹ä»£ç çš„ç†è§£æ¥å†³å®šå…³é”®ä»£ç æ®µã€‚å¦‚æœä¸ç¡®å®šå“ªæ®µä»£ç å‡ºé—®é¢˜ï¼Œå¯ä»¥ä»è¯·æ±‚å…¥å£å¤„æ·»åŠ Debugæ—¥å¿—ï¼Œç„¶åè·Ÿç€ä»£ç æµç¨‹ä¸€æ­¥æ­¥å¾€ä¸‹æ’æŸ¥ï¼Œå¹¶åœ¨éœ€è¦çš„åœ°æ–¹æ·»åŠ Debugæ—¥å¿—ã€‚

ä¾‹å¦‚ï¼Œé€šè¿‡æ’æŸ¥æ—¥å¿—ï¼Œæˆ‘ä»¬å®šä½åˆ°`internal/apiserver/server.go:139`ä½ç½®çš„ä»£ç å¯¼è‡´ç¨‹åºFATALï¼ŒFATALåŸå› æ˜¯`Failed to get cache instance: got nil cache server`ã€‚`cache server`æ˜¯`nil`ï¼Œè¯´æ˜`cache server`æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚æŸ¥çœ‹`cache server`åˆå§‹åŒ–å‡½æ•°ï¼š

```go
func GetCacheInsOr(store store.Factory) (*Cache, error) {
    if store != nil {
        once.Do(func() {
            cacheServer = &Cache{store}
        })
    }

    if cacheServer == nil {
        return nil, fmt.Errorf("got nil cache server")
    }

    return cacheServer, nil
}
```

æˆ‘ä»¬ä¸éš¾åˆ†æå‡ºï¼Œæ˜¯`store == nil`å¯¼è‡´`cacheServer`æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚å†æ¥çœ‹ä¸‹storeçš„åˆå§‹åŒ–ä»£ç ï¼Œå¹¶åŠ ä¸€äº›Debugæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](http://sm.nsddd.top/sm202303071810106.png)

æˆ‘ä»¬æ·»åŠ å®ŒDebugä»£ç åï¼Œå°±å¯ä»¥é‡æ–°ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºäº†ã€‚

è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼šå¯ä»¥åœ¨é”™è¯¯è¿”å›çš„ä½ç½®æ·»åŠ Debugæ—¥å¿—ï¼Œè¿™æ ·èƒ½å¤§æ¦‚ç‡å¸®åŠ©ä½ å®šä½åˆ°å‡ºé”™çš„ä½ç½®ï¼Œä¾‹å¦‚ï¼š

```go
if err != nil {
  log.Debugf("DEBUG POINT - 1: %v", err)
  return err
}
```

**ç¬¬äºŒæ­¥ï¼Œé‡æ–°ç¼–è¯‘æºç ï¼Œå¹¶å¯åŠ¨ã€‚**

*è¿™é‡Œä¸ºäº†è°ƒè¯•ã€çœ‹æ—¥å¿—æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨Linuxç»ˆç«¯çš„å‰ç«¯è¿è¡Œiam-apiserverï¼š

```bash
$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml
```

æŸ¥çœ‹æˆ‘ä»¬æ·»åŠ çš„Debugæ—¥å¿—æ‰“å°çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](http://sm.nsddd.top/sm202303071813916.png)

ä»Debugæ—¥å¿—ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç”¨æ¥åˆ›å»ºMySQLå®ä¾‹çš„ç«¯å£æ˜¯é”™è¯¯çš„ï¼Œæ­£ç¡®çš„ç«¯å£åº”è¯¥æ˜¯`3306`ï¼Œè€Œä¸æ˜¯`3309`ã€‚MySQLæœåŠ¡å™¨çš„ç«¯å£æ˜¯åœ¨iam-apiserver.yamlä¸­é…ç½®çš„ã€‚ä¿®æ”¹iam-apiserver.yamlä¸ºæ­£ç¡®çš„é…ç½®ï¼Œå¹¶å¯åŠ¨ï¼š

```bash
$ sudo /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml
```

å†æ¬¡æŸ¥çœ‹consoleæ—¥å¿—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/f7/9d/f72b766b7504016259bef04eb03dac9d.png?wh=1920x271)](https://static001.geekbang.org/resource/image/f7/9d/f72b766b7504016259bef04eb03dac9d.png?wh=1920x271)

å¯ä»¥çœ‹åˆ°é—®é¢˜å·²ç»ä¿®å¤ï¼Œ`dbIns`ä¸ä¸º`nil`ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œï¼š

```bash
$ systemctl status iam-apiserver
â— iam-apiserver.service - IAM APIServer
   Loaded: loaded (/etc/systemd/system/iam-apiserver.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2021-09-09 20:48:18 CST; 17s ago
     Docs: https://github.com/marmotedu/iam/blob/master/init/README.md
  Process: 255648 ExecStartPre=/usr/bin/mkdir -p /var/log/iam (code=exited, status=0/SUCCESS)
  Process: 255647 ExecStartPre=/usr/bin/mkdir -p /data/iam/iam-apiserver (code=exited, status=0/SUCCESS)
 Main PID: 255650 (iam-apiserver)
    Tasks: 5 (limit: 23724)
   Memory: 7.3M
   CGroup: /system.slice/iam-apiserver.service
           â””â”€255650 /opt/iam/bin/iam-apiserver --config=/etc/iam/iam-apiserver.yaml
```

åœ¨è¿™é‡Œï¼Œ`Active`ä¸º`active (running)`çŠ¶æ€ã€‚

å› ä¸ºè¿™äº›Debugæ—¥å¿—èƒ½å¤ŸååŠ©ä½ å®šä½é—®é¢˜ï¼Œä»ä¾§é¢è¯´æ˜è¿™äº›æ—¥å¿—æ˜¯æœ‰ç”¨çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¿ç•™è¿™äº›Debugæ—¥å¿—è°ƒç”¨ä»£ç ã€‚



### è§£å†³é—®é¢˜

åœ¨å®šä½é—®é¢˜é˜¶æ®µï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†é—®é¢˜çš„åŸå› ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ ¹æ®è‡ªå·±å¯¹ä¸šåŠ¡ã€åº•å±‚ä»£ç å®ç°çš„æŒæ¡å’Œç†è§£ï¼Œä¿®å¤è¿™ä¸ªé—®é¢˜äº†ã€‚è‡³äºæ€ä¹ˆä¿®å¤ï¼Œä½ éœ€è¦ç»“åˆå…·ä½“æƒ…å†µæ¥åˆ¤æ–­ï¼Œå¹¶æ²¡æœ‰ç»Ÿä¸€çš„æµç¨‹å’Œæ–¹æ³•è®ºï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚

ä¸Šé¢ï¼Œæˆ‘ä»‹ç»äº†æ’æŸ¥é—®é¢˜çš„æ€è·¯å’Œæ–¹æ³•ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥å‘ä½ å±•ç¤º9ä¸ªåœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMç³»ç»Ÿæ—¶å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æä¾›è§£å†³æ–¹æ³•ã€‚è¿™äº›é—®é¢˜åŸºæœ¬ä¸Šéƒ½æ˜¯ç”±æœåŠ¡å™¨ç¯å¢ƒå¼•èµ·çš„ã€‚

## IAMå¸¸è§æ•…éšœåŠè§£å†³åŠæ³•

é—®é¢˜ä¸€ï¼šå®‰è£…neovimï¼ŒæŠ¥ `No match for argument: neovim` é”™è¯¯ã€‚

è§£å†³æ–¹æ³•æ˜¯å®‰è£… EPEL æºï¼š

```bash
$ sudo yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
```

é—®é¢˜äºŒï¼šå®‰è£…protoc-gen-goå¤±è´¥ï¼ˆè¶…æ—¶ã€æŠ¥é”™ç­‰ï¼‰ã€‚

è¿™ä¸ªæ•…éšœå‡ºç°ï¼Œå¯èƒ½æ˜¯å› ä¸ºä½ å½“å‰æœåŠ¡å™¨æ‰€åœ¨çš„ç½‘ç»œç¯å¢ƒæ— æ³•è®¿é—®`github.com`ï¼Œæˆ–è€…è®¿é—®`github.com`é€Ÿåº¦å¤ªæ…¢ã€‚

è§£å†³æ–¹æ³•æ˜¯æ‰‹åŠ¨ç¼–è¯‘å®‰è£…ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```bash
$ git clone --depth 1 https://github.com/golang/protobuf $GOPATH/src/github.com/golang/protobuf
$ cd $GOPATH/src/github.com/golang/protobuf/protoc-gen-go
$ go install -v .
```

é—®é¢˜ä¸‰ï¼šé‡åˆ°`xxx: permission denied`è¿™ç±»çš„é”™è¯¯ã€‚

å‡ºç°è¿™ç§é”™è¯¯ï¼Œæ˜¯å› ä¸ºä½ æ²¡æœ‰æƒé™æ‰§è¡Œå½“å‰çš„æ“ä½œã€‚è§£å†³æ–¹æ³•æ˜¯æ’æŸ¥è‡ªå·±æ˜¯å¦æœ‰æƒé™æ‰§è¡Œå½“å‰æ“ä½œã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œéœ€è¦ä½ åˆ‡æ¢åˆ°æœ‰æƒé™çš„ç”¨æˆ·ï¼Œæˆ–è€…æ”¾å¼ƒæ‰§è¡Œå½“å‰æ“ä½œã€‚

ä¸ºäº†è¯´æ˜é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä¸¾ä¸€ä¸ªé”™è¯¯ä¾‹å­ï¼Œå¹¶ç»™å‡ºæ’æŸ¥æ€è·¯ã€‚ä¾‹å­çš„é”™è¯¯æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
[going@VM-8-9-centos /]$ go get -u github.com/golang/protobuf/protoc-gen-go
go: could not create module cache: mkdir /golang: permission denied
[going@VM-8-9-centos /]$ sudo go get -u github.com/golang/protobuf/protoc-gen-go
sudo: go: command not found
```

ä¸Šè¿°é”™è¯¯ä¸­ï¼Œ ä¸€å…±æŠ¥äº†ä¸¤ä¸ªé”™è¯¯ï¼Œåˆ†åˆ«æ˜¯`mkdir /golang: permission denied`å’Œ`sudo: go: command not found`ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹`mkdir /golang: permission denied`é”™è¯¯ã€‚

é€šè¿‡å‘½ä»¤è¡Œæç¤ºç¬¦`$`å¯ä»¥çŸ¥é“ï¼Œå½“å‰ç™»é™†ç”¨æˆ·æ˜¯æ™®é€šç”¨æˆ·ï¼›é€šè¿‡æŠ¥é”™`mkdir /golang: permission denied`å¯ä»¥çŸ¥é“`go get -u github.com/golang/protobuf/protoc-gen-go`å‘½ä»¤åº•å±‚æ‰§è¡Œäº†`mkdir /golang`ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·æ²¡æœ‰å†™`/` ç›®å½•çš„æƒé™ï¼Œæ‰€ä»¥ä¼šæŠ¥æƒé™é”™è¯¯ã€‚è§£å†³æ–¹æ³•æ˜¯åˆ‡æ¢åˆ°ç”¨æˆ·çš„ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ`go get -u`å‘½ä»¤ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸‹`sudo: go: command not found`é”™è¯¯ã€‚`sudo`å‘½ä»¤ä¼šå°†å‘½ä»¤æ‰§è¡Œçš„ç¯å¢ƒåˆ‡æ¢åˆ°`root`ç”¨æˆ·ï¼Œ`root`ç”¨æˆ·æ˜¾ç„¶æ˜¯æ²¡æœ‰å®‰è£…`go`å‘½ä»¤çš„ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´`command not found`é”™è¯¯ã€‚è§£å†³æ–¹å¼æ˜¯å»æ‰ `sudo` ï¼Œç›´æ¥æ‰§è¡Œ `$ go get -u xxx` ã€‚

é—®é¢˜å››ï¼šVimIDEä½¿ç”¨è¿‡ç¨‹ä¸­ï¼ŒæŠ¥å„ç±»é”™è¯¯ã€‚

è¿™é‡Œçš„æŠ¥é”™åŸå› è·Ÿç¯å¢ƒæœ‰å…³ç³»ï¼Œå®‰è£…VimIDEæ—¶çš„ç³»ç»Ÿç¯å¢ƒã€åŒ…çš„ç‰ˆæœ¬ç­‰ç­‰ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´ä½¿ç”¨VimIDEæŠ¥é”™ã€‚å› ä¸ºé”™è¯¯ç±»å‹å¤ªå¤šï¼Œæ²¡æ³•ä¸€ä¸€è¯´æ˜ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ä½ å¿½ç•¥è¿™äº›é”™è¯¯ï¼Œå…¶å®å®Œå…¨ä¸å½±å“åé¢çš„å­¦ä¹ ã€‚

é—®é¢˜äº”ï¼šè®¿é—®iam-authz-serverçš„`/v1/authz`æ¥å£æŠ¥`{"code":100202,"message":"Signature is invalid"}`ã€‚

è¿™æ—¶å¯èƒ½æ˜¯ç­¾å‘çš„Tokenæœ‰é—®é¢˜ï¼Œå»ºè®®é‡æ–°æ‰§è¡Œä»¥ä¸‹5ä¸ªæ­¥éª¤ï¼š

1. é‡æ–°ç™»é™†ç³»ç»Ÿï¼Œå¹¶è·å–è®¿é—®ä»¤ç‰Œï¼š

```bash
$ token=`curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login | jq -r .token`
```

å¦‚æœæ²¡æœ‰å®‰è£…`jq`å‘½ä»¤ï¼Œå¯ä»¥æ‰§è¡Œ`sudo yum -y install jq`å‘½ä»¤æ¥å®‰è£…ã€‚

1. åˆ›å»ºæˆæƒç­–ç•¥ï¼š

```bash
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"policy":{"description":"One policy to rule them all.","subjects":["users:<peter|ken>","users:maria","groups:admins"],"actions":["delete","<create|update>"],"effect":"allow","resources":["resources:articles:<.>","resources:printer"],"conditions":{"remoteIPAddress":{"type":"CIDRCondition","options":{"cidr":"192.168.0.1/16"}}}}}' http://127.0.0.1:8080/v1/policies
```

1. åˆ›å»ºå¯†é’¥ï¼Œå¹¶ä»å‘½ä»¤çš„è¾“å‡ºä¸­æå–secretID å’Œ secretKeyï¼š

```bash
$ curl -s -XPOST -H"Content-Type: application/json" -H"Authorization: Bearer $token" -d'{"metadata":{"name":"authztest"},"expires":0,"description":"admin secret"}' http://127.0.0.1:8080/v1/secrets
{"metadata":{"id":23,"name":"authztest","createdAt":"2021-04-08T07:24:50.071671422+08:00","updatedAt":"2021-04-08T07:24:50.071671422+08:00"},"username":"admin","secretID":"ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox","secretKey":"7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8","expires":0,"description":"admin secret"}
```

1. ç”Ÿæˆè®¿é—® iam-authz-server çš„ Token

iamctl æä¾›äº† `jwt sigin` å‘½ä»¤ï¼Œä½ å¯ä»¥æ ¹æ® `secretID` å’Œ `secretKey` ç­¾å‘ Tokenï¼Œæ–¹ä¾¿ä½ ä½¿ç”¨ã€‚ç­¾å‘Tokençš„å…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
$ iamctl jwt sign ZuxvXNfG08BdEMqkTaP41L2DLArlE6Jpqoox 7Sfa5EfAPIwcTLGCfSvqLf0zZGCjF3l8 # iamctl jwt sign $secretID $secretKey
eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ
```

1. æµ‹è¯•èµ„æºæˆæƒæ˜¯å¦é€šè¿‡ï¼š

```bash
$ curl -s -XPOST -H'Content-Type: application/json' -H'Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ilp1eHZYTmZHMDhCZEVNcWtUYVA0MUwyRExBcmxFNkpwcW9veCIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTYxNzg0NTE5NSwiaWF0IjoxNjE3ODM3OTk1LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2MTc4Mzc5OTV9.za9yLM7lHVabPAlVQLCqXEaf8sTU6sodAsMXnmpXjMQ' -d'{"subject":"users:maria","action":"delete","resource":"resources:articles:ladon-introduction","context":{"remoteIPAddress":"192.168.0.5"}}' http://127.0.0.1:9090/v1/authz
{"allowed":true}
```

é—®é¢˜å…­ï¼šæ‰§è¡Œ`iamctl user list`æŠ¥`error: {"code":100207,"message":"Permission denied"}`ã€‚

å‡ºç°è¿™ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯å¯†ç æ²¡æœ‰é…ç½®æ­£ç¡®ã€‚

ä½ å¯ä»¥çœ‹ä¸‹`$HOME/.iam/iamctl.yaml`é…ç½®æ–‡ä»¶ä¸­çš„ç”¨æˆ·åå’Œå¯†ç é…ç½®çš„æ˜¯ä¸æ˜¯adminï¼Œä»¥åŠadminçš„å¯†ç æ˜¯å¦æ˜¯`Admin@2021`ã€‚

é—®é¢˜ä¸ƒï¼šåœ¨åˆ›å»ºç”¨æˆ·æ—¶æŠ¥`{"code":100101,"message":"Database error"}`é”™è¯¯ã€‚

å‡ºç°è¿™ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯ç”¨æˆ·åé‡äº†ï¼Œå»ºè®®æ¢ä¸ªæ–°çš„ç”¨æˆ·åå†æ¬¡åˆ›å»ºã€‚

é—®é¢˜å…«ï¼šæŠ¥`No such file or directory`ã€`command not found`ã€`permission denied`é”™è¯¯ã€‚

é‡åˆ°è¿™ç±»é”™è¯¯ï¼Œè¦æ ¹æ®æç¤ºæ’æŸ¥å’Œè§£å†³é—®é¢˜ã€‚

+ `No such file or directory`ï¼šç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„åŸå› æ˜¯ä»€ä¹ˆã€‚
+ `command not found`ï¼šç¡®è®¤å‘½ä»¤æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå¯ä»¥é‡æ–°å®‰è£…å‘½ä»¤ã€‚
+ `permission denied`ï¼šç¡®è®¤æ˜¯å¦æœ‰æ“ä½œæƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œè¦åˆ‡æ¢åˆ°æœ‰æƒé™çš„ç”¨æˆ·æˆ–è€…ç›®å½•ã€‚

é—®é¢˜ä¹ï¼šæŠ¥`iam-apiserver.service`ã€`/opt/iam/bin/iam-apiserver`ã€`/etc/iam/iam-apiserver.yaml`æ–‡ä»¶ä¸å­˜åœ¨ã€‚

æˆ‘æ¥ä»‹ç»ä¸‹è¿™äº›æ–‡ä»¶çš„ä½œç”¨ã€‚

+ `/etc/systemd/system/iam-apiserver.service`ï¼šiam-apiserverçš„sysmted Unitæ–‡ä»¶ã€‚
+ `/opt/iam/bin/iam-apiserver`ï¼šiam-apiserverçš„äºŒè¿›åˆ¶å¯åŠ¨å‘½ä»¤ã€‚
+ `/etc/iam/iam-apiserver.yaml`ï¼šiam-apiserverçš„é…ç½®æ–‡ä»¶ã€‚

å¦‚æœæŸä¸ªæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£å°±éœ€è¦ä½ é‡æ–°å®‰è£…è¿™äº›æ–‡ä»¶ã€‚æˆ‘æ¥åˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªæ–‡ä»¶çš„å®‰è£…æ–¹æ³•ã€‚

`/etc/systemd/system/iam-apiserver.service`å®‰è£…æ–¹æ³•ï¼š

```bash
$ cd $IAM_ROOT
$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-apiserver.service > iam-apiserver.service
$ sudo mv iam-apiserver.service /etc/systemd/system/
```

`/opt/iam/bin/iam-apiserver`å®‰è£…æ–¹æ³•ï¼š

```bash
$ cd $IAM_ROOT
$ source scripts/install/environment.sh
$ make build BINS=iam-apiserver
$ sudo cp _output/platforms/linux/amd64/iam-apiserver ${IAM_INSTALL_DIR}/bin
```

`/etc/iam/iam-apiserver.yaml`å®‰è£…æ–¹æ³•ï¼š

```bash
$ cd $IAM_ROOT
$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-apiserver.yaml > iam-apiserver.yaml
$ sudo mv iam-apiserver.yaml ${IAM_CONFIG_DIR}
```

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»¥`iam-apiserver`æœåŠ¡ä¸ºä¾‹ï¼Œå‘ä½ ä»‹ç»äº†æ’éšœçš„åŸºæœ¬æµç¨‹ï¼šå‘ç°é—®é¢˜ -> å®šä½é—®é¢˜ -> è§£å†³é—®é¢˜ã€‚

ä½ å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¥å‘ç°é—®é¢˜ã€‚

+ æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼šå¯åŠ¨iam-apiserveræœåŠ¡åï¼Œæ‰§è¡Œ`systemctl status iam-apiserver` å‘ç°iam-apiserverå¯åŠ¨å¤±è´¥ï¼Œå³`Active`çš„å€¼ä¸ä¸º`active (running)`ã€‚
+ åŠŸèƒ½å¼‚å¸¸ï¼šè®¿é—®iam-apiserveræœåŠ¡ï¼ŒåŠŸèƒ½å¼‚å¸¸æˆ–è€…æŠ¥é”™ï¼Œä¾‹å¦‚æ¥å£è¿”å›å€¼è·Ÿé¢„æœŸä¸ä¸€æ ·ï¼›æ¥å£æŠ¥é”™ã€‚
+ æ—¥å¿—æŠ¥é”™ï¼šåœ¨iam-apiserverçš„æ—¥å¿—ä¸­å‘ç°ä¸€äº›`WARN`ã€`ERROR`ã€`PANIC`ã€`FATAL`ç­‰é«˜çº§åˆ«çš„é”™è¯¯æ—¥å¿—ã€‚

å‘ç°é—®é¢˜ä¹‹åï¼Œä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹æ—¥å¿—ã€ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveå’Œæ·»åŠ Debugæ—¥å¿—è¿™ä¸‰ç§æ–¹å¼æ¥å®šä½é—®é¢˜ã€‚

+ æŸ¥çœ‹æ—¥å¿—ï¼šæŸ¥çœ‹æ—¥å¿—æ˜¯æœ€ç®€å•çš„æ’éšœæ–¹å¼ã€‚
+ ä½¿ç”¨Goè°ƒè¯•å·¥å…·Delveæ¥å®šä½é—®é¢˜ã€‚
+ æ·»åŠ Debugæ—¥å¿—ï¼šä»ç¨‹åºå…¥å£å¤„è·Ÿè¯»ä»£ç ï¼Œåœ¨å…³é”®ä½ç½®å¤„æ‰“å°Debugæ—¥å¿—ï¼Œæ¥å®šä½é—®é¢˜ã€‚

æ‰¾åˆ°é—®é¢˜æ ¹å› ä¹‹åï¼Œå°±è¦è§£å†³é—®é¢˜ã€‚ä½ éœ€è¦æ ¹æ®è‡ªå·±å¯¹ä¸šåŠ¡ã€åº•å±‚ä»£ç å®ç°çš„æŒæ¡å’Œç†è§£ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚

æœ€åï¼Œæˆ‘å‘ä½ å±•ç¤ºäº†9ä¸ªåœ¨éƒ¨ç½²å’Œä½¿ç”¨IAMç³»ç»Ÿæ—¶å®¹æ˜“é‡åˆ°çš„é—®é¢˜ï¼Œå¹¶æä¾›äº†è§£å†³æ–¹æ³•ï¼Œå¸Œæœ›èƒ½ç»™ä½ ä¸€äº›åˆ‡å®çš„å¸®åŠ©ã€‚



## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸‹ï¼Œå¦‚ä½•æŸ¥æ‰¾iam-apiserverçš„systemd Unitæ–‡ä»¶çš„è·¯å¾„ï¼Ÿ
2. æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ token=`curl -s -XPOST -H'Content-Type: application/json' -d'{"username":"admin","password":"Admin@2021"}' http://127.0.0.1:8080/login | jq -r .token`
$ echo $token
```

å¯ä»¥è·å–`token`ï¼Œä½†å‘ç°`token`å€¼ä¸ºç©ºã€‚è¯·ç»™å‡ºä½ çš„æ’éšœæµç¨‹å’Œæ–¹æ³•ã€‚



## END é“¾æ¥
<ul><li><div><a href = '45.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '47.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

