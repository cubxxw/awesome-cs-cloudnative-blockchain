+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬48èŠ‚ åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡

<br>
<div><a href = '47.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '49.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ï¼Œæˆ‘ä»¬åˆè§é¢äº†ã€‚ç»“è¯¾å¹¶ä¸æ„å‘³ç€ç»“æŸï¼Œæˆ‘éå¸¸é«˜å…´èƒ½æŒç»­æŠŠå¥½çš„å†…å®¹åˆ†äº«ç»™ä½ ï¼Œä¹Ÿå¸Œæœ›ä½ èƒ½ç»§ç»­åœ¨ç•™è¨€åŒºä¸æˆ‘ä¿æŒäº¤æµï¼Œåˆ†äº«ä½ çš„å­¦ä¹ å¿ƒå¾—å’Œå®è·µç»éªŒã€‚

ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬æ¥èŠèŠå¦‚ä½•è®¾è®¡åˆ†å¸ƒå¼ä½œä¸šç³»ç»Ÿã€‚åœ¨å®é™…çš„Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸‹é¢è¿™ä¸¤ä¸ªåŠŸèƒ½éœ€æ±‚ï¼š

+ æƒ³å®šæ—¶æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œä¾‹å¦‚åœ¨æ¯å¤©ä¸Šåˆ10:00æ¸…ç†æ•°æ®åº“ä¸­çš„æ— ç”¨æ•°æ®ã€‚
+ è½®è®­æ•°æ®åº“è¡¨çš„æŸä¸ªå­—æ®µï¼Œæ ¹æ®å­—æ®µçš„çŠ¶æ€ï¼Œè¿›è¡Œä¸€äº›å¼‚æ­¥çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚æ¯”å¦‚ï¼Œç›‘å¬åˆ° `table_xxx.status = 'pending'` æ—¶ï¼Œæ‰§è¡Œå¼‚æ­¥çš„åˆå§‹åŒ–æµç¨‹ï¼Œå®Œæˆä¹‹åè®¾ç½® `table_xxx.status='normal'` ã€‚

è¿™ä¸¤ä¸ªåœ¨Goé¡¹ç›®å¼€å‘ä¸­éå¸¸å¸¸è§ã€åŸºç¡€çš„åŠŸèƒ½éœ€æ±‚ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡ä½œä¸šç³»ç»Ÿæ¥å®ç°ã€‚IAMä¸ºäº†è§£å†³è¿™ç§å¸¸è§çš„åŠŸèƒ½éœ€æ±‚ï¼Œä¹Ÿå¼€å‘äº†è‡ªå·±çš„ä½œä¸šç³»ç»Ÿã€‚ä»Šå¤©è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ä¸‹IAMæ˜¯å¦‚ä½•å®ç°ä½œä¸šç³»ç»Ÿçš„ã€‚

## ä»»åŠ¡åˆ†ç±»

åœ¨ä»‹ç»ä½œä¸šç³»ç»Ÿä¹‹å‰ï¼Œè¿™é‡Œå…ˆæ¥çœ‹ä¸‹ä»»åŠ¡çš„åˆ†ç±»ã€‚ç†è§£ä»»åŠ¡çš„åˆ†ç±»ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç†è§£ä½œä¸šç³»ç»Ÿæ‰§è¡Œçš„ä»»åŠ¡ç±»å‹ï¼Œè¿›è€Œæœ‰åŠ©äºæˆ‘ä»¬è®¾è®¡ä½œä¸šç³»ç»Ÿã€‚

åœ¨æˆ‘çœ‹æ¥ï¼Œä»»åŠ¡å¯ä»¥åˆ†ä¸ºä¸‹é¢3ç±»ã€‚

+ å®šæ—¶ä»»åŠ¡ï¼šå®šæ—¶ä»»åŠ¡ä¼šåœ¨æŒ‡å®šçš„æ—¶é—´ç‚¹å›ºå®šæ‰§è¡Œã€‚åªè¦åˆ°è¾¾æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ç‚¹ï¼Œå°±ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œè€Œ**ä¸ç®¡ä¸Šä¸€æ¬¡ä»»åŠ¡æ˜¯å¦å®Œæˆ**ã€‚
+ é—´éš”ä»»åŠ¡ï¼š**ä¸Šä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œ**ï¼Œé—´éš”ä¸€æ®µæ—¶é—´ï¼ˆå¦‚5ç§’ã€5åˆ†é’Ÿï¼‰ï¼Œå†ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ã€‚
+ é—´éš”æ€§å®šæ—¶ä»»åŠ¡ï¼šé—´éš”ä»»åŠ¡çš„å˜ç§ï¼Œä»ä¸Šä¸€æ¬¡ä»»åŠ¡å¼€å§‹æ‰§è¡Œæ—¶è®¡æ—¶ï¼Œ**åªè¦é—´éš”æ—¶é—´ä¸€åˆ°**ï¼Œä¾¿æ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ï¼Œè€Œ**ä¸ç®¡ä¸Šä¸€æ¬¡ä»»åŠ¡æ˜¯å¦å®Œæˆ**ã€‚

å®šæ—¶ä»»åŠ¡å¥½ç†è§£ï¼Œä½†é—´éš”ä»»åŠ¡å’Œé—´éš”æ€§å®šæ—¶ä»»åŠ¡ä¸å¤ªå¥½åŒºåˆ†ï¼Œå®ƒä»¬çš„åŒºåˆ«æ˜¯ï¼šé—´éš”ä»»åŠ¡ä¼šç­‰å¾…ä¸Šä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œï¼Œé—´éš”ä¸€æ®µæ—¶é—´å†æ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ã€‚è€Œé—´éš”æ€§å®šæ—¶ä»»åŠ¡ä¸ä¼šç­‰å¾…ä¸Šä¸€æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œï¼Œåªè¦é—´éš”æ—¶é—´ä¸€åˆ°ï¼Œä¾¿æ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ã€‚

ä¸‰è€…çš„åŒºåˆ«å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/cf/dd/cf323871d6946c31a82de6679c1178dd.jpg?wh=1920x1266)](https://static001.geekbang.org/resource/image/cf/dd/cf323871d6946c31a82de6679c1178dd.jpg?wh=1920x1266)

åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™3ç±»ä»»åŠ¡çš„éœ€æ±‚ã€‚

## ä½œä¸šç³»ç»Ÿçš„å¸¸è§å®ç°

åœ¨å¼€å§‹ä»‹ç»IAMä½œä¸šç³»ç»Ÿå®ç°ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆä»‹ç»ä¸€ä¸‹å¦‚ä½•æ‰§è¡Œä¸€ä¸ªé—´éš”/å®šæ—¶ä»»åŠ¡ã€‚åªæœ‰äº†è§£äº†è¿™äº›ï¼Œæ‰èƒ½æ›´å¥½åœ°è®¾è®¡IAMçš„ä½œä¸šç³»ç»Ÿã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹4ç§æ–¹å¼ï¼Œæ¥æ‰§è¡Œä¸€ä¸ªé—´éš”/å®šæ—¶ä»»åŠ¡ï¼š

1. åŸºäº`time` åŒ…æä¾›çš„æ–¹æ³•ï¼ˆä¾‹å¦‚`time.Sleep`ã€`time.Ticker`ç­‰ ï¼‰è‡ªå·±å¼€å‘æ‰§è¡Œé—´éš”/å®šæ—¶ä»»åŠ¡çš„æœåŠ¡ã€‚
2. ä¸€äº›GoåŒ…æ”¯æŒæ‰§è¡Œé—´éš”/å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›GoåŒ…æ¥æ‰§è¡Œé—´éš”/å®šæ—¶ä»»åŠ¡ï¼Œå…å»äº†è‡ªå·±å¼€å‘ä½œä¸šè°ƒåº¦éƒ¨åˆ†çš„ä»£ç ï¼Œä¾‹å¦‚`github.com/robfig/cron` ã€‚
3. å€ŸåŠ©Linuxçš„crontabæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚
4. ä½¿ç”¨å¼€æºçš„ä½œä¸šç³»ç»Ÿï¼Œå¹¶é€šè¿‡ä½œä¸šç³»ç»Ÿæ¥æ‰§è¡Œé—´éš”/å®šæ—¶ä»»åŠ¡ï¼Œä¾‹å¦‚ [distribworks/dkron](https://github.com/distribworks/dkron)ã€‚

ä¸Šè¿°4ç§æ–¹æ³•ï¼Œæ¯ä¸€ç§éƒ½æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ã€‚é‡‡ç”¨ç¬¬ä¸€ç§æ–¹æ³•çš„è¯ï¼Œå› ä¸ºä¸€åˆ‡éƒ½è¦ä»0å¼€å§‹å®ç°ï¼Œå¼€å‘å·¥ä½œé‡å¤§ã€å¼€å‘æ•ˆç‡ä½ã€‚æˆ‘è®¤ä¸ºï¼Œå› ä¸ºå·²ç»æœ‰å¾ˆå¤šä¼˜ç§€çš„cronåŒ…å¯ä¾›ä½¿ç”¨äº†ï¼Œæ²¡å¿…è¦è‡ªå·±ä»0å¼€å‘ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›cronåŒ…æ¥æ‰§è¡Œå‘¨æœŸ/å®šæ—¶ä»»åŠ¡ã€‚IAMé¡¹ç›®ä¾¿é‡‡ç”¨äº†è¿™ç§æ–¹æ³•ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å…ˆä»‹ç»ä¸‹ç¬¬ä¸‰ç§å’Œç¬¬å››ç§æ–¹æ³•ï¼šä½¿ç”¨Linux crontabå’Œä½¿ç”¨å¼€æºçš„Goä½œä¸šç³»ç»Ÿã€‚ç„¶åï¼Œæˆ‘ä»¬å†æ¥é‡ç‚¹çœ‹çœ‹IAMé¡¹ç›®é‡‡ç”¨çš„ç¬¬äºŒç§æ–¹æ³•ã€‚

### Linux crontab

crontabæ˜¯Linuxç³»ç»Ÿè‡ªå¸¦çš„å®šæ—¶æ‰§è¡Œå·¥å…·ï¼Œå¯ä»¥åœ¨æ— éœ€äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹è¿è¡Œä½œä¸šã€‚crontabé€šè¿‡crondè¿›ç¨‹æ¥æä¾›æœåŠ¡ï¼Œcrondè¿›ç¨‹æ¯åˆ†é’Ÿä¼šå®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œè¯¥ä»»åŠ¡ã€‚crondè¿›ç¨‹é€šè¿‡è¯»å–crontabé…ç½®ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æœ‰ä»»åŠ¡æ‰§è¡Œï¼Œä»¥åŠä½•æ—¶æ‰§è¡Œã€‚

crondè¿›ç¨‹ä¼šåœ¨ä¸‹é¢è¿™3ä¸ªä½ç½®æŸ¥æ‰¾crontabé…ç½®æ–‡ä»¶ã€‚

+ `/var/spool/cron/`ï¼šè¯¥ç›®å½•å­˜æ”¾ç”¨æˆ·ï¼ˆåŒ…æ‹¬rootï¼‰çš„crontabä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡ä»¥ç™»å½•åå‘½åï¼Œæ¯”å¦‚ `colin` ç”¨æˆ·åˆ›å»ºçš„crontabä»»åŠ¡å¯¹åº”çš„æ–‡ä»¶å°±æ˜¯`/var/spool/cron/colin`ã€‚
+ `/etc/crontab`ï¼šè¯¥ç›®å½•å­˜æ”¾ç”±ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºå¹¶ç»´æŠ¤çš„crontabä»»åŠ¡ã€‚
+ `/etc/cron.d/`ï¼šè¯¥ç›®å½•å­˜æ”¾ä»»ä½•è¦æ‰§è¡Œçš„crontabä»»åŠ¡ã€‚cronè¿›ç¨‹æ‰§è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰«æè¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ŒæŒ‰ç…§æ–‡ä»¶ä¸­çš„æ—¶é—´è®¾å®šæ‰§è¡Œåé¢çš„å‘½ä»¤ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæƒ³æ‰§è¡Œä¸€ä¸ªcrontabä»»åŠ¡ï¼Œå°±éœ€è¦ç¡®ä¿crondè¿è¡Œï¼Œå¹¶é…ç½®crontabä»»åŠ¡ã€‚å…·ä½“åˆ†ä¸ºä»¥ä¸‹ä¸¤æ­¥ï¼š

**ç¬¬ä¸€æ­¥ï¼Œç¡®ä¿crondè¿›ç¨‹æ­£åœ¨è¿è¡Œã€‚**

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹crondè¿›ç¨‹è¿è¡ŒçŠ¶æ€ï¼š

```bash
$ systemctl status crondâ— crond.service - Command Scheduler   Loaded: loaded (/usr/lib/systemd/system/crond.service; enabled; vendor preset: enabled)   Active: active (running) since Wed 2021-11-17 07:11:27 CST; 2 days ago Main PID: 9182 (crond)    Tasks: 1   Memory: 728.0K   CGroup: /system.slice/crond.service           â””â”€9182 /usr/sbin/crond -n
```

`Active: active (running)`è¯´æ˜crondè¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå¦åˆ™å¯ä»¥æ‰§è¡Œ`systemctl start crond`å¯åŠ¨crondè¿›ç¨‹ã€‚

**ç¬¬äºŒæ­¥ï¼Œé…ç½®crontabä»»åŠ¡ã€‚**

å¯ä»¥é€šè¿‡`crontab -e`æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚æ‰§è¡Œ`crontab -e`åè¿›å…¥viäº¤äº’ç•Œé¢ï¼Œå¹¶é…ç½®ä»¥ä¸‹crontabä»»åŠ¡ï¼š

```bash
# æ¯åˆ†é’Ÿè¾“å‡ºæ—¶é—´åˆ°æ–‡ä»¶ /tmp/test.txt*  *  *  *  * echo date >> /tmp/test.txt# æ¯éš” 2 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡äº’è”ç½‘æ—¶é—´*/2 * * * * /usr/bin/ntpstat time.windows.com > /dev/null 2>&1
```

ç¼–è¾‘åçš„é…ç½®æ–‡ä»¶ä¿å­˜åœ¨`/var/spool/cron/$USER`æ–‡ä»¶ä¸­ã€‚ä½ å¯ä»¥é€šè¿‡`crontab -l`æˆ–è€…`sudo cat /var/spool/cron/$USER`æ¥æŸ¥çœ‹ï¼Œä¾‹å¦‚ï¼š

```bash
$ crontab -l# æ¯åˆ†é’Ÿè¾“å‡ºæ—¶é—´åˆ°æ–‡ä»¶/tmp/test.txt*  *  *  *  * echo date >> /tmp/test.txt# æ¯éš” 2 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡äº’è”ç½‘æ—¶é—´*/2 * * * * /usr/bin/ntpstat time.windows.com > /dev/null 2>&1
```

å¦‚æœæƒ³åˆ é™¤æ‰€æœ‰çš„crontabä»»åŠ¡ï¼Œä½ å¯ä»¥æ‰§è¡Œ`crontab -r`å‘½ä»¤ã€‚

é…ç½®çš„crontabä»»åŠ¡éœ€è¦éµå¾ªcrontabçš„æ—¶é—´æ ¼å¼ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```bash
.---------------- minute (0 - 59)    |  .------------- hour (0 - 23)    |  |  .---------- day of month (1 - 31)    |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...    |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat    |  |  |  |  |    *  *  *  *  * <command to be executed>
```

å¯ä»¥çœ‹åˆ°ï¼Œcrontabåªèƒ½ç²¾ç¡®åˆ°åˆ†é’Ÿï¼Œä¸èƒ½ç²¾ç¡®åˆ°ç§’ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„crontabæ—¶é—´æ ¼å¼ï¼Œä½ å¯ä»¥å‚è€ƒï¼Œæ¥åŠ æ·±ç†è§£ï¼š

```bash
# æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ <command>            * * * * * <command> # * ä»£è¡¨æ‰€æœ‰å¯èƒ½çš„å€¼# æ¯éš”ä¸€å°æ—¶æ‰§è¡Œä¸€æ¬¡ <command>* */1 * * * <command> # / è¡¨ç¤ºé¢‘ç‡# æ¯å°æ—¶çš„ 15 å’Œ 30 åˆ†å„æ‰§è¡Œä¸€æ¬¡ <command>15,45 * * * * <command> # , è¡¨ç¤ºå¹¶åˆ—# åœ¨æ¯å¤©ä¸Šåˆ 8- 11 æ—¶ä¸­é—´æ¯å°æ—¶ 15ï¼Œ45 åˆ†å„æ‰§è¡Œä¸€æ¬¡ <command>15,45 8-11 * * * <command> # - è¡¨ç¤ºèŒƒå›´# æ¯ä¸ªæ˜ŸæœŸä¸€çš„ä¸Šåˆ 8 ç‚¹åˆ° 11 ç‚¹çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ <command>3,15 8-11 * * 1 <command># æ¯éš”ä¸¤å¤©çš„ä¸Šåˆ 8 ç‚¹åˆ° 11 ç‚¹çš„ç¬¬ 3 å’Œç¬¬ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ <command>3,15 8-11 /2 * * <command>
```

*ä½¿ç”¨crontabæ‰§è¡Œå‘¨æœŸ/å®šæ—¶ä»»åŠ¡çš„ä¼˜ç‚¹æ˜¯ä¸ç”¨åšä»»ä½•å¼€å‘ï¼Œåªéœ€è¦é…ç½®crontabä»»åŠ¡å³å¯ã€‚è‡³äºç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œä¸»è¦æœ‰ä¸‹é¢è¿™å‡ ä¸ªï¼š*

+ *ä¸èƒ½ç²¾ç¡®åˆ°ç§’ã€‚*
+ *éœ€è¦æ‰‹åŠ¨ç¼–å†™å¯æ‰§è¡Œå‘½ä»¤ã€‚è¿™äº›å¯æ‰§è¡Œå‘½ä»¤è·Ÿé¡¹ç›®åˆ†ç¦»ï¼Œæ²¡åŠæ³•å¤ç”¨é¡¹ç›®æä¾›çš„åŒ…ã€å‡½æ•°ç­‰èƒ½åŠ›ã€‚å¦‚æœæƒ³æ‰§è¡Œè·Ÿé¡¹ç›®å…³ç³»ç´§å¯†çš„ä½œä¸šï¼Œå¼€å‘èµ·æ¥ä¸æ–¹ä¾¿ã€‚*
+ *å•ç‚¹ï¼Œå¦‚æœcrondè¿›ç¨‹å¼‚å¸¸ï¼Œå‘¨æœŸ/å®šæ—¶ä»»åŠ¡å°±æ²¡æ³•ç»§ç»­æ‰§è¡Œã€‚ä½ å¯èƒ½æƒ³è¯´ï¼šå¯ä»¥åœ¨ä¸¤å°æœºå™¨ä¸Šé…ç½®å¹¶æ‰§è¡Œç›¸åŒçš„å‘¨æœŸ/å®šæ—¶ä»»åŠ¡ã€‚ä½†æ˜¯è¿™æ ·åšä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºä¸¤å°æœºå™¨åŒæ—¶æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œå¯èƒ½ä¼šå½¼æ­¤é€ æˆå†²çªæˆ–çŠ¶æ€ä¸ä¸€è‡´ã€‚*
+ *æ²¡åŠæ³•å®ç°é—´éš”ä»»åŠ¡å’Œé—´éš”æ€§å®šæ—¶ä»»åŠ¡ã€‚*

### *ä½¿ç”¨å¼€æºçš„ä½œä¸šç³»ç»Ÿ*

*é™¤äº†ä½¿ç”¨Linuxç³»ç»Ÿè‡ªå¸¦çš„crontabä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸€äº›ä¸šç•Œä¼˜ç§€çš„å¼€æºä½œä¸šç³»ç»Ÿã€‚è¿™é‡Œï¼Œæˆ‘åˆ—å‡ºäº†ä¸€äº›æ¯”è¾ƒå—æ¬¢è¿çš„Goè¯­è¨€å¼€å‘çš„ä½œä¸šç³»ç»Ÿã€‚ä¹‹æ‰€ä»¥åªé€‰æ‹©Goè¯­è¨€å¼€å‘çš„é¡¹ç›®ï¼Œä¸€æ–¹é¢æ˜¯æƒ³ä¸°å¯Œä½ çš„Goè¯­è¨€ç”Ÿæ€ï¼Œå¦ä¸€æ–¹é¢ï¼ŒåŒç§è¯­è¨€ä¹Ÿæœ‰åŠ©äºä½ å­¦ä¹ ã€æ”¹é€ è¿™äº›é¡¹ç›®ã€‚*

+ *[distribworks/dkron](https://github.com/distribworks/dkron)ã€‚dkronæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¯åŠ¨è¿…é€Ÿã€å¸¦å®¹é”™æœºåˆ¶çš„å®šæ—¶ä½œä¸šç³»ç»Ÿï¼Œæ”¯æŒcrontabè¡¨è¾¾å¼ã€‚å®ƒå…·æœ‰ä¸‹é¢è¿™äº›æ ¸å¿ƒç‰¹æ€§ã€‚æ˜“ç”¨ï¼šå¯ä»¥é€šè¿‡æ˜“æ“ä½œã€æ¼‚äº®çš„Webç•Œé¢æ¥ç®¡ç†ä½œä¸šã€‚å¯é ï¼šå…·å¤‡å®¹é”™æœºåˆ¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ç»§ç»­æ‰§è¡Œä½œä¸šã€‚é«˜å¯æ‰©å±•æ€§ï¼šèƒ½å¤Ÿå¤„ç†å¤§é‡çš„è®¡åˆ’ä½œä¸šå’Œæ•°åƒä¸ªèŠ‚ç‚¹ã€‚*
+ *[ouqiang/gocron](https://github.com/ouqiang/gocron)ã€‚gocronæ˜¯å›½äººå¼€å‘çš„è½»é‡çº§å®šæ—¶ä»»åŠ¡é›†ä¸­è°ƒåº¦å’Œç®¡ç†ç³»ç»Ÿ, ç”¨äºæ›¿ä»£Linux-crontabã€‚å®ƒå…·æœ‰ä¸‹é¢è¿™äº›æ ¸å¿ƒç‰¹æ€§ã€‚å…·æœ‰Webç•Œé¢ç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚æ”¯æŒcrontabæ—¶é—´æ ¼å¼ï¼Œå¹¶ç²¾ç¡®åˆ°ç§’ã€‚æ”¯æŒshellå‘½ä»¤å’ŒHTTPè¯·æ±‚ä¸¤ç§ä»»åŠ¡æ ¼å¼ã€‚å…·æœ‰ä»»åŠ¡è¶…æ—¶æœºåˆ¶ã€ä»»åŠ¡ä¾èµ–æœºåˆ¶ã€ä»»åŠ¡æ‰§è¡Œå¤±è´¥å¯é‡è¯•æœºåˆ¶ã€‚æ”¯æŒæŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæ—¥å¿—ï¼Œå¹¶æ”¯æŒç”¨é‚®ä»¶ã€Slackã€Webhookç­‰æ–¹å¼é€šçŸ¥ä»»åŠ¡æ‰§è¡Œç»“æœã€‚*
+ *[shunfei/cronsun](https://github.com/shunfei/cronsun)ã€‚cronsun æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä½œä¸šç³»ç»Ÿï¼Œå•ä¸ªèŠ‚ç‚¹åŒ crontab è¿‘ä¼¼ã€‚å®ƒå…·æœ‰ä¸‹é¢è¿™äº›æ ¸å¿ƒç‰¹æ€§ã€‚å…·æœ‰Webç•Œé¢ï¼Œæ–¹ä¾¿å¯¹å¤šå°æœåŠ¡å™¨ä¸Šçš„å®šæ—¶ä»»åŠ¡è¿›è¡Œé›†ä¸­å¼ç®¡ç†ã€‚ä»»åŠ¡è°ƒåº¦æ—¶é—´ç²’åº¦æ”¯æŒåˆ°ç§’çº§åˆ«ã€‚ä»»åŠ¡æ‰§è¡Œå¤±è´¥å¯é‡è¯•ã€‚ä»»åŠ¡å¯é æ€§ä¿éšœï¼ˆä»Nä¸ªèŠ‚ç‚¹é‡Œé¢æŒ‘ä¸€ä¸ªå¯ç”¨èŠ‚ç‚¹æ¥æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚ä»»åŠ¡æ—¥å¿—æŸ¥çœ‹ã€‚ä»»åŠ¡å¤±è´¥é‚®ä»¶å‘Šè­¦ï¼ˆä¹Ÿæ”¯æŒè‡ªå®šä¹‰httpå‘Šè­¦æ¥å£ï¼‰ã€‚*

*é‚£ä¹ˆï¼Œè¿™ä¹ˆå¤šçš„å¼€æºé¡¹ç›®è¯¥å¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿè¿™é‡Œå»ºè®®ä½ é€‰æ‹© `distribworks/dkron` ã€‚åŸå› æ˜¯ `distribworks/dkron` Staræ•°å¾ˆå¤šï¼Œè€Œä¸”åŠŸèƒ½é½å…¨æ˜“ç”¨ã€æ–‡æ¡£ä¸°å¯Œã€‚å½“ç„¶ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œä½ æœ€å¥½ä¹Ÿå¯¹å…¶ä»–å¼€æºé¡¹ç›®è¿›è¡Œè°ƒç ”ï¼Œæ ¹æ®éœ€è¦é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆè‡ªå·±çš„å¼€æºé¡¹ç›®ã€‚*

*ä½¿ç”¨è¿™äº›ä½œä¸šç³»ç»Ÿçš„ä¼˜ç‚¹æ˜¯ä¸ç”¨å¼€å‘ã€åŠŸèƒ½æ¯”crontabæ›´å¼ºå¤§ï¼Œæœ‰äº›è¿˜æ˜¯åˆ†å¸ƒå¼çš„ä½œä¸šç³»ç»Ÿï¼Œå…·å¤‡å®¹ç¾èƒ½åŠ›ã€‚ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼š*

+ *è¿™äº›ä½œä¸šç³»ç»Ÿæ”¯æŒçš„ä»»åŠ¡ç§ç±»æœ‰é™ï¼Œæ¯”å¦‚ä¸€èˆ¬ä¼šæ”¯æŒé€šè¿‡shellè„šæœ¬åŠå‘é€HTTPè¯·æ±‚çš„æ–¹å¼æ¥æ‰§è¡Œä»»åŠ¡ã€‚ä¸ç®¡å“ªç§æ–¹å¼ï¼Œå®ç°éƒ½è·Ÿé¡¹ç›®åˆ†ç¦»ï¼Œåœ¨å¼€å‘è·Ÿé¡¹ç›®ç»“åˆç´§å¯†çš„ä»»åŠ¡æ’ä»¶æ—¶ä¸æ˜¯å¾ˆç®€å•ã€é«˜æ•ˆã€‚*
+ *å¾ˆå¤šæ—¶å€™æˆ‘ä»¬åªä¼šä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†èƒ½åŠ›ï¼Œæˆ–è€…ä»…æœ‰ä¸€åˆ°ä¸¤ä¸ªé¡¹ç›®ä¼šä½¿ç”¨åˆ°è¿™ç±»ç³»ç»Ÿï¼Œä½†æˆ‘ä»¬è¿˜è¦éƒ¨ç½²å¹¶ç»´æŠ¤è¿™äº›ä½œä¸šç³»ç»Ÿï¼Œå·¥ä½œé‡å¤§ï¼Œæ”¶ç›Šå°ã€‚*
+ *æ²¡åŠæ³•å®ç°é—´éš”ä»»åŠ¡ã€‚*

*ä½¿ç”¨Linuxçš„crontabå’Œä½¿ç”¨å¼€æºçš„Goä½œä¸šç³»ç»Ÿï¼Œè¿™ä¸¤ç§æ–¹æ³•çš„ç¼ºç‚¹éƒ½å¾ˆæ˜æ˜¾ã€‚é‰´äºè¿™äº›ç¼ºç‚¹ï¼ŒIAMç³»ç»Ÿé€‰æ‹©ä½¿ç”¨ç°æœ‰çš„cronåº“å°è£…è‡ªå·±çš„ä»»åŠ¡æ¡†æ¶ï¼Œå¹¶åŸºäºè¿™ä¸ªæ¡†æ¶å¼€å‘ä»»åŠ¡ã€‚IAMé¡¹ç›®é€‰æ‹©äº†[robfig/cron](https://github.com/robfig/cron)åº“ï¼ŒåŸå› æ˜¯cronåº“Staræ•°æœ€å¤šï¼Œä¸”åŠŸèƒ½ä¸°å¯Œã€ä½¿ç”¨ç®€å•ã€‚å¦å¤–IAMè¿˜ä½¿ç”¨`github.com/go-redsync/redsync`å®ç°äº†åŸºäºRedisçš„åˆ†å¸ƒå¼äº’æ–¥é”ã€‚æ‰€ä»¥ï¼Œåœ¨å¼€å§‹ä»‹ç»IAMä½œä¸šç³»ç»Ÿå®ç°å‰ï¼Œæˆ‘å…ˆæ¥ç®€å•ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ä¸ªåŒ…ã€‚*

## *`github.com/robfig/cron`ä½¿ç”¨ä»‹ç»*

*`github.com/robfig/cron`æ˜¯ä¸€ä¸ªå¯ä»¥å®ç°ç±»ä¼¼Linux crontabå®šæ—¶ä»»åŠ¡çš„cronåŒ…ï¼Œä½†æ˜¯cronåŒ…æ”¯æŒåˆ°ç§’ã€‚*

### *cronåŒ…æ”¯æŒçš„æ—¶é—´æ ¼å¼*

*cronåŒ…æ”¯æŒcrontabæ ¼å¼å’Œå›ºå®šé—´éš”æ ¼å¼è¿™ä¸¤ç§æ—¶é—´æ ¼å¼ï¼Œä¸‹é¢æˆ‘æ¥åˆ†åˆ«ä»‹ç»ä¸‹ã€‚*

*crontabæ ¼å¼çš„æ—¶é—´æ ¼å¼ï¼Œæ”¯æŒçš„åŒ¹é…ç¬¦è·Ÿcrontabä¿æŒä¸€è‡´ã€‚æ—¶é—´æ ¼å¼å¦‚ä¸‹ï¼š*

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€second èŒƒå›´ (0 - 60) â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ min (0 - 59) â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23) â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31) â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12) â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of week (0 - 6) (0 to 6 are Sunday to â”‚ â”‚ â”‚ â”‚ â”‚ â”‚                  Saturday) â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ * * * * * *   
```

*ç¬¬äºŒç§æ˜¯å›ºå®šé—´éš”æ ¼å¼ï¼Œä¾‹å¦‚`@every <duration>`ã€‚`duration`æ˜¯ä¸€ä¸ªå¯ä»¥è¢«`time.ParseDuration`è§£æçš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚`@every 1h30m10s`è¡¨ç¤ºä»»åŠ¡æ¯éš”1å°æ—¶30åˆ†10ç§’ä¼šè¢«æ‰§è¡Œã€‚è¿™é‡Œè¦æ³¨æ„ï¼Œé—´éš”ä¸è€ƒè™‘ä»»åŠ¡çš„è¿è¡Œæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä»»åŠ¡éœ€è¦3åˆ†é’Ÿè¿è¡Œï¼Œå¹¶ä¸”è®¡åˆ’æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼Œåˆ™æ¯æ¬¡è¿è¡Œä¹‹é—´åªæœ‰2åˆ†é’Ÿçš„ç©ºé—²æ—¶é—´ã€‚*

### *cronåŒ…ä½¿ç”¨ç¤ºä¾‹*

*cronåŒ…çš„ä½¿ç”¨æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼š*

```go
package mainimport (	"fmt"	"github.com/robfig/cron/v3")func helloCron() {	fmt.Println("hello cron")}func main() {	fmt.Println("starting go cron...")	// åˆ›å»ºä¸€ä¸ªcronå®ä¾‹	cron := cron.New(cron.WithSeconds(), cron.WithChain(cron.SkipIfStillRunning(nil), cron.Recover(nil)))	// æ·»åŠ ä¸€ä¸ªå®šæ—¶ä»»åŠ¡	cron.AddFunc("  *  *  *  *  *", helloCron)	// å¯åŠ¨è®¡åˆ’ä»»åŠ¡	cron.Start()	// å…³é—­ç€è®¡åˆ’ä»»åŠ¡, ä½†æ˜¯ä¸èƒ½å…³é—­å·²ç»åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡.	defer cron.Stop()	select {} // æŸ¥è¯¢è¯­å¥ï¼Œä¿æŒç¨‹åºè¿è¡Œï¼Œåœ¨è¿™é‡Œç­‰åŒäºfor{}}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé€šè¿‡ `cron.New` å‡½æ•°è°ƒç”¨åˆ›å»ºäº†ä¸€ä¸ª `cron` å®ä¾‹ï¼›æ¥ä¸‹æ¥é€šè¿‡ `cron` å®ä¾‹çš„ `AddFunc` æ–¹æ³•ï¼Œç»™ `cron` å®ä¾‹æ·»åŠ äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼šæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ `helloCron` å‡½æ•°ï¼›æœ€åé€šè¿‡ `cron` å®ä¾‹çš„ `Start` æ–¹æ³•å¯åŠ¨å®šæ—¶ä»»åŠ¡ã€‚åœ¨ç¨‹åºé€€å‡ºæ—¶ï¼Œè¿˜æ‰§è¡Œäº† `cron.Stop()` å…³é—­å®šæ—¶ä»»åŠ¡ã€‚

### æ‹¦æˆªå™¨

cronåŒ…è¿˜æ”¯æŒå®‰è£…ä¸€äº›æ‹¦æˆªå™¨ï¼Œè¿™äº›æ‹¦æˆªå™¨å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

+ ä»ä»»åŠ¡çš„panicä¸­æ¢å¤ï¼ˆ`cron.Recover()`ï¼‰ã€‚
+ å¦‚æœä¸Šä¸€æ¬¡ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™å»¶è¿Ÿä¸‹ä¸€æ¬¡ä»»åŠ¡çš„æ‰§è¡Œï¼ˆ`cron.DelayIfStillRunning()`ï¼‰ã€‚
+ å¦‚æœä¸Šä¸€æ¬¡ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™è·³è¿‡ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„æ‰§è¡Œï¼ˆ`cron.SkipIfStillRunning()`ï¼‰ã€‚
+ è®°å½•æ¯ä¸ªä»»åŠ¡çš„è°ƒç”¨ï¼ˆ`cron.WithLogger()`ï¼‰ã€‚
+ ä»»åŠ¡å®Œæˆæ—¶é€šçŸ¥ã€‚

å¦‚æœæƒ³ä½¿ç”¨è¿™äº›æ‹¦æˆªå™¨ï¼Œåªéœ€è¦åœ¨åˆ›å»ºcronå®ä¾‹æ—¶ï¼Œä¼ å…¥ç›¸åº”çš„Optionå³å¯ï¼Œä¾‹å¦‚ï¼š

```go
cron := cron.New(cron.WithSeconds(), cron.WithChain(cron.SkipIfStillRunning(nil), cron.Recover(nil)))
```

## `github.com/go-redsync/redsync`ä½¿ç”¨ä»‹ç»

redsyncå¯ä»¥å®ç°åŸºäºRedisçš„åˆ†å¸ƒå¼é”ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š

```go
package mainimport (	goredislib "github.com/go-redis/redis/v8"	"github.com/go-redsync/redsync/v4"	"github.com/go-redsync/redsync/v4/redis/goredis/v8")func main() {	// Create a pool with go-redis (or redigo) which is the pool redisync will	// use while communicating with Redis. This can also be any pool that	// implements the redis.Pool interface.	client := goredislib.NewClient(&goredislib.Options{		Addr: "localhost:6379",	})	pool := goredis.NewPool(client) // or, pool := redigo.NewPool(...)	// Create an instance of redisync to be used to obtain a mutual exclusion	// lock.	rs := redsync.New(pool)	// Obtain a new mutex by using the same name for all instances wanting the	// same lock.	mutexname := "my-global-mutex"	mutex := rs.NewMutex(mutexname)	// Obtain a lock for our given mutex. After this is successful, no one else	// can obtain the same lock (the same mutex name) until we unlock it.	if err := mutex.Lock(); err != nil {		panic(err)	}	// Do your work that requires the lock.	// Release the lock so other processes or threads can obtain a lock.	if ok, err := mutex.Unlock(); !ok || err != nil {		panic("unlock failed")	}}
```

ä¸Šé¢çš„ä»£ç ï¼Œåˆ›å»ºäº†ä¸€ä¸ª `redsync.Redsync` å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ `redsync.Redsync` æä¾›çš„ `NewMutex` æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªåˆ†å¸ƒå¼é”å®ä¾‹ `mutex`ã€‚é€šè¿‡ `mutex.Lock()` åŠ é”ï¼Œé€šè¿‡ `mutex.Unlock()` é‡Šæ”¾é”ã€‚

## IAMä½œä¸šç³»ç»Ÿç‰¹ç‚¹

åœ¨å¼€å‘IAMçš„ä½œä¸šç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ¢³ç†å¥½IAMè¦å®ç°çš„ä»»åŠ¡ã€‚IAMéœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªé—´éš”ä»»åŠ¡ï¼š

+ æ¯éš”ä¸€æ®µæ—¶é—´ä» `policy_audit` è¡¨ä¸­æ¸…ç†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æˆæƒç­–ç•¥ã€‚
+ æ¯éš”ä¸€æ®µæ—¶é—´ç¦ç”¨è¶…è¿‡æŒ‡å®šå¤©æ•°æ²¡æœ‰ç™»å½•çš„ç”¨æˆ·ã€‚

ç»“åˆä¸Šé¢æåˆ°çš„ä½œä¸šç³»ç»Ÿçš„ç¼ºç‚¹ï¼Œè¿™é‡Œå°†æˆ‘ä»¬éœ€è¦è®¾è®¡çš„ä½œä¸šç³»ç»Ÿçš„ç‰¹ç‚¹æ€»ç»“å¦‚ä¸‹ï¼š

+ åˆ†å¸ƒå¼çš„ä½œä¸šç³»ç»Ÿï¼Œå½“æœ‰å¤šä¸ªå®ä¾‹æ—¶ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰1ä¸ªå®ä¾‹åœ¨å·¥ä½œã€‚
+ è·Ÿé¡¹ç›®å¥‘åˆç´§å¯†ï¼Œèƒ½å¤Ÿæ–¹ä¾¿åœ°å¤ç”¨é¡¹ç›®æä¾›çš„åŒ…ã€å‡½æ•°ç­‰èƒ½åŠ›ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚
+ èƒ½å¤Ÿæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€é—´éš”ä»»åŠ¡ã€é—´éš”æ€§å®šæ—¶ä»»åŠ¡è¿™3ç§ç±»å‹çš„ä»»åŠ¡ã€‚
+ å¯æ’ä»¶åŒ–åœ°åŠ å…¥æ–°çš„å‘¨æœŸ/å®šæ—¶ä»»åŠ¡ã€‚

## IAMä½œä¸šç³»ç»Ÿå®ç°

ä»‹ç»å®ŒIAMä½œä¸šç³»ç»Ÿä½¿ç”¨åˆ°çš„ä¸¤ä¸ªGoåŒ…å’ŒIAMä½œä¸šç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œä¸‹é¢æˆ‘æ¥æ­£å¼è®²è§£IAMä½œä¸šç³»ç»Ÿçš„å®ç°ã€‚

IAMçš„ä½œä¸šç³»ç»ŸæœåŠ¡åå«iam-watcherã€‚watcheræ˜¯è§‚å¯Ÿè€…çš„æ„æ€ï¼Œé‡Œé¢çš„ä»»åŠ¡ä¸»è¦æ˜¯æ„ŸçŸ¥ä¸€äº›çŠ¶æ€ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼Œæ‰€ä»¥å«watcherã€‚iam-watcher mainå‡½æ•°ä½äº[cmd/iam-watcher/watcher.go](https://github.com/marmotedu/iam/blob/v1.2.0/cmd/iam-watcher/watcher.go)æ–‡ä»¶ä¸­ã€‚åº”ç”¨æ¡†æ¶è·Ÿiam-apiserverã€iam-authz-serverã€iam-pumpä¿æŒé«˜åº¦ä¸€è‡´ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»äº†ã€‚

æ•´ä¸ªiam-watcheræœåŠ¡çš„æ ¸å¿ƒå®ç°ä½äº[internal/watcher/server.go](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/server.go)æ–‡ä»¶ä¸­ï¼Œåœ¨server.goæ–‡ä»¶ä¸­è°ƒç”¨äº†[newWatchJob](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher.go#L33)ï¼Œåˆ›å»ºäº†ä¸€ä¸ª`github.com/robfig/cron.Cron`ç±»å‹çš„cronå®ä¾‹ï¼Œ`newWatchJob` ä»£ç å¦‚ä¸‹ï¼š

```go
func newWatchJob(redisOptions *genericoptions.RedisOptions, watcherOptions *options.WatcherOptions) *watchJob {        logger := cronlog.NewLogger(log.SugaredLogger())                                                                   client := goredislib.NewClient(&goredislib.Options{                             Addr:     fmt.Sprintf("%s:%d", redisOptions.Host, redisOptions.Port),            Username: redisOptions.Username,                                                 Password: redisOptions.Password,        })                                                                      pool := goredis.NewPool(client)                                                                                rs := redsync.New(pool)                                                    cron := cron.New(                                                                     cron.WithSeconds(),                             cron.WithChain(cron.SkipIfStillRunning(logger), cron.Recover(logger)),                                          )                                                                                 return &watchJob{                                                     Cron:   cron,                                                                    config: watcherOptions,                                                           rs:     rs,                                 }                                                             }
```

ä¸Šè¿°ä»£ç åˆ›å»ºäº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„å®ä¾‹ã€‚

+ `github.com/robfig/cron.Cron`ï¼šåŸºäº`github.com/robfig/cron`åŒ…å®ç°çš„ä½œä¸šç³»ç»Ÿï¼Œå¯ä»¥æ”¯æŒå®šæ—¶ä»»åŠ¡ã€é—´éš”ä»»åŠ¡ã€é—´éš”æ€§å®šæ—¶ä»»åŠ¡ 3ç§ç±»å‹çš„ä»»åŠ¡ã€‚
+ `github.com/go-redsync/redsync.Redsync`ï¼šåŸºäºRedisçš„åˆ†å¸ƒå¼äº’æ–¥é”ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåˆ›å»ºcronå®ä¾‹æ—¶éœ€è¦å¢åŠ `cron.SkipIfStillRunning()` Optionï¼Œ`SkipIfStillRunning`å¯ä»¥ä½¿cronä»»åŠ¡åœ¨ä¸Šä¸€ä¸ªä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæ—¶ï¼Œè·³è¿‡ä¸‹ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œï¼Œä»¥æ­¤å®ç°é—´éš”ä»»åŠ¡çš„æ•ˆæœã€‚

åˆ›å»ºå®ä¾‹åï¼Œé€šè¿‡[addWatchers()](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher.go)æ¥æ³¨å†Œcronä»»åŠ¡ã€‚`addWatchers` å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š

```go
func (w *watchJob) addWatchers() watchJob {                                for name, watcher := range watcher.ListWatchers() {        // log with {"watcher": "counter"} key-value to distinguish which watcher the log comes from.        ctx := context.WithValue(context.Background(), log.KeyWatcherName, name)        if err := watcher.Init(ctx, w.rs.NewMutex(name, redsync.WithExpiry(2time.Hour)), w.config); err != nil {            log.Panicf("construct watcher %s failed: %s", name, err.Error())            }                                                                      _, _ = w.AddJob(watcher.Spec(), watcher)                                }               return w                                    }  
```

ä¸Šè¿°å‡½æ•°ä¼šè°ƒç”¨`watcher.ListWatchers()`åˆ—å‡ºæ‰€æœ‰çš„watcherï¼Œå¹¶åœ¨forå¾ªç¯ä¸­å°†è¿™äº›watcheræ·»åŠ åˆ°cronè°ƒåº¦å¼•æ“ä¸­ã€‚watcherå®šä¹‰å¦‚ä¸‹ï¼š

```go
type IWatcher interface {                                                   Init(ctx context.Context, rs *redsync.Mutex, config interface{}) error    Spec() string                                                                                          cron.Job                                                                    }type Job interface {                                                        Run()                                                                 }
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªwatcheræ˜¯å®ç°äº†ä»¥ä¸‹3ä¸ªæ–¹æ³•çš„ç»“æ„ä½“ï¼š

+ `Init()`ï¼Œç”¨æ¥åˆå§‹åŒ–wactherã€‚
+ `Spec()`ï¼Œç”¨æ¥è¿”å›Cronå®ä¾‹çš„æ—¶é—´æ ¼å¼ï¼Œæ”¯æŒLinux crontabæ—¶é—´æ ¼å¼å’Œ`@every 1d`ç±»å‹çš„æ—¶é—´æ ¼å¼ã€‚
+ `Run()`ï¼Œç”¨æ¥è¿è¡Œä»»åŠ¡ã€‚

IAMå®ç°äº†ä¸¤ä¸ªwatcherï¼š

+ [task](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/task/watcher.go)ï¼šç¦ç”¨è¶…è¿‡`X`å¤©è¿˜æ²¡æœ‰ç™»å½•è¿‡çš„ç”¨æˆ·ï¼Œ`X`å¯ç”±iam-watcher.yamlé…ç½®æ–‡ä»¶ä¸­çš„`watcher.task.max-inactive-days`é…ç½®é¡¹æ¥é…ç½®ã€‚
+ [clean](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/clean/watcher.go)ï¼šæ¸…é™¤`policy_audit`è¡¨ä¸­è¶…è¿‡`X`å¤©æ•°åçš„æˆæƒç­–ç•¥ï¼Œ`X`å¯ç”±iam-watcher.yamlé…ç½®æ–‡ä»¶ä¸­çš„`watcher.clean.max-reserve-days`é…ç½®é¡¹æ¥é…ç½®ã€‚
  åˆ›å»ºå®Œcronå®ä¾‹åï¼Œå°±å¯ä»¥åœ¨[Runå‡½æ•°](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/server.go#L62)ä¸­å¯åŠ¨cronä»»åŠ¡ã€‚Runå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š

```plain
func (s preparedWatcherServer) Run() error {	stopCh := make(chan struct{})	s.gs.AddShutdownCallback(shutdown.ShutdownFunc(func(string) error {		// wait for running jobs to complete.		ctx := s.cron.Stop()		select {		case <-ctx.Done():			log.Info("cron jobs stopped.")		case <-time.After(3 * time.Minute):			log.Error("context was not done after 3 minutes.")		}		stopCh <- struct{}{}		return nil	}))	// start shutdown managers	if err := s.gs.Start(); err != nil {		log.Fatalf("start shutdown manager failed: %s", err.Error())	}	log.Info("star to run cron jobs.")	s.cron.Start()	// blocking here via channel to prevents the process exit.	<-stopCh	return nil}
```

ä¸Šè¿°ä»£ç ï¼Œé€šè¿‡`s.cron.Start()`ä»£ç è°ƒç”¨æ¥å¯åŠ¨cronå®ä¾‹ï¼Œæ‰§è¡Œcronä»»åŠ¡ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¼˜é›…å…³åœåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å½“ç¨‹åºç»“æŸæ—¶ï¼Œç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä½œä¸šéƒ½ç»“æŸåï¼Œå†ç»ˆæ­¢è¿›ç¨‹ã€‚`s.cron.Stop()`ä¼šè¿”å›`context.Context`ç±»å‹çš„å˜é‡ï¼Œç”¨æ¥å‘ŠçŸ¥è°ƒç”¨è€…cronä»»åŠ¡ä½•æ—¶ç»“æŸï¼Œä»¥ä½¿è°ƒç”¨è€…ç»ˆæ­¢è¿›ç¨‹ã€‚åœ¨cronä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•æˆ–è€…è¶…æ—¶3åˆ†é’Ÿåï¼Œä¼šå¾€ `stopCh` é€šé“ä¸­å†™å…¥ä¸€æ¡messageï¼Œ`<-stopCh` ä¼šç»“æŸé˜»å¡çŠ¶æ€ï¼Œè¿›è€Œé€€å‡ºiam-watcherè¿›ç¨‹ã€‚

## task watcherå®ç°è§£è¯»

task watcherçš„å®ç°ä½äº[internal/watcher/watcher/task/watcher.go](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/task/watcher.go)æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª`taskWatcher`ç»“æ„ä½“ï¼š

```go
type taskWatcher struct {        ctx             context.Context        mutex           *redsync.Mutex        maxInactiveDays int          }
```

`taskWatcher`å®ç°äº†[IWatcher](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/registry.go#L17)æ¥å£ã€‚åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œé€šè¿‡ `init` å‡½æ•°å°†`taskWatcher`æ³¨å†Œåˆ°[internal/watcher/watcher/registry.go](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/registry.go)ä¸­å®šä¹‰çš„å…¨å±€å˜é‡`registry`ä¸­ï¼Œé€šè¿‡`func ListWatchers() map[string]IWatcher`å‡½æ•°è¿”å›æ‰€æœ‰æ³¨å†Œçš„watcherã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæ‰€æœ‰çš„watcheråœ¨`internal/watcher/watcher/all/all.go`æ–‡ä»¶ä¸­ä»¥åŒ¿ååŒ…çš„å½¢å¼è¢«å¯¼å…¥ï¼Œä»è€Œè§¦å‘watcheræ‰€åœ¨åŒ…çš„initå‡½æ•°çš„æ‰§è¡Œã€‚initå‡½æ•°é€šè¿‡è°ƒç”¨`watcher.Register("clean", &cleanWatcher{})`å°†watcheræ³¨å†Œåˆ°`registry`å˜é‡ä¸­ã€‚`all.go`æ–‡ä»¶ä¸­å¯¼å…¥åŒ¿ååŒ…ä»£ç å¦‚ä¸‹ï¼š

```go
import (                                                               _ "github.com/marmotedu/iam/internal/watcher/watcher/clean"        _ "github.com/marmotedu/iam/internal/watcher/watcher/task"    )  
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œä¸éœ€è¦ä¿®æ”¹ä»»ä½•iam-watcherçš„æ¡†æ¶ä»£ç ï¼Œå°±å¯ä»¥æ’ä»¶åŒ–åœ°æ³¨å†Œä¸€ä¸ªæ–°çš„watcherã€‚ä¸æ”¹åŠ¨iam-watcherçš„ä¸»ä½“ä»£ç ï¼Œèƒ½å¤Ÿä½¿æˆ‘ä»¬ä»¥æœ€å°çš„æ”¹åŠ¨æ·»åŠ ä¸€ä¸ªæ–°çš„watcherã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ª `cleansecret` watcherï¼Œåªéœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤æ­¥å³å¯ï¼š

1. åœ¨`internal/watcher/watcher`ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª`cleansecret`ç›®å½•ï¼Œå¹¶å®ç°`cleanSecretWatcher`ã€‚
2. åœ¨`internal/watcher/watcher/all/all.go`æ–‡ä»¶ä¸­ä»¥åŒ¿åçš„å½¢å¼å¯¼å…¥`github.com/marmotedu/iam/internal/watcher/watcher/cleansecret`åŒ…ã€‚
   åœ¨`taskWatcher`çš„[Run()](https://github.com/marmotedu/iam/blob/v1.2.0/internal/watcher/watcher/task/watcher.go#L27)æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä»¥ä¸‹ä»£ç ï¼Œæ¥ç¡®ä¿å³ä½¿æœ‰å¤šä¸ªiam-watcherå®ä¾‹ï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªtask watcheråœ¨æ‰§è¡Œï¼š

```go
    if err := tw.mutex.Lock(); err != nil {                       log.L(tw.ctx).Info("taskWatcher already run.")            return        }                     defer func() {                                              if _, err := tw.mutex.Unlock(); err != nil {                log.L(tw.ctx).Errorf("could not release taskWatcher lock. err: %v", err)                return            }        }()
```

æˆ‘ä»¬åœ¨`taskWatcher`çš„`Run()`æ–¹æ³•ä¸­ï¼ŒæŸ¥è¯¢å‡ºæ‰€æœ‰çš„ç”¨æˆ·ï¼Œå¹¶å¯¹æ¯”`loginedAt`å­—æ®µä¸­è®°å½•çš„æ—¶é—´å’Œå½“å‰æ—¶é—´ï¼Œæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ç¦æ­¢ç”¨æˆ·ã€‚`loginedAt`å­—æ®µè®°å½•äº†ç”¨æˆ·æœ€åä¸€æ¬¡ç™»å½•çš„æ—¶é—´ã€‚

é€šè¿‡task watcherçš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ°ï¼šåœ¨task watcherä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†IAMé¡¹ç›®æä¾›çš„`mysql.GetMySQLFactoryOr`å‡½æ•°ã€logåŒ…ï¼Œä»¥åŠOptionsé…ç½®ï¼Œè¿™ä½¿æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¼€å‘ä¸€ä¸ªè·Ÿé¡¹ç›®ç´§å¯†ç›¸å…³çš„ä»»åŠ¡ã€‚

## æ€»ç»“

åœ¨Goé¡¹ç›®å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šéœ€è¦æ‰§è¡Œä¸€äº›é—´éš”/å®šæ—¶ä»»åŠ¡ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªä½œä¸šç³»ç»Ÿã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Linuxæä¾›çš„crontabæ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œè¿˜å¯ä»¥è‡ªå·±æ­å»ºä¸€ä¸ªä½œä¸šç³»ç»Ÿï¼Œå¹¶åœ¨ä¸Šé¢æ‰§è¡Œæˆ‘ä»¬çš„é—´éš”/å®šæ—¶ä»»åŠ¡ã€‚ä½†è¿™äº›æ–¹æ³•éƒ½æœ‰ä¸€äº›ç¼ºç‚¹ï¼Œæ¯”å¦‚è·Ÿé¡¹ç›®ç‹¬ç«‹ã€æ— æ³•æ‰§è¡Œé—´éš”ä»»åŠ¡ç­‰ã€‚æ‰€ä»¥ï¼Œè¿™æ—¶å€™æ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯åŸºäºå¼€æºçš„ä¼˜ç§€cronåŒ…ï¼Œæ¥å®ç°ä¸€ä¸ªä½œä¸šç³»ç»Ÿï¼Œå¹¶åŸºäºè¿™ä¸ªä½œä¸šç³»ç»Ÿå¼€å‘ä»»åŠ¡æ’ä»¶ã€‚

IAMåŸºäº`github.com/robfig/cron`åŒ…å’Œ`github.com/go-redsync/redsync`åŒ…ï¼Œå®ç°äº†è‡ªå·±çš„åˆ†å¸ƒå¼ä½œä¸šç³»ç»Ÿiam-watcherã€‚iam-watcherå¯ä»¥æ’ä»¶åŒ–åœ°æ·»åŠ å®šæ—¶ä»»åŠ¡ã€é—´éš”ä»»åŠ¡ã€é—´éš”æ€§å®šæ—¶ä»»åŠ¡ã€‚è‡³äºå®ƒçš„å…·ä½“å®ç°ï¼Œä½ å¯ä»¥è·Ÿè¯»iam-watcheræœåŠ¡çš„ä»£ç ï¼Œå…¶mainå‡½æ•°ä½äº[cmd/iam-watcher/watcher.go](https://github.com/marmotedu/iam/blob/v1.2.0/cmd/iam-watcher/watcher.go)æ–‡ä»¶ä¸­ã€‚

## è¯¾åç»ƒä¹ 

1. æ€è€ƒä¸€ä¸‹ï¼šåœ¨æ—¥å¸¸å·¥ä½œä¸­ï¼Œé™¤äº†å®šæ—¶ä»»åŠ¡ã€é—´éš”ä»»åŠ¡ã€é—´éš”æ€§å®šæ—¶ä»»åŠ¡å¤–ï¼Œè¿˜æœ‰æ²¡æœ‰å…¶ä»–ç±»å‹çš„ä»»åŠ¡éœ€æ±‚ï¼Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºåˆ†äº«ã€‚
2. å°è¯•å®ç°ä¸€ä¸ªæ–°çš„watcherï¼Œç”¨æ¥ä»secretè¡¨ä¸­åˆ é™¤è¿‡æœŸçš„secretã€‚
   æ¬¢è¿ä½ åœ¨ç•™è¨€åŒºä¸æˆ‘äº¤æµè®¨è®ºã€‚å¦‚æœè¿™ä¸€è®²å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™ä½ èº«è¾¹çš„æœ‹å‹ã€‚



## END é“¾æ¥
<ul><li><div><a href = '47.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '49.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

