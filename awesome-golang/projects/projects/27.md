+ [ğŸ”¥ å¼€æºåœ°å€](https://github.com/cubxxw/iam)

# ç¬¬27èŠ‚ æ•ˆç‡ç¥å™¨ï¼šå¦‚ä½•è®¾è®¡å’Œå®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ï¼Ÿ

<br>

<div><a href = '26.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '28.md' style='float: right'>  â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div>
<br>

> â¤ï¸ğŸ’•ğŸ’•During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:[http://nsddd.top](http://nsddd.top/)

---
[[TOC]]
[TOC]

## å¼€å§‹

ä½ å¥½ï¼Œæˆ‘æ˜¯å­”ä»¤é£ã€‚ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·ã€‚

å¦‚æœä½ ç”¨è¿‡Kubernetesã€Istioã€etcdï¼Œé‚£ä½ ä¸€å®šç”¨è¿‡è¿™äº›å¼€æºé¡¹ç›®æ‰€æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼škubectlã€istioctlã€etcdctlã€‚ä¸€ä¸ª `xxx` é¡¹ç›®ï¼Œä¼´éšç€ä¸€ä¸ª `xxxctl` å‘½ä»¤è¡Œå·¥å…·ï¼Œè¿™ä¼¼ä¹å·²ç»æˆä¸ºä¸€ç§è¶‹åŠ¿ï¼Œåœ¨ä¸€äº›å¤§å‹ç³»ç»Ÿä¸­æ›´æ˜¯å¸¸è§ã€‚æä¾› `xxxctl` å‘½ä»¤è¡Œå·¥å…·æœ‰è¿™ä¸¤ä¸ªå¥½å¤„ï¼š

+ å®ç°è‡ªåŠ¨åŒ–ï¼šå¯ä»¥é€šè¿‡åœ¨è„šæœ¬ä¸­è°ƒç”¨ `xxxctl` å·¥å…·ï¼Œå®ç°è‡ªåŠ¨åŒ–ã€‚
+ æé«˜æ•ˆç‡ï¼šé€šè¿‡å°†åº”ç”¨çš„åŠŸèƒ½å°è£…æˆå‘½ä»¤å’Œå‚æ•°ï¼Œæ–¹ä¾¿è¿ç»´ã€å¼€å‘äººå‘˜åœ¨LinuxæœåŠ¡å™¨ä¸Šè°ƒç”¨ã€‚

å…¶ä¸­ï¼Œkubectlå‘½ä»¤è®¾è®¡çš„åŠŸèƒ½æœ€ä¸ºå¤æ‚ï¼Œä¹Ÿæ˜¯éå¸¸ä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒIAMé¡¹ç›®çš„iamctlå®¢æˆ·ç«¯å·¥å…·å°±æ˜¯ä»¿ç…§kubectlæ¥å®ç°çš„ã€‚è¿™ä¸€è®²ï¼Œæˆ‘å°±é€šè¿‡å‰–æiamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ï¼Œæ¥ä»‹ç»ä¸‹å¦‚ä½•å®ç°ä¸€ä¸ªä¼˜ç§€çš„å®¢æˆ·ç«¯å·¥å…·ã€‚

## å¸¸è§å®¢æˆ·ç«¯ä»‹ç»

åœ¨ä»‹ç»iamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å¸¸è§çš„å®¢æˆ·ç«¯ã€‚

å®¢æˆ·ç«¯åˆå«ç”¨æˆ·ç«¯ï¼Œä¸åç«¯æœåŠ¡ç›¸å¯¹åº”ï¼Œå®‰è£…åœ¨å®¢æˆ·æœºä¸Šï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿™äº›å®¢æˆ·ç«¯è®¿é—®åç«¯æœåŠ¡ã€‚ä¸åŒçš„å®¢æˆ·ç«¯é¢å‘çš„äººç¾¤ä¸åŒï¼Œæ‰€èƒ½æä¾›çš„è®¿é—®èƒ½åŠ›ä¹Ÿæœ‰å·®å¼‚ã€‚å¸¸è§çš„å®¢æˆ·ç«¯æœ‰ä¸‹é¢è¿™å‡ ç§ï¼š

+ å‰ç«¯ï¼ŒåŒ…æ‹¬æµè§ˆå™¨ã€æ‰‹æœºåº”ç”¨ï¼›
+ SDKï¼›
+ å‘½ä»¤è¡Œå·¥å…·ï¼›
+ å…¶ä»–ç»ˆç«¯ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥åˆ†åˆ«ä»‹ç»ä¸‹ã€‚

æµè§ˆå™¨å’Œæ‰‹æœºåº”ç”¨æä¾›ä¸€ä¸ªäº¤äº’ç•Œé¢ä¾›ç”¨æˆ·è®¿é—®åç«¯æœåŠ¡ï¼Œä½¿ç”¨ä½“éªŒæœ€å¥½ï¼Œé¢å‘çš„äººç¾¤æ˜¯æœ€ç»ˆçš„ç”¨æˆ·ã€‚è¿™ä¸¤ç±»å®¢æˆ·ç«¯ä¹Ÿç§°ä¸ºå‰ç«¯ã€‚å‰ç«¯ç”±å‰ç«¯å¼€å‘äººå‘˜è¿›è¡Œå¼€å‘ï¼Œå¹¶é€šè¿‡APIæ¥å£ï¼Œè°ƒç”¨åç«¯çš„æœåŠ¡ã€‚åç«¯å¼€å‘äººå‘˜ä¸éœ€è¦å…³æ³¨è¿™ä¸¤ç±»å®¢æˆ·ç«¯ï¼Œåªéœ€è¦å…³æ³¨å¦‚ä½•æä¾›APIæ¥å£å³å¯ã€‚

SDKï¼ˆSoftware Development Kitï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¾›å¼€å‘è€…è°ƒç”¨ã€‚å¼€å‘è€…è°ƒç”¨APIæ—¶ï¼Œå¦‚æœæ˜¯é€šè¿‡HTTPåè®®ï¼Œéœ€è¦ç¼–å†™HTTPçš„è°ƒç”¨ä»£ç ã€HTTPè¯·æ±‚åŒ…çš„å°è£…å’Œè¿”å›åŒ…çš„è§£å°ï¼Œè¿˜è¦å¤„ç†HTTPçš„çŠ¶æ€ç ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚SDKå…¶å®æ˜¯å°è£…äº†APIæ¥å£çš„ä¸€ç³»åˆ—å‡½æ•°é›†åˆï¼Œå¼€å‘è€…é€šè¿‡è°ƒç”¨SDKä¸­çš„å‡½æ•°è°ƒç”¨APIæ¥å£ï¼Œæä¾›SDKä¸»è¦æ˜¯æ–¹ä¾¿å¼€å‘è€…è°ƒç”¨ï¼Œå‡å°‘å·¥ä½œé‡ã€‚

å‘½ä»¤è¡Œå·¥å…·æ˜¯å¯ä»¥åœ¨æ“ä½œç³»ç»Ÿä¸Šæ‰§è¡Œçš„ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œæä¾›äº†ä¸€ç§æ¯”SDKå’ŒAPIæ¥å£æ›´æ–¹ä¾¿å¿«æ·çš„è®¿é—®åç«¯æœåŠ¡çš„é€”å¾„ï¼Œä¾›è¿ç»´æˆ–è€…å¼€å‘äººå‘˜åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œä½¿ç”¨ï¼Œæˆ–è€…åœ¨è‡ªåŠ¨åŒ–è„šæœ¬ä¸­è°ƒç”¨ã€‚

è¿˜æœ‰å…¶ä»–å„ç±»å®¢æˆ·ç«¯ï¼Œè¿™é‡Œæˆ‘åˆ—ä¸¾ä¸€äº›å¸¸è§çš„ã€‚

+ ç»ˆç«¯è®¾å¤‡ï¼šPOSæœºã€å­¦ä¹ æœºã€æ™ºèƒ½éŸ³ç®±ç­‰ã€‚
+ ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼šé€šè¿‡è°ƒç”¨APIæ¥å£æˆ–è€…SDKï¼Œè°ƒç”¨æˆ‘ä»¬æä¾›çš„åç«¯æœåŠ¡ï¼Œä»è€Œå®ç°è‡ªèº«çš„åŠŸèƒ½ã€‚
+ è„šæœ¬ï¼šè„šæœ¬ä¸­é€šè¿‡APIæ¥å£æˆ–è€…å‘½ä»¤è¡Œå·¥å…·ï¼Œè°ƒç”¨æˆ‘ä»¬æä¾›çš„åç«¯æœåŠ¡ï¼Œå®ç°è‡ªåŠ¨åŒ–ã€‚

è¿™äº›å…¶ä»–çš„å„ç±»å®¢æˆ·ç«¯ï¼Œéƒ½æ˜¯é€šè¿‡è°ƒç”¨APIæ¥å£ä½¿ç”¨åç«¯æœåŠ¡çš„ï¼Œå®ƒä»¬è·Ÿå‰ç«¯ä¸€æ ·ï¼Œä¹Ÿä¸éœ€è¦åå°å¼€å‘äººå‘˜å¼€å‘ã€‚

éœ€è¦åå°å¼€å‘äººå‘˜æŠ•å…¥å·¥ä½œé‡è¿›è¡Œç ”å‘çš„å®¢æˆ·ç«¯æ˜¯SDKå’Œå‘½ä»¤è¡Œå·¥å…·ã€‚è¿™ä¸¤ç±»å®¢æˆ·ç«¯å·¥å…·æœ‰ä¸ªè°ƒç”¨å’Œè¢«è°ƒç”¨çš„é¡ºåºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/e9/91/e97e547bec77dc7129615b11792f1291.jpg?wh=1920x568)](https://static001.geekbang.org/resource/image/e9/91/e97e547bec77dc7129615b11792f1291.jpg?wh=1920x568)

ä½ å¯ä»¥çœ‹åˆ°ï¼Œå‘½ä»¤è¡Œå·¥å…·å’ŒSDKæœ€ç»ˆéƒ½æ˜¯é€šè¿‡APIæ¥å£è°ƒç”¨åç«¯æœåŠ¡çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ä¿è¯æœåŠ¡çš„ä¸€è‡´æ€§ï¼Œå¹¶å‡å°‘ä¸ºé€‚é…å¤šä¸ªå®¢æˆ·ç«¯æ‰€å¸¦æ¥çš„é¢å¤–å¼€å‘å·¥ä½œé‡ã€‚

## å¤§å‹ç³»ç»Ÿå®¢æˆ·ç«¯ï¼ˆxxxctlï¼‰çš„ç‰¹ç‚¹

é€šè¿‡å­¦ä¹ kubectlã€istioctlã€etcdctlè¿™äº›ä¼˜ç§€çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé€šå¸¸å…·æœ‰ä¸‹é¢è¿™äº›ç‰¹ç‚¹ï¼š

+ æ”¯æŒå‘½ä»¤å’Œå­å‘½ä»¤ï¼Œå‘½ä»¤/å­å‘½åæœ‰è‡ªå·±ç‹¬æœ‰çš„å‘½ä»¤è¡Œå‚æ•°ã€‚
+ æ”¯æŒä¸€äº›ç‰¹æ®Šçš„å‘½ä»¤ã€‚æ¯”å¦‚æ”¯æŒcompletionå‘½ä»¤ï¼Œcompletionå‘½ä»¤å¯ä»¥è¾“å‡ºbash/zshè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼Œå®ç°å‘½ä»¤è¡ŒåŠå‚æ•°çš„è‡ªåŠ¨è¡¥å…¨ã€‚è¿˜æ”¯æŒ versionå‘½ä»¤ï¼Œversionå‘½ä»¤ä¸ä»…å¯ä»¥è¾“å‡ºå®¢æˆ·ç«¯çš„ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥è¾“å‡ºæœåŠ¡ç«¯çš„ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰éœ€è¦ï¼‰ã€‚
+ æ”¯æŒå…¨å±€optionï¼Œå…¨å±€optionå¯ä»¥ä½œä¸ºæ‰€æœ‰å‘½ä»¤åŠå­å‘½ä»¤çš„å‘½ä»¤è¡Œå‚æ•°ã€‚
+ æ”¯æŒ-h/helpï¼Œ-h/helpå¯ä»¥æ‰“å°xxxctlçš„å¸®åŠ©ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

```bash
$ iamctl -hiamctl controls the iam platform, is the client side tool for iam platform. Find more information at:https://github.com/marmotedu/iam/blob/master/docs/guide/en-US/cmd/iamctl/iamctl.mdBasic Commands:  info        Print the host information  color       Print colors supported by the current terminal  new         Generate demo command code  jwt         JWT command-line toolIdentity and Access Management Commands:  user        Manage users on iam platform  secret      Manage secrets on iam platform  policy      Manage authorization policies on iam platformTroubleshooting and Debugging Commands:  validate    Validate the basic environment for iamctl to runSettings Commands:  set         Set specific features on objects  completion  Output shell completion code for the specified shell (bash or zsh)Other Commands:  version     Print the client and server version informationUsage:  iamctl [flags] [options]Use "iamctl <command> --help" for more information about a given command.Use "iamctl options" for a list of global command-line options (applies to all commands).
```

+ æ”¯æŒ `xxxctl help [command | command subcommand] [command | command subcommand] -h` ï¼Œæ‰“å°å‘½ä»¤/å­å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œæ ¼å¼é€šå¸¸ä¸º `å‘½ä»¤æè¿° + ä½¿ç”¨æ–¹æ³•` ã€‚ä¾‹å¦‚ï¼š

```bash
$ istioctl help registerRegisters a service instance (e.g. VM) joining the mesh Usage:  istioctl register <svcname> <ip> [name1:]port1 [name2:]port2 ... [flags]
```

é™¤æ­¤ä¹‹å¤–ï¼Œä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„å‘½ä»¤è¡Œå·¥å…·è¿˜å¯ä»¥æ”¯æŒä¸€äº›æ›´é«˜é˜¶çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šæ”¯æŒå‘½ä»¤åˆ†ç»„ï¼Œæ”¯æŒé…ç½®æ–‡ä»¶ï¼Œæ”¯æŒå‘½ä»¤çš„ä½¿ç”¨exampleï¼Œç­‰ç­‰ã€‚

åœ¨Goç”Ÿæ€ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¦æ‰¾ä¸€ä¸ªç¬¦åˆä¸Šé¢æ‰€æœ‰ç‰¹ç‚¹çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œé‚£é[kubectl](https://github.com/kubernetes/kubernetes/blob/master/cmd/kubectl/)è«å±ã€‚å› ä¸ºæˆ‘ä»Šå¤©è¦é‡ç‚¹è®²çš„iamctlå®¢æˆ·ç«¯å·¥å…·ï¼Œå°±æ˜¯ä»¿ç…§å®ƒæ¥å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å±•å¼€ä»‹ç»kubectläº†ï¼Œä¸è¿‡è¿˜æ˜¯å»ºè®®ä½ è®¤çœŸç ”ç©¶ä¸‹kubectlçš„å®ç°ã€‚

## iamctlçš„æ ¸å¿ƒå®ç°

æ¥ä¸‹æ¥ï¼Œæˆ‘å°±æ¥ä»‹ç»IAMç³»ç»Ÿè‡ªå¸¦çš„iamctlå®¢æˆ·ç«¯å·¥å…·ï¼Œå®ƒæ˜¯ä»¿ç…§kubectlæ¥å®ç°çš„ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸€ä¸ªå¤§å‹ç³»ç»Ÿå®¢æˆ·ç«¯å·¥å…·çš„éœ€æ±‚ã€‚æˆ‘ä¼šä»iamctlçš„åŠŸèƒ½ã€ä»£ç ç»“æ„ã€å‘½ä»¤è¡Œé€‰é¡¹å’Œé…ç½®æ–‡ä»¶è§£æ4ä¸ªæ–¹é¢æ¥ä»‹ç»ã€‚

### iamctlçš„åŠŸèƒ½

iamctlå°†å‘½ä»¤è¿›è¡Œäº†åˆ†ç±»ã€‚è¿™é‡Œï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ å¯¹å‘½ä»¤è¿›è¡Œåˆ†ç±»ï¼Œå› ä¸ºé€šè¿‡åˆ†ç±»ï¼Œä¸ä»…å¯ä»¥ååŠ©ä½ ç†è§£å‘½ä»¤çš„ç”¨é€”ï¼Œè¿˜èƒ½å¸®ä½ å¿«é€Ÿå®šä½æŸç±»å‘½ä»¤ã€‚å¦å¤–ï¼Œå½“å‘½ä»¤å¾ˆå¤šæ—¶ï¼Œåˆ†ç±»ä¹Ÿå¯ä»¥ä½¿å‘½ä»¤çœ‹èµ·æ¥æ›´è§„æ•´ã€‚

iamctlå®ç°çš„å‘½ä»¤å¦‚ä¸‹ï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1d/da/1dee217f8be94ae1c3c1d9b29d627eda.jpg?wh=1920x1696)](https://static001.geekbang.org/resource/image/1d/da/1dee217f8be94ae1c3c1d9b29d627eda.jpg?wh=1920x1696)

æ›´è¯¦ç»†çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥å‚è€ƒ `iamctl -h` ã€‚æˆ‘å»ºè®®ä½ åœ¨å®ç°xxxctlå·¥å…·æ—¶ï¼Œè€ƒè™‘å®ç°ä¸‹é¢è¿™å‡ ä¸ªåŠŸèƒ½ã€‚

+ APIåŠŸèƒ½ï¼šå¹³å°å…·æœ‰çš„APIåŠŸèƒ½ï¼Œéƒ½èƒ½é€šè¿‡xxxctlæ–¹ä¾¿åœ°è¿›è¡Œè°ƒç”¨ã€‚
+ å·¥å…·ï¼šä¸€äº›ä½¿ç”¨IAMç³»ç»Ÿæ—¶æœ‰ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç­¾å‘JWT Tokenã€‚
+ versionã€completionã€validateå‘½ä»¤ã€‚

### ä»£ç ç»“æ„

iamctlå·¥å…·çš„mainå‡½æ•°ä½äº[iamctl.go](https://github.com/marmotedu/iam/blob/v1.0.6/cmd/iamctl/iamctl.go)æ–‡ä»¶ä¸­ã€‚å‘½ä»¤çš„å®ç°å­˜æ”¾åœ¨[internal/iamctl/cmd/cmd.go](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go)æ–‡ä»¶ä¸­ã€‚iamctlçš„å‘½ä»¤ç»Ÿä¸€å­˜æ”¾åœ¨[internal/iamctl/cmd](https://github.com/marmotedu/iam/tree/v1.0.6/internal/iamctl/cmd)ç›®å½•ä¸‹ï¼Œæ¯ä¸ªå‘½ä»¤éƒ½æ˜¯ä¸€ä¸ªGoåŒ…ï¼ŒåŒ…åå³ä¸ºå‘½ä»¤åï¼Œå…·ä½“å®ç°å­˜æ”¾åœ¨ `internal/iamctl/cmd/<å‘½ä»¤>/<å‘½ä»¤>.go` æ–‡ä»¶ä¸­ã€‚å¦‚æœå‘½ä»¤æœ‰å­å‘½ä»¤ï¼Œåˆ™å­å‘½ä»¤çš„å®ç°å­˜æ”¾åœ¨ `internal/iamctl/cmd/<å‘½ä»¤>/<å‘½ä»¤>*<å­å‘½ä»¤>.go*` *æ–‡ä»¶ä¸­ã€‚*

*ä½¿ç”¨è¿™ç§ä»£ç ç»„ç»‡æ–¹å¼ï¼Œå³ä½¿æ˜¯åœ¨å‘½ä»¤å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œä¹Ÿèƒ½è®©ä»£ç äº•ç„¶æœ‰åºï¼Œæ–¹ä¾¿å®šä½å’Œç»´æŠ¤ä»£ç ã€‚*

### *å‘½ä»¤è¡Œé€‰é¡¹*

*æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹çš„ä»£ç åœ¨[NewIAMCtlCommand](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go#L41-L130)å‡½æ•°ä¸­ï¼Œæ ¸å¿ƒä»£ç ä¸ºï¼š*

```
flags := cmds.PersistentFlags()...                                                                             iamConfigFlags := genericclioptions.NewConfigFlags(true).WithDeprecatedPasswordFlag().WithDeprecatedSecretFlag()iamConfigFlags.AddFlags(flags)                                   matchVersionIAMConfigFlags := cmdutil.NewMatchVersionFlags(iamConfigFlags)                matchVersionIAMConfigFlags.AddFlags(cmds.PersistentFlags())
```

*`NewConfigFlags(true)` è¿”å›å¸¦æœ‰é»˜è®¤å€¼çš„å‚æ•°ï¼Œå¹¶é€šè¿‡ `iamConfigFlags.AddFlags(flags)` æ·»åŠ åˆ°cobraçš„å‘½ä»¤è¡Œflagä¸­ã€‚*

*`NewConfigFlags(true)` è¿”å›ç»“æ„ä½“ç±»å‹çš„å€¼éƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šç¨‹åºå¯ä»¥åˆ¤æ–­å‡ºæ˜¯å¦æŒ‡å®šäº†æŸä¸ªå‚æ•°ï¼Œä»è€Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ å‚æ•°ã€‚ä¾‹å¦‚ï¼šå¯ä»¥é€šè¿‡ `WithDeprecatedPasswordFlag()` å’Œ `WithDeprecatedSecretFlag()` æ·»åŠ å¯†ç å’Œå¯†é’¥è®¤è¯å‚æ•°ã€‚*

*`NewMatchVersionFlags` æŒ‡å®šæ˜¯å¦éœ€è¦æœåŠ¡ç«¯ç‰ˆæœ¬å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œåœ¨è°ƒç”¨æœåŠ¡æ¥å£æ—¶ä¼šæŠ¥é”™ã€‚*

### *é…ç½®æ–‡ä»¶è§£æ*

*iamctléœ€è¦è¿æ¥iam-apiserverï¼Œæ¥å®Œæˆç”¨æˆ·ã€ç­–ç•¥å’Œå¯†é’¥çš„å¢åˆ æ”¹æŸ¥ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡Œè®¤è¯ã€‚è¦å®Œæˆè¿™äº›åŠŸèƒ½ï¼Œéœ€è¦æœ‰æ¯”è¾ƒå¤šçš„é…ç½®é¡¹ã€‚è¿™äº›é…ç½®é¡¹å¦‚æœæ¯æ¬¡éƒ½åœ¨å‘½ä»¤è¡Œé€‰é¡¹æŒ‡å®šï¼Œä¼šå¾ˆéº»çƒ¦ï¼Œä¹Ÿå®¹æ˜“å‡ºé”™ã€‚*

*æœ€å¥½çš„æ–¹å¼æ˜¯ä¿å­˜åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶åŠ è½½é…ç½®æ–‡ä»¶ã€‚åŠ è½½é…ç½®æ–‡ä»¶çš„ä»£ç ä½äºNewIAMCtlCommandå‡½æ•°ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š*

```
 = viper.BindPFlags(cmds.PersistentFlags())cobra.OnInitialize(func() {    genericapiserver.LoadConfig(viper.GetString(genericclioptions.FlagIAMConfig), "iamctl")})  
```

iamctlä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§åŠ è½½é…ç½®æ–‡ä»¶ï¼š

1. å‘½ä»¤è¡Œå‚ `--iamconfig` æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚
2. å½“å‰ç›®å½•ä¸‹çš„iamctl.yamlæ–‡ä»¶ã€‚
3. `$HOME/.iam/iamctl.yaml` æ–‡ä»¶ã€‚

è¿™ç§åŠ è½½æ–¹å¼å…·æœ‰ä¸¤ä¸ªå¥½å¤„ã€‚é¦–å…ˆæ˜¯å¯ä»¥æ‰‹åŠ¨æŒ‡å®šä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œè¿™åœ¨å¤šç¯å¢ƒã€å¤šé…ç½®ä¸‹å°¤ä¸ºé‡è¦ã€‚å…¶æ¬¡æ˜¯æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯ä»¥æŠŠé…ç½®å­˜æ”¾åœ¨é»˜è®¤çš„åŠ è½½è·¯å¾„ä¸­ï¼Œåœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œå°±ä¸ç”¨å†æŒ‡å®š `--iamconfig` å‚æ•°ã€‚

åŠ è½½å®Œé…ç½®æ–‡ä»¶ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ `viper.Get<Type>()` å‡½æ•°æ¥è·å–é…ç½®ã€‚ä¾‹å¦‚ï¼Œiamctlä½¿ç”¨äº†ä»¥ä¸‹ `viper.Get<Type>` æ–¹æ³•ï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/8b/42/8bce5d0b9ab45b5238d70b73175cf642.png?wh=1920x813)](https://static001.geekbang.org/resource/image/8b/42/8bce5d0b9ab45b5238d70b73175cf642.png?wh=1920x813)

## iamctlä¸­å­å‘½ä»¤æ˜¯å¦‚ä½•æ„å»ºçš„ï¼Ÿ

è®²å®Œäº†iamctlå‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒå®ç°ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹iamctlå‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œå­å‘½ä»¤æ˜¯å¦‚ä½•æ„å»ºçš„ã€‚

å‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒæ˜¯å‘½ä»¤ï¼Œæœ‰å¾ˆå¤šç§æ–¹æ³•å¯ä»¥æ„å»ºä¸€ä¸ªå‘½ä»¤ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒå¥½çš„æ„å»ºæ–¹æ³•ï¼Œå€¼å¾—æˆ‘ä»¬å»å‚è€ƒã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥ä»‹ç»ä¸‹å¦‚ä½•ç”¨æ¯”è¾ƒå¥½çš„æ–¹å¼å»æ„å»ºå‘½ä»¤ã€‚

### å‘½ä»¤æ„å»º

å‘½ä»¤è¡Œå·¥å…·çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯æä¾›å„ç±»å‘½ä»¤ï¼Œæ¥å®Œæˆä¸åŒåŠŸèƒ½ï¼Œæ¯ä¸ªå‘½ä»¤æ„å»ºçš„æ–¹å¼å¯ä»¥å®Œå…¨ä¸åŒï¼Œä½†æœ€å¥½èƒ½æŒ‰ç›¸åŒçš„æ–¹å¼å»æ„å»ºï¼Œå¹¶æŠ½è±¡æˆä¸€ä¸ªæ¨¡å‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/1e/93/1e78d2f387be0bcbae573d486e391e93.jpg?wh=1920x916)](https://static001.geekbang.org/resource/image/1e/93/1e78d2f387be0bcbae573d486e391e93.jpg?wh=1920x916)

ä½ å¯ä»¥å°†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·æä¾›çš„å‘½ä»¤è¿›è¡Œåˆ†ç»„ã€‚æ¯ä¸ªåˆ†ç»„åŒ…å«å¤šä¸ªå‘½ä»¤ï¼Œæ¯ä¸ªå‘½ä»¤åˆå¯ä»¥å…·æœ‰å¤šä¸ªå­å‘½ä»¤ï¼Œå­å‘½ä»¤å’Œçˆ¶å‘½ä»¤åœ¨æ„å»ºæ–¹å¼ä¸Šå®Œå…¨ä¸€è‡´ã€‚

æ¯ä¸ªå‘½ä»¤å¯ä»¥æŒ‰ä¸‹é¢çš„å››ç§æ–¹å¼æ„å»ºã€‚å…·ä½“ä»£ç ä½ å¯ä»¥å‚è€ƒ[internal/iamctl/cmd/user/user_update.go](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/user/user_update.go)ã€‚

+ é€šè¿‡ `NewCmdXyz` å‡½æ•°åˆ›å»ºå‘½ä»¤æ¡†æ¶ã€‚ `NewCmdXyz` å‡½æ•°é€šè¿‡åˆ›å»ºä¸€ä¸ª `cobra.Command` ç±»å‹çš„å˜é‡æ¥åˆ›å»ºå‘½ä»¤ï¼›é€šè¿‡æŒ‡å®š `cobra.Command` ç»“æ„ä½“ç±»å‹çš„Shortã€Longã€Exampleå­—æ®µï¼Œæ¥æŒ‡å®šè¯¥å‘½ä»¤çš„ä½¿ç”¨æ–‡æ¡£`iamctl -h` ã€è¯¦ç»†ä½¿ç”¨æ–‡æ¡£`iamctl xyz -h` å’Œä½¿ç”¨ç¤ºä¾‹ã€‚
+ é€šè¿‡ `cmd.Flags().XxxxVar` æ¥ç»™è¯¥å‘½ä»¤æ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹ã€‚
+ ä¸ºäº†åœ¨ä¸æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œèƒ½å¤ŸæŒ‰ç…§é»˜è®¤çš„æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼Œå¯ä»¥é€šè¿‡ `NewXyzOptions` å‡½æ•°è¿”å›ä¸€ä¸ªè®¾ç½®äº†é»˜è®¤é€‰é¡¹çš„ `XyzOptions` ç±»å‹çš„å˜é‡ã€‚
+ `XyzOptions` é€‰é¡¹å…·æœ‰ Complete ã€Validate å’Œ Run ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«å®Œæˆé€‰é¡¹è¡¥å…¨ã€é€‰é¡¹éªŒè¯å’Œå‘½ä»¤æ‰§è¡Œã€‚å‘½ä»¤çš„æ‰§è¡Œé€»è¾‘å¯ä»¥åœ¨ `func (o *XyzOptions) Run(args []string) error` å‡½æ•°ä¸­ç¼–å†™ã€‚

æŒ‰ç›¸åŒçš„æ–¹å¼å»æ„å»ºå‘½ä»¤ï¼ŒæŠ½è±¡æˆä¸€ä¸ªé€šç”¨æ¨¡å‹ï¼Œè¿™ç§æ–¹å¼æœ‰ä¸‹é¢å››ä¸ªå¥½å¤„ã€‚

+ å‡å°‘ç†è§£æˆæœ¬ï¼šç†è§£ä¸€ä¸ªå‘½ä»¤çš„æ„å»ºæ–¹å¼ï¼Œå°±å¯ä»¥ç†è§£å…¶ä»–å‘½ä»¤çš„æ„å»ºæ–¹å¼ã€‚
+ æé«˜æ–°å‘½ä»¤çš„å¼€å‘æ•ˆç‡ï¼šå¯ä»¥å¤ç”¨å…¶ä»–å‘½ä»¤çš„å¼€å‘æ¡†æ¶ï¼Œæ–°å‘½ä»¤åªéœ€å¡«å†™ä¸šåŠ¡é€»è¾‘å³å¯ã€‚
+ è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤ï¼šå¯ä»¥æŒ‰ç…§è§„å®šçš„å‘½ä»¤æ¨¡å‹ï¼Œè‡ªåŠ¨ç”Ÿæˆæ–°çš„å‘½ä»¤ã€‚
+ æ˜“ç»´æŠ¤ï¼šå› ä¸ºæ‰€æœ‰çš„å‘½ä»¤éƒ½æ¥è‡ªäºåŒä¸€ä¸ªå‘½ä»¤æ¨¡å‹ï¼Œæ‰€ä»¥å¯ä»¥ä¿æŒä¸€è‡´çš„ä»£ç é£æ ¼ï¼Œæ–¹ä¾¿åæœŸç»´æŠ¤ã€‚

### è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤

ä¸Šé¢è®²åˆ°ï¼Œè‡ªåŠ¨ç”Ÿæˆå‘½ä»¤æ¨¡å‹çš„å¥½å¤„ä¹‹ä¸€æ˜¯å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸‹ã€‚

iamctlè‡ªå¸¦äº†å‘½ä»¤ç”Ÿæˆå·¥å…·ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹ç”Ÿæˆæ–¹æ³•ï¼Œä¸€å…±å¯ä»¥åˆ†æˆ5æ­¥ã€‚è¿™é‡Œå‡è®¾ç”Ÿæˆ `xyz` å‘½ä»¤ã€‚

ç¬¬ä¸€æ­¥ï¼Œæ–°å»ºä¸€ä¸ª `xyz` ç›®å½•ï¼Œç”¨æ¥å­˜æ”¾ `xyz` å‘½ä»¤æºç ï¼š

```bash
$ mkdir internal/iamctl/cmd/xyz
```

ç¬¬äºŒæ­¥ï¼Œåœ¨xyzç›®å½•ä¸‹ï¼Œä½¿ç”¨ `iamctl new` å‘½ä»¤ç”Ÿæˆ `xyz` å‘½ä»¤æºç ï¼š

```bash
$ cd internal/iamctl/cmd/xyz/$ iamctl new xyzCommand file generated: xyz.go
```

ç¬¬ä¸‰æ­¥ï¼Œå°† `xyz` å‘½ä»¤æ·»åŠ åˆ°rootå‘½ä»¤ä¸­ï¼Œå‡è®¾ `xyz` å±äº `Settings Commands` å‘½ä»¤åˆ†ç»„ã€‚

åœ¨ `NewIAMCtlCommand` å‡½æ•°ä¸­ï¼Œæ‰¾åˆ° `Settings Commands` åˆ†ç»„ï¼Œå°† `NewCmdXyz` è¿½åŠ åˆ°Commandsæ•°ç»„åé¢ï¼š

```go
       {            Message: "Settings Commands:",            Commands: []*cobra.Command{                set.NewCmdSet(f, ioStreams),                completion.NewCmdCompletion(ioStreams.Out, ""),                xyz.NewCmdXyz(f, ioStreams),            },        }, 
```

ç¬¬å››æ­¥ï¼Œç¼–è¯‘iamctlï¼š

```bash
$ make build BINS=iamctl  
```

ç¬¬äº”æ­¥ï¼Œæµ‹è¯•ï¼š

```bash
$ iamctl xyz -hA longer description that spans multiple lines and likely contains examples and usage of using your command. Forexample:  Cobra is a CLI library for Go that empowers applications. This application is a tool to generate the needed files toquickly create a Cobra application. Examples:  # Print all option values for xyz  iamctl xyz marmotedu marmotedupass Options:  -b, --bool=false: Bool option.  -i, --int=0: Int option.      --slice=[]: String slice option.      --string='default': String option. Usage:  iamctl xyz USERNAME PASSWORD [options] Use "iamctl options" for a list of global command-line options (applies to all commands).$ iamctl xyz marmotedu marmotedupassThe following is option values:==> --string: default(complete)==> --slice: []==> --int: 0==> --bool: false The following is args values:==> username: marmotedu==> password: marmotedupass
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œç»è¿‡çŸ­çŸ­çš„å‡ æ­¥ï¼Œå°±æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å‘½ä»¤ `xyz` ã€‚ `iamctl new` å‘½ä»¤ä¸ä»…å¯ä»¥ç”Ÿæˆä¸å¸¦å­å‘½ä»¤çš„å‘½ä»¤ï¼Œè¿˜å¯ä»¥ç”Ÿæˆå¸¦æœ‰å­å‘½ä»¤çš„å‘½ä»¤ï¼Œç”Ÿæˆæ–¹å¼å¦‚ä¸‹ï¼š

```bash
$ iamctl new -g xyzCommand file generated: xyz.goCommand file generated: xyz_subcmd1.goCommand file generated: xyz_subcmd2.go
```

### å‘½ä»¤è‡ªåŠ¨è¡¥å…¨

cobraä¼šæ ¹æ®æ³¨å†Œçš„å‘½ä»¤è‡ªåŠ¨ç”Ÿæˆè¡¥å…¨è„šæœ¬ï¼Œå¯ä»¥è¡¥å…¨çˆ¶å‘½ä»¤ã€å­å‘½ä»¤å’Œé€‰é¡¹å‚æ•°ã€‚åœ¨bashä¸‹ï¼Œå¯ä»¥æŒ‰ä¸‹é¢çš„æ–¹å¼é…ç½®è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ã€‚

ç¬¬ä¸€æ­¥ï¼Œç”Ÿæˆè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š

```bash
$ iamctl completion bash > ~/.iam/completion.bash.inc
```

ç¬¬äºŒæ­¥ï¼Œç™»é™†æ—¶åŠ è½½bashï¼Œè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼š

```bash
$ echo "source '$HOME/.iam/completion.bash.inc'" >> $HOME/.bash_profile$ source $HOME/.bash_profile
```

ç¬¬ä¸‰æ­¥ï¼Œæµ‹è¯•è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼š

```bash
$ iamctl xy<TAB> # æŒ‰TABé”®ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸ºï¼šiamctl xyz$ iamctl xyz --b<TAB> # æŒ‰TABé”®ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸ºï¼šiamctl xyz --bool
```

### æ›´å‹å¥½çš„è¾“å‡º

åœ¨å¼€å‘å‘½ä»¤æ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›æŠ€å·§æ¥æé«˜ä½¿ç”¨ä½“éªŒã€‚æˆ‘ç»å¸¸ä¼šåœ¨è¾“å‡ºä¸­æ‰“å°ä¸€äº›å½©è‰²è¾“å‡ºï¼Œæˆ–è€…å°†ä¸€äº›è¾“å‡ºä»¥è¡¨æ ¼çš„å½¢å¼è¾“å‡ºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/74/42/74ef80708c853c20811e1e7bed7bde42.png?wh=651x226)](https://static001.geekbang.org/resource/image/74/42/74ef80708c853c20811e1e7bed7bde42.png?wh=651x226)

è¿™é‡Œï¼Œä½¿ç”¨ `github.com/olekukonko/tablewriter` åŒ…æ¥å®ç°è¡¨æ ¼åŠŸèƒ½ï¼Œä½¿ç”¨ `github.com/fatih/color` åŒ…æ¥æ‰“å°å¸¦è‰²å½©çš„å­—ç¬¦ä¸²ã€‚å…·ä½“ä½¿ç”¨æ–¹æ³•ï¼Œä½ å¯ä»¥å‚è€ƒ[internal/iamctl/cmd/validate/validate.go](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/validate/validate.go)æ–‡ä»¶ã€‚

`github.com/fatih/color` åŒ…å¯ä»¥ç»™å­—ç¬¦ä¸²æ ‡ç¤ºé¢œè‰²ï¼Œå­—ç¬¦ä¸²å’Œé¢œè‰²çš„å¯¹åº”å…³ç³»å¯é€šè¿‡ `iamctl color` æ¥æŸ¥çœ‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/47/b9/47593869e1b10b15a35e16c661d818b9.png?wh=991x672)](https://static001.geekbang.org/resource/image/47/b9/47593869e1b10b15a35e16c661d818b9.png?wh=991x672)

## iamctlæ˜¯å¦‚ä½•è¿›è¡ŒAPIè°ƒç”¨çš„ï¼Ÿ

ä¸Šé¢æˆ‘ä»‹ç»äº†iamctlå‘½ä»¤çš„æ„å»ºæ–¹å¼ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹iamctlæ˜¯å¦‚ä½•è¯·æ±‚æœåŠ¡ç«¯APIæ¥å£çš„ã€‚

Goåç«¯æœåŠ¡çš„åŠŸèƒ½é€šå¸¸é€šè¿‡APIæ¥å£æ¥å¯¹å¤–æš´éœ²ï¼Œä¸€ä¸ªåç«¯æœåŠ¡å¯èƒ½ä¾›å¾ˆå¤šä¸ªç»ˆç«¯ä½¿ç”¨ï¼Œæ¯”å¦‚æµè§ˆå™¨ã€å‘½ä»¤è¡Œå·¥å…·ã€æ‰‹æœºç­‰ã€‚ä¸ºäº†ä¿æŒåŠŸèƒ½çš„ä¸€è‡´æ€§ï¼Œè¿™äº›ç»ˆç«¯éƒ½ä¼šè°ƒç”¨åŒä¸€å¥—APIæ¥å®Œæˆç›¸åŒçš„åŠŸèƒ½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

[![å›¾ç‰‡](https://static001.geekbang.org/resource/image/fb/bb/fb6de4f63454dd6471e023d73b8548bb.jpg?wh=1920x742)](https://static001.geekbang.org/resource/image/fb/bb/fb6de4f63454dd6471e023d73b8548bb.jpg?wh=1920x742)

å¦‚æœå‘½ä»¤è¡Œå·¥å…·éœ€è¦ç”¨åˆ°åç«¯æœåŠ¡çš„åŠŸèƒ½ï¼Œä¹Ÿéœ€è¦é€šè¿‡APIè°ƒç”¨çš„æ–¹å¼ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼ŒGoåç«¯æœåŠ¡å¯¹å¤–æš´éœ²çš„æ‰€æœ‰APIåŠŸèƒ½ï¼Œéƒ½å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå·¥å…·æ¥å®Œæˆã€‚ä¸€ä¸ªAPIæ¥å£å¯¹åº”ä¸€ä¸ªå‘½ä»¤ï¼ŒAPIæ¥å£çš„å‚æ•°æ˜ å°„åˆ°å‘½ä»¤çš„å‚æ•°ã€‚

è¦è°ƒç”¨æœåŠ¡ç«¯çš„APIæ¥å£ï¼Œæœ€ä¾¿æ·çš„æ–¹æ³•æ˜¯é€šè¿‡SDKæ¥è°ƒç”¨ï¼Œå¯¹äºä¸€äº›æ²¡æœ‰å®ç°SDKçš„æ¥å£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œåœ¨å‘½ä»¤è¡Œå·¥å…·ä¸­ï¼Œéœ€è¦æ”¯æŒä»¥ä¸‹ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š

+ é€šè¿‡SDKè°ƒç”¨æœåŠ¡ç«¯ API æ¥å£ã€‚
+ ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯çš„APIæ¥å£ï¼ˆæœ¬ä¸“æ æ˜¯REST APIæ¥å£ï¼‰ã€‚

iamctlé€šè¿‡[cmdutil.NewFactory](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/cmd.go#L82)åˆ›å»ºä¸€ä¸ª `Factory` ç±»å‹çš„å˜é‡ `f` ï¼Œ `Factory` å®šä¹‰ä¸ºï¼š

```go
type Factory interface {    genericclioptions.RESTClientGetter    IAMClientSet() (*marmotedu.Clientset, error)    RESTClient() (*restclient.RESTClient, error)}
```

å°†å˜é‡ `f` ä¼ å…¥åˆ°å‘½ä»¤ä¸­ï¼Œåœ¨å‘½ä»¤ä¸­ä½¿ç”¨Factoryæ¥å£æä¾›çš„ `RESTClient()` å’Œ `IAMClientSet()` æ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›RESTful APIå®¢æˆ·ç«¯å’ŒSDKå®¢æˆ·ç«¯ï¼Œä»è€Œä½¿ç”¨å®¢æˆ·ç«¯æä¾›çš„æ¥å£å‡½æ•°ã€‚ä»£ç å¯å‚è€ƒ[internal/iamctl/cmd/version/version.go](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/version/version.go)ã€‚

### å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶

å¦‚æœè¦åˆ›å»ºRESTful APIå®¢æˆ·ç«¯å’ŒSDKçš„å®¢æˆ·ç«¯ï¼Œéœ€è¦è°ƒç”¨ `f.ToRESTConfig()` å‡½æ•°è¿”å› `*github.com/marmotedu/marmotedu-sdk-go/rest.Config` ç±»å‹çš„é…ç½®å˜é‡ï¼Œç„¶åå†åŸºäº `rest.Config` ç±»å‹çš„é…ç½®å˜é‡åˆ›å»ºå®¢æˆ·ç«¯ã€‚

`f.ToRESTConfig` å‡½æ•°æœ€ç»ˆæ˜¯è°ƒç”¨[toRawIAMConfigLoader](https://github.com/marmotedu/iam/blob/v1.0.6/pkg/cli/genericclioptions/config_flags.go#L92-L98)å‡½æ•°æ¥ç”Ÿæˆé…ç½®çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (f *ConfigFlags) toRawIAMConfigLoader() clientcmd.ClientConfig {    config := clientcmd.NewConfig()    if err := viper.Unmarshal(&config); err != nil {        panic(err)    }    return clientcmd.NewClientConfigFromConfig(config)}
```

`toRawIAMConfigLoader` è¿”å› `clientcmd.ClientConfig` ç±»å‹çš„å˜é‡ï¼Œ `clientcmd.ClientConfig` ç±»å‹æä¾›äº† `ClientConfig` æ–¹æ³•ï¼Œç”¨æ¥è¿”å›`*rest.Config`ç±»å‹çš„å˜é‡ã€‚

åœ¨ `toRawIAMConfigLoader` å‡½æ•°å†…éƒ¨ï¼Œé€šè¿‡ `viper.Unmarshal` å°†viperä¸­å­˜å‚¨çš„é…ç½®è§£æåˆ° `clientcmd.Config` ç±»å‹çš„ç»“æ„ä½“å˜é‡ä¸­ã€‚viperä¸­å­˜å‚¨çš„é…ç½®ï¼Œæ˜¯åœ¨cobraå‘½ä»¤å¯åŠ¨æ—¶é€šè¿‡LoadConfigå‡½æ•°åŠ è½½çš„ï¼Œä»£ç å¦‚ä¸‹ï¼ˆä½äº `NewIAMCtlCommand` å‡½æ•°ä¸­ï¼‰ï¼š

```go
cobra.OnInitialize(func() {                         genericapiserver.LoadConfig(viper.GetString(genericclioptions.FlagIAMConfig), "config")}) 
```

ä½ å¯ä»¥é€šè¿‡ `--config` é€‰é¡¹ï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚

### SDKè°ƒç”¨

é€šè¿‡[IAMClient](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/util/factory_client_access.go#L41-L47)è¿”å›SDKå®¢æˆ·ç«¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (f *factoryImpl) IAMClient() (*iam.IamClient, error) {	clientConfig, err := f.ToRESTConfig()	if err != nil {		return nil, err	}	return iam.NewForConfig(clientConfig)}
```

`marmotedu.Clientset` æä¾›äº†iam-apiserverçš„æ‰€æœ‰æ¥å£ã€‚

### REST APIè°ƒç”¨

é€šè¿‡[RESTClient()](https://github.com/marmotedu/iam/blob/v1.0.6/internal/iamctl/cmd/util/factory_client_access.go#L49-L56)è¿”å›RESTful APIå®¢æˆ·ç«¯ï¼Œä»£ç å¦‚ä¸‹ï¼š

```go
func (f *factoryImpl) RESTClient() (*restclient.RESTClient, error) {	clientConfig, err := f.ToRESTConfig()	if err != nil {		return nil, err	}	setIAMDefaults(clientConfig)	return restclient.RESTClientFor(clientConfig)}
```

å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¿é—®RESTful APIæ¥å£ï¼š

```go
serverVersion *version.Infoclient, _ := f.RESTClient()if err := client.Get().AbsPath("/version").Do(context.TODO()).Into(&serverVersion); err != nil {    return err}
```

ä¸Šé¢çš„ä»£ç è¯·æ±‚äº†iam-apiserverçš„/versionæ¥å£ï¼Œå¹¶å°†è¿”å›ç»“æœä¿å­˜åœ¨ `serverVersion` å˜é‡ä¸­ã€‚

## æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä¸»è¦å‰–æäº†iamctlå‘½ä»¤è¡Œå·¥å…·çš„å®ç°ï¼Œè¿›è€Œå‘ä½ ä»‹ç»äº†å¦‚ä½•å®ç°ä¸€ä¸ªä¼˜ç§€çš„å®¢æˆ·ç«¯å·¥å…·ã€‚

å¯¹äºä¸€ä¸ªå¤§å‹ç³»ç»Ÿ `xxx` æ¥è¯´ï¼Œé€šå¸¸éœ€è¦æœ‰ä¸€ä¸ª `xxxctl` å‘½ä»¤è¡Œå·¥å…·ï¼Œ `xxxctl` å‘½ä»¤è¡Œå·¥å…·å¯ä»¥æ–¹ä¾¿å¼€å‘ã€è¿ç»´ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ï¼Œå¹¶èƒ½å®ç°åŠŸèƒ½è‡ªåŠ¨åŒ–ã€‚

IAMé¡¹ç›®å‚è€ƒkubectlï¼Œå®ç°äº†å‘½ä»¤è¡Œå·¥å…· iamctlã€‚iamctlé›†æˆäº†å¾ˆå¤šåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iamctlå­å‘½ä»¤æ¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡iamctlå¯¹ç”¨æˆ·ã€å¯†é’¥å’Œç­–ç•¥è¿›è¡ŒCURDæ“ä½œï¼›å¯ä»¥è®¾ç½®iamctlè‡ªåŠ¨è¡¥å…¨è„šæœ¬ï¼›å¯ä»¥æŸ¥çœ‹IAMç³»ç»Ÿçš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ç”šè‡³ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ `iamctl new` å‘½ä»¤ï¼Œå¿«é€Ÿåˆ›å»ºä¸€ä¸ªiamctlå­å‘½ä»¤æ¨¡æ¿ã€‚

iamctlä½¿ç”¨äº†cobraã€pflagã€viperåŒ…æ¥æ„å»ºï¼Œæ¯ä¸ªå­å‘½ä»¤åˆåŒ…å«äº†ä¸€äº›åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚çŸ­æè¿°ã€é•¿æè¿°ã€ä½¿ç”¨ç¤ºä¾‹ã€å‘½ä»¤è¡Œé€‰é¡¹ã€é€‰é¡¹æ ¡éªŒç­‰ã€‚iamctlå‘½ä»¤å¯ä»¥åŠ è½½ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œæ¥è¿æ¥ä¸åŒçš„å®¢æˆ·ç«¯ã€‚iamctlé€šè¿‡SDKè°ƒç”¨ã€REST APIè°ƒç”¨ä¸¤ç§æ–¹å¼æ¥è°ƒç”¨æœåŠ¡ç«¯APIæ¥å£ã€‚

## è¯¾åç»ƒä¹ 

1. å°è¯•åœ¨ `iamctl` ä¸­æ·»åŠ ä¸€ä¸ª `cliprint` å­å‘½ä»¤ï¼Œè¯¥å­å‘½ä»¤ä¼šè¯»å–å¹¶æ‰“å°å‘½ä»¤è¡Œé€‰é¡¹ã€‚
2. æ€è€ƒä¸‹ï¼Œè¿˜æœ‰å“ªäº›å¥½çš„å‘½ä»¤è¡Œå·¥å…·æ„å»ºæ–¹å¼ï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºåˆ†äº«ã€‚



## END é“¾æ¥
<ul><li><div><a href = '26.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—  </a><a href = '28.md' style='float: right'>  ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°ç›®å½•ğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; ï¼šæœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

