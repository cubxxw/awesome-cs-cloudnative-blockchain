# runtimeåŒ…

[[toc]]

[toc]

## runtime.Gosched()

è®©å‡ºCPUæ—¶é—´ç‰‡ï¼Œé‡æ–°ç­‰å¾…å®‰æ’ä»»åŠ¡

> å¤§æ¦‚æ„æ€å°±æ˜¯æœ¬æ¥è®¡åˆ’çš„å¥½å¥½çš„å‘¨æœ«å‡ºå»çƒ§çƒ¤ï¼Œä½†æ˜¯ä½ å¦ˆè®©ä½ å»ç›¸äº²ï¼Œä¸¤ç§æƒ…å†µ  
>
> ç¬¬ä¸€å°±æ˜¯ä½ ç›¸äº²é€Ÿåº¦éå¸¸å¿«ï¼Œè§é¢å°±é»„ä¸è€½è¯¯ä½ ç»§ç»­çƒ§çƒ¤ï¼Œ
>
> ç¬¬äºŒç§æƒ…å†µå°±æ˜¯ä½ ç›¸äº²é€Ÿåº¦ç‰¹åˆ«æ…¢ï¼Œè§é¢å°±æ˜¯ä½ ä¾¬æˆ‘ä¾¬çš„ï¼Œè€½è¯¯äº†çƒ§çƒ¤ï¼Œä½†æ˜¯è¿˜é¦‹å°±æ˜¯è€½è¯¯äº†çƒ§çƒ¤ä½ è¿˜å¾—å»çƒ§çƒ¤

```go
/*
 * @Description: runtime.Gosched()
 * @Author: xiongxinwei 3293172751nss@gmail.com
 * @Date: 2022-10-04 21:37:41
 * @LastEditTime: 2022-10-19 12:34:48
 * @FilePath: \undefinedd:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\10-main.go
 * @Github_Address: https://github.com/3293172751/cs-awesome-Block_Chain
 * Copyright (c) 2022 by xiongxinwei 3293172751nss@gmail.com, All Rights Reserved. @blog: http://nsddd.top
 */
package main

import (
    "fmt"
    "runtime"
)

func main() {
    go func(s string) {
        for i := 0; i < 2; i++ {
            fmt.Println(s)   //ä¼ å…¥çš„sæ˜¯world
        }
    }("world")
    // ä¸»åç¨‹
    for i := 0; i < 2; i++ {
        // åˆ‡ä¸€ä¸‹ï¼Œå†æ¬¡åˆ†é…ä»»åŠ¡
        runtime.Gosched()   //è®©å‡ºæ—¶é—´ç‰‡
        fmt.Println("hello")
    }
}
```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

```
D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super>go run 10-main.go
world
world
hello
hello
```

ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

> ç›¸äº²çš„é€Ÿåº¦å¤ªå¿«äº†æ„Ÿè§‰ä¸å‡ºæ¥
>
> ```go
> package main
> 
> import (
> 	"fmt"
> 	"runtime"
> )
> 
> func main() {
> 	go func(s string) {
> 		for i := 0; i < 50; i++ {
> 			fmt.Println(s)
> 		}
> 	}("world")
> 	// ä¸»åç¨‹
> 	for i := 0; i < 50; i++ {
> 		// åˆ‡ä¸€ä¸‹ï¼Œå†æ¬¡åˆ†é…ä»»åŠ¡
> 		runtime.Gosched()
> 		fmt.Println("hello")
> 	}
> }
> ```
>
> ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š
>
> ![image-20221019124611889](http://sm.nsddd.top/smimage-20221019124611889.png)



## runtime.Goexit()

é€€å‡ºå½“å‰åç¨‹

> ä¸€è¾¹çƒ§çƒ¤ä¸€è¾¹ç›¸äº²ï¼Œçªç„¶å‘ç°ç›¸äº²å¯¹è±¡å¤ªä¸‘å½±å“çƒ§çƒ¤ï¼Œæœæ–­è®©å¥¹æ»šè›‹ï¼Œç„¶åä¹Ÿå°±æ²¡æœ‰ç„¶åäº†

```go
package main

import (
    "fmt"
    "runtime"
)

func main() {
    go func() {
        defer fmt.Println("A.defer")
        func() {
            defer fmt.Println("B.defer")
            
            // ç»“æŸåç¨‹
            runtime.Goexit()
            
            defer fmt.Println("C.defer")
            fmt.Println("B")
        }()
        fmt.Println("A")
    }()
    for {
    }
}
```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

```
[Running] go run "d:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super\10-main.go"
B.defer
A.defer
```

ğŸ“œ å¯¹ä¸Šé¢çš„è§£é‡Šï¼š

> ä¹Ÿå°±æ˜¯è¯´åé¢çš„ä»£ç éƒ½æ²¡æœ‰æ‰§è¡Œäº†ã€‚`defer`æœ¬èº«å°±æ˜¯å»¶è¿Ÿæ‰§è¡Œè¯­å¥ï¼Œä¹Ÿå°±æ˜¯` fmt.Println("C.defer")`å¹¶æ²¡æœ‰æ‰§è¡Œï¼Œå› ä¸ºå·²ç»ç»“æŸäº†ã€‚
>
> å½“æœ‰å¤šä¸ª defer è¡Œä¸ºè¢«æ³¨å†Œæ—¶ï¼Œå®ƒä»¬ä¼šä»¥é€†åºæ‰§è¡Œï¼ˆç±»ä¼¼æ ˆï¼Œå³åè¿›å…ˆå‡ºï¼‰ï¼Œä¸‹é¢çš„ä»£ç æ˜¯å°†ä¸€ç³»åˆ—çš„æ•°å€¼æ‰“å°è¯­å¥æŒ‰é¡ºåºå»¶è¿Ÿå¤„ç†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
>
> ```go
> package main
> 
> import (
>     "fmt"
> )
> 
> func main() {
> 
>     fmt.Println("defer begin")
> 
>     // å°†deferæ”¾å…¥å»¶è¿Ÿè°ƒç”¨æ ˆ
>     defer fmt.Println(1)
> 
>     defer fmt.Println(2)
> 
>     // æœ€åä¸€ä¸ªæ”¾å…¥, ä½äºæ ˆé¡¶, æœ€å…ˆè°ƒç”¨
>     defer fmt.Println(3)
> 
>     fmt.Println("defer end")
> }
> ```
>
> ä»£ç è¾“å‡ºå¦‚ä¸‹ï¼š
>
> ```
> defer begin
> defer end
> 3
> 2
> 1
> ```
>
> ç»“æœåˆ†æå¦‚ä¸‹ï¼š
>
> + ä»£ç çš„å»¶è¿Ÿé¡ºåºä¸æœ€ç»ˆçš„æ‰§è¡Œé¡ºåºæ˜¯åå‘çš„ã€‚
> + å»¶è¿Ÿè°ƒç”¨æ˜¯åœ¨ defer æ‰€åœ¨å‡½æ•°ç»“æŸæ—¶è¿›è¡Œï¼Œå‡½æ•°ç»“æŸå¯ä»¥æ˜¯æ­£å¸¸è¿”å›æ—¶ï¼Œä¹Ÿå¯ä»¥æ˜¯å‘ç”Ÿå®•æœºæ—¶ã€‚

ä¹‹å‰`for`ä¸€ç›´é˜»å¡ç€ï¼Œæˆ–è®¸æˆ‘ä»¬ä¹Ÿå¯æ‰“å¼€æŸ±å¡

ğŸ’¡ç®€å•çš„ä¸€ä¸ªæ¡ˆä¾‹å¦‚ä¸‹ï¼š

```go
package main

import (
	"fmt"
	"runtime"
	"time"
)

func main() {
	go func() {
		defer fmt.Println("A.defer")
		func() {
			defer fmt.Println("B.defer")

			// ç»“æŸåç¨‹
			runtime.Goexit()

			defer fmt.Println("C.defer")
			fmt.Println("B")
		}()
		fmt.Println("A")
	}()
	for {
        fmt.Println("main")
		defer fmt.Println("main defer")
		time.Sleep(5 * time.Second)
		break
	}
}
```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

```
D:\æ–‡æ¡£\æœ€è¿‘çš„\awesome-golang\docs\code\go-super>go run 10-main.go
main
B.defer
A.defer
main defer
```



## runtime.GOMAXPROCS

Goè¿è¡Œæ—¶çš„è°ƒåº¦å™¨ä½¿ç”¨GOMAXPROCSå‚æ•°æ¥ç¡®å®šéœ€è¦ä½¿ç”¨å¤šå°‘ä¸ª`OS`çº¿ç¨‹æ¥åŒæ—¶æ‰§è¡Œ`Go`ä»£ç ã€‚é»˜è®¤å€¼æ˜¯æœºå™¨ä¸Šçš„CPUæ ¸å¿ƒæ•°ã€‚ä¾‹å¦‚åœ¨ä¸€ä¸ª 8 æ ¸å¿ƒçš„æœºå™¨ä¸Šï¼Œè°ƒåº¦å™¨ä¼šæŠŠ`Go`ä»£ç åŒæ—¶è°ƒåº¦åˆ°8ä¸ªOSçº¿ç¨‹ä¸Šï¼ˆGOMAXPROCSæ˜¯`m:n`è°ƒåº¦ä¸­çš„`n`ï¼‰ã€‚

Goè¯­è¨€ä¸­å¯ä»¥é€šè¿‡`runtime.GOMAXPROCS()`å‡½æ•°è®¾ç½®å½“å‰ç¨‹åºå¹¶å‘æ—¶å ç”¨çš„CPUé€»è¾‘æ ¸å¿ƒæ•°ã€‚

Go1.5ç‰ˆæœ¬ä¹‹å‰ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯å•æ ¸å¿ƒæ‰§è¡Œã€‚Go1.5ç‰ˆæœ¬ä¹‹åï¼Œé»˜è®¤ä½¿ç”¨å…¨éƒ¨çš„CPUé€»è¾‘æ ¸å¿ƒæ•°ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ä»»åŠ¡åˆ†é…åˆ°ä¸åŒçš„CPUé€»è¾‘æ ¸å¿ƒä¸Šå®ç°å¹¶è¡Œçš„æ•ˆæœï¼Œè¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼š

```go
package main

import (
	"fmt"
	"runtime"
	"time"
)

func a() {
	for i := 1; i < 10; i++ {
		fmt.Println("A:", i)
	}
}

func b() {
	for i := 1; i < 10; i++ {
		fmt.Println("B:", i)
	}
}

func main() {
	runtime.GOMAXPROCS(1)
	go a()
	go b()
	time.Sleep(time.Second)
}
```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

![image-20221019130118864](http://sm.nsddd.top/smimage-20221019130118864.png)

ä¸¤ä¸ªä»»åŠ¡åªæœ‰ä¸€ä¸ªé€»è¾‘æ ¸å¿ƒï¼Œæ­¤æ—¶æ˜¯åšå®Œä¸€ä¸ªä»»åŠ¡å†åšå¦ä¸€ä¸ªä»»åŠ¡ã€‚ å°†é€»è¾‘æ ¸å¿ƒæ•°è®¾ä¸º2ï¼Œæ­¤æ—¶ä¸¤ä¸ªä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ã€‚

```go
package main

import (
	"fmt"
	"runtime"
	"time"
)

func a() {
	for i := 1; i < 10; i++ {
		fmt.Println("A:", i)
		//ç­‰å¾…ä¸€ç§’
		time.Sleep(time.Second)
	}
}

func b() {
	for i := 1; i < 10; i++ {
		fmt.Println("B:", i)
		//ç­‰å¾…ä¸€ç§’
		time.Sleep(time.Second)
	}
}

func main() {
	runtime.GOMAXPROCS(4)   //ç»™4ä¸ªï¼Œå“¥æœ‰çš„æ˜¯cpu
	go a()
	go b()
	time.Sleep(time.Second * 10)
}
```

ğŸš€ ç¼–è¯‘ç»“æœå¦‚ä¸‹ï¼š

![image-20221019130717195](http://sm.nsddd.top/smimage-20221019130717195.png)

Goè¯­è¨€ä¸­çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹å’Œ`goroutine`çš„å…³ç³»ï¼š

- ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹å¯¹åº”ç”¨æˆ·æ€å¤šä¸ª`goroutine`ã€‚
- `go`ç¨‹åºå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚
- `goroutine`å’Œ`OS`çº¿ç¨‹æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå³`m:n`ã€‚



## END é“¾æ¥

<ul><li><div><a href = '9.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '11.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

