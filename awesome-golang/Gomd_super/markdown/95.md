# å­¦ä¹  Go è¯­è¨€ä¸­è¾¹ç•Œæ£€æŸ¥

![http://image.iswbm.com/20200607145423.png](https://s2.loli.net/2022/04/11/ipb9Az2WZ54UBFx.png)

## 1. ä»€ä¹ˆæ˜¯è¾¹ç•Œæ£€æŸ¥ï¼Ÿ

è¾¹ç•Œæ£€æŸ¥ï¼Œè‹±æ–‡å `Bounds Check Elimination`ï¼Œç®€ç§°ä¸º BCEã€‚å®ƒæ˜¯ Go è¯­è¨€ä¸­é˜²æ­¢æ•°ç»„ã€åˆ‡ç‰‡è¶Šç•Œè€Œå¯¼è‡´å†…å­˜ä¸å®‰å…¨çš„æ£€æŸ¥æ‰‹æ®µã€‚å¦‚æœæ£€æŸ¥ä¸‹æ ‡å·²ç»è¶Šç•Œäº†ï¼Œå°±ä¼šäº§ç”Ÿ Panicã€‚

è¾¹ç•Œæ£€æŸ¥ä½¿å¾—æˆ‘ä»¬çš„ä»£ç èƒ½å¤Ÿå®‰å…¨åœ°è¿è¡Œï¼Œä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œä¹Ÿä½¿å¾—æˆ‘ä»¬çš„ä»£ç è¿è¡Œæ•ˆç‡ç•¥å¾®é™ä½ã€‚

æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼Œä¼šè¿›è¡Œä¸‰æ¬¡çš„è¾¹ç•Œæ£€æŸ¥

```
package main

func f(s []int) {
    _ = s[0]  // æ£€æŸ¥ç¬¬ä¸€æ¬¡
    _ = s[1]  // æ£€æŸ¥ç¬¬äºŒæ¬¡
    _ = s[2]  // æ£€æŸ¥ç¬¬ä¸‰æ¬¡
}

func main() {}
```

ä½ å¯èƒ½ä¼šå¥½å¥‡äº†ï¼Œä¸‰æ¬¡ï¼Ÿæˆ‘æ˜¯æ€ä¹ˆçŸ¥é“å®ƒè¦æ£€æŸ¥ä¸‰æ¬¡çš„ã€‚

å®é™…ä¸Šï¼Œä½ åªè¦åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼ŒåŠ ä¸Šå‚æ•°å³å¯ï¼Œå‘½ä»¤å¦‚ä¸‹

```
$ go build -gcflags="-d=ssa/check_bce/debug=1" main.go
# command-line-arguments
./main.go:4:7: Found IsInBounds
./main.go:5:7: Found IsInBounds
./main.go:6:7: Found IsInBounds
```

## 2. è¾¹ç•Œæ£€æŸ¥çš„æ¡ä»¶ï¼Ÿ

å¹¶ä¸æ˜¯æ‰€æœ‰çš„å¯¹æ•°ç»„ã€åˆ‡ç‰‡è¿›è¡Œç´¢å¼•æ“ä½œéƒ½éœ€è¦è¾¹ç•Œæ£€æŸ¥ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œå°±ä¸éœ€è¦è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå› ä¸ºç¼–è¯‘å™¨æ ¹æ®ä¸Šä¸‹æ–‡å·²ç»å¾—çŸ¥ï¼Œ`s` è¿™ä¸ªåˆ‡ç‰‡çš„é•¿åº¦æ˜¯å¤šå°‘ï¼Œä½ çš„ç»ˆæ­¢ç´¢å¼•æ˜¯å¤šå°‘ï¼Œç«‹é©¬å°±èƒ½åˆ¤æ–­åˆ°åº•æœ‰æ²¡æœ‰è¶Šç•Œï¼Œå› æ­¤æ˜¯ä¸éœ€è¦å†è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå› ä¸ºåœ¨ç¼–è¯‘çš„æ—¶å€™å°±å·²ç»çŸ¥é“è¿™ä¸ªåœ°æ–¹ä¼šä¸ä¼š panicã€‚

```
package main

func f() {
    s := []int{1,2,3,4}
    _ = s[:9]  // ä¸éœ€è¦è¾¹ç•Œæ£€æŸ¥
}
func main()  {}
```

å› æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå¯¹äºåœ¨ç¼–è¯‘é˜¶æ®µæ— æ³•åˆ¤æ–­æ˜¯å¦ä¼šè¶Šç•Œçš„ç´¢å¼•æ“ä½œæ‰ä¼šéœ€è¦è¾¹ç•Œæ£€æŸ¥ï¼Œæ¯”å¦‚è¿™æ ·å­

```
package main


func f(s []int) {
    _ = s[:9]  // éœ€è¦è¾¹ç•Œæ£€æŸ¥
}
func main()  {}
```

## 3. è¾¹ç•Œæ£€æŸ¥çš„ç‰¹æ®Šæ¡ˆä¾‹

### 3.1 æ¡ˆä¾‹ä¸€

åœ¨å¦‚ä¸‹ç¤ºä¾‹ä»£ç ä¸­ï¼Œç”±äºç´¢å¼• 2 åœ¨æœ€å‰é¢å·²ç»æ£€æŸ¥è¿‡ä¼šä¸ä¼šè¶Šç•Œï¼Œå› æ­¤èªæ˜çš„ç¼–è¯‘å™¨å¯ä»¥æ¨æ–­å‡ºåé¢çš„ç´¢å¼• 0 å’Œ 1 ä¸ç”¨å†æ£€æŸ¥å•¦

```
 package main

func f(s []int) {
    _ = s[2] // æ£€æŸ¥ä¸€æ¬¡
    _ = s[1]  // ä¸ä¼šæ£€æŸ¥
    _ = s[0]  // ä¸ä¼šæ£€æŸ¥
}

func main() {}
```

### 3.2 æ¡ˆä¾‹äºŒ

åœ¨ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œå¯ä»¥åœ¨é€»è¾‘ä¸Šä¿è¯ä¸ä¼šè¶Šç•Œçš„ä»£ç ï¼ŒåŒæ ·æ˜¯ä¸ä¼šè¿›è¡Œè¶Šç•Œæ£€æŸ¥çš„ã€‚

```
package main

func f(s []int) {
    for index, _ := range s {
        _ = s[index]
        _ = s[:index+1]
        _ = s[index:len(s)]
    }
}

func main()  {}
```

### 3.3 æ¡ˆä¾‹ä¸‰

åœ¨å¦‚ä¸‹ç¤ºä¾‹ä»£ç ä¸­ï¼Œè™½ç„¶æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡å¯ä»¥ç¡®å®šï¼Œä½†æ˜¯ç´¢å¼•æ˜¯é€šè¿‡ `rand.Intn()` å‡½æ•°å–å¾—çš„éšæœºæ•°ï¼Œåœ¨ç¼–è¯‘å™¨çœ‹æ¥è¿™ä¸ªç´¢å¼•å€¼æ˜¯ä¸ç¡®å®šçš„ï¼Œå®ƒæœ‰å¯èƒ½å¤§äºæ•°ç»„çš„é•¿åº¦ï¼Œä¹Ÿæœ‰å¯èƒ½å°äºæ•°ç»„çš„é•¿åº¦ã€‚

å› æ­¤ç¬¬ä¸€æ¬¡æ˜¯éœ€è¦è¿›è¡Œæ£€æŸ¥çš„ï¼Œæœ‰äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥åï¼Œç¬¬äºŒæ¬¡ç´¢å¼•ä»é€»è¾‘ä¸Šå°±èƒ½æ¨æ–­ï¼Œæ‰€ä»¥ä¸ä¼šå†è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ã€‚

```
package main

import (
    "math/rand"
)

func f()  {
    s := make([]int, 3, 3)
    index := rand.Intn(3)
     _ = s[:index]  // ç¬¬ä¸€æ¬¡æ£€æŸ¥
    _ = s[index:]  // ä¸ä¼šæ£€æŸ¥
}

func main()  {}
```

ä½†å¦‚æœæŠŠä¸Šé¢çš„ä»£ç ç¨å¾®æ”¹ä¸€ä¸‹ï¼Œè®©åˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡å˜å¾—ä¸ä¸€æ ·ï¼Œç»“æœåˆä¼šå˜å¾—ä¸ä¸€æ ·äº†ã€‚

```
package main

import (
    "math/rand"
)

func f()  {
    s := make([]int, 3, 5)
    index := rand.Intn(3)
     _ = s[:index]  // ç¬¬ä¸€æ¬¡æ£€æŸ¥
    _ = s[index:]  // ç¬¬äºŒæ¬¡æ£€æŸ¥
}

func main()  {}
```

æˆ‘ä»¬åªæœ‰å½“æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡ç›¸ç­‰æ—¶ï¼Œ `:index` æˆç«‹ï¼Œæ‰èƒ½ä¸€å®šèƒ½æ¨å‡º `index:` ä¹Ÿæˆç«‹ï¼Œè¿™æ ·çš„è¯ï¼Œåªè¦åšä¸€æ¬¡æ£€æŸ¥å³å¯

ä¸€æ—¦æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆ index åœ¨ç¼–è¯‘å™¨çœ‹æ¥æ˜¯æœ‰å¯èƒ½å¤§äºæ•°ç»„é•¿åº¦çš„ï¼Œç”šè‡³å¤§äºæ•°ç»„çš„å®¹é‡ã€‚

æˆ‘ä»¬å‡è®¾ index å–å¾—çš„éšæœºæ•°ä¸º 4ï¼Œé‚£ä¹ˆå®ƒå¤§äºæ•°ç»„é•¿åº¦ï¼Œæ­¤æ—¶ `s[:index]` è™½ç„¶å¯ä»¥æˆåŠŸï¼Œä½†æ˜¯ `s[index:]` æ˜¯è¦å¤±è´¥çš„ï¼Œå› æ­¤ç¬¬äºŒæ¬¡è¾¹ç•Œçš„æ£€æŸ¥æ˜¯æœ‰å¿…è¦çš„ã€‚

ä½ å¯èƒ½ä¼šè¯´ï¼Œ index ä¸æ˜¯æœ€å¤§å€¼ä¸º 3 å—ï¼Ÿæ€ä¹ˆå¯èƒ½æ˜¯ 4å‘¢ï¼Ÿ

è¦çŸ¥é“ç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå¹¶ä¸çŸ¥é“ index çš„æœ€å¤§å€¼æ˜¯ 3 å‘¢ã€‚

**å°ç»“ä¸€ä¸‹**

1. å½“æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡ç›¸ç­‰æ—¶ï¼Œ`s[:index]` æˆç«‹èƒ½å¤Ÿä¿è¯ `s[index:]` ä¹Ÿæˆç«‹ï¼Œå› ä¸ºåªè¦æ£€æŸ¥ä¸€æ¬¡å³å¯
2. å½“æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡ä¸ç­‰æ—¶ï¼Œ`s[:index]` æˆç«‹ä¸èƒ½ä¿è¯ `s[index:]` ä¹Ÿæˆç«‹ï¼Œå› ä¸ºè¦æ£€æŸ¥ä¸¤æ¬¡æ‰å¯ä»¥

### 3.4 æ¡ˆä¾‹å››

æœ‰äº†ä¸Šé¢çš„é“ºå«ï¼Œå†æ¥çœ‹ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œç”±äºæ•°ç»„æ˜¯è°ƒç”¨è€…ä¼ å…¥çš„å‚æ•°ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨çš„ç¼–è¯‘çš„æ—¶å€™æ— æ³•å¾—çŸ¥æ•°ç»„çš„é•¿åº¦å’Œå®¹é‡æ˜¯å¦ç›¸ç­‰ï¼Œå› æ­¤åªèƒ½ä¿é™©ä¸€ç‚¹ï¼Œä¸¤ä¸ªéƒ½æ£€æŸ¥ã€‚

```
package main

import (
    "math/rand"
)

func f(s []int, index int) {
    _ = s[:index] // ç¬¬ä¸€æ¬¡æ£€æŸ¥
    _ = s[index:] // ç¬¬äºŒæ¬¡æ£€æŸ¥
}

func main()  {}
```

ä½†æ˜¯å¦‚æœæŠŠä¸¤ä¸ªè¡¨è¾¾å¼çš„é¡ºåºåè¿‡æ¥ï¼Œå°±åªè¦åšä¸€æ¬¡æ£€æŸ¥å°±è¡Œäº†ï¼ŒåŸå› æˆ‘å°±ä¸èµ˜è¿°äº†ã€‚

```
package main

import (
    "math/rand"
)

func f(s []int, index int) {
    _ = s[index:] // ç¬¬ä¸€æ¬¡æ£€æŸ¥
    _ = s[:index] // ä¸ç”¨æ£€æŸ¥
}

func main()  {}
```

## 5. ä¸»åŠ¨æ¶ˆé™¤è¾¹ç•Œæ£€æŸ¥

è™½ç„¶ç¼–è¯‘å™¨å·²ç»éå¸¸åŠªåŠ›å»æ¶ˆé™¤ä¸€äº›åº”è¯¥æ¶ˆé™¤çš„è¾¹ç•Œæ£€æŸ¥ï¼Œä½†éš¾å…ä¼šæœ‰ä¸€äº›é—æ¼ã€‚

è¿™å°±éœ€è¦â€è­¦æ°‘åˆä½œâ€ï¼Œå¯¹äºé‚£äº›ç¼–è¯‘å™¨è¿˜æœªè€ƒè™‘åˆ°çš„åœºæ™¯ï¼Œä½†å¼€å‘è€…åˆæåŠ›è¿½æ±‚ç¨‹åºçš„è¿è¡Œæ•ˆç‡çš„ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å°æŠ€å·§ç»™å‡ºä¸€äº›æš—ç¤ºï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å“ªäº›åœ°æ–¹å¯ä»¥ä¸ç”¨åšè¾¹ç•Œæ£€æŸ¥ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ï¼Œä»ä»£ç çš„é€»è¾‘ä¸Šæ¥è¯´ï¼Œæ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦åšè¾¹ç•Œæ£€æŸ¥çš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å¹¶æ²¡æœ‰é‚£ä¹ˆæ™ºèƒ½ï¼Œå®é™…ä¸Šæ¯ä¸ªforå¾ªç¯ï¼Œå®ƒéƒ½è¦åšä¸€æ¬¡è¾¹ç•Œçš„æ£€æŸ¥ï¼Œéå¸¸çš„æµªè´¹æ€§èƒ½ã€‚

```
package main


func f(is []int, bs []byte) {
    if len(is) >= 256 {
        for _, n := range bs {
            _ = is[n] // æ¯ä¸ªå¾ªç¯éƒ½è¦è¾¹ç•Œæ£€æŸ¥
        }
    }
}
func main()  {}
```

å¯ä»¥è¯•ç€åœ¨ for å¾ªç¯å‰åŠ ä¸Šè¿™ä¹ˆä¸€å¥ `is = is[:256]` æ¥å‘Šè¯‰ç¼–è¯‘å™¨æ–° is çš„é•¿åº¦ä¸º 256ï¼Œæœ€å¤§ç´¢å¼•å€¼ä¸º 255ï¼Œä¸ä¼šè¶…è¿‡ byte çš„æœ€å¤§å€¼ï¼Œå› ä¸º `is[n]` ä»é€»è¾‘ä¸Šæ¥è¯´æ˜¯ä¸€å®šä¸ä¼šè¶Šç•Œçš„ã€‚

```
package main


func f(is []int, bs []byte) {
    if len(is) >= 256 {
        is = is[:256]
        for _, n := range bs {
            _ = is[n] // ä¸éœ€è¦åšè¾¹ç•Œæ£€æŸ¥
        }
    }
}
func main()  {}
```

## å‚è€ƒæ–‡æ¡£

- [è¾¹ç•Œæ£€æŸ¥æ¶ˆé™¤](https://gfw.go101.org/article/bounds-check-elimination.html)

## END é“¾æ¥
<ul><li><div><a href = '94.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '96.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

