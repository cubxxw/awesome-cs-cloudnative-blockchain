# 1. ç®€å•çš„åˆ†å¸ƒå¼server

### 1.1.1. ç®€å•çš„åˆ†å¸ƒå¼server

ç›®å‰åˆ†å¸ƒå¼ç³»ç»Ÿå·²ç»å¾ˆæµè¡Œäº†ï¼Œä¸€äº›å¼€æºæ¡†æ¶ä¹Ÿè¢«å¹¿æ³›åº”ç”¨ï¼Œå¦‚dubboã€Motanç­‰ã€‚å¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡ï¼Œæœ€åŸºæœ¬çš„ä¸€é¡¹åŠŸèƒ½å°±æ˜¯æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œè€Œåˆ©ç”¨zkçš„EPHEMERALèŠ‚ç‚¹åˆ™å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°è¯¥åŠŸèƒ½ã€‚EPHEMERALèŠ‚ç‚¹æ­£å¦‚å…¶åï¼Œæ˜¯ä¸´æ—¶æ€§çš„ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯å’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šçš„ï¼Œå½“ä¼šè¯è¿æ¥æ–­å¼€æ—¶ï¼ŒèŠ‚ç‚¹ä¹Ÿä¼šè¢«åˆ é™¤ã€‚ä¸‹è¾¹æˆ‘ä»¬å°±æ¥å®ç°ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼serverï¼š

#### serverï¼š

æœåŠ¡å¯åŠ¨æ—¶ï¼Œåˆ›å»ºzkè¿æ¥ï¼Œå¹¶åœ¨go_serversèŠ‚ç‚¹ä¸‹åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹åä¸º"ip:port"ï¼Œå®ŒæˆæœåŠ¡æ³¨å†Œ æœåŠ¡ç»“æŸæ—¶ï¼Œç”±äºè¿æ¥æ–­å¼€ï¼Œåˆ›å»ºçš„èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ï¼Œè¿™æ ·clientå°±ä¸ä¼šè¿åˆ°è¯¥èŠ‚ç‚¹

#### clientï¼š

å…ˆä»zkè·å–go_serversèŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†æ‰€æœ‰æ³¨å†Œçš„server ä»serveråˆ—è¡¨ä¸­é€‰ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆè¿™é‡Œåªæ˜¯éšæœºé€‰å–ï¼Œå®é™…æœåŠ¡ä¸€èˆ¬ä¼šæä¾›å¤šç§ç­–ç•¥ï¼‰ï¼Œåˆ›å»ºè¿æ¥è¿›è¡Œé€šä¿¡ è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬æ¯æ¬¡clientè¿æ¥serverï¼Œè·å–serverå‘é€çš„æ—¶é—´åå°±æ–­å¼€ã€‚ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š

server.go

```go
package main

import (
    "fmt"
    "net"
    "os"
    "time"

    "github.com/samuel/go-zookeeper/zk"
)

func main() {
    go starServer("127.0.0.1:8897")
    go starServer("127.0.0.1:8898")
    go starServer("127.0.0.1:8899")

    a := make(chan bool, 1)
    <-a
}

func checkError(err error) {
    if err != nil {
        fmt.Println(err)
    }
}

func starServer(port string) {
    tcpAddr, err := net.ResolveTCPAddr("tcp4", port)
    fmt.Println(tcpAddr)
    checkError(err)

    listener, err := net.ListenTCP("tcp", tcpAddr)
    checkError(err)

    //æ³¨å†ŒzkèŠ‚ç‚¹q
    // é“¾æ¥zk
    conn, err := GetConnect()
    if err != nil {
        fmt.Printf(" connect zk error: %s ", err)
    }
    defer conn.Close()
    // zkèŠ‚ç‚¹æ³¨å†Œ
    err = RegistServer(conn, port)
    if err != nil {
        fmt.Printf(" regist node error: %s ", err)
    }

    for {
        conn, err := listener.Accept()
        if err != nil {
            fmt.Fprintf(os.Stderr, "Error: %s", err)
            continue
        }
        go handleCient(conn, port)
    }

    fmt.Println("aaaaaa")
}

func handleCient(conn net.Conn, port string) {
    defer conn.Close()

    daytime := time.Now().String()
    conn.Write([]byte(port + ": " + daytime))
}
func GetConnect() (conn *zk.Conn, err error) {
    zkList := []string{"localhost:2181"}
    conn, _, err = zk.Connect(zkList, 10*time.Second)
    if err != nil {
        fmt.Println(err)
    }
    return
}

func RegistServer(conn *zk.Conn, host string) (err error) {
    _, err = conn.Create("/go_servers/"+host, nil, zk.FlagEphemeral, zk.WorldACL(zk.PermAll))
    return
}

func GetServerList(conn *zk.Conn) (list []string, err error) {
    list, _, err = conn.Children("/go_servers")
    return
}
```

### 1.1.2. client.go

```go
package main

import (
    "errors"
    "fmt"
    "io/ioutil"
    "math/rand"
    "net"
    "time"

    "github.com/samuel/go-zookeeper/zk"
)

func checkError(err error) {
    if err != nil {
        fmt.Println(err)
    }
}
func main() {
    for i := 0; i < 100; i++ {
        startClient()

        time.Sleep(1 * time.Second)
    }
}

func startClient() {
    // service := "127.0.0.1:8899"
    //è·å–åœ°å€
    serverHost, err := getServerHost()
    if err != nil {
        fmt.Printf("get server host fail: %s \n", err)
        return
    }

    fmt.Println("connect host: " + serverHost)
    tcpAddr, err := net.ResolveTCPAddr("tcp4", serverHost)
    checkError(err)
    conn, err := net.DialTCP("tcp", nil, tcpAddr)
    checkError(err)
    defer conn.Close()

    _, err = conn.Write([]byte("timestamp"))
    checkError(err)

    result, err := ioutil.ReadAll(conn)
    checkError(err)
    fmt.Println(string(result))

    return
}

func getServerHost() (host string, err error) {
    conn, err := GetConnect()
    if err != nil {
        fmt.Printf(" connect zk error: %s \n ", err)
        return
    }
    defer conn.Close()
    serverList, err := GetServerList(conn)
    if err != nil {
        fmt.Printf(" get server list error: %s \n", err)
        return
    }

    count := len(serverList)
    if count == 0 {
        err = errors.New("server list is empty \n")
        return
    }

    //éšæœºé€‰ä¸­ä¸€ä¸ªè¿”å›
    r := rand.New(rand.NewSource(time.Now().UnixNano()))
    host = serverList[r.Intn(3)]
    return
}
func GetConnect() (conn *zk.Conn, err error) {
    zkList := []string{"localhost:2181"}
    conn, _, err = zk.Connect(zkList, 10*time.Second)
    if err != nil {
        fmt.Println(err)
    }
    return
}
func GetServerList(conn *zk.Conn) (list []string, err error) {
    list, _, err = conn.Children("/go_servers")
    return
}
```

å…ˆå¯åŠ¨serverï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªèŠ‚ç‚¹æ³¨å†Œåˆ°zkï¼š

```
    127.0.0.1:8897
    127.0.0.1:8899
    127.0.0.1:8898
    2018/08/27 14:04:58 Connected to 127.0.0.1:2181
    2018/08/27 14:04:58 Connected to 127.0.0.1:2181
    2018/08/27 14:04:58 Connected to 127.0.0.1:2181
    2018/08/27 14:04:58 Authenticated: id=100619932030205976, timeout=10000
    2018/08/27 14:04:58 Re-submitting `0` credentials after reconnect
    2018/08/27 14:04:58 Authenticated: id=100619932030205977, timeout=10000
    2018/08/27 14:04:58 Re-submitting `0` credentials after reconnect
    2018/08/27 14:04:58 Authenticated: id=100619932030205978, timeout=10000
    2018/08/27 14:04:58 Re-submitting `0` credentials after reconnect
```

å¯åŠ¨clientï¼Œå¯ä»¥çœ‹åˆ°æ¯æ¬¡clientéƒ½ä¼šéšæœºè¿æ¥åˆ°ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼š

```
    2018/08/27 14:05:21 Connected to 127.0.0.1:2181
    2018/08/27 14:05:21 Authenticated: id=100619932030205979, timeout=10000
    2018/08/27 14:05:21 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:21 Recv loop terminated: err=EOF
    connect host: 127.0.0.1:8899
    2018/08/27 14:05:21 Send loop terminated: err=<nil>
    read tcp 127.0.0.1:54062->127.0.0.1:8899: read: connection reset by peer
    127.0.0.1:8899: 2018-08-27 14:05:21.291641 +0800 CST m=+22.480149656
    2018/08/27 14:05:22 Connected to [::1]:2181
    2018/08/27 14:05:22 Authenticated: id=100619932030205980, timeout=10000
    2018/08/27 14:05:22 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:22 Recv loop terminated: err=EOF
    2018/08/27 14:05:22 Send loop terminated: err=<nil>
    connect host: 127.0.0.1:8897
    read tcp 127.0.0.1:54064->127.0.0.1:8897: read: connection reset by peer
    127.0.0.1:8897: 2018-08-27 14:05:22.302322 +0800 CST m=+23.490801385
    2018/08/27 14:05:23 Connected to 127.0.0.1:2181
    2018/08/27 14:05:23 Authenticated: id=100619932030205981, timeout=10000
    2018/08/27 14:05:23 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:23 Recv loop terminated: err=EOF
    2018/08/27 14:05:23 Send loop terminated: err=<nil>
    connect host: 127.0.0.1:8897
    read tcp 127.0.0.1:54070->127.0.0.1:8897: read: connection reset by peer
    127.0.0.1:8897: 2018-08-27 14:05:23.312873 +0800 CST m=+24.501324228
    2018/08/27 14:05:24 Connected to 127.0.0.1:2181
    2018/08/27 14:05:24 Authenticated: id=100619932030205982, timeout=10000
    2018/08/27 14:05:24 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:24 Recv loop terminated: err=EOF
    connect host: 127.0.0.1:8899
    2018/08/27 14:05:24 Send loop terminated: err=<nil>
    read tcp 127.0.0.1:54072->127.0.0.1:8899: read: connection reset by peer
    127.0.0.1:8899: 2018-08-27 14:05:24.323668 +0800 CST m=+25.512090155
    2018/08/27 14:05:25 Connected to 127.0.0.1:2181
    2018/08/27 14:05:25 Authenticated: id=100619932030205983, timeout=10000
    2018/08/27 14:05:25 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:25 Recv loop terminated: err=EOF
    2018/08/27 14:05:25 Send loop terminated: err=<nil>
    connect host: 127.0.0.1:8897
    read tcp 127.0.0.1:54074->127.0.0.1:8897: read: connection reset by peer
    127.0.0.1:8897: 2018-08-27 14:05:25.330257 +0800 CST m=+26.518650566
    2018/08/27 14:05:26 Connected to [::1]:2181
    2018/08/27 14:05:26 Authenticated: id=100619932030205984, timeout=10000
    2018/08/27 14:05:26 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:26 Recv loop terminated: err=EOF
    2018/08/27 14:05:26 Send loop terminated: err=<nil>
    connect host: 127.0.0.1:8897
    read tcp 127.0.0.1:54080->127.0.0.1:8897: read: connection reset by peer
    127.0.0.1:8897: 2018-08-27 14:05:26.357251 +0800 CST m=+27.545614616
    2018/08/27 14:05:27 Connected to 127.0.0.1:2181
    2018/08/27 14:05:27 Authenticated: id=100619932030205985, timeout=10000
    2018/08/27 14:05:27 Re-submitting `0` credentials after reconnect
    connect host: 127.0.0.1:8899
    2018/08/27 14:05:27 Recv loop terminated: err=EOF
    2018/08/27 14:05:27 Send loop terminated: err=<nil>
    read tcp 127.0.0.1:54082->127.0.0.1:8899: read: connection reset by peer
    127.0.0.1:8899: 2018-08-27 14:05:27.369096 +0800 CST m=+28.557430764
    2018/08/27 14:05:28 Connected to [::1]:2181
    2018/08/27 14:05:28 Authenticated: id=100619932030205986, timeout=10000
    2018/08/27 14:05:28 Re-submitting `0` credentials after reconnect
    2018/08/27 14:05:28 Recv loop terminated: err=EOF
    2018/08/27 14:05:28 Send loop terminated: err=<nil>
    connect host: 127.0.0.1:8898
    read tcp 127.0.0.1:54084->127.0.0.1:8898: read: connection reset by peer
    127.0.0.1:8898: 2018-08-27 14:05:28.380455 +0800 CST m=+29.568760988
    ......
```

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„åˆ†å¸ƒå¼serverå°±å®ç°äº†

## END é“¾æ¥
<ul><li><div><a href = '36.md' style='float:left'>â¬†ï¸ä¸Šä¸€èŠ‚ğŸ”—</a><a href = '38.md' style='float: right'>â¬‡ï¸ä¸‹ä¸€èŠ‚ğŸ”—</a></div></li></ul>

+ [â“‚ï¸å›åˆ°é¦–é¡µğŸ ](../README.md)

+ [**ğŸ«µå‚ä¸è´¡çŒ®ğŸ’â¤ï¸â€ğŸ”¥ğŸ’–**](https://nsddd.top/archives/contributors))

+ âœ´ï¸ç‰ˆæƒå£°æ˜ &copy; :æœ¬ä¹¦æ‰€æœ‰å†…å®¹éµå¾ª[CC-BY-SA 3.0åè®®ï¼ˆç½²å-ç›¸åŒæ–¹å¼å…±äº«ï¼‰&copy;](http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0åè®®æ–‡æœ¬) 

